<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 10 Camera源码分析8：openCamera流程 | zhoujinjian</title><meta name="keywords" content="Camera"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 10 Camera源码分析8：openCamera流程">
<meta property="og:url" content="https://zhoujinjian.com/posts/20220415/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.38.jpg">
<meta property="article:published_time" content="2022-04-14T20:15:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.932Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Camera">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.38.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20220415/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.38.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 10 Camera源码分析8：openCamera流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-04-14T20:15:00.000Z" title="发表于 2022-04-15 04:15:00">2022-04-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.932Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Camera/">Camera</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。</p>
<p>（==<strong>文章基于 Kernel-4.19</strong>==）&amp;&amp;（==<strong>文章基于 Android 10.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz">【zhoujinjian.com博客原图链接】</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.khadas.cn/edge-v">【开发板 Khadas Edge V】</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/khadas/linux/tree/khadas-edge-Qt">【开发板 Khadas Edge V Android 10.0 &amp;&amp; Linux（Kernel 4.19）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41944449/article/details/99684653">Android openCamera流程</a> </p>
<hr>
<p>==源码（部分）==：</p>
<p><strong>F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\</strong></p>
<p>==源码（部分）==：</p>
<hr>
<h2 id="（一）、从APP到CameraService"><a href="#（一）、从APP到CameraService" class="headerlink" title="（一）、从APP到CameraService"></a>（一）、从APP到CameraService</h2><h4 id="（1）、总体概览图"><a href="#（1）、总体概览图" class="headerlink" title="（1）、总体概览图"></a>（1）、总体概览图</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.08/openCamera.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager: openCameraDeviceUserAsync</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at android.hardware.camera2.CameraManager.openCameraDeviceUserAsync(CameraManager.java:<span class="number">366</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at android.hardware.camera2.CameraManager.openCameraForUid(CameraManager.java:<span class="number">590</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at android.hardware.camera2.CameraManager.openCamera(CameraManager.java:<span class="number">518</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at com.android.camera.one.v2.Camera2OneCameraOpenerImpl.open(Camera2OneCameraOpenerImpl.java:<span class="number">118</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at com.android.camera.CaptureModule.openCameraAndStartPreview(CaptureModule.java:<span class="number">1492</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at com.android.camera.CaptureModule.access$<span class="number">2100</span>(CaptureModule.java:<span class="number">114</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at com.android.camera.CaptureModule$<span class="number">10.</span>run(CaptureModule.java:<span class="number">680</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1167</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">641</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">17.368</span>  <span class="number">1450</span>  <span class="number">1540</span> I CameraManager:     at java.lang.Thread.run(Thread.java:<span class="number">919</span>)</span><br></pre></td></tr></table></figure>



<h4 id="（2）、App-gt-Camera2OneCameraOpenerImpl-open"><a href="#（2）、App-gt-Camera2OneCameraOpenerImpl-open" class="headerlink" title="（2）、App-&gt;Camera2OneCameraOpenerImpl.open()"></a>（2）、App-&gt;Camera2OneCameraOpenerImpl.open()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\packages\apps\Camera2\src\com\android\camera\one\v2\Camera2OneCameraOpenerImpl.java</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(......)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Opening Camera: &quot;</span> + cameraKey);</span><br><span class="line">            mCameraManager.openCamera(cameraKey.getValue(), <span class="keyword">new</span> CameraDevice.StateCallback() &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpened</span><span class="params">(CameraDevice device)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (isFirstCallback) &#123;</span><br><span class="line">                        ......</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ......</span><br><span class="line">                            OneCamera oneCamera = OneCameraCreator.create()</span><br><span class="line">                                    ......</span><br><span class="line">                            <span class="keyword">if</span> (oneCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                openCallback.onCameraOpened(oneCamera);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                Log.d(TAG, <span class="string">&quot;Could not construct a OneCamera object!&quot;</span>);</span><br><span class="line">                                openCallback.onFailure();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; ......</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, handler);</span><br><span class="line">        &#125; ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="（3）、Framework-gt-CameraManager-openCamera"><a href="#（3）、Framework-gt-CameraManager-openCamera" class="headerlink" title="（3）、Framework-&gt;CameraManager.openCamera()"></a>（3）、Framework-&gt;CameraManager.openCamera()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\base\core\java\android\hardware\camera2\CameraManager.java</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(<span class="meta">@NonNull</span> String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@NonNull</span> <span class="keyword">final</span> CameraDevice.StateCallback callback, <span class="meta">@Nullable</span> Handler handler)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">        openCameraForUid(cameraId, callback, CameraDeviceImpl.checkAndWrapHandler(handler),</span><br><span class="line">                USE_CALLING_UID);</span><br><span class="line">    &#125;</span><br><span class="line">openCameraForUid-&gt;openCameraDeviceUserAsync</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">private</span> CameraDevice <span class="title">openCameraDeviceUserAsync</span><span class="params">(String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            CameraDevice.StateCallback callback, Executor executor, <span class="keyword">final</span> <span class="keyword">int</span> uid)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">        CameraCharacteristics characteristics = getCameraCharacteristics(cameraId);</span><br><span class="line">        CameraDevice device = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">            ICameraDeviceUser cameraUser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl =</span><br><span class="line">                    <span class="keyword">new</span> android.hardware.camera2.impl.CameraDeviceImpl(</span><br><span class="line">                        cameraId,</span><br><span class="line">                        callback,</span><br><span class="line">                        executor,</span><br><span class="line">                        characteristics,</span><br><span class="line">                        mContext.getApplicationInfo().targetSdkVersion);</span><br><span class="line"></span><br><span class="line">            ICameraDeviceCallbacks callbacks = deviceImpl.getCallbacks();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (supportsCamera2ApiLocked(cameraId)) &#123;</span><br><span class="line">                    <span class="comment">// Use cameraservice&#x27;s cameradeviceclient implementation for HAL3.2+ devices</span></span><br><span class="line">                    <span class="comment">//获得&quot;media.camera&quot; 的 CameraService Binder代理，然后转变为ICameraService</span></span><br><span class="line">                    ICameraService cameraService = CameraManagerGlobal.get().getCameraService();</span><br><span class="line">                    ......</span><br><span class="line">                    cameraUser = cameraService.connectDevice(callbacks, cameraId,</span><br><span class="line">                            mContext.getOpPackageName(), uid);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; ......</span><br><span class="line">            deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">            device = deviceImpl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> device;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="（4）、openSession-gt-StackTrace"><a href="#（4）、openSession-gt-StackTrace" class="headerlink" title="（4）、openSession()-&gt;StackTrace"></a>（4）、openSession()-&gt;StackTrace</h4><p>首先看看CameraProviderManager::openSession()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                                               FILE:LINE</span><br><span class="line">  <span class="number">000</span>afd4b  android::CameraProviderManager::openSession(<span class="built_in">std</span>::__1::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::__1::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;, android::sp&lt;android::hardware::camera::device::V3_2::ICameraDeviceCallback&gt; <span class="keyword">const</span>&amp;, android::sp&lt;android::hardware::camera::device::V3_2::ICameraDeviceSession&gt;*)+<span class="number">178</span>                                                                         frameworks/av/services/camera/libcameraservice/common/CameraProviderManager.cpp:<span class="number">349</span></span><br><span class="line">  <span class="number">000f</span>b0e7  android::Camera3Device::initialize(android::sp&lt;android::CameraProviderManager&gt;, android::String8 <span class="keyword">const</span>&amp;)+<span class="number">354</span>                                                                                                                                                                                                                                                                           frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">127</span></span><br><span class="line">  <span class="number">000</span>ad62f  <span class="keyword">int</span> android::Camera2ClientBase&lt;android::CameraDeviceClientBase&gt;::initializeImpl&lt;android::sp&lt;android::CameraProviderManager&gt; &gt;(android::sp&lt;android::CameraProviderManager&gt;, android::String8 <span class="keyword">const</span>&amp;)+<span class="number">170</span>                                                                                                                                                                                frameworks/av/services/camera/libcameraservice/common/Camera2ClientBase.cpp:<span class="number">106</span></span><br><span class="line">  <span class="number">000</span>ad557  android::Camera2ClientBase&lt;android::CameraDeviceClientBase&gt;::initialize(android::sp&lt;android::CameraProviderManager&gt;, android::String8 <span class="keyword">const</span>&amp;)+<span class="number">46</span>                                                                                                                                                                                                                                       frameworks/av/services/camera/libcameraservice/common/Camera2ClientBase.cpp:<span class="number">82</span></span><br><span class="line">  <span class="number">000</span>d8847  <span class="keyword">int</span> android::CameraDeviceClient::initializeImpl&lt;android::sp&lt;android::CameraProviderManager&gt; &gt;(android::sp&lt;android::CameraProviderManager&gt;, android::String8 <span class="keyword">const</span>&amp;)+<span class="number">90</span>                                                                                                                                                                                                                 frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:<span class="number">107</span></span><br><span class="line">  <span class="number">000</span>d87bf  android::CameraDeviceClient::initialize(android::sp&lt;android::CameraProviderManager&gt;, android::String8 <span class="keyword">const</span>&amp;)+<span class="number">46</span>                                                                                                                                                                                                                                                                       frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:<span class="number">99</span></span><br><span class="line">  <span class="number">0009f</span>4d3  android::binder::Status android::CameraService::connectHelper&lt;android::hardware::camera2::ICameraDeviceCallbacks, android::CameraDeviceClient&gt;(android::sp&lt;android::hardware::camera2::ICameraDeviceCallbacks&gt; <span class="keyword">const</span>&amp;, android::String8 <span class="keyword">const</span>&amp;, <span class="keyword">int</span>, <span class="keyword">int</span>, android::String16 <span class="keyword">const</span>&amp;, <span class="keyword">int</span>, <span class="keyword">int</span>, android::CameraService::apiLevel, <span class="keyword">bool</span>, android::sp&lt;android::CameraDeviceClient&gt;&amp;)+<span class="number">1762</span>  frameworks/av/services/camera/libcameraservice/CameraService.cpp:<span class="number">1504</span></span><br><span class="line">  <span class="number">0009</span>ecc9  android::CameraService::connectDevice(android::sp&lt;android::hardware::camera2::ICameraDeviceCallbacks&gt; <span class="keyword">const</span>&amp;, android::String16 <span class="keyword">const</span>&amp;, android::String16 <span class="keyword">const</span>&amp;, <span class="keyword">int</span>, android::sp&lt;android::hardware::camera2::ICameraDeviceUser&gt;*)+<span class="number">208</span>                                                                                                                                                frameworks/av/services/camera/libcameraservice/CameraService.cpp:<span class="number">1382</span></span><br><span class="line">  <span class="number">0009f</span>88f  <span class="keyword">virtual</span> thunk to android::CameraService::connectDevice(android::sp&lt;android::hardware::camera2::ICameraDeviceCallbacks&gt; <span class="keyword">const</span>&amp;, android::String16 <span class="keyword">const</span>&amp;, android::String16 <span class="keyword">const</span>&amp;, <span class="keyword">int</span>, android::sp&lt;android::hardware::camera2::ICameraDeviceUser&gt;*)+<span class="number">30</span>                                                                                                                                aeabi_div0.c:?</span><br><span class="line">  <span class="number">00023819</span>  android::hardware::BnCameraService::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">556</span>                                                                                                                                                                                                                                                               out/soong/.intermediates/frameworks/av/camera/libcamera_client/android_arm_armv7-a-neon_cortex-a15_core_shared/gen/aidl/frameworks/av/camera/aidl/android/hardware/ICameraService.cpp:<span class="number">829</span></span><br><span class="line">  <span class="number">00032</span>ed1  android::BBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">72</span>                                                                                                                                                                                                                                                                                    frameworks/native/libs/binder/Binder.cpp:<span class="number">134</span></span><br><span class="line">  <span class="number">0003b</span>117  android::IPCThreadState::executeCommand(<span class="keyword">int</span>)+<span class="number">770</span>                                                                                                                                                                                                                                                                                                                                       frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">1213</span></span><br><span class="line">  <span class="number">0003</span>ad53  android::IPCThreadState::getAndExecuteCommand()+<span class="number">98</span>                                                                                                                                                                                                                                                                                                                                     frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">514</span></span><br><span class="line">  <span class="number">0003b</span>2ef  android::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">38</span>                                                                                                                                                                                                                                                                                                                                       frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">594</span></span><br><span class="line">  <span class="number">00054665</span>  android::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                                                                                                                                                   frameworks/native/libs/binder/ProcessState.cpp:<span class="number">67</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                                                                                                                                                system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                                                                                                                                              bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                               </span><br></pre></td></tr></table></figure>



<h4 id="（5）、ICameraService-connectDevice"><a href="#（5）、ICameraService-connectDevice" class="headerlink" title="（5）、ICameraService::connectDevice()"></a>（5）、ICameraService::connectDevice()</h4><p>BpCameraService -&gt; BnCameraService，进入到CameraService进程中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/home/zhoujinjian/Khadas_Edge_Android_Q/out/soong/.intermediates/frameworks/av/camera/libcamera_client/android_arm_armv7-a-neon_cortex-a15_core_shared/gen/aidl/frameworks/av/camera/aidl/android/hardware/ICameraService.cpp</span><br><span class="line">::android::<span class="function">binder::Status <span class="title">BpCameraService::connectDevice</span><span class="params">(<span class="keyword">const</span> ::android::sp&lt;::android::hardware::camera2::ICameraDeviceCallbacks&gt;&amp; callbacks, <span class="keyword">const</span> ::android::String16&amp; cameraId, <span class="keyword">const</span> ::android::String16&amp; opPackageName, <span class="keyword">int32_t</span> clientUid, ::android::sp&lt;::android::hardware::camera2::ICameraDeviceUser&gt;* _aidl_return)</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  _aidl_ret_status = remote()-&gt;transact(::android::IBinder::FIRST_CALL_TRANSACTION + <span class="number">3</span> <span class="comment">/* connectDevice */</span>, _aidl_data, &amp;_aidl_reply);</span><br><span class="line">  <span class="keyword">if</span> (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; ICameraService::getDefaultImpl())) &#123;</span><br><span class="line">     <span class="keyword">return</span> ICameraService::getDefaultImpl()-&gt;connectDevice(callbacks, cameraId, opPackageName, clientUid, _aidl_return);</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">return</span> _aidl_status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    ::<span class="function">android::<span class="keyword">status_t</span> <span class="title">BnCameraService::onTransact</span><span class="params">(<span class="keyword">uint32_t</span> _aidl_code, <span class="keyword">const</span> ::android::Parcel&amp; _aidl_data, ::android::Parcel* _aidl_reply, <span class="keyword">uint32_t</span> _aidl_flags)</span> </span>&#123;</span><br><span class="line">  ::android::<span class="keyword">status_t</span> _aidl_ret_status = ::android::OK;</span><br><span class="line">  <span class="keyword">switch</span> (_aidl_code) &#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">case</span> ::android::IBinder::FIRST_CALL_TRANSACTION + <span class="number">3</span> <span class="comment">/* connectDevice */</span>:</span><br><span class="line">  &#123;</span><br><span class="line">    ::android::sp&lt;::android::hardware::camera2::ICameraDeviceCallbacks&gt; in_callbacks;</span><br><span class="line">    ::android::String16 in_cameraId;</span><br><span class="line">    ::android::String16 in_opPackageName;</span><br><span class="line">    <span class="keyword">int32_t</span> in_clientUid;</span><br><span class="line">    ::android::sp&lt;::android::hardware::camera2::ICameraDeviceUser&gt; _aidl_return;</span><br><span class="line">    _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_callbacks);</span><br><span class="line">    _aidl_ret_status = _aidl_data.readString16(&amp;in_cameraId);</span><br><span class="line">    _aidl_ret_status = _aidl_data.readString16(&amp;in_opPackageName);</span><br><span class="line">    _aidl_ret_status = _aidl_data.readInt32(&amp;in_clientUid);</span><br><span class="line">    ::android::binder::Status _aidl_status(connectDevice(in_callbacks, in_cameraId, in_opPackageName, in_clientUid, &amp;_aidl_return));</span><br><span class="line">    _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply);</span><br><span class="line">    ......</span><br><span class="line">    _aidl_ret_status = _aidl_reply-&gt;writeStrongBinder(::android::hardware::camera2::ICameraDeviceUser::asBinder(_aidl_return));</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="（6）、CameraService-connectDevice"><a href="#（6）、CameraService-connectDevice" class="headerlink" title="（6）、CameraService::connectDevice()"></a>（6）、CameraService::connectDevice()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\CameraService.cpp</span><br><span class="line">    </span><br><span class="line">    <span class="function">Status <span class="title">CameraService::connectDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt;&amp; cameraCb,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String16&amp; cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String16&amp; clientPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> clientUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">/*out*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;hardware::camera2::ICameraDeviceUser&gt;* device)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    Status ret = Status::ok();</span><br><span class="line">    String8 id = String8(cameraId);</span><br><span class="line">    sp&lt;CameraDeviceClient&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    String16 clientPackageNameAdj = clientPackageName;</span><br><span class="line">    ......</span><br><span class="line">    ret = connectHelper&lt;hardware::camera2::ICameraDeviceCallbacks,CameraDeviceClient&gt;(cameraCb, id,</span><br><span class="line">            <span class="comment">/*api1CameraId*/</span><span class="number">-1</span>,</span><br><span class="line">            CAMERA_HAL_API_VERSION_UNSPECIFIED, clientPackageNameAdj,</span><br><span class="line">            clientUid, USE_CALLING_PID, API_2, <span class="comment">/*shimUpdateOnly*/</span> <span class="literal">false</span>, <span class="comment">/*out*/</span>client);</span><br><span class="line">    ......</span><br><span class="line">    *device = client;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">CALLBACK</span>, <span class="title">class</span> <span class="title">CLIENT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">Status</span> <span class="title">CameraService</span>:</span>:connectHelper(<span class="keyword">const</span> sp&lt;CALLBACK&gt;&amp; cameraCb, <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> api1CameraId, <span class="keyword">int</span> halVersion, <span class="keyword">const</span> String16&amp; clientPackageName, <span class="keyword">int</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> clientPid, apiLevel effectiveApiLevel, <span class="keyword">bool</span> shimUpdateOnly,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;CLIENT&gt;&amp; device) &#123;</span><br><span class="line">    binder::Status ret = binder::Status::ok();</span><br><span class="line"></span><br><span class="line">    <span class="function">String8 <span class="title">clientName8</span><span class="params">(clientPackageName)</span></span>;</span><br><span class="line">    property_set(<span class="string">&quot;vendor.sys.camera.callprocess&quot;</span>, clientName8.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> originalClientPid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ALOGI(<span class="string">&quot;CameraService::connect call (PID %d \&quot;%s\&quot;, camera ID %s) for HAL version %s and &quot;</span></span><br><span class="line">            <span class="string">&quot;Camera API version %d&quot;</span>, clientPid, clientName8.<span class="built_in">string</span>(), cameraId.<span class="built_in">string</span>(),</span><br><span class="line">            (halVersion == <span class="number">-1</span>) ? <span class="string">&quot;default&quot;</span> : <span class="built_in">std</span>::to_string(halVersion).c_str(),</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(effectiveApiLevel));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldRejectHiddenCameraConnection(cameraId)) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;Attempting to connect to system-only camera id %s, connection rejected&quot;</span>,</span><br><span class="line">              cameraId.c_str());</span><br><span class="line">        <span class="keyword">return</span> STATUS_ERROR_FMT(ERROR_DISCONNECTED,</span><br><span class="line">                                <span class="string">&quot;No camera device with ID \&quot;%s\&quot; currently available&quot;</span>,</span><br><span class="line">                                cameraId.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    sp&lt;CLIENT&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// give flashlight a chance to close devices if necessary.</span></span><br><span class="line">        mFlashlight-&gt;prepareDeviceOpen(cameraId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> facing = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">int</span> deviceVersion = getDeviceVersion(cameraId, <span class="comment">/*out*/</span>&amp;facing);</span><br><span class="line">        ......</span><br><span class="line">        sp&lt;BasicClient&gt; tmp = <span class="literal">nullptr</span>;</span><br><span class="line">         <span class="comment">/* makeClient() 将会根据API版本以及HAL版本选择生成具体的 Client 实例 */</span></span><br><span class="line">        <span class="keyword">if</span>(!(ret = makeClient(<span class="keyword">this</span>, cameraCb, clientPackageName,</span><br><span class="line">                cameraId, api1CameraId, facing,</span><br><span class="line">                clientPid, clientUid, getpid(),</span><br><span class="line">                halVersion, deviceVersion, effectiveApiLevel,</span><br><span class="line">                <span class="comment">/*out*/</span>&amp;tmp)).isOk()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        client = <span class="keyword">static_cast</span>&lt;CLIENT*&gt;(tmp.get());</span><br><span class="line">        ......</span><br><span class="line">         <span class="comment">/* client 进行初始化工作,mCameraProviderManager 是 CameraService 运行起来时，</span></span><br><span class="line"><span class="comment">         * 第一次强指针引用从而调用 onFirstRef() 函数创建的 CameraProviderManager</span></span><br><span class="line"><span class="comment">         * 实例对象，它保存了 CameraProvider 信息.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        err = client-&gt;initialize(mCameraProviderManager, mMonitorTags);</span><br><span class="line">        .......</span><br><span class="line">    &#125; <span class="comment">// lock is destroyed, allow further connect calls</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Important: release the mutex here so the client can call back into the service from its</span></span><br><span class="line">    <span class="comment">// destructor (can be at the end of the call)</span></span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="（7）、CameraService-makeClient"><a href="#（7）、CameraService-makeClient" class="headerlink" title="（7）、CameraService::makeClient()"></a>（7）、CameraService::makeClient()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\CameraService.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">CameraService::makeClient</span><span class="params">(<span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;IInterface&gt;&amp; cameraCb, <span class="keyword">const</span> String16&amp; packageName, <span class="keyword">const</span> String8&amp; cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> api1CameraId, <span class="keyword">int</span> facing, <span class="keyword">int</span> clientPid, <span class="keyword">uid_t</span> clientUid, <span class="keyword">int</span> servicePid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> halVersion, <span class="keyword">int</span> deviceVersion, apiLevel effectiveApiLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">/*out*/</span>sp&lt;BasicClient&gt;* client)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (halVersion &lt; <span class="number">0</span> || halVersion == deviceVersion) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(deviceVersion) &#123;</span><br><span class="line">          ......</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_0:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_1:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_2:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_3:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_4:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_5:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123; <span class="comment">// Camera1 API route</span></span><br><span class="line">                ......</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                <span class="comment">/* API2 HAL3 将会通过 CameraDeviceClient() 创建 client，</span></span><br><span class="line"><span class="comment">                 * 这一 client 最终返回到 CameraDeviceImpl 实例，被保存在 mRemoteDevice</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; tmp =</span><br><span class="line">                        <span class="keyword">static_cast</span>&lt;hardware::camera2::ICameraDeviceCallbacks*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraDeviceClient(cameraService, tmp, packageName, cameraId,</span><br><span class="line">                        facing, clientPid, clientUid, servicePid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.08/app_camera_service.png"></p>
<h2 id="（二）、从CameraService到CameraProvider"><a href="#（二）、从CameraService到CameraProvider" class="headerlink" title="（二）、从CameraService到CameraProvider"></a>（二）、从CameraService到CameraProvider</h2><p>由于 Android O 中加入了 Treble 机制，它带来的一个巨大变化就是将原本的 CameraServer 进程分隔成 CameraServer 与 Provider service 两个进程，它们之间通过 HIDL（一个类似 Binder 的机制）进行通信。<br>在这种情况下，CameraServer 一端主体为 CameraService，它将会寻找现存的 Provider service，将其加入到内部的 CameraProviderManager 中进行管理，相关操作都是通过远端调用进行的。<br>而 Provider service 一端的主体为 CameraProvider，它在初始化时就已经连接到 libhardware 的 Camera HAL 实现层，并以 CameraModule 来进行管理。这两个进程的启动以及初始化在系统启动时就已经进行，所以当相机应用运行时，它们的初始化工作已经完成。</p>
<h4 id="（1）、CameraDeviceClient-CameraDeviceClient"><a href="#（1）、CameraDeviceClient-CameraDeviceClient" class="headerlink" title="（1）、CameraDeviceClient::CameraDeviceClient()"></a>（1）、CameraDeviceClient::CameraDeviceClient()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp</span><br><span class="line">CameraDeviceClient::CameraDeviceClient(<span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> cameraFacing,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> servicePid) :</span><br><span class="line">    Camera2ClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">                cameraId, <span class="comment">/*API1 camera ID*/</span> <span class="number">-1</span>,</span><br><span class="line">                cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">    mInputStream(),</span><br><span class="line">    mStreamingRequestId(REQUEST_ID_NONE),</span><br><span class="line">    mRequestIdCounter(<span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGI(<span class="string">&quot;CameraDeviceClient %s: Opened&quot;</span>, cameraId.<span class="built_in">string</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\common\Camera2ClientBase.cpp</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line">Camera2ClientBase&lt;TClientBase&gt;::Camera2ClientBase(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;TCamCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> api1CameraId,</span><br><span class="line">        <span class="keyword">int</span> cameraFacing,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> servicePid):</span><br><span class="line">        TClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">                cameraId, api1CameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">        mSharedCameraCallbacks(remoteCallback),</span><br><span class="line">        mDeviceVersion(cameraService-&gt;getDeviceVersion(TClientBase::mCameraIdStr)),</span><br><span class="line">        mDevice(<span class="keyword">new</span> Camera3Device(cameraId)),</span><br><span class="line">        mDeviceActive(<span class="literal">false</span>), mApi1CameraId(api1CameraId)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGI(<span class="string">&quot;Camera %s: Opened. Client: %s (PID %d, UID %d)&quot;</span>, cameraId.<span class="built_in">string</span>(),</span><br><span class="line">            String8(clientPackageName).<span class="built_in">string</span>(), clientPid, clientUid);</span><br><span class="line"></span><br><span class="line">    mInitialClientPid = clientPid;</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mDevice == <span class="number">0</span>, <span class="string">&quot;Device should never be NULL here.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="（2）、继续看CameraService-connectHelper函数中client-gt-initialize"><a href="#（2）、继续看CameraService-connectHelper函数中client-gt-initialize" class="headerlink" title="（2）、继续看CameraService::connectHelper函数中client-&gt;initialize()"></a>（2）、继续看CameraService::connectHelper函数中client-&gt;initialize()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp</span><br><span class="line">    <span class="function"><span class="keyword">status_t</span> <span class="title">CameraDeviceClient::initialize</span><span class="params">(sp&lt;CameraProviderManager&gt; manager,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String8&amp; monitorTags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> initializeImpl(manager, monitorTags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">CameraDeviceClient::initializeImpl</span><span class="params">(TProviderPtr providerPtr, <span class="keyword">const</span> String8&amp; monitorTags)</span> </span>&#123;</span><br><span class="line">    res = Camera2ClientBase::initialize(providerPtr, monitorTags);</span><br><span class="line">    </span><br><span class="line">    String8 threadName;</span><br><span class="line">    mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">    threadName = String8::format(<span class="string">&quot;CDU-%s-FrameProc&quot;</span>, mCameraIdStr.<span class="built_in">string</span>());</span><br><span class="line">    mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line"></span><br><span class="line">    mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">                                      FRAME_PROCESSOR_LISTENER_MAX_ID,</span><br><span class="line">                                      <span class="comment">/*listener*/</span><span class="keyword">this</span>,</span><br><span class="line">                                      <span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> deviceInfo = mDevice-&gt;info();</span><br><span class="line">    <span class="keyword">camera_metadata_entry_t</span> physicalKeysEntry = deviceInfo.find(</span><br><span class="line">            ANDROID_REQUEST_AVAILABLE_PHYSICAL_CAMERA_REQUEST_KEYS);</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mProviderManager = providerPtr;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\common\Camera2ClientBase.cpp</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initialize(sp&lt;CameraProviderManager&gt; manager,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; monitorTags) &#123;</span><br><span class="line">    <span class="keyword">return</span> initializeImpl(manager, monitorTags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TProviderPtr&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initializeImpl(TProviderPtr providerPtr,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; monitorTags) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGV(<span class="string">&quot;%s: Initializing client for camera %s&quot;</span>, __FUNCTION__,</span><br><span class="line">          TClientBase::mCameraIdStr.<span class="built_in">string</span>());</span><br><span class="line">    res = TClientBase::startCameraOps();</span><br><span class="line">    ......</span><br><span class="line">    res = mDevice-&gt;initialize(providerPtr, monitorTags);</span><br><span class="line">    ......</span><br><span class="line">    <span class="function">wp&lt;CameraDeviceBase::NotificationListener&gt; <span class="title">weakThis</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">    res = mDevice-&gt;setNotifyCallback(weakThis);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="（3）、Camera3Device-initialize"><a href="#（3）、Camera3Device-initialize" class="headerlink" title="（3）、Camera3Device::initialize"></a>（3）、Camera3Device::initialize</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3Device::initialize</span><span class="params">(sp&lt;CameraProviderManager&gt; manager, <span class="keyword">const</span> String8&amp; monitorTags)</span> </span>&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">il</span><span class="params">(mInterfaceLock)</span></span>;</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">l</span><span class="params">(mLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">&quot;%s: Initializing HIDL device for camera %s&quot;</span>, __FUNCTION__, mId.<span class="built_in">string</span>());</span><br><span class="line">    ......</span><br><span class="line">    sp&lt;ICameraDeviceSession&gt; session;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">status_t</span> res = manager-&gt;openSession(mId.<span class="built_in">string</span>(), <span class="keyword">this</span>,</span><br><span class="line">            <span class="comment">/*out*/</span> &amp;session);</span><br><span class="line">    ......</span><br><span class="line">    mInterface = <span class="keyword">new</span> HalInterface(session, <span class="built_in">queue</span>, mUseHalBufManager);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> initializeCommonLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（4）、CameraProviderManager-openSession"><a href="#（4）、CameraProviderManager-openSession" class="headerlink" title="（4）、CameraProviderManager::openSession()"></a>（4）、CameraProviderManager::openSession()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\common\CameraProviderManager.cpp</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">CameraProviderManager::openSession</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;id,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;device::V3_2::ICameraDeviceCallback&gt;&amp; callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">/*out*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;device::V3_2::ICameraDeviceSession&gt; *session)</span> </span>&#123;</span><br><span class="line">    ALOGI(<span class="string">&quot;V3_2 openSession&quot;</span>);</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mInterfaceMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> deviceInfo = findDeviceInfoLocked(id,</span><br><span class="line">            <span class="comment">/*minVersion*/</span> &#123;<span class="number">3</span>,<span class="number">0</span>&#125;, <span class="comment">/*maxVersion*/</span> &#123;<span class="number">4</span>,<span class="number">0</span>&#125;);</span><br><span class="line">    <span class="keyword">if</span> (deviceInfo == <span class="literal">nullptr</span>) <span class="keyword">return</span> NAME_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> *deviceInfo3 = <span class="keyword">static_cast</span>&lt;ProviderInfo::DeviceInfo3*&gt;(deviceInfo);</span><br><span class="line">    <span class="keyword">const</span> sp&lt;provider::V2_4::ICameraProvider&gt; provider =</span><br><span class="line">            deviceInfo-&gt;mParentProvider-&gt;startProviderInterface();</span><br><span class="line">    <span class="keyword">if</span> (provider == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">    &#125;</span><br><span class="line">    saveRef(DeviceMode::CAMERA, id, provider);</span><br><span class="line"></span><br><span class="line">    Status status;</span><br><span class="line">    hardware::Return&lt;<span class="keyword">void</span>&gt; ret;</span><br><span class="line">    <span class="keyword">auto</span> interface = deviceInfo3-&gt;startDeviceInterface&lt;</span><br><span class="line">            CameraProviderManager::ProviderInfo::DeviceInfo3::InterfaceT&gt;();</span><br><span class="line">    <span class="keyword">if</span> (interface == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CallStack <span class="built_in">stack</span>;</span><br><span class="line">    <span class="built_in">stack</span>.update();</span><br><span class="line">    <span class="built_in">stack</span>.<span class="built_in">log</span>(<span class="string">&quot;CameraProviderManager::openSession&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ret = interface-&gt;open(callback, [&amp;status, &amp;session]</span><br><span class="line">            (Status s, <span class="keyword">const</span> sp&lt;device::V3_2::ICameraDeviceSession&gt;&amp; cameraSession) &#123;</span><br><span class="line">                status = s;</span><br><span class="line">                <span class="keyword">if</span> (status == Status::OK) &#123;</span><br><span class="line">                    *session = cameraSession;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!ret.isOk()) &#123;</span><br><span class="line">        removeRef(DeviceMode::CAMERA, id);</span><br><span class="line">        ALOGE(<span class="string">&quot;%s: Transaction error opening a session for camera device %s: %s&quot;</span>,</span><br><span class="line">                __FUNCTION__, id.c_str(), ret.description().c_str());</span><br><span class="line">        <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mapToStatusT(status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此，Android open camera的流程操作到相应SOC厂商（Rockchip）的camera HAL层</p>
<h4 id="（5）、CameraDevice-open"><a href="#（5）、CameraDevice-open" class="headerlink" title="（5）、CameraDevice::open()"></a>（5）、CameraDevice::open()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\hardware\interfaces\camera\device\<span class="number">3.2</span>\<span class="keyword">default</span>\CameraDevice.cpp</span><br><span class="line"><span class="function">Return&lt;<span class="keyword">void</span>&gt; <span class="title">CameraDevice::open</span><span class="params">(<span class="keyword">const</span> sp&lt;ICameraDeviceCallback&gt;&amp; callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        ICameraDevice::open_cb _hidl_cb)</span>  </span>&#123;</span><br><span class="line">    Status status = initStatus();</span><br><span class="line">    sp&lt;CameraDeviceSession&gt; session = <span class="literal">nullptr</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (status != Status::OK) &#123;</span><br><span class="line">       .......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mLock.lock();</span><br><span class="line"></span><br><span class="line">        ALOGV(<span class="string">&quot;%s: Initializing device for camera %d&quot;</span>, __FUNCTION__, mCameraIdInt);</span><br><span class="line">        session = mSession.promote();</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">/** Open HAL device */</span></span><br><span class="line">        <span class="keyword">status_t</span> res;</span><br><span class="line">        <span class="keyword">camera3_device_t</span> *device;</span><br><span class="line"></span><br><span class="line">        ATRACE_BEGIN(<span class="string">&quot;camera3-&gt;open&quot;</span>);</span><br><span class="line">        res = mModule-&gt;open(mCameraId.c_str(),</span><br><span class="line">                <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">hw_device_t</span>**&gt;(&amp;device));</span><br><span class="line">        ATRACE_END();</span><br><span class="line">        ......</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">camera_info</span> <span class="title">info</span>;</span></span><br><span class="line">        res = mModule-&gt;getCameraInfo(mCameraIdInt, &amp;info);</span><br><span class="line">        ......</span><br><span class="line">        session = createSession(</span><br><span class="line">                device, info.static_camera_characteristics, callback);</span><br><span class="line">        ......</span><br><span class="line">        mSession = session;</span><br><span class="line"></span><br><span class="line">        IF_ALOGV() &#123;</span><br><span class="line">            session-&gt;getInterface()-&gt;interfaceChain([](</span><br><span class="line">                ::android::hardware::hidl_vec&lt;::android::hardware::hidl_string&gt; interfaceChain) &#123;</span><br><span class="line">                    ALOGV(<span class="string">&quot;Session interface chain:&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; iface : interfaceChain) &#123;</span><br><span class="line">                        ALOGV(<span class="string">&quot;  %s&quot;</span>, iface.c_str());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        mLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    _hidl_cb(status, session-&gt;getInterface());</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="（6）、Camera3HALModule-openCameraHardware"><a href="#（6）、Camera3HALModule-openCameraHardware" class="headerlink" title="（6）、Camera3HALModule::openCameraHardware()"></a>（6）、Camera3HALModule::openCameraHardware()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\hardware\rockchip\camera\Camera3HALModule.cpp</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">openCameraHardware</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">hw_device_t</span>** device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HAL_TRACE_CALL(CAM_GLBL_DBG_HIGH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sInstances[id])</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    FlashLight&amp; flash = FlashLight::getInstance();</span><br><span class="line"></span><br><span class="line">    flash.init(id);</span><br><span class="line">    flash.setCallbacks(sCallbacks);</span><br><span class="line">    flash.reserveFlashForCamera(id);</span><br><span class="line"></span><br><span class="line">    Camera3HAL* halDev = <span class="keyword">new</span> Camera3HAL(id, <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (halDev-&gt;init() != NO_ERROR) &#123;</span><br><span class="line">        LOGE(<span class="string">&quot;HAL initialization fail!&quot;</span>);</span><br><span class="line">        <span class="keyword">delete</span> halDev;</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">camera3_device_t</span> *cam3Device = halDev-&gt;getDeviceStruct();</span><br><span class="line"></span><br><span class="line">    cam3Device-&gt;common.close = hal_dev_close;</span><br><span class="line">    *device = &amp;cam3Device-&gt;common;</span><br><span class="line"></span><br><span class="line">    sInstanceCount++;</span><br><span class="line">    sInstances[id] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    CallStack <span class="built_in">stack</span>;</span><br><span class="line">    <span class="built_in">stack</span>.update();</span><br><span class="line">    <span class="built_in">stack</span>.<span class="built_in">log</span>(<span class="string">&quot;Camera3HALModule::open&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">F:\Khadas_Edge_Android_Q\hardware\rockchip\camera\AAL\Camera3HAL.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> camera3_device_ops hal_dev_ops = &#123;</span><br><span class="line">    NAMED_FIELD_INITIALIZER(initialize)                         hal_dev_initialize,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(configure_streams)                  hal_dev_configure_streams,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(register_stream_buffers)            <span class="literal">nullptr</span>,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(construct_default_request_settings) hal_dev_construct_default_request_settings,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(process_capture_request)            hal_dev_process_capture_request,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(get_metadata_vendor_tag_ops)        <span class="literal">nullptr</span>,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(dump)                               hal_dev_dump,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(flush)                              hal_dev_flush,</span><br><span class="line">    NAMED_FIELD_INITIALIZER(reserved)                           &#123;<span class="number">0</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Camera3HAL::Camera3HAL(<span class="keyword">int</span> cameraId, <span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>) :</span><br><span class="line">    mCameraId(cameraId),</span><br><span class="line">    mCameraHw(<span class="literal">nullptr</span>),</span><br><span class="line">    mRequestThread(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    LOGI(<span class="string">&quot;@%s&quot;</span>, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">camera_info</span> <span class="title">info</span>;</span></span><br><span class="line">    PlatformData::getCameraInfo(cameraId, &amp;info);</span><br><span class="line"></span><br><span class="line">    CLEAR(mDevice);</span><br><span class="line">    mDevice.common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">    mDevice.common.version = info.device_version;</span><br><span class="line">    mDevice.common.<span class="keyword">module</span> = (<span class="keyword">hw_module_t</span> *)(<span class="keyword">module</span>);</span><br><span class="line">    <span class="comment">// hal_dev_close is kept in the module for symmetry with dev_open</span></span><br><span class="line">    <span class="comment">// it will be set there</span></span><br><span class="line">    mDevice.common.close = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">//重要：初始化ops</span></span><br><span class="line">    mDevice.ops = &amp;hal_dev_ops;</span><br><span class="line">    mDevice.priv = <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3HAL::init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HAL_TRACE_CALL(CAM_GLBL_DBG_HIGH);</span><br><span class="line">    <span class="keyword">status_t</span> status = UNKNOWN_ERROR;</span><br><span class="line"></span><br><span class="line">    mCameraHw = ICameraHw::createCameraHW(mCameraId);</span><br><span class="line"></span><br><span class="line">    status = mCameraHw-&gt;init();</span><br><span class="line">    <span class="keyword">if</span> (status != NO_ERROR) &#123;</span><br><span class="line">        LOGE(<span class="string">&quot;Error initializing Camera HW&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> bail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mRequestThread = <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;RequestThread&gt;(<span class="keyword">new</span> RequestThread(mCameraId, mCameraHw));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line"></span><br><span class="line">bail:</span><br><span class="line">    deinit();</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="（7）、openCameraHardware-gt-Stack-Trace"><a href="#（7）、openCameraHardware-gt-Stack-Trace" class="headerlink" title="（7）、openCameraHardware()-&gt;Stack Trace"></a>（7）、openCameraHardware()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace: openCameraHardware()</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                          FILE:LINE</span><br><span class="line">  000d6eb7  openCameraHardware(int, hw_module_t const*, hw_device_t**)+182                                                                                                                                                                                                                                                                                                    hardware/rockchip/camera/Camera3HALModule.cpp:98</span><br><span class="line">  000d759f  hal_dev_open(hw_module_t const*, char const*, hw_device_t**)+234                                                                                                                                                                                                                                                                                                  hardware/rockchip/camera/Camera3HALModule.cpp:191</span><br><span class="line">  <span class="number">0001</span>cbb9  android::hardware::camera::common::V1_0::helper::CameraModule::open(<span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">hw_device_t</span>**)+<span class="number">48</span>                                                                                                                                                                                                                                                                hardware/interfaces/camera/common/<span class="number">1.0</span>/<span class="keyword">default</span>/CameraModule.cpp:<span class="number">397</span></span><br><span class="line">  <span class="number">00015b</span>a1  android::hardware::camera::device::V3_2::implementation::CameraDevice::open(android::sp&lt;android::hardware::camera::device::V3_2::ICameraDeviceCallback&gt; <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, android::sp&lt;android::hardware::camera::device::V3_2::ICameraDeviceSession&gt; <span class="keyword">const</span>&amp;)&gt;)+<span class="number">388</span>                                hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDevice.cpp:<span class="number">212</span></span><br><span class="line">  <span class="number">00016203</span>  android::hardware::camera::device::V3_2::implementation::CameraDevice::TrampolineDeviceInterface_3_2::open(android::sp&lt;android::hardware::camera::device::V3_2::ICameraDeviceCallback&gt; <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, android::sp&lt;android::hardware::camera::device::V3_2::ICameraDeviceSession&gt; <span class="keyword">const</span>&amp;)&gt;)+<span class="number">66</span>  hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDevice_3_2.h:<span class="number">138</span></span><br><span class="line">  <span class="number">000133</span>c1  android::hardware::camera::device::V3_2::BnHwCameraDevice::_hidl_open(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">288</span>                                                                                                                              out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceAll.cpp:<span class="number">852</span></span><br><span class="line">  <span class="number">00013</span>a5f  android::hardware::camera::device::V3_2::BnHwCameraDevice::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">390</span>                                                                                                                                        out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceAll.cpp:<span class="number">1025</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                                                                                                                        system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                                                                                                                            system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                                                                                                                     system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                                                                                                                        system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  <span class="number">00076f</span>0d  android::hardware::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                                                                                                                    system/libhwbinder/ProcessState.cpp:<span class="number">61</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                                                                                                                           system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                                                                                                                         bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>            </span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.08/cameraservice_provider.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20220415/">https://zhoujinjian.com/posts/20220415/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Camera/">Camera</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.38.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20220501/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.39.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 10 Camera源码分析9：Camera startPreview流程</div></div></a></div><div class="next-post pull-right"><a href="/posts/20220401/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.37.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 10 Camera源码分析7：Rockchip_Camera_Hal3_User_Manual</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20220515/" title="Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.40.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-15</div><div class="title">Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md</div></div></a></div><div><a href="/posts/20220101/" title="Android 10 Camera源码分析1：MIPI CSI2总结基于DPHY2.1(转载)"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.31.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">Android 10 Camera源码分析1：MIPI CSI2总结基于DPHY2.1(转载)</div></div></a></div><div><a href="/posts/20220115/" title="Android 10 Camera源码分析2：V4L2简介"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.32.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">Android 10 Camera源码分析2：V4L2简介</div></div></a></div><div><a href="/posts/20220201/" title="Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.33.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-01</div><div class="title">Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队</div></div></a></div><div><a href="/posts/20220215/" title="Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.34.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-15</div><div class="title">Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析</div></div></a></div><div><a href="/posts/20220301/" title="Android 10 Camera源码分析5：rkisp_demo分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.35.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-01</div><div class="title">Android 10 Camera源码分析5：rkisp_demo分析</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81%E4%BB%8EAPP%E5%88%B0CameraService"><span class="toc-number">1.</span> <span class="toc-text">（一）、从APP到CameraService</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81%E6%80%BB%E4%BD%93%E6%A6%82%E8%A7%88%E5%9B%BE"><span class="toc-number">1.0.1.</span> <span class="toc-text">（1）、总体概览图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81App-gt-Camera2OneCameraOpenerImpl-open"><span class="toc-number">1.0.2.</span> <span class="toc-text">（2）、App-&gt;Camera2OneCameraOpenerImpl.open()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81Framework-gt-CameraManager-openCamera"><span class="toc-number">1.0.3.</span> <span class="toc-text">（3）、Framework-&gt;CameraManager.openCamera()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81openSession-gt-StackTrace"><span class="toc-number">1.0.4.</span> <span class="toc-text">（4）、openSession()-&gt;StackTrace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81ICameraService-connectDevice"><span class="toc-number">1.0.5.</span> <span class="toc-text">（5）、ICameraService::connectDevice()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E3%80%81CameraService-connectDevice"><span class="toc-number">1.0.6.</span> <span class="toc-text">（6）、CameraService::connectDevice()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E3%80%81CameraService-makeClient"><span class="toc-number">1.0.7.</span> <span class="toc-text">（7）、CameraService::makeClient()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81%E4%BB%8ECameraService%E5%88%B0CameraProvider"><span class="toc-number">2.</span> <span class="toc-text">（二）、从CameraService到CameraProvider</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81CameraDeviceClient-CameraDeviceClient"><span class="toc-number">2.0.1.</span> <span class="toc-text">（1）、CameraDeviceClient::CameraDeviceClient()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81%E7%BB%A7%E7%BB%AD%E7%9C%8BCameraService-connectHelper%E5%87%BD%E6%95%B0%E4%B8%ADclient-gt-initialize"><span class="toc-number">2.0.2.</span> <span class="toc-text">（2）、继续看CameraService::connectHelper函数中client-&gt;initialize()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81Camera3Device-initialize"><span class="toc-number">2.0.3.</span> <span class="toc-text">（3）、Camera3Device::initialize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81CameraProviderManager-openSession"><span class="toc-number">2.0.4.</span> <span class="toc-text">（4）、CameraProviderManager::openSession()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81CameraDevice-open"><span class="toc-number">2.0.5.</span> <span class="toc-text">（5）、CameraDevice::open()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E3%80%81Camera3HALModule-openCameraHardware"><span class="toc-number">2.0.6.</span> <span class="toc-text">（6）、Camera3HALModule::openCameraHardware()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E3%80%81openCameraHardware-gt-Stack-Trace"><span class="toc-number">2.0.7.</span> <span class="toc-text">（7）、openCameraHardware()-&gt;Stack Trace</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>