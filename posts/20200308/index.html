<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android Audio System源码分析（2）：Linux &amp;&amp; Android Audio 系统驱动源码分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86） | zhoujinjian</title><meta name="keywords" content="Android,Linux,Audio"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（ ©Android @Linux 版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。（&#x3D;&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Audio System源码分析（2）：Linux &amp;&amp; Android Audio 系统驱动源码分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）">
<meta property="og:url" content="https://zhoujinjian.com/posts/20200308/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（ ©Android @Linux 版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。（&#x3D;&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00008.jpg">
<meta property="article:published_time" content="2020-03-08T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.964Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Audio">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00008.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20200308/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00008.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android Audio System源码分析（2）：Linux &amp;&amp; Android Audio 系统驱动源码分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-08T01:25:00.000Z" title="发表于 2020-03-08 09:25:00">2020-03-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.964Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Audio/">Audio</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。<strong>文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕）</strong>，转载请注明出处（ ©Android @Linux 版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。<br>（==<strong>文章基于 Kernel-3.0.86</strong>==）&amp;&amp;（==<strong>文章基于 Android 5.0.2</strong>==）<br><a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=0.0.0.0.3GsGdQ&id=20131438062">【开发板 - 友善之臂 FriendlyARM Cortex-A9 Tiny4412 ADK Exynos4412 （ Android 5.0.2）HD702高清电容屏 扩展套餐】</a><br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1jJHm74q">【开发板 Android 5.0.2 &amp;&amp; Kernel 3.0.86 源码链接： https://pan.baidu.com/s/1jJHm74q 密码：yfih】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<hr>
<hr>
<h4 id="（一）、ALSA-音频系统框架"><a href="#（一）、ALSA-音频系统框架" class="headerlink" title="（一）、ALSA 音频系统框架"></a>（一）、ALSA 音频系统框架</h4><h5 id="（1）、声卡节点"><a href="#（1）、声卡节点" class="headerlink" title="（1）、声卡节点"></a>（1）、声卡节点</h5><p>我们首先看看tiny4412的声卡节电：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@tiny4412:/ <span class="meta"># ls -l /dev/snd/</span></span><br><span class="line">crw-rw---- system   audio    <span class="number">116</span>,   <span class="number">0</span> <span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">12</span>:<span class="number">00</span> controlC0 <span class="comment">//起控制作用</span></span><br><span class="line">crw-rw---- system   audio    <span class="number">116</span>,  <span class="number">24</span> <span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">12</span>:<span class="number">00</span> pcmC0D0c  <span class="comment">//card0，device0，capture</span></span><br><span class="line">crw-rw---- system   audio    <span class="number">116</span>,  <span class="number">16</span> <span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">12</span>:<span class="number">00</span> pcmC0D0p  <span class="comment">//card0，device0，playback</span></span><br><span class="line">crw-rw---- system   audio    <span class="number">116</span>,  <span class="number">25</span> <span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">12</span>:<span class="number">00</span> pcmC0D1c  <span class="comment">//card0，device1，capture</span></span><br><span class="line">crw-rw---- system   audio    <span class="number">116</span>,  <span class="number">17</span> <span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">12</span>:<span class="number">00</span> pcmC0D1p  <span class="comment">//card0，device1，playback</span></span><br><span class="line">crw-rw---- system   audio    <span class="number">116</span>,  <span class="number">33</span> <span class="number">2016</span><span class="number">-01</span><span class="number">-01</span> <span class="number">12</span>:<span class="number">00</span> timer</span><br></pre></td></tr></table></figure>
<p>可以推断一个声卡可以有多个device，一个device有播放和录音通道。用户空间通过声卡节点访问内核空间，每个设备节点在驱动程序都有一个file_ops，上面的主设备号相同（116），对应同一个file_ops结构体。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\sound.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> major = CONFIG_SND_MAJOR; <span class="comment">// CONFIG_SND_MAJOR 为 116</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">snd_fops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    .owner =    THIS_MODULE,</span><br><span class="line">    .open =        snd_open,</span><br><span class="line">    .llseek =    noop_llseek,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">alsa_sound_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    snd_major = major;</span><br><span class="line">    snd_ecards_limit = cards_limit;</span><br><span class="line">    <span class="keyword">if</span> (register_chrdev(major, <span class="string">&quot;alsa&quot;</span>, &amp;snd_fops)) &#123;</span><br><span class="line">        snd_printk(KERN_ERR <span class="string">&quot;unable to register native major device number %d\n&quot;</span>, major);</span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (snd_info_init() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        unregister_chrdev(major, <span class="string">&quot;alsa&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    snd_info_minor_register();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MODULE</span></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Advanced Linux Sound Architecture Driver Version &quot;</span> CONFIG_SND_VERSION CONFIG_SND_DATE <span class="string">&quot;.\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> minor = iminor(inode); </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_minor</span> *<span class="title">mptr</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">old_fops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (minor &gt;= ARRAY_SIZE(snd_minors))</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    mutex_lock(&amp;sound_mutex);</span><br><span class="line">    mptr = snd_minors[minor];    <span class="comment">//根据次设备号找到一项</span></span><br><span class="line">    <span class="keyword">if</span> (mptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mptr = autoload_device(minor);</span><br><span class="line">        <span class="keyword">if</span> (!mptr) &#123;</span><br><span class="line">            mutex_unlock(&amp;sound_mutex);</span><br><span class="line">            <span class="keyword">return</span> -ENODEV;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    old_fops = file-&gt;f_op; <span class="comment">//这一项有f_op结构体</span></span><br><span class="line">    file-&gt;f_op = fops_get(mptr-&gt;f_ops);</span><br><span class="line">    <span class="keyword">if</span> (file-&gt;f_op == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        file-&gt;f_op = old_fops;</span><br><span class="line">        err = -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;sound_mutex);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file-&gt;f_op-&gt;open) &#123;</span><br><span class="line">        err = file-&gt;f_op-&gt;open(inode, file);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            fops_put(file-&gt;f_op);</span><br><span class="line">            file-&gt;f_op = fops_get(old_fops);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fops_put(old_fops);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>snd_fops  为中转作用，会根据次设备号找到具体的file_ops结构体。playback，capture都有自己的file_ops。</p>
<p>根据ALSA规范，事先定义好顶层结构体。APP就可以使用确定的接口访问声卡。</p>
<p><strong>顶层：Sound.c      snd_ops</strong></p>
<p><strong>（1）下层：controlC0 节点     snd_ctl_f_ops</strong> </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\control.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">snd_ctl_f_ops</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    .owner =    THIS_MODULE,</span><br><span class="line">    .read =        snd_ctl_read,</span><br><span class="line">    .open =        snd_ctl_open,</span><br><span class="line">    .release =    snd_ctl_release,</span><br><span class="line">    .llseek =    no_llseek,</span><br><span class="line">    .poll =        snd_ctl_poll,</span><br><span class="line">    .unlocked_ioctl =    snd_ctl_ioctl,</span><br><span class="line">    .compat_ioctl =    snd_ctl_ioctl_compat,</span><br><span class="line">    .fasync =    snd_ctl_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>（2）下层：pcmC0D0c 节点   snd_pcm_f_ops</strong><br><strong>（3）下层：pcmC0D0p 节点   snd_pcm_f_ops</strong><br>snd_pcm_f_ops是一个数组，一个对应playback，一个对应capture。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\pcm_native.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">snd_pcm_f_ops</span>[2] = &#123;</span></span><br><span class="line">    &#123;</span><br><span class="line">        .owner =        THIS_MODULE,</span><br><span class="line">        .write =        snd_pcm_write,</span><br><span class="line">        .aio_write =        snd_pcm_aio_write,</span><br><span class="line">        .open =            snd_pcm_playback_open,</span><br><span class="line">        .release =        snd_pcm_release,</span><br><span class="line">        .llseek =        no_llseek,</span><br><span class="line">        .poll =            snd_pcm_playback_poll,</span><br><span class="line">        .unlocked_ioctl =    snd_pcm_playback_ioctl,</span><br><span class="line">        .compat_ioctl =     snd_pcm_ioctl_compat,</span><br><span class="line">        .mmap =            snd_pcm_mmap,</span><br><span class="line">        .fasync =        snd_pcm_fasync,</span><br><span class="line">        .get_unmapped_area =    snd_pcm_get_unmapped_area,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .owner =        THIS_MODULE,</span><br><span class="line">        .read =            snd_pcm_read,</span><br><span class="line">        .aio_read =        snd_pcm_aio_read,</span><br><span class="line">        .open =            snd_pcm_capture_open,</span><br><span class="line">        .release =        snd_pcm_release,</span><br><span class="line">        .llseek =        no_llseek,</span><br><span class="line">        .poll =            snd_pcm_capture_poll,</span><br><span class="line">        .unlocked_ioctl =    snd_pcm_capture_ioctl,</span><br><span class="line">        .compat_ioctl =     snd_pcm_ioctl_compat,</span><br><span class="line">        .mmap =            snd_pcm_mmap,</span><br><span class="line">        .fasync =        snd_pcm_fasync,</span><br><span class="line">        .get_unmapped_area =    snd_pcm_get_unmapped_area,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="（2）、怎么写声卡驱动？"><a href="#（2）、怎么写声卡驱动？" class="headerlink" title="（2）、怎么写声卡驱动？"></a>（2）、怎么写声卡驱动？</h5><p>随便找一个声卡驱动，总结怎么写声卡驱动?</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\staging\tm6000\tm6000-alsa.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Alsa Constructor - Component probe</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tm6000_audio_init</span><span class="params">(struct tm6000_core *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span>        *<span class="title">card</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_tm6000_card</span>    *<span class="title">chip</span>;</span></span><br><span class="line">    <span class="keyword">int</span>            rc;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span>        devnr;</span><br><span class="line">    <span class="keyword">char</span>            component[<span class="number">14</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span>        *<span class="title">pcm</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    rc = snd_card_create(index[devnr], <span class="string">&quot;tm6000&quot;</span>, THIS_MODULE, <span class="number">0</span>, &amp;card);</span><br><span class="line">    ......</span><br><span class="line">    rc = snd_pcm_new(card, <span class="string">&quot;TM6000 Audio&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, &amp;pcm);</span><br><span class="line">    ......</span><br><span class="line">    rc = snd_card_register(card);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>sound/core/sound.c      实现了最顶层的file_operations，它起中转作用<br>sound/core/control.c     实现了控制接口的file_operations<br>sound/core/pcm_native.c 实现了playback, capture的file_operations</p>
<p>这些file_operations规定了ALSA接口</p>
<p> 实现硬件相关的代码即可: 创建、设置、注册snd_card结构体:<br>a. 创建：snd_card_create //里面会创建控制接口<br>b. 设置：snd_pcm_new     // 里面会创建playback, capture接口<br>c. 注册：snd_card_register</p>
</blockquote>
<p>sound.c中确定最顶层file_ops结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\sound.c</span><br><span class="line">register_chrdev(major, <span class="string">&quot;alsa&quot;</span>, &amp;snd_fops) <span class="comment">//确定最顶层file_ops结构体</span></span><br></pre></td></tr></table></figure>


<h5 id="2-1、snd-card-create"><a href="#2-1、snd-card-create" class="headerlink" title="2.1、snd_card_create"></a>2.1、snd_card_create</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\init.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_card_create</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">const</span> <span class="keyword">char</span> *xid,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct <span class="keyword">module</span> *<span class="keyword">module</span>, <span class="keyword">int</span> extra_size,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct snd_card **card_ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, idx2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card_ret))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    *card_ret = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (extra_size &lt; <span class="number">0</span>)</span><br><span class="line">        extra_size = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//创建分配snd_card结构体</span></span><br><span class="line">    card = kzalloc(<span class="keyword">sizeof</span>(*card) + extra_size, GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line">    snd_cards_lock |= <span class="number">1</span> &lt;&lt; idx;        <span class="comment">/* lock it */</span></span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= snd_ecards_limit)</span><br><span class="line">        snd_ecards_limit = idx + <span class="number">1</span>; <span class="comment">/* increase the limit */</span></span><br><span class="line">    mutex_unlock(&amp;snd_card_mutex);</span><br><span class="line">    card-&gt;number = idx;</span><br><span class="line">    card-&gt;<span class="keyword">module</span> = <span class="keyword">module</span>;</span><br><span class="line">    INIT_LIST_HEAD(&amp;card-&gt;devices);</span><br><span class="line">    init_rwsem(&amp;card-&gt;controls_rwsem);</span><br><span class="line">    rwlock_init(&amp;card-&gt;ctl_files_rwlock);</span><br><span class="line">    INIT_LIST_HEAD(&amp;card-&gt;controls);</span><br><span class="line">    INIT_LIST_HEAD(&amp;card-&gt;ctl_files);</span><br><span class="line">    spin_lock_init(&amp;card-&gt;files_lock);</span><br><span class="line">    INIT_LIST_HEAD(&amp;card-&gt;files_list);</span><br><span class="line">    init_waitqueue_head(&amp;card-&gt;shutdown_sleep);</span><br><span class="line">    atomic_set(&amp;card-&gt;refcount, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* the control interface cannot be accessed from the user space until */</span></span><br><span class="line">    <span class="comment">/* snd_cards_bitmask and snd_cards are set with snd_card_register */</span></span><br><span class="line">    err = snd_ctl_create(card);</span><br><span class="line">    ......</span><br><span class="line">    err = snd_info_card_create(card);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (extra_size &gt; <span class="number">0</span>)</span><br><span class="line">        card-&gt;private_data = (<span class="keyword">char</span> *)card + <span class="keyword">sizeof</span>(struct snd_card);</span><br><span class="line">    *card_ret = card;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      __error_ctl:</span><br><span class="line">    snd_device_free_all(card, SNDRV_DEV_CMD_PRE);</span><br><span class="line">      __error:</span><br><span class="line">    kfree(card);</span><br><span class="line">      <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="2-1-1、snd-ctl-create-创建控制接口"><a href="#2-1-1、snd-ctl-create-创建控制接口" class="headerlink" title="2.1.1、snd_ctl_create 创建控制接口"></a>2.1.1、snd_ctl_create 创建控制接口</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\control.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * create control core:</span></span><br><span class="line"><span class="comment"> * called from init.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_ctl_create</span><span class="params">(struct snd_card *card)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_device_ops</span> <span class="title">ops</span> = &#123;</span></span><br><span class="line">        .dev_free = snd_ctl_dev_free,</span><br><span class="line">        .dev_register =    snd_ctl_dev_register,</span><br><span class="line">        .dev_disconnect = snd_ctl_dev_disconnect,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    <span class="keyword">return</span> snd_device_new(card, SNDRV_DEV_CONTROL, card, &amp;ops);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\device.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_device_new</span><span class="params">(struct snd_card *card, <span class="keyword">snd_device_type_t</span> type,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">void</span> *device_data, struct snd_device_ops *ops)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card || !device_data || !ops))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    dev = kzalloc(<span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (dev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        snd_printk(KERN_ERR <span class="string">&quot;Cannot allocate device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    dev-&gt;card = card;</span><br><span class="line">    dev-&gt;type = type;</span><br><span class="line">    dev-&gt;state = SNDRV_DEV_BUILD;</span><br><span class="line">    dev-&gt;device_data = device_data;</span><br><span class="line">    dev-&gt;ops = ops;</span><br><span class="line">    list_add(&amp;dev-&gt;<span class="built_in">list</span>, &amp;card-&gt;devices);    <span class="comment">/* add to the head of list */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\control.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * registration of the control device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_ctl_dev_register</span><span class="params">(struct snd_device *device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span> = <span class="title">device</span>-&gt;<span class="title">device_data</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, cardnum;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    cardnum = card-&gt;number;</span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(cardnum &lt; <span class="number">0</span> || cardnum &gt;= SNDRV_CARDS))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    <span class="built_in">sprintf</span>(name, <span class="string">&quot;controlC%i&quot;</span>, cardnum);</span><br><span class="line">    <span class="keyword">if</span> ((err = snd_register_device(SNDRV_DEVICE_TYPE_CONTROL, card, <span class="number">-1</span>,</span><br><span class="line">                       &amp;snd_ctl_f_ops, card, name)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-2、snd-pcm-new"><a href="#2-2、snd-pcm-new" class="headerlink" title="2.2、snd_pcm_new"></a>2.2、snd_pcm_new</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_pcm_new</span><span class="params">(struct snd_card *card, <span class="keyword">const</span> <span class="keyword">char</span> *id, <span class="keyword">int</span> device,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> playback_count, <span class="keyword">int</span> capture_count,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct snd_pcm ** rpcm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_device_ops</span> <span class="title">ops</span> = &#123;</span></span><br><span class="line">        .dev_free = snd_pcm_dev_free,</span><br><span class="line">        .dev_register =    snd_pcm_dev_register,</span><br><span class="line">        .dev_disconnect = snd_pcm_dev_disconnect,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    <span class="keyword">if</span> (rpcm)</span><br><span class="line">        *rpcm = <span class="literal">NULL</span>;</span><br><span class="line">    pcm = kzalloc(<span class="keyword">sizeof</span>(*pcm), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (pcm == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        snd_printk(KERN_ERR <span class="string">&quot;Cannot allocate PCM\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    pcm-&gt;card = card;</span><br><span class="line">    pcm-&gt;device = device;</span><br><span class="line">    <span class="keyword">if</span> (id)</span><br><span class="line">        strlcpy(pcm-&gt;id, id, <span class="keyword">sizeof</span>(pcm-&gt;id));</span><br><span class="line">    <span class="keyword">if</span> ((err = snd_pcm_new_stream(pcm, SNDRV_PCM_STREAM_PLAYBACK, playback_count)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        snd_pcm_free(pcm);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((err = snd_pcm_new_stream(pcm, SNDRV_PCM_STREAM_CAPTURE, capture_count)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        snd_pcm_free(pcm);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_init(&amp;pcm-&gt;open_mutex);</span><br><span class="line">    init_waitqueue_head(&amp;pcm-&gt;open_wait);</span><br><span class="line">    <span class="keyword">if</span> ((err = snd_device_new(card, SNDRV_DEV_PCM, pcm, &amp;ops)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        snd_pcm_free(pcm);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rpcm)</span><br><span class="line">        *rpcm = pcm;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_pcm_dev_register</span><span class="params">(struct snd_device *device)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cidx, err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_substream</span> *<span class="title">substream</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_notify</span> *<span class="title">notify</span>;</span></span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">16</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!device || !device-&gt;device_data))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    pcm = device-&gt;device_data;</span><br><span class="line">    mutex_lock(&amp;register_mutex);</span><br><span class="line">    err = snd_pcm_add(pcm);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        mutex_unlock(&amp;register_mutex);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (cidx = <span class="number">0</span>; cidx &lt; <span class="number">2</span>; cidx++) &#123;</span><br><span class="line">        <span class="keyword">int</span> devtype = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (pcm-&gt;streams[cidx].substream == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">switch</span> (cidx) &#123;</span><br><span class="line">        <span class="keyword">case</span> SNDRV_PCM_STREAM_PLAYBACK:</span><br><span class="line">            <span class="built_in">sprintf</span>(str, <span class="string">&quot;pcmC%iD%ip&quot;</span>, pcm-&gt;card-&gt;number, pcm-&gt;device);</span><br><span class="line">            devtype = SNDRV_DEVICE_TYPE_PCM_PLAYBACK;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SNDRV_PCM_STREAM_CAPTURE:</span><br><span class="line">            <span class="built_in">sprintf</span>(str, <span class="string">&quot;pcmC%iD%ic&quot;</span>, pcm-&gt;card-&gt;number, pcm-&gt;device);</span><br><span class="line">            devtype = SNDRV_DEVICE_TYPE_PCM_CAPTURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* device pointer to use, pcm-&gt;dev takes precedence if</span></span><br><span class="line"><span class="comment">         * it is assigned, otherwise fall back to card&#x27;s device</span></span><br><span class="line"><span class="comment">         * if possible */</span></span><br><span class="line">        dev = pcm-&gt;dev;</span><br><span class="line">        <span class="keyword">if</span> (!dev)</span><br><span class="line">            dev = snd_card_get_device_link(pcm-&gt;card);</span><br><span class="line">        <span class="comment">/* register pcm */</span></span><br><span class="line">        err = snd_register_device_for_dev(devtype, pcm-&gt;card,</span><br><span class="line">                          pcm-&gt;device,</span><br><span class="line">                          &amp;snd_pcm_f_ops[cidx],</span><br><span class="line">                          pcm, str, dev);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            list_del(&amp;pcm-&gt;<span class="built_in">list</span>);</span><br><span class="line">            mutex_unlock(&amp;register_mutex);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        snd_add_device_sysfs_file(devtype, pcm-&gt;card, pcm-&gt;device,</span><br><span class="line">                      &amp;pcm_attrs);</span><br><span class="line">        <span class="keyword">for</span> (substream = pcm-&gt;streams[cidx].substream; substream; substream = substream-&gt;next)</span><br><span class="line">            snd_pcm_timer_init(substream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(notify, &amp;snd_pcm_notify_list, <span class="built_in">list</span>)</span><br><span class="line">        notify-&gt;n_register(pcm);</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;register_mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个pcm就是一个逻辑设备device<br>一个pcm两个stream，playback，capture</p>
<p>何时注册，使用结构体？</p>
<h5 id="2-3、snd-card-regsiter"><a href="#2-3、snd-card-regsiter" class="headerlink" title="2.3、snd_card_regsiter"></a>2.3、snd_card_regsiter</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\init.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_card_register</span><span class="params">(struct snd_card *card)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!card-&gt;card_dev) &#123;</span><br><span class="line">        card-&gt;card_dev = device_create(sound_class, card-&gt;dev,</span><br><span class="line">                           MKDEV(<span class="number">0</span>, <span class="number">0</span>), card,</span><br><span class="line">                           <span class="string">&quot;card%i&quot;</span>, card-&gt;number);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(card-&gt;card_dev))</span><br><span class="line">            card-&gt;card_dev = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((err = snd_device_register_all(card)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    mutex_lock(&amp;snd_card_mutex);</span><br><span class="line">    <span class="keyword">if</span> (snd_cards[card-&gt;number]) &#123;</span><br><span class="line">        <span class="comment">/* already registered */</span></span><br><span class="line">        mutex_unlock(&amp;snd_card_mutex);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    snd_card_set_id_no_lock(card, card-&gt;id[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span> ? <span class="literal">NULL</span> : card-&gt;id);</span><br><span class="line">    snd_cards[card-&gt;number] = card;</span><br><span class="line">    mutex_unlock(&amp;snd_card_mutex);</span><br><span class="line">    init_info_for_card(card);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_SND_MIXER_OSS) || defined(CONFIG_SND_MIXER_OSS_MODULE)</span></span><br><span class="line">    <span class="keyword">if</span> (snd_mixer_oss_notify_callback)</span><br><span class="line">        snd_mixer_oss_notify_callback(card, SND_MIXER_OSS_NOTIFY_REGISTER);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (card-&gt;card_dev) &#123;</span><br><span class="line">        err = device_create_file(card-&gt;card_dev, &amp;card_id_attrs);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        err = device_create_file(card-&gt;card_dev, &amp;card_number_attrs);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * register all the devices on the card.</span></span><br><span class="line"><span class="comment"> * called from init.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_device_register_all</span><span class="params">(struct snd_card *card)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!card))</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    list_for_each_entry(dev, &amp;card-&gt;devices, <span class="built_in">list</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dev-&gt;state == SNDRV_DEV_BUILD &amp;&amp; dev-&gt;ops-&gt;dev_register) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = dev-&gt;ops-&gt;dev_register(dev)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            dev-&gt;state = SNDRV_DEV_REGISTERED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>前面设置了snd_ctl_dev_register 和  snd_pcm_dev_register，dev-&gt;ops-&gt;dev_register(dev) 就会调用对应的<br>dev_register函数完成注册。</p>
<p>上面就是大概如何写一个声卡驱动程序。</p>
<h4 id="（二）、ASoC音频驱动框架"><a href="#（二）、ASoC音频驱动框架" class="headerlink" title="（二）、ASoC音频驱动框架"></a>（二）、ASoC音频驱动框架</h4><h5 id="2-1、ASoC音频驱动框架概括"><a href="#2-1、ASoC音频驱动框架概括" class="headerlink" title="2.1、ASoC音频驱动框架概括"></a>2.1、ASoC音频驱动框架概括</h5><p>ASoC：ALSA System on Chip，是建立在标准 ALSA 驱动之上，为了更好支持嵌入式系统和应用于移动设备的音频 codec 的一套软件体系，它依赖于标准 ALSA 驱动框架。内核文档 Documentation/alsa/soc/overview.txt 中详细介绍了 ASoC 的设计初衷，这里不一一引用，简单陈述如下：</p>
<p>• 独立的 codec 驱动，标准的 ALSA 驱动框架里面 codec 驱动往往与 SoC/CPU 耦合过于紧密，不利于在多样化的平台/机器上移植复用<br>• 方便 codec 与 SoC 通过 PCM/I2S 总线建立链接<br>• 动态音频电源管理 DAPM，使得 codec 任何时候都工作在最低功耗状态，同时负责音频路由的创建<br>• POPs 和 click 音抑制弱化处理，在 ASoC 中通过正确的音频部件上下电次序来实现<br>• Machine 驱动的特定控制，比如耳机、麦克风的插拔检测，外放功放的开关<br>在概述中已经介绍了 ASoC 硬件设备驱动的三大构成：Codec、Platform 和 Machine，下面列举各驱动的功能构成：</p>
<blockquote>
<p>（1）SoC Codec Driver：</p>
</blockquote>
<p>• Codec DAI 和 PCM 的配置信息<br>• Codec 的控制接口，如 I2C/SPI<br>• Mixer 和其他音频控件<br>• Codec 的音频接口函数，见 snd_soc_dai_ops 结构体定义<br>• DAPM 描述信息<br>• DAPM 事件处理句柄<br>• DAC 数字静音控制</p>
<blockquote>
<p>（2）ASoC Platform Driver： 包括 dma 和 cpu_dai 两部分：</p>
</blockquote>
<p>• dma 驱动实现音频 dma 操作，具体见 snd_pcm_ops 结构体定义<br>• cpu_dai 驱动实现音频数字接口控制器的描述和配置</p>
<blockquote>
<p>（3）ASoC Machine Driver：</p>
</blockquote>
<p>作为链结 Platform 和 Codec 的载体，它必须配置 dai_link 为音频数据链路指定 Platform 和 Codec<br>处理机器特有的音频控件和音频事件，例如回放时打开外放功放<br>硬件设备驱动相关结构体：</p>
<p>• snd_soc_codec_driver：音频编解码芯片描述及操作函数，如控件/微件/音频路由的描述信息、时钟配置、IO 控制等<br>• snd_soc_dai_driver：音频数据接口描述及操作函数，根据 codec 端和 soc 端，分为 codec_dai 和 cpu_dai<br>• snd_soc_platform_driver：音频 dma 设备描述及操作函数<br>• snd_soc_dai_link：音频链路描述及板级操作函数</p>
<h5 id="2-2、ASoC音频驱动框架图"><a href="#2-2、ASoC音频驱动框架图" class="headerlink" title="2.2、ASoC音频驱动框架图"></a>2.2、ASoC音频驱动框架图</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/asoc_audio_arc.png" alt="enter image description here"></p>
<h5 id="2-3、ASoC音频驱动代码分析"><a href="#2-3、ASoC音频驱动代码分析" class="headerlink" title="2.3、ASoC音频驱动代码分析"></a>2.3、ASoC音频驱动代码分析</h5><h6 id="2-3-1、SoC-Codec-Driver"><a href="#2-3-1、SoC-Codec-Driver" class="headerlink" title="2.3.1、SoC Codec Driver"></a>2.3.1、SoC Codec Driver</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\codecs\wm8960.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec_driver</span> <span class="title">soc_codec_dev_wm8960</span> = &#123;</span></span><br><span class="line">    .probe =    wm8960_probe,</span><br><span class="line">    .remove =    wm8960_remove,</span><br><span class="line">    .suspend =    wm8960_suspend,</span><br><span class="line">    .resume =    wm8960_resume,</span><br><span class="line">    .set_bias_level = wm8960_set_bias_level,</span><br><span class="line">    .reg_cache_size = ARRAY_SIZE(wm8960_reg),</span><br><span class="line">    .reg_word_size = <span class="keyword">sizeof</span>(u16),</span><br><span class="line">    .reg_cache_default = wm8960_reg,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __devinit <span class="keyword">int</span> <span class="title">wm8960_i2c_probe</span><span class="params">(struct i2c_client *i2c,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> struct i2c_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wm8960_priv</span> *<span class="title">wm8960</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    wm8960 = kzalloc(<span class="keyword">sizeof</span>(struct wm8960_priv), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (wm8960 == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    i2c_set_clientdata(i2c, wm8960);</span><br><span class="line">    wm8960-&gt;control_type = SND_SOC_I2C;</span><br><span class="line">    wm8960-&gt;control_data = i2c;</span><br><span class="line"></span><br><span class="line">    ret = snd_soc_register_codec(&amp;i2c-&gt;dev,</span><br><span class="line">            &amp;soc_codec_dev_wm8960, &amp;wm8960_dai, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        kfree(wm8960);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">wm8960_i2c_id</span>[] = &#123;</span></span><br><span class="line">    &#123; <span class="string">&quot;wm8960&quot;</span>, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(i2c, wm8960_i2c_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">wm8960_i2c_driver</span> = &#123;</span></span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;wm8960-codec&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">    &#125;,</span><br><span class="line">    .probe =    wm8960_i2c_probe,</span><br><span class="line">    .remove =   __devexit_p(wm8960_i2c_remove),</span><br><span class="line">    .id_table = wm8960_i2c_id,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">wm8960_modinit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)</span></span><br><span class="line">    ret = i2c_add_driver(&amp;wm8960_i2c_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;Failed to register WM8960 I2C driver: %d\n&quot;</span>,</span><br><span class="line">               ret);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">module_init(wm8960_modinit);</span><br></pre></td></tr></table></figure>

<h6 id="2-3-2、ASoC-Platform-Driver"><a href="#2-3-2、ASoC-Platform-Driver" class="headerlink" title="2.3.2、ASoC Platform Driver"></a>2.3.2、ASoC Platform Driver</h6><p>（1）dma部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\samsung\dma-wrapper.c</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> <span class="title">asoc_platform_ops</span> = &#123;</span></span><br><span class="line">    .open        = asoc_platform_open,</span><br><span class="line">    .close        = asoc_platform_close,</span><br><span class="line">    .ioctl        = asoc_platform_ioctl,</span><br><span class="line">    .hw_params    = asoc_platform_hw_params,</span><br><span class="line">    .hw_free    = asoc_platform_hw_free,</span><br><span class="line">    .prepare    = asoc_platform_prepare,</span><br><span class="line">    .trigger    = asoc_platform_trigger,</span><br><span class="line">    .pointer    = asoc_platform_pointer,</span><br><span class="line">    .mmap        = asoc_platform_mmap,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">asoc_platform_free_dma_buffers</span><span class="params">(struct snd_pcm *pcm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_platform_driver</span> *<span class="title">platform</span> = <span class="title">asoc_get_platform</span>(<span class="title">pcm</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (platform-&gt;pcm_free)</span><br><span class="line">        platform-&gt;pcm_free(pcm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">asoc_platform_new</span><span class="params">(struct snd_card *card,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct snd_soc_dai *dai, struct snd_pcm *pcm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_platform_driver</span> *<span class="title">platform</span> = <span class="title">asoc_get_platform</span>(<span class="title">pcm</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (platform-&gt;pcm_new)</span><br><span class="line">        platform-&gt;pcm_new(card, dai, pcm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_platform_driver</span> <span class="title">asoc_dma_platform</span> = &#123;</span></span><br><span class="line">    .ops        = &amp;asoc_platform_ops,</span><br><span class="line">    .pcm_new    = asoc_platform_new,</span><br><span class="line">    .pcm_free    = asoc_platform_free_dma_buffers,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __devinit <span class="title">samsung_asoc_platform_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> snd_soc_register_platform(&amp;pdev-&gt;dev, &amp;asoc_dma_platform);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __devexit <span class="title">samsung_asoc_platform_remove</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    snd_soc_unregister_platform(&amp;pdev-&gt;dev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">asoc_platform_driver</span> = &#123;</span></span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;samsung-audio&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    .probe = samsung_asoc_platform_probe,</span><br><span class="line">    .remove = __devexit_p(samsung_asoc_platform_remove),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">samsung_asoc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;asoc_platform_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(samsung_asoc_init);</span><br></pre></td></tr></table></figure>
<p>（2）cpu_dai部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\samsung\i2s.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __devinit <span class="keyword">int</span> <span class="title">samsung_i2s_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 dma_pl_chan, dma_cp_chan, dma_pl_sec_chan;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2s_dai</span> *<span class="title">pri_dai</span>, *<span class="title">sec_dai</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3c_audio_pdata</span> *<span class="title">i2s_pdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">samsung_i2s</span> *<span class="title">i2s_cfg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line">    u32 regs_base, quirks;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Call during Seconday interface registration */</span></span><br><span class="line">    <span class="keyword">if</span> (pdev-&gt;id &gt;= SAMSUNG_I2S_SECOFF) &#123;</span><br><span class="line">        sec_dai = dev_get_drvdata(&amp;pdev-&gt;dev);</span><br><span class="line">        snd_soc_register_dai(&amp;sec_dai-&gt;pdev-&gt;dev,</span><br><span class="line">            &amp;sec_dai-&gt;i2s_dai_drv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i2s_pdata = pdev-&gt;dev.platform_data;</span><br><span class="line"></span><br><span class="line">    res = platform_get_resource(pdev, IORESOURCE_DMA, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    dma_pl_chan = res-&gt;start;</span><br><span class="line"></span><br><span class="line">    res = platform_get_resource(pdev, IORESOURCE_DMA, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    dma_cp_chan = res-&gt;start;</span><br><span class="line"></span><br><span class="line">    res = platform_get_resource(pdev, IORESOURCE_DMA, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (res)</span><br><span class="line">        dma_pl_sec_chan = res-&gt;start;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dma_pl_sec_chan = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">    ......</span><br><span class="line">    regs_base = res-&gt;start;</span><br><span class="line"></span><br><span class="line">    i2s_cfg = &amp;i2s_pdata-&gt;type.i2s;</span><br><span class="line">    quirks = i2s_cfg-&gt;quirks;</span><br><span class="line"></span><br><span class="line">    pri_dai = i2s_alloc_dai(pdev, <span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    pri_dai-&gt;dma_playback.dma_addr = regs_base + I2STXD;</span><br><span class="line">    pri_dai-&gt;dma_capture.dma_addr = regs_base + I2SRXD;</span><br><span class="line">    pri_dai-&gt;dma_playback.client =</span><br><span class="line">        (struct s3c2410_dma_client *)&amp;pri_dai-&gt;dma_playback;</span><br><span class="line">    pri_dai-&gt;dma_capture.client =</span><br><span class="line">        (struct s3c2410_dma_client *)&amp;pri_dai-&gt;dma_capture;</span><br><span class="line">    pri_dai-&gt;dma_playback.channel = dma_pl_chan;</span><br><span class="line">    pri_dai-&gt;dma_capture.channel = dma_cp_chan;</span><br><span class="line">    pri_dai-&gt;src_clk = i2s_cfg-&gt;src_clk;</span><br><span class="line">    pri_dai-&gt;dma_playback.dma_size = <span class="number">4</span>;</span><br><span class="line">    pri_dai-&gt;dma_capture.dma_size = <span class="number">4</span>;</span><br><span class="line">    pri_dai-&gt;base = regs_base;</span><br><span class="line">    pri_dai-&gt;quirks = quirks;</span><br><span class="line">    <span class="keyword">if</span> (pdev-&gt;id == <span class="number">0</span>) &#123;</span><br><span class="line">        pri_dai-&gt;audss_clk_enable = audss_clk_enable;</span><br><span class="line">        pri_dai-&gt;audss_suspend = audss_suspend;</span><br><span class="line">        pri_dai-&gt;audss_resume = audss_resume;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (quirks &amp; QUIRK_PRI_6CHAN)</span><br><span class="line">        pri_dai-&gt;i2s_dai_drv.playback.channels_max = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (quirks &amp; QUIRK_SEC_DAI) &#123;</span><br><span class="line">        sec_dai = i2s_alloc_dai(pdev, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!sec_dai) &#123;</span><br><span class="line">            dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Unable to alloc I2S_sec\n&quot;</span>);</span><br><span class="line">            ret = -ENOMEM;</span><br><span class="line">            <span class="keyword">goto</span> err2;</span><br><span class="line">        &#125;</span><br><span class="line">        sec_dai-&gt;dma_playback.dma_addr = regs_base + I2STXDS;</span><br><span class="line">        sec_dai-&gt;dma_playback.client =</span><br><span class="line">            (struct s3c2410_dma_client *)&amp;sec_dai-&gt;dma_playback;</span><br><span class="line">        <span class="comment">/* Use iDMA always if SysDMA not provided */</span></span><br><span class="line">        sec_dai-&gt;dma_playback.channel = dma_pl_sec_chan ? : <span class="number">-1</span>;</span><br><span class="line">        sec_dai-&gt;src_clk = i2s_cfg-&gt;src_clk;</span><br><span class="line">        sec_dai-&gt;dma_playback.dma_size = <span class="number">4</span>;</span><br><span class="line">        sec_dai-&gt;base = regs_base;</span><br><span class="line">        sec_dai-&gt;quirks = quirks;</span><br><span class="line"></span><br><span class="line">        sec_dai-&gt;pri_dai = pri_dai;</span><br><span class="line">        pri_dai-&gt;sec_dai = sec_dai;</span><br><span class="line">        <span class="keyword">if</span> (pdev-&gt;id == <span class="number">0</span>) &#123;</span><br><span class="line">            sec_dai-&gt;audss_clk_enable = audss_clk_enable;</span><br><span class="line">            sec_dai-&gt;audss_suspend = audss_suspend;</span><br><span class="line">            sec_dai-&gt;audss_resume = audss_resume;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    snd_soc_register_dai(&amp;pri_dai-&gt;pdev-&gt;dev, &amp;pri_dai-&gt;i2s_dai_drv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">samsung_i2s_driver</span> = &#123;</span></span><br><span class="line">    .probe  = samsung_i2s_probe,</span><br><span class="line">    .remove = samsung_i2s_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;samsung-i2s&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">samsung_i2s_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;samsung_i2s_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(samsung_i2s_init);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="2-3-3、ASoC-Machine-Driver"><a href="#2-3-3、ASoC-Machine-Driver" class="headerlink" title="2.3.3、ASoC Machine Driver"></a>2.3.3、ASoC Machine Driver</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\samsung\tiny4412_wm8960.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai_link</span> <span class="title">s3c2440_uda1341_dai_link</span> = &#123;</span></span><br><span class="line">    .name = <span class="string">&quot;100ask_UDA1341&quot;</span>,</span><br><span class="line">    .stream_name = <span class="string">&quot;100ask_UDA1341&quot;</span>,</span><br><span class="line">    .codec_name = <span class="string">&quot;wm8960-codec.0-001a&quot;</span>,</span><br><span class="line">    .codec_dai_name = <span class="string">&quot;wm8960-hifi&quot;</span>,</span><br><span class="line">    .cpu_dai_name = <span class="string">&quot;samsung-i2s.0&quot;</span>,</span><br><span class="line">    .ops = &amp;s3c2440_uda1341_ops,</span><br><span class="line">    .platform_name    = <span class="string">&quot;samsung-audio&quot;</span>,</span><br><span class="line">    .init = tiny4412_wm8960_machine_init,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_card</span> <span class="title">myalsa_card</span> = &#123;</span></span><br><span class="line">    .name = <span class="string">&quot;S3C2440_UDA1341&quot;</span>,</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .dai_link = &amp;s3c2440_uda1341_dai_link,</span><br><span class="line">    .num_links = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">asoc_release</span><span class="params">(struct device * dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> <span class="title">asoc_dev</span> = &#123;</span></span><br><span class="line">    .name         = <span class="string">&quot;soc-audio&quot;</span>,</span><br><span class="line">    .id       = <span class="number">-1</span>,</span><br><span class="line">    .dev = &#123; </span><br><span class="line">        .release = asoc_release, </span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c2440_uda1341_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    platform_set_drvdata(&amp;asoc_dev, &amp;myalsa_card);</span><br><span class="line">    platform_device_register(&amp;asoc_dev);    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-4、ASoC音频驱动代码分析"><a href="#2-4、ASoC音频驱动代码分析" class="headerlink" title="2.4、ASoC音频驱动代码分析"></a>2.4、ASoC音频驱动代码分析</h5><p>latform_device 还有个好伙伴 platform_driver 跟它配对。而 .name=”soc-audio” 的 platform_driver 定义在 soc-core.c 中：<br>两者匹配后，soc_probe() 会被调用，继而调用 snd_soc_register_card() 注册声卡。由于该过程很冗长，这里不一一贴代码分析了，但整个流程是比较简单的，流程图如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/snd_soc_register_card.png" alt="enter image description here"></p>
<ul>
<li>取出 platform_device 的私有数据，该私有数据就是 snd_soc_card ；</li>
<li>snd_soc_register_card() 为每个 dai_link 分配一个 snd_soc_pcm_runtime 实例，别忘了之前提过 snd_soc_pcm_runtime 是 ASoC 的桥梁，保存着 codec、codec_dai、cpu_dai、platform 等硬件设备实例。</li>
<li>随后的工作都在 snd_soc_instantiate_card() 进行：</li>
<li>遍历 dai_list、codec_list、platform_list 链表，为每个音频链路找到对应的 cpu_dai、codec_dai、codec、platform；找到的 cpu_dai、codec_dai、codec、platform 保存到 snd_soc_pcm_runtime ，完成音频链路的设备绑定；</li>
<li>调用 snd_card_create() 创建声卡；</li>
<li>soc_probe_dai_link() 依次回调 cpu_dai、codec、platform、codec_dai 的 probe() 函数，完成各音频设备的初始化，随后调用 soc_new_pcm() 创建 pcm 逻辑设备（因为涉及到本系列的重点内容，后面具体分析这个函数）；</li>
<li>最后调用 snd_card_register() 注册声卡。<br>soc_new_pcm 源码分析：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* create a new pcm */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">soc_new_pcm</span><span class="params">(struct snd_soc_pcm_runtime *rtd, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_codec</span> *<span class="title">codec</span> = <span class="title">rtd</span>-&gt;<span class="title">codec</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_platform</span> *<span class="title">platform</span> = <span class="title">rtd</span>-&gt;<span class="title">platform</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">codec_dai</span> = <span class="title">rtd</span>-&gt;<span class="title">codec_dai</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dai</span> *<span class="title">cpu_dai</span> = <span class="title">rtd</span>-&gt;<span class="title">cpu_dai</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm_ops</span> *<span class="title">soc_pcm_ops</span> = &amp;<span class="title">rtd</span>-&gt;<span class="title">ops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_pcm</span> *<span class="title">pcm</span>;</span></span><br><span class="line">    <span class="keyword">char</span> new_name[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, playback = <span class="number">0</span>, capture = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 snd_soc_pcm_runtime 的 ops 字段，成员函数其实依次调用 machine、codec_dai、cpu_dai、platform 的回调；如 soc_pcm_hw_params：</span></span><br><span class="line">    <span class="comment">// |-&gt; rtd-&gt;dai_link-&gt;ops-&gt;hw_params() </span></span><br><span class="line">    <span class="comment">// |-&gt; codec_dai-&gt;driver-&gt;ops-&gt;hw_params() </span></span><br><span class="line">    <span class="comment">// |-&gt; cpu_dai-&gt;driver-&gt;ops-&gt;hw_params()</span></span><br><span class="line">    <span class="comment">// |-&gt; platform-&gt;driver-&gt;ops-&gt;hw_params()</span></span><br><span class="line">    <span class="comment">// 在这里把底层硬件的操作接口抽象起来，pcm native 不用知道底层硬件细节</span></span><br><span class="line">    soc_pcm_ops-&gt;open   = soc_pcm_open;</span><br><span class="line">    soc_pcm_ops-&gt;close  = soc_pcm_close;</span><br><span class="line">    soc_pcm_ops-&gt;hw_params  = soc_pcm_hw_params;</span><br><span class="line">    soc_pcm_ops-&gt;hw_free    = soc_pcm_hw_free;</span><br><span class="line">    soc_pcm_ops-&gt;prepare    = soc_pcm_prepare;</span><br><span class="line">    soc_pcm_ops-&gt;trigger    = soc_pcm_trigger;</span><br><span class="line">    soc_pcm_ops-&gt;pointer    = soc_pcm_pointer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check client and interface hw capabilities */</span></span><br><span class="line">    <span class="built_in">snprintf</span>(new_name, <span class="keyword">sizeof</span>(new_name), <span class="string">&quot;%s %s-%d&quot;</span>,</span><br><span class="line">            rtd-&gt;dai_link-&gt;stream_name, codec_dai-&gt;name, num);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (codec_dai-&gt;driver-&gt;playback.channels_min)</span><br><span class="line">        playback = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (codec_dai-&gt;driver-&gt;capture.channels_min)</span><br><span class="line">        capture = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 pcm 逻辑设备</span></span><br><span class="line">    ret = snd_pcm_new(rtd-&gt;card-&gt;snd_card, new_name,</span><br><span class="line">            num, playback, capture, &amp;pcm);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;asoc: can&#x27;t create pcm for codec %s\n&quot;</span>, codec-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DAPM dai link stream work */</span></span><br><span class="line">    INIT_DELAYED_WORK(&amp;rtd-&gt;delayed_work, close_delayed_work);</span><br><span class="line"></span><br><span class="line">    rtd-&gt;pcm = pcm;</span><br><span class="line">    pcm-&gt;private_data = rtd; <span class="comment">// pcm 的私有数据指向 snd_soc_pcm_runtime</span></span><br><span class="line">    <span class="keyword">if</span> (platform-&gt;driver-&gt;ops) &#123;</span><br><span class="line">        <span class="comment">// 初始化 snd_soc_pcm_runtime 的 ops 字段，这些与 pcm_dma 操作相关，一般我们只用留意 pointer 回调</span></span><br><span class="line">        soc_pcm_ops-&gt;mmap = platform-&gt;driver-&gt;ops-&gt;mmap;</span><br><span class="line">        soc_pcm_ops-&gt;pointer = platform-&gt;driver-&gt;ops-&gt;pointer;</span><br><span class="line">        soc_pcm_ops-&gt;ioctl = platform-&gt;driver-&gt;ops-&gt;ioctl;</span><br><span class="line">        soc_pcm_ops-&gt;copy = platform-&gt;driver-&gt;ops-&gt;copy;</span><br><span class="line">        soc_pcm_ops-&gt;silence = platform-&gt;driver-&gt;ops-&gt;silence;</span><br><span class="line">        soc_pcm_ops-&gt;ack = platform-&gt;driver-&gt;ops-&gt;ack;</span><br><span class="line">        soc_pcm_ops-&gt;page = platform-&gt;driver-&gt;ops-&gt;page;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (playback)</span><br><span class="line">        snd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, soc_pcm_ops); <span class="comment">// 把 soc_pcm_ops 赋给 playback substream 的 ops 字段</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (capture)</span><br><span class="line">        snd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, soc_pcm_ops); <span class="comment">// 把 soc_pcm_ops 赋给 capture substream 的 ops 字段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回调 dma 驱动的 pcm_new()，进行 dma buffer 内存分配和 dma 设备初始化</span></span><br><span class="line">    <span class="keyword">if</span> (platform-&gt;driver-&gt;pcm_new) &#123;</span><br><span class="line">        ret = platform-&gt;driver-&gt;pcm_new(rtd);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            pr_err(<span class="string">&quot;asoc: platform pcm constructor failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pcm-&gt;private_free = platform-&gt;driver-&gt;pcm_free;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;asoc: %s &lt;-&gt; %s mapping ok\n&quot;</span>, codec_dai-&gt;name,</span><br><span class="line">        cpu_dai-&gt;name);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可见 soc_new_pcm() 最主要的工作是创建 pcm 逻辑设备，创建回放子流和录制子流实例，并初始化回放子流和录制子流的 pcm 操作函数（数据搬运时，需要调用这些函数来驱动 codec、codec_dai、cpu_dai、dma 设备工作）。</p>
<h4 id="（三）、-声卡控制之kcontrol"><a href="#（三）、-声卡控制之kcontrol" class="headerlink" title="（三）、 声卡控制之kcontrol"></a>（三）、 声卡控制之kcontrol</h4><h5 id="（1）、snd-kcontrol结构体"><a href="#（1）、snd-kcontrol结构体" class="headerlink" title="（1）、snd_kcontrol结构体"></a>（1）、snd_kcontrol结构体</h5><p>首先看看录音电路原理图：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/audio_codec_elec.png" alt="enter image description here"><br>我们对着mic说话，声音会经过一系列线路进入声卡芯片的LINPUT1。看看声卡芯片wm8960</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/wm8960.png" alt="enter image description here"></p>
<p>LINPUT1 经过一系列部件经过ADC，对于这些部件我们需要设置相应的寄存器来启动他们，让声音转换成数字信号。<br>怎么设置这些寄存器呢？有没有统一的接口来设置他们？既是Kcontrol。</p>
<p>学习Kcontrol之前我们先来想想：</p>
<blockquote>
<p>一个芯片有多个寄存器<br>一个寄存器某些位表示某个功能<br>kcontrol有自己的读写函数</p>
<p>一个声卡有多个kcontrol<br>一个kcontrol对应一个功能，比如：音量，开关声音。<br> kcontrol有函数来设置功能</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/snd_kcontrol.png" alt="enter image description here"></p>
<h5 id="（2）、tinymix-设置kcontrol"><a href="#（2）、tinymix-设置kcontrol" class="headerlink" title="（2）、tinymix 设置kcontrol"></a>（2）、tinymix 设置kcontrol</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/tinymix_kcontrol.png" alt="enter image description here"><br>可以看到有50个kcontrol，我们可以使用tinymix 来设置kcontrol<br>tinymix “Left Input Mixer Boost Switch” 1<br>tinymix “Capture Switch” 0</p>
<h5 id="（3）、snd-soc-add-controls"><a href="#（3）、snd-soc-add-controls" class="headerlink" title="（3）、snd_soc_add_controls"></a>（3）、snd_soc_add_controls</h5><p>首先看看snd_soc_add_controls</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\codecs\wm8960.c</span><br><span class="line">    snd_soc_add_controls(codec, wm8960_snd_controls,</span><br><span class="line">                     ARRAY_SIZE(wm8960_snd_controls));</span><br><span class="line">                 </span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\soc-core.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_add_controls</span><span class="params">(struct snd_soc_codec *codec,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> struct snd_kcontrol_new *controls, <span class="keyword">int</span> num_controls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span> = <span class="title">codec</span>-&gt;<span class="title">card</span>-&gt;<span class="title">snd_card</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_controls; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">control</span> = &amp;<span class="title">controls</span>[<span class="title">i</span>];</span></span><br><span class="line">        err = snd_ctl_add(card, snd_soc_cnew(control, codec,</span><br><span class="line">                             control-&gt;name,</span><br><span class="line">                             codec-&gt;name_prefix));</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(codec-&gt;dev, <span class="string">&quot;%s: Failed to add %s: %d\n&quot;</span>,</span><br><span class="line">                codec-&gt;name, control-&gt;name, err);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>snd_kcontrol 的值由谁提供。。？由对应芯片驱动程序提供,如WM8960芯片：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\codecs\wm8960.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">wm8960_lin_boost</span>[] = &#123;</span></span><br><span class="line">SOC_DAPM_SINGLE(<span class="string">&quot;LINPUT2 Switch&quot;</span>, WM8960_LINPATH, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">SOC_DAPM_SINGLE(<span class="string">&quot;LINPUT3 Switch&quot;</span>, WM8960_LINPATH, <span class="number">7</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">SOC_DAPM_SINGLE(<span class="string">&quot;LINPUT1 Switch&quot;</span>, WM8960_LINPATH, <span class="number">8</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\soc-core.c</span><br><span class="line"></span><br><span class="line"><span class="function">struct snd_kcontrol *<span class="title">snd_soc_cnew</span><span class="params">(<span class="keyword">const</span> struct snd_kcontrol_new *_template,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span> *data, <span class="keyword">char</span> *long_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">const</span> <span class="keyword">char</span> *prefix)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> <span class="title">template</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol</span> *<span class="title">kcontrol</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *name = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> name_len;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;<span class="keyword">template</span>, _template, <span class="keyword">sizeof</span>(<span class="keyword">template</span>));</span><br><span class="line">    <span class="keyword">template</span>.index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!long_name)</span><br><span class="line">        long_name = <span class="keyword">template</span>.name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prefix) &#123;</span><br><span class="line">        name_len = <span class="built_in">strlen</span>(long_name) + <span class="built_in">strlen</span>(prefix) + <span class="number">2</span>;</span><br><span class="line">        name = kmalloc(name_len, GFP_ATOMIC);</span><br><span class="line">        <span class="keyword">if</span> (!name)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">snprintf</span>(name, name_len, <span class="string">&quot;%s %s&quot;</span>, prefix, long_name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span>.name = name;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">template</span>.name = long_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kcontrol = snd_ctl_new1(&amp;<span class="keyword">template</span>, data);</span><br><span class="line"></span><br><span class="line">    kfree(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> kcontrol;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\core\control.c</span><br><span class="line"></span><br><span class="line"><span class="function">struct snd_kcontrol *<span class="title">snd_ctl_new1</span><span class="params">(<span class="keyword">const</span> struct snd_kcontrol_new *ncontrol,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">void</span> *private_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol</span> <span class="title">kctl</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> access;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!ncontrol || !ncontrol-&gt;info))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;kctl, <span class="number">0</span>, <span class="keyword">sizeof</span>(kctl));</span><br><span class="line">    kctl.id.iface = ncontrol-&gt;iface;</span><br><span class="line">    kctl.id.device = ncontrol-&gt;device;</span><br><span class="line">    kctl.id.subdevice = ncontrol-&gt;subdevice;</span><br><span class="line">    <span class="keyword">if</span> (ncontrol-&gt;name) &#123;</span><br><span class="line">        strlcpy(kctl.id.name, ncontrol-&gt;name, <span class="keyword">sizeof</span>(kctl.id.name));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(ncontrol-&gt;name, kctl.id.name) != <span class="number">0</span>)</span><br><span class="line">            snd_printk(KERN_WARNING</span><br><span class="line">                   <span class="string">&quot;Control name &#x27;%s&#x27; truncated to &#x27;%s&#x27;\n&quot;</span>,</span><br><span class="line">                   ncontrol-&gt;name, kctl.id.name);</span><br><span class="line">    &#125;</span><br><span class="line">    kctl.id.index = ncontrol-&gt;index;</span><br><span class="line">    kctl.count = ncontrol-&gt;count ? ncontrol-&gt;count : <span class="number">1</span>;</span><br><span class="line">    access = ncontrol-&gt;access == <span class="number">0</span> ? SNDRV_CTL_ELEM_ACCESS_READWRITE :</span><br><span class="line">         (ncontrol-&gt;access &amp; (SNDRV_CTL_ELEM_ACCESS_READWRITE|</span><br><span class="line">                      SNDRV_CTL_ELEM_ACCESS_INACTIVE|</span><br><span class="line">                      SNDRV_CTL_ELEM_ACCESS_TLV_READWRITE|</span><br><span class="line">                      SNDRV_CTL_ELEM_ACCESS_TLV_COMMAND|</span><br><span class="line">                      SNDRV_CTL_ELEM_ACCESS_TLV_CALLBACK));</span><br><span class="line">    kctl.info = ncontrol-&gt;info;</span><br><span class="line">    kctl.get = ncontrol-&gt;get;</span><br><span class="line">    kctl.put = ncontrol-&gt;put;</span><br><span class="line">    kctl.tlv.p = ncontrol-&gt;tlv.p;</span><br><span class="line">    kctl.private_value = ncontrol-&gt;private_value;</span><br><span class="line">    kctl.private_data = private_data;</span><br><span class="line">    <span class="keyword">return</span> snd_ctl_new(&amp;kctl, access);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct snd_kcontrol *<span class="title">snd_ctl_new</span><span class="params">(struct snd_kcontrol *control,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> access)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol</span> *<span class="title">kctl</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (snd_BUG_ON(!control || !control-&gt;count))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (control-&gt;count &gt; MAX_CONTROL_COUNT)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    kctl = kzalloc(<span class="keyword">sizeof</span>(*kctl) + <span class="keyword">sizeof</span>(struct snd_kcontrol_volatile) * control-&gt;count, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (kctl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        snd_printk(KERN_ERR <span class="string">&quot;Cannot allocate control instance\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *kctl = *control;</span><br><span class="line">    <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; kctl-&gt;count; idx++)</span><br><span class="line">        kctl-&gt;vd[idx].access = access;</span><br><span class="line">    <span class="keyword">return</span> kctl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="（四）、-DAPM-widget-route-path"><a href="#（四）、-DAPM-widget-route-path" class="headerlink" title="（四）、 DAPM_widget_route_path"></a>（四）、 DAPM_widget_route_path</h4><p>概念：Dynamic Audio Power Management，动态音频电源管理，为移动 Linux 设备设计，使得音频系统任何时候都工作在最低功耗状态。</p>
<p>目的：使能最少的必要的部件，令音频系统正常工作。</p>
<p>原理：当音频路径发生改变（比如上层使用 tinymix 工具设置音频通路）时，或发生数据流事件（比如启动或停止播放）时，都会触发 dapm 去遍历所有邻近的音频部件，检查是否存在完整的音频路径（complete path：满足条件的音频路径，该路径上任意一个部件往前遍历能到达输入端点如 DAC/Mic/Linein，往后遍历能到达输出端点如 ADC/HP/SPK），如果存在完整的音频路径，则该路径上面的所有部件都是需要上电的，其他部件则下电。</p>
<p>部件上下电都是 dapm 根据策略自主控制的，外部无法干预，可以说 dapm 是一个专门为音频系统设计的自成体系的电源管理模块，独立于 Linux 电源管理之外。即使 SoC 休眠了，Codec 仍可以在正常工作，试想下这个情景：语音通话，modem_dai 连接到 codec_dai，语音数据不经过 SoC，因此这种情形下 SoC 可以进入睡眠以降低功耗，只保持 Codec 正常工作就行了。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/LINPUT1.png" alt="enter image description here"></p>
<p>在这个例子中，codec 中的音频通路是：LINPUT1&gt;LEFT Boost Mixer&gt;ADC；</p>
<p>Mixer有多个输入源，只要其中的某个开关使能，顺便把其他三个也使能</p>
<h5 id="（1）、widget-Route-Path概念："><a href="#（1）、widget-Route-Path概念：" class="headerlink" title="（1）、widget Route Path概念："></a>（1）、widget Route Path概念：</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/dapm_widget_route_path.png" alt="enter image description here"></p>
<h4 id="（五）、DAPM的kcontrol注册过程"><a href="#（五）、DAPM的kcontrol注册过程" class="headerlink" title="（五）、DAPM的kcontrol注册过程"></a>（五）、DAPM的kcontrol注册过程</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/snd_soc_dapm_new_controls.png" alt="enter image description here"></p>
<h5 id="（1）、snd-soc-dapm-new-controls"><a href="#（1）、snd-soc-dapm-new-controls" class="headerlink" title="（1）、snd_soc_dapm_new_controls"></a>（1）、snd_soc_dapm_new_controls</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\soc-dapm.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_controls</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> struct snd_soc_dapm_widget *widget,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        ret = snd_soc_dapm_new_control(dapm, widget);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(dapm-&gt;dev,</span><br><span class="line">                <span class="string">&quot;ASoC: Failed to create DAPM control %s: %d\n&quot;</span>,</span><br><span class="line">                widget-&gt;name, ret);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        widget++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_control</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> struct snd_soc_dapm_widget *widget)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> name_len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((w = dapm_cnew_widget(widget)) == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    name_len = <span class="built_in">strlen</span>(widget-&gt;name) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (dapm-&gt;codec &amp;&amp; dapm-&gt;codec-&gt;name_prefix)</span><br><span class="line">        name_len += <span class="number">1</span> + <span class="built_in">strlen</span>(dapm-&gt;codec-&gt;name_prefix);</span><br><span class="line">    w-&gt;name = kmalloc(name_len, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (w-&gt;name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        kfree(w);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dapm-&gt;codec &amp;&amp; dapm-&gt;codec-&gt;name_prefix)</span><br><span class="line">        <span class="built_in">snprintf</span>(w-&gt;name, name_len, <span class="string">&quot;%s %s&quot;</span>,</span><br><span class="line">            dapm-&gt;codec-&gt;name_prefix, widget-&gt;name);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">snprintf</span>(w-&gt;name, name_len, <span class="string">&quot;%s&quot;</span>, widget-&gt;name);</span><br><span class="line"></span><br><span class="line">    dapm-&gt;n_widgets++;</span><br><span class="line">    w-&gt;dapm = dapm;</span><br><span class="line">    w-&gt;codec = dapm-&gt;codec;</span><br><span class="line">    INIT_LIST_HEAD(&amp;w-&gt;sources);</span><br><span class="line">    INIT_LIST_HEAD(&amp;w-&gt;sinks);</span><br><span class="line">    INIT_LIST_HEAD(&amp;w-&gt;<span class="built_in">list</span>);</span><br><span class="line">    list_add(&amp;w-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;widgets);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* machine layer set ups unconnected pins and insertions */</span></span><br><span class="line">    w-&gt;connected = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（2）、snd-soc-dapm-new-widgets"><a href="#（2）、snd-soc-dapm-new-widgets" class="headerlink" title="（2）、snd_soc_dapm_new_widgets"></a>（2）、snd_soc_dapm_new_widgets</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_widgets</span><span class="params">(struct snd_soc_dapm_context *dapm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(w, &amp;dapm-&gt;card-&gt;widgets, <span class="built_in">list</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (w-&gt;<span class="keyword">new</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (w-&gt;num_kcontrols) &#123;</span><br><span class="line">            w-&gt;kcontrols = kzalloc(w-&gt;num_kcontrols *</span><br><span class="line">                        <span class="keyword">sizeof</span>(struct snd_kcontrol *),</span><br><span class="line">                        GFP_KERNEL);</span><br><span class="line">            <span class="keyword">if</span> (!w-&gt;kcontrols)</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(w-&gt;id) &#123;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_switch:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_mixer:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_mixer_named_ctl:</span><br><span class="line">            w-&gt;power_check = dapm_generic_check_power;</span><br><span class="line">            dapm_new_mixer(w);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_mux:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_virt_mux:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_value_mux:</span><br><span class="line">            w-&gt;power_check = dapm_generic_check_power;</span><br><span class="line">            dapm_new_mux(w);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_adc:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_aif_out:</span><br><span class="line">            w-&gt;power_check = dapm_adc_check_power;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_dac:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_aif_in:</span><br><span class="line">            w-&gt;power_check = dapm_dac_check_power;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_pga:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_out_drv:</span><br><span class="line">            w-&gt;power_check = dapm_generic_check_power;</span><br><span class="line">            dapm_new_pga(w);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_input:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_output:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_micbias:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_spk:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_hp:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_mic:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_line:</span><br><span class="line">            w-&gt;power_check = dapm_generic_check_power;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_supply:</span><br><span class="line">            w-&gt;power_check = dapm_supply_check_power;</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_vmid:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_pre:</span><br><span class="line">        <span class="keyword">case</span> snd_soc_dapm_post:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read the initial power state from the device */</span></span><br><span class="line">        <span class="keyword">if</span> (w-&gt;reg &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            val = snd_soc_read(w-&gt;codec, w-&gt;reg);</span><br><span class="line">            val &amp;= <span class="number">1</span> &lt;&lt; w-&gt;shift;</span><br><span class="line">            <span class="keyword">if</span> (w-&gt;invert)</span><br><span class="line">                val = !val;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (val)</span><br><span class="line">                w-&gt;power = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        w-&gt;<span class="keyword">new</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        dapm_debugfs_add_widget(w);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dapm_power_widgets(dapm, SND_SOC_DAPM_STREAM_NOP);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>a. 对于普通的snd_kcontrol:<br>snd_soc_add_controls : snd_kcontrol_new构造出snd_kcontrol, 放入card-&gt;controls链表</p>
<p>b. 对于DAPM的snd_kcontrol, 分2步:<br>b.1 snd_soc_dapm_new_controls  // 把widget放入card-&gt;widgets链表<br>b.2 在注册machine驱动时, 导致如下调用:<br>    soc_probe_dai_link &gt; soc_post_component_init &gt; snd_soc_dapm_new_widgets</p>
<p>snd_soc_dapm_new_widgets:<br>   对于每一个widget, 设置它的power_check函数(用来判断该widget是否应该上电)<br>   对于mixer widget, 取出其中的snd_kcontrol_new构造出snd_kcontrol, 放入card-&gt;controls链表<br>   对于mux widget,它只有一个snd_kcontrol_new, 构造出snd_kcontrol, 放入card-&gt;controls链表</p>
<h4 id="（六）、route-path添加过程分析"><a href="#（六）、route-path添加过程分析" class="headerlink" title="（六）、route_path添加过程分析"></a>（六）、route_path添加过程分析</h4><h5 id="（1）、snd-soc-dapm-add-routes"><a href="#（1）、snd-soc-dapm-add-routes" class="headerlink" title="（1）、snd_soc_dapm_add_routes"></a>（1）、snd_soc_dapm_add_routes</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\codecs\wm8960.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> <span class="title">audio_paths</span>[] = &#123;</span></span><br><span class="line">    &#123; <span class="string">&quot;Left Boost Mixer&quot;</span>, <span class="string">&quot;LINPUT1 Switch&quot;</span>, <span class="string">&quot;LINPUT1&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Boost Mixer&quot;</span>, <span class="string">&quot;LINPUT2 Switch&quot;</span>, <span class="string">&quot;LINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Boost Mixer&quot;</span>, <span class="string">&quot;LINPUT3 Switch&quot;</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="string">&quot;Boost Switch&quot;</span>, <span class="string">&quot;Left Boost Mixer&quot;</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT1&quot;</span>, &#125;,  <span class="comment">/* Really Boost Switch */</span></span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Right Boost Mixer&quot;</span>, <span class="string">&quot;RINPUT1 Switch&quot;</span>, <span class="string">&quot;RINPUT1&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Boost Mixer&quot;</span>, <span class="string">&quot;RINPUT2 Switch&quot;</span>, <span class="string">&quot;RINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Boost Mixer&quot;</span>, <span class="string">&quot;RINPUT3 Switch&quot;</span>, <span class="string">&quot;RINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="string">&quot;Boost Switch&quot;</span>, <span class="string">&quot;Right Boost Mixer&quot;</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;RINPUT1&quot;</span>, &#125;,  <span class="comment">/* Really Boost Switch */</span></span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;RINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left ADC&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Input Mixer&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right ADC&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Input Mixer&quot;</span> &#125;,</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_add_routes</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> struct snd_soc_dapm_route *route, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        ret = snd_soc_dapm_add_route(dapm, route);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(dapm-&gt;dev, <span class="string">&quot;Failed to add route %s-&gt;%s\n&quot;</span>,</span><br><span class="line">                route-&gt;source, route-&gt;sink);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        route++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">snd_soc_dapm_add_route</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">const</span> struct snd_soc_dapm_route *route)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_path</span> *<span class="title">path</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">wsource</span> = <span class="title">NULL</span>, *<span class="title">wsink</span> = <span class="title">NULL</span>, *<span class="title">w</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">wtsource</span> = <span class="title">NULL</span>, *<span class="title">wtsink</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sink;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *control = route-&gt;control;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *source;</span><br><span class="line">    <span class="keyword">char</span> prefixed_sink[<span class="number">80</span>];</span><br><span class="line">    <span class="keyword">char</span> prefixed_source[<span class="number">80</span>];</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dapm-&gt;codec &amp;&amp; dapm-&gt;codec-&gt;name_prefix) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(prefixed_sink, <span class="keyword">sizeof</span>(prefixed_sink), <span class="string">&quot;%s %s&quot;</span>,</span><br><span class="line">             dapm-&gt;codec-&gt;name_prefix, route-&gt;sink);</span><br><span class="line">        sink = prefixed_sink;</span><br><span class="line">        <span class="built_in">snprintf</span>(prefixed_source, <span class="keyword">sizeof</span>(prefixed_source), <span class="string">&quot;%s %s&quot;</span>,</span><br><span class="line">             dapm-&gt;codec-&gt;name_prefix, route-&gt;source);</span><br><span class="line">        source = prefixed_source;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sink = route-&gt;sink;</span><br><span class="line">        source = route-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * find src and dest widgets over all widgets but favor a widget from</span></span><br><span class="line"><span class="comment">     * current DAPM context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    list_for_each_entry(w, &amp;dapm-&gt;card-&gt;widgets, <span class="built_in">list</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!wsink &amp;&amp; !(<span class="built_in">strcmp</span>(w-&gt;name, sink))) &#123;</span><br><span class="line">            wtsink = w;</span><br><span class="line">            <span class="keyword">if</span> (w-&gt;dapm == dapm)</span><br><span class="line">                wsink = w;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!wsource &amp;&amp; !(<span class="built_in">strcmp</span>(w-&gt;name, source))) &#123;</span><br><span class="line">            wtsource = w;</span><br><span class="line">            <span class="keyword">if</span> (w-&gt;dapm == dapm)</span><br><span class="line">                wsource = w;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* use widget from another DAPM context if not found from this */</span></span><br><span class="line">    <span class="keyword">if</span> (!wsink)</span><br><span class="line">        wsink = wtsink;</span><br><span class="line">    <span class="keyword">if</span> (!wsource)</span><br><span class="line">        wsource = wtsource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wsource == <span class="literal">NULL</span> || wsink == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">    path = kzalloc(<span class="keyword">sizeof</span>(struct snd_soc_dapm_path), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!path)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    path-&gt;source = wsource;</span><br><span class="line">    path-&gt;sink = wsink;</span><br><span class="line">    path-&gt;connected = route-&gt;connected;</span><br><span class="line">    INIT_LIST_HEAD(&amp;path-&gt;<span class="built_in">list</span>);</span><br><span class="line">    INIT_LIST_HEAD(&amp;path-&gt;list_source);</span><br><span class="line">    INIT_LIST_HEAD(&amp;path-&gt;list_sink);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check for external widgets */</span></span><br><span class="line">    <span class="keyword">if</span> (wsink-&gt;id == snd_soc_dapm_input) &#123;</span><br><span class="line">        <span class="keyword">if</span> (wsource-&gt;id == snd_soc_dapm_micbias ||</span><br><span class="line">            wsource-&gt;id == snd_soc_dapm_mic ||</span><br><span class="line">            wsource-&gt;id == snd_soc_dapm_line ||</span><br><span class="line">            wsource-&gt;id == snd_soc_dapm_output)</span><br><span class="line">            wsink-&gt;ext = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wsource-&gt;id == snd_soc_dapm_output) &#123;</span><br><span class="line">        <span class="keyword">if</span> (wsink-&gt;id == snd_soc_dapm_spk ||</span><br><span class="line">            wsink-&gt;id == snd_soc_dapm_hp ||</span><br><span class="line">            wsink-&gt;id == snd_soc_dapm_line ||</span><br><span class="line">            wsink-&gt;id == snd_soc_dapm_input)</span><br><span class="line">            wsource-&gt;ext = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* connect static paths */</span></span><br><span class="line">    <span class="keyword">if</span> (control == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);</span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);</span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);</span><br><span class="line">        path-&gt;connect = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* connect dynamic paths */</span></span><br><span class="line">    <span class="keyword">switch</span> (wsink-&gt;id) &#123;</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_adc:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_dac:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_pga:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_out_drv:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_input:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_output:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_micbias:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_vmid:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_pre:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_post:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_supply:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_aif_in:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_aif_out:</span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);</span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);</span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);</span><br><span class="line">        path-&gt;connect = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_mux:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_virt_mux:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_value_mux:</span><br><span class="line">        ret = dapm_connect_mux(dapm, wsource, wsink, path, control,</span><br><span class="line">            &amp;wsink-&gt;kcontrol_news[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_switch:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_mixer:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_mixer_named_ctl:</span><br><span class="line">        ret = dapm_connect_mixer(dapm, wsource, wsink, path, control);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_hp:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_mic:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_line:</span><br><span class="line">    <span class="keyword">case</span> snd_soc_dapm_spk:</span><br><span class="line">        list_add(&amp;path-&gt;<span class="built_in">list</span>, &amp;dapm-&gt;card-&gt;paths);</span><br><span class="line">        list_add(&amp;path-&gt;list_sink, &amp;wsink-&gt;sources);</span><br><span class="line">        list_add(&amp;path-&gt;list_source, &amp;wsource-&gt;sinks);</span><br><span class="line">        path-&gt;connect = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">    dev_warn(dapm-&gt;dev, <span class="string">&quot;asoc: no dapm match for %s --&gt; %s --&gt; %s\n&quot;</span>,</span><br><span class="line">         source, control, sink);</span><br><span class="line">    kfree(path);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/snd_soc_dapm_add_route.png" alt="enter image description here"></p>
<h5 id="（2）、route分类"><a href="#（2）、route分类" class="headerlink" title="（2）、route分类"></a>（2）、route分类</h5><h5 id="2-1、常规route"><a href="#2-1、常规route" class="headerlink" title="2.1、常规route"></a>2.1、常规route</h5><blockquote>
<p>{“sink”，NULL，”source”}          path-&gt;connect = 1</p>
</blockquote>
<h5 id="2-2、sink-widget是mixer"><a href="#2-2、sink-widget是mixer" class="headerlink" title="2.2、sink widget是mixer"></a>2.2、sink widget是mixer</h5><blockquote>
<p>{“Mux”，name1，”source1”}<br>{“Mux”，name2，”source2”}<br>(name1,name2)snd_kcontrol_new的名，可以通过操作某个kcontrol来打开某条path<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/route_sink_widget_mixer.png" alt="enter image description here"></p>
</blockquote>
<h5 id="2-3、sink-widget是Mux"><a href="#2-3、sink-widget是Mux" class="headerlink" title="2.3、sink widget是Mux"></a>2.3、sink widget是Mux</h5><blockquote>
<p>{“Mux”，value1，”source1”}<br>{“Mux”，value1，”source2”}<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/route_sink_widget_mux.png" alt="enter image description here"></p>
</blockquote>
<h4 id="（七）、DAPM的情景分析-构造过程"><a href="#（七）、DAPM的情景分析-构造过程" class="headerlink" title="（七）、DAPM的情景分析_构造过程"></a>（七）、DAPM的情景分析_构造过程</h4><p>a. kcontrol,route,path注册过程情景演示<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/dapm_how_to_create_and_use.png" alt="enter image description here"></p>
<h5 id="（1）、普通的kcontrol"><a href="#（1）、普通的kcontrol" class="headerlink" title="（1）、普通的kcontrol"></a>（1）、普通的kcontrol</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\soc-core.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_add_controls</span><span class="params">(struct snd_soc_codec *codec,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> struct snd_kcontrol_new *controls, <span class="keyword">int</span> num_controls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_card</span> *<span class="title">card</span> = <span class="title">codec</span>-&gt;<span class="title">card</span>-&gt;<span class="title">snd_card</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_controls; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_kcontrol_new</span> *<span class="title">control</span> = &amp;<span class="title">controls</span>[<span class="title">i</span>];</span></span><br><span class="line">        err = snd_ctl_add(card, snd_soc_cnew(control, codec,</span><br><span class="line">                             control-&gt;name,</span><br><span class="line">                             codec-&gt;name_prefix));</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(codec-&gt;dev, <span class="string">&quot;%s: Failed to add %s: %d\n&quot;</span>,</span><br><span class="line">                codec-&gt;name, control-&gt;name, err);</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h5 id="（2）、注册widget"><a href="#（2）、注册widget" class="headerlink" title="（2）、注册widget"></a>（2）、注册widget</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\codecs\wm8960.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">wm8960_add_widgets</span><span class="params">(struct snd_soc_codec *codec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wm8960_data</span> *<span class="title">pdata</span> = <span class="title">codec</span>-&gt;<span class="title">dev</span>-&gt;<span class="title">platform_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wm8960_priv</span> *<span class="title">wm8960</span> = <span class="title">snd_soc_codec_get_drvdata</span>(<span class="title">codec</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_context</span> *<span class="title">dapm</span> = &amp;<span class="title">codec</span>-&gt;<span class="title">dapm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> *<span class="title">w</span>;</span></span><br><span class="line"></span><br><span class="line">    snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets,</span><br><span class="line">                  ARRAY_SIZE(wm8960_dapm_widgets));</span><br><span class="line"></span><br><span class="line">    snd_soc_dapm_add_routes(dapm, audio_paths, ARRAY_SIZE(audio_paths));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* In capless mode OUT3 is used to provide VMID for the</span></span><br><span class="line"><span class="comment">     * headphone outputs, otherwise it is used as a mono mixer.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (pdata &amp;&amp; pdata-&gt;capless) &#123;</span><br><span class="line">        snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets_capless,</span><br><span class="line">                      ARRAY_SIZE(wm8960_dapm_widgets_capless));</span><br><span class="line"></span><br><span class="line">        snd_soc_dapm_add_routes(dapm, audio_paths_capless,</span><br><span class="line">                    ARRAY_SIZE(audio_paths_capless));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets_out3,</span><br><span class="line">                      ARRAY_SIZE(wm8960_dapm_widgets_out3));</span><br><span class="line"></span><br><span class="line">        snd_soc_dapm_add_routes(dapm, audio_paths_out3,</span><br><span class="line">                    ARRAY_SIZE(audio_paths_out3));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to power up the headphone output stage out of</span></span><br><span class="line"><span class="comment">     * sequence for capless mode.  To save scanning the widget</span></span><br><span class="line"><span class="comment">     * list each time to find the desired power state do so now</span></span><br><span class="line"><span class="comment">     * and save the result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    list_for_each_entry(w, &amp;codec-&gt;card-&gt;widgets, <span class="built_in">list</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (w-&gt;dapm != &amp;codec-&gt;dapm)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(w-&gt;name, <span class="string">&quot;LOUT1 PGA&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            wm8960-&gt;lout1 = w;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(w-&gt;name, <span class="string">&quot;ROUT1 PGA&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            wm8960-&gt;rout1 = w;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(w-&gt;name, <span class="string">&quot;OUT3 VMID&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            wm8960-&gt;out3 = w;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\soc-core.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_controls</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> struct snd_soc_dapm_widget *widget,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        ret = snd_soc_dapm_new_control(dapm, widget);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(dapm-&gt;dev,</span><br><span class="line">                <span class="string">&quot;ASoC: Failed to create DAPM control %s: %d\n&quot;</span>,</span><br><span class="line">                widget-&gt;name, ret);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        widget++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（3）、route-gt-path注册"><a href="#（3）、route-gt-path注册" class="headerlink" title="（3）、route=&gt;path注册"></a>（3）、route=&gt;path注册</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\sound\soc\codecs\wm8960.c</span><br><span class="line"><span class="comment">//    snd_soc_dapm_add_routes(dapm, audio_paths, ARRAY_SIZE(audio_paths));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_route</span> <span class="title">audio_paths</span>[] = &#123;</span></span><br><span class="line">    &#123; <span class="string">&quot;Left Boost Mixer&quot;</span>, <span class="string">&quot;LINPUT1 Switch&quot;</span>, <span class="string">&quot;LINPUT1&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Boost Mixer&quot;</span>, <span class="string">&quot;LINPUT2 Switch&quot;</span>, <span class="string">&quot;LINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Boost Mixer&quot;</span>, <span class="string">&quot;LINPUT3 Switch&quot;</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="string">&quot;Boost Switch&quot;</span>, <span class="string">&quot;Left Boost Mixer&quot;</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT1&quot;</span>, &#125;,  <span class="comment">/* Really Boost Switch */</span></span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Right Boost Mixer&quot;</span>, <span class="string">&quot;RINPUT1 Switch&quot;</span>, <span class="string">&quot;RINPUT1&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Boost Mixer&quot;</span>, <span class="string">&quot;RINPUT2 Switch&quot;</span>, <span class="string">&quot;RINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Boost Mixer&quot;</span>, <span class="string">&quot;RINPUT3 Switch&quot;</span>, <span class="string">&quot;RINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="string">&quot;Boost Switch&quot;</span>, <span class="string">&quot;Right Boost Mixer&quot;</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;RINPUT1&quot;</span>, &#125;,  <span class="comment">/* Really Boost Switch */</span></span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;RINPUT2&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Input Mixer&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left ADC&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Input Mixer&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right ADC&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Input Mixer&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left Output Mixer&quot;</span>, <span class="string">&quot;LINPUT3 Switch&quot;</span>, <span class="string">&quot;LINPUT3&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Left Output Mixer&quot;</span>, <span class="string">&quot;Boost Bypass Switch&quot;</span>, <span class="string">&quot;Left Boost Mixer&quot;</span>&#125; ,</span><br><span class="line">    &#123; <span class="string">&quot;Left Output Mixer&quot;</span>, <span class="string">&quot;PCM Playback Switch&quot;</span>, <span class="string">&quot;Left DAC&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Right Output Mixer&quot;</span>, <span class="string">&quot;RINPUT3 Switch&quot;</span>, <span class="string">&quot;RINPUT3&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Output Mixer&quot;</span>, <span class="string">&quot;Boost Bypass Switch&quot;</span>, <span class="string">&quot;Right Boost Mixer&quot;</span> &#125; ,</span><br><span class="line">    &#123; <span class="string">&quot;Right Output Mixer&quot;</span>, <span class="string">&quot;PCM Playback Switch&quot;</span>, <span class="string">&quot;Right DAC&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;LOUT1 PGA&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Output Mixer&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;ROUT1 PGA&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Output Mixer&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;HP_L&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;LOUT1 PGA&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;HP_R&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;ROUT1 PGA&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left Speaker PGA&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Output Mixer&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Speaker PGA&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Output Mixer&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;Left Speaker Output&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Speaker PGA&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Right Speaker Output&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Speaker PGA&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">&quot;SPK_LN&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Speaker Output&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;SPK_LP&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Left Speaker Output&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;SPK_RN&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Speaker Output&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;SPK_RP&quot;</span>, <span class="literal">NULL</span>, <span class="string">&quot;Right Speaker Output&quot;</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（4）、处理widget，确定power-check函数，对于Mux-Mixer，根据kcontrol-new创建snd-kcontrol"><a href="#（4）、处理widget，确定power-check函数，对于Mux-Mixer，根据kcontrol-new创建snd-kcontrol" class="headerlink" title="（4）、处理widget，确定power_check函数，对于Mux Mixer，根据kcontrol_new创建snd_kcontrol"></a>（4）、处理widget，确定power_check函数，对于Mux Mixer，根据kcontrol_new创建snd_kcontrol</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">snd_soc_dapm_widget</span> <span class="title">wm8960_dapm_widgets</span>[] = &#123;</span></span><br><span class="line">SND_SOC_DAPM_INPUT(<span class="string">&quot;LINPUT1&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_INPUT(<span class="string">&quot;RINPUT1&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_INPUT(<span class="string">&quot;LINPUT2&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_INPUT(<span class="string">&quot;RINPUT2&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_INPUT(<span class="string">&quot;LINPUT3&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_INPUT(<span class="string">&quot;RINPUT3&quot;</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_MICBIAS(<span class="string">&quot;MICB&quot;</span>, WM8960_POWER1, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Left Boost Mixer&quot;</span>, WM8960_POWER1, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">           wm8960_lin_boost, ARRAY_SIZE(wm8960_lin_boost)),</span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Right Boost Mixer&quot;</span>, WM8960_POWER1, <span class="number">4</span>, <span class="number">0</span>,</span><br><span class="line">           wm8960_rin_boost, ARRAY_SIZE(wm8960_rin_boost)),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Left Input Mixer&quot;</span>, WM8960_POWER3, <span class="number">5</span>, <span class="number">0</span>,</span><br><span class="line">           wm8960_lin, ARRAY_SIZE(wm8960_lin)),</span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Right Input Mixer&quot;</span>, WM8960_POWER3, <span class="number">4</span>, <span class="number">0</span>,</span><br><span class="line">           wm8960_rin, ARRAY_SIZE(wm8960_rin)),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_ADC(<span class="string">&quot;Left ADC&quot;</span>, <span class="string">&quot;Capture&quot;</span>, WM8960_POWER2, <span class="number">3</span>, <span class="number">0</span>),</span><br><span class="line">SND_SOC_DAPM_ADC(<span class="string">&quot;Right ADC&quot;</span>, <span class="string">&quot;Capture&quot;</span>, WM8960_POWER2, <span class="number">2</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_DAC(<span class="string">&quot;Left DAC&quot;</span>, <span class="string">&quot;Playback&quot;</span>, WM8960_POWER2, <span class="number">8</span>, <span class="number">0</span>),</span><br><span class="line">SND_SOC_DAPM_DAC(<span class="string">&quot;Right DAC&quot;</span>, <span class="string">&quot;Playback&quot;</span>, WM8960_POWER2, <span class="number">7</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Left Output Mixer&quot;</span>, WM8960_POWER3, <span class="number">3</span>, <span class="number">0</span>,</span><br><span class="line">    &amp;wm8960_loutput_mixer[<span class="number">0</span>],</span><br><span class="line">    ARRAY_SIZE(wm8960_loutput_mixer)),</span><br><span class="line">SND_SOC_DAPM_MIXER(<span class="string">&quot;Right Output Mixer&quot;</span>, WM8960_POWER3, <span class="number">2</span>, <span class="number">0</span>,</span><br><span class="line">    &amp;wm8960_routput_mixer[<span class="number">0</span>],</span><br><span class="line">    ARRAY_SIZE(wm8960_routput_mixer)),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_PGA(<span class="string">&quot;LOUT1 PGA&quot;</span>, WM8960_POWER2, <span class="number">6</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line">SND_SOC_DAPM_PGA(<span class="string">&quot;ROUT1 PGA&quot;</span>, WM8960_POWER2, <span class="number">5</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_PGA(<span class="string">&quot;Left Speaker PGA&quot;</span>, WM8960_POWER2, <span class="number">4</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line">SND_SOC_DAPM_PGA(<span class="string">&quot;Right Speaker PGA&quot;</span>, WM8960_POWER2, <span class="number">3</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_PGA(<span class="string">&quot;Right Speaker Output&quot;</span>, WM8960_CLASSD1, <span class="number">7</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line">SND_SOC_DAPM_PGA(<span class="string">&quot;Left Speaker Output&quot;</span>, WM8960_CLASSD1, <span class="number">6</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;SPK_LP&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;SPK_LN&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;HP_L&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;HP_R&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;SPK_RP&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;SPK_RN&quot;</span>),</span><br><span class="line">SND_SOC_DAPM_OUTPUT(<span class="string">&quot;OUT3&quot;</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    snd_soc_dapm_new_controls(dapm, wm8960_dapm_widgets,</span></span><br><span class="line"><span class="comment">//                  ARRAY_SIZE(wm8960_dapm_widgets));</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">snd_soc_dapm_new_controls</span><span class="params">(struct snd_soc_dapm_context *dapm,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> struct snd_soc_dapm_widget *widget,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        ret = snd_soc_dapm_new_control(dapm, widget);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(dapm-&gt;dev,</span><br><span class="line">                <span class="string">&quot;ASoC: Failed to create DAPM control %s: %d\n&quot;</span>,</span><br><span class="line">                widget-&gt;name, ret);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        widget++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（5）、widget上电过程"><a href="#（5）、widget上电过程" class="headerlink" title="（5）、widget上电过程"></a>（5）、widget上电过程</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/dapm_power_check.png" alt="enter image description here"></p>
<h4 id="（八）、DAPM的情景分析-使用过程"><a href="#（八）、DAPM的情景分析-使用过程" class="headerlink" title="（八）、DAPM的情景分析_使用过程"></a>（八）、DAPM的情景分析_使用过程</h4><p>a. tinymix,tinyplay,tinycap殊途同归,都会调用dapm_power_widgets<br>b. dapm的核心: complete path<br>某个widget是否要上电的判断过程 </p>
<h5 id="（1）、tinymix调用过程"><a href="#（1）、tinymix调用过程" class="headerlink" title="（1）、tinymix调用过程"></a>（1）、tinymix调用过程</h5><p>以SOC_DAPM_SINGLE(“LINPUT1 Switch”, WM8960_LINPATH, 8, 1, 0)为例:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">snd_soc_dapm_put_volsw</span><br><span class="line">    connect = xxx <span class="comment">// 根据传入的val确定</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把kcontrol要设置的reg,val写入update</span></span><br><span class="line">    update.kcontrol = kcontrol;</span><br><span class="line">    update.widget = widget;</span><br><span class="line">    update.reg = reg;</span><br><span class="line">    update.mask = mask;</span><br><span class="line">    update.val = val;</span><br><span class="line">    widget-&gt;dapm-&gt;update = &amp;update;</span><br><span class="line">    </span><br><span class="line">    dapm_mixer_update_power(widget, kcontrol, connect);</span><br><span class="line">        <span class="comment">// 找到path并设置connect</span></span><br><span class="line">        path-&gt;connect = connect;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用此函数逐个widget进行判断、上电/关闭</span></span><br><span class="line">        dapm_power_widgets(widget-&gt;dapm, SND_SOC_DAPM_STREAM_NOP);</span><br><span class="line">    </span><br><span class="line">    widget-&gt;dapm-&gt;update = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h5 id="（2）、tinyplay-tinycap调用过程"><a href="#（2）、tinyplay-tinycap调用过程" class="headerlink" title="（2）、tinyplay,tinycap调用过程"></a>（2）、tinyplay,tinycap调用过程</h5><p>播放/录音前都会调用 soc_pcm_prepare</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">soc_pcm_prepare</span><br><span class="line">    <span class="comment">// stream&#x27;s name = Playback or Capture</span></span><br><span class="line">    snd_soc_dapm_stream_event(rtd, stream<span class="number">&#x27;</span>s name, SND_SOC_DAPM_STREAM_START)</span><br><span class="line">        soc_dapm_stream_event</span><br><span class="line">            <span class="comment">// 找出每一个widget</span></span><br><span class="line">            <span class="comment">// 如果strstr(w-&gt;sname, stream) // w-&gt;sname中含有Playback or Capture</span></span><br><span class="line">            <span class="comment">// w-&gt;active = 1</span></span><br><span class="line">            </span><br><span class="line">            dapm_power_widgets</span><br></pre></td></tr></table></figure>

<p>大家都会调用dapm_power_widgets</p>
<blockquote>
<pre><code>    对于每一个widget 

power = w-&gt;power_check(w);  // 确定是否要上电</code></pre>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 放入不同的链表, 以后统一上是或关闭</span></span><br><span class="line">    <span class="keyword">if</span> (power)</span><br><span class="line">        dapm_seq_insert(w, &amp;up_list, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dapm_seq_insert(w, &amp;down_list, <span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭down_list上的所有widget</span></span><br><span class="line">    dapm_seq_run(dapm, &amp;down_list, event, <span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据dapm-&gt;update设置kcontrol, // update来自tinymix的调用</span></span><br><span class="line">    dapm_widget_update(dapm);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打开up_list上的所有widget</span></span><br><span class="line">    dapm_seq_run(dapm, &amp;up_list, event, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给链表中的widget上电或关闭</span></span><br><span class="line">dapm_seq_run</span><br><span class="line">    dapm_seq_run_coalesced</span><br><span class="line">        snd_soc_update_bits</span><br></pre></td></tr></table></figure>

<h4 id="（九）、tinycap-amp-amp-tinyplay调用流程源码分析"><a href="#（九）、tinycap-amp-amp-tinyplay调用流程源码分析" class="headerlink" title="（九）、tinycap &amp;&amp; tinyplay调用流程源码分析"></a>（九）、tinycap &amp;&amp; tinyplay调用流程源码分析</h4><h5 id="（1）、tiny4412声卡驱动录音功能调试"><a href="#（1）、tiny4412声卡驱动录音功能调试" class="headerlink" title="（1）、tiny4412声卡驱动录音功能调试"></a>（1）、tiny4412声卡驱动录音功能调试</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/WM8940_ADC_DAC.png" alt="enter image description here"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/tiny4412_wm8960_fix_record.png" alt="enter image description here"></p>
<h5 id="（2）、tinycap-amp-amp-tinyplay调用流程源码分析"><a href="#（2）、tinycap-amp-amp-tinyplay调用流程源码分析" class="headerlink" title="（2）、tinycap &amp;&amp; tinyplay调用流程源码分析"></a>（2）、tinycap &amp;&amp; tinyplay调用流程源码分析</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/tinycap_tinyplay.png" alt="enter image description here"></p>
<p>tinycap /data/charlesvincent.wav   // 录音ok<br>tinyplay /data/charlesvincent.wav   // 播放ok</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//audio 打印 log：</span></span><br><span class="line">Line <span class="number">1575</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.628618</span>] zjj.android.audio.sys platform <span class="keyword">register</span> snd-soc-dummy</span><br><span class="line">Line 1577: &lt;4&gt;[    4.628627] zjj.android.audio.sys Registered platform &#x27;snd-soc-dummy&#x27;</span><br><span class="line">Line <span class="number">1579</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.628872</span>] zjj.android.audio.sys platform <span class="keyword">register</span> samsung-audio</span><br><span class="line">Line 1581: &lt;4&gt;[    4.628878] zjj.android.audio.sys Registered platform &#x27;samsung-audio&#x27;</span><br><span class="line">Line <span class="number">1583</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.628997</span>] zjj.android.audio.sys samsung_i2s_probe snd_soc_register_dai0 i2s.c</span><br><span class="line">Line <span class="number">1585</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.629005</span>] zjj.android.audio.sys i2s_alloc_dai i2s.c</span><br><span class="line">Line <span class="number">1587</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.629160</span>] zjj.android.audio.sys samsung_i2s_probe snd_soc_register_dai1 i2s.c</span><br><span class="line">Line <span class="number">1589</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.629166</span>] zjj.android.audio.sys dai <span class="keyword">register</span> samsung-i2s<span class="number">.0</span></span><br><span class="line">Line 1591: &lt;4&gt;[    4.629174] zjj.android.audio.sys Registered DAI &#x27;samsung-i2s.0&#x27;</span><br><span class="line">Line <span class="number">1593</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.629200</span>] zjj.android.audio.sys samsung_i2s_probe snd_soc_register_dai0 i2s.c</span><br><span class="line">Line <span class="number">1595</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.629205</span>] zjj.android.audio.sys dai <span class="keyword">register</span> samsung-i2s<span class="number">.4</span></span><br><span class="line">Line 1597: &lt;4&gt;[    4.629210] zjj.android.audio.sys Registered DAI &#x27;samsung-i2s.4&#x27;</span><br><span class="line">Line <span class="number">1603</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">4.629489</span>] zjj.android.audio.sys platform <span class="keyword">register</span> samsung-audio-idma</span><br><span class="line">Line 1605: &lt;4&gt;[    4.629496] zjj.android.audio.sys Registered platform &#x27;samsung-audio-idma&#x27;</span><br><span class="line">Line <span class="number">1973</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.090438</span>] zjj.android.audio.sys codec <span class="keyword">register</span> <span class="number">0</span><span class="number">-001</span>a</span><br><span class="line">Line <span class="number">1975</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.090510</span>] zjj.android.audio.sys dai <span class="keyword">register</span> <span class="number">0</span><span class="number">-001</span>a #<span class="number">1</span></span><br><span class="line">Line 1977: &lt;4&gt;[    9.090572] zjj.android.audio.sys Registered codec &#x27;wm8960-codec.0-001a&#x27;</span><br><span class="line">Line <span class="number">1979</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.114080</span>] zjj.android.audio.sys platform_device_register soc-audio tiny4412_wm8960.c</span><br><span class="line">Line <span class="number">1981</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.114594</span>] zjj.android.audio.sys soc_probe soc-core.c</span><br><span class="line">Line <span class="number">1983</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.114688</span>] zjj.android.audio.sys soc_bind_dai_link soc-core.c</span><br><span class="line">Line <span class="number">1985</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.114753</span>] zjj.android.audio.sys snd_card_create soc-core.c</span><br><span class="line">Line <span class="number">1987</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.116842</span>] zjj.android.audio.sys soc-core.c probe S3C2440_UDA1341 dai link <span class="number">0</span></span><br><span class="line">Line <span class="number">1991</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.124088</span>] zjj.android.audio.sys wm8960_probe</span><br><span class="line">Line <span class="number">1995</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.234417</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">1997</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.234545</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">1999</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.234611</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2001</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.234679</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2003</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.235192</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2005</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.246173</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2007</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.246251</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2009</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.252225</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2011</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.258684</span>] zjj.android.audio.sys soc-core.c registered pcm #<span class="number">0</span> <span class="number">100</span>ask_UDA1341 wm8960-hifi<span class="number">-0</span></span><br><span class="line">Line <span class="number">2013</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.266114</span>] zjj.android.audio.sys snd_pcm_new pcm.c</span><br><span class="line">Line <span class="number">2019</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.280976</span>] zjj.android.audio.sys soc-core.c asoc: wm8960-hifi &lt;-&gt; samsung-i2s<span class="number">.0</span> mapping ok</span><br><span class="line">Line <span class="number">2021</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.281075</span>] zjj.android.audio.sys snd_card_register soc-core.c</span><br><span class="line">Line <span class="number">2023</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.307787</span>] zjj.android.audio.sys snd_soc_register_card soc-core.c</span><br><span class="line">Line <span class="number">2025</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.380530</span>] zjj.android.audio.sys snd_soc_dapm_put_volsw soc-dapm.c</span><br><span class="line">Line <span class="number">2027</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.380608</span>] zjj.android.audio.sys dapm_mixer_update_power soc-dapm.c</span><br><span class="line">Line <span class="number">2029</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.380698</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2031</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.380979</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2033</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.382107</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2035</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.391457</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2037</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.393502</span>] zjj.android.audio.sys snd_soc_dapm_put_volsw soc-dapm.c</span><br><span class="line">Line <span class="number">2039</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.405092</span>] zjj.android.audio.sys dapm_mixer_update_power soc-dapm.c</span><br><span class="line">Line <span class="number">2041</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.406440</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2043</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.412262</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2045</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.417412</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2047</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">9.423600</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2251</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.642371</span>] zjj.android.audio.sys snd_pcm_capture_open pcm_native.c</span><br><span class="line">Line <span class="number">2253</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.642447</span>] zjj.android.audio.sys snd_pcm_open pcm_native.c</span><br><span class="line">Line <span class="number">2255</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.643772</span>] zjj.android.audio.sys snd_pcm_do_prepare pcm_native.c</span><br><span class="line">Line <span class="number">2257</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.643842</span>] zjj.android.audio.sys soc_pcm_prepare soc-core.c</span><br><span class="line">Line <span class="number">2259</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.643920</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2261</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.650158</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2263</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.654885</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2265</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">59.660862</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2267</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">70.453890</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2269</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">70.454754</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2271</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">70.455971</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2273</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">70.456096</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2275</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.689064</span>] zjj.android.audio.sys snd_pcm_playback_open pcm_native.c</span><br><span class="line">Line <span class="number">2277</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.689140</span>] zjj.android.audio.sys snd_pcm_open pcm_native.c</span><br><span class="line">Line <span class="number">2279</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.689566</span>] zjj.android.audio.sys snd_pcm_playback_open pcm_native.c</span><br><span class="line">Line <span class="number">2281</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.689638</span>] zjj.android.audio.sys snd_pcm_open pcm_native.c</span><br><span class="line">Line <span class="number">2283</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.691460</span>] zjj.android.audio.sys snd_pcm_do_prepare pcm_native.c</span><br><span class="line">Line <span class="number">2285</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.696896</span>] zjj.android.audio.sys soc_pcm_prepare soc-core.c</span><br><span class="line">Line <span class="number">2287</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.702418</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2289</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.708425</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2291</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.713567</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2293</span>: &lt;<span class="number">4</span>&gt;[   <span class="number">88.719467</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2299</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">104.510149</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2301</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">104.510853</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2303</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">104.512003</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2305</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">104.512129</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2307</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.184433</span>] zjj.android.audio.sys snd_pcm_capture_open pcm_native.c</span><br><span class="line">Line <span class="number">2309</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.184510</span>] zjj.android.audio.sys snd_pcm_open pcm_native.c</span><br><span class="line">Line <span class="number">2311</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.185324</span>] zjj.android.audio.sys snd_pcm_do_prepare pcm_native.c</span><br><span class="line">Line <span class="number">2313</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.185397</span>] zjj.android.audio.sys soc_pcm_prepare soc-core.c</span><br><span class="line">Line <span class="number">2315</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.185683</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2317</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.191879</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2319</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.196990</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2321</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">115.202897</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2323</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">116.077184</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2325</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">116.077890</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2327</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">116.079099</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2329</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">116.079223</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2331</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.836590</span>] zjj.android.audio.sys snd_pcm_playback_open pcm_native.c</span><br><span class="line">Line <span class="number">2333</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.836666</span>] zjj.android.audio.sys snd_pcm_open pcm_native.c</span><br><span class="line">Line <span class="number">2335</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.837085</span>] zjj.android.audio.sys snd_pcm_playback_open pcm_native.c</span><br><span class="line">Line <span class="number">2337</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.837156</span>] zjj.android.audio.sys snd_pcm_open pcm_native.c</span><br><span class="line">Line <span class="number">2339</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.838975</span>] zjj.android.audio.sys snd_pcm_do_prepare pcm_native.c</span><br><span class="line">Line <span class="number">2341</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.844460</span>] zjj.android.audio.sys soc_pcm_prepare soc-core.c</span><br><span class="line">Line <span class="number">2343</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.850000</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2345</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.855998</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2347</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.862549</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2349</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">117.867224</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2355</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">123.720164</span>] zjj.android.audio.sys dapm_power_widgets soc-dapm.c</span><br><span class="line">Line <span class="number">2357</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">123.720905</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br><span class="line">Line <span class="number">2359</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">123.722064</span>] zjj.android.audio.sys dapm_widget_update soc-dapm.c</span><br><span class="line">Line <span class="number">2361</span>: &lt;<span class="number">4</span>&gt;[  <span class="number">123.722188</span>] zjj.android.audio.sys dapm_seq_run soc-dapm.c</span><br></pre></td></tr></table></figure>




<h4 id="（十）、参考文档："><a href="#（十）、参考文档：" class="headerlink" title="（十）、参考文档："></a>（十）、参考文档：</h4><p><a target="_blank" rel="noopener" href="https://github.com/weidongshan/DRV_0007_tiny4412_asoc_machine">韦老师移植后的声卡驱动</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27480328">Android音频模块启动流程分析</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/jhuster">Jhuster的专栏​ Android音频开发</a><br><a target="_blank" rel="noopener" href="http://thinks.me/2016/09/13/audio_qcom_offload/">高通audio offload学习 | Thinking</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/droidphone/article/category/1118446">DroidPhone的专栏 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/orz415678659/article/details/8866071">alsa音频架构1-CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/orz415678659/article/details/8982771">alsa音频架构2-ASoc - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/orz415678659/article/details/8995163">alsa音频架构3-Pcm - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/orz415678659/article/details/8999364">alsa音频架构4-声卡控制 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zyuanyun/article/details/59180272">Linux ALSA 音频系统：逻辑设备篇 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zyuanyun/article/details/59170418">Linux ALSA 音频系统：物理链路篇 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/column/details/12812.html">专栏：MultiMedia框架总结(基于6.0源码) - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zyuanyun/article/details/60890534">Android 音频系统：从 AudioTrack 到 AudioFlinger - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/azloong/article/category/778492">AZURE - CSDN博客 - ALSA-Android Audio</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/azloong/article/category/777239">AZURE - CSDN博客 - ANDROID音频系统</a><br><a target="_blank" rel="noopener" href="https://winddoing.github.io/2017/07/10/audio_alsa/">Audio驱动总结–ALSA | Winddoing’s Blog</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/muhe221/articles/4461543.html">audio HAL - 牧 天 - 博客园</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/xuesen_lin/article/category/1390680">林学森的Android专栏 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yangwen123/article/category/2589087">深入剖析Android音频 - CSDN博客Yangwen123</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/tocy/tag/%E6%92%AD%E6%94%BE%E6%A1%86%E6%9E%B6/">播放框架 - 标签 - Tocy - 博客园</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/miaomiao12345678/article/details/57415505">Android-7.0-Nuplayer概述 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/miaomiao12345678/article/details/56961370">Android-7.0-Nuplayer-启动流程 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/harman_zjc/article/details/53386010">Android Media Player 框架分析-Nuplayer - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/harman_zjc/article/details/53397945">Android Media Player 框架分析-AHandler AMessage ALooper - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/liu1314you/article/category/6344583">Android N Audio播放 start真面目- (六篇) CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/nonmarking/article/details/78746671">深入理解Android音视频同步机制（五篇）NuPlayer的avsync逻辑 - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014310046/article/category/6571854">wangyf的专栏 - CSDN博客-MT6737 Android N 平台 Audio系统学习</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiashaohua/article/details/53638780">Android 7.0 Audio: Mediaplayer - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/xiashaohua/article/category/6549668">Android 7.0 Audio-相关类浅析- CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/liu1314you/article/details/59119144">Android N Audio播放六：如何读取buffer - CSDN博客</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/jinzhuojun/article/details/78007568">Fuchsia OS中的RPC机制-FIDL - CSDN博客</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/linhaostudy/category/1145404.html">高通Audio中ASOC的codec驱动 - yooooooo - 博客园</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20200308/">https://zhoujinjian.com/posts/20200308/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Audio/">Audio</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00008.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20200408/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00009.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android Audio System源码分析（3）：Android Audio 系统源码分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</div></div></a></div><div class="next-post pull-right"><a href="/posts/20200208/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00007.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android Audio System 源码分析（1）：Linux &amp;&amp; Android Audio 系统框架简述（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20200208/" title="Android Audio System 源码分析（1）：Linux && Android Audio 系统框架简述（Android 5.0.2 && Kernel 3.0.86）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00007.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-08</div><div class="title">Android Audio System 源码分析（1）：Linux && Android Audio 系统框架简述（Android 5.0.2 && Kernel 3.0.86）</div></div></a></div><div><a href="/posts/20200408/" title="Android Audio System源码分析（3）：Android Audio 系统源码分析（Android 5.0.2 && Kernel 3.0.86）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00009.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-08</div><div class="title">Android Audio System源码分析（3）：Android Audio 系统源码分析（Android 5.0.2 && Kernel 3.0.86）</div></div></a></div><div><a href="/posts/20180908/" title="Audio System（1）：Linux && Android Audio 系统框架分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-09-08</div><div class="title">Audio System（1）：Linux && Android Audio 系统框架分析</div></div></a></div><div><a href="/posts/20181008/" title="Audio System（2）：Linux ALSA音频系统分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.14.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-10-08</div><div class="title">Audio System（2）：Linux ALSA音频系统分析</div></div></a></div><div><a href="/posts/20181108/" title="Audio System（3）：Android audio system(音频系统)分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.15.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-11-08</div><div class="title">Audio System（3）：Android audio system(音频系统)分析</div></div></a></div><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81ALSA-%E9%9F%B3%E9%A2%91%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6"><span class="toc-number">1.</span> <span class="toc-text">（一）、ALSA 音频系统框架</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81%E5%A3%B0%E5%8D%A1%E8%8A%82%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">（1）、声卡节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81%E6%80%8E%E4%B9%88%E5%86%99%E5%A3%B0%E5%8D%A1%E9%A9%B1%E5%8A%A8%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">（2）、怎么写声卡驱动？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81snd-card-create"><span class="toc-number">1.3.</span> <span class="toc-text">2.1、snd_card_create</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1%E3%80%81snd-ctl-create-%E5%88%9B%E5%BB%BA%E6%8E%A7%E5%88%B6%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1.1、snd_ctl_create 创建控制接口</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81snd-pcm-new"><span class="toc-number">1.4.</span> <span class="toc-text">2.2、snd_pcm_new</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3%E3%80%81snd-card-regsiter"><span class="toc-number">1.5.</span> <span class="toc-text">2.3、snd_card_regsiter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81ASoC%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="toc-number">2.</span> <span class="toc-text">（二）、ASoC音频驱动框架</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81ASoC%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E6%A6%82%E6%8B%AC"><span class="toc-number">2.1.</span> <span class="toc-text">2.1、ASoC音频驱动框架概括</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81ASoC%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%9B%BE"><span class="toc-number">2.2.</span> <span class="toc-text">2.2、ASoC音频驱动框架图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3%E3%80%81ASoC%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.3.</span> <span class="toc-text">2.3、ASoC音频驱动代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1%E3%80%81SoC-Codec-Driver"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1、SoC Codec Driver</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2%E3%80%81ASoC-Platform-Driver"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2、ASoC Platform Driver</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-3%E3%80%81ASoC-Machine-Driver"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3、ASoC Machine Driver</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4%E3%80%81ASoC%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.4.</span> <span class="toc-text">2.4、ASoC音频驱动代码分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81-%E5%A3%B0%E5%8D%A1%E6%8E%A7%E5%88%B6%E4%B9%8Bkcontrol"><span class="toc-number">3.</span> <span class="toc-text">（三）、 声卡控制之kcontrol</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81snd-kcontrol%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">3.1.</span> <span class="toc-text">（1）、snd_kcontrol结构体</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81tinymix-%E8%AE%BE%E7%BD%AEkcontrol"><span class="toc-number">3.2.</span> <span class="toc-text">（2）、tinymix 设置kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81snd-soc-add-controls"><span class="toc-number">3.3.</span> <span class="toc-text">（3）、snd_soc_add_controls</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E3%80%81-DAPM-widget-route-path"><span class="toc-number">4.</span> <span class="toc-text">（四）、 DAPM_widget_route_path</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81widget-Route-Path%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">（1）、widget Route Path概念：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E3%80%81DAPM%E7%9A%84kcontrol%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">（五）、DAPM的kcontrol注册过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81snd-soc-dapm-new-controls"><span class="toc-number">5.1.</span> <span class="toc-text">（1）、snd_soc_dapm_new_controls</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81snd-soc-dapm-new-widgets"><span class="toc-number">5.2.</span> <span class="toc-text">（2）、snd_soc_dapm_new_widgets</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%85%AD%EF%BC%89%E3%80%81route-path%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">（六）、route_path添加过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81snd-soc-dapm-add-routes"><span class="toc-number">6.1.</span> <span class="toc-text">（1）、snd_soc_dapm_add_routes</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81route%E5%88%86%E7%B1%BB"><span class="toc-number">6.2.</span> <span class="toc-text">（2）、route分类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81%E5%B8%B8%E8%A7%84route"><span class="toc-number">6.3.</span> <span class="toc-text">2.1、常规route</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81sink-widget%E6%98%AFmixer"><span class="toc-number">6.4.</span> <span class="toc-text">2.2、sink widget是mixer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3%E3%80%81sink-widget%E6%98%AFMux"><span class="toc-number">6.5.</span> <span class="toc-text">2.3、sink widget是Mux</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%83%EF%BC%89%E3%80%81DAPM%E7%9A%84%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90-%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">7.</span> <span class="toc-text">（七）、DAPM的情景分析_构造过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81%E6%99%AE%E9%80%9A%E7%9A%84kcontrol"><span class="toc-number">7.1.</span> <span class="toc-text">（1）、普通的kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81%E6%B3%A8%E5%86%8Cwidget"><span class="toc-number">7.2.</span> <span class="toc-text">（2）、注册widget</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81route-gt-path%E6%B3%A8%E5%86%8C"><span class="toc-number">7.3.</span> <span class="toc-text">（3）、route&#x3D;&gt;path注册</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81%E5%A4%84%E7%90%86widget%EF%BC%8C%E7%A1%AE%E5%AE%9Apower-check%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AF%B9%E4%BA%8EMux-Mixer%EF%BC%8C%E6%A0%B9%E6%8D%AEkcontrol-new%E5%88%9B%E5%BB%BAsnd-kcontrol"><span class="toc-number">7.4.</span> <span class="toc-text">（4）、处理widget，确定power_check函数，对于Mux Mixer，根据kcontrol_new创建snd_kcontrol</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81widget%E4%B8%8A%E7%94%B5%E8%BF%87%E7%A8%8B"><span class="toc-number">7.5.</span> <span class="toc-text">（5）、widget上电过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%85%AB%EF%BC%89%E3%80%81DAPM%E7%9A%84%E6%83%85%E6%99%AF%E5%88%86%E6%9E%90-%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">8.</span> <span class="toc-text">（八）、DAPM的情景分析_使用过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81tinymix%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">8.1.</span> <span class="toc-text">（1）、tinymix调用过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81tinyplay-tinycap%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">8.2.</span> <span class="toc-text">（2）、tinyplay,tinycap调用过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B9%9D%EF%BC%89%E3%80%81tinycap-amp-amp-tinyplay%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">9.</span> <span class="toc-text">（九）、tinycap &amp;&amp; tinyplay调用流程源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81tiny4412%E5%A3%B0%E5%8D%A1%E9%A9%B1%E5%8A%A8%E5%BD%95%E9%9F%B3%E5%8A%9F%E8%83%BD%E8%B0%83%E8%AF%95"><span class="toc-number">9.1.</span> <span class="toc-text">（1）、tiny4412声卡驱动录音功能调试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81tinycap-amp-amp-tinyplay%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">9.2.</span> <span class="toc-text">（2）、tinycap &amp;&amp; tinyplay调用流程源码分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%8D%81%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="toc-number">10.</span> <span class="toc-text">（十）、参考文档：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>