<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 10 Display System源码分析（8）：App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（1）：Activity启动流程分析（Android 10.0 &amp;&amp; Kernel 4.15） | zhoujinjian</title><meta name="keywords" content="Android,Linux,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="准备我们首先去除掉系统的： 123456adb rootadb remountadb shellrk3399_Android10:&#x2F;system&#x2F;bin # rm -rf bootanimationrk3399_Android10:&#x2F;product&#x2F;priv-app # rm -rf SystemUI&#x2F;rk3399_Android10:&#x2F;product&#x2F;priv-app # rm -rf Laun">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 10 Display System源码分析（8）：App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（1）：Activity启动流程分析（Android 10.0 &amp;&amp; Kernel 4.15）">
<meta property="og:url" content="https://zhoujinjian.com/posts/20211010/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="准备我们首先去除掉系统的： 123456adb rootadb remountadb shellrk3399_Android10:&#x2F;system&#x2F;bin # rm -rf bootanimationrk3399_Android10:&#x2F;product&#x2F;priv-app # rm -rf SystemUI&#x2F;rk3399_Android10:&#x2F;product&#x2F;priv-app # rm -rf Laun">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.29.jpg">
<meta property="article:published_time" content="2021-10-10T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.936Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.29.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20211010/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.29.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 10 Display System源码分析（8）：App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（1）：Activity启动流程分析（Android 10.0 &amp;&amp; Kernel 4.15）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-10-10T01:25:00.000Z" title="发表于 2021-10-10 09:25:00">2021-10-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.936Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Display/">Display</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h6 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h6><p>我们首先去除掉系统的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adb root</span><br><span class="line">adb remount</span><br><span class="line">adb shell</span><br><span class="line">rk3399_Android10:/system/bin <span class="meta"># rm -rf bootanimation</span></span><br><span class="line">rk3399_Android10:/product/priv-app <span class="meta"># rm -rf SystemUI/</span></span><br><span class="line">rk3399_Android10:/product/priv-app <span class="meta"># rm -rf Launcher3QuickStep/</span></span><br></pre></td></tr></table></figure>
<p>然后等待开机完成App（”com.android.testgreen”），抓取Log。setprop vendor.dump true。抓取的帧会按数字排列，还带分辨率参数。adb pull /data/dump/。抓到的bin文件可以用软件7yuv打开查看，格式设定为RGBA8888<br>App（”com.android.testgreen”）渲染图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android10.Display.8/dmlayer_fb_com.android.testred.png"><br>FrameBuffer渲染图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android10.Display.8/dmlayer_fb_com.android.testred.png"></p>
<p>效果图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android10.Display.8/Android10.com.android.test.takepic.jpg"></p>
<hr>
<p>==源码（部分）==：<br><strong>packages/apps/testViewportGreen &amp;&amp; testViewportBlue &amp;&amp; testViewportRed/</strong><br><strong>frameworks/base/core/java/android/app/</strong><br><strong>frameworks/base/services/core/java/com/android/server/wm/</strong><br><strong>frameworks/base/services/core/java/com/android/server/am/</strong><br><strong>frameworks/base/services/core/java/com/android/server/policy/</strong><br><strong>frameworks/native/services/surfaceflinger/</strong><br><strong>frameworks/native/libs/gui/</strong><br><strong>frameworks/native/libs/ui/</strong></p>
<hr>
<h4 id="一、Activity概述"><a href="#一、Activity概述" class="headerlink" title="一、Activity概述"></a>一、Activity概述</h4><p>基于Android 10.0的源码剖析， 分析Android Activity启动流程：</p>
<hr>
<h5 id="1-1、Activity的管理机制"><a href="#1-1、Activity的管理机制" class="headerlink" title="1.1、Activity的管理机制"></a>1.1、Activity的管理机制</h5><p>Android的管理主要是通过Activity栈来进行的。当一个Activity启动时，系统根据其配置或调用的方式，将Activity压入一个特定的栈中，系统处 于运行（Running or Resumed）状态。当按Back键或触发finish()方法时，Activity会从栈中被压出，进而被销毁，当有新的Activity压入栈时， 如果原Activity仍然可见，则原Activity的状态将转变为暂停（Paused）状态，如果原Activity完全被遮挡，那么其状态将转变为 停止（Stopped）。</p>
<h6 id="1-1-1、Task和Stack"><a href="#1-1-1、Task和Stack" class="headerlink" title="1.1.1、Task和Stack"></a>1.1.1、Task和Stack</h6><p>Android系统中的每一个Activity都位于一个Task中。一个Task可以包含多个Activity，同一个Activity也可能有多个实例。 在AndroidManifest.xml中，我们可以通过android:launchMode来控制Activity在Task中的实例。</p>
<h6 id="1-1-2、启动模式的作用"><a href="#1-1-2、启动模式的作用" class="headerlink" title="1.1.2、启动模式的作用"></a>1.1.2、启动模式的作用</h6><p>Activity启动模式就是属于Activity配置属性之一，叫它具有四种启动模式，分别是：1.standard ，2.singleTop，3.singleTask，4.singleInstance，一般如果不显示声明，默认为standard模式。launchMode 在多个Activity跳转的过程中扮演着重要的角色，它可以决定是否生成新的Activity实例，是否重用已存在的Activity实例，是否和其他 Activity实例公用一个task里。</p>
<h6 id="1-1-3、启动模式的作用"><a href="#1-1-3、启动模式的作用" class="headerlink" title="1.1.3、启动模式的作用"></a>1.1.3、启动模式的作用</h6><p><strong>模式说明</strong></p>
<ul>
<li>standard模式：这是系统默认的启动模式，这种模式就是创建一个Activity压入Task容器栈中，当当前Activity激活，并处在和用户交互时，此Activity弹出栈顶，当finish()时候，在任务栈中销毁该实例。</li>
<li>singleTop模式：这种模式首先会判断要激活的Activity是否在栈顶，如果在则不重新创建新的实例，复用当前的实例，如果不在栈顶，则在任务栈中创建实例。条件是是否在栈顶，而不是是否在栈中。</li>
<li>singleTask模式： 这种模式启 动的目标Activity实例如果已经存在task容器栈中，不管当前实例处于栈的任何位置，是栈顶也好，栈底也好，还是处于栈中间，只要目标 Activity实例处于task容器栈中，都可以重用该Activity实例对象，然后，把处于该Activity实例对象上面全部Activity实 例清除掉，并且，task容器栈中永远只有唯一实例对象，不会存在两个相同的实例对象。所以，如果你想你的应用不管怎么启动目标Activity，都只有 唯一一个实例对象，就使用这种启动模式。</li>
<li>singleInstance模式：当该模式Activity实例在任务栈中创建后，只要该实例还在任务栈中，即只要激活的是该类型的Activity，都会通过调用实例的newInstance()方法重用该Activity，此时使用的都是同一个Activity实例，它都会处于任务栈的栈顶。此模式一般用于加载较慢的，比较耗性能且不需要每次都重新创建的Activity。</li>
</ul>
<h6 id="1-1-4、ActivityStack-amp-TaskRecord-amp-ActivityRecord-关系"><a href="#1-1-4、ActivityStack-amp-TaskRecord-amp-ActivityRecord-关系" class="headerlink" title="1.1.4、ActivityStack &amp; TaskRecord &amp; ActivityRecord 关系"></a>1.1.4、ActivityStack &amp; TaskRecord &amp; ActivityRecord 关系</h6><p>Back栈管理了当你在Activity上点击Back键，当前Activity销毁后应该跳转到哪一个Activity的逻辑。</p>
<p>其实在ActivityManagerService与WindowManagerService内部管理中，在Task之外，还有一层容器，这个容器应用开发者和用户可能都不会感觉到或者用到，但它却非常重要，那就是ActivityStack。 下文中，我们将看到，Android系统中的多窗口管理，就是建立在Stack的数据结构上的。 一个ActivityStack中包含了多个TaskRecord，一个TaskRecord中包含了多个ActivityRecord，下图描述了它们的关系：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android10.Display.8/com.android.testred.1.ActivityStack_TaskRecord_ActivityRecord.png"></p>
<p>另外还有一点需要注意的是，ActivityManagerService和WindowManagerService中的Task和Stack结构是一一对应的，对应关系对于如下：</p>
<blockquote>
<p>ActivityStack &lt;–&gt; TaskStack<br>TaskRecord   &lt;–&gt; Task</p>
</blockquote>
<p>即，ActivityManagerService中的每一个ActivityStack或者TaskRecord在WindowManagerService中都有对应的TaskStack和Task，这两类对象都有唯一的id（id是int类型），它们通过id进行关联。</p>
<h5 id="1-2、ActivityManagerService相关类简介"><a href="#1-2、ActivityManagerService相关类简介" class="headerlink" title="1.2、ActivityManagerService相关类简介"></a>1.2、ActivityManagerService相关类简介</h5><ul>
<li><p>Instrumentation<br>用于实现应用程序测试代码的基类。当在打开仪器的情况下运行时，这个类将在任何应用程序代码之前为您实例化，允许您监视系统与应用程序的所有交互。可以通过AndroidManifest.xml的标签描述该类的实现。</p>
</li>
<li><p>ActivityManager<br>该类提供与Activity、Service和Process相关的信息以及交互方法， 可以被看作是ActivityManagerService的辅助类。</p>
</li>
<li><p>ActivityManagerService<br>Android中最核心的服务，主要负责系统中四大组件的启动、切换、调度及应用程序的管理和调度等工作。</p>
</li>
<li><p>ActivityThread<br>管理应用程序进程中主线程的执行，根据Activity管理者的请求调度和执行activities、broadcasts及其相关的操作。</p>
</li>
<li><p>ActivityStack<br>负责单个Activity栈的状态和管理。</p>
</li>
<li><p>ActivityStackSupervisor<br>负责所有Activity栈的管理。内部管理了mHomeStack、mFocusedStack和mLastFocusedStack三个Activity栈。其中，mHomeStack管理的是Launcher相关的Activity栈；mFocusedStack管理的是当前显示在前台Activity的Activity栈；mLastFocusedStack管理的是上一次显示在前台Activity的Activity栈。</p>
</li>
<li><p>ClientLifecycleManager<br>用来管理多个客户端生命周期执行请求的管理类。</p>
</li>
<li><p>Activity<br>用来管理客户端视图、点击、输入等功能的抽象，具有完整的生命周期</p>
</li>
<li><p>ViewRootImpl<br>APP进程与system_server进程进行视图相关通信的桥梁，同时也管理着APP进程视图方面操作的主要逻辑</p>
</li>
<li><p>ActivityRecord<br>Activity的信息记录在ActivityRecord对象, 并通过通过成员变量task指向TaskRecord</p>
</li>
</ul>
<blockquote>
<p>ProcessRecord app //跑在哪个进程<br>TaskRecord task //跑在哪个task<br>ActivityInfo info // Activity信息<br>ActivityState state //Activity状态<br>ApplicationInfo appInfo //跑在哪个app<br>ComponentName realActivity //组件名<br>String packageName //包名<br>String processName //进程名<br>int launchMode //启动模式<br>int userId // 该Activity运行在哪个用户id</p>
</blockquote>
<ul>
<li>ActivityState：</li>
</ul>
<blockquote>
<p>INITIALIZING<br>RESUMED：已恢复<br>PAUSING<br>PAUSED：已暂停<br>STOPPING<br>STOPPED：已停止<br>FINISHING<br>DESTROYING<br>DESTROYED：已销毁</p>
</blockquote>
<ul>
<li>TaskRecord<br>Task的信息记录在TaskRecord对象.</li>
</ul>
<blockquote>
<p>ActivityStack stack; //当前所属的stack<br>ArrayList<ActivityRecord> mActivities;; // 当前task的所有Activity列表<br>int taskId<br>String affinity； 是指root activity的affinity，即该Task中第一个Activity;<br>int mCallingUid;<br>String mCallingPackage； //调用者的包名</p>
</blockquote>
<ul>
<li>ActivityStack</li>
</ul>
<blockquote>
<p>ArrayList<TaskRecord> mTaskHistory //保存所有的Task列表<br>final int mStackId;<br>int mDisplayId;<br>ActivityRecord mPausingActivity //正在pause<br>ActivityRecord mLastPausedActivity<br>ActivityRecord mResumedActivity //已经resumed<br>ActivityRecord mLastStartedActivity</p>
</blockquote>
<p>所有前台stack的mResumedActivity的state == RESUMED, 则表示allResumedActivitiesComplete, 此时mLastFocusedStack = mFocusedStack;</p>
<ul>
<li>ActivityStackSupervisor</li>
</ul>
<blockquote>
<p>ActivityStack mHomeStack //桌面的stack<br>ActivityStack mFocusedStack //当前聚焦stack<br>ActivityStack mLastFocusedStack //正在切换<br>SparseArray mActivityDisplays //displayId为key<br>SparseArray mActivityContainers // mStackId为key</p>
</blockquote>
<h5 id="1-3、相关类重要成员变量"><a href="#1-3、相关类重要成员变量" class="headerlink" title="1.3、相关类重要成员变量"></a>1.3、相关类重要成员变量</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android10.Display.8/com.android.testred.1.ams_class_member.png"></p>
<h5 id="1-4、小结："><a href="#1-4、小结：" class="headerlink" title="1.4、小结："></a>1.4、小结：</h5><p>总体概览图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android10.Display.8/com.android.testred.1.startActivity_fork_new_process.png"></p>
<p>1、点击桌面App图标，Launcher进程采用Binder IPC向system_server进程发起startActivity请求；<br>2、system_server进程接收到请求后，向zygote进程发送创建进程的请求；<br>3、Zygote进程fork出新的子进程，即App进程；<br>4、App进程，通过Binder IPC向sytem_server进程发起attachApplication请求；<br>5、system_server进程在收到请求后，进行一系列准备工作后，再通过binder IPC向App进程发送scheduleLaunchActivity请求；<br>6、App进程的binder线程（ApplicationThread）在收到请求后，通过handler向主线程发送LAUNCH_ACTIVITY消息；<br>7、主线程在收到Message后，通过发射机制创建目标Activity，并回调Activity.onCreate()等方法。</p>
<h4 id="二、APP请求启动Activity（普通app启动流程）"><a href="#二、APP请求启动Activity（普通app启动流程）" class="headerlink" title="二、APP请求启动Activity（普通app启动流程）"></a>二、APP请求启动Activity（普通app启动流程）</h4><h5 id="2-1、Activity-startActivity-（普通app启动流程）"><a href="#2-1、Activity-startActivity-（普通app启动流程）" class="headerlink" title="2.1、Activity.startActivity()（普通app启动流程）"></a>2.1、Activity.startActivity()（普通app启动流程）</h5><p>从Launcher启动应用的时候，经过调用会执行Activity中的startActivity。(我们这里testred就是launcher)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\core\java\android\app\Activity.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, <span class="meta">@Nullable</span> Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2、Activity-startActivityForResult-（普通app启动流程）"><a href="#2-2、Activity-startActivityForResult-（普通app启动流程）" class="headerlink" title="2.2、Activity.startActivityForResult()（普通app启动流程）"></a>2.2、Activity.startActivityForResult()（普通app启动流程）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\core\java\android\app\Activity.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String who, Intent intent, <span class="keyword">int</span> requestCode, <span class="meta">@Nullable</span> Bundle options)</span> </span>&#123;</span><br><span class="line">        Uri referrer = onProvideReferrer();</span><br><span class="line">        <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">        &#125;</span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, who,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, who, requestCode,</span><br><span class="line">                ar.getResultCode(), ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-3、Instrumentation-execStartActivity-（普通app启动流程）"><a href="#2-3、Instrumentation-execStartActivity-（普通app启动流程）" class="headerlink" title="2.3、Instrumentation.execStartActivity()（普通app启动流程）"></a>2.3、Instrumentation.execStartActivity()（普通app启动流程）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\core\java\android\app\Instrumentation.java</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context who, IBinder contextThread, IBinder token, String resultWho,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, <span class="keyword">int</span> requestCode, Bundle options, UserHandle user)</span> </span>&#123;</span><br><span class="line">        IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            intent.migrateExtraStreamToClipData();</span><br><span class="line">            intent.prepareToLeaveProcess(who);</span><br><span class="line">            <span class="keyword">int</span> result = ActivityTaskManager.getService()</span><br><span class="line">                .startActivityAsUser(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, resultWho,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options, user.getIdentifier());</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ActivityTaskManager.getService()返回一个android.app.IActivityManager.Stub.Proxy对象(请参考Android9.0activity启动分析)</p>
<blockquote>
<p>IActivityManager.aidl -&gt; Binder机制 -&gt; ActivityManagerService</p>
</blockquote>
<h4 id="三、-ActivityManagerService接收启动Activity的请求"><a href="#三、-ActivityManagerService接收启动Activity的请求" class="headerlink" title="三、 ActivityManagerService接收启动Activity的请求"></a>三、 ActivityManagerService接收启动Activity的请求</h4><h5 id="3-1、ActivityManagerService-startActivity-（普通app启动流程）"><a href="#3-1、ActivityManagerService-startActivity-（普通app启动流程）" class="headerlink" title="3.1、ActivityManagerService.startActivity()（普通app启动流程）"></a>3.1、ActivityManagerService.startActivity()（普通app启动流程）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mActivityTaskManager.startActivity(caller, callingPackage, intent, resolvedType,</span><br><span class="line">                resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> mActivityTaskManager.startActivityAsUser(caller, callingPackage, intent,</span><br><span class="line">                    resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo,</span><br><span class="line">                    bOptions, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">WaitResult <span class="title">startActivityAndWait</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mActivityTaskManager.startActivityAndWait(caller, callingPackage, intent,</span><br><span class="line">                    resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo,</span><br><span class="line">                    bOptions, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-2、ActivityTaskManagerService-startActivityAndWait-（普通app启动流程）"><a href="#3-2、ActivityTaskManagerService-startActivityAndWait-（普通app启动流程）" class="headerlink" title="3.2、ActivityTaskManagerService.startActivityAndWait()（普通app启动流程）"></a>3.2、ActivityTaskManagerService.startActivityAndWait()（普通app启动流程）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityTaskManagerService.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> WaitResult <span class="title">startActivityAndWait</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WaitResult res = <span class="keyword">new</span> WaitResult();</span><br><span class="line">        <span class="keyword">synchronized</span> (mGlobalLock) &#123;</span><br><span class="line">            enforceNotIsolatedCaller(<span class="string">&quot;startActivityAndWait&quot;</span>);</span><br><span class="line">            userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">                    userId, <span class="string">&quot;startActivityAndWait&quot;</span>);</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">            getActivityStartController().obtainStarter(intent, <span class="string">&quot;startActivityAndWait&quot;</span>)</span><br><span class="line">                    .setCaller(caller)</span><br><span class="line">                    .setCallingPackage(callingPackage)</span><br><span class="line">                    .setResolvedType(resolvedType)</span><br><span class="line">                    .setResultTo(resultTo)</span><br><span class="line">                    .setResultWho(resultWho)</span><br><span class="line">                    .setRequestCode(requestCode)</span><br><span class="line">                    .setStartFlags(startFlags)</span><br><span class="line">                    .setActivityOptions(bOptions)</span><br><span class="line">                    .setMayWait(userId)</span><br><span class="line">                    .setProfilerInfo(profilerInfo)</span><br><span class="line">                    .setWaitResult(res)</span><br><span class="line">                    .execute();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStartController.java</span><br><span class="line">    <span class="function">ActivityStarter <span class="title">obtainStarter</span><span class="params">(Intent intent, String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mFactory.obtain().setIntent(intent).setReason(reason);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="3-3、ActivityStarter-execute-（普通app启动流程）"><a href="#3-3、ActivityStarter-execute-（普通app启动流程）" class="headerlink" title="3.3、ActivityStarter.execute()（普通app启动流程）"></a>3.3、ActivityStarter.execute()（普通app启动流程）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStarter.java</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// TODO(b/64750076): Look into passing request directly to these methods to allow</span></span><br><span class="line">        <span class="comment">// for transactional diffs and preprocessing.</span></span><br><span class="line">        <span class="keyword">if</span> (mRequest.mayWait) &#123;</span><br><span class="line">            <span class="keyword">return</span> startActivityMayWait(mRequest.caller, mRequest.callingUid,</span><br><span class="line">                    mRequest.callingPackage, mRequest.realCallingPid, mRequest.realCallingUid,</span><br><span class="line">                    mRequest.intent, mRequest.resolvedType,</span><br><span class="line">                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                    mRequest.resultWho, mRequest.requestCode, mRequest.startFlags,</span><br><span class="line">                    mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig,</span><br><span class="line">                    mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId,</span><br><span class="line">                    mRequest.inTask, mRequest.reason,</span><br><span class="line">                    mRequest.allowPendingRemoteAnimationRegistryLookup,</span><br><span class="line">                    mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> startActivity(mRequest.caller, mRequest.intent, mRequest.ephemeralIntent,</span><br><span class="line">                    mRequest.resolvedType, mRequest.activityInfo, mRequest.resolveInfo,</span><br><span class="line">                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                    mRequest.resultWho, mRequest.requestCode, mRequest.callingPid,</span><br><span class="line">                    mRequest.callingUid, mRequest.callingPackage, mRequest.realCallingPid,</span><br><span class="line">                    mRequest.realCallingUid, mRequest.startFlags, mRequest.activityOptions,</span><br><span class="line">                    mRequest.ignoreTargetSecurity, mRequest.componentSpecified,</span><br><span class="line">                    mRequest.outActivity, mRequest.inTask, mRequest.reason,</span><br><span class="line">                    mRequest.allowPendingRemoteAnimationRegistryLookup,</span><br><span class="line">                    mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        onExecutionComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>这个方法是基于初始的参数来启动activity,可以看到有两种启动activity的代码块,startActivityMayWait最终会调用startActivity所以:我们来看startActivityMayWait源码</p>
</blockquote>
<h5 id="3-4、App（”com-android-testgreen”）（Launcher-App启动流程）"><a href="#3-4、App（”com-android-testgreen”）（Launcher-App启动流程）" class="headerlink" title="3.4、App（”com.android.testgreen”）（Launcher App启动流程）"></a>3.4、App（”com.android.testgreen”）（Launcher App启动流程）</h5><p>Android 开机会启动一个com.android.settings/.FallbackHome，当FallbackHome Paused的时候，此时系统已经没有Activity，ActivityStack 就会调用方法resumeNextFocusableActivityWhenStackIsEmpty。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack_Pause: Activity paused: token=Token&#123;<span class="number">484d</span>3e0 ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125;&#125;, timeout=<span class="keyword">false</span></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack_States: Moving to PAUSED: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125; (pause complete)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack_Pause: Complete pause: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125;</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityRecord_States: State movement: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125; from:PAUSING to:PAUSED reason:completePausedLocked</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack_Pause: Executing finish of activity: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack_States: Moving to FINISHING: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125;</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityRecord_States: State movement: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125; from:PAUSED to:FINISHING reason:finishCurrentActivityLocked</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.679</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack: Enqueueing pending finish: ActivityRecord&#123;fd3e474 u0 com.android.settings/.FallbackHome t1 f&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.680</span>   <span class="number">433</span>   <span class="number">916</span> D ActivityStack_States: resumeNextFocusableActivityWhenStackIsEmpty: noMoreActivities, go home</span><br></pre></td></tr></table></figure>

<p>此时就是我们的主脚上场，App（”com.android.testgreen”）启动，我们看看调用Stack。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.startActivityLocked(ActivityStack.java:<span class="number">3254</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStarter.startActivityUnchecked(ActivityStarter.java:<span class="number">1718</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStarter.startActivity(ActivityStarter.java:<span class="number">1404</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStarter.startActivity(ActivityStarter.java:<span class="number">935</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStarter.startActivity(ActivityStarter.java:<span class="number">585</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStarter.execute(ActivityStarter.java:<span class="number">527</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStartController.startHomeActivity(ActivityStartController.java:<span class="number">186</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.RootActivityContainer.startHomeOnDisplay(RootActivityContainer.java:<span class="number">403</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.RootActivityContainer.startHomeOnDisplay(RootActivityContainer.java:<span class="number">352</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.RootActivityContainer.resumeHomeActivity(RootActivityContainer.java:<span class="number">533</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.resumeNextFocusableActivityWhenStackIsEmpty(ActivityStack.java:<span class="number">3131</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.resumeTopActivityInnerLocked(ActivityStack.java:<span class="number">2700</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.resumeTopActivityUncheckedLocked(ActivityStack.java:<span class="number">2603</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.RootActivityContainer.resumeFocusedStacksTopActivities(RootActivityContainer.java:<span class="number">1193</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.RootActivityContainer.resumeFocusedStacksTopActivities(RootActivityContainer.java:<span class="number">1146</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.finishCurrentActivityLocked(ActivityStack.java:<span class="number">4240</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.completePauseLocked(ActivityStack.java:<span class="number">1806</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityStack.activityPausedLocked(ActivityStack.java:<span class="number">1772</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at com.android.server.wm.ActivityTaskManagerService.activityPaused(ActivityTaskManagerService.java:<span class="number">1725</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at android.app.IActivityTaskManager$Stub.onTransact(IActivityTaskManager.java:<span class="number">1981</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at android.os.Binder.execTransactInternal(Binder.java:<span class="number">1021</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.701</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStack:     at android.os.Binder.execTransact(Binder.java:<span class="number">994</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到也会执行ActivityStarter.execute()来继续执行。所以我们继续分析代码。</p>
<h5 id="3-5、ActivityStarter-startActivity"><a href="#3-5、ActivityStarter-startActivity" class="headerlink" title="3.5、ActivityStarter.startActivity()"></a>3.5、ActivityStarter.startActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStarter.java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity, TaskRecord inTask, String reason,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingIntentRecord originatingPendingIntent, <span class="keyword">boolean</span> allowBackgroundActivityStart)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mLastStartReason = reason;</span><br><span class="line">        mLastStartActivityTimeMs = System.currentTimeMillis();</span><br><span class="line">        mLastStartActivityRecord[<span class="number">0</span>] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line">                callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line">                inTask, allowPendingRemoteAnimationRegistryLookup, originatingPendingIntent,</span><br><span class="line">                allowBackgroundActivityStart);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// mLastStartActivityRecord[0] is set in the call to startActivity above.</span></span><br><span class="line">            outActivity[<span class="number">0</span>] = mLastStartActivityRecord[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getExternalResult(mLastStartActivityResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            SafeActivityOptions options,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord inTask, <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingIntentRecord originatingPendingIntent, <span class="keyword">boolean</span> allowBackgroundActivityStart)</span> </span>&#123;</span><br><span class="line">        mSupervisor.getActivityMetricsLogger().notifyActivityLaunching(intent);</span><br><span class="line">        <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;START u&quot;</span> + userId + <span class="string">&quot; &#123;&quot;</span> + intent.toShortString(<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>)</span><br><span class="line">                    + <span class="string">&quot;&#125; from uid &quot;</span> + callingUid);</span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：<span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.681</span>   <span class="number">433</span>   <span class="number">916</span> I ActivityStarter: START u0 &#123;act=android.intent.action.MAIN cat=[android.intent.category.HOME] flg=<span class="number">0x10000100</span> cmp=com.android.testred/.TestActivity&#125; from uid <span class="number">0</span></span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建ActivityRecord</span></span><br><span class="line">        ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingPid, callingUid,</span><br><span class="line">                callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(),</span><br><span class="line">                resultRecord, resultWho, requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>,</span><br><span class="line">                mSupervisor, checkedOptions, sourceRecord);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> res = startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/* doResume */</span>, checkedOptions, inTask, outActivity, restrictedBgActivity);</span><br><span class="line">        mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(res, outActivity[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">                IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">                ActivityRecord[] outActivity, <span class="keyword">boolean</span> restrictedBgActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = START_CANCELED;</span><br><span class="line">        <span class="keyword">final</span> ActivityStack startedActivityStack;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">            result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                    startFlags, doResume, options, inTask, outActivity, restrictedBgActivity);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        postStartActivityProcessing(r, result, startedActivityStack);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="3-6、ActivityStarter-startActivityUnchecked"><a href="#3-6、ActivityStarter-startActivityUnchecked" class="headerlink" title="3.6、ActivityStarter.startActivityUnchecked()"></a>3.6、ActivityStarter.startActivityUnchecked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Note: This method should only be called from &#123;@link startActivity&#125;.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, <span class="keyword">boolean</span> restrictedBgActivity)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> TaskRecord taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != <span class="keyword">null</span>)</span><br><span class="line">            ? mSourceRecord.getTaskRecord() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Should this be considered a new task?</span></span><br><span class="line">    <span class="keyword">int</span> result = START_SUCCESS;</span><br><span class="line">    <span class="keyword">if</span> (mStartActivity.resultTo == <span class="keyword">null</span> &amp;&amp; mInTask == <span class="keyword">null</span> &amp;&amp; !mAddingToTask</span><br><span class="line">            &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">        newTask = <span class="keyword">true</span>;</span><br><span class="line">        result = setTaskFromReuseOrCreateNewTask(taskToAffiliate);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = setTaskFromSourceRecord();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = setTaskFromInTask();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This not being started from an existing activity, and not part of a new task...</span></span><br><span class="line">        <span class="comment">// just put it in the top task, though these days this case should never happen.</span></span><br><span class="line">        result = setTaskToCurrentTopOrCreateNewTask();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result != START_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mService.mUgmInternal.grantUriPermissionFromIntent(mCallingUid, mStartActivity.packageName,</span><br><span class="line">            mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity.mUserId);</span><br><span class="line">    mService.getPackageManagerInternalLocked().grantEphemeralAccess(</span><br><span class="line">            mStartActivity.mUserId, mIntent, UserHandle.getAppId(mStartActivity.appInfo.uid),</span><br><span class="line">            UserHandle.getAppId(mCallingUid));</span><br><span class="line">    <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_CREATE_TASK, mStartActivity.mUserId,</span><br><span class="line">                mStartActivity.getTaskRecord().taskId);</span><br><span class="line">    &#125;</span><br><span class="line">    ActivityStack.logStartActivity(</span><br><span class="line">            EventLogTags.AM_CREATE_ACTIVITY, mStartActivity, mStartActivity.getTaskRecord());</span><br><span class="line">    mTargetStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    mRootActivityContainer.sendPowerHintForLaunchStartIfNeeded(</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* forceSend */</span>, mStartActivity);</span><br><span class="line"></span><br><span class="line">    mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,</span><br><span class="line">            mOptions);</span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord topTaskActivity =</span><br><span class="line">                mStartActivity.getTaskRecord().topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            <span class="comment">// If the activity is not focusable, we can&#x27;t resume it, but still would like to</span></span><br><span class="line">            <span class="comment">// make sure it becomes visible as it starts (this will also trigger entry</span></span><br><span class="line">            <span class="comment">// animation). An example of this are PIP activities.</span></span><br><span class="line">            <span class="comment">// Also, we don&#x27;t want to resume activities in a task that currently has an overlay</span></span><br><span class="line">            <span class="comment">// as the starting activity just needs to be in the visible paused state until the</span></span><br><span class="line">            <span class="comment">// over is removed.</span></span><br><span class="line">            mTargetStack.ensureActivitiesVisibleLocked(mStartActivity, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">            <span class="comment">// Go ahead and tell window manager to execute app transition for this activity</span></span><br><span class="line">            <span class="comment">// since the app transition will not be triggered through the resume channel.</span></span><br><span class="line">            mTargetStack.getDisplay().mDisplayContent.executeAppTransition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If the target stack was not previously focusable (previous top running activity</span></span><br><span class="line">            <span class="comment">// on that stack was not visible) then any prior calls to move the stack to the</span></span><br><span class="line">            <span class="comment">// will not update the focused stack.  If starting the new activity now allows the</span></span><br><span class="line">            <span class="comment">// task stack to be focusable, then ensure that we now update the focused stack</span></span><br><span class="line">            <span class="comment">// accordingly.</span></span><br><span class="line">            <span class="keyword">if</span> (mTargetStack.isFocusable()</span><br><span class="line">                    &amp;&amp; !mRootActivityContainer.isTopDisplayFocusedStack(mTargetStack)) &#123;</span><br><span class="line">                mTargetStack.moveToFront(<span class="string">&quot;startActivityUnchecked&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRootActivityContainer.resumeFocusedStacksTopActivities(</span><br><span class="line">                    mTargetStack, mStartActivity, mOptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mStartActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mSupervisor.mRecentTasks.add(mStartActivity.getTaskRecord());</span><br><span class="line">    &#125;</span><br><span class="line">    mRootActivityContainer.updateUserStack(mStartActivity.mUserId, mTargetStack);</span><br><span class="line"></span><br><span class="line">    mSupervisor.handleNonResizableTaskIfNeeded(mStartActivity.getTaskRecord(),</span><br><span class="line">            preferredWindowingMode, mPreferredDisplayId, mTargetStack);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-6-1、ActivityStarter-setTaskFromReuseOrCreateNewTask-创建新的Task-AMS端"><a href="#3-6-1、ActivityStarter-setTaskFromReuseOrCreateNewTask-创建新的Task-AMS端" class="headerlink" title="3.6.1、ActivityStarter.setTaskFromReuseOrCreateNewTask()-创建新的Task[AMS端]"></a>3.6.1、ActivityStarter.setTaskFromReuseOrCreateNewTask()-创建新的Task[AMS端]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStarter.java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setTaskFromReuseOrCreateNewTask</span><span class="params">(TaskRecord taskToAffiliate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mRestrictedBgActivity &amp;&amp; (mReuseTask == <span class="keyword">null</span> || !mReuseTask.containsAppUid(mCallingUid))</span><br><span class="line">                &amp;&amp; handleBackgroundActivityAbort(mStartActivity)) &#123;</span><br><span class="line">            <span class="keyword">return</span> START_ABORTED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mTargetStack = computeStackFocus(mStartActivity, <span class="keyword">true</span>, mLaunchFlags, mOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do no move the target stack to front yet, as we might bail if</span></span><br><span class="line">        <span class="comment">// isLockTaskModeViolation fails below.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> toTop = !mLaunchTaskBehind &amp;&amp; !mAvoidMoveToFront;</span><br><span class="line">            <span class="keyword">final</span> TaskRecord task = mTargetStack.createTaskRecord(</span><br><span class="line">                    mSupervisor.getNextTaskIdForUserLocked(mStartActivity.mUserId),</span><br><span class="line">                    mNewTaskInfo != <span class="keyword">null</span> ? mNewTaskInfo : mStartActivity.info,</span><br><span class="line">                    mNewTaskIntent != <span class="keyword">null</span> ? mNewTaskIntent : mIntent, mVoiceSession,</span><br><span class="line">                    mVoiceInteractor, toTop, mStartActivity, mSourceRecord, mOptions);</span><br><span class="line">            addOrReparentStartingActivity(task, <span class="string">&quot;setTaskFromReuseOrCreateNewTask - mReuseTask&quot;</span>);</span><br><span class="line">            updateBounds(mStartActivity.getTaskRecord(), mLaunchParams.mBounds);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">&quot;Starting new activity &quot;</span> + mStartActivity</span><br><span class="line">                    + <span class="string">&quot; in new task &quot;</span> + mStartActivity.getTaskRecord());</span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：11-12 03:15:29.698   433   916 V ActivityStackSupervisor_Tasks: Starting new activity ActivityRecord&#123;563ed0d u0 com.android.testred/.TestActivity t2&#125; in new task TaskRecord&#123;c645b40 #2 A=com.android.testred U=0 StackId=0 sz=1&#125;</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addOrReparentStartingActivity(mReuseTask, <span class="string">&quot;setTaskFromReuseOrCreateNewTask&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (taskToAffiliate != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mStartActivity.setTaskToAffiliateWith(taskToAffiliate);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.getLockTaskController().isLockTaskModeViolation(</span><br><span class="line">                mStartActivity.getTaskRecord())) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;Attempted Lock Task Mode violation mStartActivity=&quot;</span> + mStartActivity);</span><br><span class="line">            <span class="keyword">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">            mTargetStack.moveToFront(<span class="string">&quot;reuseOrNewTask&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-6-1-1、TaskRecord创建createTaskRecord"><a href="#3-6-1-1、TaskRecord创建createTaskRecord" class="headerlink" title="3.6.1.1、TaskRecord创建createTaskRecord()"></a>3.6.1.1、TaskRecord创建createTaskRecord()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStack.java</span><br><span class="line"><span class="function">TaskRecord <span class="title">createTaskRecord</span><span class="params">(<span class="keyword">int</span> taskId, ActivityInfo info, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> toTop, ActivityRecord activity, ActivityRecord source,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> TaskRecord task = TaskRecord.create(</span><br><span class="line">            mService, taskId, info, intent, voiceSession, voiceInteractor);</span><br><span class="line">    <span class="comment">// add the task to stack first, mTaskPositioner might need the stack association</span></span><br><span class="line">    addTask(task, toTop, <span class="string">&quot;createTaskRecord&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayId != INVALID_DISPLAY ? mDisplayId : DEFAULT_DISPLAY;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isLockscreenShown = mService.mStackSupervisor.getKeyguardController()</span><br><span class="line">            .isKeyguardOrAodShowing(displayId);</span><br><span class="line">    <span class="keyword">if</span> (!mStackSupervisor.getLaunchParamsController()</span><br><span class="line">            .layoutTask(task, info.windowLayout, activity, source, options)</span><br><span class="line">            &amp;&amp; !matchParentBounds() &amp;&amp; task.isResizeable() &amp;&amp; !isLockscreenShown) &#123;</span><br><span class="line">        task.updateOverrideConfiguration(getRequestedOverrideBounds());</span><br><span class="line">    &#125;</span><br><span class="line">    task.createTask(toTop, (info.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-6-1-1-1、TaskRecord-create"><a href="#3-6-1-1-1、TaskRecord-create" class="headerlink" title="3.6.1.1.1、TaskRecord.create()"></a>3.6.1.1.1、TaskRecord.create()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\TaskRecord.java</span><br><span class="line">    <span class="function"><span class="keyword">static</span> TaskRecord <span class="title">create</span><span class="params">(ActivityTaskManagerService service, <span class="keyword">int</span> taskId, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, IVoiceInteractionSession voiceSession,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getTaskRecordFactory().create(</span><br><span class="line">                service, taskId, info, intent, voiceSession, voiceInteractor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskRecordFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">TaskRecord <span class="title">create</span><span class="params">(ActivityManagerService service, <span class="keyword">int</span> taskId, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                Intent intent, IVoiceInteractionSession voiceSession,</span></span></span><br><span class="line"><span class="function"><span class="params">                IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TaskRecord(</span><br><span class="line">                    service, taskId, info, intent, voiceSession, voiceInteractor);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    TaskRecord(ActivityManagerService service, <span class="keyword">int</span> _taskId, ActivityInfo info, Intent _intent,</span><br><span class="line">            IVoiceInteractionSession _voiceSession, IVoiceInteractor _voiceInteractor) &#123;</span><br><span class="line">        mService = service;</span><br><span class="line">        userId = UserHandle.getUserId(info.applicationInfo.uid);</span><br><span class="line">        taskId = _taskId;</span><br><span class="line">        lastActiveTime = SystemClock.elapsedRealtime();</span><br><span class="line">        mAffiliatedTaskId = _taskId;</span><br><span class="line">        voiceSession = _voiceSession;</span><br><span class="line">        voiceInteractor = _voiceInteractor;</span><br><span class="line">        isAvailable = <span class="keyword">true</span>;</span><br><span class="line">        mActivities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        mCallingUid = info.applicationInfo.uid;</span><br><span class="line">        mCallingPackage = info.packageName;</span><br><span class="line">        setIntent(_intent, info);</span><br><span class="line">        setMinDimensions(info);</span><br><span class="line">        touchActiveTime();</span><br><span class="line">        mService.mTaskChangeNotificationController.notifyTaskCreated(_taskId, realActivity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-6-1-1-2、将TaskRecord加入到ActivityStack中"><a href="#3-6-1-1-2、将TaskRecord加入到ActivityStack中" class="headerlink" title="3.6.1.1.2、将TaskRecord加入到ActivityStack中"></a>3.6.1.1.2、将TaskRecord加入到ActivityStack中</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStack.java</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(<span class="keyword">final</span> TaskRecord task, <span class="keyword">final</span> <span class="keyword">boolean</span> toTop, String reason)</span> </span>&#123;</span><br><span class="line">        addTask(task, toTop ? MAX_VALUE : <span class="number">0</span>, <span class="keyword">true</span> <span class="comment">/* schedulePictureInPictureModeChange */</span>, reason);</span><br><span class="line">        <span class="keyword">if</span> (toTop) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> figure-out a way to remove this call.</span></span><br><span class="line">            positionChildWindowContainerAtTop(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> This shouldn&#x27;t allow automatic reparenting. Remove the call to preAddTask and deal</span></span><br><span class="line">    <span class="comment">// with the fall-out...</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(<span class="keyword">final</span> TaskRecord task, <span class="keyword">int</span> position, <span class="keyword">boolean</span> schedulePictureInPictureModeChange,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Is this remove really needed? Need to look into the call path for the other addTask</span></span><br><span class="line">        mTaskHistory.remove(task);</span><br><span class="line">        <span class="keyword">if</span> (isSingleTaskInstance() &amp;&amp; !mTaskHistory.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Can only have one child on stack=&quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        position = getAdjustedPositionForTask(task, position, <span class="keyword">null</span> <span class="comment">/* starting */</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> toTop = position &gt;= mTaskHistory.size();</span><br><span class="line">        <span class="keyword">final</span> ActivityStack prevStack = preAddTask(task, reason, toTop);</span><br><span class="line"></span><br><span class="line">        mTaskHistory.add(position, task);</span><br><span class="line">        task.setStack(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        updateTaskMovement(task, toTop);</span><br><span class="line"></span><br><span class="line">        postAddTask(task, prevStack, schedulePictureInPictureModeChange);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-6-1-1-3、TaskRecord-createTask-WMS端的Task"><a href="#3-6-1-1-3、TaskRecord-createTask-WMS端的Task" class="headerlink" title="3.6.1.1.3、TaskRecord..createTask()[WMS端的Task]"></a>3.6.1.1.3、TaskRecord..createTask()[WMS端的Task]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\TaskRecord.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createTask</span><span class="params">(<span class="keyword">boolean</span> onTop, <span class="keyword">boolean</span> showForAllUsers)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> Rect bounds = updateOverrideConfigurationFromLaunchBounds();</span><br><span class="line">        <span class="keyword">final</span> TaskStack stack = getStack().getTaskStack();</span><br><span class="line"></span><br><span class="line">        EventLog.writeEvent(WM_TASK_CREATED, taskId, stack.mStackId);</span><br><span class="line">        mTask = <span class="keyword">new</span> Task(taskId, stack, userId, mService.mWindowManager, mResizeMode,</span><br><span class="line">                mSupportsPictureInPicture, lastTaskDescription, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> position = onTop ? POSITION_TOP : POSITION_BOTTOM;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mDisplayedBounds.isEmpty()) &#123;</span><br><span class="line">            mTask.setOverrideDisplayedBounds(mDisplayedBounds);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We only want to move the parents to the parents if we are creating this task at the</span></span><br><span class="line">        <span class="comment">// top of its stack.</span></span><br><span class="line">        stack.addTask(mTask, position, showForAllUsers, onTop <span class="comment">/* moveParents */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\TaskRecord.java</span><br><span class="line">    Task(<span class="keyword">int</span> taskId, TaskStack stack, <span class="keyword">int</span> userId, WindowManagerService service, <span class="keyword">int</span> resizeMode,</span><br><span class="line">            <span class="keyword">boolean</span> supportsPictureInPicture, TaskDescription taskDescription,</span><br><span class="line">            TaskRecord taskRecord) &#123;</span><br><span class="line">        <span class="keyword">super</span>(service);</span><br><span class="line">        mTaskId = taskId;</span><br><span class="line">        mStack = stack;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mResizeMode = resizeMode;</span><br><span class="line">        mSupportsPictureInPicture = supportsPictureInPicture;</span><br><span class="line">        mTaskRecord = taskRecord;</span><br><span class="line">        <span class="keyword">if</span> (mTaskRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTaskRecord.registerConfigurationChangeListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setBounds(getRequestedOverrideBounds());</span><br><span class="line">        mTaskDescription = taskDescription;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tasks have no set orientation value (including SCREEN_ORIENTATION_UNSPECIFIED).</span></span><br><span class="line">        setOrientation(SCREEN_ORIENTATION_UNSET);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-6-1-1-4、将Task-WMS-加入到TaskStack"><a href="#3-6-1-1-4、将Task-WMS-加入到TaskStack" class="headerlink" title="3.6.1.1.4、将Task[WMS]加入到TaskStack"></a>3.6.1.1.4、将Task[WMS]加入到TaskStack</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\TaskStack.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(Task task, <span class="keyword">int</span> position, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">boolean</span> moveParents)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> TaskStack currentStack = task.mStack;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add child task.</span></span><br><span class="line">        task.mStack = <span class="keyword">this</span>;</span><br><span class="line">        addChild(task, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Move child to a proper position, as some restriction for position might apply.</span></span><br><span class="line">        positionChildAt(position, task, moveParents <span class="comment">/* includingParents */</span>, showForAllUsers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="3-6-2、ActivityStack-startActivityLocked"><a href="#3-6-2、ActivityStack-startActivityLocked" class="headerlink" title="3.6.2、ActivityStack.startActivityLocked()"></a>3.6.2、ActivityStack.startActivityLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStack.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, ActivityRecord focusedTopActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">        TaskRecord rTask = r.getTaskRecord();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> allowMoveToFront = options == <span class="keyword">null</span> || !options.getAvoidMoveToFront();</span><br><span class="line">        <span class="comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span></span><br><span class="line">        <span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; allowMoveToFront</span><br><span class="line">                &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</span><br><span class="line">            insertTaskAtTop(rTask, r);</span><br><span class="line">        &#125;</span><br><span class="line">        TaskRecord task = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!newTask) &#123;</span><br><span class="line">            <span class="comment">// If starting in an existing task, find where that is...</span></span><br><span class="line">            <span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">                task = mTaskHistory.get(taskNdx);</span><br><span class="line">                <span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// All activities in task are finishing.</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (task == rTask) &#123;</span><br><span class="line">                    <span class="comment">// Here it is!  Now, if this is not yet visible to the</span></span><br><span class="line">                    <span class="comment">// user, then just add it without starting; it will</span></span><br><span class="line">                    <span class="comment">// get started when the user navigates back to it.</span></span><br><span class="line">                    <span class="keyword">if</span> (!startIt) &#123;</span><br><span class="line">                    ------------------------------</span><br><span class="line">                    11-12 03:15:29.701   433   916 I ActivityStack: Adding activity ActivityRecord&#123;563ed0d u0 com.android.testred/.TestActivity t2&#125; to stack to task TaskRecord&#123;c645b40 #2 A=com.android.testred U=0 StackId=0 sz=1&#125;</span><br><span class="line">                    ------------------------------</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">&quot;Adding activity &quot;</span> + r + <span class="string">&quot; to task &quot;</span></span><br><span class="line">                                + task, <span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());</span><br><span class="line">                        r.createAppWindowToken();</span><br><span class="line">                        ActivityOptions.abort(options);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    startIt = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Place a new activity at top of stack, so it is next to interact with the user.</span></span><br><span class="line"></span><br><span class="line">        task = activityTask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Slot the activity into the history stack and proceed</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">&quot;Adding activity &quot;</span> + r + <span class="string">&quot; to stack to task &quot;</span> + task,</span><br><span class="line">                <span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Need to investigate if it is okay for the controller to already be created by the</span></span><br><span class="line">        <span class="comment">// time we get to this point. I think it is, but need to double check.</span></span><br><span class="line">        <span class="comment">// Use test in b/34179495 to trace the call path.</span></span><br><span class="line">        <span class="keyword">if</span> (r.mAppWindowToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.createAppWindowToken();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        task.setFrontOfTask();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The transition animation and starting window are not needed if &#123;@code allowMoveToFront&#125;</span></span><br><span class="line">        <span class="comment">// is false, because the activity won&#x27;t be visible.</span></span><br><span class="line">        <span class="keyword">if</span> ((!isHomeOrRecentsStack() || numActivities() &gt; <span class="number">0</span>) &amp;&amp; allowMoveToFront) &#123;</span><br><span class="line">            <span class="keyword">final</span> DisplayContent dc = getDisplay().mDisplayContent;</span><br><span class="line">            ----------------------------------------------------</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.703</span>   <span class="number">433</span>   <span class="number">916</span> V ActivityStack_Transition: Prepare open transition: starting ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125;</span><br><span class="line">            ----------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</span><br><span class="line">                    <span class="string">&quot;Prepare open transition: starting &quot;</span> + r);</span><br><span class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</span><br><span class="line">                dc.prepareAppTransition(TRANSIT_NONE, keepCurTransition);</span><br><span class="line">                mStackSupervisor.mNoAnimActivities.add(r);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> transit = TRANSIT_ACTIVITY_OPEN;</span><br><span class="line">                <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">                        transit = TRANSIT_TASK_OPEN_BEHIND;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDisplay().isSingleTaskInstance()) &#123;</span><br><span class="line">                        transit = TRANSIT_SHOW_SINGLE_TASK_DISPLAY;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// If a new task is being launched, then mark the existing top activity as</span></span><br><span class="line">                        <span class="comment">// supporting picture-in-picture while pausing only if the starting activity</span></span><br><span class="line">                        <span class="comment">// would not be considered an overlay on top of the current activity</span></span><br><span class="line">                        <span class="comment">// (eg. not fullscreen, or the assistant)</span></span><br><span class="line">                        <span class="keyword">if</span> (canEnterPipOnTaskSwitch(focusedTopActivity,</span><br><span class="line">                                <span class="keyword">null</span> <span class="comment">/* toFrontTask */</span>, r, options)) &#123;</span><br><span class="line">                            focusedTopActivity.supportsEnterPipOnTaskSwitch = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        transit = TRANSIT_TASK_OPEN;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                dc.prepareAppTransition(transit, keepCurTransition);</span><br><span class="line">                mStackSupervisor.mNoAnimActivities.remove(r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">                <span class="comment">// Even though this activity is starting fresh, we still need</span></span><br><span class="line">                <span class="comment">// to reset it to make sure we apply affinities to move any</span></span><br><span class="line">                <span class="comment">// existing activities from other tasks in to it.</span></span><br><span class="line">                <span class="comment">// If the caller has requested that the target task be</span></span><br><span class="line">                <span class="comment">// reset, then do so.</span></span><br><span class="line">                <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    resetTaskIfNeededLocked(r, r);</span><br><span class="line">                    doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; options.getAnimationType()</span><br><span class="line">                    == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class="line">                doShow = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t do a starting window for mLaunchTaskBehind. More importantly make sure we</span></span><br><span class="line">                <span class="comment">// tell WindowManager that r is visible even though it is at the back of the stack.</span></span><br><span class="line">                r.setVisibility(<span class="keyword">true</span>);</span><br><span class="line">                ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class="line">                ......</span><br><span class="line">                r.showStartingWindow(prev, newTask, isTaskSwitch(r, focusedTopActivity));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If this is the first activity, don&#x27;t do any fancy animations,</span></span><br><span class="line">            <span class="comment">// because there is nothing for it to animate on top of.</span></span><br><span class="line">            ActivityOptions.abort(options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="3-6-3、ActivityStack-ensureActivitiesVisibleLocked"><a href="#3-6-3、ActivityStack-ensureActivitiesVisibleLocked" class="headerlink" title="3.6.3、ActivityStack.ensureActivitiesVisibleLocked()"></a>3.6.3、ActivityStack.ensureActivitiesVisibleLocked()</h5><p>由于现在App进程还未创建，会走此分支</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">ensureActivitiesVisibleLocked</span><span class="params">(ActivityRecord starting, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">if</span> (!r.attachedToProcess()</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (makeVisibleAndRestartIfNeeded(starting, configChanges, isTop,</span><br><span class="line">                                resumeNextActivity, r)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (activityNdx &gt;= activities.size()) &#123;</span><br><span class="line">                                <span class="comment">// Record may be removed if its process needs to restart.</span></span><br><span class="line">                                activityNdx = activities.size() - <span class="number">1</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                resumeNextActivity = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="3-6-3-1、ActivityStack-makeVisibleAndRestartIfNeeded"><a href="#3-6-3-1、ActivityStack-makeVisibleAndRestartIfNeeded" class="headerlink" title="3.6.3.1、ActivityStack.makeVisibleAndRestartIfNeeded()"></a>3.6.3.1、ActivityStack.makeVisibleAndRestartIfNeeded()</h5><p>此时ActivityRecord 状态为state=INITIALIZING</p>
<blockquote>
<p>11-12 03:15:29.708   433   916 V ActivityStack_Visibility: Make visible? ActivityRecord{563ed0d u0 com.android.testred/.TestActivity t2} finishing=false state=INITIALIZING</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">makeVisibleAndRestartIfNeeded</span><span class="params">(ActivityRecord starting, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isTop, <span class="keyword">boolean</span> andResume, ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We need to make sure the app is running if it&#x27;s the top, or it is just made visible from</span></span><br><span class="line">    <span class="comment">// invisible. If the app is already visible, it must have died while it was visible. In this</span></span><br><span class="line">    <span class="comment">// case, we&#x27;ll show the dead window but will not restart the app. Otherwise we could end up</span></span><br><span class="line">    <span class="comment">// thrashing.</span></span><br><span class="line">    <span class="keyword">if</span> (isTop || !r.visible) &#123;</span><br><span class="line">        <span class="comment">// This activity needs to be visible, but isn&#x27;t even running...</span></span><br><span class="line">        <span class="comment">// get it started and resume if no other stack in this stack is resumed.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY, <span class="string">&quot;Start and freeze screen for &quot;</span> + r);</span><br><span class="line">        <span class="keyword">if</span> (r != starting) &#123;</span><br><span class="line">            r.startFreezingScreenLocked(r.app, configChanges);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!r.visible || r.mLaunchTaskBehind) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY, <span class="string">&quot;Starting and making visible: &quot;</span> + r);</span><br><span class="line">            r.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != starting) &#123;</span><br><span class="line">            <span class="comment">// We should not resume activities that being launched behind because these</span></span><br><span class="line">            <span class="comment">// activities are actually behind other fullscreen activities, but still required</span></span><br><span class="line">            <span class="comment">// to be visible (such as performing Recents animation).</span></span><br><span class="line">            mStackSupervisor.startSpecificActivityLocked(r, andResume &amp;&amp; !r.mLaunchTaskBehind,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* checkConfig */</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-6-4、StackSupervisor-startSpecificActivityLocked"><a href="#3-6-4、StackSupervisor-startSpecificActivityLocked" class="headerlink" title="3.6.4、StackSupervisor.startSpecificActivityLocked()"></a>3.6.4、StackSupervisor.startSpecificActivityLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Is this activity&#x27;s application already running?</span></span><br><span class="line">        <span class="keyword">final</span> WindowProcessController wpc =</span><br><span class="line">                mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> knownToBeDead = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (wpc != <span class="keyword">null</span> &amp;&amp; wpc.hasThread()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Exception when starting activity &quot;</span></span><br><span class="line">                        + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">final</span> Message msg = PooledLambda.obtainMessage(</span><br><span class="line">                    ActivityManagerInternal::startProcess, mService.mAmInternal, r.processName,</span><br><span class="line">                    r.info.applicationInfo, knownToBeDead, <span class="string">&quot;activity&quot;</span>, r.intent.getComponent());</span><br><span class="line">            mService.mH.sendMessage(msg);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at com.android.server.am.ActivityManagerService$LocalService.startProcess(ActivityManagerService.java:<span class="number">18542</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at com.android.server.wm.-$$Lambda$<span class="number">3</span>W4Y_XVQUddVKzLjibuHW7h0R1g.accept(Unknown Source:<span class="number">22</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at com.android.internal.util.function.pooled.PooledLambdaImpl.doInvoke(PooledLambdaImpl.java:<span class="number">335</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at com.android.internal.util.function.pooled.PooledLambdaImpl.invoke(PooledLambdaImpl.java:<span class="number">195</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at com.android.internal.util.function.pooled.OmniFunction.run(OmniFunction.java:<span class="number">86</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at android.os.Handler.handleCallback(Handler.java:<span class="number">883</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">100</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at android.os.HandlerThread.run(HandlerThread.java:<span class="number">67</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19.103</span>   <span class="number">427</span>   <span class="number">449</span> I ActivityManagerService:     at com.android.server.ServiceThread.run(ServiceThread.java:<span class="number">44</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-6-5、StackSupervisor-startSpecificActivityLocked"><a href="#3-6-5、StackSupervisor-startSpecificActivityLocked" class="headerlink" title="3.6.5、StackSupervisor.startSpecificActivityLocked()"></a>3.6.5、StackSupervisor.startSpecificActivityLocked()</h5><p>ActivityManagerInternal::startProcess -&gt; ActivityManagerService::startProcess</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProcess</span><span class="params">(String processName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> knownToBeDead, String hostingType, ComponentName hostingName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) &#123;</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;startProcess:&quot;</span></span><br><span class="line">                            + processName);</span><br><span class="line">                &#125;</span><br><span class="line"> -------------------------------------------------</span><br><span class="line"> <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.918</span>   <span class="number">433</span>   <span class="number">455</span> V xzj     : startProcess: name=com.android.testred app=ProcessRecord&#123;f5e79a0 <span class="number">1069</span>:com.android.testred/u0a56&#125; knownToBeDead=<span class="keyword">false</span> hostingRecord=activity intentFlags=<span class="number">0</span> thread=android.app.IApplicationThread$Stub$Proxy<span class="meta">@cbb8cb</span> pid=<span class="number">1069</span></span><br><span class="line"> -------------------------------------------------</span><br><span class="line">                <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">                    startProcessLocked(processName, info, knownToBeDead, <span class="number">0</span> <span class="comment">/* intentFlags */</span>,</span><br><span class="line">                            <span class="keyword">new</span> HostingRecord(hostingType, hostingName),</span><br><span class="line">                            <span class="keyword">false</span> <span class="comment">/* allowWhileBooting */</span>, <span class="keyword">false</span> <span class="comment">/* isolated */</span>,</span><br><span class="line">                            <span class="keyword">true</span> <span class="comment">/* keepIfLarge */</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进程的创建跟之前分析的一致，就不再分析了。创建完成后回调用ActivityThread的main方法。</p>
<h4 id="3-7、Activity所在应用主线程初始化-ActivityThread-main"><a href="#3-7、Activity所在应用主线程初始化-ActivityThread-main" class="headerlink" title="3.7、Activity所在应用主线程初始化 ActivityThread.main()"></a>3.7、Activity所在应用主线程初始化 ActivityThread.main()</h4><p>在ActivityThread.main方法中对ActivityThread进行了初始化，创建了主线程的Looper对象并调用Looper.loop()方法启动Looper，把自定义Handler类H的对象作为主线程的handler。接下来跳转到ActivityThread.attach方法，看都做了什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ActivityThreadMain&quot;</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Install selective syscall interception</span></span><br><span class="line">     AndroidOs.install();</span><br><span class="line"></span><br><span class="line">     Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">     <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">     TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">     Process.setArgV0(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">     Looper.prepareMainLooper();</span><br><span class="line">     ......</span><br><span class="line">     ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">     thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">         sMainThreadHandler = thread.getHandler();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">     Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">     Looper.loop();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


<p>Activity所在的进程创建完了，主线程也初始化了，接下来就该真正的启动Activity了。在ActivityThread.attach方法中，首先会通过ActivityManagerService为这个应用绑定一个Application，然后添加一个垃圾回收观察者，每当系统触发垃圾回收的时候就会在run方法里面去计算应用使用了多少内存，如果超过总量的四分之三就会尝试释放内存。最后，为根View添加config回调接收config变化相关的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">     sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">     mSystemThread = system;</span><br><span class="line">     <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">         android.ddm.DdmHandleAppName.setAppName(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>,</span><br><span class="line">                                                 UserHandle.myUserId());</span><br><span class="line">         RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">         <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">             <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">         &#125;</span><br><span class="line">         ......</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Don&#x27;t set application object here -- if the system crashes,</span></span><br><span class="line">         <span class="comment">// we can&#x27;t display an alert, we just want to die die die.</span></span><br><span class="line">         android.ddm.DdmHandleAppName.setAppName(<span class="string">&quot;system_process&quot;</span>,</span><br><span class="line">                 UserHandle.myUserId());</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">             mInstrumentation.basicInit(<span class="keyword">this</span>);</span><br><span class="line">             ContextImpl context = ContextImpl.createAppContext(</span><br><span class="line">                     <span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">             mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">             mInitialApplication.onCreate();</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                     <span class="string">&quot;Unable to instantiate Application():&quot;</span> + e.toString(), e);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     ViewRootImpl.ConfigChangedCallback configChangedCallback</span><br><span class="line">             = (Configuration globalConfig) -&gt; &#123;</span><br><span class="line">         <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">             <span class="comment">// We need to apply this change to the resources immediately, because upon returning</span></span><br><span class="line">             <span class="comment">// the view hierarchy will be informed about it.</span></span><br><span class="line">             <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(globalConfig,</span><br><span class="line">                     <span class="keyword">null</span> <span class="comment">/* compat */</span>)) &#123;</span><br><span class="line">                 updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                         mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// This actually changed the resources! Tell everyone about it.</span></span><br><span class="line">                 <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span></span><br><span class="line">                         || mPendingConfiguration.isOtherSeqNewer(globalConfig)) &#123;</span><br><span class="line">                     mPendingConfiguration = globalConfig;</span><br><span class="line">                     sendMessage(H.CONFIGURATION_CHANGED, globalConfig);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;;</span><br><span class="line">     ViewRootImpl.addConfigCallback(configChangedCallback);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-7-1、ActivityManagerService-attachApplication"><a href="#3-7-1、ActivityManagerService-attachApplication" class="headerlink" title="3.7.1、ActivityManagerService.attachApplication()"></a>3.7.1、ActivityManagerService.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(<span class="meta">@NonNull</span> IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> pid, <span class="keyword">int</span> callingUid, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the application record that is being attached...  either via</span></span><br><span class="line">        <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></span><br><span class="line">        <span class="comment">// next app record if we are emulating process with anonymous threads.</span></span><br><span class="line">        ProcessRecord app;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">long</span> bindApplicationTimeMillis;</span><br><span class="line">        ......</span><br><span class="line">        ------------------------------------------------------</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.897</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityManagerService: Binding process pid <span class="number">1069</span> to record ProcessRecord&#123;f5e79a0 <span class="number">1069</span>:com.android.testred/u0a56&#125;</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.897</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityManagerService: New death recipient com.android.server.am.ActivityManagerService$AppDeathRecipient<span class="meta">@c19c0af</span> <span class="keyword">for</span> thread android.os.BinderProxy@<span class="number">6068</span>cbc</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.897</span>   <span class="number">433</span>   <span class="number">451</span> I am_proc_bound: [<span class="number">0</span>,<span class="number">1069</span>,com.android.testred]</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.897</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityManagerService: New app record ProcessRecord&#123;f5e79a0 <span class="number">1069</span>:com.android.testred/u0a56&#125; thread=android.os.BinderProxy@<span class="number">6068</span>cbc pid=<span class="number">1069</span></span><br><span class="line">        ------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">                TAG, <span class="string">&quot;Binding process pid &quot;</span> + pid + <span class="string">&quot; to record &quot;</span> + app);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;New app record &quot;</span> + app</span><br><span class="line">            + <span class="string">&quot; thread=&quot;</span> + thread.asBinder() + <span class="string">&quot; pid=&quot;</span> + pid);</span><br><span class="line">        <span class="keyword">final</span> BackupRecord backupTarget = mBackupTargets.get(app.userId);</span><br><span class="line">     </span><br><span class="line">            -------------------------------------------------</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.897</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityManagerService_Configuration: Binding proc com.android.testred with config &#123;<span class="number">1.0</span> ?mcc?mnc [en_US] ldltr sw621dp w1097dp h549dp <span class="number">280d</span>pi lrg <span class="keyword">long</span> land finger -keyb/v/h dpad/v winConfig=&#123; mBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">1920</span>, <span class="number">1088</span>) mAppBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">1920</span>, <span class="number">1004</span>) mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_90&#125; s.<span class="number">6</span>&#125;</span><br><span class="line">            -------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">&quot;Binding proc &quot;</span></span><br><span class="line">                    + processName + <span class="string">&quot; with config &quot;</span></span><br><span class="line">                    + app.getWindowProcessController().getConfiguration());</span><br><span class="line">            ApplicationInfo appInfo = instr != <span class="keyword">null</span> ? instr.mTargetInfo : app.info;</span><br><span class="line">            app.compat = compatibilityInfoForPackage(appInfo);</span><br><span class="line"></span><br><span class="line">            ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">            String preBindAgent = <span class="keyword">null</span>;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">final</span> ActiveInstrumentation instr2 = app.getActiveInstrumentation();</span><br><span class="line">            <span class="keyword">if</span> (app.isolatedEntryPoint != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// This is an isolated process which should just call an entry point instead of</span></span><br><span class="line">                <span class="comment">// being bound to an application.</span></span><br><span class="line">                thread.runIsolatedEntryPoint(app.isolatedEntryPoint, app.isolatedEntryPointArgs);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instr2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                        instr2.mClass,</span><br><span class="line">                        profilerInfo, instr2.mArguments,</span><br><span class="line">                        instr2.mWatcher,</span><br><span class="line">                        instr2.mUiAutomationConnection, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                        <span class="keyword">new</span> Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                        app.compat, getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, autofillOptions, contentCaptureOptions);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                thread.bindApplication(processName, appInfo, providers, <span class="keyword">null</span>, profilerInfo,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.isPersistent(),</span><br><span class="line">                        <span class="keyword">new</span> Configuration(app.getWindowProcessController().getConfiguration()),</span><br><span class="line">                        app.compat, getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, autofillOptions, contentCaptureOptions);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">        <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.wtf(TAG, <span class="string">&quot;Exception thrown launching activities in &quot;</span> + app, e);</span><br><span class="line">                badApp = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里又调用App进程自己的bindApplication()方法。接着</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callers=com.android.server.wm.ActivityStackSupervisor.realStartActivityLocked:<span class="number">917</span> com.android.server.wm.RootActivityContainer.attachApplication:<span class="number">784</span> com.android.server.wm.ActivityTaskManagerService$LocalService.attachApplication:<span class="number">6949</span> com.android.server.am.ActivityManagerService.attachApplicationLocked:<span class="number">5213</span> com.android.server.am.ActivityManagerService.attachApplication:<span class="number">5293</span> </span><br></pre></td></tr></table></figure>

<h4 id="3-7-2、ActivityTaskManagerService-LocalService-attachApplication"><a href="#3-7-2、ActivityTaskManagerService-LocalService-attachApplication" class="headerlink" title="3.7.2、ActivityTaskManagerService$LocalService.attachApplication()"></a>3.7.2、ActivityTaskManagerService$LocalService.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityTaskManagerService.java</span><br><span class="line">        <span class="meta">@HotPath(caller = HotPath.PROCESS_CHANGE)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">attachApplication</span><span class="params">(WindowProcessController wpc)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mGlobalLockWithoutBoost) &#123;</span><br><span class="line">                <span class="keyword">return</span> mRootActivityContainer.attachApplication(wpc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-7-3、RootActivityContainer-attachApplication"><a href="#3-7-3、RootActivityContainer-attachApplication" class="headerlink" title="3.7.3、RootActivityContainer.attachApplication()"></a>3.7.3、RootActivityContainer.attachApplication()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\RootActivityContainer.java</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">attachApplication</span><span class="params">(WindowProcessController app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String processName = app.mName;</span><br><span class="line">        <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityDisplay display = mActivityDisplays.get(displayNdx);</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = display.getFocusedStack();</span><br><span class="line">            <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList);</span><br><span class="line">                <span class="keyword">final</span> ActivityRecord top = stack.topRunningActivityLocked();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> size = mTmpActivityList.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityRecord activity = mTmpActivityList.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (activity.app == <span class="keyword">null</span> &amp;&amp; app.mUid == activity.info.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; processName.equals(activity.processName)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mStackSupervisor.realStartActivityLocked(activity, app,</span><br><span class="line">                                    top == activity <span class="comment">/* andResume */</span>, <span class="keyword">true</span> <span class="comment">/* checkConfig */</span>)) &#123;</span><br><span class="line">                                didSomething = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">&quot;Exception in new application when starting activity &quot;</span></span><br><span class="line">                                    + top.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">                            <span class="keyword">throw</span> e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">            ensureActivitiesVisible(<span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">false</span> <span class="comment">/* preserve_windows */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> didSomething;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-7-4、ActivityStackSupervisor-realStartActivityLocked"><a href="#3-7-4、ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="3.7.4、ActivityStackSupervisor.realStartActivityLocked()"></a>3.7.4、ActivityStackSupervisor.realStartActivityLocked()</h4><p>又进入熟悉的realStartActivityLocked方法了，之前因为app进程没有创建，startSpecificActivityLocked走的另外一个分支，还记着吗</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, WindowProcessController proc,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = r.getTaskRecord();</span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack = task.getStack();</span><br><span class="line"></span><br><span class="line">        beginDeferResume();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.startFreezingScreenLocked(proc, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">            r.startLaunchTickingLocked();</span><br><span class="line"></span><br><span class="line">            r.setProcess(proc);</span><br><span class="line">            ......</span><br><span class="line">            r.launchCount++;</span><br><span class="line">            r.lastLaunchTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">&quot;Launching: &quot;</span> + r);</span><br><span class="line"></span><br><span class="line">            proc.addActivityIfNeeded(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> LockTaskController lockTaskController = mService.getLockTaskController();</span><br><span class="line">            <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE</span><br><span class="line">                    || task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV</span><br><span class="line">                    || (task.mLockTaskAuth == LOCK_TASK_AUTH_WHITELISTED</span><br><span class="line">                            &amp;&amp; lockTaskController.getLockTaskModeState()</span><br><span class="line">                                    == LOCK_TASK_MODE_LOCKED)) &#123;</span><br><span class="line">                lockTaskController.startLockTaskMode(task, <span class="keyword">false</span>, <span class="number">0</span> <span class="comment">/* blank UID */</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!proc.hasThread()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line">                List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    <span class="comment">// We don&#x27;t need to deliver new intents and/or set results if activity is going</span></span><br><span class="line">                    <span class="comment">// to pause immediately after launch.</span></span><br><span class="line">                    results = r.results;</span><br><span class="line">                    newIntents = r.newIntents;</span><br><span class="line">                &#125;</span><br><span class="line">    -------------------------------------------------------------</span><br><span class="line">    Line <span class="number">80647</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.909</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityStackSupervisor: Launching: ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125;</span><br><span class="line">    Line <span class="number">80652</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.909</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityStackSupervisor_Switch: Launching: ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125; icicle=<span class="keyword">null</span> with results=<span class="keyword">null</span> newIntents=<span class="keyword">null</span> andResume=<span class="keyword">true</span></span><br><span class="line">    Line <span class="number">80656</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.909</span>   <span class="number">433</span>   <span class="number">451</span> I am_restart_activity: [<span class="number">0</span>,<span class="number">90434829</span>,<span class="number">2</span>,com.android.testred/.TestActivity]</span><br><span class="line">  --------------------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</span><br><span class="line">                        <span class="string">&quot;Launching: &quot;</span> + r + <span class="string">&quot; icicle=&quot;</span> + r.icicle + <span class="string">&quot; with results=&quot;</span> + results</span><br><span class="line">                                + <span class="string">&quot; newIntents=&quot;</span> + newIntents + <span class="string">&quot; andResume=&quot;</span> + andResume);</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY, r.mUserId,</span><br><span class="line">                        System.identityHashCode(r), task.taskId, r.shortComponentName);</span><br><span class="line">                <span class="keyword">if</span> (r.isActivityTypeHome()) &#123;</span><br><span class="line">                    <span class="comment">// Home process is the root process of the task.</span></span><br><span class="line">                    updateHomeProcess(task.mActivities.get(<span class="number">0</span>).app);</span><br><span class="line">                &#125;</span><br><span class="line">                mService.getPackageManagerInternalLocked().notifyPackageUse(</span><br><span class="line">                        r.intent.getComponent().getPackageName(), NOTIFY_PACKAGE_USE_ACTIVITY);</span><br><span class="line">                r.sleeping = <span class="keyword">false</span>;</span><br><span class="line">                r.forceNewConfig = <span class="keyword">false</span>;</span><br><span class="line">                mService.getAppWarningsLocked().onStartActivity(r);</span><br><span class="line">                r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Because we could be starting an Activity in the system process this may not go</span></span><br><span class="line">                <span class="comment">// across a Binder interface which would create a new Configuration. Consequently</span></span><br><span class="line">                <span class="comment">// we have to always create a new Configuration here.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> MergedConfiguration mergedConfiguration = <span class="keyword">new</span> MergedConfiguration(</span><br><span class="line">                        proc.getConfiguration(), r.getMergedOverrideConfiguration());</span><br><span class="line">                r.setLastReportedConfiguration(mergedConfiguration);</span><br><span class="line"></span><br><span class="line">                logIfTransactionTooLarge(r.intent, r.icicle);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">                <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(</span><br><span class="line">                        proc.getThread(), r.appToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> DisplayContent dc = r.getDisplay().mDisplayContent;</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                        <span class="comment">// and override configs.</span></span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, proc.getReportedProcState(),</span><br><span class="line">                        r.icicle, r.persistentState, results, newIntents,</span><br><span class="line">                        dc.isNextTransitionForward(), proc.createProfilerInfoIfNeeded(),</span><br><span class="line">                                r.assistToken));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set desired final state.</span></span><br><span class="line">                <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    lifecycleItem = ResumeActivityItem.obtain(dc.isNextTransitionForward());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">                &#125;</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Schedule transaction.</span></span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((proc.mInfo.privateFlags &amp; ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span></span><br><span class="line">                        &amp;&amp; mService.mHasHeavyWeightFeature) &#123;</span><br><span class="line">                    <span class="comment">// This may be a heavy-weight process! Note that the package manager will ensure</span></span><br><span class="line">                    <span class="comment">// that only activity can run in the main process of the .apk, which is the only</span></span><br><span class="line">                    <span class="comment">// thing that will be considered heavy-weight.</span></span><br><span class="line">                    <span class="keyword">if</span> (proc.mName.equals(proc.mInfo.packageName)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; mService.mHeavyWeightProcess != proc) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">&quot;Starting new heavy weight process &quot;</span> + proc</span><br><span class="line">                                    + <span class="string">&quot; when already running &quot;</span></span><br><span class="line">                                    + mService.mHeavyWeightProcess);</span><br><span class="line">                        &#125;</span><br><span class="line">                        mService.setHeavyWeightProcess(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.launchFailed) &#123;</span><br><span class="line">                    <span class="comment">// This is the second time we failed -- finish activity and give up.</span></span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Second failure launching &quot;</span></span><br><span class="line">                            + r.intent.getComponent().flattenToShortString() + <span class="string">&quot;, giving up&quot;</span>, e);</span><br><span class="line">                    proc.appDied();</span><br><span class="line">                    stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="string">&quot;2nd-crash&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This is the first time we failed -- restart process and</span></span><br><span class="line">                <span class="comment">// retry.</span></span><br><span class="line">                r.launchFailed = <span class="keyword">true</span>;</span><br><span class="line">                proc.removeActivity(r);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            endDeferResume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.launchFailed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (stack.updateLRUListLocked(r)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Activity &quot;</span> + r + <span class="string">&quot; being launched, but already in LRU list&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO(lifecycler): Resume or pause requests are done as part of launch transaction,</span></span><br><span class="line">        <span class="comment">// so updating the state should be done accordingly.</span></span><br><span class="line">        <span class="keyword">if</span> (andResume &amp;&amp; readyToResume()) &#123;</span><br><span class="line">            <span class="comment">// As part of the process of launching, ActivityThread also performs</span></span><br><span class="line">            <span class="comment">// a resume.</span></span><br><span class="line">            stack.minimalResumeActivityLocked(r);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This activity is not starting in the resumed state... which should look like we asked</span></span><br><span class="line">            <span class="comment">// it to pause+stop (but remain visible), and it has done so and reported back the</span></span><br><span class="line">            <span class="comment">// current icicle and other state.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES,</span><br><span class="line">                    <span class="string">&quot;Moving to PAUSED: &quot;</span> + r + <span class="string">&quot; (starting in paused state)&quot;</span>);</span><br><span class="line">            r.setState(PAUSED, <span class="string">&quot;realStartActivityLocked&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Perform OOM scoring after the activity state is set, so the process can be updated with</span></span><br><span class="line">        <span class="comment">// the latest state.</span></span><br><span class="line">        proc.onStartActivity(mService.mTopProcessState, r.info);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Launch the new version setup screen if needed.  We do this -after-</span></span><br><span class="line">        <span class="comment">// launching the initial activity (that is, home), so that it can have</span></span><br><span class="line">        <span class="comment">// a chance to initialize itself while in the background, making the</span></span><br><span class="line">        <span class="comment">// switch back to it faster and look better.</span></span><br><span class="line">        <span class="keyword">if</span> (mRootActivityContainer.isTopDisplayFocusedStack(stack)) &#123;</span><br><span class="line">            mService.getActivityStartController().startSetupActivity();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update any services we are bound to that might care about whether</span></span><br><span class="line">        <span class="comment">// their client may have activities.</span></span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.app.updateServiceConnectionActivities();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-7-5、LaunchActivityItem-obtain"><a href="#3-7-5、LaunchActivityItem-obtain" class="headerlink" title="3.7.5、LaunchActivityItem.obtain()"></a>3.7.5、LaunchActivityItem.obtain()</h4><p>ClientTransaction对象添加LaunchActivityItem的callback，然后设置当前的生命周期状态，最后调用ClientLifecycleManager.scheduleTransaction方法执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStackSupervisor.java</span><br><span class="line">                <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">                <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(</span><br><span class="line">                        proc.getThread(), r.appToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> DisplayContent dc = r.getDisplay().mDisplayContent;</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                        <span class="comment">// and override configs.</span></span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, proc.getReportedProcState(),</span><br><span class="line">                        r.icicle, r.persistentState, results, newIntents,</span><br><span class="line">                        dc.isNextTransitionForward(), proc.createProfilerInfoIfNeeded(),</span><br><span class="line">                                r.assistToken));</span><br><span class="line">                <span class="comment">// Set desired final state.</span></span><br><span class="line">                <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    lifecycleItem = ResumeActivityItem.obtain(dc.isNextTransitionForward());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">                &#125;</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Schedule transaction.</span></span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br></pre></td></tr></table></figure>


<h4 id="3-7-6、ActivityStack-minimalResumeActivityLocked-r"><a href="#3-7-6、ActivityStack-minimalResumeActivityLocked-r" class="headerlink" title="3.7.6、ActivityStack.minimalResumeActivityLocked(r)"></a>3.7.6、ActivityStack.minimalResumeActivityLocked(r)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStack.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">minimalResumeActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;Moving to RESUMED: &quot;</span> + r + <span class="string">&quot; (starting new instance)&quot;</span></span><br><span class="line">                + <span class="string">&quot; callers=&quot;</span> + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line">        r.setState(RESUMED, <span class="string">&quot;minimalResumeActivityLocked&quot;</span>);</span><br><span class="line">        r.completeResumeLocked();</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SAVED_STATE) Slog.i(TAG_SAVED_STATE,</span><br><span class="line">                <span class="string">&quot;Launch completed; removing icicle of &quot;</span> + r.icicle);</span><br><span class="line">    &#125;</span><br><span class="line">--------------------------------------------------------------</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.910</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityStack_Stack: set resumed activity to:ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125; reason:minimalResumeActivityLocked</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.911</span>   <span class="number">433</span>   <span class="number">451</span> D ActivityStack_Stack: setResumedActivity stack:ActivityStack&#123;<span class="number">6</span>c17ba0 stackId=<span class="number">0</span> type=home mode=fullscreen visible=<span class="keyword">true</span> translucent=<span class="keyword">true</span>, <span class="number">2</span> tasks&#125; + from: <span class="keyword">null</span> to:ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125; reason:minimalResumeActivityLocked - onActivityStateChanged</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityRecord.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setState</span><span class="params">(ActivityState state, String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;State movement: &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; from:&quot;</span> + getState()</span><br><span class="line">                        + <span class="string">&quot; to:&quot;</span> + state + <span class="string">&quot; reason:&quot;</span> + reason);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == mState) &#123;</span><br><span class="line">            <span class="comment">// No need to do anything if state doesn&#x27;t change.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;State unchanged from:&quot;</span> + state);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mState = state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskRecord parent = getTaskRecord();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            parent.onActivityStateChanged(<span class="keyword">this</span>, state, reason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The WindowManager interprets the app stopping signal as</span></span><br><span class="line">        <span class="comment">// an indication that the Surface will eventually be destroyed.</span></span><br><span class="line">        <span class="comment">// This however isn&#x27;t necessarily true if we are going to sleep.</span></span><br><span class="line">        <span class="keyword">if</span> (state == STOPPING &amp;&amp; !isSleeping()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAppWindowToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_WM, <span class="string">&quot;Attempted to notify stopping on non-existing app token: &quot;</span></span><br><span class="line">                        + appToken);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mAppWindowToken.detachChildren();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == RESUMED) &#123;</span><br><span class="line">            mAtmService.updateBatteryStats(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">            mAtmService.updateActivityUsageStats(<span class="keyword">this</span>, Event.ACTIVITY_RESUMED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == PAUSED) &#123;</span><br><span class="line">            mAtmService.updateBatteryStats(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">            mAtmService.updateActivityUsageStats(<span class="keyword">this</span>, Event.ACTIVITY_PAUSED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == STOPPED) &#123;</span><br><span class="line">            mAtmService.updateActivityUsageStats(<span class="keyword">this</span>, Event.ACTIVITY_STOPPED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == DESTROYED) &#123;</span><br><span class="line">            mAtmService.updateActivityUsageStats(<span class="keyword">this</span>, Event.ACTIVITY_DESTROYED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="四、执行启动Acitivity"><a href="#四、执行启动Acitivity" class="headerlink" title="四、执行启动Acitivity"></a>四、执行启动Acitivity</h4><h5 id="4-1、LaunchActivityItem-execute"><a href="#4-1、LaunchActivityItem-execute" class="headerlink" title="4.1、LaunchActivityItem.execute()"></a>4.1、LaunchActivityItem.execute()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\services\core\java\com\android\server\wm\ActivityStackSupervisor.java</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                        <span class="comment">// and override configs.</span></span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, proc.getReportedProcState(),</span><br><span class="line">                        r.icicle, r.persistentState, results, newIntents,</span><br><span class="line">                        dc.isNextTransitionForward(), proc.createProfilerInfoIfNeeded(),</span><br><span class="line">                                r.assistToken));</span><br></pre></td></tr></table></figure>

<p>这里的clientTransaction.addCallback(LaunchActivityItem.obtain(arg…))就是我们目前用到的lifecycleItem,也就是说 这个lifecycleItem就是LaunchActivityItem<br>继续看lifecycleItem.execute(mTransactionHandler, token, mPendingActions);源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\core\java\android\app\servertransaction\LaunchActivityItem.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">                mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">                mPendingResults, mPendingNewIntents, mIsForward,</span><br><span class="line">                mProfilerInfo, client, mAssistToken);</span><br><span class="line">        client.handleLaunchActivity(r, pendingActions, <span class="keyword">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-2、ActivityThread-handleLaunchActivity"><a href="#4-2、ActivityThread-handleLaunchActivity" class="headerlink" title="4.2、ActivityThread.handleLaunchActivity()"></a>4.2、ActivityThread.handleLaunchActivity()</h5><p>client.handleLaunchActivity就是:控制activity的生命周期  真正的实现类是ClientTransactionHandler的子类 Activityhread;</p>
<p>继续看client.handleLaunchActivity源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Extended implementation of activity launch. Used when server requests a launch or relaunch.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Activity <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">        <span class="comment">// we are back active so skip it.</span></span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProfiler.setProfiler(r.profilerInfo);</span><br><span class="line">            mProfiler.startProfiling();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure we are running with the most recent config.</span></span><br><span class="line">        handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;Handling launch of &quot;</span> + r);</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.i(TAG, <span class="string">&quot;handleLaunchActivity&quot;</span>,<span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize before creating the activity</span></span><br><span class="line">        <span class="keyword">if</span> (!ThreadedRenderer.sRendererDisabled</span><br><span class="line">                &amp;&amp; (r.activityInfo.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>) &#123;</span><br><span class="line">            HardwareRenderer.preload();</span><br><span class="line">        &#125;</span><br><span class="line">        WindowManagerGlobal.initialize();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hint the GraphicsEnvironment that an activity is launching on the process.</span></span><br><span class="line">        GraphicsEnvironment.hintActivityLaunch();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">            reportSizeConfigurations(r);</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; pendingActions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pendingActions.setOldState(r.state);</span><br><span class="line">                pendingActions.setRestoreInstanceState(<span class="keyword">true</span>);</span><br><span class="line">                pendingActions.setCallOnPostCreate(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If there was an error, for any reason, tell the activity manager to stop us.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityTaskManager.getService()</span><br><span class="line">                        .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                                Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: handleLaunchActivity</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:<span class="number">3401</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:<span class="number">83</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:<span class="number">135</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">95</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.978</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span>)</span><br><span class="line">----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>


<h5 id="4-3、ActivityThread-performLaunchActivity"><a href="#4-3、ActivityThread-performLaunchActivity" class="headerlink" title="4.3、ActivityThread.performLaunchActivity()"></a>4.3、ActivityThread.performLaunchActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**  Core implementation of activity launch. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.i(TAG, <span class="string">&quot;performLaunchActivity&quot;</span>,<span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());;</span><br><span class="line"></span><br><span class="line">        ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">        <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ComponentName component = r.intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = r.intent.resolveActivity(</span><br><span class="line">                mInitialApplication.getPackageManager());</span><br><span class="line">            r.intent.setComponent(component);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">        Activity activity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to instantiate activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Performing launch of &quot;</span> + r);</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, r + <span class="string">&quot;: app=&quot;</span> + app</span><br><span class="line">                    + <span class="string">&quot;, appName=&quot;</span> + app.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, pkg=&quot;</span> + r.packageInfo.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, comp=&quot;</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                    + <span class="string">&quot;, dir=&quot;</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">                <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    config.updateFrom(r.overrideConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">&quot;Launching activity &quot;</span></span><br><span class="line">                        + r.activityInfo.name + <span class="string">&quot; with config &quot;</span> + config);</span><br><span class="line">                Window window = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                    window = r.mPendingRemoveWindow;</span><br><span class="line">                    r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                    r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                appContext.setOuterContext(activity);</span><br><span class="line">                activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback,</span><br><span class="line">                        r.assistToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    activity.mIntent = customIntent;</span><br><span class="line">                &#125;</span><br><span class="line">                r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">                checkAndBlockForNetworkAccess();</span><br><span class="line">                activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">                <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                    activity.setTheme(theme);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">&quot;Activity &quot;</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">&quot; did not call through to super.onCreate()&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.activity = activity;</span><br><span class="line">            &#125;</span><br><span class="line">            r.setState(ON_CREATE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// updatePendingActivityConfiguration() reads from mActivities to update</span></span><br><span class="line">            <span class="comment">// ActivityClientRecord which runs in a different thread. Protect modifications to</span></span><br><span class="line">            <span class="comment">// mActivities to avoid race.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">                mActivities.put(r.token, r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to start activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br><span class="line">------------------------------------------------------</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: performLaunchActivity</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:<span class="number">3160</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:<span class="number">3413</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:<span class="number">83</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:<span class="number">135</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">95</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">29.983</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span>)</span><br><span class="line">-------------------------------------------------------</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化activity的context</li>
<li>利用classloader机制反射获取activity实例</li>
<li>创建app的入口application</li>
<li>执行 activity的attach方法   初始化window/父parent-DecorView/windowManage ,windowManager的子类为 - WindowManagerimpl 是view和window的操作类</li>
<li>执行activity的onCreate方法</li>
</ul>
<p>至此executeCallbacks执行完毕，开始执行executeLifecycleState方法。先执行cycleToPath方法，生命周期状态是从ON_CREATE状态到ON_RESUME状态，中间有一个ON_START状态，所以会执行ActivityThread.handleStartActivity方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">X:\frameworks\base\core\java\android\app\servertransaction\TransactionExecutor.java</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transition the client between states with an option not to perform the last hop in the</span></span><br><span class="line"><span class="comment">     * sequence. This is used when resolving lifecycle state request, when the last transition must</span></span><br><span class="line"><span class="comment">     * be performed with some specific parameters.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cycleToPath</span><span class="params">(ActivityClientRecord r, <span class="keyword">int</span> finish, <span class="keyword">boolean</span> excludeLastState,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> start = r.getLifecycleState();</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_RESOLVER) &#123;</span><br><span class="line">            Slog.d(TAG, tId(transaction) + <span class="string">&quot;Cycle activity: &quot;</span></span><br><span class="line">                    + getShortActivityName(r.token, mTransactionHandler)</span><br><span class="line">                    + <span class="string">&quot; from: &quot;</span> + getStateName(start) + <span class="string">&quot; to: &quot;</span> + getStateName(finish)</span><br><span class="line">                    + <span class="string">&quot; excludeLastState: &quot;</span> + excludeLastState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> IntArray path = mHelper.getLifecyclePath(start, finish, excludeLastState);</span><br><span class="line">        performLifecycleSequence(r, path, transaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Transition the client through previously initialized state sequence. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLifecycleSequence</span><span class="params">(ActivityClientRecord r, IntArray path,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> size = path.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, state; i &lt; size; i++) &#123;</span><br><span class="line">            state = path.get(i);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_RESOLVER) &#123;</span><br><span class="line">                Slog.d(TAG, tId(transaction) + <span class="string">&quot;Transitioning activity: &quot;</span></span><br><span class="line">                        + getShortActivityName(r.token, mTransactionHandler)</span><br><span class="line">                        + <span class="string">&quot; to state: &quot;</span> + getStateName(state));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">                    mTransactionHandler.handleLaunchActivity(r, mPendingActions,</span><br><span class="line">                            <span class="keyword">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ON_START:</span><br><span class="line">                    mTransactionHandler.handleStartActivity(r, mPendingActions);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">                    mTransactionHandler.handleResumeActivity(r.token, <span class="keyword">false</span> <span class="comment">/* finalStateRequest */</span>,</span><br><span class="line">                            r.isForward, <span class="string">&quot;LIFECYCLER_RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">                    mTransactionHandler.handlePauseActivity(r.token, <span class="keyword">false</span> <span class="comment">/* finished */</span>,</span><br><span class="line">                            <span class="keyword">false</span> <span class="comment">/* userLeaving */</span>, <span class="number">0</span> <span class="comment">/* configChanges */</span>, mPendingActions,</span><br><span class="line">                            <span class="string">&quot;LIFECYCLER_PAUSE_ACTIVITY&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ON_STOP:</span><br><span class="line">                    mTransactionHandler.handleStopActivity(r.token, <span class="keyword">false</span> <span class="comment">/* show */</span>,</span><br><span class="line">                            <span class="number">0</span> <span class="comment">/* configChanges */</span>, mPendingActions, <span class="keyword">false</span> <span class="comment">/* finalStateRequest */</span>,</span><br><span class="line">                            <span class="string">&quot;LIFECYCLER_STOP_ACTIVITY&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">                    mTransactionHandler.handleDestroyActivity(r.token, <span class="keyword">false</span> <span class="comment">/* finishing */</span>,</span><br><span class="line">                            <span class="number">0</span> <span class="comment">/* configChanges */</span>, <span class="keyword">false</span> <span class="comment">/* getNonConfigInstance */</span>,</span><br><span class="line">                            <span class="string">&quot;performLifecycleSequence. cycling to:&quot;</span> + path.get(size - <span class="number">1</span>));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ON_RESTART:</span><br><span class="line">                    mTransactionHandler.performRestartActivity(r.token, <span class="keyword">false</span> <span class="comment">/* start */</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected lifecycle state: &quot;</span> + state);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>从ActivityThread.handleStartActivity方法经过多次跳转最后会调用Activity.onStart方法，至此cycleToPath方法执行完毕。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartActivity</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Start</span></span><br><span class="line">        activity.performStart(<span class="string">&quot;handleStartActivity&quot;</span>);</span><br><span class="line">        r.setState(ON_START);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frameworks/base/core/java/android/app/Activity.java</span><br><span class="line">        <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.onStart();</span><br><span class="line">    &#125;</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: handleStartActivity</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.handleStartActivity(ActivityThread.java:<span class="number">3294</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.performLifecycleSequence(TransactionExecutor.java:<span class="number">221</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.cycleToPath(TransactionExecutor.java:<span class="number">201</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:<span class="number">173</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">97</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.031</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span>)</span><br><span class="line">----------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>执行完毕cycleToPath，开始执行ResumeActivityItem.execute方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">   frameworks/base/core/java/android/app/servertransaction/ResumeActivityItem.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        client.handleResumeActivity(token, <span class="keyword">true</span> <span class="comment">/* finalStateRequest */</span>, mIsForward,</span><br><span class="line">                <span class="string">&quot;RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finalStateRequest, <span class="keyword">boolean</span> isForward,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">        ...</span><br><span class="line">        Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityClientRecord <span class="title">performResumeActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finalStateRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.activity.onStateNotSaved();</span><br><span class="line">            r.activity.mFragments.noteStateNotSaved();</span><br><span class="line">            checkAndBlockForNetworkAccess();</span><br><span class="line">            <span class="keyword">if</span> (r.pendingIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">                deliverNewIntents(r, r.pendingIntents);</span><br><span class="line">                r.pendingIntents = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.pendingResults != <span class="keyword">null</span>) &#123;</span><br><span class="line">                deliverResults(r, r.pendingResults, reason);</span><br><span class="line">                r.pendingResults = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line"></span><br><span class="line">            r.state = <span class="keyword">null</span>;</span><br><span class="line">            r.persistentState = <span class="keyword">null</span>;</span><br><span class="line">            r.setState(ON_RESUME);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to resume activity &quot;</span></span><br><span class="line">                        + r.intent.getComponent().toShortString() + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frameworks/base/core/java/android/app/Activity.java</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">(<span class="keyword">boolean</span> followedByPause, String reason)</span> </span>&#123;</span><br><span class="line">        performRestart(<span class="keyword">true</span> <span class="comment">/* start */</span>, reason);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// mResumed is set by the instrumentation</span></span><br><span class="line">        mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">        activity.onResume();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: handleResumeActivity</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:<span class="number">4241</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.ResumeActivityItem.execute(ResumeActivityItem.java:<span class="number">52</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:<span class="number">176</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">97</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>经过上面的多次跳转最终调用到Activity.onResume方法，Activity启动完毕。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">我们来看一下Activity 的生命周期：</span><br><span class="line"></span><br><span class="line">&gt; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>; </span><br><span class="line">&gt; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span></span>; </span><br><span class="line">&gt; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>; </span><br><span class="line">&gt; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span></span>; </span><br><span class="line">&gt; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span></span>;</span><br><span class="line">&gt; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestory</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>performPauseActivityIfNeeded</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">performPauseActivityIfNeeded</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread: performPauseActivityIfNeeded</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.ActivityThread.performPauseActivityIfNeeded(ActivityThread.java:<span class="number">4493</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.ActivityThread.performPauseActivity(ActivityThread.java:<span class="number">4461</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.ActivityThread.handleRelaunchActivityInner(ActivityThread.java:<span class="number">5261</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.ActivityThread.handleRelaunchActivity(ActivityThread.java:<span class="number">5199</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.servertransaction.ActivityRelaunchItem.execute(ActivityRelaunchItem.java:<span class="number">69</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:<span class="number">135</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">95</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">16</span>:<span class="number">44.970</span>   <span class="number">728</span>   <span class="number">728</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>performStopActivityInner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread: performStopActivityInner</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread.performStopActivityInner(ActivityThread.java:<span class="number">4565</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread.handleStopActivity(ActivityThread.java:<span class="number">4679</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.performLifecycleSequence(TransactionExecutor.java:<span class="number">233</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.cycleToPath(TransactionExecutor.java:<span class="number">201</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:<span class="number">173</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">97</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.339</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>performDestroyActivity </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread: performDestroyActivity</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread.performDestroyActivity(ActivityThread.java:<span class="number">4909</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread.handleDestroyActivity(ActivityThread.java:<span class="number">4982</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.DestroyActivityItem.execute(DestroyActivityItem.java:<span class="number">44</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:<span class="number">176</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:<span class="number">97</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:<span class="number">2016</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">107</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at android.app.ActivityThread.main(ActivityThread.java:<span class="number">7368</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:<span class="number">492</span>)</span><br><span class="line"><span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">31.341</span>   <span class="number">729</span>   <span class="number">729</span> I ActivityThread:     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">930</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>前面我们分析了onCreate()、onStart() 、onResume()、onPause()。 Activity 暂停销毁时的 、onStop() 、onDestroy() 回调都与前面的过程大同小异，这里就只列举相应的方法栈，不再继续描述。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------------</span><br><span class="line">Line <span class="number">81035</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.004</span>  <span class="number">1069</span>  <span class="number">1069</span> V Activity: onCreate com.android.testred.TestActivity<span class="meta">@e170766</span>: <span class="keyword">null</span></span><br><span class="line">Line <span class="number">81056</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.023</span>  <span class="number">1069</span>  <span class="number">1069</span> I am_on_create_called: [<span class="number">0</span>,com.android.testred.TestActivity,performCreate]</span><br><span class="line">Line <span class="number">81078</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.029</span>   <span class="number">433</span>   <span class="number">451</span> I ActivityRecord: Taking options <span class="keyword">for</span> ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125; callers=com.android.server.wm.ActivityTaskManagerService.getActivityOptions:<span class="number">2985</span> android.app.IActivityTaskManager$Stub.onTransact:<span class="number">2569</span> android.os.Binder.execTransactInternal:<span class="number">1021</span> android.os.Binder.execTransact:<span class="number">994</span> &lt;bottom of call stack&gt; &lt;bottom of call stack&gt; </span><br><span class="line">Line <span class="number">81079</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.030</span>   <span class="number">433</span>   <span class="number">451</span> V ActivityTaskManagerService: Report configuration: Token&#123;b3bac1f ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125;&#125; <span class="keyword">null</span> <span class="keyword">null</span></span><br><span class="line">Line <span class="number">81106</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.037</span>   <span class="number">433</span>   <span class="number">714</span> I ActivityRecord: Taking options <span class="keyword">for</span> ActivityRecord&#123;<span class="number">563</span>ed0d u0 com.android.testred/.TestActivity t2&#125; callers=com.android.server.wm.ActivityTaskManagerService.getActivityOptions:<span class="number">2985</span> android.app.IActivityTaskManager$Stub.onTransact:<span class="number">2569</span> android.os.Binder.execTransactInternal:<span class="number">1021</span> android.os.Binder.execTransact:<span class="number">994</span> &lt;bottom of call stack&gt; &lt;bottom of call stack&gt; </span><br><span class="line">Line <span class="number">81107</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.038</span>  <span class="number">1069</span>  <span class="number">1069</span> V Activity: onStart com.android.testred.TestActivity<span class="meta">@e170766</span></span><br><span class="line">Line <span class="number">81108</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.039</span>  <span class="number">1069</span>  <span class="number">1069</span> I am_on_start_called: [<span class="number">0</span>,com.android.testred.TestActivity,handleStartActivity]</span><br><span class="line">Line <span class="number">81138</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.043</span>  <span class="number">1069</span>  <span class="number">1069</span> V ActivityThread: Performing resume of ActivityRecord&#123;<span class="number">9</span>cb94af token=android.os.BinderProxy<span class="meta">@fbcf48e</span> &#123;com.android.testred/com.android.testred.TestActivity&#125;&#125; finished=<span class="keyword">false</span></span><br><span class="line">Line <span class="number">81156</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.044</span>  <span class="number">1069</span>  <span class="number">1069</span> V Activity: onResume com.android.testred.TestActivity<span class="meta">@e170766</span></span><br><span class="line">Line <span class="number">81157</span>: <span class="number">11</span>-<span class="number">12</span> <span class="number">03</span>:<span class="number">15</span>:<span class="number">30.045</span>  <span class="number">1069</span>  <span class="number">1069</span> I am_on_resume_called: [<span class="number">0</span>,com.android.testred.TestActivity,RESUME_ACTIVITY]</span><br><span class="line">---------------------------------------</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20211010/">https://zhoujinjian.com/posts/20211010/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.29.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20211111/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.30.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 10 Display System源码分析（9）：App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（2）：Window加载显示流程分析（Android 10.0 &amp;&amp; Kernel 4.15）</div></div></a></div><div class="next-post pull-right"><a href="/posts/20210910/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.28.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 10 Display System源码分析（7）：Native Surface创建 &amp;&amp; SurfaceFlinger合成流程分析（Android 10.0 &amp;&amp; Kernel 4.15）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">1.</span> <span class="toc-text">准备</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81Activity%E6%A6%82%E8%BF%B0"><span class="toc-number"></span> <span class="toc-text">一、Activity概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81Activity%E7%9A%84%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number"></span> <span class="toc-text">1.1、Activity的管理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-1%E3%80%81Task%E5%92%8CStack"><span class="toc-number">1.</span> <span class="toc-text">1.1.1、Task和Stack</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-2%E3%80%81%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">1.1.2、启动模式的作用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-3%E3%80%81%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">1.1.3、启动模式的作用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-4%E3%80%81ActivityStack-amp-TaskRecord-amp-ActivityRecord-%E5%85%B3%E7%B3%BB"><span class="toc-number">4.</span> <span class="toc-text">1.1.4、ActivityStack &amp; TaskRecord &amp; ActivityRecord 关系</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2%E3%80%81ActivityManagerService%E7%9B%B8%E5%85%B3%E7%B1%BB%E7%AE%80%E4%BB%8B"><span class="toc-number"></span> <span class="toc-text">1.2、ActivityManagerService相关类简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3%E3%80%81%E7%9B%B8%E5%85%B3%E7%B1%BB%E9%87%8D%E8%A6%81%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number"></span> <span class="toc-text">1.3、相关类重要成员变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4%E3%80%81%E5%B0%8F%E7%BB%93%EF%BC%9A"><span class="toc-number"></span> <span class="toc-text">1.4、小结：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81APP%E8%AF%B7%E6%B1%82%E5%90%AF%E5%8A%A8Activity%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">二、APP请求启动Activity（普通app启动流程）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81Activity-startActivity-%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">2.1、Activity.startActivity()（普通app启动流程）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81Activity-startActivityForResult-%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">2.2、Activity.startActivityForResult()（普通app启动流程）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3%E3%80%81Instrumentation-execStartActivity-%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">2.3、Instrumentation.execStartActivity()（普通app启动流程）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81-ActivityManagerService%E6%8E%A5%E6%94%B6%E5%90%AF%E5%8A%A8Activity%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="toc-number"></span> <span class="toc-text">三、 ActivityManagerService接收启动Activity的请求</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81ActivityManagerService-startActivity-%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">3.1、ActivityManagerService.startActivity()（普通app启动流程）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2%E3%80%81ActivityTaskManagerService-startActivityAndWait-%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">3.2、ActivityTaskManagerService.startActivityAndWait()（普通app启动流程）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3%E3%80%81ActivityStarter-execute-%EF%BC%88%E6%99%AE%E9%80%9Aapp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">3.3、ActivityStarter.execute()（普通app启动流程）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4%E3%80%81App%EF%BC%88%E2%80%9Dcom-android-testgreen%E2%80%9D%EF%BC%89%EF%BC%88Launcher-App%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number"></span> <span class="toc-text">3.4、App（”com.android.testgreen”）（Launcher App启动流程）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5%E3%80%81ActivityStarter-startActivity"><span class="toc-number"></span> <span class="toc-text">3.5、ActivityStarter.startActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6%E3%80%81ActivityStarter-startActivityUnchecked"><span class="toc-number"></span> <span class="toc-text">3.6、ActivityStarter.startActivityUnchecked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1%E3%80%81ActivityStarter-setTaskFromReuseOrCreateNewTask-%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84Task-AMS%E7%AB%AF"><span class="toc-number"></span> <span class="toc-text">3.6.1、ActivityStarter.setTaskFromReuseOrCreateNewTask()-创建新的Task[AMS端]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1-1%E3%80%81TaskRecord%E5%88%9B%E5%BB%BAcreateTaskRecord"><span class="toc-number"></span> <span class="toc-text">3.6.1.1、TaskRecord创建createTaskRecord()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1-1-1%E3%80%81TaskRecord-create"><span class="toc-number"></span> <span class="toc-text">3.6.1.1.1、TaskRecord.create()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1-1-2%E3%80%81%E5%B0%86TaskRecord%E5%8A%A0%E5%85%A5%E5%88%B0ActivityStack%E4%B8%AD"><span class="toc-number"></span> <span class="toc-text">3.6.1.1.2、将TaskRecord加入到ActivityStack中</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1-1-3%E3%80%81TaskRecord-createTask-WMS%E7%AB%AF%E7%9A%84Task"><span class="toc-number"></span> <span class="toc-text">3.6.1.1.3、TaskRecord..createTask()[WMS端的Task]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-1-1-4%E3%80%81%E5%B0%86Task-WMS-%E5%8A%A0%E5%85%A5%E5%88%B0TaskStack"><span class="toc-number"></span> <span class="toc-text">3.6.1.1.4、将Task[WMS]加入到TaskStack</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-2%E3%80%81ActivityStack-startActivityLocked"><span class="toc-number"></span> <span class="toc-text">3.6.2、ActivityStack.startActivityLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-3%E3%80%81ActivityStack-ensureActivitiesVisibleLocked"><span class="toc-number"></span> <span class="toc-text">3.6.3、ActivityStack.ensureActivitiesVisibleLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-3-1%E3%80%81ActivityStack-makeVisibleAndRestartIfNeeded"><span class="toc-number"></span> <span class="toc-text">3.6.3.1、ActivityStack.makeVisibleAndRestartIfNeeded()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-4%E3%80%81StackSupervisor-startSpecificActivityLocked"><span class="toc-number"></span> <span class="toc-text">3.6.4、StackSupervisor.startSpecificActivityLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6-5%E3%80%81StackSupervisor-startSpecificActivityLocked"><span class="toc-number"></span> <span class="toc-text">3.6.5、StackSupervisor.startSpecificActivityLocked()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7%E3%80%81Activity%E6%89%80%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96-ActivityThread-main"><span class="toc-number"></span> <span class="toc-text">3.7、Activity所在应用主线程初始化 ActivityThread.main()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-1%E3%80%81ActivityManagerService-attachApplication"><span class="toc-number"></span> <span class="toc-text">3.7.1、ActivityManagerService.attachApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-2%E3%80%81ActivityTaskManagerService-LocalService-attachApplication"><span class="toc-number"></span> <span class="toc-text">3.7.2、ActivityTaskManagerService$LocalService.attachApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-3%E3%80%81RootActivityContainer-attachApplication"><span class="toc-number"></span> <span class="toc-text">3.7.3、RootActivityContainer.attachApplication()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-4%E3%80%81ActivityStackSupervisor-realStartActivityLocked"><span class="toc-number"></span> <span class="toc-text">3.7.4、ActivityStackSupervisor.realStartActivityLocked()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-5%E3%80%81LaunchActivityItem-obtain"><span class="toc-number"></span> <span class="toc-text">3.7.5、LaunchActivityItem.obtain()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-7-6%E3%80%81ActivityStack-minimalResumeActivityLocked-r"><span class="toc-number"></span> <span class="toc-text">3.7.6、ActivityStack.minimalResumeActivityLocked(r)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%89%A7%E8%A1%8C%E5%90%AF%E5%8A%A8Acitivity"><span class="toc-number"></span> <span class="toc-text">四、执行启动Acitivity</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1%E3%80%81LaunchActivityItem-execute"><span class="toc-number"></span> <span class="toc-text">4.1、LaunchActivityItem.execute()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2%E3%80%81ActivityThread-handleLaunchActivity"><span class="toc-number"></span> <span class="toc-text">4.2、ActivityThread.handleLaunchActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3%E3%80%81ActivityThread-performLaunchActivity"><span class="toc-number"></span> <span class="toc-text">4.3、ActivityThread.performLaunchActivity()</span></a></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>