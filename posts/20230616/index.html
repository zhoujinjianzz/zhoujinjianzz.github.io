<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Linux学习系列0：裸机 | zhoujinjian</title><meta name="keywords" content="Linux"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux学习系列0：裸机">
<meta property="og:url" content="https://zhoujinjian.com/posts/20230616/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.52.jpg">
<meta property="article:published_time" content="2023-06-15T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.972Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.52.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20230616/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.52.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Linux学习系列0：裸机</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-15T16:00:00.000Z" title="发表于 2023-06-16 00:00:00">2023-06-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.972Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。</p>
<p>（==<strong>文章基于 Kernel-4.19</strong>==）&amp;&amp;（==<strong>文章基于 Android 11.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz">【zhoujinjian.com博客原图链接】</a> </p>
<p><a target="_blank" rel="noopener" href="https://shop.allnetchina.cn/collections/frontpage/products/rock-pi-4-model-b-board-only-2-4-5ghz-wlan-bluetooth-5-0">【开发板 RockPi4bPlusV1.6】</a></p>
<p>[【开发板 RockPi4bPlusV1.6 Android 11.0 &amp;&amp; Linux（Kernel 4.19）源码链接】](repo init -u <a target="_blank" rel="noopener" href="https://github.com/radxa/manifests.git">https://github.com/radxa/manifests.git</a> -b Android11_Radxa_rk11.1 -m rockchip-r-release.xml)</p>
<p>正是由于前人（各位大神）的分析和总结，帮助我节约了大量的时间和精力，特别感谢，由于不喜欢图片水印，去除了水印，敬请谅解！！！</p>
<p> <a target="_blank" rel="noopener" href="https://hceng.cn/2018/08/16/RK3399%E2%80%94%E2%80%94%E8%A3%B8%E6%9C%BA%E5%A4%A7%E5%85%A8/">【RK3399—裸机大全】</a>    </p>
<p>以64位的RK3399为例，实现裸机的启动：LED、中断、串口(printf移植)、定时器、ADC、I2C、SPI；  </p>
<h1 id="1-ARMv8基础"><a href="#1-ARMv8基础" class="headerlink" title="1.ARMv8基础"></a>1.ARMv8基础</h1><h2 id="1-1-基本概念"><a href="#1-1-基本概念" class="headerlink" title="1.1 基本概念"></a>1.1 基本概念</h2><p><strong>1.架构和内核型号</strong></p>
<ul>
<li><p><strong>架构(Architecture)</strong>:就是常说的ARMv5(32bits)、ARMv6(32bits)、ARMv7(32bits)、ARMv8(32/64bits)；</p>
</li>
<li><p><strong>内核型号</strong>:就是常说的ARM7、ARM9、Cortex-A系列(Aplication)、Cortex-R系列(Runtime)、Cortex-M系列(MCU)；</p>
</li>
<li><p><strong>举例</strong>:单片机STM32F103C8T6采用Cortex-M3内核，采用ARMv7-M架构；<br>　　　　瑞芯微RK3288采用4个Cortex-A17，采用ARMv7-A架构；<br>　　　　瑞芯微RK3399采用2个Cortex-A72和4个Cortex-A53组成，Cortex-A72和Cortex-A53都是ARMv8-A架构。<br>　　　　高通骁龙845处理器由4个Cortex-A75和4个Cortex-A55组成，Cortex-A75和Cortex-A55都是ARMv8-A架构。</p>
</li>
<li><p><strong>发展迭代</strong>：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/1.jpg"></p>
</li>
</ul>
<p><strong>2.AArch64/AArch32/A64/A32/T32</strong></p>
<table>
<thead>
<tr>
<th>名字</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AArch64</td>
<td>架构</td>
<td>指基于64bits运作的ARMv8架构（通用寄存器X0-X30）</td>
</tr>
<tr>
<td>AArch32</td>
<td>架构</td>
<td>指基于32bits运作的ARMv8架构，并且兼容之前的ARMv7架构（通用寄存器R0-R15）</td>
</tr>
<tr>
<td>A64</td>
<td>指令集</td>
<td>指在AArch64模式下支持的ARM 64bits指令集</td>
</tr>
<tr>
<td>A32</td>
<td>指令集</td>
<td>指ARMv7架构下支持的ARM 32bits指令集，在ARMv8中也有新加入的A32指令集</td>
</tr>
<tr>
<td>T32</td>
<td>指令集</td>
<td>指ARMv7架构下支持的Thumb2 16/32bits指定集，在ARMv8中也有新加入的T32指令集。</td>
</tr>
</tbody></table>
<h2 id="1-2-AArch64-32寄存器"><a href="#1-2-AArch64-32寄存器" class="headerlink" title="1.2 AArch64/32寄存器"></a>1.2 AArch64/32寄存器</h2><table>
<thead>
<tr>
<th>AArch64</th>
<th>Special</th>
<th>Role in the procedure call standard</th>
</tr>
</thead>
<tbody><tr>
<td>x0…x7</td>
<td></td>
<td>Parameter/result registers(参数传入/返回结果）</td>
</tr>
<tr>
<td>x8</td>
<td></td>
<td>Indirect result location register</td>
</tr>
<tr>
<td>x9…x15</td>
<td></td>
<td>Temporary registers(临时寄存器)</td>
</tr>
<tr>
<td>x16</td>
<td>IP0</td>
<td>The first intra-procedure-call scratch register (can be used by call veneers and PLT code); at other times may be used as a temporary register.</td>
</tr>
<tr>
<td>x17</td>
<td>IP1</td>
<td>The second intra-procedure-call temporary register (can be used by call veneers and PLT code); at other times may be used as a temporary register.</td>
</tr>
<tr>
<td>x18</td>
<td></td>
<td>The Platform Register, if needed; otherwise a temporary register.</td>
</tr>
<tr>
<td>x19…x28</td>
<td></td>
<td>Callee-saved registers(由被调用者保存的寄存器)</td>
</tr>
<tr>
<td>x29</td>
<td>FP</td>
<td>The Frame Pointer(栈帧指针)</td>
</tr>
<tr>
<td>x30</td>
<td>LR</td>
<td>The Link Register(链接寄存器)</td>
</tr>
<tr>
<td>SP</td>
<td></td>
<td>The Stack Pointer(栈指针)</td>
</tr>
<tr>
<td>AArch32</td>
<td>Special</td>
<td>Role in the procedure call standard</td>
</tr>
<tr>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>r0…r3</td>
<td></td>
<td>Parameter/result registers</td>
</tr>
<tr>
<td>r4…r11</td>
<td></td>
<td>Temporary registers (r9 also as platform register)</td>
</tr>
<tr>
<td>r12</td>
<td>IP</td>
<td>The Intra-Procedure-call scratch register.</td>
</tr>
<tr>
<td>r13</td>
<td>SP</td>
<td>The second intra-procedure-call temporary register (can be used by call veneers and PLT code); at other times may be used as a temporary register.</td>
</tr>
<tr>
<td>r14</td>
<td>LR</td>
<td>The Platform Register, if needed; otherwise a temporary register.</td>
</tr>
<tr>
<td>r15</td>
<td>PC</td>
<td>Callee-saved registers</td>
</tr>
</tbody></table>
<p>两者区别：</p>
<table>
<thead>
<tr>
<th>Execution State</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>AArch64</td>
<td>1. 提供31个64bits的通用寄存器(x0~x30，其中x30可作为LR)</td>
</tr>
<tr>
<td></td>
<td>2. 提供64bits程序计数器(PC)、栈指针(SP)、异常链接寄存器(ELR)</td>
</tr>
<tr>
<td></td>
<td>3. 提供32个128bits 的SIMD Vector与Scalar Floating-Point寄存器</td>
</tr>
<tr>
<td></td>
<td>4. 定义ARMv8 EL0~EL3共4个执行权限(Execution Privilege)</td>
</tr>
<tr>
<td></td>
<td>5. 支持64bits Virtual-Addressing</td>
</tr>
<tr>
<td></td>
<td>6. 定义一组PSTATE用以保存PE(Processing Element)状态</td>
</tr>
<tr>
<td>AArch32</td>
<td>1. 提供16个32bits的通用寄存器(r0~r12，其中r13=SP、r14=LR、r15=PC，且r14需要同时供ELR与LR之用）</td>
</tr>
<tr>
<td></td>
<td>2. 提供一个ELR，用以作为从Hyp-Mode的Exception返回之用</td>
</tr>
<tr>
<td></td>
<td>3. 提供32个64bits的Advanced SIMD Vector与Scalar Floating-Point寄存器</td>
</tr>
<tr>
<td></td>
<td>4. 提供A32与T32两种指令集的组合</td>
</tr>
<tr>
<td></td>
<td>5. 使用32bits Virtual-Addressing</td>
</tr>
<tr>
<td></td>
<td>6. 只使用CPSR(当前程序状态寄存器)保存PE(Processing Element)状态。</td>
</tr>
</tbody></table>
<h2 id="1-3-ARMv8-Exception-Level"><a href="#1-3-ARMv8-Exception-Level" class="headerlink" title="1.3 ARMv8 Exception Level"></a>1.3 ARMv8 Exception Level</h2><p>针对Security的需求，ARMv8的系统软件设计可以提供安全模式与非安全模式的状态。<br>ARMv8规定了CPU有4种运行级别。每种运行级别下标的数字越大，其权力级别越高。其中EL0为非特权等级，即平时应用程序运行时的级别；EL1为特权等级，即操作系统运行时的级别；EL2为虚拟机监视器运行级别，即虚拟机的控制层运行的级别；EL3为切换EL1和EL2级别时需要进入的一个级别，为CPU的最高级别。</p>
<p>若底层EL(Exception Level)为32bits，则上层EL的软件就只能是32位。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/2-16297118529022.png"></p>
<p>若底层的EL为64bits，则上层EL就可以依据需求选择为32bits或是64bits。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/3-16297118317991.png"></p>
<h1 id="2-RK3399启动"><a href="#2-RK3399启动" class="headerlink" title="2.RK3399启动"></a>2.RK3399启动</h1><p>先看一下RK3399的启动流程图[1]：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/4.png"></p>
<p>从图中可以得到以下几个结论：</p>
<ul>
<li>1.RK3399上电后，会从<code>0xffff0000</code>获取<code>romcode</code>并运行；</li>
<li>2.然后依次从Nor Flash、Nand Flash、eMMC、SD/MMC获取<code>ID BLOCK</code>，<code>ID BLOCK</code>正确则启动，都不正确则从USB端口下载；</li>
<li>3.如果emmc启动，则先读取SDRAM(DDR)初始化代码到内部SRAM，然后初始化DDR，再将emmc上的代码(剩下的用户代码)复制到DDR运行；</li>
<li>4.如果从USB下载，则先获取DDR初始化代码，下载到内部SRAM中，然后运行代码初始化DDR，再获取loader代码(用户代码)，放到DDR中并运行；</li>
<li>5.无论是何种方式，都需要DDR的初始化代码。</li>
</ul>
<h2 id="2-1-官方启动分析"><a href="#2-1-官方启动分析" class="headerlink" title="2.1 官方启动分析"></a>2.1 官方启动分析</h2><p>如何分析一款芯片的启动方式?大致就是先用厂家提供的资料，配置相关环境、编译、烧写，运行起来。然后就有了U-boot源码，从U-boot就可以几乎提取出所有的裸机代码，本文也是这样做的。</p>
<p>分析U-Boot的编译流程，可以看到如下内容：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">load addr is <span class="number">0x200000</span>!</span><br><span class="line">pack input u-boot.bin </span><br><span class="line">pack file size: <span class="number">1034744</span>(<span class="number">1010</span> KB)</span><br><span class="line">crc = <span class="number">0x2434c863</span></span><br><span class="line">uboot version: U-Boot <span class="number">2017.09</span>-g745ea52 #xwj (Aug <span class="number">03</span> <span class="number">2021</span> - <span class="number">12</span>:<span class="number">20</span>:<span class="number">53</span>)</span><br><span class="line">pack uboot.img success! </span><br><span class="line">pack uboot okay! Input: u-boot.bin</span><br><span class="line"></span><br><span class="line">out:trust.img</span><br><span class="line">merge success(trust.img)</span><br><span class="line">pack trust okay! Input: /home/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/rkbin/RKTRUST/RK3399TRUST.ini</span><br><span class="line"></span><br><span class="line">/home/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/u-boot</span><br><span class="line">out:rk3399_loader_v1<span class="number">.20</span><span class="number">.126</span>.bin</span><br><span class="line">fix opt:rk3399_loader_v1<span class="number">.20</span><span class="number">.126</span>.bin</span><br><span class="line">merge success(rk3399_loader_v1<span class="number">.20</span><span class="number">.126</span>.bin)</span><br><span class="line">pack loader okay! Input: /home/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/rkbin/RKBOOT/RK3399MINIALL.ini</span><br><span class="line">/home/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/u-boot</span><br><span class="line">Image Type:   Rockchip RK33 (SD/MMC) boot image</span><br><span class="line">Init Data Size: <span class="number">73728</span> bytes</span><br><span class="line">Boot Data Size: <span class="number">86016</span> bytes</span><br><span class="line">Input:</span><br><span class="line">    /home/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/rkbin/RKBOOT/RK3399MINIALL.ini</span><br><span class="line">    /home/xwj/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/rkbin/bin/rk33/rk3399_ddr_800MHz_v1<span class="number">.20</span>.bin</span><br><span class="line">    /home/zhoujinjian/Rock4Plus_Android10/Sync_Rock_PI4_Plus_Android10/rkbin/bin/rk33/rk3399_miniloader_v1<span class="number">.26</span>.bin</span><br><span class="line"></span><br><span class="line">Pack rk3399 idbloader.img okay!</span><br></pre></td></tr></table></figure>

<p>可以看出这里使用了三个工具，产生了三个文件：<br>①:使用<code>boot_merger</code>，参数为<code>RK3399MINIALL.ini</code>，得到loader文件<code>rk3399_loader_v1.20.126.bin</code>，打开<code>RK3399MINIALL.ini</code>内容为：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[CHIP_NAME]</span><br><span class="line">NAME=RK330C</span><br><span class="line">[VERSION]</span><br><span class="line">MAJOR=<span class="number">1</span></span><br><span class="line">MINOR=<span class="number">26</span></span><br><span class="line">[CODE471_OPTION]</span><br><span class="line">NUM=<span class="number">1</span></span><br><span class="line">Path1=bin/rk33/rk3399_ddr_800MHz_v1<span class="number">.20</span>.bin</span><br><span class="line">Sleep=<span class="number">1</span></span><br><span class="line">[CODE472_OPTION]</span><br><span class="line">NUM=<span class="number">1</span></span><br><span class="line">Path1=bin/rk33/rk3399_usbplug_v1<span class="number">.26</span>.bin</span><br><span class="line">[LOADER_OPTION]</span><br><span class="line">NUM=<span class="number">2</span></span><br><span class="line">LOADER1=FlashData</span><br><span class="line">LOADER2=FlashBoot</span><br><span class="line">FlashData=bin/rk33/rk3399_ddr_800MHz_v1<span class="number">.20</span>.bin</span><br><span class="line">FlashBoot=bin/rk33/rk3399_miniloader_v1<span class="number">.26</span>.bin</span><br><span class="line">[OUTPUT]</span><br><span class="line">PATH=rk3399_loader_v1<span class="number">.20</span><span class="number">.126</span>.bin</span><br></pre></td></tr></table></figure>

<p>得知依赖的文件有:DDR相关的<code>rk3399_ddr_800MHz_v1.20.bin</code>、、USB相关的<code>rk3399_usbplug_v1.26.bin</code>、miniloader(瑞芯微修改的一个bootloader)相关的<code>rk3399_miniloader_v1.26.bin</code>。<br><code>boot_merger</code>将这三个bin文件最后合并成rk3399_loader_v1.20.126.bin。</p>
<p>②:使用<code>trust_merger</code>，参数为<code>RK3399TRUST.ini</code>，生成<code>trust.img</code>；</p>
<p>③:使用<code>loaderimage</code>将<code>u-boot.bin</code>变成<code>uboot.img</code>；</p>
<h2 id="2-2-制作裸机启动文件"><a href="#2-2-制作裸机启动文件" class="headerlink" title="2.2 制作裸机启动文件"></a>2.2 制作裸机启动文件</h2><p>经过分析和测试，现实现了emmc裸机程序，并把整个过程整理了一个工程模板。<br>工程模板见<a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz/u_boot_demo">GitHub</a>，替换官方u-boot，然后编译update.img</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"># u_boot_demo <span class="keyword">for</span> rockpi4b_plus_v1<span class="number">.6</span></span><br><span class="line"></span><br><span class="line"># <span class="number">0</span>、Env(NO) &amp;&amp; Download Source Code</span><br><span class="line"></span><br><span class="line">$ curl https:<span class="comment">//storage.googleapis.com/git-repo-downloads/repo-1 &gt; ~/bin/repo</span></span><br><span class="line"></span><br><span class="line">$ chmod a+x ~/bin/repo</span><br><span class="line"></span><br><span class="line">$ python3 ~/bin/repo init -u https:<span class="comment">//github.com/radxa/manifests.git -b rockchip-android-10 -m rockchip-q-release.xml</span></span><br><span class="line"></span><br><span class="line">$ cd u-boot </span><br><span class="line"></span><br><span class="line">$ rm -rf *</span><br><span class="line"></span><br><span class="line">$ cp u-boot-xxx-ok<span class="comment">/* to u-boot </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 1、ROCKPI 4A/B（编译u-boot）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ cd u-boot</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ ./make.sh rockpi4b</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ cd -</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 2、ROCKPI 4A/B（编译kernel）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ cd kernel</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ make ARCH=arm64 rockchip_defconfig android-10.config rockpi_4b.config</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ make ARCH=arm64 rk3399-rockpi-4b.img -j8</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ cd -</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 3、ROCKPI 4A/B（编译Android）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ source build/envsetup.sh</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ lunch RockPi4B-userdebug</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ make -j8</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 4、ROCKPI 4A/B（mkimage）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ ln -s RKTools/linux/Linux_Pack_Firmware/rockdev/ rockdev</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ ./mkimage.sh</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 5、ROCKPI 4A/B（编译update.img）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ cd rockdev</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ ln -s Image-RockPi4B Image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$ ./mkupdate_rk3399.sh</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Please burn rockdev/update.img</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">https://wiki.radxa.com/Android/android_tool</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>



<p>烧录update.img（每次都烧录update.img好像有点<del>.</del>） ：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/6.png"></p>
<h1 id="3-Uboot启动部分分析"><a href="#3-Uboot启动部分分析" class="headerlink" title="3.Uboot启动部分分析"></a>3.Uboot启动部分分析</h1><p>为了方便后面从U-boot提取所需裸机代码，有必要先对U-boot进行分析，本节只分析启动部分的，后续具体某个模块，如LED将在后面对应的章节分析。<br>另外，本次分析是的RK3399，64位的ARMv8架构，与市面上较多的32位ARMv7架构SOC略有区别，注意不要混淆。<br>U-boot执行的第一个文件是start.S，下面开始对其进行分析。</p>
<h2 id="3-1-start-S"><a href="#3-1-start-S" class="headerlink" title="3.1 start.S"></a>3.1 start.S</h2><p>所在文件路径：<a target="_blank" rel="noopener" href="https://github.com/radxa/u-boot/blob/stable-4.4-rockpi4/arch/arm/cpu/armv8/start.S"><code>u-boot/arch/arm/cpu/armv8/start.S</code></a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Startup Code (reset vector)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line"></span><br><span class="line">.globl    _start</span><br><span class="line">_start:</span><br><span class="line">    b    reset</span><br><span class="line">    .align <span class="number">3</span></span><br><span class="line">......</span><br><span class="line">reset:</span><br><span class="line">    <span class="comment">/* Allow the board to save important registers */</span></span><br><span class="line">    b    save_boot_params</span><br><span class="line">.globl    save_boot_params_ret</span><br><span class="line">save_boot_params_ret:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Could be EL3/EL2/EL1, Initial State:</span></span><br><span class="line"><span class="comment">     * Little Endian, MMU Disabled, i/dCache Disabled</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    adr    x0, vectors</span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    msr    vbar_el3, x0</span><br><span class="line">    mrs    x0, scr_el3</span><br><span class="line">    orr    x0, x0, #<span class="number">0xf</span>            <span class="comment">/* SCR_EL3.NS|IRQ|FIQ|EA */</span></span><br><span class="line">    msr    scr_el3, x0</span><br><span class="line">    msr    cptr_el3, xzr            <span class="comment">/* Enable FP/SIMD */</span></span><br><span class="line">    <span class="comment">/* COUNTER_FREQUENCY 24000000 \u-boot\include\configs\rockchip-common.h */</span></span><br><span class="line">    ldr    x0, =<span class="number">24000000</span></span><br><span class="line">    msr    cntfrq_el0, x0            <span class="comment">/* Initialize CNTFRQ */</span></span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    msr    vbar_el2, x0</span><br><span class="line">    mov    x0, #<span class="number">0x33ff</span></span><br><span class="line">    msr    cptr_el2, x0            <span class="comment">/* Enable FP/SIMD */</span></span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    msr    vbar_el1, x0</span><br><span class="line">    mov    x0, #<span class="number">3</span> &lt;&lt; <span class="number">20</span></span><br><span class="line">    msr    cpacr_el1, x0            <span class="comment">/* Enable FP/SIMD */</span></span><br><span class="line"><span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Enable SMPEN bit for coherency.</span></span><br><span class="line"><span class="comment">     * This register is not architectural but at the moment</span></span><br><span class="line"><span class="comment">     * this bit should be set for A53/A57/A72.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">1f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:</span><br><span class="line">    mrs     x0, S3_1_c15_c2_1               <span class="comment">/* cpuectlr_el1 */</span></span><br><span class="line">    orr     x0, x0, #<span class="number">0x40</span></span><br><span class="line">    msr     S3_1_c15_c2_1, x0</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Apply ARM core specific erratas */</span></span><br><span class="line">    bl    apply_core_errata</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Cache/BPB/TLB Invalidate</span></span><br><span class="line"><span class="comment">     * i-cache is invalidated before enabled in icache_enable()</span></span><br><span class="line"><span class="comment">     * tlb is invalidated before mmu is enabled in dcache_enable()</span></span><br><span class="line"><span class="comment">     * d-cache is invalidated before enabled in dcache_enable()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Processor specific initialization */</span></span><br><span class="line">    bl    lowlevel_init </span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>1.设置中断向量等 [important]</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\cpu\armv8\exceptions.S*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Exception vectors.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    .align    <span class="number">11</span></span><br><span class="line">    .globl    vectors</span><br><span class="line">vectors:</span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL Synchronous Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_sync*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL IRQ Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_irq*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL FIQ Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_fiq*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL Error Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_error*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL Synchronous Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_sync*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL IRQ Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">//bl    do_irq</span></span><br><span class="line">    <span class="comment">//bl    board_init_f_init_reserve</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL FIQ Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_fiq*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL Error Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_error*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Enter Exception.</span></span><br><span class="line"><span class="comment"> * This will save the processor state that is ELR/X0~X30</span></span><br><span class="line"><span class="comment"> * to the stack frame.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">_exception_entry:</span><br><span class="line">    stp    x27, x28, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x25, x26, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x23, x24, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x21, x22, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x19, x20, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x17, x18, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x15, x16, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x13, x14, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x11, x12, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x9, x10, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x7, x8, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x5, x6, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x3, x4, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x1, x2, [sp, #<span class="number">-16</span>]!</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Could be running at EL3/EL2/EL1 */</span></span><br><span class="line">    switch_el x11, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    mrs    x1, esr_el3</span><br><span class="line">    mrs    x2, elr_el3</span><br><span class="line">    mrs    x3, daif</span><br><span class="line">    mrs    x4, vbar_el3</span><br><span class="line">    mrs    x5, spsr_el3</span><br><span class="line">    sub    x6, sp, #(<span class="number">8</span>*<span class="number">30</span>)</span><br><span class="line">    mrs    x7, sctlr_el3</span><br><span class="line">    mrs    x8, scr_el3</span><br><span class="line">    mrs    x9, ttbr0_el3</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    mrs    x1, esr_el2</span><br><span class="line">    mrs    x2, elr_el2</span><br><span class="line">    mrs    x3, daif</span><br><span class="line">    mrs    x4, vbar_el2</span><br><span class="line">    mrs    x5, spsr_el2</span><br><span class="line">    sub    x6, sp, #(<span class="number">8</span>*<span class="number">30</span>)</span><br><span class="line">    mrs    x7, sctlr_el2</span><br><span class="line">    mrs    x8, hcr_el2</span><br><span class="line">    mrs    x9, ttbr0_el2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>:    mrs    x1, esr_el1</span><br><span class="line">    mrs    x2, elr_el1</span><br><span class="line">    mrs    x3, daif</span><br><span class="line">    mrs    x4, vbar_el1</span><br><span class="line">    mrs    x5, spsr_el1</span><br><span class="line">    sub    x6, sp, #(<span class="number">8</span>*<span class="number">30</span>)</span><br><span class="line">    mrs    x7, sctlr_el1</span><br><span class="line">    mov    x8, #<span class="number">0</span></span><br><span class="line">    mrs    x9, ttbr0_el1</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line">    stp     x2, x0, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x3, x1, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x5, x4, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x7, x6, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x9, x8, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    mov    x0, sp</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exception_exit:</span><br><span class="line">    add    sp, sp, #(<span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">    ldp    x2, x0, [sp],#<span class="number">16</span></span><br><span class="line">    switch_el x11, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    msr    elr_el3, x2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    msr    elr_el2, x2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    msr    elr_el1, x2</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line">    ldp    x1, x2, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x3, x4, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x5, x6, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x7, x8, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x9, x10, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x11, x12, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x13, x14, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x15, x16, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x17, x18, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x19, x20, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x21, x22, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x23, x24, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x25, x26, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x27, x28, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x29, x30, [sp],#<span class="number">16</span></span><br><span class="line">    eret</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：<br>1.<code>switch_el</code>这一宏定义伪指令在<code>u-boot/arch/arm/include/asm/macro.h</code>定义；<br>2.<code>vbar_el3</code>等寄存器定义在文档<code>ARMv8-A_Architecture_Reference_Manual_(Issue_A.a).pdf</code>[2]中；<br>3.<code>XZR/WZR</code>(word zero rigiser)分别代表64/32位，<code>zero register</code>的作用就是0，写进去代表丢弃结果，拿出来是0；</p>
</blockquote>
</li>
</ul>
<p>中断向量的定义在文件<code>u-boot/arch/arm/cpu/armv8/exceptions.S</code>中。</p>
<p>这一部分功能就是根据当前的EL级别，配置中断向量、MMU、Endian、i/d Cache等，比较重要。</p>
<ul>
<li><p><strong>2.配置ARM核心特定勘误表 [unimportant]</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Apply ARM core specific erratas */</span></span><br><span class="line">bl    apply_core_errata</span><br></pre></td></tr></table></figure>

<p>看样子是对ARM做一些勘误，实测没有用到，不重要。</p>
</li>
<li><p><strong>3.lowlevel_init [important]</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Processor specific initialization */</span></span><br><span class="line">    bl    lowlevel_init</span><br><span class="line"></span><br><span class="line">    ……</span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">WEAK(lowlevel_init)</span><br><span class="line">    mov    x29, lr            <span class="comment">/* Save LR */</span></span><br><span class="line">     branch_if_slave x0, <span class="number">1f</span></span><br><span class="line">    ldr    x0, =GICD_BASE</span><br><span class="line">    bl    gic_init_secure</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">     ldr    x0, =GICR_BASE</span><br><span class="line">    bl    gic_init_secure_percpu</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Setting HCR_EL2.TGE AMO IMO FMO for exception rounting to EL2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mrs    x0, CurrentEL        <span class="comment">/* check currentEL */</span></span><br><span class="line">    cmp    x0, <span class="number">0x8</span></span><br><span class="line">    b.ne    end            <span class="comment">/* currentEL != EL2 */</span></span><br><span class="line"></span><br><span class="line">    mrs    x9, hcr_el2</span><br><span class="line">    orr    x9, x9, #(<span class="number">7</span> &lt;&lt; <span class="number">3</span>)    <span class="comment">/* HCR_EL2.AMO IMO FMO set */</span></span><br><span class="line">    orr    x9, x9, #(<span class="number">1</span> &lt;&lt; <span class="number">27</span>)    <span class="comment">/* HCR_EL2.TGE set */</span></span><br><span class="line">    msr    hcr_el2, x9</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">    nop</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>:</span><br><span class="line">    mov    lr, x29            <span class="comment">/* Restore LR */</span></span><br><span class="line">    ret</span><br><span class="line">ENDPROC(lowlevel_init)</span><br></pre></td></tr></table></figure>


</li>
</ul>
<blockquote>
<p>注：<br>1.<code>branch_if_slave</code>在<code>u-boot/arch/arm/include/asm/macro.h</code>定义；<br>2.<code>gic_init_secure</code>和<code>gic_init_secure_percpu</code>这两个中断初始化的关键函数在<code>u-boot/arch/arm/lib/gic_64.S</code>定义；  </p>
</blockquote>
<p><code>lowlevel_init</code>的主要功能就是中断的初始化，后面写中断服务程序的使用会用到。</p>
<ul>
<li><strong>4.跳转到_main [important]</strong><br>到此<code>start.S</code>的工作就基本完成了，接下来就交给ARM公共的<code>_main</code>。</li>
</ul>
<h2 id="3-2-crt0-64-S"><a href="#3-2-crt0-64-S" class="headerlink" title="3.2 crt0_64.S"></a>3.2 crt0_64.S</h2><p>所在文件路径：<a target="_blank" rel="noopener" href="https://github.com/radxa/u-boot/blob/stable-4.4-rockpi4/arch/arm/lib/crt0_64.S"><code>u-boot/arch/arm/cpu/armv8/start.S</code></a><br><code>_main</code>在<code>crt0_64.S</code>里，<code>crt0</code>是<code>C-runtime Startup Code</code>的简称，意思就是运行C代码之前的准备工作，包括设置栈、重定位、清理BSS段等；</p>
<ul>
<li><p><strong>1.设置栈 [important]</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">    ENTRY(_main)</span><br><span class="line">        .equ SCTLR_A_BIT,        (<span class="number">1</span> &lt;&lt; <span class="number">1</span>)</span><br><span class="line">        .equ SCTLR_SA_BIT,        (<span class="number">1</span> &lt;&lt; <span class="number">3</span>)</span><br><span class="line">        .equ SCTLR_I_BIT,        (<span class="number">1</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Set up initial C runtime environment and call board_init_f(0).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">        ldr    x0, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line">        bic    sp, x0, #<span class="number">0xf</span>    <span class="comment">/* 16-byte alignment for ABI compliance */</span></span><br><span class="line">        <span class="comment">//mov    x0, sp</span></span><br><span class="line">        <span class="comment">//bl    board_init_f_alloc_reserve</span></span><br><span class="line">        <span class="comment">//mov    sp, x0</span></span><br><span class="line">        <span class="comment">/* set up gd here, outside any C code */</span></span><br><span class="line">        <span class="comment">//mov    x18, x0</span></span><br><span class="line">        <span class="comment">//bl    board_init_f_init_reserve</span></span><br><span class="line">        <span class="comment">//bl    board_init_f_init_serial</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">//mov    x0, #0</span></span><br><span class="line">        bl    main <span class="comment">//bl board_init_f</span></span><br><span class="line"></span><br><span class="line">这里栈需要<span class="number">16</span>字节对齐，即要求地址为<span class="number">16</span>的倍数，只需要二进制位最后四位为<span class="number">0</span>(<span class="number">2</span>的<span class="number">4</span>次方)，与前面中断向量地址需要<span class="number">2</span>K对齐，实现原理类似。  另外U-Boot在SP上面分配了一块GD(global data)，后面写裸机用不到。</span><br><span class="line"></span><br><span class="line">*   **<span class="number">2.b</span>oard\_init\_f \[important\]**</span><br><span class="line">    </span><br><span class="line">    ```plain</span><br><span class="line">    mov    x0, #<span class="number">0</span>          <span class="comment">//将0作为参数传入board_init_f</span></span><br><span class="line">    bl    board_init_f</span><br></pre></td></tr></table></figure>

<p><code>board_init_f</code>所在文件路径：<a target="_blank" rel="noopener" href="https://github.com/radxa/u-boot/blob/stable-4.4-rockpi4/common/board_f.c"><code>u-boot/common/board_f.c</code></a>。<br><code>board_init_f</code>中调用<code>initcall_run_list(init_sequence_f)</code>，<code>init_sequence_f</code>是个数组，里面是将要进行初始化的函数列表，完成一些前期的初始化工作，比如board相关的early的初始化<code>board_early_init_f</code>、环境变量初始化<code>env_init</code>、串口初始化的<code>serial_init</code>、I2C初始化<code>init_func_i2c</code>、设备树相关准备工作<code>fdtdec_prepare_fdt</code>、打印CPU信息<code>print_cpuinfo</code>、SDRAM初始化<code>dram_init</code>、计算重定位信息<code>setup_reloc</code>等；</p>
</li>
<li><p><strong>3.重定位 [important]</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\lib\relocate_64.S*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> R_AARCH64_RELATIVE    1027</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * void relocate_code (addr_moni)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function relocates the monitor code.</span></span><br><span class="line"><span class="comment"> * x0 holds the destination address.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ENTRY(relocate_code)</span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-32</span>]!    <span class="comment">/* create a stack frame */</span></span><br><span class="line">    mov    x29, sp</span><br><span class="line">    str    x0, [sp, #<span class="number">16</span>]</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Copy u-boot from flash to RAM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    adr    x1, __image_copy_start    <span class="comment">/* x1 &lt;- Run &amp;__image_copy_start */</span></span><br><span class="line">    subs    x9, x0, x1        <span class="comment">/* x8 &lt;- Run to copy offset */</span></span><br><span class="line">    b.eq    relocate_done        <span class="comment">/* skip relocation */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Dont ldr x1, __image_copy_start here, since if the code is already</span></span><br><span class="line"><span class="comment">     * running at an address other than it was linked to, that instruction</span></span><br><span class="line"><span class="comment">     * will load the relocated value of __image_copy_start. To</span></span><br><span class="line"><span class="comment">     * correctly apply relocations, we need to know the linked value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Linked &amp;__image_copy_start, which we know was at</span></span><br><span class="line"><span class="comment">     * CONFIG_SYS_TEXT_BASE, which is stored in _TEXT_BASE, as a non-</span></span><br><span class="line"><span class="comment">     * relocated value, since it isnt a symbol reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ldr    x1, _TEXT_BASE        <span class="comment">/* x1 &lt;- Linked &amp;__image_copy_start */</span></span><br><span class="line">    subs    x9, x0, x1        <span class="comment">/* x9 &lt;- Link to copy offset */</span></span><br><span class="line"></span><br><span class="line">    adr    x1, __image_copy_start    <span class="comment">/* x1 &lt;- Run &amp;__image_copy_start */</span></span><br><span class="line">    adr    x2, __image_copy_end    <span class="comment">/* x2 &lt;- Run &amp;__image_copy_end */</span></span><br><span class="line">copy_loop:</span><br><span class="line">    ldp    x10, x11, [x1], #<span class="number">16</span>    <span class="comment">/* copy from source address [x1] */</span></span><br><span class="line">    stp    x10, x11, [x0], #<span class="number">16</span>    <span class="comment">/* copy to   target address [x0] */</span></span><br><span class="line">    cmp    x1, x2            <span class="comment">/* until source end address [x2] */</span></span><br><span class="line">    b.lo    copy_loop</span><br><span class="line">    str    x0, [sp, #<span class="number">24</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Fix .rela.dyn relocations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    adr    x2, __rel_dyn_start    <span class="comment">/* x2 &lt;- Run &amp;__rel_dyn_start */</span></span><br><span class="line">    adr    x3, __rel_dyn_end    <span class="comment">/* x3 &lt;- Run &amp;__rel_dyn_end */</span></span><br><span class="line">fixloop:</span><br><span class="line">    ldp    x0, x1, [x2], #<span class="number">16</span>    <span class="comment">/* (x0,x1) &lt;- (SRC location, fixup) */</span></span><br><span class="line">    ldr    x4, [x2], #<span class="number">8</span>        <span class="comment">/* x4 &lt;- addend */</span></span><br><span class="line">    <span class="keyword">and</span>    x1, x1, #<span class="number">0xffffffff</span></span><br><span class="line">    cmp    x1, #R_AARCH64_RELATIVE</span><br><span class="line">    bne    fixnext</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* relative fix: store addend plus offset at dest location */</span></span><br><span class="line">    add    x0, x0, x9</span><br><span class="line">    add    x4, x4, x9</span><br><span class="line">    str    x4, [x0]</span><br><span class="line">fixnext:</span><br><span class="line">    cmp    x2, x3</span><br><span class="line">    b.lo    fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line">    bl    hang</span><br><span class="line"><span class="number">3</span>:    mrs    x0, sctlr_el3</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    mrs    x0, sctlr_el2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    mrs    x0, sctlr_el1</span><br><span class="line"><span class="number">0</span>:    tbz    w0, #<span class="number">2</span>, <span class="number">5f</span>    <span class="comment">/* skip flushing cache if disabled */</span></span><br><span class="line">    tbz    w0, #<span class="number">12</span>, <span class="number">4f</span>    <span class="comment">/* skip invalidating i-cache if disabled */</span></span><br><span class="line">    ic    iallu        <span class="comment">/* i-cache invalidate all */</span></span><br><span class="line">    isb    sy</span><br><span class="line"><span class="number">4</span>:    ldp    x0, x1, [sp, #<span class="number">16</span>]</span><br><span class="line">    bl    __asm_flush_dcache_range</span><br><span class="line"><span class="number">5</span>:    ldp    x29, x30, [sp],#<span class="number">32</span></span><br><span class="line">    ret</span><br><span class="line">ENDPROC(relocate_code)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先是更新了gd结构体，然后根据宏<code>CONFIG_SKIP_RELOCATE_UBOOT</code>决定是否要重定位。<br>这里是不需要重定位的，因为链接脚本<a target="_blank" rel="noopener" href="https://github.com/radxa/u-boot/blob/stable-4.4-rockpi4/arch/arm/cpu/armv8/u-boot.lds"><code>u-boot.lds</code></a>里面的链接地址是<code>0x00000000</code>，而RK3399上电后，加头的<code>boot code</code>会自动将代码复制到DDR(0x00000000)，两者地址相同，不需要重定位。<br>重定位的代码在<code>u-boot/arch/arm/lib/relocate_64.S</code>里面。</p>
</li>
<li><p><strong>4.重新设置异常向量表 [important]</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up final (full) environment</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    bl    c_runtime_cpu_setup        <span class="comment">/* still call old routine */</span></span><br></pre></td></tr></table></figure>

<p>如果发生了重定位，需要重新设置异常向量表。<code>c_runtime_cpu_setup</code>定义在<code>start.S</code>里面。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(c_runtime_cpu_setup)</span><br><span class="line">    <span class="comment">/* Relocate vBAR */</span></span><br><span class="line">    adr    x0, vectors</span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    msr    vbar_el3, x0</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    msr    vbar_el2, x0</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    msr    vbar_el1, x0</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">ENDPROC(c_runtime_cpu_setup)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>5.清理BSS段 [important]</strong><br>接下来就是清除BSS段，将未定义的全局变量设置为0。在以前使用Keil单片机编程时，未初始化的全局变量默认为0，那是因为集成开发环境为我们做了清理BSS段的操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Clear BSS section</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        ldr    x0, =__bss_start        <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">        ldr    x1, =__bss_end            <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">    clear_loop:</span><br><span class="line">        str    xzr, [x0], #<span class="number">8</span></span><br><span class="line">        cmp    x0, x1</span><br><span class="line">        b.lo    clear_loop</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/* call board_init_r(gd_t *id, ulong dest_addr) */</span></span><br><span class="line">        <span class="comment">//mov    x0, x18                /* gd_t */</span></span><br><span class="line">        <span class="comment">//ldr    x1, [x18, #GD_RELOCADDR]    /* dest_addr */</span></span><br><span class="line">        <span class="comment">//b    board_init_r            /* PC relative jump */</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/* NOTREACHED - board_init_r() does not return */</span></span><br><span class="line">    </span><br><span class="line">*   **<span class="number">6.b</span>oard\_init\_r \[important\]**  </span><br><span class="line">    接下来就是板子的后半部分的初始化：</span><br><span class="line">    </span><br><span class="line">    ```c</span><br><span class="line">        <span class="comment">/* call board_init_r(gd_t *id, ulong dest_addr) */</span></span><br><span class="line">        <span class="comment">//mov    x0, x18                /* gd_t */</span></span><br><span class="line">        <span class="comment">//ldr    x1, [x18, #GD_RELOCADDR]    /* dest_addr */</span></span><br><span class="line">        <span class="comment">//b    board_init_r            /* PC relative jump */</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/* NOTREACHED - board_init_r() does not return */</span></span><br><span class="line"></span><br><span class="line">`crt0_64.S`主要就是为C语言运行设置栈和进行了重定位，以及两个阶段的初始化:`board_init_f`(front)和`board_init_r`(rear)，最后进入主循环。</span><br><span class="line"></span><br><span class="line">- `board_init_r`所在文件路径：[`u-boot/common/board_f.c`](https:<span class="comment">//github.com/radxa/u-boot/blob/stable-4.4-rockpi4/common/board_r.c)。</span></span><br><span class="line">  与前面的`board_init_f`类似，`board_init_r`中调用`initcall_run_list(init_sequence_r)`，`init_sequence_r`是个数组，里面是将要进行初始化的函数列表，又是一系列的初始化操作。之前遇到的LCD初始化就是在这里。</span><br><span class="line">  初始化数组列表最后一个成员是`run_main_loop`，将最终跳到主循环[`main_loop`](https:<span class="comment">//github.com/radxa/u-boot/blob/stable-4.4-rockpi4/common/main.c)。</span></span><br><span class="line"></span><br><span class="line">`crt0_64.S`主要就是为C语言运行设置栈和进行了重定位，以及两个阶段的初始化:`board_init_f`(front)和`board_init_r`(rear)，最后进入主循环。</span><br><span class="line"></span><br><span class="line"><span class="number">3.3</span> 总结</span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line">U-Boot启动流程示意图：</span><br><span class="line"></span><br><span class="line">![](https:<span class="comment">//raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/5.png)</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>中断</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line"><span class="number">4.1</span> 分析</span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line">在U-Boot中找到如下几个文件：</span><br><span class="line"></span><br><span class="line">&gt; `u-boot/arch/arm/cpu/armv8/rk33xx/irqs.c`:包含中断的基本操作，如：初始化、注册、使能等；  </span><br><span class="line">&gt; `u-boot/arch/arm/cpu/armv8/rk33xx/irqs-gic.c`:包含非GPIO类型中断的使能、去能；  </span><br><span class="line">&gt; `u-boot/arch/arm/cpu/armv8/rk33xx/irqs-gpio.c`:包含GPIO类型中断的使能、去能、触发类型；  </span><br><span class="line">&gt; `u-boot/board/rockchip/rk33xx/demo.c`:包含一些测试代码，如：定时器中断测试、GPIO中断测试；</span><br><span class="line"></span><br><span class="line">*   `irqs.c`里的函数:  </span><br><span class="line">    首先是**`irq_init()`**里面包含gic中断初始化和gpio中断初始化，函数里注释`gic has been init in Start.S`和之前的猜测一样，在`start.S`里面已经gic初始化了；  </span><br><span class="line">    然后是**`irq_install_handler()`**里面实现了中断的注册，即把对应中断号放在`g_irq_handler[]`数组里；  </span><br><span class="line">    再是**`irq_handler_enable()`**，将对应的中断处理函数使能，具体实现的函数在`irqs-gic.c`和`irqs-gpio.c`里面。此外还有使能总中断`enable_interrupts()`；  </span><br><span class="line">    最后就是**`do_irq()`**中断处理函数。</span><br><span class="line">    </span><br><span class="line">*   `irqs-gic.c`里的函数:  </span><br><span class="line">    包含`gic_handler_enable()`和`gic_handler_disable()`，在前面`irq_handler_enable()`调用；</span><br><span class="line">    </span><br><span class="line">*   `irqs-gpio.c`里的函数:  </span><br><span class="line">    包含`gic_handler_enable()`、`gpio_irq_enable`和`gpio_irq_set_type()`，在前面`irq_handler_enable()`调用；</span><br><span class="line">    </span><br><span class="line">*   `demo.c`里的函数:  </span><br><span class="line">    包含定时器中断测试`board_gic_test()`和GPIO中断测试`board_gpio_irq_test()`；</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">因此，除了`start.S`里的初始化，还需移植`irq_install_handler()`、`irq_handler_enable`、`do_irq()`三个函数，此外还有定时器中断测试和GPIO测试函数。</span><br><span class="line"></span><br><span class="line"><span class="number">4.2</span> 启动和中断代码</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">因为`start.S`里面包含了中断初始化代码，即`gic_init_secure`和`gic_init_secure_percpu`，移植的时候直接复制过来的，因此也把`start.S`贴出来。  </span><br><span class="line">`start.S`是对U-boot的`start.S`进行了裁剪和修改，思路和前面U-Boot的流程差不多，几个重定位、绝对跳转、代码对齐的坑，都踩完了，下面的`start.S`有时间的话可以好好看下。  </span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (C) Copyright 2013</span></span><br><span class="line"><span class="comment"> * David Feng &lt;fenghua@phytium.com.cn&gt;</span></span><br><span class="line"><span class="comment"> * F:\Rock4Plus_Android10\u-boot\arch\arm\cpu\armv8\start.S</span></span><br><span class="line"><span class="comment"> * SPDX-License-Identifier:    GPL-2.0+</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;asm-offsets.h&gt;</span></span><br><span class="line">#define GENERATED_GBL_DATA_SIZE <span class="number">464</span> <span class="comment">/* (sizeof(struct global_data) + 15) &amp; ~15    // */</span></span><br><span class="line">#define GENERATED_BD_INFO_SIZE <span class="number">336</span> <span class="comment">/* (sizeof(struct bd_info) + 15) &amp; ~15    // */</span></span><br><span class="line">#define GD_SIZE <span class="number">456</span> <span class="comment">/* sizeof(struct global_data)    // */</span></span><br><span class="line">#define GD_BD <span class="number">0</span> <span class="comment">/* offsetof(struct global_data, bd)    // */</span></span><br><span class="line">#define GD_MALLOC_BASE <span class="number">280</span> <span class="comment">/* offsetof(struct global_data, malloc_base)    // */</span></span><br><span class="line">#define GD_RELOCADDR <span class="number">96</span> <span class="comment">/* offsetof(struct global_data, relocaddr)    // */</span></span><br><span class="line">#define GD_RELOC_OFF <span class="number">136</span> <span class="comment">/* offsetof(struct global_data, reloc_off)    // */</span></span><br><span class="line">#define GD_START_ADDR_SP <span class="number">128</span> <span class="comment">/* offsetof(struct global_data, start_addr_sp)    // */</span></span><br><span class="line">#define PM_CTX_SIZE <span class="number">136</span> <span class="comment">/* sizeof(struct pm_ctx)    // */</span></span><br><span class="line">#define PM_CTX_PHYS <span class="number">408</span> <span class="comment">/* offsetof(struct global_data, pm_ctx_phys)    // */</span></span><br><span class="line">#define GD_NEW_GD <span class="number">144</span> <span class="comment">/* offsetof(struct global_data, new_gd)    // */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;config.h&gt;</span></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\include\configs\rk3399_common.h*/</span></span><br><span class="line">#define CONFIG_SYS_TEXT_BASE        <span class="number">0x00200000</span></span><br><span class="line">#define CONFIG_SYS_INIT_SP_ADDR        <span class="number">0x00400000</span></span><br><span class="line"></span><br><span class="line">#define GICD_BASE            <span class="number">0xFEE00000</span></span><br><span class="line">#define GICR_BASE            <span class="number">0xFEF00000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;asm/macro.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\include\asm\macro.h start*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These macros provide a convenient way to write 8, 16 and 32 bit data</span></span><br><span class="line"><span class="comment"> * to any address.</span></span><br><span class="line"><span class="comment"> * Registers r4 and r5 are used, any data in these registers are</span></span><br><span class="line"><span class="comment"> * overwritten by the macros.</span></span><br><span class="line"><span class="comment"> * The macros are valid for any ARM architecture, they do not implement</span></span><br><span class="line"><span class="comment"> * any memory barriers so caution is recommended when using these when the</span></span><br><span class="line"><span class="comment"> * caches are enabled or on a multi-core system.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">.macro    write32, addr, data</span><br><span class="line">    ldr    r4, =\addr</span><br><span class="line">    ldr    r5, =\data</span><br><span class="line">    str    r5, [r4]</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro    write16, addr, data</span><br><span class="line">    ldr    r4, =\addr</span><br><span class="line">    ldrh    r5, =\data</span><br><span class="line">    strh    r5, [r4]</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro    write8, addr, data</span><br><span class="line">    ldr    r4, =\addr</span><br><span class="line">    ldrb    r5, =\data</span><br><span class="line">    strb    r5, [r4]</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This macro generates a loop that can be used for delays in the code.</span></span><br><span class="line"><span class="comment"> * Register r4 is used, any data in this register is overwritten by the</span></span><br><span class="line"><span class="comment"> * macro.</span></span><br><span class="line"><span class="comment"> * The macro is valid for any ARM architeture. The actual time spent in the</span></span><br><span class="line"><span class="comment"> * loop will vary from CPU to CPU though.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">.macro    wait_timer, time</span><br><span class="line">    ldr    r4, =\time</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">    nop</span><br><span class="line">    subs    r4, r4, #<span class="number">1</span></span><br><span class="line">    bcs    <span class="number">1b</span></span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Register aliases.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">lr    .req    x30</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Branch according to exception level</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro    switch_el, xreg, el3_label, el2_label, el1_label</span><br><span class="line">    mrs    \xreg, CurrentEL</span><br><span class="line">    cmp    \xreg, <span class="number">0xc</span></span><br><span class="line">    b.eq    \el3_label</span><br><span class="line">    cmp    \xreg, <span class="number">0x8</span></span><br><span class="line">    b.eq    \el2_label</span><br><span class="line">    cmp    \xreg, <span class="number">0x4</span></span><br><span class="line">    b.eq    \el1_label</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Branch if current processor is a Cortex-A35 core.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro    branch_if_a35_core, xreg, a35_label</span><br><span class="line">    mrs    \xreg, midr_el1</span><br><span class="line">    lsr    \xreg, \xreg, #<span class="number">4</span></span><br><span class="line">    <span class="keyword">and</span>    \xreg, \xreg, #<span class="number">0x00000FFF</span></span><br><span class="line">    cmp    \xreg, #<span class="number">0xD04</span>        <span class="comment">/* Cortex-A35 MPCore processor. */</span></span><br><span class="line">    b.eq    \a35_label</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Branch if current processor is a Cortex-A57 core.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro    branch_if_a57_core, xreg, a57_label</span><br><span class="line">    mrs    \xreg, midr_el1</span><br><span class="line">    lsr    \xreg, \xreg, #<span class="number">4</span></span><br><span class="line">    <span class="keyword">and</span>    \xreg, \xreg, #<span class="number">0x00000FFF</span></span><br><span class="line">    cmp    \xreg, #<span class="number">0xD07</span>        <span class="comment">/* Cortex-A57 MPCore processor. */</span></span><br><span class="line">    b.eq    \a57_label</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Branch if current processor is a Cortex-A53 core.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro    branch_if_a53_core, xreg, a53_label</span><br><span class="line">    mrs    \xreg, midr_el1</span><br><span class="line">    lsr    \xreg, \xreg, #<span class="number">4</span></span><br><span class="line">    <span class="keyword">and</span>    \xreg, \xreg, #<span class="number">0x00000FFF</span></span><br><span class="line">    cmp    \xreg, #<span class="number">0xD03</span>        <span class="comment">/* Cortex-A53 MPCore processor. */</span></span><br><span class="line">    b.eq    \a53_label</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Branch if current processor is a slave,</span></span><br><span class="line"><span class="comment"> * choose processor with all zero affinity value as the master.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro    branch_if_slave, xreg, slave_label</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Branch if current processor is a master,</span></span><br><span class="line"><span class="comment"> * choose processor with all zero affinity value as the master.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro    branch_if_master, xreg1, xreg2, master_label</span><br><span class="line">    b     \master_label</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Switch from EL3 to EL2 for ARMv8</span></span><br><span class="line"><span class="comment"> * @ep:     kernel entry point</span></span><br><span class="line"><span class="comment"> * @flag:   The execution state flag for lower exception</span></span><br><span class="line"><span class="comment"> *          level, ES_TO_AARCH64 or ES_TO_AARCH32</span></span><br><span class="line"><span class="comment"> * @tmp:    temporary register</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For loading 32-bit OS, x1 is machine nr and x2 is ftaddr.</span></span><br><span class="line"><span class="comment"> * For loading 64-bit OS, x0 is physical address to the FDT blob.</span></span><br><span class="line"><span class="comment"> * They will be passed to the guest.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro armv8_switch_to_el2_m, ep, flag, tmp</span><br><span class="line">    msr    cptr_el3, xzr        <span class="comment">/* Disable coprocessor traps to EL3 */</span></span><br><span class="line">    mov    \tmp, #CPTR_EL2_RES1</span><br><span class="line">    msr    cptr_el2, \tmp        <span class="comment">/* Disable coprocessor traps to EL2 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize Generic Timers */</span></span><br><span class="line">    msr    cntvoff_el2, xzr</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize SCTLR_EL2</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * setting RES1 bits (29,28,23,22,18,16,11,5,4) to 1</span></span><br><span class="line"><span class="comment">     * and RES0 bits (31,30,27,26,24,21,20,17,15-13,10-6) +</span></span><br><span class="line"><span class="comment">     * EE,WXN,I,SA,C,A,M to 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ldr    \tmp, =(SCTLR_EL2_RES1 | SCTLR_EL2_EE_LE |\</span><br><span class="line">            SCTLR_EL2_WXN_DIS | SCTLR_EL2_ICACHE_DIS |\</span><br><span class="line">            SCTLR_EL2_SA_DIS | SCTLR_EL2_DCACHE_DIS |\</span><br><span class="line">            SCTLR_EL2_ALIGN_DIS | SCTLR_EL2_MMU_DIS)</span><br><span class="line">    msr    sctlr_el2, \tmp</span><br><span class="line"></span><br><span class="line">    mov    \tmp, sp</span><br><span class="line">    msr    sp_el2, \tmp        <span class="comment">/* Migrate SP */</span></span><br><span class="line">    mrs    \tmp, vbar_el3</span><br><span class="line">    msr    vbar_el2, \tmp        <span class="comment">/* Migrate VBAR */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check switch to AArch64 EL2 or AArch32 Hypervisor mode */</span></span><br><span class="line">    cmp    \flag, #ES_TO_AARCH32</span><br><span class="line">    b.eq    <span class="number">1f</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The next lower exception level is AArch64, 64bit EL2 | HCE |</span></span><br><span class="line"><span class="comment">     * RES1 (Bits[5:4]) | Non-secure EL0/EL1.</span></span><br><span class="line"><span class="comment">     * and the SMD depends on requirements.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ldr    \tmp, =(SCR_EL3_RW_AARCH64 | SCR_EL3_HCE_EN |\</span><br><span class="line">            SCR_EL3_SMD_DIS | SCR_EL3_RES1 |\</span><br><span class="line">            SCR_EL3_NS_EN)</span><br><span class="line">    msr    scr_el3, \tmp</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return to the EL2_SP2 mode from EL3 */</span></span><br><span class="line">    ldr    \tmp, =(SPSR_EL_DEBUG_MASK | SPSR_EL_SERR_MASK |\</span><br><span class="line">            SPSR_EL_IRQ_MASK | SPSR_EL_FIQ_MASK |\</span><br><span class="line">            SPSR_EL_M_AARCH64 | SPSR_EL_M_EL2H)</span><br><span class="line">    msr    spsr_el3, \tmp</span><br><span class="line">    msr    elr_el3, \ep</span><br><span class="line">    eret</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The next lower exception level is AArch32, 32bit EL2 | HCE |</span></span><br><span class="line"><span class="comment">     * SMD | RES1 (Bits[5:4]) | Non-secure EL0/EL1.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ldr    \tmp, =(SCR_EL3_RW_AARCH32 | SCR_EL3_HCE_EN |\</span><br><span class="line">            SCR_EL3_SMD_DIS | SCR_EL3_RES1 |\</span><br><span class="line">            SCR_EL3_NS_EN)</span><br><span class="line">    msr    scr_el3, \tmp</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return to AArch32 Hypervisor mode */</span></span><br><span class="line">    ldr     \tmp, =(SPSR_EL_END_LE | SPSR_EL_ASYN_MASK |\</span><br><span class="line">            SPSR_EL_IRQ_MASK | SPSR_EL_FIQ_MASK |\</span><br><span class="line">            SPSR_EL_T_A32 | SPSR_EL_M_AARCH32 |\</span><br><span class="line">            SPSR_EL_M_HYP)</span><br><span class="line">    msr    spsr_el3, \tmp</span><br><span class="line">    msr     elr_el3, \ep</span><br><span class="line">    eret</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Switch from EL2 to EL1 for ARMv8</span></span><br><span class="line"><span class="comment"> * @ep:     kernel entry point</span></span><br><span class="line"><span class="comment"> * @flag:   The execution state flag for lower exception</span></span><br><span class="line"><span class="comment"> *          level, ES_TO_AARCH64 or ES_TO_AARCH32</span></span><br><span class="line"><span class="comment"> * @tmp:    temporary register</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For loading 32-bit OS, x1 is machine nr and x2 is ftaddr.</span></span><br><span class="line"><span class="comment"> * For loading 64-bit OS, x0 is physical address to the FDT blob.</span></span><br><span class="line"><span class="comment"> * They will be passed to the guest.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.macro armv8_switch_to_el1_m, ep, flag, tmp</span><br><span class="line">    <span class="comment">/* Initialize Generic Timers */</span></span><br><span class="line">    mrs    \tmp, cnthctl_el2</span><br><span class="line">    <span class="comment">/* Enable EL1 access to timers */</span></span><br><span class="line">    orr    \tmp, \tmp, #(CNTHCTL_EL2_EL1PCEN_EN |\</span><br><span class="line">        CNTHCTL_EL2_EL1PCTEN_EN)</span><br><span class="line">    msr    cnthctl_el2, \tmp</span><br><span class="line">    msr    cntvoff_el2, xzr</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initilize MPID/MPIDR registers */</span></span><br><span class="line">    mrs    \tmp, midr_el1</span><br><span class="line">    msr    vpidr_el2, \tmp</span><br><span class="line">    mrs    \tmp, mpidr_el1</span><br><span class="line">    msr    vmpidr_el2, \tmp</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Disable coprocessor traps */</span></span><br><span class="line">    mov    \tmp, #CPTR_EL2_RES1</span><br><span class="line">    msr    cptr_el2, \tmp        <span class="comment">/* Disable coprocessor traps to EL2 */</span></span><br><span class="line">    msr    hstr_el2, xzr        <span class="comment">/* Disable coprocessor traps to EL2 */</span></span><br><span class="line">    mov    \tmp, #CPACR_EL1_FPEN_EN</span><br><span class="line">    msr    cpacr_el1, \tmp        <span class="comment">/* Enable FP/SIMD at EL1 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* SCTLR_EL1 initialization</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * setting RES1 bits (29,28,23,22,20,11) to 1</span></span><br><span class="line"><span class="comment">     * and RES0 bits (31,30,27,21,17,13,10,6) +</span></span><br><span class="line"><span class="comment">     * UCI,EE,EOE,WXN,nTWE,nTWI,UCT,DZE,I,UMA,SED,ITD,</span></span><br><span class="line"><span class="comment">     * CP15BEN,SA0,SA,C,A,M to 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ldr    \tmp, =(SCTLR_EL1_RES1 | SCTLR_EL1_UCI_DIS |\</span><br><span class="line">            SCTLR_EL1_EE_LE | SCTLR_EL1_WXN_DIS |\</span><br><span class="line">            SCTLR_EL1_NTWE_DIS | SCTLR_EL1_NTWI_DIS |\</span><br><span class="line">            SCTLR_EL1_UCT_DIS | SCTLR_EL1_DZE_DIS |\</span><br><span class="line">            SCTLR_EL1_ICACHE_DIS | SCTLR_EL1_UMA_DIS |\</span><br><span class="line">            SCTLR_EL1_SED_EN | SCTLR_EL1_ITD_EN |\</span><br><span class="line">            SCTLR_EL1_CP15BEN_DIS | SCTLR_EL1_SA0_DIS |\</span><br><span class="line">            SCTLR_EL1_SA_DIS | SCTLR_EL1_DCACHE_DIS |\</span><br><span class="line">            SCTLR_EL1_ALIGN_DIS | SCTLR_EL1_MMU_DIS)</span><br><span class="line">    msr    sctlr_el1, \tmp</span><br><span class="line"></span><br><span class="line">    mov    \tmp, sp</span><br><span class="line">    msr    sp_el1, \tmp        <span class="comment">/* Migrate SP */</span></span><br><span class="line">    mrs    \tmp, vbar_el2</span><br><span class="line">    msr    vbar_el1, \tmp        <span class="comment">/* Migrate VBAR */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check switch to AArch64 EL1 or AArch32 Supervisor mode */</span></span><br><span class="line">    cmp    \flag, #ES_TO_AARCH32</span><br><span class="line">    b.eq    <span class="number">1f</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize HCR_EL2 */</span></span><br><span class="line">    ldr    \tmp, =(HCR_EL2_RW_AARCH64 | HCR_EL2_HCD_DIS)</span><br><span class="line">    msr    hcr_el2, \tmp</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return to the EL1_SP1 mode from EL2 */</span></span><br><span class="line">    ldr    \tmp, =(SPSR_EL_DEBUG_MASK | SPSR_EL_SERR_MASK |\</span><br><span class="line">            SPSR_EL_IRQ_MASK | SPSR_EL_FIQ_MASK |\</span><br><span class="line">            SPSR_EL_M_AARCH64 | SPSR_EL_M_EL1H)</span><br><span class="line">    msr    spsr_el2, \tmp</span><br><span class="line">    msr     elr_el2, \ep</span><br><span class="line">    eret</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">    <span class="comment">/* Initialize HCR_EL2 */</span></span><br><span class="line">    ldr    \tmp, =(HCR_EL2_RW_AARCH32 | HCR_EL2_HCD_DIS)</span><br><span class="line">    msr    hcr_el2, \tmp</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return to AArch32 Supervisor mode from EL2 */</span></span><br><span class="line">    ldr    \tmp, =(SPSR_EL_END_LE | SPSR_EL_ASYN_MASK |\</span><br><span class="line">            SPSR_EL_IRQ_MASK | SPSR_EL_FIQ_MASK |\</span><br><span class="line">            SPSR_EL_T_A32 | SPSR_EL_M_AARCH32 |\</span><br><span class="line">            SPSR_EL_M_SVC)</span><br><span class="line">    msr     spsr_el2, \tmp</span><br><span class="line">    msr     elr_el2, \ep</span><br><span class="line">    eret</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro gic_wait_for_interrupt_m xreg1</span><br><span class="line"><span class="number">0</span> :    wfi</span><br><span class="line">    mrs     \xreg1, ICC_IAR1_EL1</span><br><span class="line">    msr     ICC_EOIR1_EL1, \xreg1</span><br><span class="line">    cbnz    \xreg1, <span class="number">0b</span></span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\include\asm\macro.h end*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#include &lt;asm/armv8/mmu.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* #include &lt;linux/linkage.h&gt; start*/</span></span><br><span class="line"></span><br><span class="line">#define STT_FUNC <span class="number">2</span> <span class="comment">/* elf.h */</span></span><br><span class="line"></span><br><span class="line">#define ASM_NL ;</span><br><span class="line"></span><br><span class="line">#define SYMBOL_NAME(X)        X</span><br><span class="line">#define SYMBOL_NAME_LABEL(X)    X:</span><br><span class="line">#define __ALIGN .align <span class="number">0</span></span><br><span class="line">#define __ALIGN_STR <span class="string">&quot;.align 0&quot;</span></span><br><span class="line">#define ALIGN            __ALIGN</span><br><span class="line">#define ALIGN_STR        __ALIGN_STR</span><br><span class="line"></span><br><span class="line">#define LENTRY(name) \</span><br><span class="line">    ALIGN ASM_NL \</span><br><span class="line">    SYMBOL_NAME_LABEL(name)</span><br><span class="line"></span><br><span class="line">#define ENTRY(name) \</span><br><span class="line">    .globl SYMBOL_NAME(name) ASM_NL \</span><br><span class="line">    LENTRY(name)</span><br><span class="line"></span><br><span class="line">#define WEAK(name) \</span><br><span class="line">    .weak SYMBOL_NAME(name) ASM_NL \</span><br><span class="line">    LENTRY(name)</span><br><span class="line"></span><br><span class="line">#define END(name) \</span><br><span class="line">    .size name, .-name</span><br><span class="line"></span><br><span class="line">#define ENDPROC(name) \</span><br><span class="line">    .type name STT_FUNC ASM_NL \</span><br><span class="line">    END(name)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* #include &lt;linux/linkage.h&gt; end*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Startup Code (reset vector)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line"></span><br><span class="line">.globl    _start</span><br><span class="line">_start:</span><br><span class="line">    b    reset</span><br><span class="line">    .align <span class="number">3</span></span><br><span class="line"></span><br><span class="line">.globl    _TEXT_BASE</span><br><span class="line">_TEXT_BASE:</span><br><span class="line">    .quad    CONFIG_SYS_TEXT_BASE</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These are defined in the linker script.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.globl    _end_ofs</span><br><span class="line">_end_ofs:</span><br><span class="line">    .quad    _end - _start</span><br><span class="line"></span><br><span class="line">.globl    _bss_start_ofs</span><br><span class="line">_bss_start_ofs:</span><br><span class="line">    .quad    __bss_start - _start</span><br><span class="line"></span><br><span class="line">.globl    _bss_end_ofs</span><br><span class="line">_bss_end_ofs:</span><br><span class="line">    .quad    __bss_end - _start</span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">    <span class="comment">/* Allow the board to save important registers */</span></span><br><span class="line">    b    save_boot_params</span><br><span class="line">.globl    save_boot_params_ret</span><br><span class="line">save_boot_params_ret:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Could be EL3/EL2/EL1, Initial State:</span></span><br><span class="line"><span class="comment">     * Little Endian, MMU Disabled, i/dCache Disabled</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    adr    x0, vectors</span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    msr    vbar_el3, x0</span><br><span class="line">    mrs    x0, scr_el3</span><br><span class="line">    orr    x0, x0, #<span class="number">0xf</span>            <span class="comment">/* SCR_EL3.NS|IRQ|FIQ|EA */</span></span><br><span class="line">    msr    scr_el3, x0</span><br><span class="line">    msr    cptr_el3, xzr            <span class="comment">/* Enable FP/SIMD */</span></span><br><span class="line">    <span class="comment">/* COUNTER_FREQUENCY 24000000 \u-boot\include\configs\rockchip-common.h */</span></span><br><span class="line">    ldr    x0, =<span class="number">24000000</span></span><br><span class="line">    msr    cntfrq_el0, x0            <span class="comment">/* Initialize CNTFRQ */</span></span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    msr    vbar_el2, x0</span><br><span class="line">    mov    x0, #<span class="number">0x33ff</span></span><br><span class="line">    msr    cptr_el2, x0            <span class="comment">/* Enable FP/SIMD */</span></span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    msr    vbar_el1, x0</span><br><span class="line">    mov    x0, #<span class="number">3</span> &lt;&lt; <span class="number">20</span></span><br><span class="line">    msr    cpacr_el1, x0            <span class="comment">/* Enable FP/SIMD */</span></span><br><span class="line"><span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Enable SMPEN bit for coherency.</span></span><br><span class="line"><span class="comment">     * This register is not architectural but at the moment</span></span><br><span class="line"><span class="comment">     * this bit should be set for A53/A57/A72.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">1f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:</span><br><span class="line">    mrs     x0, S3_1_c15_c2_1               <span class="comment">/* cpuectlr_el1 */</span></span><br><span class="line">    orr     x0, x0, #<span class="number">0x40</span></span><br><span class="line">    msr     S3_1_c15_c2_1, x0</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Apply ARM core specific erratas */</span></span><br><span class="line">    bl    apply_core_errata</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Cache/BPB/TLB Invalidate</span></span><br><span class="line"><span class="comment">     * i-cache is invalidated before enabled in icache_enable()</span></span><br><span class="line"><span class="comment">     * tlb is invalidated before mmu is enabled in dcache_enable()</span></span><br><span class="line"><span class="comment">     * d-cache is invalidated before enabled in dcache_enable()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Processor specific initialization */</span></span><br><span class="line">    bl    lowlevel_init </span><br><span class="line">master_cpu:</span><br><span class="line">    bl    _main</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">WEAK(apply_core_errata)</span><br><span class="line"></span><br><span class="line">    mov    x29, lr            <span class="comment">/* Save LR */</span></span><br><span class="line">    <span class="comment">/* For now, we support Cortex-A57 specific errata only */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we are running on a Cortex-A57 core */</span></span><br><span class="line">    branch_if_a57_core x0, apply_a57_core_errata</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line">    mov    lr, x29            <span class="comment">/* Restore LR */</span></span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">apply_a57_core_errata:</span><br><span class="line">    b <span class="number">0b</span></span><br><span class="line">ENDPROC(apply_core_errata)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">WEAK(lowlevel_init)</span><br><span class="line">    mov    x29, lr            <span class="comment">/* Save LR */</span></span><br><span class="line">     branch_if_slave x0, <span class="number">1f</span></span><br><span class="line">    ldr    x0, =GICD_BASE</span><br><span class="line">    bl    gic_init_secure</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">     ldr    x0, =GICR_BASE</span><br><span class="line">    bl    gic_init_secure_percpu</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Setting HCR_EL2.TGE AMO IMO FMO for exception rounting to EL2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mrs    x0, CurrentEL        <span class="comment">/* check currentEL */</span></span><br><span class="line">    cmp    x0, <span class="number">0x8</span></span><br><span class="line">    b.ne    end            <span class="comment">/* currentEL != EL2 */</span></span><br><span class="line"></span><br><span class="line">    mrs    x9, hcr_el2</span><br><span class="line">    orr    x9, x9, #(<span class="number">7</span> &lt;&lt; <span class="number">3</span>)    <span class="comment">/* HCR_EL2.AMO IMO FMO set */</span></span><br><span class="line">    orr    x9, x9, #(<span class="number">1</span> &lt;&lt; <span class="number">27</span>)    <span class="comment">/* HCR_EL2.TGE set */</span></span><br><span class="line">    msr    hcr_el2, x9</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">    nop</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>:</span><br><span class="line">    mov    lr, x29            <span class="comment">/* Restore LR */</span></span><br><span class="line">    ret</span><br><span class="line">ENDPROC(lowlevel_init)</span><br><span class="line"></span><br><span class="line">WEAK(smp_kick_all_cpus)</span><br><span class="line">    <span class="comment">/* Kick secondary cpus up by SGI 0 interrupt */</span></span><br><span class="line">     ldr    x0, =GICD_BASE</span><br><span class="line">    b    gic_kick_secondary_cpus</span><br><span class="line">     ret</span><br><span class="line">ENDPROC(smp_kick_all_cpus)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">ENTRY(c_runtime_cpu_setup)</span><br><span class="line">    <span class="comment">/* Relocate vBAR */</span></span><br><span class="line">    adr    x0, vectors</span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    msr    vbar_el3, x0</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    msr    vbar_el2, x0</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    msr    vbar_el1, x0</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line">ENDPROC(c_runtime_cpu_setup)</span><br><span class="line"></span><br><span class="line">WEAK(save_boot_params)</span><br><span class="line">    b    save_boot_params_ret    <span class="comment">/* back to my caller */</span></span><br><span class="line">ENDPROC(save_boot_params) </span><br><span class="line"></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\lib\gic_64.S*/</span></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\include\asm\gic.h*/</span></span><br><span class="line"><span class="comment">/* Register offsets for the ARM generic interrupt controller (GIC) */</span></span><br><span class="line"></span><br><span class="line">#define GIC_DIST_OFFSET        <span class="number">0x1000</span></span><br><span class="line">#define GIC_CPU_OFFSET_A9    <span class="number">0x0100</span></span><br><span class="line">#define GIC_CPU_OFFSET_A15    <span class="number">0x2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Distributor Registers */</span></span><br><span class="line">#define GICD_CTLR        <span class="number">0x0000</span></span><br><span class="line">#define GICD_TYPER        <span class="number">0x0004</span></span><br><span class="line">#define GICD_IIDR        <span class="number">0x0008</span></span><br><span class="line">#define GICD_STATUSR        <span class="number">0x0010</span></span><br><span class="line">#define GICD_SETSPI_NSR        <span class="number">0x0040</span></span><br><span class="line">#define GICD_CLRSPI_NSR        <span class="number">0x0048</span></span><br><span class="line">#define GICD_SETSPI_SR        <span class="number">0x0050</span></span><br><span class="line">#define GICD_CLRSPI_SR        <span class="number">0x0058</span></span><br><span class="line">#define GICD_SEIR        <span class="number">0x0068</span></span><br><span class="line">#define GICD_IGROUPRn        <span class="number">0x0080</span></span><br><span class="line">#define GICD_ISENABLERn        <span class="number">0x0100</span></span><br><span class="line">#define GICD_ICENABLERn        <span class="number">0x0180</span></span><br><span class="line">#define GICD_ISPENDRn        <span class="number">0x0200</span></span><br><span class="line">#define GICD_ICPENDRn        <span class="number">0x0280</span></span><br><span class="line">#define GICD_ISACTIVERn        <span class="number">0x0300</span></span><br><span class="line">#define GICD_ICACTIVERn        <span class="number">0x0380</span></span><br><span class="line">#define GICD_IPRIORITYRn    <span class="number">0x0400</span></span><br><span class="line">#define GICD_ITARGETSRn        <span class="number">0x0800</span></span><br><span class="line">#define GICD_ICFGR        <span class="number">0x0c00</span></span><br><span class="line">#define GICD_IGROUPMODRn    <span class="number">0x0d00</span></span><br><span class="line">#define GICD_NSACRn        <span class="number">0x0e00</span></span><br><span class="line">#define GICD_SGIR        <span class="number">0x0f00</span></span><br><span class="line">#define GICD_CPENDSGIRn        <span class="number">0x0f10</span></span><br><span class="line">#define GICD_SPENDSGIRn        <span class="number">0x0f20</span></span><br><span class="line">#define GICD_IROUTERn        <span class="number">0x6000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Cpu Interface Memory Mapped Registers */</span></span><br><span class="line">#define GICC_CTLR        <span class="number">0x0000</span></span><br><span class="line">#define GICC_PMR        <span class="number">0x0004</span></span><br><span class="line">#define GICC_BPR        <span class="number">0x0008</span></span><br><span class="line">#define GICC_IAR        <span class="number">0x000C</span></span><br><span class="line">#define GICC_EOIR        <span class="number">0x0010</span></span><br><span class="line">#define GICC_RPR        <span class="number">0x0014</span></span><br><span class="line">#define GICC_HPPIR        <span class="number">0x0018</span></span><br><span class="line">#define GICC_ABPR        <span class="number">0x001c</span></span><br><span class="line">#define GICC_AIAR        <span class="number">0x0020</span></span><br><span class="line">#define GICC_AEOIR        <span class="number">0x0024</span></span><br><span class="line">#define GICC_AHPPIR        <span class="number">0x0028</span></span><br><span class="line">#define GICC_APRn        <span class="number">0x00d0</span></span><br><span class="line">#define GICC_NSAPRn        <span class="number">0x00e0</span></span><br><span class="line">#define GICC_IIDR        <span class="number">0x00fc</span></span><br><span class="line">#define GICC_DIR        <span class="number">0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ReDistributor Registers for Control and Physical LPIs */</span></span><br><span class="line">#define GICR_CTLR        <span class="number">0x0000</span></span><br><span class="line">#define GICR_IIDR        <span class="number">0x0004</span></span><br><span class="line">#define GICR_TYPER        <span class="number">0x0008</span></span><br><span class="line">#define GICR_STATUSR        <span class="number">0x0010</span></span><br><span class="line">#define GICR_WAKER        <span class="number">0x0014</span></span><br><span class="line">#define GICR_SETLPIR        <span class="number">0x0040</span></span><br><span class="line">#define GICR_CLRLPIR        <span class="number">0x0048</span></span><br><span class="line">#define GICR_SEIR        <span class="number">0x0068</span></span><br><span class="line">#define GICR_PROPBASER        <span class="number">0x0070</span></span><br><span class="line">#define GICR_PENDBASER        <span class="number">0x0078</span></span><br><span class="line">#define GICR_INVLPIR        <span class="number">0x00a0</span></span><br><span class="line">#define GICR_INVALLR        <span class="number">0x00b0</span></span><br><span class="line">#define GICR_SYNCR        <span class="number">0x00c0</span></span><br><span class="line">#define GICR_MOVLPIR        <span class="number">0x0100</span></span><br><span class="line">#define GICR_MOVALLR        <span class="number">0x0110</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ReDistributor Registers for SGIs and PPIs */</span></span><br><span class="line">#define GICR_IGROUPRn        <span class="number">0x0080</span></span><br><span class="line">#define GICR_ISENABLERn        <span class="number">0x0100</span></span><br><span class="line">#define GICR_ICENABLERn        <span class="number">0x0180</span></span><br><span class="line">#define GICR_ISPENDRn        <span class="number">0x0200</span></span><br><span class="line">#define GICR_ICPENDRn        <span class="number">0x0280</span></span><br><span class="line">#define GICR_ISACTIVERn        <span class="number">0x0300</span></span><br><span class="line">#define GICR_ICACTIVERn        <span class="number">0x0380</span></span><br><span class="line">#define GICR_IPRIORITYRn    <span class="number">0x0400</span></span><br><span class="line">#define GICR_ICFGR0        <span class="number">0x0c00</span></span><br><span class="line">#define GICR_ICFGR1        <span class="number">0x0c04</span></span><br><span class="line">#define GICR_IGROUPMODRn    <span class="number">0x0d00</span></span><br><span class="line">#define GICR_NSACRn        <span class="number">0x0e00</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Cpu Interface System Registers */</span></span><br><span class="line">#define ICC_IAR0_EL1        S3_0_C12_C8_0</span><br><span class="line">#define ICC_IAR1_EL1        S3_0_C12_C12_0</span><br><span class="line">#define ICC_EOIR0_EL1        S3_0_C12_C8_1</span><br><span class="line">#define ICC_EOIR1_EL1        S3_0_C12_C12_1</span><br><span class="line">#define ICC_HPPIR0_EL1        S3_0_C12_C8_2</span><br><span class="line">#define ICC_HPPIR1_EL1        S3_0_C12_C12_2</span><br><span class="line">#define ICC_BPR0_EL1        S3_0_C12_C8_3</span><br><span class="line">#define ICC_BPR1_EL1        S3_0_C12_C12_3</span><br><span class="line">#define ICC_DIR_EL1        S3_0_C12_C11_1</span><br><span class="line">#define ICC_PMR_EL1        S3_0_C4_C6_0</span><br><span class="line">#define ICC_RPR_EL1        S3_0_C12_C11_3</span><br><span class="line">#define ICC_CTLR_EL1        S3_0_C12_C12_4</span><br><span class="line">#define ICC_CTLR_EL3        S3_6_C12_C12_4</span><br><span class="line">#define ICC_SRE_EL1        S3_0_C12_C12_5</span><br><span class="line">#define ICC_SRE_EL2        S3_4_C12_C9_5</span><br><span class="line">#define ICC_SRE_EL3        S3_6_C12_C12_5</span><br><span class="line">#define ICC_IGRPEN0_EL1        S3_0_C12_C12_6</span><br><span class="line">#define ICC_IGRPEN1_EL1        S3_0_C12_C12_7</span><br><span class="line">#define ICC_IGRPEN1_EL3        S3_6_C12_C12_7</span><br><span class="line">#define ICC_SEIEN_EL1        S3_0_C12_C13_0</span><br><span class="line">#define ICC_SGI0R_EL1        S3_0_C12_C11_7</span><br><span class="line">#define ICC_SGI1R_EL1        S3_0_C12_C11_5</span><br><span class="line">#define ICC_ASGI1R_EL1        S3_0_C12_C11_6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * void gic_init_secure(DistributorBase);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Initialize secure copy of GIC at EL3.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(gic_init_secure)</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Initialize Distributor</span></span><br><span class="line"><span class="comment">     * x0: Distributor Base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     mov    w9, #<span class="number">0x37</span>        <span class="comment">/* EnableGrp0 | EnableGrp1NS */</span></span><br><span class="line">                    <span class="comment">/* EnableGrp1S | ARE_S | ARE_NS */</span></span><br><span class="line">    str    w9, [x0, GICD_CTLR]    <span class="comment">/* Secure GICD_CTLR */</span></span><br><span class="line">    ldr    w9, [x0, GICD_TYPER]</span><br><span class="line">    <span class="keyword">and</span>    w10, w9, #<span class="number">0x1f</span>        <span class="comment">/* ITLinesNumber */</span></span><br><span class="line">    cbz    w10, <span class="number">1f</span>            <span class="comment">/* No SPIs */</span></span><br><span class="line">    add    x11, x0, (GICD_IGROUPRn + <span class="number">4</span>)</span><br><span class="line">    add    x12, x0, (GICD_IGROUPMODRn + <span class="number">4</span>)</span><br><span class="line">    mov    w9, #~<span class="number">0</span></span><br><span class="line"><span class="number">0</span>:    str    w9, [x11], #<span class="number">0x4</span></span><br><span class="line">    str    wzr, [x12], #<span class="number">0x4</span>    <span class="comment">/* Config SPIs as Group1NS */</span></span><br><span class="line">    sub    w10, w10, #<span class="number">0x1</span></span><br><span class="line">    cbnz    w10, <span class="number">0b</span></span><br><span class="line"> </span><br><span class="line"><span class="number">1</span>:</span><br><span class="line">    ret</span><br><span class="line">ENDPROC(gic_init_secure)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************* </span></span><br><span class="line"><span class="comment"> * For Gicv3:</span></span><br><span class="line"><span class="comment"> * void gic_init_secure_percpu(ReDistributorBase);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Initialize secure copy of GIC at EL3.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(gic_init_secure_percpu)</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Initialize ReDistributor</span></span><br><span class="line"><span class="comment">     * x0: ReDistributor Base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mrs    x10, mpidr_el1</span><br><span class="line">    lsr    x9, x10, #<span class="number">32</span></span><br><span class="line">    bfi    x10, x9, #<span class="number">24</span>, #<span class="number">8</span>    <span class="comment">/* w10 is aff3:aff2:aff1:aff0 */</span></span><br><span class="line">    mov    x9, x0</span><br><span class="line"><span class="number">1</span>:    ldr    x11, [x9, GICR_TYPER]</span><br><span class="line">    lsr    x11, x11, #<span class="number">32</span>        <span class="comment">/* w11 is aff3:aff2:aff1:aff0 */</span></span><br><span class="line">    cmp    w10, w11</span><br><span class="line">    b.eq    <span class="number">2f</span></span><br><span class="line">    add    x9, x9, #(<span class="number">2</span> &lt;&lt; <span class="number">16</span>)</span><br><span class="line">    b    <span class="number">1b</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* x9: ReDistributor Base Address of Current CPU */</span></span><br><span class="line"><span class="number">2</span>:    mov    w10, #~<span class="number">0x2</span></span><br><span class="line">    ldr    w11, [x9, GICR_WAKER]</span><br><span class="line">    <span class="keyword">and</span>    w11, w11, w10        <span class="comment">/* Clear ProcessorSleep */</span></span><br><span class="line">    str    w11, [x9, GICR_WAKER]</span><br><span class="line">    dsb    st</span><br><span class="line">    isb</span><br><span class="line"><span class="number">3</span>:    ldr    w10, [x9, GICR_WAKER]</span><br><span class="line">    tbnz    w10, #<span class="number">2</span>, <span class="number">3b</span>        <span class="comment">/* Wait Children be Alive */</span></span><br><span class="line"></span><br><span class="line">    add    x10, x9, #(<span class="number">1</span> &lt;&lt; <span class="number">16</span>)    <span class="comment">/* SGI_Base */</span></span><br><span class="line">    mov    w11, #~<span class="number">0</span></span><br><span class="line">    str    w11, [x10, GICR_IGROUPRn]</span><br><span class="line">    str    wzr, [x10, GICR_IGROUPMODRn]    <span class="comment">/* SGIs|PPIs Group1NS */</span></span><br><span class="line">    mov    w11, #<span class="number">0x1</span>        <span class="comment">/* Enable SGI 0 */</span></span><br><span class="line">    str    w11, [x10, GICR_ISENABLERn]</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Rockchip: check elx */</span></span><br><span class="line">    switch_el x0, el3_sre, el2_sre, el1_sre</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize Cpu Interface */</span></span><br><span class="line">el3_sre:</span><br><span class="line">    mrs    x10, ICC_SRE_EL3</span><br><span class="line">    orr    x10, x10, #<span class="number">0xf</span>        <span class="comment">/* SRE &amp; Disable IRQ/FIQ Bypass &amp; */</span></span><br><span class="line">                    <span class="comment">/* Allow EL2 access to ICC_SRE_EL2 */</span></span><br><span class="line">    msr    ICC_SRE_EL3, x10</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">el2_sre:</span><br><span class="line">    mrs    x10, ICC_SRE_EL2</span><br><span class="line">    orr    x10, x10, #<span class="number">0xf</span>        <span class="comment">/* SRE &amp; Disable IRQ/FIQ Bypass &amp; */</span></span><br><span class="line">                    <span class="comment">/* Allow EL1 access to ICC_SRE_EL1 */</span></span><br><span class="line">    msr    ICC_SRE_EL2, x10</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">el1_sre:</span><br><span class="line">    mrs    x0, CurrentEL        <span class="comment">/* check currentEL */</span></span><br><span class="line">    cmp    x0, <span class="number">0xC</span></span><br><span class="line">    b.ne    el1_ctlr        <span class="comment">/* currentEL != EL3 */</span></span><br><span class="line"></span><br><span class="line">el3_ctlr:</span><br><span class="line">    mov    x10, #<span class="number">0x3</span>        <span class="comment">/* EnableGrp1NS | EnableGrp1S */</span></span><br><span class="line">    msr    ICC_IGRPEN1_EL3, x10</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">    msr    ICC_CTLR_EL3, xzr</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">el1_ctlr:</span><br><span class="line">    mov    x10, #<span class="number">0x3</span>        <span class="comment">/* EnableGrp1NS | EnableGrp1S */</span></span><br><span class="line">    msr    ICC_IGRPEN1_EL1, x10</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">    msr    ICC_CTLR_EL1, xzr    <span class="comment">/* NonSecure ICC_CTLR_EL1 */</span></span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">    mov    x10, #<span class="number">0xf0</span>        <span class="comment">/* Non-Secure access to ICC_PMR_EL1 */</span></span><br><span class="line">    msr    ICC_PMR_EL1, x10</span><br><span class="line">    isb</span><br><span class="line"> </span><br><span class="line">    ret</span><br><span class="line">ENDPROC(gic_init_secure_percpu)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************* </span></span><br><span class="line"><span class="comment"> * For Gicv3:</span></span><br><span class="line"><span class="comment"> * void gic_kick_secondary_cpus(void);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************/</span></span><br><span class="line">ENTRY(gic_kick_secondary_cpus)</span><br><span class="line">     mov    x9, #(<span class="number">1</span> &lt;&lt; <span class="number">40</span>)</span><br><span class="line">    msr    ICC_ASGI1R_EL1, x9</span><br><span class="line">    isb</span><br><span class="line">    ret</span><br><span class="line">ENDPROC(gic_kick_secondary_cpus)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\cpu\armv8\exceptions.S*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Exception vectors.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    .align    <span class="number">11</span></span><br><span class="line">    .globl    vectors</span><br><span class="line">vectors:</span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL Synchronous Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_sync*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL IRQ Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_irq*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL FIQ Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_fiq*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>        <span class="comment">/* Current EL Error Thread */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_bad_error*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL Synchronous Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_sync*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL IRQ Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">//bl    do_irq</span></span><br><span class="line">    <span class="comment">//bl    board_init_f_init_reserve</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL FIQ Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_fiq*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line">    .align    <span class="number">7</span>         <span class="comment">/* Current EL Error Handler */</span></span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    bl    _exception_entry</span><br><span class="line">    <span class="comment">/*bl    do_error*/</span></span><br><span class="line">    b    exception_exit</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Enter Exception.</span></span><br><span class="line"><span class="comment"> * This will save the processor state that is ELR/X0~X30</span></span><br><span class="line"><span class="comment"> * to the stack frame.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">_exception_entry:</span><br><span class="line">    stp    x27, x28, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x25, x26, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x23, x24, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x21, x22, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x19, x20, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x17, x18, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x15, x16, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x13, x14, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x11, x12, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x9, x10, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x7, x8, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x5, x6, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x3, x4, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x1, x2, [sp, #<span class="number">-16</span>]!</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Could be running at EL3/EL2/EL1 */</span></span><br><span class="line">    switch_el x11, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    mrs    x1, esr_el3</span><br><span class="line">    mrs    x2, elr_el3</span><br><span class="line">    mrs    x3, daif</span><br><span class="line">    mrs    x4, vbar_el3</span><br><span class="line">    mrs    x5, spsr_el3</span><br><span class="line">    sub    x6, sp, #(<span class="number">8</span>*<span class="number">30</span>)</span><br><span class="line">    mrs    x7, sctlr_el3</span><br><span class="line">    mrs    x8, scr_el3</span><br><span class="line">    mrs    x9, ttbr0_el3</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    mrs    x1, esr_el2</span><br><span class="line">    mrs    x2, elr_el2</span><br><span class="line">    mrs    x3, daif</span><br><span class="line">    mrs    x4, vbar_el2</span><br><span class="line">    mrs    x5, spsr_el2</span><br><span class="line">    sub    x6, sp, #(<span class="number">8</span>*<span class="number">30</span>)</span><br><span class="line">    mrs    x7, sctlr_el2</span><br><span class="line">    mrs    x8, hcr_el2</span><br><span class="line">    mrs    x9, ttbr0_el2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>:    mrs    x1, esr_el1</span><br><span class="line">    mrs    x2, elr_el1</span><br><span class="line">    mrs    x3, daif</span><br><span class="line">    mrs    x4, vbar_el1</span><br><span class="line">    mrs    x5, spsr_el1</span><br><span class="line">    sub    x6, sp, #(<span class="number">8</span>*<span class="number">30</span>)</span><br><span class="line">    mrs    x7, sctlr_el1</span><br><span class="line">    mov    x8, #<span class="number">0</span></span><br><span class="line">    mrs    x9, ttbr0_el1</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line">    stp     x2, x0, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x3, x1, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x5, x4, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x7, x6, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    stp    x9, x8, [sp, #<span class="number">-16</span>]!</span><br><span class="line">    mov    x0, sp</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exception_exit:</span><br><span class="line">    add    sp, sp, #(<span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">    ldp    x2, x0, [sp],#<span class="number">16</span></span><br><span class="line">    switch_el x11, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line"><span class="number">3</span>:    msr    elr_el3, x2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    msr    elr_el2, x2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    msr    elr_el1, x2</span><br><span class="line"><span class="number">0</span>:</span><br><span class="line">    ldp    x1, x2, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x3, x4, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x5, x6, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x7, x8, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x9, x10, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x11, x12, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x13, x14, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x15, x16, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x17, x18, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x19, x20, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x21, x22, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x23, x24, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x25, x26, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x27, x28, [sp],#<span class="number">16</span></span><br><span class="line">    ldp    x29, x30, [sp],#<span class="number">16</span></span><br><span class="line">    eret</span><br><span class="line"></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\lib\crt0_64.S*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\include\generated\generic-asm-offsets.h*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ENTRY(_main)</span><br><span class="line">    .equ SCTLR_A_BIT,        (<span class="number">1</span> &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    .equ SCTLR_SA_BIT,        (<span class="number">1</span> &lt;&lt; <span class="number">3</span>)</span><br><span class="line">    .equ SCTLR_I_BIT,        (<span class="number">1</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up initial C runtime environment and call board_init_f(0).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">    ldr    x0, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line">    bic    sp, x0, #<span class="number">0xf</span>    <span class="comment">/* 16-byte alignment for ABI compliance */</span></span><br><span class="line">    <span class="comment">//mov    x0, sp</span></span><br><span class="line">    <span class="comment">//bl    board_init_f_alloc_reserve</span></span><br><span class="line">    <span class="comment">//mov    sp, x0</span></span><br><span class="line">    <span class="comment">/* set up gd here, outside any C code */</span></span><br><span class="line">    <span class="comment">//mov    x18, x0</span></span><br><span class="line">    <span class="comment">//bl    board_init_f_init_reserve</span></span><br><span class="line">    <span class="comment">//bl    board_init_f_init_serial</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//mov    x0, #0</span></span><br><span class="line">    bl    main</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up intermediate environment (new sp and gd) and call</span></span><br><span class="line"><span class="comment"> * relocate_code(addr_moni). Trick here is that we.ll return</span></span><br><span class="line"><span class="comment"> * here but relocated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    ldr    x0, [x18, #GD_START_ADDR_SP]    <span class="comment">/* x0 &lt;- gd-&gt;start_addr_sp */</span></span><br><span class="line">    bic    sp, x0, #<span class="number">0xf</span>    <span class="comment">/* 16-byte alignment for ABI compliance */</span></span><br><span class="line">    ldr    x18, [x18, #GD_NEW_GD]        <span class="comment">/* x18 &lt;- gd-&gt;new_gd */</span></span><br><span class="line"></span><br><span class="line">    adr    lr, relocation_return</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Add in link-vs-relocation offset */</span></span><br><span class="line">    ldr    x9, [x18, #GD_RELOC_OFF]    <span class="comment">/* x9 &lt;- gd-&gt;reloc_off */</span></span><br><span class="line">    add    lr, lr, x9    <span class="comment">/* new return address after relocation */</span></span><br><span class="line">    ldr    x0, [x18, #GD_RELOCADDR]    <span class="comment">/* x0 &lt;- gd-&gt;relocaddr */</span></span><br><span class="line">    b    relocate_code</span><br><span class="line"></span><br><span class="line">relocation_return:</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Set up final (full) environment</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    bl    c_runtime_cpu_setup        <span class="comment">/* still call old routine */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Clear BSS section</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    ldr    x0, =__bss_start        <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">    ldr    x1, =__bss_end            <span class="comment">/* this is auto-relocated! */</span></span><br><span class="line">clear_loop:</span><br><span class="line">    str    xzr, [x0], #<span class="number">8</span></span><br><span class="line">    cmp    x0, x1</span><br><span class="line">    b.lo    clear_loop</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* call board_init_r(gd_t *id, ulong dest_addr) */</span></span><br><span class="line">    <span class="comment">//mov    x0, x18                /* gd_t */</span></span><br><span class="line">    <span class="comment">//ldr    x1, [x18, #GD_RELOCADDR]    /* dest_addr */</span></span><br><span class="line">    <span class="comment">//b    board_init_r            /* PC relative jump */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* NOTREACHED - board_init_r() does not return */</span></span><br><span class="line"></span><br><span class="line">ENDPROC(_main)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*F:\Rock4Plus_Android10\u-boot\arch\arm\lib\relocate_64.S*/</span></span><br><span class="line">#define R_AARCH64_RELATIVE    <span class="number">1027</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * void relocate_code (addr_moni)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function relocates the monitor code.</span></span><br><span class="line"><span class="comment"> * x0 holds the destination address.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ENTRY(relocate_code)</span><br><span class="line">    stp    x29, x30, [sp, #<span class="number">-32</span>]!    <span class="comment">/* create a stack frame */</span></span><br><span class="line">    mov    x29, sp</span><br><span class="line">    str    x0, [sp, #<span class="number">16</span>]</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Copy u-boot from flash to RAM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    adr    x1, __image_copy_start    <span class="comment">/* x1 &lt;- Run &amp;__image_copy_start */</span></span><br><span class="line">    subs    x9, x0, x1        <span class="comment">/* x8 &lt;- Run to copy offset */</span></span><br><span class="line">    b.eq    relocate_done        <span class="comment">/* skip relocation */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Dont ldr x1, __image_copy_start here, since if the code is already</span></span><br><span class="line"><span class="comment">     * running at an address other than it was linked to, that instruction</span></span><br><span class="line"><span class="comment">     * will load the relocated value of __image_copy_start. To</span></span><br><span class="line"><span class="comment">     * correctly apply relocations, we need to know the linked value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Linked &amp;__image_copy_start, which we know was at</span></span><br><span class="line"><span class="comment">     * CONFIG_SYS_TEXT_BASE, which is stored in _TEXT_BASE, as a non-</span></span><br><span class="line"><span class="comment">     * relocated value, since it isnt a symbol reference.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ldr    x1, _TEXT_BASE        <span class="comment">/* x1 &lt;- Linked &amp;__image_copy_start */</span></span><br><span class="line">    subs    x9, x0, x1        <span class="comment">/* x9 &lt;- Link to copy offset */</span></span><br><span class="line"></span><br><span class="line">    adr    x1, __image_copy_start    <span class="comment">/* x1 &lt;- Run &amp;__image_copy_start */</span></span><br><span class="line">    adr    x2, __image_copy_end    <span class="comment">/* x2 &lt;- Run &amp;__image_copy_end */</span></span><br><span class="line">copy_loop:</span><br><span class="line">    ldp    x10, x11, [x1], #<span class="number">16</span>    <span class="comment">/* copy from source address [x1] */</span></span><br><span class="line">    stp    x10, x11, [x0], #<span class="number">16</span>    <span class="comment">/* copy to   target address [x0] */</span></span><br><span class="line">    cmp    x1, x2            <span class="comment">/* until source end address [x2] */</span></span><br><span class="line">    b.lo    copy_loop</span><br><span class="line">    str    x0, [sp, #<span class="number">24</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Fix .rela.dyn relocations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    adr    x2, __rel_dyn_start    <span class="comment">/* x2 &lt;- Run &amp;__rel_dyn_start */</span></span><br><span class="line">    adr    x3, __rel_dyn_end    <span class="comment">/* x3 &lt;- Run &amp;__rel_dyn_end */</span></span><br><span class="line">fixloop:</span><br><span class="line">    ldp    x0, x1, [x2], #<span class="number">16</span>    <span class="comment">/* (x0,x1) &lt;- (SRC location, fixup) */</span></span><br><span class="line">    ldr    x4, [x2], #<span class="number">8</span>        <span class="comment">/* x4 &lt;- addend */</span></span><br><span class="line">    <span class="keyword">and</span>    x1, x1, #<span class="number">0xffffffff</span></span><br><span class="line">    cmp    x1, #R_AARCH64_RELATIVE</span><br><span class="line">    bne    fixnext</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* relative fix: store addend plus offset at dest location */</span></span><br><span class="line">    add    x0, x0, x9</span><br><span class="line">    add    x4, x4, x9</span><br><span class="line">    str    x4, [x0]</span><br><span class="line">fixnext:</span><br><span class="line">    cmp    x2, x3</span><br><span class="line">    b.lo    fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line">    switch_el x1, <span class="number">3f</span>, <span class="number">2f</span>, <span class="number">1f</span></span><br><span class="line">    bl    hang</span><br><span class="line"><span class="number">3</span>:    mrs    x0, sctlr_el3</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">2</span>:    mrs    x0, sctlr_el2</span><br><span class="line">    b    <span class="number">0f</span></span><br><span class="line"><span class="number">1</span>:    mrs    x0, sctlr_el1</span><br><span class="line"><span class="number">0</span>:    tbz    w0, #<span class="number">2</span>, <span class="number">5f</span>    <span class="comment">/* skip flushing cache if disabled */</span></span><br><span class="line">    tbz    w0, #<span class="number">12</span>, <span class="number">4f</span>    <span class="comment">/* skip invalidating i-cache if disabled */</span></span><br><span class="line">    ic    iallu        <span class="comment">/* i-cache invalidate all */</span></span><br><span class="line">    isb    sy</span><br><span class="line"><span class="number">4</span>:    ldp    x0, x1, [sp, #<span class="number">16</span>]</span><br><span class="line">    bl    __asm_flush_dcache_range</span><br><span class="line"><span class="number">5</span>:    ldp    x29, x30, [sp],#<span class="number">32</span></span><br><span class="line">    ret</span><br><span class="line">ENDPROC(relocate_code)</span><br><span class="line"></span><br><span class="line"><span class="comment">//.popsection</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * void __asm_flush_dcache_range(start, end)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * clean &amp; invalidate data cache in the range</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * x0: start address</span></span><br><span class="line"><span class="comment"> * x1: end address</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//.pushsection .text.__asm_flush_dcache_range, &quot;ax&quot;</span></span><br><span class="line">ENTRY(__asm_flush_dcache_range)</span><br><span class="line">    mrs    x3, ctr_el0</span><br><span class="line">    lsr    x3, x3, #<span class="number">16</span></span><br><span class="line">    <span class="keyword">and</span>    x3, x3, #<span class="number">0xf</span></span><br><span class="line">    mov    x2, #<span class="number">4</span></span><br><span class="line">    lsl    x2, x2, x3        <span class="comment">/* cache line size */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* x2 &lt;- minimal cache line size in cache system */</span></span><br><span class="line">    sub    x3, x2, #<span class="number">1</span></span><br><span class="line">    bic    x0, x0, x3</span><br><span class="line"><span class="number">1</span>:    dc    civac, x0    <span class="comment">/* clean &amp; invalidate data or unified cache */</span></span><br><span class="line">    add    x0, x0, x2</span><br><span class="line">    cmp    x0, x1</span><br><span class="line">    b.lo    <span class="number">1b</span></span><br><span class="line">    dsb    sy</span><br><span class="line">    ret</span><br><span class="line">ENDPROC(__asm_flush_dcache_range)</span><br><span class="line"></span><br><span class="line">ENTRY(hang)</span><br><span class="line">    bl hang</span><br><span class="line">ENDPROC(hang)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>前面的中断初始化完成了，接下来就是注册、使能、执行中断、中断测试几个函数：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;irq.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;led.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;printf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;uart.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Cpu Interface System Registers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_IAR0_EL1        S3_0_C12_C8_0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_IAR1_EL1        S3_0_C12_C12_0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_EOIR0_EL1        S3_0_C12_C8_1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_EOIR1_EL1        S3_0_C12_C12_1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_HPPIR0_EL1        S3_0_C12_C8_2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_HPPIR1_EL1        S3_0_C12_C12_2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_BPR0_EL1        S3_0_C12_C8_3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_BPR1_EL1        S3_0_C12_C12_3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_DIR_EL1            S3_0_C12_C11_1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_PMR_EL1            S3_0_C4_C6_0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_RPR_EL1            S3_0_C12_C11_3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_CTLR_EL1        S3_0_C12_C12_4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_CTLR_EL3        S3_6_C12_C12_4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_SRE_EL1            S3_0_C12_C12_5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_SRE_EL2            S3_4_C12_C9_5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_SRE_EL3            S3_6_C12_C12_5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_IGRPEN0_EL1        S3_0_C12_C12_6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_IGRPEN1_EL1        S3_0_C12_C12_7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_IGRPEN1_EL3        S3_6_C12_C12_7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_SEIEN_EL1        S3_0_C12_C13_0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_SGI0R_EL1        S3_0_C12_C11_7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_SGI1R_EL1        S3_0_C12_C11_5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICC_ASGI1R_EL1        S3_0_C12_C11_6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">s_irq_handler</span> <span class="title">g_irq_handler</span>[<span class="title">NR_IRQS</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">irq_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* gic has been init in Start.S */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enable_interrupts</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;enable_interrupts \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;msr    daifclr, #0x03&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* irq interrupt install handle */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">irq_install_handler</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">interrupt_handler_t</span> *handler, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;irq_install_handler \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_irq_handler[irq].m_func != handler)</span><br><span class="line">        g_irq_handler[irq].m_func = handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* enable irq handler */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">irq_handler_enable</span><span class="params">(<span class="keyword">int</span> irq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;irq_handler_enable start \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> M, N;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (irq &gt;= NR_GIC_IRQS)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    M = irq / <span class="number">32</span>;</span><br><span class="line">    N = irq % <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    GICD-&gt;ISENABLER[M]  = (<span class="number">0x1</span> &lt;&lt; N);</span><br><span class="line">    my_printf(<span class="string">&quot;irq_handler_enable end \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*do_irq*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_do_irq</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;do_irq start \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> nintid;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> irqstat;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;mrs %0, &quot;</span> __stringify(ICC_IAR1_EL1) : <span class="string">&quot;=r&quot;</span> (irqstat))</span></span>;</span><br><span class="line"></span><br><span class="line">    nintid = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)irqstat &amp; <span class="number">0x3FF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* here we use gic id checking, not include gpio pin irq */</span></span><br><span class="line">    <span class="keyword">if</span> (nintid &lt; NR_GIC_IRQS)</span><br><span class="line">        g_irq_handler[nintid].m_func((<span class="keyword">void</span> *)(<span class="keyword">unsigned</span> <span class="keyword">long</span>)nintid);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;msr &quot;</span> __stringify(ICC_EOIR1_EL1) <span class="string">&quot;, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)nintid))</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;msr &quot;</span> __stringify(ICC_DIR_EL1) <span class="string">&quot;, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)nintid))</span></span>;</span><br><span class="line">    isb();</span><br><span class="line">    my_printf(<span class="string">&quot;do_irq end \n\r&quot;</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">board_timer_isr</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;board_timer_isr start \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> led_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* Rockchip RK3399TRM V1.3 Part1.pdf P959</span></span><br><span class="line"><span class="comment">     * TIMER_n_INTSTATUS </span></span><br><span class="line"><span class="comment">     * bit[0] int_pd </span></span><br><span class="line"><span class="comment">     * This register contains the interrupt status for timer n. </span></span><br><span class="line"><span class="comment">     * Write 1 to this register will clear the interrupt. </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    TIMER3-&gt;INTSTATUS = <span class="number">0x01</span>;  <span class="comment">//clrear interrupt</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(led_flag == <span class="number">0</span>)</span><br><span class="line">        led_ctl(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        led_ctl(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    led_flag = !led_flag;</span><br><span class="line">    my_printf(<span class="string">&quot;board_timer_isr end \n\r&quot;</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Rockchip RK3399TRM V1.3 Part1.pdf P960</span></span><br><span class="line"><span class="comment"> * TIMER_n_CONTROLREG </span></span><br><span class="line"><span class="comment"> * Address: Operational Base + offset (0x1c) </span></span><br><span class="line"><span class="comment"> * Timer n Control Register </span></span><br><span class="line"><span class="comment"> * bit[2] int_en Timer interrupt mask, 0: mask 1: not mask</span></span><br><span class="line"><span class="comment"> * bit[1] timer_mode Timer mode. 0: free-running mode 1: user-defined count mode </span></span><br><span class="line"><span class="comment"> * bit[0] timer_en Timer enable. 0: disable 1: enable </span></span><br><span class="line"><span class="comment"> * (1&lt;&lt;0) + (1&lt;&lt;1) + (1&lt;&lt;2) = 5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_timer_irq</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;test_timer_irq start \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* enable exceptions */</span></span><br><span class="line">    enable_interrupts();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* timer set */</span></span><br><span class="line">    </span><br><span class="line">    TIMER3-&gt;CURRENT_VALUE0 = <span class="number">0x0FFFFFF</span>;</span><br><span class="line">    TIMER3-&gt;LOAD_COUNT0    = <span class="number">0x0FFFFFF</span>;</span><br><span class="line">    TIMER3-&gt;CONTROL_REG    = <span class="number">0x05</span>; <span class="comment">//auto reload &amp; enable the timer</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* register and enable */</span></span><br><span class="line">    irq_install_handler(TIMER_INTR3, (<span class="keyword">interrupt_handler_t</span> *)board_timer_isr, (<span class="keyword">void</span> *)(<span class="number">0</span>));</span><br><span class="line">    irq_handler_enable(TIMER_INTR3);</span><br><span class="line">    my_printf(<span class="string">&quot;test_timer_irq end \n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在主函数里对重定位的验证可以尝试定义一个全局变量检查是否正常，对清BSS段的验证可以尝试定义一个未初始化的全局变量检查是否正常，对中断的验证可以测试定时器中断是否正常，GPIO中断通过外接按键检测是否正常：  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;led.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;uart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;printf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;irq.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uart_test</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    uart_init();</span><br><span class="line">    printf_test();</span><br><span class="line">    my_printf(<span class="string">&quot;uart_init ok. \n\r&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    led_init();</span><br><span class="line">    led_ctl(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uart_test();</span><br><span class="line"></span><br><span class="line">    test_timer_irq();    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        led_ctl(<span class="number">1</span>);</span><br><span class="line">        led_delay();</span><br><span class="line"></span><br><span class="line">        led_ctl(<span class="number">0</span>);</span><br><span class="line">        led_delay();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>测试效果：<br>上电后，蓝色LED1间隔闪烁。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/u-boot-timer-irq-ok.png"></p>
</li>
</ul>
<h1 id="5-串口"><a href="#5-串口" class="headerlink" title="5.串口"></a>5.串口</h1><h2 id="5-1-uart代码"><a href="#5-1-uart代码" class="headerlink" title="5.1 uart代码"></a>5.1 uart代码</h2><p>可以看到<code>rk_uart_init()</code>是串口初始化，里面依次调用了引脚复用<code>rk_uart_iomux()</code>、串口复位<code>rk_uart_reset()</code>、设置IRDA SIR功能<code>rk_uart_set_iop()</code>、设置串口属性<code>rk_uart_set_lcr()</code>、设置波特率<code>rk_uart_set_baudrate()</code>、设置串口FIFO<code>rk_uart_set_fifo()</code>。<br>初始化完成后，就可以收发数据了，这里只实现了发生数据<code>rk_uart_sendbyte()</code>。<br>移植的过程还是比较简单，寄存器比较少，注意在设置波特率函数里，需要用到除法，为了简便，可先算出来直接赋值。这里的波特率为最大的1.5M。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;led.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;uart.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Rockchip RK3399TRM V1.3 Part1.pdf</span></span><br><span class="line"><span class="comment"> * GRF(P29)</span></span><br><span class="line"><span class="comment"> * FF76_0000 &amp;&amp; FF77_0000</span></span><br><span class="line"><span class="comment"> * Chapter 2 System Overview (Address Mapping)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define    CRU_BASE                  0xFF760000</span></span><br><span class="line"><span class="comment">//#define    GRF_BASE                  0xFF770000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Rockchip RK3399TRM V1.3 Part1.pdf</span></span><br><span class="line"><span class="comment"> * GRF_GPIO4C_IOMUX</span></span><br><span class="line"><span class="comment"> * Address: Operational Base + offset (0x0e028) </span></span><br><span class="line"><span class="comment"> * GPIO4C iomux control</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *GRF_GPIO4C_IOMUX;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rk_uart_iomux</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GRF_GPIO4C_IOMUX  = (<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *)(<span class="number">0xFF760000</span> + <span class="number">0x0e028</span>);</span><br><span class="line">    *GRF_GPIO4C_IOMUX = (<span class="number">3</span> &lt;&lt; (<span class="number">8</span> + <span class="number">16</span>)) | (<span class="number">3</span> &lt;&lt; (<span class="number">6</span> + <span class="number">16</span>)) | (<span class="number">2</span> &lt;&lt; <span class="number">8</span>) | (<span class="number">2</span> &lt;&lt; <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rk_uart_reset</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* UART reset, rx fifo &amp; tx fifo reset */</span></span><br><span class="line">    UART2_SRR =  (<span class="number">0x01</span> &lt;&lt; <span class="number">1</span>) | (<span class="number">0x01</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    led_ctl(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">/* interrupt disable */</span></span><br><span class="line">    UART2_IER = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rk_uart_set_iop</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UART2_MCR = <span class="number">0x00</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">rk_uart_set_lcr</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UART2_LCR &amp;= ~(<span class="number">0x03</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    UART2_LCR |=  (<span class="number">0x03</span> &lt;&lt; <span class="number">0</span>); <span class="comment">//8bits</span></span><br><span class="line"></span><br><span class="line">    UART2_LCR &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>); <span class="comment">//parity disabled</span></span><br><span class="line"></span><br><span class="line">    UART2_LCR &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">2</span>); <span class="comment">//1 stop bit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rk_uart_set_baudrate</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> rate;</span><br><span class="line">    <span class="comment">//unsigned long baudrate = 1500000;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* uart rate is div for 24M input clock */</span></span><br><span class="line">    <span class="comment">//rate = 24000000 / 16 / baudrate;</span></span><br><span class="line">    rate = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    UART2_LCR |= (<span class="number">0x01</span> &lt;&lt; <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    UART2_DLL = (rate &amp; <span class="number">0xFF</span>);</span><br><span class="line">    UART2_DLH = ((rate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">    UART2_LCR &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">7</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rk_uart_set_fifo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* shadow FIFO enable */</span></span><br><span class="line">    UART2_SFE = <span class="number">0x01</span>;</span><br><span class="line">    <span class="comment">/* fifo 2 less than */</span></span><br><span class="line">    UART2_SRT = <span class="number">0x03</span>;</span><br><span class="line">    <span class="comment">/* 2 char in tx fifo */</span></span><br><span class="line">    UART2_STET = <span class="number">0x01</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uart_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    rk_uart_iomux();</span><br><span class="line">    rk_uart_reset();</span><br><span class="line"></span><br><span class="line">    rk_uart_set_iop();</span><br><span class="line">    rk_uart_set_lcr();</span><br><span class="line"></span><br><span class="line">    rk_uart_set_baudrate();</span><br><span class="line"></span><br><span class="line">    rk_uart_set_fifo();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rk_uart_sendbyte</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((UART2_USR &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">1</span>)) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    UART2_THR = byte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rk_uart_sendstring</span><span class="params">(<span class="keyword">char</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(*ptr)</span><br><span class="line">        rk_uart_sendbyte(*ptr++);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 0xABCDEF12 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rk_uart_sendhex</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> arr[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        arr[i] = val &amp; <span class="number">0xf</span>;</span><br><span class="line">        val &gt;&gt;= <span class="number">4</span>;   <span class="comment">/* arr[0] = 2, arr[1] = 1, arr[2] = 0xF */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* printf */</span></span><br><span class="line">    rk_uart_sendstring(<span class="string">&quot;0x&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &gt;= <span class="number">0</span> &amp;&amp; arr[i] &lt;= <span class="number">9</span>)</span><br><span class="line">            rk_uart_sendbyte(arr[i] + <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(arr[i] &gt;= <span class="number">0xA</span> &amp;&amp; arr[i] &lt;= <span class="number">0xF</span>)</span><br><span class="line">            rk_uart_sendbyte(arr[i] - <span class="number">0xA</span> + <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-2-printf移植"><a href="#5-2-printf移植" class="headerlink" title="5.2 printf移植"></a>5.2 printf移植</h2><p>printf库移植的方法：<br>1.先在<code>printf.h</code>里，用<code>__out_putchar</code>替换成自己实现的字节发送函数<code>rk_uart_sendbyte</code>；<br>2.然后在<code>printf.c</code>里，为其提供宏<code>va_start</code>、<code>va_arg</code>、<code>va_end</code>、<code>_INTSIZEOF</code>和<code>va_list</code>；</p>
<p>在第二步里，之前ARMv7的可以直接使用，现在使用ARMv8，实测发现打印有问题，找到交叉编译工具里对应宏的位置，直接加入头文件<code>stdarg.h</code>即可。  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&quot;printf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>  <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span>   *va_list;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _INTSIZEOF(n)   ( (sizeof(n) + sizeof(int) - 1) &amp; ~(sizeof(int) - 1) )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> va_start(ap,v)  ( ap = (va_list)&amp;v + _INTSIZEOF(v) )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> va_arg(ap,t)    ( *(t *)((ap += _INTSIZEOF(t)) - _INTSIZEOF(t)) )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> va_arg(ap,t)    ( *(t *)( ap=ap + _INTSIZEOF(t), ap- _INTSIZEOF(t)) )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> va_end(ap)      ( ap = (va_list)0 )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/************************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> hex_tab[] = &#123;<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, \</span><br><span class="line">                           <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span></span><br><span class="line">                          &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">outc</span><span class="params">(<span class="keyword">int</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __out_putchar(c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">outs</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (*s != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">        __out_putchar(*s++);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">out_num</span><span class="params">(<span class="keyword">long</span> n, <span class="keyword">int</span> base, <span class="keyword">char</span> lead, <span class="keyword">int</span> maxwidth)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> m = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[MAX_NUMBER_BYTES], *s = buf + <span class="keyword">sizeof</span>(buf);</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>, i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    *--s = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">        m = -n;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        m = n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        *--s = hex_tab[m % base];</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((m /= base) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( maxwidth &amp;&amp; count &lt; maxwidth)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = maxwidth - count; i; i--)</span><br><span class="line">            *--s = lead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">        *--s = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outs(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*ref: int vprintf(const char *format, va_list ap); */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_vprintf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, va_list ap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> lead = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    <span class="keyword">int</span>  maxwidth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(; *fmt != <span class="string">&#x27;\0&#x27;</span>; fmt++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (*fmt != <span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            outc(*fmt);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        lead=<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        maxwidth=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//format : %08d, %8d,%d,%u,%x,%f,%c,%s</span></span><br><span class="line">        fmt++;</span><br><span class="line">        <span class="keyword">if</span>(*fmt == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            lead = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            fmt++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(*fmt &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; *fmt &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            maxwidth *= <span class="number">10</span>;</span><br><span class="line">            maxwidth += (*fmt - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            fmt++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (*fmt)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            out_num(va_arg(ap, <span class="keyword">int</span>),          <span class="number">10</span>, lead, maxwidth);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">            out_num(va_arg(ap, <span class="keyword">unsigned</span> <span class="keyword">int</span>),  <span class="number">8</span>, lead, maxwidth);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">            out_num(va_arg(ap, <span class="keyword">unsigned</span> <span class="keyword">int</span>), <span class="number">10</span>, lead, maxwidth);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">            out_num(va_arg(ap, <span class="keyword">unsigned</span> <span class="keyword">int</span>), <span class="number">16</span>, lead, maxwidth);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">            outc(va_arg(ap, <span class="keyword">int</span>   ));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">            outs(va_arg(ap, <span class="keyword">char</span> *));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            outc(*fmt);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ref: int printf(const char *format, ...);</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    va_list ap;</span><br><span class="line"></span><br><span class="line">    va_start(ap, fmt);</span><br><span class="line">    my_vprintf(fmt, ap);</span><br><span class="line">    va_end(ap);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    my_printf(<span class="string">&quot;=========This is printf test=========\n\r&quot;</span>);</span><br><span class="line">    my_printf(<span class="string">&quot;test char            = %c,%c,%c\n\r&quot;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;j&#x27;</span>);</span><br><span class="line">    my_printf(<span class="string">&quot;test decimal1 number = %d\n\r&quot;</span>,     <span class="number">123456</span>);</span><br><span class="line">    my_printf(<span class="string">&quot;test decimal2 number = %d\n\r&quot;</span>,     <span class="number">-123456</span>);</span><br><span class="line">    my_printf(<span class="string">&quot;test hex1    number  = 0x%x\n\r&quot;</span>,   <span class="number">0x123456</span>);</span><br><span class="line">    my_printf(<span class="string">&quot;test hex2    number  = 0x%08x\n\r&quot;</span>, <span class="number">0x123456</span>);</span><br><span class="line">    my_printf(<span class="string">&quot;test string          = %s\n\r&quot;</span>,    <span class="string">&quot;www.hermitme.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">puts</span><span class="params">(<span class="keyword">char</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(*ptr)</span><br><span class="line">        rk_uart_sendbyte(*ptr++);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>测试效果：</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/u-boot-uart-ok.png"></p>
<h1 id="6-定时器"><a href="#6-定时器" class="headerlink" title="6.定时器"></a>6.定时器</h1><p>RK3399有12个通用定时器(timer0<del>timer11)、12个安全定时器(stimer0</del>stimer11)、2个PMU定时器(pmutimer0~pmutimer1)。<br>定时器部分比较简单，很多东西都是固定的，比如定时器的时钟来源都是24MHz的晶振，也就是定时器周期为1/24us。此外定时器的计数只能由小向大增加。<br>定时器支持两种模式:自由运行模式和用户自定义模式，其实就是前者计数达到设定值后，自动装载计数循环，后者需要手动重新装载，实现循环。</p>
<h2 id="6-1-编程思路"><a href="#6-1-编程思路" class="headerlink" title="6.1 编程思路"></a>6.1 编程思路</h2><p>这里希望通过用定时器实现一个比较准确的延时函数，包括us、ms、s的延时。<br>1.首先设置<code>CONTROLREG</code>，关闭定时器、设置为用户定义计数模式(用户确定循环次数)、中断屏蔽(不需要中断处理函数)；<br>2.向<code>LOAD_COUNT0</code>、<code>LOAD_COUNT1</code>放入计数结束值，向<code>LOAD_COUNT2</code>、<code>LOAD_COUNT3</code>放入计数初始值，默认为0；<br>3.设置<code>CONTROLREG</code>，开启定时器，计数器开始运行；<br>4.读取中断状态<code>INTSTATUS</code>判断时候完成计数，清中断，本次计数完成；</p>
<h2 id="6-2-实现代码"><a href="#6-2-实现代码" class="headerlink" title="6.2 实现代码"></a>6.2 实现代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//timer4 is used for delay.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay_us</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span>  i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> count_value = <span class="number">24</span> * i;  <span class="comment">//24MHz; period=(1/24000000)*1000000=1/24us</span></span><br><span class="line"></span><br><span class="line">    TIMER4-&gt;CONTROL_REG &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);     <span class="comment">//Timer disable</span></span><br><span class="line">    TIMER4-&gt;CONTROL_REG |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">1</span>);     <span class="comment">//Timer mode:user-defined count mode</span></span><br><span class="line">    TIMER4-&gt;CONTROL_REG &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">2</span>);     <span class="comment">//Timer interrupt mask</span></span><br><span class="line"></span><br><span class="line">    TIMER4-&gt;LOAD_COUNT0 = count_value &amp; <span class="number">0xFFFFFFFF</span>; <span class="comment">//load_count_low bits</span></span><br><span class="line">    TIMER4-&gt;LOAD_COUNT1 = (count_value &gt;&gt; <span class="number">32</span>);      <span class="comment">//load_count_high bits</span></span><br><span class="line">    </span><br><span class="line">    TIMER4-&gt;CONTROL_REG |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);     <span class="comment">//Timer enable</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!(TIMER4-&gt;INTSTATUS &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>)));</span><br><span class="line">    TIMER4-&gt;INTSTATUS |= (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);        <span class="comment">//Write 1 clear the interrupt</span></span><br><span class="line"></span><br><span class="line">    TIMER4-&gt;CONTROL_REG &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);     <span class="comment">//Timer enable disable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay_ms</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">        delay_us(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay_s</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">        delay_ms(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7-ADC"><a href="#7-ADC" class="headerlink" title="7.ADC"></a>7.ADC</h1><p>RK3399有两类ADC：</p>
<ul>
<li>TS-ADC(Temperature Sensor):<br>　　内嵌的两路ADC，一路检测CPU温度，一路检测GPU温度；<br>　　ADC精度10bit，时钟频率必须低于800KHZ;<br>　　测量范围为-40℃~125℃，精度只有5℃；<br>　　支持用户自定义和自动模式(前者用户自己控制，后者控制器自动查询)；</li>
<li>SAR-ADC(Successive Approximation Register):<br>　　六路ADC，精度10bit；<br>　　时钟频率必须小于13MHZ;</li>
</ul>
<h2 id="7-1-编程思路"><a href="#7-1-编程思路" class="headerlink" title="7.1 编程思路"></a>7.1 编程思路</h2><p>这里希望通过用SAR-ADC获取外部ADC值，通过TS-ADC获取内部CPU/GPU温度。</p>
<ul>
<li><p>SAR-ADC<br>1.首先设置<code>SARADC_CTRL[3]</code>，关闭ADC；<br>2.设置<code>SARADC_CTRL[2:0]</code>，选择ADC通道；<br>3.设置<code>SARADC_CTRL[3]</code>，启动ADC转换；<br>4.读取ADC状态<code>SARADC_STAS</code>判断是否转换完成；<br>5.读取ADC数据<code>SARADC_DATA</code>；</p>
</li>
<li><p>TS-ADC(User-Define Mode)<br>1.首先设置<code>TSADC_AUTO_CON</code>为用户定义模式、ADC值与温度值负关系；<br>2.设置<code>TSADC_USER_CON</code>选择通道、复位、转换开始；<br>3.设置<code>TSADC_INT_EN</code>，使能ADC完成中断；<br>4.读取ADC中断状态<code>TSADC_INT_PD</code>判断是否转换完成，并清理；<br>5.根据选择的通道，从对应的<code>TSADC_DATA0</code>或<code>TSADC_DATA1</code>读取ADC数据；</p>
</li>
</ul>
<p>这里的TS-ADC得到的数值和温度并不是完全的线性关系，根据提供的表格，可以计算出一个大致的线性关系：<code>y = 0.5823x - 273.62</code></p>
<h2 id="7-2-实现代码"><a href="#7-2-实现代码" class="headerlink" title="7.2 实现代码"></a>7.2 实现代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;uart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;printf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;int.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;adc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">get_saradc_val</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//delay between power up and start command</span></span><br><span class="line">    <span class="comment">//SARADC_DLY_PU_SOC = 8; //DLY_PU_SOC + 2</span></span><br><span class="line"></span><br><span class="line">    SARADC_CTRL &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>); <span class="comment">//ADC power down control bit</span></span><br><span class="line"></span><br><span class="line">    SARADC_CTRL |= (channel &lt;&lt; <span class="number">0</span>); <span class="comment">//ADC input source selection</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//SARADC_CTRL |= (0x01&lt;&lt;3); //Interrupt enable.</span></span><br><span class="line"></span><br><span class="line">    SARADC_CTRL |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>); <span class="comment">//ADC power up and reset</span></span><br><span class="line">    delay_us(<span class="number">100</span>); <span class="comment">//不能立即就判断状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(SARADC_STAS &amp; <span class="number">0x01</span>); <span class="comment">//The status register of A/D Converter 1’b0: ADC stop</span></span><br><span class="line"></span><br><span class="line">    val = SARADC_DATA &amp; <span class="number">0x3FF</span>; <span class="comment">//A/D value of the last conversion (DOUT[9:0]).</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//channel0: CPU temperature</span></span><br><span class="line"><span class="comment">//channel1: GPU temperature</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_tsadc_temp</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((channel != <span class="number">0</span>) &amp;&amp; (channel != <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;get_tsadc_temp set channel error.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-255</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//User-Define Mode</span></span><br><span class="line">    TSADC_AUTO_CON &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);     <span class="comment">//TSADC controller works at user-define mode</span></span><br><span class="line">    TSADC_AUTO_CON |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">1</span>);     <span class="comment">//RK3399 is negative temprature coefficient</span></span><br><span class="line"></span><br><span class="line">    TSADC_USER_CON &amp;= ~(<span class="number">0x07</span> &lt;&lt; <span class="number">0</span>);     <span class="comment">//clear</span></span><br><span class="line">    TSADC_USER_CON |=  (channel &lt;&lt; <span class="number">0</span>);  <span class="comment">//PD_DVDD and ADC input source selection</span></span><br><span class="line">    TSADC_USER_CON |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>);     <span class="comment">//CHSEL_DVDD and ADC power up and reset</span></span><br><span class="line"></span><br><span class="line">    TSADC_USER_CON |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>);     <span class="comment">//the start_of_conversion will be controlled by TSADC_USER_CON[5].</span></span><br><span class="line">    TSADC_USER_CON |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">5</span>);     <span class="comment">//start conversion</span></span><br><span class="line"></span><br><span class="line">    TSADC_INT_EN   |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">16</span>);    <span class="comment">//eoc_interrupt enable in user defined mode</span></span><br><span class="line">    <span class="keyword">while</span>(!(TSADC_INT_PD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">16</span>))); <span class="comment">//wait ADC conversion stop</span></span><br><span class="line">    TSADC_INT_PD &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == channel)</span><br><span class="line">        val = (<span class="keyword">int</span>)(<span class="number">0.5823</span> * (<span class="keyword">float</span>)(TSADC_DATA0) - <span class="number">273.62</span>); <span class="comment">//y = 0.5823x - 273.62</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        val = (<span class="keyword">int</span>)(<span class="number">0.5823</span> * (<span class="keyword">float</span>)(TSADC_DATA1) - <span class="number">273.62</span>); <span class="comment">//y = 0.5823x - 273.62</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get_tsadc_temp = %d \n&quot;</span>, val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试效果：</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/u-boot-adc-ok.png"></p>
<h1 id="8-I2C"><a href="#8-I2C" class="headerlink" title="8.I2C"></a>8.I2C</h1><p>RK3399拥有8个I2C，其功能和其它SOC的I2C差不多，这里通过I2C读写EEPROM。</p>
<h2 id="8-1-编程思路"><a href="#8-1-编程思路" class="headerlink" title="8.1 编程思路"></a>8.1 编程思路</h2><p>0.首先是I2C引脚复用、设置SCK时钟、注册/使能中断(非必须)等；</p>
<ul>
<li><p>写EEPROM<br>1.清空控制寄存器<code>CON</code>并使能；<br>2.设置I2C模式<code>transmit only</code>；<br>3.设置<code>CON</code>启动开始信号，并读取<code>IPD</code>等待开始信号发送完成；<br>4.设置<code>TXDATA0</code>实现从机地址、写地址、数据的设定，设置传输数据个数，等待传输完成；<br>5.设置<code>CON</code>发送结束信号，并读取<code>IPD</code>等待结束信号发送完成；</p>
</li>
<li><p>读EEPROM<br>1.清空控制寄存器<code>CON</code>并使能；<br>2.设置I2C模式<code>transmit only + restart + transmit address + receive only</code>；<br>3.设置<code>MRXADDR</code>设定从机地址，设置<code>MRXRADDR</code>设定从机寄存器地址；<br>4.设置<code>TXDATA0</code>实现从机地址、写地址、数据的设定，设置传输数据个数，等待传输完成；<br>5.设置<code>MRXCNT</code>值接收一个数据，读取<code>IPD</code>等待接收数据完成；<br>6.设置<code>CON</code>发送结束信号，并读取<code>IPD</code>等待结束信号发送完成；<br>7.读取<code>RXDATA0</code>获得数据；</p>
</li>
</ul>
<h2 id="8-2-实现代码"><a href="#8-2-实现代码" class="headerlink" title="8.2 实现代码"></a>8.2 实现代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;i2c.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;uart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;printf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//GPIO1_B3/I2C4_SDA</span></span><br><span class="line"><span class="comment">//GPIO1_B4/I2C4_SCL</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">i2c_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.GPIO1_B3/I2C4_SDA、GPIO1_B4/I2C4_SCL设置为功能引脚,注意高位要先置为1才能写;</span></span><br><span class="line">    PMUGRF_GPIO1B_IOMUX |= ((<span class="number">0xFFFF0000</span> &lt;&lt; <span class="number">0</span>) | (<span class="number">0x01</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">0x01</span> &lt;&lt; <span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.设置SCK时钟</span></span><br><span class="line">    <span class="comment">//3.注册/使能中断</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eeprom_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//0.清空控制寄存器并使能</span></span><br><span class="line">    I2C4-&gt;CON &amp;= ~(<span class="number">0x7F</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    I2C4-&gt;IPD &amp;= ~(<span class="number">0x7F</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    I2C4-&gt;CON |= <span class="number">0x01</span> &lt;&lt; <span class="number">0</span>; <span class="comment">//使能</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.设置模式:transmit only</span></span><br><span class="line">    I2C4-&gt;CON &amp;= ~(<span class="number">0x03</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.开始信号</span></span><br><span class="line">    I2C4-&gt;CON |= <span class="number">0x01</span> &lt;&lt; <span class="number">3</span>; <span class="comment">//开始信号</span></span><br><span class="line">    <span class="keyword">while</span>(!(I2C4-&gt;IPD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>))); <span class="comment">//等待开始信号发完</span></span><br><span class="line">    I2C4-&gt;IPD |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>); <span class="comment">//清开始信号标志</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.I2C从机地址+写地址+数据 (3个字节)</span></span><br><span class="line">    I2C4-&gt;TXDATA0 = <span class="number">0x46</span> | (addr &lt;&lt; <span class="number">8</span>) | (data &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    I2C4-&gt;MTXCNT = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">while</span>(!(I2C4-&gt;IPD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">2</span>))); <span class="comment">//MTXCNT data transmit finished interrupt pending bit</span></span><br><span class="line">    I2C4-&gt;IPD |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.结束信号</span></span><br><span class="line">    I2C4-&gt;CON &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>); <span class="comment">//手动清除start(注意:前面的开始信号控制位理论会自动清0,实测没有,这里必须手动清,否则是开始信号)</span></span><br><span class="line">    I2C4-&gt;CON |= (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">while</span>(!(I2C4-&gt;IPD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">5</span>)));</span><br><span class="line">    I2C4-&gt;IPD |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动发送从机地址和从机寄存器地址</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">eeprom_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.清空控制寄存器并使能</span></span><br><span class="line">    I2C4-&gt;CON &amp;= ~(<span class="number">0x7F</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    I2C4-&gt;IPD &amp;= ~(<span class="number">0x7F</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    I2C4-&gt;CON |= <span class="number">0x01</span> &lt;&lt; <span class="number">0</span>; <span class="comment">//使能</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//必须收到ack,否则停止传输(非必需)</span></span><br><span class="line">    <span class="comment">//I2C4-&gt;CON |=  (0x01&lt;&lt;6); //stop transaction when NAK handshake is received</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.设置模式:transmit address (device + register address) --&gt; restart --&gt; transmit address –&gt; receive only</span></span><br><span class="line">    I2C4-&gt;CON |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">1</span>); <span class="comment">//自动发送从机地址和从机寄存器地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.从机地址</span></span><br><span class="line">    I2C4-&gt;MRXADDR = (<span class="number">0x46</span> | (<span class="number">1</span> &lt;&lt; <span class="number">24</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.从机寄存器地址</span></span><br><span class="line">    I2C4-&gt;MRXRADDR = (addr | (<span class="number">1</span> &lt;&lt; <span class="number">24</span>)); <span class="comment">//地址只有6位,超过6位怎么办?</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.开始信号</span></span><br><span class="line">    I2C4-&gt;CON |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">while</span>(!(I2C4-&gt;IPD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>)));</span><br><span class="line">    I2C4-&gt;IPD |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.接收一个数据且不响应</span></span><br><span class="line">    I2C4-&gt;CON |= (<span class="number">0x01</span> &lt;&lt; <span class="number">5</span>);</span><br><span class="line">    I2C4-&gt;MRXCNT = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(!(I2C4-&gt;IPD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>)));</span><br><span class="line">    I2C4-&gt;IPD |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.结束信号</span></span><br><span class="line">    I2C4-&gt;CON &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>); <span class="comment">//手动清除start</span></span><br><span class="line">    I2C4-&gt;CON |= (<span class="number">0x01</span> &lt;&lt; <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">while</span>(!(I2C4-&gt;IPD &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">5</span>)));</span><br><span class="line">    I2C4-&gt;IPD |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (I2C4-&gt;RXDATA0 &amp; <span class="number">0xFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主函数里先向EEPROM(0x46地址不是连的EEPROM)写数据，再读出数据并打印出来，是否是预期的值。  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">i2c_test</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    i2c_init();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//write eeprom.</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//eeprom_write(i,2*i);</span></span><br><span class="line">        delay_ms(<span class="number">4</span>);<span class="comment">//Must be delayed more than 4ms.</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    my_printf(<span class="string">&quot;write eeprom ok\n\r&quot;</span>);</span><br><span class="line">    delay_ms(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//read eeprom.</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        my_printf(<span class="string">&quot;read_data%d = %d\n\r&quot;</span>, i, eeprom_read(i));</span><br><span class="line">        delay_ms(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>测试效果(0x46地址不是连的EEPROM，i2c测试失败，以后填坑)：</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/u-boot-i2c-read-ok.png"></p>
<h1 id="9-SPI"><a href="#9-SPI" class="headerlink" title="9.SPI"></a>9.SPI</h1><p>RK3399有6组SPI，协议也是标准的，没什么好说的。通过SPI读取Flash，也实现了两个版本：GPIO模拟和寄存器控制，这里主要介绍寄存器控制版本。</p>
<h2 id="9-1-编程思路"><a href="#9-1-编程思路" class="headerlink" title="9.1 编程思路"></a>9.1 编程思路</h2><p>0.首先是SPI引脚复用、设置时钟、SPI模式(SCPH=1，SCPOL=1)等；<br>1.实现发送一字节函数：使能SPI、向<code>TXDR[0]</code>写入待发送的数据、根据<code>SR</code>等待发送完成及空闲、关闭SPI；<br>2.实现接收一字节函数：使能SPI、向<code>TXDR[0]</code>写入空数据、根据<code>SR</code>等待接收完成及空闲、读出<code>RXDR[0]</code>数据、关闭SPI；<br>3.实现片选函数；<br>4.剩下的就是SPI Flash(W25Q16DV)相关的操作，比如发送哪个指令读取ID，发送哪个指令擦除数据等，参考具体的Flash芯片手册；</p>
<p>值得注意的几点有：<br>1.SPI Flash(W25Q16DV)每次写操作某个分区前都得先擦除该分区；<br>2.注意片选的连续性，比如写使能指令(0x06)和写状态寄存器指令(0x01)之间的片选不能中断；</p>
<h2 id="9-2-实现代码"><a href="#9-2-实现代码" class="headerlink" title="9.2 实现代码"></a>9.2 实现代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spi.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;uart.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;printf.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;gpio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;grf.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//SPI1_CSn0/GPIO1_B2_U</span></span><br><span class="line">    <span class="comment">//SPI1_CLK/GPIO1_B1_U</span></span><br><span class="line">    <span class="comment">//SPI1_TXD/GPIO1_B0_U</span></span><br><span class="line">    <span class="comment">//SPI1_RXD/GPIO1_A7_U</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.IOMUX</span></span><br><span class="line">    PMUGRF_GPIO1A_IOMUX = <span class="number">0xFFFF8000</span>;</span><br><span class="line">    PMUGRF_GPIO1B_IOMUX = <span class="number">0xFFFF002A</span>;</span><br><span class="line"></span><br><span class="line">    SPI1-&gt;ENR &amp;=  ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>); <span class="comment">//关闭SPI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.Clock Ratios   master mode:Fspi_clk&gt;= 2 × (maximum Fsclk_out)</span></span><br><span class="line">    <span class="comment">//CRU_CLKGATE2_CON &amp;= ~(0x01&lt;&lt;9);  //默认SPI1 source clock开启</span></span><br><span class="line">    <span class="comment">//CRU_CLKGATE6_CON &amp;= ~(0x01&lt;&lt;4);  //默认SPI1 APB clock开启</span></span><br><span class="line">    SPI1-&gt;BAUDR = <span class="number">24</span>; <span class="comment">//Fsclk_out = 48/24= 2M   48 &gt;= 2x2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.注册/使能中断(本程序未使用,用的查询)</span></span><br><span class="line">    <span class="comment">//register_irq(IRQ_SPI1, spi_irq_isr);</span></span><br><span class="line">    <span class="comment">//irq_handler_enable(IRQ_SPI1);</span></span><br><span class="line">    <span class="comment">//SPI1-&gt;IPR &amp;= ~(0x01&lt;&lt;4); //Active Interrupt Polarity Level is HIGH(default)</span></span><br><span class="line">    <span class="comment">//SPI1-&gt;IMR |=  ((0x01&lt;&lt;4) | (0x01&lt;&lt;3) | (0x01&lt;&lt;2) | (0x01&lt;&lt;1) | (0x01&lt;&lt;0)); //Interrupt Mask</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.DMA(可以不用)</span></span><br><span class="line">    <span class="comment">//SPI1-&gt;DMACR |= ((0x01&lt;&lt;1) | (0x01&lt;&lt;0)); // Transmit/Receive DMA enabled</span></span><br><span class="line">    <span class="comment">//SPI1-&gt;DMATDLR = 1; //?</span></span><br><span class="line">    <span class="comment">//SPI1-&gt;DMARDLR = 1; //?</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.SPI模式</span></span><br><span class="line">    <span class="comment">//[1:0]Data Frame Size:8bit data</span></span><br><span class="line">    <span class="comment">//[5:2]Control Frame Size:8-bit serial data transfer</span></span><br><span class="line">    <span class="comment">//[6]SCPH:Serial clock toggles at start of first data bit</span></span><br><span class="line">    <span class="comment">//[7]SCPOL:Inactive state of serial clock is high</span></span><br><span class="line">    <span class="comment">//[13]BHT:apb 8bit write/read, spi 8bit write/read</span></span><br><span class="line">    <span class="comment">//[19:18]XFM(Transfer Mode):Transmit &amp; Receive(default)</span></span><br><span class="line">    <span class="comment">//[20]OPM(Operation Mode):Master Mode(default)</span></span><br><span class="line"></span><br><span class="line">    SPI1-&gt;CTRLR0 &amp;= ~(<span class="number">0x03</span> &lt;&lt; <span class="number">0</span>) ;</span><br><span class="line">    SPI1-&gt;CTRLR0 |= ((<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>) | (<span class="number">0x07</span> &lt;&lt; <span class="number">2</span>) | (<span class="number">0x01</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">0x01</span> &lt;&lt; <span class="number">7</span>) | (<span class="number">0x01</span> &lt;&lt; <span class="number">13</span>)); <span class="comment">//设置SPI模式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_send_byte</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SPI1-&gt;ENR |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);      <span class="comment">//SPI Enable</span></span><br><span class="line"></span><br><span class="line">    SPI1-&gt;TXDR[<span class="number">0</span>] = val &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">    <span class="keyword">while</span>(!(SPI1-&gt;SR &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">2</span>))); <span class="comment">//Transmit FIFO is empty</span></span><br><span class="line">    <span class="keyword">while</span>(SPI1-&gt;SR &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>));  <span class="comment">//SPI is idle or disabled</span></span><br><span class="line"></span><br><span class="line">    SPI1-&gt;ENR &amp;=  ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);     <span class="comment">//SPI Disable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">spi_recv_byte</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    SPI1-&gt;ENR |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);    <span class="comment">//SPI Enable</span></span><br><span class="line"></span><br><span class="line">    SPI1-&gt;TXDR[<span class="number">0</span>] = <span class="number">0</span>;            <span class="comment">//因为是发送接收模式,FIFO在发送时也会接收数据,这里发送空数据,就可读取数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(SPI1-&gt;SR &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">3</span>)); <span class="comment">//SReceive FIFO is not empty</span></span><br><span class="line">    <span class="keyword">while</span>(SPI1-&gt;SR &amp; (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>)); <span class="comment">//SPI is idle or disabled</span></span><br><span class="line"></span><br><span class="line">    val = SPI1-&gt;RXDR[<span class="number">0</span>] &amp; <span class="number">0xFF</span>;  <span class="comment">//读数据</span></span><br><span class="line"></span><br><span class="line">    SPI1-&gt;ENR &amp;=  ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);  <span class="comment">//SPI Disable,为了清空FIFO</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_flash_set_cs</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!flag)</span><br><span class="line">        SPI1-&gt;SER |=  (<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        SPI1-&gt;SER &amp;= ~(<span class="number">0x01</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 通用部分 */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spi_flash_send_addr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    spi_send_byte(addr &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    spi_send_byte(addr &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    spi_send_byte(addr &amp; <span class="number">0xff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spi_flash_write_enable</span><span class="params">(<span class="keyword">int</span> enable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (enable)</span><br><span class="line">    &#123;</span><br><span class="line">        spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line">        spi_send_byte(<span class="number">0x06</span>);</span><br><span class="line">        spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line">        spi_send_byte(<span class="number">0x04</span>);</span><br><span class="line">        spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">spi_flash_read_status_reg1</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> val;</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x05</span>);</span><br><span class="line">    val = spi_recv_byte();</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">spi_flash_read_status_reg2</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> val;</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x35</span>);</span><br><span class="line">    val = spi_recv_byte();</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spi_flash_wait_when_busy</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (spi_flash_read_status_reg1() &amp; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spi_flash_write_status_reg</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> reg1, <span class="keyword">unsigned</span> <span class="keyword">char</span> reg2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    spi_flash_write_enable(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x01</span>);</span><br><span class="line">    spi_send_byte(reg1);</span><br><span class="line">    spi_send_byte(reg2);</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_wait_when_busy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spi_flash_clear_protect_for_status_reg</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> reg1, reg2;</span><br><span class="line"></span><br><span class="line">    reg1 = spi_flash_read_status_reg1();</span><br><span class="line">    reg2 = spi_flash_read_status_reg2();</span><br><span class="line"></span><br><span class="line">    reg1 &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">7</span>);</span><br><span class="line">    reg2 &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_write_status_reg(reg1, reg2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spi_flash_clear_protect_for_data</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* cmp=0,bp2,1,0=0b000 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> reg1, reg2;</span><br><span class="line"></span><br><span class="line">    reg1 = spi_flash_read_status_reg1();</span><br><span class="line">    reg2 = spi_flash_read_status_reg2();</span><br><span class="line"></span><br><span class="line">    reg1 &amp;= ~(<span class="number">7</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    reg2 &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_write_status_reg(reg1, reg2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* erase 4K */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_flash_erase_sector</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    spi_flash_write_enable(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x20</span>);</span><br><span class="line">    spi_flash_send_addr(addr);</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_wait_when_busy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* program */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_flash_program</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    spi_flash_write_enable(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x02</span>);</span><br><span class="line">    spi_flash_send_addr(addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">        spi_send_byte(buf[i]);</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_wait_when_busy();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_flash_read</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> addr, <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x03</span>);</span><br><span class="line">    spi_flash_send_addr(addr);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">        buf[i] = spi_recv_byte();</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_flash_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    spi_flash_clear_protect_for_status_reg();</span><br><span class="line">    spi_flash_clear_protect_for_data();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spi_flash_read_ID</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *pMID, <span class="keyword">unsigned</span> <span class="keyword">int</span> *pDID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    spi_send_byte(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    spi_flash_send_addr(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    *pMID = spi_recv_byte();</span><br><span class="line">    *pDID = spi_recv_byte();</span><br><span class="line"></span><br><span class="line">    spi_flash_set_cs(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在主函数里先读取Flash的MID和PID，然后初始化Flash(去除写状态寄存器保护和写数据保护)，再写入数据，读出数据检测是否一致。  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    led_init();</span><br><span class="line">    led_ctl(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mid, pid; </span><br><span class="line">    </span><br><span class="line">    uart_init();</span><br><span class="line">    my_printf(<span class="string">&quot;uart_init ok.\n\r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    spi_init();</span><br><span class="line">    </span><br><span class="line">    spi_flash_read_ID(&amp;mid, &amp;pid);</span><br><span class="line">    my_printf(<span class="string">&quot;SPI Flash : MID = 0x%02x, PID = 0x%02x\n\r&quot;</span>, mid, pid);    </span><br><span class="line"></span><br><span class="line">    spi_flash_init();</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        spi_flash_erase_sector(<span class="number">4096</span>);</span><br><span class="line">        spi_flash_program(<span class="number">4096</span>, <span class="string">&quot;zjj&quot;</span>, <span class="number">7</span>);</span><br><span class="line">        spi_flash_read(<span class="number">4096</span>, str, <span class="number">7</span>);</span><br><span class="line">        my_printf(<span class="string">&quot;SPI Flash read from 4096: %s\n\r&quot;</span>, str);</span><br><span class="line">        </span><br><span class="line">        delay_s(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>测试效果：</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/kernel.embedded/u-boot-spi-ok.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20230616/">https://zhoujinjian.com/posts/20230616/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.52.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20230716/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.53.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux学习系列1：clk子系统</div></div></a></div><div class="next-post pull-right"><a href="/posts/20230516/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.51.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 11 Gnss System源码分析（1）：Gnss流程分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-ARMv8%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">1.ARMv8基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-AArch64-32%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 AArch64&#x2F;32寄存器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-ARMv8-Exception-Level"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 ARMv8 Exception Level</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-RK3399%E5%90%AF%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">2.RK3399启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AE%98%E6%96%B9%E5%90%AF%E5%8A%A8%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 官方启动分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%B6%E4%BD%9C%E8%A3%B8%E6%9C%BA%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 制作裸机启动文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Uboot%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3.Uboot启动部分分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-start-S"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 start.S</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-crt0-64-S"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 crt0_64.S</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E4%B8%B2%E5%8F%A3"><span class="toc-number">4.</span> <span class="toc-text">5.串口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-uart%E4%BB%A3%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">5.1 uart代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-printf%E7%A7%BB%E6%A4%8D"><span class="toc-number">4.2.</span> <span class="toc-text">5.2 printf移植</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">6.定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E7%BC%96%E7%A8%8B%E6%80%9D%E8%B7%AF"><span class="toc-number">5.1.</span> <span class="toc-text">6.1 编程思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.</span> <span class="toc-text">6.2 实现代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-ADC"><span class="toc-number">6.</span> <span class="toc-text">7.ADC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E7%BC%96%E7%A8%8B%E6%80%9D%E8%B7%AF"><span class="toc-number">6.1.</span> <span class="toc-text">7.1 编程思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">6.2.</span> <span class="toc-text">7.2 实现代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-I2C"><span class="toc-number">7.</span> <span class="toc-text">8.I2C</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E7%BC%96%E7%A8%8B%E6%80%9D%E8%B7%AF"><span class="toc-number">7.1.</span> <span class="toc-text">8.1 编程思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">7.2.</span> <span class="toc-text">8.2 实现代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-SPI"><span class="toc-number">8.</span> <span class="toc-text">9.SPI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E7%BC%96%E7%A8%8B%E6%80%9D%E8%B7%AF"><span class="toc-number">8.1.</span> <span class="toc-text">9.1 编程思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="toc-number">8.2.</span> <span class="toc-text">9.2 实现代码</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>