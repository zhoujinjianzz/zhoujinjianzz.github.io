<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识 | zhoujinjian</title><meta name="keywords" content="Linux"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">
<meta property="og:url" content="https://zhoujinjian.com/posts/20240222/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg">
<meta property="article:published_time" content="2024-02-21T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.940Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20240222/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.940Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。</p>
<p>（==<strong>文章基于 Kernel-4.19</strong>==）&amp;&amp;（==<strong>文章基于 Android 11.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz">【zhoujinjian.com博客原图链接】</a> </p>
<p><a target="_blank" rel="noopener" href="https://shop.allnetchina.cn/collections/frontpage/products/rock-pi-4-model-b-board-only-2-4-5ghz-wlan-bluetooth-5-0">【开发板 RockPi4bPlusV1.6】</a></p>
<p><a href="">【开发板 RockPi4bPlusV1.6 Android 11.0 &amp;&amp; Linux（Kernel 4.19）源码链接】</a>：（repo init -u <a target="_blank" rel="noopener" href="https://github.com/radxa/manifests.git">https://github.com/radxa/manifests.git</a> -b Android11_Radxa_rk11.1 -m rockchip-r-release.xml）</p>
<p><a target="_blank" rel="noopener" href="https://wiki.radxa.com/Rockpi4/rockpi-android11">【开发板 RockPi4bPlusV1.6 Android 11.0 &amp;&amp; Linux（Kernel 4.19）编译指南】</a></p>
<p>正是由于前人（各位大神）的分析和总结，帮助我节约了大量的时间和精力，特别感谢，由于不喜欢图片水印，去除了水印，敬请谅解！！！</p>
<p>本文转自<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyly/p/17778170.html">Rockchip RK3399 - DRM crtc基础知识</a>，如有侵权，请联系删除。</p>
<hr>
<p>开发板 ：<code>ROCK Pi 4B+</code>开发板<br><code>eMMC</code> ：<code>32GB</code><br><code>LPDDR4</code> ：<code>4GB</code><br>显示屏 ：<code>7</code>英寸<code>HDMI</code>接口显示屏<br><code>u-boot</code> ：<code>2017.09</code><br><code>linux</code> ：<code>4.19</code>  </p>
<hr>
<h3 id="一、LCD硬件原理"><a href="#一、LCD硬件原理" class="headerlink" title="一、LCD硬件原理"></a>一、<code>LCD</code>硬件原理</h3><h4 id="1-1-CRT介绍"><a href="#1-1-CRT介绍" class="headerlink" title="1.1 CRT介绍"></a>1.1 <code>CRT</code>介绍</h4><p><code>CRT</code>是阴极射线管（<code>Cathode Ray Tube</code>）的缩写，它是一种使用电子束在荧光屏上创建图像的显示设备。<code>CRT</code>显示器在过去很长一段时间内是主流的显示技术，现已被液晶显示屏（<code>LCD</code>，<code>Liquid Crystal Display</code>）或其他新兴技术所替代。</p>
<p>在<code>CRT</code>显示器中，扫描电子束从左到右、从上到下移动，照亮屏幕上的荧光点，从而创建图像。电子束每秒多次扫描整个屏幕，产生闪烁效果，需要与正在显示的内容同步。</p>
<p>随着<code>LCD</code>、<code>LED</code>和<code>OLED</code>等新型显示技术的出现，底层原理已经发生了变化；</p>
<ul>
<li><code>LCD</code>： <code>LCD</code>的构造是在两片平行的玻璃当中放置液态的晶体，两片玻璃中间有许多垂直和水平的细小电线，透过通电与否来控制杆状水晶分子改变方向，将光线折射出来产生画面； <code>LCD</code>通常需要背光源，例如冷阴极荧光灯（<code>CCFL</code>）或<code>LED</code>背光，以照亮液晶面板；这些背光源位于液晶面板的后面，因此<code>LCD</code>显示屏通常较厚；</li>
<li><code>LED</code>：<code>LED</code>是一种通过控制半导体发光二极管的显示方式，其大概的样子就是由很多个通常是红色的发光二极管组成，靠灯的亮灭来显示字符，用来显示文字、图形、图像、动画、行情、视频、录像信号等各种信息的显示屏幕；<code>LED</code>显示屏的<code>LED</code>作为自身的背光源，这使得<code>LED</code>显示屏可以更薄，并且能效更高；</li>
<li><code>OLED</code>：<code>OLED</code>显示屏使用有机发光二极管（<code>OLED</code>），每个像素都能发光，因此无需背光源；每个像素可以独立控制，实现高对比度和色彩鲜艳；</li>
</ul>
<p>这些显示器不再使用扫描电子束，而是使用可以单独控制发光或阻挡光的像素矩阵。这使得图像更加清晰，刷新率更快，能源效率也得到了提高；</p>
<p>然而，刷新显示的基本概念并没有发生很大变化。显示内容仍然通过向每个像素发送信号来控制其亮度和颜色来进行更新。这些信号由显示控制器根据输入视频信号生成，并且它们确定屏幕上显示的内容。</p>
<h4 id="1-2-LCD示意图"><a href="#1-2-LCD示意图" class="headerlink" title="1.2 LCD示意图"></a>1.2 <code>LCD</code>示意图</h4><p>下图是<code>LCD</code>显示器示意图，里面的每个点就是一个像素点。它里面有一个电子枪，一边移动，一边发出各种颜色的光。用动态图表示如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android_Display_System/Android11_Drm05/202309022237381.gif" alt="img"></p>
<p>电子枪是如何移动的？</p>
<ul>
<li>有一条<code>Pixel Clock</code>时钟线与<code>LCD</code>相连，每发出一次<code>Pixel Clock</code>，电子枪就移动一个像素。</li>
</ul>
<p>颜色如何确定？</p>
<ul>
<li>由连接<code>LCD</code>的三组线<code>RGB</code>三原色混合而成：R(<code>Red</code>)、G(<code>Green</code>)、B(<code>Blue</code>)确定。</li>
</ul>
<p>电子枪如何得知应跳到下一行？</p>
<ul>
<li>有一条<code>HSYNC</code>信号线与<code>LCD</code>相连，每发出一次脉冲(高低电平)，电子枪就跳到下一行，该信号叫做行同步信号。</li>
</ul>
<p>电子枪如何得知应跳到原点？</p>
<ul>
<li>有一条<code>VSYNC</code>信号线与<code>LCD</code>相连，每发出一次脉冲(高低电平)，电子枪就跳到原点，该信号叫做帧同步信号。</li>
</ul>
<p><code>RGB</code>线上的数据从何而来？</p>
<ul>
<li>内存里面划分一块显存(<code>frameBuffer</code>)，里面存放了要显示的数据，<code>LCD</code>控制器从里面将数据读出来，通过显示接口（比如<code>mipi</code>，<code>lvds</code>，<code>hdmi</code>、<code>edp</code>、``dp`）传给电子枪，电子枪再依次打到显示屏上。</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android_Display_System/Android11_Drm05/202310202248855.png" alt="img"></p>
<p>因此要想在显示设备上显示图像，至少需要3个信号：</p>
<ul>
<li><code>Pixel Clock</code>：时钟信号，在每个时钟周期更新屏幕上一个像素；</li>
<li><code>HSYNC</code>：水平同步信号，引脚每发出一个脉冲，表示一行的数据开始发送；</li>
<li><code>VSYNC</code>：垂直同步信号，引脚每发出一个脉冲，表示一帧的数据开始发送。</li>
</ul>
<h4 id="1-3-时序参数"><a href="#1-3-时序参数" class="headerlink" title="1.3 时序参数"></a>1.3 时序参数</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android_Display_System/Android11_Drm05/202309022243381.png"> <img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android_Display_System/Android11_Drm05/202309022308840.png"></p>
<p>在上图中我们发现除了<code>Pixel Clock</code>、<code>HSYNC</code>、<code>VSYNC</code>信号外，还包含了大量的时序参数，这里我们一一介绍：</p>
<ul>
<li><code>HBPD</code>（<code>hback porch</code>）：行同步信号的后肩，单位为1个<code>Pixel Clock</code>时钟周期；</li>
<li><code>HFPD</code>（<code>hfront porch</code>）：行同步信号的前肩，单位为1个<code>Pixel Clock</code>时钟周期；</li>
<li><code>HSPW</code>（<code>hsync pulse</code>）：行同步信号的脉宽，单位为1个<code>Pixel Clock</code>时钟周期；</li>
<li><code>HOZVAL</code>（<code>hdisplay</code>）：<code>LCD</code>的水平宽度；</li>
<li><code>VBPD</code>（<code>vback porch</code>）：帧同步信号的后肩，单位为1个<code>HSYNC</code>时钟周期；</li>
<li><code>VFPD</code>（<code>vfront porch</code>）：帧同步信号的前肩，单位为1个<code>HSYNC</code>时钟周期；</li>
<li><code>VSPW</code>（<code>vsync pulse</code>）：帧同步信号的脉宽，单位为1个<code>HSYNC</code>时钟周期；</li>
<li><code>LINEVAL</code> （<code>vdisplay</code>）：<code>LCD</code>的垂直宽度；</li>
</ul>
<p>如果这部分内容看不到，可以参考我之前写的这篇文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyly/p/15407570.html"><code>Mini2440</code>裸机开发之<code>LCD</code>基础</a>。</p>
<h3 id="二、crtc数据结构"><a href="#二、crtc数据结构" class="headerlink" title="二、crtc数据结构"></a>二、<code>crtc</code>数据结构</h3><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android_Display_System/Android11_Drm05/202309022145790.png"></p>
<p>在<code>DRM</code>框架中，<code>crtc</code>从<code>framebuffer</code>中读取待显示的图像，并按照响应的格式输出给<code>encoder</code>，其主要承担的作用为：</p>
<ul>
<li>配置适合显示的显示模式、分辨率、刷新率等参数，并输出相应的时序；</li>
<li>扫描<code>framebuffer</code>发送到一个或多个显示器；</li>
<li>更新<code>framebuffer</code>；</li>
</ul>
<p>概括下就是，对显示器进行扫描，产生时序信号的模块、负责帧切换、电源控制、色彩调整等等。</p>
<h4 id="2-1-struct-drm-crtc"><a href="#2-1-struct-drm-crtc" class="headerlink" title="2.1 struct drm_crtc"></a>2.1 <code>struct drm_crtc</code></h4><p><code>linux</code>内核使用<code>struct drm_crtc</code>来表示一个<code>crtc</code>控制器，包括显示模式、分辨率、刷新率等参数。定义在<code>include/drm/drm_crtc.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_crtc - central CRTC control structure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Each CRTC may have one or more connectors associated with it.  This structure</span></span><br><span class="line"><span class="comment"> * allows the CRTC to be controlled.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc</span> &#123;</span></span><br><span class="line">        <span class="comment">/** @dev: parent DRM device */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="comment">/** @port: OF node used by drm_of_find_possible_crtcs(). */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">port</span>;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @head:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * List of all CRTCs on @dev, linked from &amp;drm_mode_config.crtc_list.</span></span><br><span class="line"><span class="comment">         * Invariant over the lifetime of @dev and therefore does not need</span></span><br><span class="line"><span class="comment">         * locking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** @name: human readable name, can be overwritten by the driver */</span></span><br><span class="line">        <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mutex:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This provides a read lock for the overall CRTC state (mode, dpms</span></span><br><span class="line"><span class="comment">         * state, ...) and a write lock for everything which can be update</span></span><br><span class="line"><span class="comment">         * without a full modeset (fb, cursor data, CRTC properties ...). A full</span></span><br><span class="line"><span class="comment">         * modeset also need to grab &amp;drm_mode_config.connection_mutex.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For atomic drivers specifically this protects @state.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_modeset_lock</span> <span class="title">mutex</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** @base: base KMS object for ID tracking etc. */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_mode_object</span> <span class="title">base</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @primary:</span></span><br><span class="line"><span class="comment">         * Primary plane for this CRTC. Note that this is only</span></span><br><span class="line"><span class="comment">         * relevant for legacy IOCTL, it specifies the plane implicitly used by</span></span><br><span class="line"><span class="comment">         * the SETCRTC and PAGE_FLIP IOCTLs. It does not have any significance</span></span><br><span class="line"><span class="comment">         * beyond that.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_plane</span> *<span class="title">primary</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @cursor:</span></span><br><span class="line"><span class="comment">         * Cursor plane for this CRTC. Note that this is only relevant for</span></span><br><span class="line"><span class="comment">         * legacy IOCTL, it specifies the plane implicitly used by the SETCURSOR</span></span><br><span class="line"><span class="comment">         * and SETCURSOR2 IOCTLs. It does not have any significance</span></span><br><span class="line"><span class="comment">         * beyond that.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_plane</span> *<span class="title">cursor</span>;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @index: Position inside the mode_config.list, can be used as an array</span></span><br><span class="line"><span class="comment">         * index. It is invariant over the lifetime of the CRTC.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">unsigned</span> index;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @cursor_x: Current x position of the cursor, used for universal</span></span><br><span class="line"><span class="comment">         * cursor planes because the SETCURSOR IOCTL only can update the</span></span><br><span class="line"><span class="comment">         * framebuffer without supplying the coordinates. Drivers should not use</span></span><br><span class="line"><span class="comment">         * this directly, atomic drivers should look at &amp;drm_plane_state.crtc_x</span></span><br><span class="line"><span class="comment">         * of the cursor plane instead.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> cursor_x;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @cursor_y: Current y position of the cursor, used for universal</span></span><br><span class="line"><span class="comment">         * cursor planes because the SETCURSOR IOCTL only can update the</span></span><br><span class="line"><span class="comment">         * framebuffer without supplying the coordinates. Drivers should not use</span></span><br><span class="line"><span class="comment">         * this directly, atomic drivers should look at &amp;drm_plane_state.crtc_y</span></span><br><span class="line"><span class="comment">         * of the cursor plane instead.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> cursor_y;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @enabled:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Is this CRTC enabled? Should only be used by legacy drivers, atomic</span></span><br><span class="line"><span class="comment">         * drivers should instead consult &amp;drm_crtc_state.enable and</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.active. Atomic drivers can update this by calling</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_update_legacy_modeset_state().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> enabled;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Current mode timings. Should only be used by legacy drivers, atomic</span></span><br><span class="line"><span class="comment">         * drivers should instead consult &amp;drm_crtc_state.mode. Atomic drivers</span></span><br><span class="line"><span class="comment">         * can update this by calling</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_update_legacy_modeset_state().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> <span class="title">mode</span>;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @hwmode:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Programmed mode in hw, after adjustments for encoders, crtc, panel</span></span><br><span class="line"><span class="comment">         * scaling etc. Should only be used by legacy drivers, for high</span></span><br><span class="line"><span class="comment">         * precision vblank timestamps in</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_helper_get_vblank_timestamp().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that atomic drivers should not use this, but instead use</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.adjusted_mode. And for high-precision timestamps</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_helper_get_vblank_timestamp() used</span></span><br><span class="line"><span class="comment">         * &amp;drm_vblank_crtc.hwmode,</span></span><br><span class="line"><span class="comment">         * which is filled out by calling drm_calc_timestamping_constants().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> <span class="title">hwmode</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @x:</span></span><br><span class="line"><span class="comment">         * x position on screen. Should only be used by legacy drivers, atomic</span></span><br><span class="line"><span class="comment">         * drivers should look at &amp;drm_plane_state.crtc_x of the primary plane</span></span><br><span class="line"><span class="comment">         * instead. Updated by calling</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_update_legacy_modeset_state().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> x;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @y:</span></span><br><span class="line"><span class="comment">         * y position on screen. Should only be used by legacy drivers, atomic</span></span><br><span class="line"><span class="comment">         * drivers should look at &amp;drm_plane_state.crtc_y of the primary plane</span></span><br><span class="line"><span class="comment">         * instead. Updated by calling</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_update_legacy_modeset_state().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** @funcs: CRTC control functions */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_funcs</span> *<span class="title">funcs</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @gamma_size: Size of legacy gamma ramp reported to userspace. Set up</span></span><br><span class="line"><span class="comment">         * by calling drm_mode_crtc_set_gamma_size().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that atomic drivers need to instead use</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.gamma_lut. See drm_crtc_enable_color_mgmt().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">uint32_t</span> gamma_size;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @gamma_store: Gamma ramp values used by the legacy SETGAMMA and</span></span><br><span class="line"><span class="comment">         * GETGAMMA IOCTls. Set up by calling drm_mode_crtc_set_gamma_size().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that atomic drivers need to instead use</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.gamma_lut. See drm_crtc_enable_color_mgmt().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">uint16_t</span> *gamma_store;</span><br><span class="line">        <span class="comment">/** @helper_private: mid-layer private data */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_helper_funcs</span> *<span class="title">helper_private</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** @properties: property tracking for this CRTC */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_object_properties</span> <span class="title">properties</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @scaling_filter_property: property to apply a particular filter while</span></span><br><span class="line"><span class="comment">         * scaling.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_property</span> *<span class="title">scaling_filter_property</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @state:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Current atomic state for this CRTC.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is protected by @mutex. Note that nonblocking atomic commits</span></span><br><span class="line"><span class="comment">         * access the current CRTC state without taking locks. Either by going</span></span><br><span class="line"><span class="comment">         * through the &amp;struct drm_atomic_state pointers, see</span></span><br><span class="line"><span class="comment">         * for_each_oldnew_crtc_in_state(), for_each_old_crtc_in_state() and</span></span><br><span class="line"><span class="comment">         * for_each_new_crtc_in_state(). Or through careful ordering of atomic</span></span><br><span class="line"><span class="comment">         * commit operations as implemented in the atomic helpers, see</span></span><br><span class="line"><span class="comment">         * &amp;struct drm_crtc_commit.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_state</span> *<span class="title">state</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @commit_list:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * List of &amp;drm_crtc_commit structures tracking pending commits.</span></span><br><span class="line"><span class="comment">         * Protected by @commit_lock. This list holds its own full reference,</span></span><br><span class="line"><span class="comment">         * as does the ongoing commit.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &quot;Note that the commit for a state change is also tracked in</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.commit. For accessing the immediately preceding</span></span><br><span class="line"><span class="comment">         * commit in an atomic update it is recommended to just use that</span></span><br><span class="line"><span class="comment">         * pointer in the old CRTC state, since accessing that doesn&#x27;t need</span></span><br><span class="line"><span class="comment">         * any locking or list-walking. @commit_list should only be used to</span></span><br><span class="line"><span class="comment">         * stall for framebuffer cleanup that&#x27;s signalled through</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_commit.cleanup_done.&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">commit_list</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @commit_lock:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Spinlock to protect @commit_list.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">spinlock_t</span> commit_lock;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @debugfs_entry:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Debugfs directory for this CRTC.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">debugfs_entry</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @crc:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Configuration settings of CRC capture.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_crc</span> <span class="title">crc</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @fence_context:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * timeline context used for fence operations.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> fence_context;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @fence_lock:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * spinlock to protect the fences in the fence_context.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">spinlock_t</span> fence_lock;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @fence_seqno:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Seqno variable used as monotonic counter for the fences</span></span><br><span class="line"><span class="comment">         * created on the CRTC&#x27;s timeline.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> fence_seqno;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @timeline_name:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The name of the CRTC&#x27;s fence timeline.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">char</span> timeline_name[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @self_refresh_data: Holds the state for the self refresh helpers</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Initialized via drm_self_refresh_helper_init().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_self_refresh_data</span> *<span class="title">self_refresh_data</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>该结构体包含以下成员变量：</p>
<ul>
<li><code>dev</code>：该<code>crtc</code>所属的<code>DRM</code>设备；</li>
<li><code>port</code>：设备节点，被<code>drm_of_find_possible_crtcs</code>使用；</li>
<li><code>head</code>：链表节点，用于将当前节点添加到<code>&amp;drm_mode_config.crtc_list</code>链表；</li>
<li><code>name</code>：名称，可以被驱动程序覆盖；</li>
<li><code>mutex</code>：用于保护<code>crtc</code>状态的互斥锁；</li>
<li><code>base</code>： <code>struct drm_mode_object</code>；</li>
<li><code>primary</code>：与该<code>crtc</code>相关的<code>primary plane</code>；</li>
<li><code>cursor</code>：与该<code>crtc</code>相关的<code>cursor plane</code>；</li>
<li><code>index</code>：在<code>mode_config.list</code>中的位置，可以用作数组索引；</li>
<li><code>cursor_x</code>：光标的<code>x</code>坐标；</li>
<li><code>cursor_y</code>：光标的<code>y</code>坐标；</li>
<li><code>enabled</code>：指示该<code>crtc</code>是否已启用；</li>
<li><code>mode</code>：当前模式时序信息；</li>
<li><code>hwmode</code>：硬件中编程的模式；</li>
<li><code>x</code>：在屏幕上的<code>x</code>坐标；</li>
<li><code>y</code>：在屏幕上的<code>y</code>坐标；</li>
<li><code>funcs</code>：<code>crtc</code>控制函数；</li>
<li><code>gamma_size</code>：报告给用户空间的<code>legacy gamma ramp</code>大小；</li>
<li><code>gamma_store</code>：<code>legacy gamma values</code>数据存储区域；</li>
<li><code>helper_private</code>：中间层私有数据；</li>
<li><code>properties</code>：跟踪该<code>crtc</code>的属性；</li>
<li><code>scaling_filter_property</code>：应用于缩放时的特定滤镜的属性；</li>
<li><code>state</code>：当前<code>crtc</code>的原子状态；</li>
<li><code>commit_list</code>：跟踪挂起提交的列表；</li>
<li><code>commit_lock</code>：保护<code>commit_list</code>的自旋锁；</li>
<li><code>debugfs_entry</code>：用于调试的目录条目；</li>
<li><code>crc</code>：<code>crc</code>捕获的配置设置；</li>
<li><code>fence_context</code>：用于围栏操作的时间线上下文；</li>
<li><code>fence_lock</code>：保护时间线上的围栏的自旋锁；</li>
<li><code>fence_seqno</code>：用作<code>crtc</code>时间线上创建的围栏的单调计数器；</li>
<li><code>timeline_name</code>：<code>crtc</code>时间线的名称；</li>
<li><code>self_refresh_data</code>：保存自刷新辅助程序状态的数据；</li>
</ul>
<h5 id="2-1-1-struct-drm-display-mode"><a href="#2-1-1-struct-drm-display-mode" class="headerlink" title="2.1.1 struct drm_display_mode"></a>2.1.1 <code>struct drm_display_mode</code></h5><p><code>struct drm_display_mode</code>用于表示显示模式，包含了显示的各种时序参数配置（与显示器息息相关）。定义在<code>include/drm/drm_modes.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_display_mode - DRM kernel-internal display mode structure</span></span><br><span class="line"><span class="comment"> * @hdisplay: horizontal display size</span></span><br><span class="line"><span class="comment"> * @hsync_start: horizontal sync start</span></span><br><span class="line"><span class="comment"> * @hsync_end: horizontal sync end</span></span><br><span class="line"><span class="comment"> * @htotal: horizontal total size</span></span><br><span class="line"><span class="comment"> * @hskew: horizontal skew?!</span></span><br><span class="line"><span class="comment"> * @vdisplay: vertical display size</span></span><br><span class="line"><span class="comment"> * @vsync_start: vertical sync start</span></span><br><span class="line"><span class="comment"> * @vsync_end: vertical sync end</span></span><br><span class="line"><span class="comment"> * @vtotal: vertical total size</span></span><br><span class="line"><span class="comment"> * @vscan: vertical scan?!</span></span><br><span class="line"><span class="comment"> * @crtc_hdisplay: hardware mode horizontal display size</span></span><br><span class="line"><span class="comment"> * @crtc_hblank_start: hardware mode horizontal blank start</span></span><br><span class="line"><span class="comment"> * @crtc_hblank_end: hardware mode horizontal blank end</span></span><br><span class="line"><span class="comment"> * @crtc_hsync_start: hardware mode horizontal sync start</span></span><br><span class="line"><span class="comment"> * @crtc_hsync_end: hardware mode horizontal sync end</span></span><br><span class="line"><span class="comment"> * @crtc_htotal: hardware mode horizontal total size</span></span><br><span class="line"><span class="comment"> * @crtc_hskew: hardware mode horizontal skew?!</span></span><br><span class="line"><span class="comment"> * @crtc_vdisplay: hardware mode vertical display size</span></span><br><span class="line"><span class="comment"> * @crtc_vblank_start: hardware mode vertical blank start</span></span><br><span class="line"><span class="comment"> * @crtc_vblank_end: hardware mode vertical blank end</span></span><br><span class="line"><span class="comment"> * @crtc_vsync_start: hardware mode vertical sync start</span></span><br><span class="line"><span class="comment"> * @crtc_vsync_end: hardware mode vertical sync end</span></span><br><span class="line"><span class="comment"> * @crtc_vtotal: hardware mode vertical total size</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is the kernel API display mode information structure. For the</span></span><br><span class="line"><span class="comment"> * user-space version see struct drm_mode_modeinfo.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The horizontal and vertical timings are defined per the following diagram.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ::</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *               Active                 Front           Sync           Back</span></span><br><span class="line"><span class="comment"> *              Region                 Porch                          Porch</span></span><br><span class="line"><span class="comment"> *     &lt;-----------------------&gt;&lt;----------------&gt;&lt;-------------&gt;&lt;--------------&gt;</span></span><br><span class="line"><span class="comment"> *       //////////////////////|</span></span><br><span class="line"><span class="comment"> *      ////////////////////// |</span></span><br><span class="line"><span class="comment"> *     //////////////////////  |..................               ................</span></span><br><span class="line"><span class="comment"> *                                                _______________</span></span><br><span class="line"><span class="comment"> *     &lt;----- [hv]display -----&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;------------- [hv]sync_start ------------&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;--------------------- [hv]sync_end ---------------------&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;-------------------------------- [hv]total -----------------------------&gt;*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This structure contains two copies of timings. First are the plain timings,</span></span><br><span class="line"><span class="comment"> * which specify the logical mode, as it would be for a progressive 1:1 scanout</span></span><br><span class="line"><span class="comment"> * at the refresh rate userspace can observe through vblank timestamps. Then</span></span><br><span class="line"><span class="comment"> * there&#x27;s the hardware timings, which are corrected for interlacing,</span></span><br><span class="line"><span class="comment"> * double-clocking and similar things. They are provided as a convenience, and</span></span><br><span class="line"><span class="comment"> * can be appropriately computed using drm_mode_set_crtcinfo().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For printing you can use %DRM_MODE_FMT and DRM_MODE_ARG().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> &#123;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @clock:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Pixel clock in kHz.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> clock;              <span class="comment">/* in kHz */</span></span><br><span class="line">        u16 hdisplay;</span><br><span class="line">        u16 hsync_start;</span><br><span class="line">        u16 hsync_end;</span><br><span class="line">        u16 htotal;</span><br><span class="line">        u16 hskew;</span><br><span class="line">        u16 vdisplay;</span><br><span class="line">        u16 vsync_start;</span><br><span class="line">        u16 vsync_end;</span><br><span class="line">        u16 vtotal;</span><br><span class="line">        u16 vscan;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @flags:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Sync and timing flags:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_PHSYNC: horizontal sync is active high.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_NHSYNC: horizontal sync is active low.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_PVSYNC: vertical sync is active high.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_NVSYNC: vertical sync is active low.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_INTERLACE: mode is interlaced.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_DBLSCAN: mode uses doublescan.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_CSYNC: mode uses composite sync.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_PCSYNC: composite sync is active high.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_NCSYNC: composite sync is active low.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_HSKEW: hskew provided (not used?).</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_BCAST: &lt;deprecated&gt;</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_PIXMUX: &lt;deprecated&gt;</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_DBLCLK: double-clocked mode.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_CLKDIV2: half-clocked mode.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Additionally there&#x27;s flags to specify how 3D modes are packed:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_NONE: normal, non-3D mode.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_FRAME_PACKING: 2 full frames for left and right.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_FIELD_ALTERNATIVE: interleaved like fields.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_LINE_ALTERNATIVE: interleaved lines.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_SIDE_BY_SIDE_FULL: side-by-side full frames.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_L_DEPTH: ?</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_L_DEPTH_GFX_GFX_DEPTH: ?</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_TOP_AND_BOTTOM: frame split into top and bottom</span></span><br><span class="line"><span class="comment">         *    parts.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_FLAG_3D_SIDE_BY_SIDE_HALF: frame split into left and</span></span><br><span class="line"><span class="comment">         *    right parts.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u32 flags;</span><br><span class="line">        u32 flags;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @crtc_clock:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Actual pixel or dot clock in the hardware. This differs from the</span></span><br><span class="line"><span class="comment">         * logical @clock when e.g. using interlacing, double-clocking, stereo</span></span><br><span class="line"><span class="comment">         * modes or other fancy stuff that changes the timings and signals</span></span><br><span class="line"><span class="comment">         * actually sent over the wire.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is again in kHz.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that with digital outputs like HDMI or DP there&#x27;s usually a</span></span><br><span class="line"><span class="comment">         * massive confusion between the dot clock and the signal clock at the</span></span><br><span class="line"><span class="comment">         * bit encoding level. Especially when a 8b/10b encoding is used and the</span></span><br><span class="line"><span class="comment">         * difference is exactly a factor of 10.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> crtc_clock;</span><br><span class="line">        u16 crtc_hdisplay;</span><br><span class="line">        u16 crtc_hblank_start;</span><br><span class="line">        u16 crtc_hblank_end;</span><br><span class="line">        u16 crtc_hsync_start;</span><br><span class="line">        u16 crtc_hsync_end;</span><br><span class="line">        u16 crtc_htotal;</span><br><span class="line">        u16 crtc_hskew;</span><br><span class="line">        u16 crtc_vdisplay;</span><br><span class="line">        u16 crtc_vblank_start;</span><br><span class="line">        u16 crtc_vblank_end;</span><br><span class="line">        u16 crtc_vsync_start;</span><br><span class="line">        u16 crtc_vsync_end;</span><br><span class="line">        u16 crtc_vtotal;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @width_mm:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Addressable size of the output in mm, projectors should set this to</span></span><br><span class="line"><span class="comment">         * 0.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u16 width_mm;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @height_mm:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Addressable size of the output in mm, projectors should set this to</span></span><br><span class="line"><span class="comment">         * 0.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u16 height_mm;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * A bitmask of flags, mostly about the source of a mode. Possible flags</span></span><br><span class="line"><span class="comment">         * are:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_TYPE_PREFERRED: Preferred mode, usually the native</span></span><br><span class="line"><span class="comment">         *    resolution of an LCD panel. There should only be one preferred</span></span><br><span class="line"><span class="comment">         *    mode per connector at any given time.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_TYPE_DRIVER: Mode created by the driver, which is all of</span></span><br><span class="line"><span class="comment">         *    them really. Drivers must set this bit for all modes they create</span></span><br><span class="line"><span class="comment">         *    and expose to userspace.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_TYPE_USERDEF: Mode defined or selected via the kernel</span></span><br><span class="line"><span class="comment">         *    command line.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Plus a big list of flags which shouldn&#x27;t be used at all, but are</span></span><br><span class="line"><span class="comment">         * still around since these flags are also used in the userspace ABI.</span></span><br><span class="line"><span class="comment">         * We no longer accept modes with these types though:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_TYPE_BUILTIN: Meant for hard-coded modes, unused.</span></span><br><span class="line"><span class="comment">         *    Use DRM_MODE_TYPE_DRIVER instead.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_TYPE_DEFAULT: Again a leftover, use</span></span><br><span class="line"><span class="comment">         *    DRM_MODE_TYPE_PREFERRED instead.</span></span><br><span class="line"><span class="comment">         *  - DRM_MODE_TYPE_CLOCK_C and DRM_MODE_TYPE_CRTC_C: Define leftovers</span></span><br><span class="line"><span class="comment">         *    which are stuck around for hysterical raisins only. No one has an</span></span><br><span class="line"><span class="comment">         *    idea what they were meant for. Don&#x27;t use.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u8 type;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @expose_to_userspace:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Indicates whether the mode is to be exposed to the userspace.</span></span><br><span class="line"><span class="comment">         * This is to maintain a set of exposed modes while preparing</span></span><br><span class="line"><span class="comment">         * user-mode&#x27;s list in drm_mode_getconnector ioctl. The purpose of</span></span><br><span class="line"><span class="comment">         * this only lies in the ioctl function, and is not to be used</span></span><br><span class="line"><span class="comment">         * outside the function.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> expose_to_userspace;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @head:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * struct list_head for mode lists.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @name:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Human-readable name of the mode, filled out with drm_mode_set_name().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">char</span> name[DRM_DISPLAY_MODE_LEN];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @status:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Status of the mode, used to filter out modes not supported by the</span></span><br><span class="line"><span class="comment">         * hardware. See enum &amp;drm_mode_status.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">enum</span> drm_mode_status status;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @picture_aspect_ratio:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Field for setting the HDMI picture aspect ratio of a mode.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">enum</span> hdmi_picture_aspect picture_aspect_ratio;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>结构体包含以下成员变量：</p>
<ul>
<li><code>hdisplay</code>：行有效像素;</li>
<li><code>hsync_start</code>：行同步起始像素;</li>
<li><code>hsync_end</code>：行同步结束像素;</li>
<li><code>htotal</code>：行总大小;</li>
<li><code>hskew</code>：行偏差，通常为 0（暂不清楚具体含义）;</li>
<li><code>vdisplay</code>：帧有效行;</li>
<li><code>vsync_start</code>：帧同步起始行;</li>
<li><code>vsync_end</code>：帧同步结束行;</li>
<li><code>vtotal</code>：一帧总行数;</li>
<li><code>vscan</code>： 帧扫描信号，通常为 0（暂不清楚具体含义）;</li>
<li><code>crtc_hdisplay</code>：硬件模式的行有效像素;;</li>
<li><code>crtc_hblank_start</code>：硬件模式的行空白起始像素;</li>
<li><code>crtc_hblank_end</code>：硬件模式的行空白结束像素;</li>
<li><code>crtc_hsync_start</code>：硬件模式的行同步起始像素;</li>
<li><code>crtc_hsync_end</code>：硬件模式的行同步结束像素;</li>
<li><code>crtc_htotal</code>：硬件模式的行总大小;</li>
<li><code>crtc_hskew</code>：硬件模式的行偏差，通常为 0（暂不清楚具体含义）;</li>
<li><code>crtc_vdisplay</code>：硬件模式的帧有效行;</li>
<li><code>crtc_vblank_start</code>：硬件模式的帧空白起始行;</li>
<li><code>crtc_vblank_end</code>：硬件模式的帧空白结束行;</li>
<li><code>crtc_vsync_start</code>：硬件模式的帧同步起始行;</li>
<li><code>crtc_vsync_end</code>：硬件模式的帧同步结束行;</li>
<li><code>crtc_vtotal</code>：硬件模式的一帧总行数;</li>
</ul>
<p>关于<code>hdisplay</code>、<code>hsync_start</code>、<code>hsync_end</code>、<code>htotal</code>对应着我们第一节中介绍的水平时序参数；</p>
<p>同理<code>vdisplay</code>、<code>vsync_start</code>、<code>vsync_end</code>、<code>vtotal</code>对应着垂直时序参数；</p>
<h5 id="2-1-2-struct-drm-crtc-state"><a href="#2-1-2-struct-drm-crtc-state" class="headerlink" title="2.1.2 struct drm_crtc_state"></a>2.1.2 <code>struct drm_crtc_state</code></h5><p><code>struct drm_crtc_state</code>用于表示<code>crtc</code>的状态，定义在<code>include/drm/drm_crtc.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_crtc_state - mutable CRTC state</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that the distinction between @enable and @active is rather subtle:</span></span><br><span class="line"><span class="comment"> * Flipping @active while @enable is set without changing anything else may</span></span><br><span class="line"><span class="comment"> * never return in a failure from the &amp;drm_mode_config_funcs.atomic_check</span></span><br><span class="line"><span class="comment"> * callback. Userspace assumes that a DPMS On will always succeed. In other</span></span><br><span class="line"><span class="comment"> * words: @enable controls resource assignment, @active controls the actual</span></span><br><span class="line"><span class="comment"> * hardware state.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The three booleans active_changed, connectors_changed and mode_changed are</span></span><br><span class="line"><span class="comment"> * intended to indicate whether a full modeset is needed, rather than strictly</span></span><br><span class="line"><span class="comment"> * describing what has changed in a commit. See also:</span></span><br><span class="line"><span class="comment"> * drm_atomic_crtc_needs_modeset()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WARNING: Transitional helpers (like drm_helper_crtc_mode_set() or</span></span><br><span class="line"><span class="comment"> * drm_helper_crtc_mode_set_base()) do not maintain many of the derived control</span></span><br><span class="line"><span class="comment"> * state like @plane_mask so drivers not converted over to atomic helpers should</span></span><br><span class="line"><span class="comment"> * not rely on these being accurate!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_state</span> &#123;</span></span><br><span class="line">        <span class="comment">/** @crtc: backpointer to the CRTC */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc</span> *<span class="title">crtc</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @enable: Whether the CRTC should be enabled, gates all other state.</span></span><br><span class="line"><span class="comment">         * This controls reservations of shared resources. Actual hardware state</span></span><br><span class="line"><span class="comment">         * is controlled by @active.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> enable;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @active: Whether the CRTC is actively displaying (used for DPMS).</span></span><br><span class="line"><span class="comment">         * Implies that @enable is set. The driver must not release any shared</span></span><br><span class="line"><span class="comment">         * resources if @active is set to false but @enable still true, because</span></span><br><span class="line"><span class="comment">         * userspace expects that a DPMS ON always succeeds.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Hence drivers must not consult @active in their various</span></span><br><span class="line"><span class="comment">         * &amp;drm_mode_config_funcs.atomic_check callback to reject an atomic</span></span><br><span class="line"><span class="comment">         * commit. They can consult it to aid in the computation of derived</span></span><br><span class="line"><span class="comment">         * hardware state, since even in the DPMS OFF state the display hardware</span></span><br><span class="line"><span class="comment">         * should be as much powered down as when the CRTC is completely</span></span><br><span class="line"><span class="comment">         * disabled through setting @enable to false.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> active;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @planes_changed: Planes on this crtc are updated. Used by the atomic</span></span><br><span class="line"><span class="comment">         * helpers and drivers to steer the atomic commit control flow.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> planes_changed : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_changed: @mode or @enable has been changed. Used by the atomic</span></span><br><span class="line"><span class="comment">         * helpers and drivers to steer the atomic commit control flow. See also</span></span><br><span class="line"><span class="comment">         * drm_atomic_crtc_needs_modeset().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Drivers are supposed to set this for any CRTC state changes that</span></span><br><span class="line"><span class="comment">         * require a full modeset. They can also reset it to false if e.g. a</span></span><br><span class="line"><span class="comment">         * @mode change can be done without a full modeset by only changing</span></span><br><span class="line"><span class="comment">         * scaler settings.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> mode_changed : <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @active_changed: @active has been toggled. Used by the atomic</span></span><br><span class="line"><span class="comment">         * helpers and drivers to steer the atomic commit control flow. See also</span></span><br><span class="line"><span class="comment">         * drm_atomic_crtc_needs_modeset().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> active_changed : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @connectors_changed: Connectors to this crtc have been updated,</span></span><br><span class="line"><span class="comment">         * either in their state or routing. Used by the atomic</span></span><br><span class="line"><span class="comment">         * helpers and drivers to steer the atomic commit control flow. See also</span></span><br><span class="line"><span class="comment">         * drm_atomic_crtc_needs_modeset().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Drivers are supposed to set this as-needed from their own atomic</span></span><br><span class="line"><span class="comment">         * check code, e.g. from &amp;drm_encoder_helper_funcs.atomic_check</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> connectors_changed : <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">         <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @zpos_changed: zpos values of planes on this crtc have been updated.</span></span><br><span class="line"><span class="comment">         * Used by the atomic helpers and drivers to steer the atomic commit</span></span><br><span class="line"><span class="comment">         * control flow.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> zpos_changed : <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @color_mgmt_changed: Color management properties have changed</span></span><br><span class="line"><span class="comment">         * (@gamma_lut, @degamma_lut or @ctm). Used by the atomic helpers and</span></span><br><span class="line"><span class="comment">         * drivers to steer the atomic commit control flow.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> color_mgmt_changed : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @no_vblank:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reflects the ability of a CRTC to send VBLANK events. This state</span></span><br><span class="line"><span class="comment">         * usually depends on the pipeline configuration. If set to true, DRM</span></span><br><span class="line"><span class="comment">         * atomic helpers will send out a fake VBLANK event during display</span></span><br><span class="line"><span class="comment">         * updates after all hardware changes have been committed. This is</span></span><br><span class="line"><span class="comment">         * implemented in drm_atomic_helper_fake_vblank().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * One usage is for drivers and/or hardware without support for VBLANK</span></span><br><span class="line"><span class="comment">         * interrupts. Such drivers typically do not initialize vblanking</span></span><br><span class="line"><span class="comment">         * (i.e., call drm_vblank_init() with the number of CRTCs). For CRTCs</span></span><br><span class="line"><span class="comment">         * without initialized vblanking, this field is set to true in</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_check_modeset(), and a fake VBLANK event will be</span></span><br><span class="line"><span class="comment">         * send out on each update of the display pipeline by</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_fake_vblank().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Another usage is CRTCs feeding a writeback connector operating in</span></span><br><span class="line"><span class="comment">         * oneshot mode. In this case the fake VBLANK event is only generated</span></span><br><span class="line"><span class="comment">         * when a job is queued to the writeback connector, and we want the</span></span><br><span class="line"><span class="comment">         * core to fake VBLANK events when this part of the pipeline hasn&#x27;t</span></span><br><span class="line"><span class="comment">         * changed but others had or when the CRTC and connectors are being</span></span><br><span class="line"><span class="comment">         * disabled.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * __drm_atomic_helper_crtc_duplicate_state() will not reset the value</span></span><br><span class="line"><span class="comment">         * from the current state, the CRTC driver is then responsible for</span></span><br><span class="line"><span class="comment">         * updating this field when needed.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that the combination of &amp;drm_crtc_state.event == NULL and</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.no_blank == true is valid and usually used when the</span></span><br><span class="line"><span class="comment">         * writeback connector attached to the CRTC has a new job queued. In</span></span><br><span class="line"><span class="comment">         * this case the driver will send the VBLANK event on its own when the</span></span><br><span class="line"><span class="comment">         * writeback job is complete.</span></span><br><span class="line"><span class="comment">        bool no_vblank : 1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        /**</span></span><br><span class="line"><span class="comment">         * @plane_mask: Bitmask of drm_plane_mask(plane) of planes attached to</span></span><br><span class="line"><span class="comment">         * this CRTC.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u32 plane_mask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @connector_mask: Bitmask of drm_connector_mask(connector) of</span></span><br><span class="line"><span class="comment">         * connectors attached to this CRTC.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u32 connector_mask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @encoder_mask: Bitmask of drm_encoder_mask(encoder) of encoders</span></span><br><span class="line"><span class="comment">         * attached to this CRTC.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u32 encoder_mask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @adjusted_mode:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Internal display timings which can be used by the driver to handle</span></span><br><span class="line"><span class="comment">         * differences between the mode requested by userspace in @mode and what</span></span><br><span class="line"><span class="comment">         * is actually programmed into the hardware.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For drivers using &amp;drm_bridge, this stores hardware display timings</span></span><br><span class="line"><span class="comment">         * used between the CRTC and the first bridge. For other drivers, the</span></span><br><span class="line"><span class="comment">         * meaning of the adjusted_mode field is purely driver implementation</span></span><br><span class="line"><span class="comment">         * defined information, and will usually be used to store the hardware</span></span><br><span class="line"><span class="comment">         * display timings used between the CRTC and encoder blocks.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> <span class="title">adjusted_mode</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Display timings requested by userspace. The driver should try to</span></span><br><span class="line"><span class="comment">         * match the refresh rate as close as possible (but note that it&#x27;s</span></span><br><span class="line"><span class="comment">         * undefined what exactly is close enough, e.g. some of the HDMI modes</span></span><br><span class="line"><span class="comment">         * only differ in less than 1% of the refresh rate). The active width</span></span><br><span class="line"><span class="comment">         * and height as observed by userspace for positioning planes must match</span></span><br><span class="line"><span class="comment">         * exactly.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For external connectors where the sink isn&#x27;t fixed (like with a</span></span><br><span class="line"><span class="comment">         * built-in panel), this mode here should match the physical mode on the</span></span><br><span class="line"><span class="comment">         * wire to the last details (i.e. including sync polarities and</span></span><br><span class="line"><span class="comment">         * everything).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> <span class="title">mode</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_blob: &amp;drm_property_blob for @mode, for exposing the mode to</span></span><br><span class="line"><span class="comment">         * atomic userspace.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_property_blob</span> *<span class="title">mode_blob</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @degamma_lut:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Lookup table for converting framebuffer pixel data before apply the</span></span><br><span class="line"><span class="comment">         * color conversion matrix @ctm. See drm_crtc_enable_color_mgmt(). The</span></span><br><span class="line"><span class="comment">         * blob (if not NULL) is an array of &amp;struct drm_color_lut.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_property_blob</span> *<span class="title">degamma_lut</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @ctm:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Color transformation matrix. See drm_crtc_enable_color_mgmt(). The</span></span><br><span class="line"><span class="comment">         * blob (if not NULL) is a &amp;struct drm_color_ctm.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_property_blob</span> *<span class="title">ctm</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @gamma_lut:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Lookup table for converting pixel data after the color conversion</span></span><br><span class="line"><span class="comment">         * matrix @ctm.  See drm_crtc_enable_color_mgmt(). The blob (if not</span></span><br><span class="line"><span class="comment">         * NULL) is an array of &amp;struct drm_color_lut.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that for mostly historical reasons stemming from Xorg heritage,</span></span><br><span class="line"><span class="comment">         * this is also used to store the color map (also sometimes color lut,</span></span><br><span class="line"><span class="comment">         * CLUT or color palette) for indexed formats like DRM_FORMAT_C8.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_property_blob</span> *<span class="title">gamma_lut</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @target_vblank:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Target vertical blank period when a page flip</span></span><br><span class="line"><span class="comment">         * should take effect.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u32 target_vblank;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @async_flip:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is set when DRM_MODE_PAGE_FLIP_ASYNC is set in the legacy</span></span><br><span class="line"><span class="comment">         * PAGE_FLIP IOCTL. It&#x27;s not wired up for the atomic IOCTL itself yet.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> async_flip;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @vrr_enabled:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Indicates if variable refresh rate should be enabled for the CRTC.</span></span><br><span class="line"><span class="comment">         * Support for the requested vrr state will depend on driver and</span></span><br><span class="line"><span class="comment">         * hardware capabiltiy - lacking support is not treated as failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> vrr_enabled;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @self_refresh_active:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Used by the self refresh helpers to denote when a self refresh</span></span><br><span class="line"><span class="comment">         * transition is occurring. This will be set on enable/disable callbacks</span></span><br><span class="line"><span class="comment">         * when self refresh is being enabled or disabled. In some cases, it may</span></span><br><span class="line"><span class="comment">         * not be desirable to fully shut off the crtc during self refresh.</span></span><br><span class="line"><span class="comment">         * CRTC&#x27;s can inspect this flag and determine the best course of action.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> self_refresh_active;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @scaling_filter:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Scaling filter to be applied</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">enum</span> drm_scaling_filter scaling_filter;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @event:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Optional pointer to a DRM event to signal upon completion of the</span></span><br><span class="line"><span class="comment">         * state update. The driver must send out the event when the atomic</span></span><br><span class="line"><span class="comment">         * commit operation completes. There are two cases:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - The event is for a CRTC which is being disabled through this</span></span><br><span class="line"><span class="comment">         *    atomic commit. In that case the event can be send out any time</span></span><br><span class="line"><span class="comment">         *    after the hardware has stopped scanning out the current</span></span><br><span class="line"><span class="comment">         *    framebuffers. It should contain the timestamp and counter for the</span></span><br><span class="line"><span class="comment">         *    last vblank before the display pipeline was shut off. The simplest</span></span><br><span class="line"><span class="comment">         *    way to achieve that is calling drm_crtc_send_vblank_event()</span></span><br><span class="line"><span class="comment">         *    somewhen after drm_crtc_vblank_off() has been called.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - For a CRTC which is enabled at the end of the commit (even when it</span></span><br><span class="line"><span class="comment">         *    undergoes an full modeset) the vblank timestamp and counter must</span></span><br><span class="line"><span class="comment">         *    be for the vblank right before the first frame that scans out the</span></span><br><span class="line"><span class="comment">         *    new set of buffers. Again the event can only be sent out after the</span></span><br><span class="line"><span class="comment">         *    hardware has stopped scanning out the old buffers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  - Events for disabled CRTCs are not allowed, and drivers can ignore</span></span><br><span class="line"><span class="comment">         *    that case.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For very simple hardware without VBLANK interrupt, enabling</span></span><br><span class="line"><span class="comment">         * &amp;struct drm_crtc_state.no_vblank makes DRM&#x27;s atomic commit helpers</span></span><br><span class="line"><span class="comment">         * send a fake VBLANK event at the end of the display update after all</span></span><br><span class="line"><span class="comment">         * hardware changes have been applied. See</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_fake_vblank().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For more complex hardware this</span></span><br><span class="line"><span class="comment">         * can be handled by the drm_crtc_send_vblank_event() function,</span></span><br><span class="line"><span class="comment">         * which the driver should call on the provided event upon completion of</span></span><br><span class="line"><span class="comment">         * the atomic commit. Note that if the driver supports vblank signalling</span></span><br><span class="line"><span class="comment">         * and timestamping the vblank counters and timestamps must agree with</span></span><br><span class="line"><span class="comment">         * the ones returned from page flip events. With the current vblank</span></span><br><span class="line"><span class="comment">         * helper infrastructure this can be achieved by holding a vblank</span></span><br><span class="line"><span class="comment">         * reference while the page flip is pending, acquired through</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_get() and released with drm_crtc_vblank_put().</span></span><br><span class="line"><span class="comment">         * Drivers are free to implement their own vblank counter and timestamp</span></span><br><span class="line"><span class="comment">         * tracking though, e.g. if they have accurate timestamp registers in</span></span><br><span class="line"><span class="comment">         * hardware.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * For hardware which supports some means to synchronize vblank</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         * interrupt delivery with committing display state there&#x27;s also</span></span><br><span class="line"><span class="comment">         * drm_crtc_arm_vblank_event(). See the documentation of that function</span></span><br><span class="line"><span class="comment">         * for a detailed discussion of the constraints it needs to be used</span></span><br><span class="line"><span class="comment">         * safely.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If the device can&#x27;t notify of flip completion in a race-free way</span></span><br><span class="line"><span class="comment">         * at all, then the event should be armed just after the page flip is</span></span><br><span class="line"><span class="comment">         * committed. In the worst case the driver will send the event to</span></span><br><span class="line"><span class="comment">         * userspace one frame too late. This doesn&#x27;t allow for a real atomic</span></span><br><span class="line"><span class="comment">         * update, but it should avoid tearing.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_pending_vblank_event</span> *<span class="title">event</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @commit:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This tracks how the commit for this update proceeds through the</span></span><br><span class="line"><span class="comment">         * various phases. This is never cleared, except when we destroy the</span></span><br><span class="line"><span class="comment">         * state, so that subsequent commits can synchronize with previous ones.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_commit</span> *<span class="title">commit</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/** @state: backpointer to global drm_atomic_state */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_atomic_state</span> *<span class="title">state</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-操作函数"><a href="#2-2-操作函数" class="headerlink" title="2.2 操作函数"></a>2.2 操作函数</h4><h5 id="2-2-1-struct-drm-crtc-funcs"><a href="#2-2-1-struct-drm-crtc-funcs" class="headerlink" title="2.2.1 struct drm_crtc_funcs"></a>2.2.1 <code>struct drm_crtc_funcs</code></h5><p><code>struct drm_crtc_funcs</code>用于定义与<code>crtc</code>相关的函数和操作，该结构体包含了一系列函数指针，用于实现包括模式设置、帧缓冲区映射、显示控制等功能。定义在<code>include/drm/drm_crtc.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_crtc_funcs - control CRTCs for a given device</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The drm_crtc_funcs structure is the central CRTC management structure</span></span><br><span class="line"><span class="comment"> * in the DRM.  Each CRTC controls one or more connectors (note that the name</span></span><br><span class="line"><span class="comment"> * CRTC is simply historical, a CRTC may control LVDS, VGA, DVI, TV out, etc.</span></span><br><span class="line"><span class="comment"> * connectors, not just CRTs).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Each driver is responsible for filling out this structure at startup time,</span></span><br><span class="line"><span class="comment"> * in addition to providing other modesetting features, like i2c and DDC</span></span><br><span class="line"><span class="comment"> * bus accessors.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_funcs</span> &#123;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @reset:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reset CRTC hardware and software state to off. This function isn&#x27;t</span></span><br><span class="line"><span class="comment">         * called by the core directly, only through drm_mode_config_reset().</span></span><br><span class="line"><span class="comment">         * It&#x27;s not a helper hook only for historical reasons.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Atomic drivers can use drm_atomic_helper_crtc_reset() to reset</span></span><br><span class="line"><span class="comment">         * atomic state using this hook.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*reset)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @cursor_set:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Update the cursor image. The cursor position is relative to the CRTC</span></span><br><span class="line"><span class="comment">         * and can be partially or fully outside of the visible area.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that contrary to all other KMS functions the legacy cursor entry</span></span><br><span class="line"><span class="comment">         * points don&#x27;t take a framebuffer object, but instead take directly a</span></span><br><span class="line"><span class="comment">         * raw buffer object id from the driver&#x27;s buffer manager (which is</span></span><br><span class="line"><span class="comment">         * either GEM or TTM for current drivers).</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This entry point is deprecated, drivers should instead implement</span></span><br><span class="line"><span class="comment">         * universal plane support and register a proper cursor plane using</span></span><br><span class="line"><span class="comment">         * drm_crtc_init_with_planes().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*cursor_set)(struct drm_crtc *crtc, struct drm_file *file_priv,</span><br><span class="line">                          <span class="keyword">uint32_t</span> handle, <span class="keyword">uint32_t</span> width, <span class="keyword">uint32_t</span> height);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @cursor_set2:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Update the cursor image, including hotspot information. The hotspot</span></span><br><span class="line"><span class="comment">         * must not affect the cursor position in CRTC coordinates, but is only</span></span><br><span class="line"><span class="comment">         * meant as a hint for virtualized display hardware to coordinate the</span></span><br><span class="line"><span class="comment">         * guests and hosts cursor position. The cursor hotspot is relative to</span></span><br><span class="line"><span class="comment">         * the cursor image. Otherwise this works exactly like @cursor_set.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This entry point is deprecated, drivers should instead implement</span></span><br><span class="line"><span class="comment">         * universal plane support and register a proper cursor plane using</span></span><br><span class="line"><span class="comment">         * drm_crtc_init_with_planes().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*cursor_set2)(struct drm_crtc *crtc, struct drm_file *file_priv,</span><br><span class="line">                           <span class="keyword">uint32_t</span> handle, <span class="keyword">uint32_t</span> width, <span class="keyword">uint32_t</span> height,</span><br><span class="line">                           <span class="keyword">int32_t</span> hot_x, <span class="keyword">int32_t</span> hot_y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @cursor_move:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Update the cursor position. The cursor does not need to be visible</span></span><br><span class="line"><span class="comment">         * when this hook is called.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This entry point is deprecated, drivers should instead implement</span></span><br><span class="line"><span class="comment">         * universal plane support and register a proper cursor plane using</span></span><br><span class="line"><span class="comment">         * drm_crtc_init_with_planes().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*cursor_move)(struct drm_crtc *crtc, <span class="keyword">int</span> x, <span class="keyword">int</span> y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @gamma_set:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Set gamma on the CRTC.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Atomic drivers who want to support gamma tables should implement the</span></span><br><span class="line"><span class="comment">         * atomic color management support, enabled by calling</span></span><br><span class="line"><span class="comment">         * drm_crtc_enable_color_mgmt(), which then supports the legacy gamma</span></span><br><span class="line"><span class="comment">         * interface through the drm_atomic_helper_legacy_gamma_set()</span></span><br><span class="line"><span class="comment">         * compatibility implementation.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*gamma_set)(struct drm_crtc *crtc, u16 *r, u16 *g, u16 *b,</span><br><span class="line">                         <span class="keyword">uint32_t</span> size,</span><br><span class="line">                         struct drm_modeset_acquire_ctx *ctx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @destroy:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Clean up CRTC resources. This is only called at driver unload time</span></span><br><span class="line"><span class="comment">         * through drm_mode_config_cleanup() since a CRTC cannot be hotplugged</span></span><br><span class="line"><span class="comment">         * in DRM.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*destroy)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @set_config:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is the main legacy entry point to change the modeset state on a</span></span><br><span class="line"><span class="comment">         * CRTC. All the details of the desired configuration are passed in a</span></span><br><span class="line"><span class="comment">         * &amp;struct drm_mode_set - see there for details.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Drivers implementing atomic modeset should use</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_set_config() to implement this hook.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*set_config)(struct drm_mode_set *<span class="built_in">set</span>,</span><br><span class="line">                          struct drm_modeset_acquire_ctx *ctx);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @page_flip:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Legacy entry point to schedule a flip to the given framebuffer.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Page flipping is a synchronization mechanism that replaces the frame</span></span><br><span class="line"><span class="comment">         * buffer being scanned out by the CRTC with a new frame buffer during</span></span><br><span class="line"><span class="comment">         * vertical blanking, avoiding tearing (except when requested otherwise</span></span><br><span class="line"><span class="comment">         * through the DRM_MODE_PAGE_FLIP_ASYNC flag). When an application</span></span><br><span class="line"><span class="comment">         * requests a page flip the DRM core verifies that the new frame buffer</span></span><br><span class="line"><span class="comment">         * is large enough to be scanned out by the CRTC in the currently</span></span><br><span class="line"><span class="comment">         * configured mode and then calls this hook with a pointer to the new</span></span><br><span class="line"><span class="comment">         * frame buffer.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The driver must wait for any pending rendering to the new framebuffer</span></span><br><span class="line"><span class="comment">         * to complete before executing the flip. It should also wait for any</span></span><br><span class="line"><span class="comment">         * pending rendering from other drivers if the underlying buffer is a</span></span><br><span class="line"><span class="comment">         * shared dma-buf.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * An application can request to be notified when the page flip has</span></span><br><span class="line"><span class="comment">         * completed. The drm core will supply a &amp;struct drm_event in the event</span></span><br><span class="line"><span class="comment">         * parameter in this case. This can be handled by the</span></span><br><span class="line"><span class="comment">         * drm_crtc_send_vblank_event() function, which the driver should call on</span></span><br><span class="line"><span class="comment">         * the provided event upon completion of the flip. Note that if</span></span><br><span class="line"><span class="comment">         * the driver supports vblank signalling and timestamping the vblank</span></span><br><span class="line"><span class="comment">         * counters and timestamps must agree with the ones returned from page</span></span><br><span class="line"><span class="comment">         * flip events. With the current vblank helper infrastructure this can</span></span><br><span class="line"><span class="comment">         * be achieved by holding a vblank reference while the page flip is</span></span><br><span class="line"><span class="comment">         * pending, acquired through drm_crtc_vblank_get() and released with</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_put(). Drivers are free to implement their own vblank</span></span><br><span class="line"><span class="comment">         * counter and timestamp tracking though, e.g. if they have accurate</span></span><br><span class="line"><span class="comment">         * timestamp registers in hardware.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Very early versions of the KMS ABI mandated that the driver must</span></span><br><span class="line"><span class="comment">         * block (but not reject) any rendering to the old framebuffer until the</span></span><br><span class="line"><span class="comment">         * flip operation has completed and the old framebuffer is no longer</span></span><br><span class="line"><span class="comment">         * visible. This requirement has been lifted, and userspace is instead</span></span><br><span class="line"><span class="comment">         * expected to request delivery of an event and wait with recycling old</span></span><br><span class="line"><span class="comment">         * buffers until such has been received.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure. Note that if a</span></span><br><span class="line"><span class="comment">         * page flip operation is already pending the callback should return</span></span><br><span class="line"><span class="comment">         * -EBUSY. Pageflips on a disabled CRTC (either by setting a NULL mode</span></span><br><span class="line"><span class="comment">         * or just runtime disabled through DPMS respectively the new atomic</span></span><br><span class="line"><span class="comment">         * &quot;ACTIVE&quot; state) should result in an -EINVAL error code. Note that</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_page_flip() checks this already for atomic drivers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*page_flip)(struct drm_crtc *crtc,</span><br><span class="line">                         struct drm_framebuffer *fb,</span><br><span class="line">                         struct drm_pending_vblank_event *event,</span><br><span class="line">                         <span class="keyword">uint32_t</span> flags,</span><br><span class="line">                         struct drm_modeset_acquire_ctx *ctx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @page_flip_target:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Same as @page_flip but with an additional parameter specifying the</span></span><br><span class="line"><span class="comment">         * absolute target vertical blank period (as reported by</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_count()) when the flip should take effect.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that the core code calls drm_crtc_vblank_get before this entry</span></span><br><span class="line"><span class="comment">         * point, and will call drm_crtc_vblank_put if this entry point returns</span></span><br><span class="line"><span class="comment">         * any non-0 error code. It&#x27;s the driver&#x27;s responsibility to call</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_put after this entry point returns 0, typically when</span></span><br><span class="line"><span class="comment">         * the flip completes.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*page_flip_target)(struct drm_crtc *crtc,</span><br><span class="line">                                struct drm_framebuffer *fb,</span><br><span class="line">                                struct drm_pending_vblank_event *event,</span><br><span class="line">                                <span class="keyword">uint32_t</span> flags, <span class="keyword">uint32_t</span> target,</span><br><span class="line">                                struct drm_modeset_acquire_ctx *ctx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @set_property:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is the legacy entry point to update a property attached to the</span></span><br><span class="line"><span class="comment">         * CRTC.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional if the driver does not support any legacy</span></span><br><span class="line"><span class="comment">         * driver-private properties. For atomic drivers it is not used because</span></span><br><span class="line"><span class="comment">         * property handling is done entirely in the DRM core.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*set_property)(struct drm_crtc *crtc,</span><br><span class="line">                            struct drm_property *property, <span class="keyword">uint64_t</span> val);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_duplicate_state:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Duplicate the current atomic state for this CRTC and return it.</span></span><br><span class="line"><span class="comment">         * The core and helpers guarantee that any atomic state duplicated with</span></span><br><span class="line"><span class="comment">         * this hook and still owned by the caller (i.e. not transferred to the</span></span><br><span class="line"><span class="comment">         * driver by calling &amp;drm_mode_config_funcs.atomic_commit) will be</span></span><br><span class="line"><span class="comment">         * cleaned up by calling the @atomic_destroy_state hook in this</span></span><br><span class="line"><span class="comment">         * structure.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is mandatory for atomic drivers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Atomic drivers which don&#x27;t subclass &amp;struct drm_crtc_state should use</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_crtc_duplicate_state(). Drivers that subclass the</span></span><br><span class="line"><span class="comment">         * state structure to extend it with driver-private state should use</span></span><br><span class="line"><span class="comment">         * __drm_atomic_helper_crtc_duplicate_state() to make sure shared state is</span></span><br><span class="line"><span class="comment">         * duplicated in a consistent fashion across drivers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * It is an error to call this hook before &amp;drm_crtc.state has been</span></span><br><span class="line"><span class="comment">         * initialized correctly.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If the duplicate state references refcounted resources this hook must</span></span><br><span class="line"><span class="comment">         * acquire a reference for each of them. The driver must release these</span></span><br><span class="line"><span class="comment">         * references again in @atomic_destroy_state.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Duplicated atomic state or NULL when the allocation failed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_state</span> *(*<span class="title">atomic_duplicate_state</span>)(<span class="title">struct</span> <span class="title">drm_crtc</span> *<span class="title">crtc</span>);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_destroy_state:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Destroy a state duplicated with @atomic_duplicate_state and release</span></span><br><span class="line"><span class="comment">         * or unreference all resources it references</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is mandatory for atomic drivers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*atomic_destroy_state)(struct drm_crtc *crtc,</span><br><span class="line">                                     struct drm_crtc_state *state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_set_property:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Decode a driver-private property value and store the decoded value</span></span><br><span class="line"><span class="comment">         * into the passed-in state structure. Since the atomic core decodes all</span></span><br><span class="line"><span class="comment">         * standardized properties (even for extensions beyond the core set of</span></span><br><span class="line"><span class="comment">         * properties which might not be implemented by all drivers) this</span></span><br><span class="line"><span class="comment">         * requires drivers to subclass the state structure.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Such driver-private properties should really only be implemented for</span></span><br><span class="line"><span class="comment">         * truly hardware/vendor specific state. Instead it is preferred to</span></span><br><span class="line"><span class="comment">         * standardize atomic extension and decode the properties used to expose</span></span><br><span class="line"><span class="comment">         * such an extension in the core.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Do not call this function directly, use</span></span><br><span class="line"><span class="comment">         * drm_atomic_crtc_set_property() instead.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional if the driver does not support any</span></span><br><span class="line"><span class="comment">         * driver-private atomic properties.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is called in the state assembly phase of atomic</span></span><br><span class="line"><span class="comment">         * modesets, which can be aborted for any reason (including on</span></span><br><span class="line"><span class="comment">         * userspace&#x27;s request to just check whether a configuration would be</span></span><br><span class="line"><span class="comment">         * possible). Drivers MUST NOT touch any persistent state (hardware or</span></span><br><span class="line"><span class="comment">         * software) or data structures except the passed in @state parameter.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Also since userspace controls in which order properties are set this</span></span><br><span class="line"><span class="comment">         * function must not do any input validation (since the state update is</span></span><br><span class="line"><span class="comment">         * incomplete and hence likely inconsistent). Instead any such input</span></span><br><span class="line"><span class="comment">         * validation must be done in the various atomic_check callbacks.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 if the property has been found, -EINVAL if the property isn&#x27;t</span></span><br><span class="line"><span class="comment">         * implemented by the driver (which should never happen, the core only</span></span><br><span class="line"><span class="comment">         * asks for properties attached to this CRTC). No other validation is</span></span><br><span class="line"><span class="comment">         * allowed by the driver. The core already checks that the property</span></span><br><span class="line"><span class="comment">         * value is within the range (integer, valid enum value, ...) the driver</span></span><br><span class="line"><span class="comment">         * set when registering the property.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*atomic_set_property)(struct drm_crtc *crtc,</span><br><span class="line">                                   struct drm_crtc_state *state,</span><br><span class="line">                                   struct drm_property *property,</span><br><span class="line">                                   <span class="keyword">uint64_t</span> val);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_get_property:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reads out the decoded driver-private property. This is used to</span></span><br><span class="line"><span class="comment">         * implement the GETCRTC IOCTL.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Do not call this function directly, use</span></span><br><span class="line"><span class="comment">         * drm_atomic_crtc_get_property() instead.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional if the driver does not support any</span></span><br><span class="line"><span class="comment">         * driver-private atomic properties.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success, -EINVAL if the property isn&#x27;t implemented by the</span></span><br><span class="line"><span class="comment">         * driver (which should never happen, the core only asks for</span></span><br><span class="line"><span class="comment">         * properties attached to this CRTC).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*atomic_get_property)(struct drm_crtc *crtc,</span><br><span class="line">                                   <span class="keyword">const</span> struct drm_crtc_state *state,</span><br><span class="line">                                   struct drm_property *property,</span><br><span class="line">                                   <span class="keyword">uint64_t</span> *val);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @late_register:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This optional hook can be used to register additional userspace</span></span><br><span class="line"><span class="comment">         * interfaces attached to the crtc like debugfs interfaces.</span></span><br><span class="line"><span class="comment">         * It is called late in the driver load sequence from drm_dev_register().</span></span><br><span class="line"><span class="comment">         * Everything added from this callback should be unregistered in</span></span><br><span class="line"><span class="comment">         * the early_unregister callback.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success, or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*late_register)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @early_unregister:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This optional hook should be used to unregister the additional</span></span><br><span class="line"><span class="comment">         * userspace interfaces attached to the crtc from</span></span><br><span class="line"><span class="comment">         * @late_register. It is called from drm_dev_unregister(),</span></span><br><span class="line"><span class="comment">         * early in the driver unload sequence to disable userspace access</span></span><br><span class="line"><span class="comment">         * before data structures are torndown.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*early_unregister)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @set_crc_source:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Changes the source of CRC checksums of frames at the request of</span></span><br><span class="line"><span class="comment">         * userspace, typically for testing purposes. The sources available are</span></span><br><span class="line"><span class="comment">         * specific of each driver and a %NULL value indicates that CRC</span></span><br><span class="line"><span class="comment">         * generation is to be switched off.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * When CRC generation is enabled, the driver should call</span></span><br><span class="line"><span class="comment">         * drm_crtc_add_crc_entry() at each frame, providing any information</span></span><br><span class="line"><span class="comment">         * that characterizes the frame contents in the crcN arguments, as</span></span><br><span class="line"><span class="comment">         * provided from the configured source. Drivers must accept an &quot;auto&quot;</span></span><br><span class="line"><span class="comment">         * source name that will select a default source for this CRTC.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This may trigger an atomic modeset commit if necessary, to enable CRC</span></span><br><span class="line"><span class="comment">         * generation.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that &quot;auto&quot; can depend upon the current modeset configuration,</span></span><br><span class="line"><span class="comment">         * e.g. it could pick an encoder or output specific CRC sampling point.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional if the driver does not support any CRC</span></span><br><span class="line"><span class="comment">         * generation functionality.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*set_crc_source)(struct drm_crtc *crtc, <span class="keyword">const</span> <span class="keyword">char</span> *source);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @verify_crc_source:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * verifies the source of CRC checksums of frames before setting the</span></span><br><span class="line"><span class="comment">         * source for CRC and during crc open. Source parameter can be NULL</span></span><br><span class="line"><span class="comment">         * while disabling crc source.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional if the driver does not support any CRC</span></span><br><span class="line"><span class="comment">         * generation functionality.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*verify_crc_source)(struct drm_crtc *crtc, <span class="keyword">const</span> <span class="keyword">char</span> *source,</span><br><span class="line">                                 <span class="keyword">size_t</span> *values_cnt);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @get_crc_sources:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Driver callback for getting a list of all the available sources for</span></span><br><span class="line"><span class="comment">         * CRC generation. This callback depends upon verify_crc_source, So</span></span><br><span class="line"><span class="comment">         * verify_crc_source callback should be implemented before implementing</span></span><br><span class="line"><span class="comment">         * this. Driver can pass full list of available crc sources, this</span></span><br><span class="line"><span class="comment">         * callback does the verification on each crc-source before passing it</span></span><br><span class="line"><span class="comment">         * to userspace.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional if the driver does not support exporting of</span></span><br><span class="line"><span class="comment">         * possible CRC sources list.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * a constant character pointer to the list of all the available CRC</span></span><br><span class="line"><span class="comment">         * sources. On failure driver should return NULL. count should be</span></span><br><span class="line"><span class="comment">         * updated with number of sources in list. if zero we don&#x27;t process any</span></span><br><span class="line"><span class="comment">         * source from the list.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> *(*get_crc_sources)(struct drm_crtc *crtc,</span><br><span class="line">                                              <span class="keyword">size_t</span> *count);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_print_state:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If driver subclasses &amp;struct drm_crtc_state, it should implement</span></span><br><span class="line"><span class="comment">         * this optional hook for printing additional driver specific state.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Do not call this directly, use drm_atomic_crtc_print_state()</span></span><br><span class="line"><span class="comment">         * instead.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*atomic_print_state)(struct drm_printer *p,</span><br><span class="line">                                   <span class="keyword">const</span> struct drm_crtc_state *state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @get_vblank_counter:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Driver callback for fetching a raw hardware vblank counter for the</span></span><br><span class="line"><span class="comment">         * CRTC. It&#x27;s meant to be used by new drivers as the replacement of</span></span><br><span class="line"><span class="comment">         * &amp;drm_driver.get_vblank_counter hook.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional. If a device doesn&#x27;t have a hardware</span></span><br><span class="line"><span class="comment">         * counter, the driver can simply leave the hook as NULL. The DRM core</span></span><br><span class="line"><span class="comment">         * will account for missed vblank events while interrupts where disabled</span></span><br><span class="line"><span class="comment">         * based on system timestamps.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Wraparound handling and loss of events due to modesetting is dealt</span></span><br><span class="line"><span class="comment">         * with in the DRM core code, as long as drivers call</span></span><br><span class="line"><span class="comment">         * drm_crtc_vblank_off() and drm_crtc_vblank_on() when disabling or</span></span><br><span class="line"><span class="comment">         * enabling a CRTC.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * See also &amp;drm_device.vblank_disable_immediate and</span></span><br><span class="line"><span class="comment">         * &amp;drm_device.max_vblank_count.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Raw vblank counter value.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u32 (*get_vblank_counter)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @enable_vblank:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Enable vblank interrupts for the CRTC. It&#x27;s meant to be used by</span></span><br><span class="line"><span class="comment">         * new drivers as the replacement of &amp;drm_driver.enable_vblank hook.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Zero on success, appropriate errno if the vblank interrupt cannot</span></span><br><span class="line"><span class="comment">         * be enabled.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*enable_vblank)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @disable_vblank:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Disable vblank interrupts for the CRTC. It&#x27;s meant to be used by</span></span><br><span class="line"><span class="comment">         * new drivers as the replacement of &amp;drm_driver.disable_vblank hook.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*disable_vblank)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @get_vblank_timestamp:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Called by drm_get_last_vbltimestamp(). Should return a precise</span></span><br><span class="line"><span class="comment">         * timestamp when the most recent vblank interval ended or will end.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Specifically, the timestamp in @vblank_time should correspond as</span></span><br><span class="line"><span class="comment">         * closely as possible to the time when the first video scanline of</span></span><br><span class="line"><span class="comment">         * the video frame after the end of vblank will start scanning out,</span></span><br><span class="line"><span class="comment">         * the time immediately after end of the vblank interval. If the</span></span><br><span class="line"><span class="comment">         * @crtc is currently inside vblank, this will be a time in the future.</span></span><br><span class="line"><span class="comment">         * If the @crtc is currently scanning out a frame, this will be the</span></span><br><span class="line"><span class="comment">         * past start time of the current scanout. This is meant to adhere</span></span><br><span class="line"><span class="comment">         * to the OpenML OML_sync_control extension specification.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Parameters:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * crtc:</span></span><br><span class="line"><span class="comment">         *     CRTC for which timestamp should be returned.</span></span><br><span class="line"><span class="comment">         * max_error:</span></span><br><span class="line"><span class="comment">         *     Maximum allowable timestamp error in nanoseconds.</span></span><br><span class="line"><span class="comment">         *     Implementation should strive to provide timestamp</span></span><br><span class="line"><span class="comment">         *     with an error of at most max_error nanoseconds.</span></span><br><span class="line"><span class="comment">         *     Returns true upper bound on error for timestamp.</span></span><br><span class="line"><span class="comment">         * vblank_time:</span></span><br><span class="line"><span class="comment">         *     Target location for returned vblank timestamp.</span></span><br><span class="line"><span class="comment">         * in_vblank_irq:</span></span><br><span class="line"><span class="comment">         *     True when called from drm_crtc_handle_vblank().  Some drivers</span></span><br><span class="line"><span class="comment">         *     need to apply some workarounds for gpu-specific vblank irq quirks</span></span><br><span class="line"><span class="comment">         *     if flag is set.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * True on success, false on failure, which means the core should</span></span><br><span class="line"><span class="comment">         * fallback to a simple timestamp taken in drm_crtc_handle_vblank().</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> (*get_vblank_timestamp)(struct drm_crtc *crtc,</span><br><span class="line">                                     <span class="keyword">int</span> *max_error,</span><br><span class="line">                                     <span class="keyword">ktime_t</span> *vblank_time,</span><br><span class="line">                                     <span class="keyword">bool</span> in_vblank_irq);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里定义了一大堆回调函数：</p>
<ul>
<li><p><code>reset</code>：用于将<code>crtc</code>硬件和软件重置为关闭状态，这个函数不会直接调用，只会通过<code>drm_mode_config_reset</code>调用；</p>
</li>
<li><p><code>cursor_set</code>：更新光标图像，光标位置是相对于<code>crtc</code>，并且可以部分或完全位于可见区域之外；</p>
</li>
<li><p><code>cursor_set2</code>：更新光标图像，包括热点信息；</p>
</li>
<li><p><code>cursor_move</code>：更新光标位置。在调用此钩子时，光标不需要可见；</p>
</li>
<li><p><code>gamma_set</code>：在<code>crtc</code>上设置<code>gamma</code>；</p>
</li>
<li><p><code>destroy</code>：清理<code>crtc</code>资源；</p>
</li>
<li><p><code>set_config</code>：改变<code>modeset state</code>， 负责配置几个内容：</p>
<ul>
<li>更新正在扫描的<code>framebuffer</code>；</li>
<li>配置显示模式：时序、分辨率等;</li>
<li>将连接器/编码器附加到<code>crtc</code>；</li>
</ul>
</li>
<li><p><code>page_flip</code>：用于反转给定的<code>framebuffer</code>；</p>
</li>
<li><p>…</p>
</li>
</ul>
<h5 id="2-2-2-struct-drm-crtc-helper-funcs"><a href="#2-2-2-struct-drm-crtc-helper-funcs" class="headerlink" title="2.2.2 struct drm_crtc_helper_funcs"></a>2.2.2 <code>struct drm_crtc_helper_funcs</code></h5><p><code>struct drm_crtc_helper_funcs</code>用于定义与<code>crtc</code>助手函数相关的操作。这些助手函数提供了一些辅助性的操作，如时序生成、同步信号发送、格式转换等，以便更好地协助实现扫描输出帧缓冲区内容的功能。定义在<code>include/drm/drm_modeset_helper_vtables.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_crtc_helper_funcs - helper operations for CRTCs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These hooks are used by the legacy CRTC helpers, the transitional plane</span></span><br><span class="line"><span class="comment"> * helpers and the new atomic modesetting helpers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_helper_funcs</span> &#123;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @dpms:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Callback to control power levels on the CRTC.  If the mode passed in</span></span><br><span class="line"><span class="comment">         * is unsupported, the provider must use the next lowest power level.</span></span><br><span class="line"><span class="comment">         * This is used by the legacy CRTC helpers to implement DPMS</span></span><br><span class="line"><span class="comment">         * functionality in drm_helper_connector_dpms().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is also used to disable a CRTC by calling it with</span></span><br><span class="line"><span class="comment">         * DRM_MODE_DPMS_OFF if the @disable hook isn&#x27;t used.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the legacy CRTC helpers.  Atomic helpers</span></span><br><span class="line"><span class="comment">         * also support using this hook for enabling and disabling a CRTC to</span></span><br><span class="line"><span class="comment">         * facilitate transitions to atomic, but it is deprecated. Instead</span></span><br><span class="line"><span class="comment">         * @atomic_enable and @atomic_disable should be used.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*dpms)(struct drm_crtc *crtc, <span class="keyword">int</span> mode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @prepare:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback should prepare the CRTC for a subsequent modeset, which</span></span><br><span class="line"><span class="comment">         * in practice means the driver should disable the CRTC if it is</span></span><br><span class="line"><span class="comment">         * running. Most drivers ended up implementing this by calling their</span></span><br><span class="line"><span class="comment">         * @dpms hook with DRM_MODE_DPMS_OFF.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the legacy CRTC helpers.  Atomic helpers</span></span><br><span class="line"><span class="comment">         * also support using this hook for disabling a CRTC to facilitate</span></span><br><span class="line"><span class="comment">         * transitions to atomic, but it is deprecated. Instead @atomic_disable</span></span><br><span class="line"><span class="comment">         * should be used.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*prepare)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @commit:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback should commit the new mode on the CRTC after a modeset,</span></span><br><span class="line"><span class="comment">         * which in practice means the driver should enable the CRTC.  Most</span></span><br><span class="line"><span class="comment">         * drivers ended up implementing this by calling their @dpms hook with</span></span><br><span class="line"><span class="comment">         * DRM_MODE_DPMS_ON.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the legacy CRTC helpers.  Atomic helpers</span></span><br><span class="line"><span class="comment">         * also support using this hook for enabling a CRTC to facilitate</span></span><br><span class="line"><span class="comment">         * transitions to atomic, but it is deprecated. Instead @atomic_enable</span></span><br><span class="line"><span class="comment">         * should be used.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*commit)(struct drm_crtc *crtc);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_valid:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used to check if a specific mode is valid in this</span></span><br><span class="line"><span class="comment">         * crtc. This should be implemented if the crtc has some sort of</span></span><br><span class="line"><span class="comment">         * restriction in the modes it can display. For example, a given crtc</span></span><br><span class="line"><span class="comment">         * may be responsible to set a clock value. If the clock can not</span></span><br><span class="line"><span class="comment">         * produce all the values for the available modes then this callback</span></span><br><span class="line"><span class="comment">         * can be used to restrict the number of modes to only the ones that</span></span><br><span class="line"><span class="comment">         * can be displayed.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This hook is used by the probe helpers to filter the mode list in</span></span><br><span class="line"><span class="comment">         * drm_helper_probe_single_connector_modes(), and it is used by the</span></span><br><span class="line"><span class="comment">         * atomic helpers to validate modes supplied by userspace in</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_check_modeset().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Since this function is both called from the check phase of an atomic</span></span><br><span class="line"><span class="comment">         * commit, and the mode validation in the probe paths it is not allowed</span></span><br><span class="line"><span class="comment">         * to look at anything else but the passed-in mode, and validate it</span></span><br><span class="line"><span class="comment">         * against configuration-invariant hardward constraints. Any further</span></span><br><span class="line"><span class="comment">         * limits which depend upon the configuration can only be checked in</span></span><br><span class="line"><span class="comment">         * @mode_fixup or @atomic_check.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * drm_mode_status Enum</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">enum</span> <span class="title">drm_mode_status</span> <span class="params">(*mode_valid)</span><span class="params">(struct drm_crtc *crtc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           <span class="keyword">const</span> struct drm_display_mode *mode)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_fixup:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used to validate a mode. The parameter mode is the</span></span><br><span class="line"><span class="comment">         * display mode that userspace requested, adjusted_mode is the mode the</span></span><br><span class="line"><span class="comment">         * encoders need to be fed with. Note that this is the inverse semantics</span></span><br><span class="line"><span class="comment">         * of the meaning for the &amp;drm_encoder and &amp;drm_bridge_funcs.mode_fixup</span></span><br><span class="line"><span class="comment">         * vfunc. If the CRTC cannot support the requested conversion from mode</span></span><br><span class="line"><span class="comment">         * to adjusted_mode it should reject the modeset. See also</span></span><br><span class="line"><span class="comment">         * &amp;drm_crtc_state.adjusted_mode for more details.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is used by both legacy CRTC helpers and atomic helpers.</span></span><br><span class="line"><span class="comment">         * With atomic helpers it is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is called in the check phase of atomic modesets, which</span></span><br><span class="line"><span class="comment">         * can be aborted for any reason (including on userspace&#x27;s request to</span></span><br><span class="line"><span class="comment">         * just check whether a configuration would be possible). Atomic drivers</span></span><br><span class="line"><span class="comment">         * MUST NOT touch any persistent state (hardware or software) or data</span></span><br><span class="line"><span class="comment">         * structures except the passed in adjusted_mode parameter.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is in contrast to the legacy CRTC helpers where this was</span></span><br><span class="line"><span class="comment">         * allowed.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Atomic drivers which need to inspect and adjust more state should</span></span><br><span class="line"><span class="comment">         * instead use the @atomic_check callback, but note that they&#x27;re not</span></span><br><span class="line"><span class="comment">         * perfectly equivalent: @mode_valid is called from</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_check_modeset(), but @atomic_check is called from</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_check_planes(), because originally it was meant for</span></span><br><span class="line"><span class="comment">         * plane update checks only.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Also beware that userspace can request its own custom modes, neither</span></span><br><span class="line"><span class="comment">         * core nor helpers filter modes to the list of probe modes reported by</span></span><br><span class="line"><span class="comment">         * the GETCONNECTOR IOCTL and stored in &amp;drm_connector.modes. To ensure</span></span><br><span class="line"><span class="comment">         * that modes are filtered consistently put any CRTC constraints and</span></span><br><span class="line"><span class="comment">         * limits checks into @mode_valid.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * True if an acceptable configuration is possible, false if the modeset</span></span><br><span class="line"><span class="comment">         * operation should be rejected.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> (*mode_fixup)(struct drm_crtc *crtc,</span><br><span class="line">                           <span class="keyword">const</span> struct drm_display_mode *mode,</span><br><span class="line">                           struct drm_display_mode *adjusted_mode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_set:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the legacy CRTC helpers to set a new mode,</span></span><br><span class="line"><span class="comment">         * position and framebuffer. Since it ties the primary plane to every</span></span><br><span class="line"><span class="comment">         * mode change it is incompatible with universal plane support. And</span></span><br><span class="line"><span class="comment">         * since it can&#x27;t update other planes it&#x27;s incompatible with atomic</span></span><br><span class="line"><span class="comment">         * modeset support.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is only used by CRTC helpers and deprecated.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*mode_set)(struct drm_crtc *crtc, struct drm_display_mode *mode,</span><br><span class="line">                        struct drm_display_mode *adjusted_mode, <span class="keyword">int</span> x, <span class="keyword">int</span> y,</span><br><span class="line">                        struct drm_framebuffer *old_fb);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_set_nofb:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used to update the display mode of a CRTC without</span></span><br><span class="line"><span class="comment">         * changing anything of the primary plane configuration. This fits the</span></span><br><span class="line"><span class="comment">         * requirement of atomic and hence is used by the atomic helpers. It is</span></span><br><span class="line"><span class="comment">         * also used by the transitional plane helpers to implement a</span></span><br><span class="line"><span class="comment">         * @mode_set hook in drm_helper_crtc_mode_set().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that the display pipe is completely off when this function is</span></span><br><span class="line"><span class="comment">         * called. Atomic drivers which need hardware to be running before they</span></span><br><span class="line"><span class="comment">         * program the new display mode (e.g. because they implement runtime PM)</span></span><br><span class="line"><span class="comment">         * should not use this hook. This is because the helper library calls</span></span><br><span class="line"><span class="comment">         * this hook only once per mode change and not every time the display</span></span><br><span class="line"><span class="comment">         * pipeline is suspended using either DPMS or the new &quot;ACTIVE&quot; property.</span></span><br><span class="line"><span class="comment">         * Which means register values set in this callback might get reset when</span></span><br><span class="line"><span class="comment">         * the CRTC is suspended, but not restored.  Such drivers should instead</span></span><br><span class="line"><span class="comment">         * move all their CRTC setup into the @atomic_enable callback.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*mode_set_nofb)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_set_base:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the legacy CRTC helpers to set a new</span></span><br><span class="line"><span class="comment">         * framebuffer and scanout position. It is optional and used as an</span></span><br><span class="line"><span class="comment">         * optimized fast-path instead of a full mode set operation with all the</span></span><br><span class="line"><span class="comment">         * resulting flickering. If it is not present</span></span><br><span class="line"><span class="comment">         * drm_crtc_helper_set_config() will fall back to a full modeset, using</span></span><br><span class="line"><span class="comment">         * the @mode_set callback. Since it can&#x27;t update other planes it&#x27;s</span></span><br><span class="line"><span class="comment">         * incompatible with atomic modeset support.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is only used by the CRTC helpers and deprecated.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*mode_set_base)(struct drm_crtc *crtc, <span class="keyword">int</span> x, <span class="keyword">int</span> y,</span><br><span class="line">                             struct drm_framebuffer *old_fb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @mode_set_base_atomic:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the fbdev helpers to set a new framebuffer</span></span><br><span class="line"><span class="comment">         * and scanout without sleeping, i.e. from an atomic calling context. It</span></span><br><span class="line"><span class="comment">         * is only used to implement kgdb support.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is optional and only needed for kgdb support in the fbdev</span></span><br><span class="line"><span class="comment">         * helpers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success or a negative error code on failure.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*mode_set_base_atomic)(struct drm_crtc *crtc,</span><br><span class="line">                                    struct drm_framebuffer *fb, <span class="keyword">int</span> x, <span class="keyword">int</span> y,</span><br><span class="line">                                    <span class="keyword">enum</span> mode_set_atomic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @disable:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback should be used to disable the CRTC. With the atomic</span></span><br><span class="line"><span class="comment">         * drivers it is called after all encoders connected to this CRTC have</span></span><br><span class="line"><span class="comment">         * been shut off already using their own</span></span><br><span class="line"><span class="comment">         * &amp;drm_encoder_helper_funcs.disable hook. If that sequence is too</span></span><br><span class="line"><span class="comment">         * simple drivers can just add their own hooks and call it from this</span></span><br><span class="line"><span class="comment">         * CRTC callback here by looping over all encoders connected to it using</span></span><br><span class="line"><span class="comment">         * for_each_encoder_on_crtc().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This hook is used both by legacy CRTC helpers and atomic helpers.</span></span><br><span class="line"><span class="comment">         * Atomic drivers don&#x27;t need to implement it if there&#x27;s no need to</span></span><br><span class="line"><span class="comment">         * disable anything at the CRTC level. To ensure that runtime PM</span></span><br><span class="line"><span class="comment">         * handling (using either DPMS or the new &quot;ACTIVE&quot; property) works</span></span><br><span class="line"><span class="comment">         * @disable must be the inverse of @atomic_enable for atomic drivers.</span></span><br><span class="line"><span class="comment">         * Atomic drivers should consider to use @atomic_disable instead of</span></span><br><span class="line"><span class="comment">         * this one.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * With legacy CRTC helpers there&#x27;s a big semantic difference between</span></span><br><span class="line"><span class="comment">         * @disable and other hooks (like @prepare or @dpms) used to shut down a</span></span><br><span class="line"><span class="comment">         * CRTC: @disable is only called when also logically disabling the</span></span><br><span class="line"><span class="comment">         * display pipeline and needs to release any resources acquired in</span></span><br><span class="line"><span class="comment">         * @mode_set (like shared PLLs, or again release pinned framebuffers).</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Therefore @disable must be the inverse of @mode_set plus @commit for</span></span><br><span class="line"><span class="comment">         * drivers still using legacy CRTC helpers, which is different from the</span></span><br><span class="line"><span class="comment">         * rules under atomic.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*disable)(struct drm_crtc *crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_check:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Drivers should check plane-update related CRTC constraints in this</span></span><br><span class="line"><span class="comment">         * hook. They can also check mode related limitations but need to be</span></span><br><span class="line"><span class="comment">         * aware of the calling order, since this hook is used by</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_check_planes() whereas the preparations needed to</span></span><br><span class="line"><span class="comment">         * check output routing and the display mode is done in</span></span><br><span class="line"><span class="comment">         * drm_atomic_helper_check_modeset(). Therefore drivers that want to</span></span><br><span class="line"><span class="comment">         * check output routing and display mode constraints in this callback</span></span><br><span class="line"><span class="comment">         * must ensure that drm_atomic_helper_check_modeset() has been called</span></span><br><span class="line"><span class="comment">         * beforehand. This is calling order used by the default helper</span></span><br><span class="line"><span class="comment">         * implementation in drm_atomic_helper_check().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * When using drm_atomic_helper_check_planes() this hook is called</span></span><br><span class="line"><span class="comment">         * after the &amp;drm_plane_helper_funcs.atomic_check hook for planes, which</span></span><br><span class="line"><span class="comment">         * allows drivers to assign shared resources requested by planes in this</span></span><br><span class="line"><span class="comment">         * callback here. For more complicated dependencies the driver can call</span></span><br><span class="line"><span class="comment">         * the provided check helpers multiple times until the computed state</span></span><br><span class="line"><span class="comment">         * has a final configuration and everything has been checked.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is also allowed to inspect any other object&#x27;s state and</span></span><br><span class="line"><span class="comment">         * can add more state objects to the atomic commit if needed. Care must</span></span><br><span class="line"><span class="comment">         * be taken though to ensure that state check and compute functions for</span></span><br><span class="line"><span class="comment">         * these added states are all called, and derived state in other objects</span></span><br><span class="line"><span class="comment">         * all updated. Again the recommendation is to just call check helpers</span></span><br><span class="line"><span class="comment">         * until a maximal configuration is reached.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the atomic modeset helpers and by the</span></span><br><span class="line"><span class="comment">         * transitional plane helpers, but it is optional.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is called in the check phase of an atomic update. The</span></span><br><span class="line"><span class="comment">         * driver is not allowed to change anything outside of the free-standing</span></span><br><span class="line"><span class="comment">         * state object passed-in.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Also beware that userspace can request its own custom modes, neither</span></span><br><span class="line"><span class="comment">         * core nor helpers filter modes to the list of probe modes reported by</span></span><br><span class="line"><span class="comment">         * the GETCONNECTOR IOCTL and stored in &amp;drm_connector.modes. To ensure</span></span><br><span class="line"><span class="comment">         * that modes are filtered consistently put any CRTC constraints and</span></span><br><span class="line"><span class="comment">         * limits checks into @mode_valid.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * RETURNS:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 0 on success, -EINVAL if the state or the transition can&#x27;t be</span></span><br><span class="line"><span class="comment">         * supported, -ENOMEM on memory allocation failure and -EDEADLK if an</span></span><br><span class="line"><span class="comment">         * attempt to obtain another state object ran into a &amp;drm_modeset_lock</span></span><br><span class="line"><span class="comment">         * deadlock.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> (*atomic_check)(struct drm_crtc *crtc,</span><br><span class="line">                            struct drm_atomic_state *state);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_begin:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Drivers should prepare for an atomic update of multiple planes on</span></span><br><span class="line"><span class="comment">         * a CRTC in this hook. Depending upon hardware this might be vblank</span></span><br><span class="line"><span class="comment">         * evasion, blocking updates by setting bits or doing preparatory work</span></span><br><span class="line"><span class="comment">         * for e.g. manual update display.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This hook is called before any plane commit functions are called.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that the power state of the display pipe when this function is</span></span><br><span class="line"><span class="comment">         * called depends upon the exact helpers and calling sequence the driver</span></span><br><span class="line"><span class="comment">         * has picked. See drm_atomic_helper_commit_planes() for a discussion of</span></span><br><span class="line"><span class="comment">         * the tradeoffs and variants of plane commit helpers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the atomic modeset helpers and by the</span></span><br><span class="line"><span class="comment">         * transitional plane helpers, but it is optional.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*atomic_begin)(struct drm_crtc *crtc,</span><br><span class="line">                             struct drm_atomic_state *state);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_flush:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Drivers should finalize an atomic update of multiple planes on</span></span><br><span class="line"><span class="comment">         * a CRTC in this hook. Depending upon hardware this might include</span></span><br><span class="line"><span class="comment">         * checking that vblank evasion was successful, unblocking updates by</span></span><br><span class="line"><span class="comment">         * setting bits or setting the GO bit to flush out all updates.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Simple hardware or hardware with special requirements can commit and</span></span><br><span class="line"><span class="comment">         * flush out all updates for all planes from this hook and forgo all the</span></span><br><span class="line"><span class="comment">         * other commit hooks for plane updates.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This hook is called after any plane commit functions are called.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that the power state of the display pipe when this function is</span></span><br><span class="line"><span class="comment">         * called depends upon the exact helpers and calling sequence the driver</span></span><br><span class="line"><span class="comment">         * has picked. See drm_atomic_helper_commit_planes() for a discussion of</span></span><br><span class="line"><span class="comment">         * the tradeoffs and variants of plane commit helpers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback is used by the atomic modeset helpers and by the</span></span><br><span class="line"><span class="comment">         * transitional plane helpers, but it is optional.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*atomic_flush)(struct drm_crtc *crtc,</span><br><span class="line">                             struct drm_atomic_state *state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_enable:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback should be used to enable the CRTC. With the atomic</span></span><br><span class="line"><span class="comment">         * drivers it is called before all encoders connected to this CRTC are</span></span><br><span class="line"><span class="comment">         * enabled through the encoder&#x27;s own &amp;drm_encoder_helper_funcs.enable</span></span><br><span class="line"><span class="comment">         * hook.  If that sequence is too simple drivers can just add their own</span></span><br><span class="line"><span class="comment">         * hooks and call it from this CRTC callback here by looping over all</span></span><br><span class="line"><span class="comment">         * encoders connected to it using for_each_encoder_on_crtc().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This hook is used only by atomic helpers, for symmetry with</span></span><br><span class="line"><span class="comment">         * @atomic_disable. Atomic drivers don&#x27;t need to implement it if there&#x27;s</span></span><br><span class="line"><span class="comment">         * no need to enable anything at the CRTC level. To ensure that runtime</span></span><br><span class="line"><span class="comment">         * PM handling (using either DPMS or the new &quot;ACTIVE&quot; property) works</span></span><br><span class="line"><span class="comment">         * @atomic_enable must be the inverse of @atomic_disable for atomic</span></span><br><span class="line"><span class="comment">         * drivers.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is optional.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*atomic_enable)(struct drm_crtc *crtc,</span><br><span class="line">                              struct drm_atomic_state *state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @atomic_disable:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This callback should be used to disable the CRTC. With the atomic</span></span><br><span class="line"><span class="comment">         * drivers it is called after all encoders connected to this CRTC have</span></span><br><span class="line"><span class="comment">         * been shut off already using their own</span></span><br><span class="line"><span class="comment">         * &amp;drm_encoder_helper_funcs.disable hook. If that sequence is too</span></span><br><span class="line"><span class="comment">         * simple drivers can just add their own hooks and call it from this</span></span><br><span class="line"><span class="comment">         * CRTC callback here by looping over all encoders connected to it using</span></span><br><span class="line"><span class="comment">         * for_each_encoder_on_crtc().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This hook is used only by atomic helpers. Atomic drivers don&#x27;t</span></span><br><span class="line"><span class="comment">         * need to implement it if there&#x27;s no need to disable anything at the</span></span><br><span class="line"><span class="comment">         * CRTC level.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This function is optional.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">void</span> (*atomic_disable)(struct drm_crtc *crtc,</span><br><span class="line">                               struct drm_atomic_state *state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @get_scanout_position:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Called by vblank timestamping code.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns the current display scanout position from a CRTC and an</span></span><br><span class="line"><span class="comment">         * optional accurate ktime_get() timestamp of when the position was</span></span><br><span class="line"><span class="comment">         * measured. Note that this is a helper callback which is only used</span></span><br><span class="line"><span class="comment">         * if a driver uses drm_crtc_vblank_helper_get_vblank_timestamp()</span></span><br><span class="line"><span class="comment">         * for the @drm_crtc_funcs.get_vblank_timestamp callback.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Parameters:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * crtc:</span></span><br><span class="line"><span class="comment">         *     The CRTC.</span></span><br><span class="line"><span class="comment">         * in_vblank_irq:</span></span><br><span class="line"><span class="comment">         *     True when called from drm_crtc_handle_vblank(). Some drivers</span></span><br><span class="line"><span class="comment">         *     need to apply some workarounds for gpu-specific vblank irq</span></span><br><span class="line"><span class="comment">         *     quirks if the flag is set.</span></span><br><span class="line"><span class="comment">         * vpos:</span></span><br><span class="line"><span class="comment">         *     Target location for current vertical scanout position.</span></span><br><span class="line"><span class="comment">         * hpos:</span></span><br><span class="line"><span class="comment">         *     Target location for current horizontal scanout position.</span></span><br><span class="line"><span class="comment">         * stime:</span></span><br><span class="line"><span class="comment">         *     Target location for timestamp taken immediately before</span></span><br><span class="line"><span class="comment">         *     scanout position query. Can be NULL to skip timestamp.</span></span><br><span class="line"><span class="comment">         * etime:</span></span><br><span class="line"><span class="comment">         *     Target location for timestamp taken immediately after</span></span><br><span class="line"><span class="comment">         *     scanout position query. Can be NULL to skip timestamp.</span></span><br><span class="line"><span class="comment">         * mode:</span></span><br><span class="line"><span class="comment">         *     Current display timings.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns vpos as a positive number while in active scanout area.</span></span><br><span class="line"><span class="comment">         * Returns vpos as a negative number inside vblank, counting the number</span></span><br><span class="line"><span class="comment">         * of scanlines to go until end of vblank, e.g., -1 means &quot;one scanline</span></span><br><span class="line"><span class="comment">         * until start of active scanout / end of vblank.&quot;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * True on success, false if a reliable scanout position counter could</span></span><br><span class="line"><span class="comment">         * not be read out.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">bool</span> (*get_scanout_position)(struct drm_crtc *crtc,</span><br><span class="line">                                     <span class="keyword">bool</span> in_vblank_irq, <span class="keyword">int</span> *vpos, <span class="keyword">int</span> *hpos,</span><br><span class="line">                                     <span class="keyword">ktime_t</span> *stime, <span class="keyword">ktime_t</span> *etime,</span><br><span class="line">                                     <span class="keyword">const</span> struct drm_display_mode *mode);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><p><code>dpms</code>：电源管理接口，一般由<code>drm_helper_connector_dpms</code>调用；</p>
</li>
<li><p><code>prepare</code>：为<code>modeset</code>做准备，一般就是调用<code>dpms</code>接口关闭<code>crtc</code>；</p>
</li>
<li><p><code>commit</code>：和<code>prepare</code>接口对应，是在<code>modeset</code>完成后，调用该接口来<code>enable crtc</code>;</p>
</li>
<li><p><code>drm_mode_status</code> ：检查<code>display mode</code>的有效性， <code>drm_helper_probe_single_connector_modes</code>和<code>drm_atomic_helper_check_modeset</code>会调用到；</p>
</li>
<li><p><code>disable</code>：关闭<code>crtc</code>；</p>
</li>
<li><p><code>atomic_check</code>：检查待更新的<code>drm_crtc_state</code>；</p>
</li>
<li><p><code>mode_set</code>：这个回调函数被<code>legacy CRTC helpers</code>用来设置新的模式、位置和<code>framebuffer</code>；</p>
</li>
</ul>
<h3 id="三、核心API"><a href="#三、核心API" class="headerlink" title="三、核心API"></a>三、核心<code>API</code></h3><h4 id="3-1-drm-crtc-init-with-planes"><a href="#3-1-drm-crtc-init-with-planes" class="headerlink" title="3.1 drm_crtc_init_with_planes"></a>3.1 <code>drm_crtc_init_with_planes</code></h4><p><code>drm_crtc_init_with_planes</code>函数使用指定的<code>primary and cursor planes</code>初始化的<code>crtc</code>对象，定义在<code>drivers/gpu/drm/drm_crtc.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_crtc_init_with_planes - Initialise a new CRTC object with</span></span><br><span class="line"><span class="comment"> *    specified primary and cursor planes.</span></span><br><span class="line"><span class="comment"> * @dev: DRM device</span></span><br><span class="line"><span class="comment"> * @crtc: CRTC object to init</span></span><br><span class="line"><span class="comment"> * @primary: Primary plane for CRTC</span></span><br><span class="line"><span class="comment"> * @cursor: Cursor plane for CRTC</span></span><br><span class="line"><span class="comment"> * @funcs: callbacks for the new CRTC</span></span><br><span class="line"><span class="comment"> * @name: printf style format string for the CRTC name, or NULL for default name</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Inits a new object created as base part of a driver crtc object. Drivers</span></span><br><span class="line"><span class="comment"> * should use this function instead of drm_crtc_init(), which is only provided</span></span><br><span class="line"><span class="comment"> * for backwards compatibility with drivers which do not yet support universal</span></span><br><span class="line"><span class="comment"> * planes). For really simple hardware which has only 1 plane look at</span></span><br><span class="line"><span class="comment"> * drm_simple_display_pipe_init() instead.</span></span><br><span class="line"><span class="comment"> * The &amp;drm_crtc_funcs.destroy hook should call drm_crtc_cleanup() and kfree()</span></span><br><span class="line"><span class="comment"> * the crtc structure. The crtc structure should not be allocated with</span></span><br><span class="line"><span class="comment"> * devm_kzalloc().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The @primary and @cursor planes are only relevant for legacy uAPI, see</span></span><br><span class="line"><span class="comment"> * &amp;drm_crtc.primary and &amp;drm_crtc.cursor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: consider using drmm_crtc_alloc_with_planes() or</span></span><br><span class="line"><span class="comment"> * drmm_crtc_init_with_planes() instead of drm_crtc_init_with_planes()</span></span><br><span class="line"><span class="comment"> * to let the DRM managed resource infrastructure take care of cleanup</span></span><br><span class="line"><span class="comment"> * and deallocation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns:</span></span><br><span class="line"><span class="comment"> * Zero on success, error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">drm_crtc_init_with_planes</span><span class="params">(struct drm_device *dev, struct drm_crtc *crtc,  </span></span></span><br><span class="line"><span class="function"><span class="params">                              struct drm_plane *primary,           <span class="comment">// primary plane</span></span></span></span><br><span class="line"><span class="function"><span class="params">                              struct drm_plane *cursor,            <span class="comment">// cursor plane</span></span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">const</span> struct drm_crtc_funcs *funcs,  <span class="comment">// crtc回调函数，重点关注</span></span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">const</span> <span class="keyword">char</span> *name, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        va_list ap;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        WARN_ON(!funcs-&gt;destroy);</span><br><span class="line"></span><br><span class="line">        va_start(ap, name);</span><br><span class="line">        ret = __drm_crtc_init_with_planes(dev, crtc, primary, cursor, funcs,</span><br><span class="line">                                          name, ap);</span><br><span class="line">        va_end(ap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>drm_crtc_init_with_planes</code>功能是由<code>__drm_crtc_init_with_planes</code>实现的；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DOC: standard CRTC properties</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DRM CRTCs have a few standardized properties:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ACTIVE:</span></span><br><span class="line"><span class="comment"> *      Atomic property for setting the power state of the CRTC. When set to 1</span></span><br><span class="line"><span class="comment"> *      the CRTC will actively display content. When set to 0 the CRTC will be</span></span><br><span class="line"><span class="comment"> *      powered off. There is no expectation that user-space will reset CRTC</span></span><br><span class="line"><span class="comment"> *      resources like the mode and planes when setting ACTIVE to 0.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      User-space can rely on an ACTIVE change to 1 to never fail an atomic</span></span><br><span class="line"><span class="comment"> *      test as long as no other property has changed. If a change to ACTIVE</span></span><br><span class="line"><span class="comment"> *      fails an atomic test, this is a driver bug. For this reason setting</span></span><br><span class="line"><span class="comment"> *      ACTIVE to 0 must not release internal resources (like reserved memory</span></span><br><span class="line"><span class="comment"> *      bandwidth or clock generators).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      Note that the legacy DPMS property on connectors is internally routed</span></span><br><span class="line"><span class="comment"> *      to control this property for atomic drivers.</span></span><br><span class="line"><span class="comment"> * MODE_ID:</span></span><br><span class="line"><span class="comment"> *      Atomic property for setting the CRTC display timings. The value is the</span></span><br><span class="line"><span class="comment"> *      ID of a blob containing the DRM mode info. To disable the CRTC,</span></span><br><span class="line"><span class="comment"> *      user-space must set this property to 0.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      Setting MODE_ID to 0 will release reserved resources for the CRTC.</span></span><br><span class="line"><span class="comment"> * SCALING_FILTER:</span></span><br><span class="line"><span class="comment"> *      Atomic property for setting the scaling filter for CRTC scaler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      The value of this property can be one of the following:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      Default:</span></span><br><span class="line"><span class="comment"> *              Driver&#x27;s default scaling filter</span></span><br><span class="line"><span class="comment"> *      Nearest Neighbor:</span></span><br><span class="line"><span class="comment"> *              Nearest Neighbor scaling filter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">__printf(<span class="number">6</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __drm_crtc_init_with_planes(struct drm_device *dev, struct drm_crtc *crtc,</span><br><span class="line">                                       struct drm_plane *primary,</span><br><span class="line">                                       struct drm_plane *cursor,</span><br><span class="line">                                       <span class="keyword">const</span> struct drm_crtc_funcs *funcs,  <span class="comment">// 重点关注</span></span><br><span class="line">                                       <span class="keyword">const</span> <span class="keyword">char</span> *name, va_list ap)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// 获取drm模式配置</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_mode_config</span> *<span class="title">config</span> = &amp;<span class="title">dev</span>-&gt;<span class="title">mode_config</span>;</span></span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// plane类型校验</span></span><br><span class="line">        WARN_ON(primary &amp;&amp; primary-&gt;type != DRM_PLANE_TYPE_PRIMARY);</span><br><span class="line">        WARN_ON(cursor &amp;&amp; cursor-&gt;type != DRM_PLANE_TYPE_CURSOR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* crtc index is used with 32bit bitmasks */</span></span><br><span class="line">        <span class="keyword">if</span> (WARN_ON(config-&gt;num_crtc &gt;= <span class="number">32</span>))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        WARN_ON(drm_drv_uses_atomic_modeset(dev) &amp;&amp;</span><br><span class="line">                (!funcs-&gt;atomic_destroy_state ||</span><br><span class="line">                 !funcs-&gt;atomic_duplicate_state));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存drm设备</span></span><br><span class="line">        crtc-&gt;dev = dev;</span><br><span class="line">        <span class="comment">// 设置crtc操作函数</span></span><br><span class="line">        crtc-&gt;funcs = funcs;</span><br><span class="line"></span><br><span class="line">        INIT_LIST_HEAD(&amp;crtc-&gt;commit_list);</span><br><span class="line">        spin_lock_init(&amp;crtc-&gt;commit_lock);</span><br><span class="line"></span><br><span class="line">        drm_modeset_lock_init(&amp;crtc-&gt;mutex);</span><br><span class="line">    </span><br><span class="line">       <span class="comment">// 基于基数树为crtc分配一个唯一id，根绝该id可以定位到该crtc</span></span><br><span class="line">        ret = drm_mode_object_add(dev, &amp;crtc-&gt;base, DRM_MODE_OBJECT_CRTC);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        <span class="comment">//  设置名称</span></span><br><span class="line">        <span class="keyword">if</span> (name) &#123;</span><br><span class="line">                crtc-&gt;name = kvasprintf(GFP_KERNEL, name, ap);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                crtc-&gt;name = kasprintf(GFP_KERNEL, <span class="string">&quot;crtc-%d&quot;</span>,</span><br><span class="line">                                       drm_num_crtcs(dev));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!crtc-&gt;name) &#123;</span><br><span class="line">                drm_mode_object_unregister(dev, &amp;crtc-&gt;base);</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        crtc-&gt;fence_context = dma_fence_context_alloc(<span class="number">1</span>);</span><br><span class="line">        spin_lock_init(&amp;crtc-&gt;fence_lock);</span><br><span class="line">        <span class="built_in">snprintf</span>(crtc-&gt;timeline_name, <span class="keyword">sizeof</span>(crtc-&gt;timeline_name),</span><br><span class="line">                 <span class="string">&quot;CRTC:%d-%s&quot;</span>, crtc-&gt;base.id, crtc-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化properties</span></span><br><span class="line">        crtc-&gt;base.properties = &amp;crtc-&gt;properties;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将当前crtc节点添加到链表config-&gt;crtc_list中</span></span><br><span class="line">        list_add_tail(&amp;crtc-&gt;head, &amp;config-&gt;crtc_list);</span><br><span class="line">        <span class="comment">// 初始化crtc索引</span></span><br><span class="line">        crtc-&gt;index = config-&gt;num_crtc++;</span><br><span class="line"></span><br><span class="line">        crtc-&gt;primary = primary;</span><br><span class="line">        crtc-&gt;cursor = cursor;</span><br><span class="line">        <span class="keyword">if</span> (primary &amp;&amp; !primary-&gt;possible_crtcs)</span><br><span class="line">                primary-&gt;possible_crtcs = drm_crtc_mask(crtc);</span><br><span class="line">        <span class="keyword">if</span> (cursor &amp;&amp; !cursor-&gt;possible_crtcs)</span><br><span class="line">                cursor-&gt;possible_crtcs = drm_crtc_mask(crtc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调试相关的</span></span><br><span class="line">        ret = drm_crtc_crc_init(crtc);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                drm_mode_object_unregister(dev, &amp;crtc-&gt;base);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 附加一些属性</span></span><br><span class="line">        <span class="keyword">if</span> (drm_core_check_feature(dev, DRIVER_ATOMIC)) &#123;</span><br><span class="line">                drm_object_attach_property(&amp;crtc-&gt;base, config-&gt;prop_active, <span class="number">0</span>);</span><br><span class="line">                drm_object_attach_property(&amp;crtc-&gt;base, config-&gt;prop_mode_id, <span class="number">0</span>);</span><br><span class="line">                drm_object_attach_property(&amp;crtc-&gt;base,</span><br><span class="line">                                           config-&gt;prop_out_fence_ptr, <span class="number">0</span>);</span><br><span class="line">                drm_object_attach_property(&amp;crtc-&gt;base,</span><br><span class="line">                                           config-&gt;prop_vrr_enabled, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-drm-crtc-crc-init"><a href="#3-2-drm-crtc-crc-init" class="headerlink" title="3.2 drm_crtc_crc_init"></a>3.2 <code>drm_crtc_crc_init</code></h4><p><code>drm_crtc_crc_init</code>函数用于初始化的<code>crtc</code>对象，定义在<code>drivers/gpu/drm/drm_crtc.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">drm_crtc_crc_init</span><span class="params">(struct drm_crtc *crtc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">        spin_lock_init(&amp;crtc-&gt;crc.lock);</span><br><span class="line">        init_waitqueue_head(&amp;crtc-&gt;crc.wq);</span><br><span class="line">        crtc-&gt;crc.source = kstrdup(<span class="string">&quot;auto&quot;</span>, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!crtc-&gt;crc.source)</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-drm-crtc-helper-add"><a href="#3-3-drm-crtc-helper-add" class="headerlink" title="3.3 drm_crtc_helper_add"></a>3.3 <code>drm_crtc_helper_add</code></h4><p><code>drm_crtc_helper_add</code>函数用于设置<code>crtc</code>的辅助函数<code>helper_private</code>，定义在<code>include/drm/drm_modeset_helper_vtables.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_crtc_helper_add - sets the helper vtable for a crtc</span></span><br><span class="line"><span class="comment"> * @crtc: DRM CRTC</span></span><br><span class="line"><span class="comment"> * @funcs: helper vtable to set for @crtc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">drm_crtc_helper_add</span><span class="params">(struct drm_crtc *crtc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> struct drm_crtc_helper_funcs *funcs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        crtc-&gt;helper_private = funcs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="四、Rockchip-vop驱动"><a href="#四、Rockchip-vop驱动" class="headerlink" title="四、Rockchip vop驱动"></a>四、<code>Rockchip vop</code>驱动</h3><p>这里我们介绍一下<code>Rochchip DRM</code>驱动中与<code>vop</code>相关的实现，具体实现文件：</p>
<ul>
<li><code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</li>
<li><code>drivers/gpu/drm/rockchip/rockchip_vop_reg.c</code>；</li>
<li><code>drivers/gpu/drm/rockchip/rockchip_drm_vop.h</code>;</li>
<li><code>drivers/gpu/drm/rockchip/rockchip_vop_reg.h</code>；</li>
</ul>
<h4 id="4-1-DRM驱动入口函数回顾"><a href="#4-1-DRM驱动入口函数回顾" class="headerlink" title="4.1 DRM驱动入口函数回顾"></a>4.1 <code>DRM</code>驱动入口函数回顾</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">rockchip_drm_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (drm_firmware_drivers_only())</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 根据配置来决定是否添加xxx_xxx_driver到数组rockchip_sub_drivers</span></span><br><span class="line">        num_rockchip_sub_drivers = <span class="number">0</span>;</span><br><span class="line">        ADD_ROCKCHIP_SUB_DRIVER(vop_platform_driver, CONFIG_ROCKCHIP_VOP);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 注册多个platform driver    </span></span><br><span class="line">        ret = platform_register_drivers(rockchip_sub_drivers,</span><br><span class="line">                                        num_rockchip_sub_drivers);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 注册rockchip_drm_platform_driver</span></span><br><span class="line">        ret = platform_driver_register(&amp;rockchip_drm_platform_driver);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">goto</span> err_unreg_drivers;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD_ROCKCHIP_SUB_DRIVER(vop_platform_driver, CONFIG_ROCKCHIP_VOP);</span><br></pre></td></tr></table></figure>

<p>会将<code>vop_platform_driver</code>保存到<code>rockchip_sub_drivers</code>数组中。</p>
<p>并调用<code>platform_register_drivers</code>遍历<code>rockchip_sub_drivers</code>数组，多次调用<code>platform_driver_register</code>注册<code>platform driver</code>。</p>
<h4 id="4-2-vop-platform-driver"><a href="#4-2-vop-platform-driver" class="headerlink" title="4.2 vop_platform_driver"></a>4.2 <code>vop_platform_driver</code></h4><p><code>vop_platform_driver</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_vop_reg.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">vop_platform_driver</span> = &#123;</span></span><br><span class="line">        .probe = vop_probe,</span><br><span class="line">        .remove = vop_remove,</span><br><span class="line">        .driver = &#123;</span><br><span class="line">                .name = <span class="string">&quot;rockchip-vop&quot;</span>,</span><br><span class="line">                .of_match_table = vop_driver_dt_match,</span><br><span class="line">        &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="4-2-1-of-match-table"><a href="#4-2-1-of-match-table" class="headerlink" title="4.2.1 of_match_table"></a>4.2.1 <code>of_match_table</code></h5><p>其中<code>of_match_table</code>用于设备树匹配，匹配设备树中<code>compatible = &quot;rockchip,rk3399-vop-big&quot;</code>或者<code>compatible = &quot;rockchip,rk3399-vop-lit&quot;</code>的设备节点；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">vop_driver_dt_match</span>[] = &#123;</span></span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3036-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3036_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3126-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3126_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,px30-vop-big&quot;</span>,</span><br><span class="line">          .data = &amp;px30_vop_big &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,px30-vop-lit&quot;</span>,</span><br><span class="line">          .data = &amp;px30_vop_lit &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3066-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3066_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3188-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3188_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3288-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3288_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3368-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3368_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3366-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3366_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3399-vop-big&quot;</span>,</span><br><span class="line">          .data = &amp;rk3399_vop_big &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3399-vop-lit&quot;</span>,</span><br><span class="line">          .data = &amp;rk3399_vop_lit &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3228-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3228_vop &#125;,</span><br><span class="line">        &#123; .compatible = <span class="string">&quot;rockchip,rk3328-vop&quot;</span>,</span><br><span class="line">          .data = &amp;rk3328_vop &#125;,</span><br><span class="line">        &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="4-2-2-vop-probe"><a href="#4-2-2-vop-probe" class="headerlink" title="4.2.2 vop_probe"></a>4.2.2 <code>vop_probe</code></h5><p>在<code>plaftrom</code>总线设备驱动模型中，我们知道当内核中有<code>platform</code>设备和<code>platform</code>驱动匹配，会调用到<code>platform_driver</code>里的成员<code>.probe</code>，在这里就是<code>vop_probe</code>函数；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vop_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = &amp;<span class="title">pdev</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 未使用设备树 退出</span></span><br><span class="line">        <span class="keyword">if</span> (!dev-&gt;of_node) &#123;</span><br><span class="line">                DRM_DEV_ERROR(dev, <span class="string">&quot;can&#x27;t find vop devices\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> component_add(dev, &amp;vop_component_ops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里代码很简单，就是为设备<code>pdev-&gt;dev</code>向系统注册一个<code>component</code>，其中组件可执行的初始化操作被设置为了<code>vop_component_ops</code>，其定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">component_ops</span> <span class="title">vop_component_ops</span> = &#123;</span></span><br><span class="line">        .bind = vop_bind,</span><br><span class="line">        .unbind = vop_unbind,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们需要重点关注<code>bind</code>函数的实现，这个函数内容较多我们单独小节介绍。</p>
<h4 id="4-3-vopb设备节点"><a href="#4-3-vopb设备节点" class="headerlink" title="4.3 vopb设备节点"></a>4.3 <code>vopb</code>设备节点</h4><p>以<code>vopb</code>设备节点为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">vopb: vop@ff900000 &#123;</span><br><span class="line">        compatible = <span class="string">&quot;rockchip,rk3399-vop-big&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x0</span> <span class="number">0xff900000</span> <span class="number">0x0</span> <span class="number">0x2000</span>&gt;, &lt;<span class="number">0x0</span> <span class="number">0xff902000</span> <span class="number">0x0</span> <span class="number">0x1000</span>&gt;;</span><br><span class="line">        interrupts = &lt;GIC_SPI <span class="number">118</span> IRQ_TYPE_LEVEL_HIGH <span class="number">0</span>&gt;;</span><br><span class="line">        assigned-clocks = &lt;&amp;cru ACLK_VOP0&gt;, &lt;&amp;cru HCLK_VOP0&gt;;</span><br><span class="line">        assigned-clock-rates = &lt;<span class="number">400000000</span>&gt;, &lt;<span class="number">100000000</span>&gt;;</span><br><span class="line">        clocks = &lt;&amp;cru ACLK_VOP0&gt;, &lt;&amp;cru DCLK_VOP0&gt;, &lt;&amp;cru HCLK_VOP0&gt;;</span><br><span class="line">        clock-names = <span class="string">&quot;aclk_vop&quot;</span>, <span class="string">&quot;dclk_vop&quot;</span>, <span class="string">&quot;hclk_vop&quot;</span>;</span><br><span class="line">        iommus = &lt;&amp;vopb_mmu&gt;;</span><br><span class="line">        power-domains = &lt;&amp;power RK3399_PD_VOPB&gt;;</span><br><span class="line">        resets = &lt;&amp;cru SRST_A_VOP0&gt;, &lt;&amp;cru SRST_H_VOP0&gt;, &lt;&amp;cru SRST_D_VOP0&gt;;</span><br><span class="line">        reset-names = <span class="string">&quot;axi&quot;</span>, <span class="string">&quot;ahb&quot;</span>, <span class="string">&quot;dclk&quot;</span>;</span><br><span class="line">        status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"></span><br><span class="line">        vopb_out: port &#123;</span><br><span class="line">                <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">                <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">                vopb_out_edp: endpoint@<span class="number">0</span> &#123;</span><br><span class="line">                        reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                        remote-endpoint = &lt;&amp;edp_in_vopb&gt;;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                vopb_out_mipi: endpoint@<span class="number">1</span> &#123;</span><br><span class="line">                        reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">                        remote-endpoint = &lt;&amp;mipi_in_vopb&gt;;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                vopb_out_hdmi: endpoint@<span class="number">2</span> &#123;</span><br><span class="line">                        reg = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">                        remote-endpoint = &lt;&amp;hdmi_in_vopb&gt;;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                vopb_out_mipi1: endpoint@<span class="number">3</span> &#123;</span><br><span class="line">                        reg = &lt;<span class="number">3</span>&gt;;</span><br><span class="line">                        remote-endpoint = &lt;&amp;mipi1_in_vopb&gt;;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                vopb_out_dp: endpoint@<span class="number">4</span> &#123;</span><br><span class="line">                        reg = &lt;<span class="number">4</span>&gt;;</span><br><span class="line">                        remote-endpoint = &lt;&amp;dp_in_vopb&gt;;</span><br><span class="line">                &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="五-vop-bind"><a href="#五-vop-bind" class="headerlink" title="五 vop_bind"></a>五 <code>vop_bind</code></h3><p><code>vop_bind</code>函数定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>，涉及到对<code>vop</code>设备节点的解析，咱们以<code>vopb</code>设备节点为例进行分析；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vop_bind</span><span class="params">(struct device *dev, struct device *master, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="comment">// 1. 获取platform_device</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">pdev</span> = <span class="title">to_platform_device</span>(<span class="title">dev</span>);</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> *<span class="title">vop_data</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">drm_dev</span> = <span class="title">data</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vop</span> *<span class="title">vop</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line">        <span class="keyword">int</span> ret, irq;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 得到rk3399_vop_big</span></span><br><span class="line">        vop_data = of_device_get_match_data(dev);</span><br><span class="line">        <span class="keyword">if</span> (!vop_data)</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Allocate vop struct and its vop_win array，初始化vop win */</span></span><br><span class="line">        vop = devm_kzalloc(dev, struct_size(vop, win, vop_data-&gt;win_size),</span><br><span class="line">                           GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!vop)</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">        vop-&gt;dev = dev;</span><br><span class="line">        vop-&gt;data = vop_data;</span><br><span class="line">        vop-&gt;drm_dev = drm_dev;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置驱动数据为vop</span></span><br><span class="line">        dev_set_drvdata(dev, vop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 初始化vop win</span></span><br><span class="line">        vop_win_init(vop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 获取第一个内存资源，即&lt;0x0 0xff900000 0x0 0x2000&gt;; VOP_BIG相关寄存器基地址</span></span><br><span class="line">        res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将VOP_BIG相关寄存器起始物理地址映射到虚拟地址，并返回虚拟地址</span></span><br><span class="line">        vop-&gt;regs = devm_ioremap_resource(dev, res);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(vop-&gt;regs))</span><br><span class="line">                <span class="keyword">return</span> PTR_ERR(vop-&gt;regs);</span><br><span class="line">        vop-&gt;len = resource_size(res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 获取第二个内存资源，即&lt;0x0 0xff902000 0x0 0x1000&gt;; LUT相关寄存器基地址</span></span><br><span class="line">        res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vop_data-&gt;lut_size != <span class="number">1024</span> &amp;&amp; vop_data-&gt;lut_size != <span class="number">256</span>) &#123;</span><br><span class="line">                        DRM_DEV_ERROR(dev, <span class="string">&quot;unsupported gamma LUT size %d\n&quot;</span>, vop_data-&gt;lut_size);</span><br><span class="line">                        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// LUT相关寄存器起始物理地址映射到虚拟地址，并返回虚拟地址</span></span><br><span class="line">                vop-&gt;lut_regs = devm_ioremap_resource(dev, res);</span><br><span class="line">                <span class="keyword">if</span> (IS_ERR(vop-&gt;lut_regs))</span><br><span class="line">                        <span class="keyword">return</span> PTR_ERR(vop-&gt;lut_regs);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        vop-&gt;regsbak = devm_kzalloc(dev, vop-&gt;len, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!vop-&gt;regsbak)</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 获取第1个IRQ编号 interrupts = &lt;GIC_SPI 118 IRQ_TYPE_LEVEL_HIGH 0&gt;;</span></span><br><span class="line">        irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (irq &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DRM_DEV_ERROR(dev, <span class="string">&quot;cannot find irq for vop\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> irq;</span><br><span class="line">        &#125;</span><br><span class="line">        vop-&gt;irq = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)irq;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化自旋锁和互斥锁</span></span><br><span class="line">        spin_lock_init(&amp;vop-&gt;reg_lock);</span><br><span class="line">        spin_lock_init(&amp;vop-&gt;irq_lock);</span><br><span class="line">        mutex_init(&amp;vop-&gt;vop_lock);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 创建crtc对象，并和plane关联在一起</span></span><br><span class="line">        ret = vop_create_crtc(vop);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 电源管理相关</span></span><br><span class="line">        pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. vop初始化</span></span><br><span class="line">        ret = vop_initial(vop);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DRM_DEV_ERROR(&amp;pdev-&gt;dev,</span><br><span class="line">                              <span class="string">&quot;cannot initial vop dev - err %d\n&quot;</span>, ret);</span><br><span class="line">                <span class="keyword">goto</span> err_disable_pm_runtime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9. 申请中断，中断处理函数设置为vop_isr</span></span><br><span class="line">        ret = devm_request_irq(dev, vop-&gt;irq, vop_isr,</span><br><span class="line">                               IRQF_SHARED, dev_name(dev), vop);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">goto</span> err_disable_pm_runtime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 未设置</span></span><br><span class="line">        <span class="keyword">if</span> (vop-&gt;data-&gt;feature &amp; VOP_FEATURE_INTERNAL_RGB) &#123;</span><br><span class="line">                vop-&gt;rgb = rockchip_rgb_init(dev, &amp;vop-&gt;crtc, vop-&gt;drm_dev);</span><br><span class="line">                <span class="keyword">if</span> (IS_ERR(vop-&gt;rgb)) &#123;</span><br><span class="line">                        ret = PTR_ERR(vop-&gt;rgb);</span><br><span class="line">                        <span class="keyword">goto</span> err_disable_pm_runtime;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 10. dma初始化</span></span><br><span class="line">        rockchip_drm_dma_init_device(drm_dev, dev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_disable_pm_runtime:</span><br><span class="line">        pm_runtime_disable(&amp;pdev-&gt;dev);</span><br><span class="line">        vop_destroy_crtc(vop);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们以设备节点<code>vopb</code>为例，对这段代码进行分析，主要流程如下：</p>
<p>(1) 调用<code>to_platform_device</code>获取<code>platform device</code>，设备节点为<code>vopb</code>；</p>
<p>(2) 调用<code>of_device_get_match_data</code>获取与特定设备匹配的数据，这里获取到的数据为<code>rk3399_vop_big</code>;</p>
<p>(3) 调用<code>vop_win_init</code>初始化<code>vop win</code>；</p>
<p>(4) 首先调用<code>platform_get_resource(pdev, IORESOURCE_MEM, 0)</code>获取第一个内存资源，即：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="number">0x0</span> <span class="number">0xff900000</span> <span class="number">0x0</span> <span class="number">0x2000</span>&gt;</span><br></pre></td></tr></table></figure>

<p><code>0xff900000</code>为<code>VOP_BIG</code>相关寄存器基地址；</p>
<p>接着调用<code>devm_ioremap_resource(dev, res)</code>将<code>VOP_BIG</code>相关寄存器起始物理地址映射到虚拟地址，并返回虚拟地址；</p>
<p>(5) 调用<code>platform_get_resource(pdev, IORESOURCE_MEM, 1)</code>获取第二个内存资源，即：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="number">0x0</span> <span class="number">0xff902000</span> <span class="number">0x0</span> <span class="number">0x1000</span>&gt;</span><br></pre></td></tr></table></figure>

<p><code>0xff902000</code> 为<code>LUT</code>相关寄存器基地址；</p>
<p>接着调用<code>devm_ioremap_resource(dev, res)</code>将<code>LUT</code>相关寄存器起始物理地址映射到虚拟地址，并返回虚拟地址；</p>
<p>(6) 调用<code>platform_get_irq(pdev, 0)</code> 获取第1个<code>IRQ</code>编号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">interrupts = &lt;GIC_SPI <span class="number">118</span> IRQ_TYPE_LEVEL_HIGH <span class="number">0</span>&gt;</span><br></pre></td></tr></table></figure>

<p>(7) 调用<code>vop_create_crtc(vop)</code>初始化<code>crtc</code>对象，并和<code>plane</code>关联在一起；</p>
<p>(8) 调用<code>vop_initial(vop)</code>进行<code>vop</code>初始化；</p>
<p>(9) 调用<code>devm_request_irq(dev, vop-&gt;irq, vop_isr, IRQF_SHARED, dev_name(dev), vop)</code>申请中断，中断处理函数设置为<code>vop_isr</code>；</p>
<p>(10) 调用<code>rockchip_drm_dma_init_device(drm_dev, dev)</code>进行<code>dma</code>相关的初始化工作；</p>
<h4 id="5-1-struct-vop"><a href="#5-1-struct-vop" class="headerlink" title="5.1 struct vop"></a>5.1 <code>struct vop</code></h4><p><code>struct vop</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>，用于表示显示处理器；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 描述vop win</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_plane</span> <span class="title">base</span>;</span>              <span class="comment">// 对应的struct drm_plane数据结构</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span> *<span class="title">data</span>;</span>    <span class="comment">// vop win data</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_yuv2yuv_data</span> *<span class="title">yuv2yuv_data</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vop</span> *<span class="title">vop</span>;</span>                    <span class="comment">// 指向vop</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 描述显示处理器vop</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vop</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc</span> <span class="title">crtc</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">drm_dev</span>;</span></span><br><span class="line">        <span class="keyword">bool</span> is_enabled;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">dsp_hold_completion</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> win_enabled;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* protected by dev-&gt;event_lock */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_pending_vblank_event</span> *<span class="title">event</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_flip_work</span> <span class="title">fb_unref_work</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pending;</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">line_flag_completion</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> *<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> *regsbak;</span><br><span class="line">        <span class="keyword">void</span> __iomem *regs;</span><br><span class="line">        <span class="keyword">void</span> __iomem *lut_regs;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* physical map length of vop register */</span></span><br><span class="line">        <span class="keyword">uint32_t</span> len;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* one time only one process allowed to config the register */</span></span><br><span class="line">        <span class="keyword">spinlock_t</span> reg_lock;</span><br><span class="line">        <span class="comment">/* lock vop irq reg */</span></span><br><span class="line">        <span class="keyword">spinlock_t</span> irq_lock;</span><br><span class="line">        <span class="comment">/* protects crtc enable/disable */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">vop_lock</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> irq;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* vop AHP clk */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">hclk</span>;</span></span><br><span class="line">        <span class="comment">/* vop dclk */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">dclk</span>;</span></span><br><span class="line">        <span class="comment">/* vop share memory frequency */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">clk</span> *<span class="title">aclk</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* vop dclk reset */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">reset_control</span> *<span class="title">dclk_rst</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* optional internal rgb encoder */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_rgb</span> *<span class="title">rgb</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span> <span class="title">win</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>crtc</code>：指向一个<code>struct drm_crtc</code>;</li>
<li><code>dev</code>：这是一个指向设备结构体的指针，通常用于表示与<code>vop</code>关联的设备；</li>
<li><code>data</code> ：存储与<code>vop</code>相关的数据；</li>
<li><code>drm_dev</code> ：指向一个<code>struct drm_device</code>，表示当前<code>drm</code>设备；</li>
<li><code>regs</code> ：<code>vop</code>相关寄存器起始虚拟地址；</li>
<li><code>len</code> ：<code>vop</code>相关寄存器所占内存长度，单位字节；</li>
<li><code>regsbak</code> ：指向一块内存，用于备份<code>vop</code>相关寄存器；</li>
<li><code>irq</code> ：存储<code>vop</code>中断<code>IRQ</code>编号；</li>
<li><code>hclk</code>、<code>dclk</code>、<code>aclk</code>：<code>vop</code>相关的各种时钟；</li>
<li><code>rgb</code>：这是一个用于管理<code>RGB</code>编码器的结构体指针；</li>
<li><code>win</code>：这是一个表示<code>vop win</code>的结构体数组，比如<code>RK399 vop</code> 支持4个图层，因此该该数组有4个元素；</li>
</ul>
<h4 id="5-2-struct-vop-data"><a href="#5-2-struct-vop-data" class="headerlink" title="5.2 struct vop_data"></a>5.2 <code>struct vop_data</code></h4><p><code>struct vop_data</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.h</code>，用于描述与<code>vop</code>相关的数据，主要是一些寄存器信息；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> version;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_intr</span> *<span class="title">intr</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_common</span> *<span class="title">common</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_misc</span> *<span class="title">misc</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_modeset</span> *<span class="title">modeset</span>;</span>  <span class="comment">// 模式配置相关寄存器信息</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_output</span> *<span class="title">output</span>;</span>    <span class="comment">// 输出配置相关寄存器信息</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_afbc</span> *<span class="title">afbc</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_yuv2yuv_data</span> *<span class="title">win_yuv2yuv</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span> *<span class="title">win</span>;</span>     <span class="comment">// vop win配置相关寄存器信息</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> win_size;   <span class="comment">// vop win个数</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> lut_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VOP_FEATURE_OUTPUT_RGB10        BIT(0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VOP_FEATURE_INTERNAL_RGB        BIT(1)</span></span><br><span class="line">        u64 feature;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以<code>rk3399_vop_big</code>为例，定义在<code>drivers/gpu/drm/rockchip/rockchip_vop_reg.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> <span class="title">rk3399_vop_big</span> = &#123;</span></span><br><span class="line">        .version = VOP_VERSION(<span class="number">3</span>, <span class="number">5</span>),</span><br><span class="line">        .feature = VOP_FEATURE_OUTPUT_RGB10,</span><br><span class="line">        .intr = &amp;rk3366_vop_intr,</span><br><span class="line">        .common = &amp;rk3399_common,</span><br><span class="line">        .modeset = &amp;rk3288_modeset,   <span class="comment">// 模式配置相关寄存器信息</span></span><br><span class="line">        .output = &amp;rk3399_output,     <span class="comment">// 输出配置相关寄存器信息</span></span><br><span class="line">        .afbc = &amp;rk3399_vop_afbc,</span><br><span class="line">        .misc = &amp;rk3368_misc,</span><br><span class="line">        .win = rk3399_vop_win_data,                   <span class="comment">// vop win配置相关寄存器信息</span></span><br><span class="line">        .win_size = ARRAY_SIZE(rk3399_vop_win_data),  <span class="comment">// vop win个数</span></span><br><span class="line">        .win_yuv2yuv = rk3399_vop_big_win_yuv2yuv_data,</span><br><span class="line">        .lut_size = <span class="number">1024</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>rk3366_vop_intr</code>、<code>rk3288_modeset</code>，<code>rk3399_output</code>、<code>rk3399_common</code>等配置了大量的寄存器信息。</p>
<h5 id="5-2-1-rk3288-modeset"><a href="#5-2-1-rk3288-modeset" class="headerlink" title="5.2.1 rk3288_modeset"></a>5.2.1 <code>rk3288_modeset</code></h5><p><code>rk3288_modeset</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_modeset</span> <span class="title">rk3288_modeset</span> = &#123;</span></span><br><span class="line">        .htotal_pw = VOP_REG(RK3288_DSP_HTOTAL_HS_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>), <span class="comment">// horizontal total size配置</span></span><br><span class="line">        .hact_st_end = VOP_REG(RK3288_DSP_HACT_ST_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">        .vtotal_pw = VOP_REG(RK3288_DSP_VTOTAL_VS_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>), <span class="comment">// vertical total size配置</span></span><br><span class="line">        .vact_st_end = VOP_REG(RK3288_DSP_VACT_ST_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">        .hpost_st_end = VOP_REG(RK3288_POST_DSP_HACT_INFO, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">        .vpost_st_end = VOP_REG(RK3288_POST_DSP_VACT_INFO, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>VOP_REG</code>用于定义寄存器信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _VOP_REG(off, _mask, _shift, _write_mask, _relaxed) \</span></span><br><span class="line">                &#123; \</span><br><span class="line">                 .offset = off, \</span><br><span class="line">                 .mask = _mask, \</span><br><span class="line">                 .shift = _shift, \</span><br><span class="line">                 .write_mask = _write_mask, \</span><br><span class="line">                 .relaxed = _relaxed, \</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">#define VOP_REG(off, _mask, _shift) \</span><br><span class="line">                _VOP_REG(off, _mask, _shift, <span class="literal">false</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h5 id="5-2-2-rk3399-common"><a href="#5-2-2-rk3399-common" class="headerlink" title="5.2.2 rk3399_common"></a>5.2.2 <code>rk3399_common</code></h5><p><code>rk3399_common</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_common</span> <span class="title">rk3399_common</span> = &#123;</span></span><br><span class="line">        .standby = VOP_REG_SYNC(RK3399_SYS_CTRL, <span class="number">0x1</span>, <span class="number">22</span>),</span><br><span class="line">        .gate_en = VOP_REG(RK3399_SYS_CTRL, <span class="number">0x1</span>, <span class="number">23</span>),</span><br><span class="line">        .mmu_en = VOP_REG(RK3399_SYS_CTRL, <span class="number">0x1</span>, <span class="number">20</span>),</span><br><span class="line">        .dither_down_sel = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">4</span>),</span><br><span class="line">        .dither_down_mode = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">3</span>),</span><br><span class="line">        .dither_down_en = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">2</span>),</span><br><span class="line">        .pre_dither_down = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">1</span>),</span><br><span class="line">        .dither_up = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">6</span>),</span><br><span class="line">        .dsp_lut_en = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">        .update_gamma_lut = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">7</span>),</span><br><span class="line">        .lut_buffer_index = VOP_REG(RK3399_DBG_POST_REG1, <span class="number">0x1</span>, <span class="number">1</span>),</span><br><span class="line">        .data_blank = VOP_REG(RK3399_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">19</span>),</span><br><span class="line">        .dsp_blank = VOP_REG(RK3399_DSP_CTRL0, <span class="number">0x3</span>, <span class="number">18</span>),</span><br><span class="line">        .out_mode = VOP_REG(RK3399_DSP_CTRL0, <span class="number">0xf</span>, <span class="number">0</span>),</span><br><span class="line">        .cfg_done = VOP_REG_SYNC(RK3399_REG_CFG_DONE, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-3-rk3399-vop-wn-data"><a href="#5-2-3-rk3399-vop-wn-data" class="headerlink" title="5.2.3 rk3399_vop_wn_data"></a>5.2.3 <code>rk3399_vop_wn_data</code></h5><p><code>rk3399_vop_wn_data</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_phy</span> <span class="title">rk3399_win01_data</span> = &#123;</span></span><br><span class="line">        .scl = &amp;rk3288_win_full_scl,</span><br><span class="line">        .data_formats = formats_win_full,</span><br><span class="line">        .nformats = ARRAY_SIZE(formats_win_full),</span><br><span class="line">        .format_modifiers = format_modifiers_win_full_afbc,</span><br><span class="line">        .enable = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">        .format = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x7</span>, <span class="number">1</span>),</span><br><span class="line">        .rb_swap = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">12</span>),</span><br><span class="line">        .uv_swap = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">15</span>),</span><br><span class="line">        .x_mir_en = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">21</span>),   <span class="comment">// 水平方向上反转（翻转）使能</span></span><br><span class="line">        .y_mir_en = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">22</span>),   <span class="comment">// 垂直方向上反转（翻转）使能</span></span><br><span class="line">        .act_info = VOP_REG(RK3288_WIN0_ACT_INFO, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">        .dsp_info = VOP_REG(RK3288_WIN0_DSP_INFO, <span class="number">0x0fff0fff</span>, <span class="number">0</span>),</span><br><span class="line">        .dsp_st = VOP_REG(RK3288_WIN0_DSP_ST, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">        .yrgb_mst = VOP_REG(RK3288_WIN0_YRGB_MST, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">        .uv_mst = VOP_REG(RK3288_WIN0_CBR_MST, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">        .yrgb_vir = VOP_REG(RK3288_WIN0_VIR, <span class="number">0x3fff</span>, <span class="number">0</span>),</span><br><span class="line">        .uv_vir = VOP_REG(RK3288_WIN0_VIR, <span class="number">0x3fff</span>, <span class="number">16</span>),</span><br><span class="line">        .src_alpha_ctl = VOP_REG(RK3288_WIN0_SRC_ALPHA_CTRL, <span class="number">0xff</span>, <span class="number">0</span>),</span><br><span class="line">        .dst_alpha_ctl = VOP_REG(RK3288_WIN0_DST_ALPHA_CTRL, <span class="number">0xff</span>, <span class="number">0</span>),</span><br><span class="line">        .channel = VOP_REG(RK3288_WIN0_CTRL2, <span class="number">0xff</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * rk3399 vop big windows register layout is same as rk3288, but we</span></span><br><span class="line"><span class="comment"> * have a separate rk3399 win data array here so that we can advertise</span></span><br><span class="line"><span class="comment"> * AFBC on the primary plane.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span> <span class="title">rk3399_vop_win_data</span>[] = &#123;</span></span><br><span class="line">        &#123; .base = <span class="number">0x00</span>, .phy = &amp;rk3399_win01_data,</span><br><span class="line">          .type = DRM_PLANE_TYPE_PRIMARY &#125;,       <span class="comment">// primary plane</span></span><br><span class="line">        &#123; .base = <span class="number">0x40</span>, .phy = &amp;rk3368_win01_data, </span><br><span class="line">          .type = DRM_PLANE_TYPE_OVERLAY &#125;,       <span class="comment">// overlay plane</span></span><br><span class="line">        &#123; .base = <span class="number">0x00</span>, .phy = &amp;rk3368_win23_data,</span><br><span class="line">          .type = DRM_PLANE_TYPE_OVERLAY &#125;,       <span class="comment">// overlay plane</span></span><br><span class="line">        &#123; .base = <span class="number">0x50</span>, .phy = &amp;rk3368_win23_data,</span><br><span class="line">          .type = DRM_PLANE_TYPE_CURSOR &#125;,        <span class="comment">// cursor plane</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>RK3399</code>其<code>vop</code>包含4个图层，因此这里存放就是<code>RK3399</code>的4个图层配置相关寄存器的信息。</p>
<h5 id="5-2-4-rk3399-vop-big-win-yuv2yuv-data"><a href="#5-2-4-rk3399-vop-big-win-yuv2yuv-data" class="headerlink" title="5.2.4 rk3399_vop_big_win_yuv2yuv_data"></a>5.2.4 <code>rk3399_vop_big_win_yuv2yuv_data</code></h5><p><code>rk3399_vop_big_win_yuv2yuv_data</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_yuv2yuv_data</span> <span class="title">rk3399_vop_big_win_yuv2yuv_data</span>[] = &#123;</span></span><br><span class="line">        &#123; .base = <span class="number">0x00</span>, .phy = &amp;rk3399_yuv2yuv_win01_data,</span><br><span class="line">          .y2r_en = VOP_REG(RK3399_YUV2YUV_WIN, <span class="number">0x1</span>, <span class="number">1</span>) &#125;,</span><br><span class="line">        &#123; .base = <span class="number">0x60</span>, .phy = &amp;rk3399_yuv2yuv_win01_data,</span><br><span class="line">          .y2r_en = VOP_REG(RK3399_YUV2YUV_WIN, <span class="number">0x1</span>, <span class="number">9</span>) &#125;,</span><br><span class="line">        &#123; .base = <span class="number">0xC0</span>, .phy = &amp;rk3399_yuv2yuv_win23_data &#125;,</span><br><span class="line">        &#123; .base = <span class="number">0x120</span>, .phy = &amp;rk3399_yuv2yuv_win23_data &#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-rk3399-output"><a href="#5-3-rk3399-output" class="headerlink" title="5.3 rk3399_output"></a>5.3 <code>rk3399_output</code></h4><p><code>rk3399_output</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_output</span> <span class="title">rk3399_output</span> = &#123;</span></span><br><span class="line">        .dp_dclk_pol = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">19</span>),</span><br><span class="line">        .rgb_dclk_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">19</span>),</span><br><span class="line">        .hdmi_dclk_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">23</span>),</span><br><span class="line">        .edp_dclk_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">27</span>),</span><br><span class="line">        .mipi_dclk_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">31</span>),</span><br><span class="line">        <span class="comment">// 接口引脚极性相关寄存器位</span></span><br><span class="line">        .dp_pin_pol = VOP_REG(RK3399_DSP_CTRL1, <span class="number">0x7</span>, <span class="number">16</span>),</span><br><span class="line">        .rgb_pin_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x7</span>, <span class="number">16</span>),</span><br><span class="line">        .hdmi_pin_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x7</span>, <span class="number">20</span>),</span><br><span class="line">        .edp_pin_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x7</span>, <span class="number">24</span>),</span><br><span class="line">        .mipi_pin_pol = VOP_REG(RK3368_DSP_CTRL1, <span class="number">0x7</span>, <span class="number">28</span>),</span><br><span class="line">        <span class="comment">// 接口使能相关寄存器位</span></span><br><span class="line">        .dp_en = VOP_REG(RK3399_SYS_CTRL, <span class="number">0x1</span>, <span class="number">11</span>),       <span class="comment">// dp接口输出使能</span></span><br><span class="line">        .rgb_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">12</span>),      <span class="comment">// rgb接口输出使能</span></span><br><span class="line">        .hdmi_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">13</span>),     <span class="comment">// hdmi接口输出使能</span></span><br><span class="line">        .edp_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">14</span>),      <span class="comment">// edp接口输出使能</span></span><br><span class="line">        .mipi_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">15</span>),     <span class="comment">// mipi接口输出使能</span></span><br><span class="line">        .mipi_dual_channel_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">3</span>),  <span class="comment">// mipi1接口输出使能</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里以如下代码为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3288_SYS_CTRL                         0x0008</span></span><br><span class="line"></span><br><span class="line">.hdmi_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">13</span>),</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>RK3288_SYS_CTRL</code>为<code>offset</code>，表示寄存器偏移，相对<code>vop</code>基址，</li>
<li><code>0x1</code>为<code>mask</code>：表示掩码；</li>
<li><code>13</code>为<code>shift</code>，表示偏移位；</li>
</ul>
<p>因此，总结下来就是地址为<code>0xff900000+0x0008</code>=<code>0xff900008</code>的寄存器的位13用于<code>hdmi</code>接口的使能。</p>
<p>不幸的是在<code>RK3399 datasheet</code>没有找到与<code>vop</code>相关的任何信息，我猜测<code>Rockchip</code>应该是<code>vop</code>这部分并不对用户开放。</p>
<p>不过我们可以通过<code>drivers/gpu/drm/rockchip/rockchip_vop_reg.h</code>中的宏定义猜测出<code>vop</code>包含了哪些寄存器；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* rk3399 register definition */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_REG_CFG_DONE                     0x0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_VERSION_INFO                     0x0004</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_SYS_CTRL                         0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_SYS_CTRL1                        0x000c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_CTRL0                        0x0010</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_CTRL1                        0x0014</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_BG                           0x0018</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_MCU_CTRL                         0x001c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WB_CTRL0                         0x0020</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WB_CTRL1                         0x0024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WB_YRGB_MST                      0x0028</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WB_CBR_MST                       0x002c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_CTRL0                       0x0030</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_CTRL1                       0x0034</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_COLOR_KEY                   0x0038</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_VIR                         0x003c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_YRGB_MST                    0x0040</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_CBR_MST                     0x0044</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_ACT_INFO                    0x0048</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_DSP_INFO                    0x004c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_DSP_ST                      0x0050</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_SCL_FACTOR_YRGB             0x0054</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_SCL_FACTOR_CBR              0x0058</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_SCL_OFFSET                  0x005c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_SRC_ALPHA_CTRL              0x0060</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_DST_ALPHA_CTRL              0x0064</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_FADING_CTRL                 0x0068</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_CTRL2                       0x006c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_CTRL0                       0x0070</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_CTRL1                       0x0074</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_COLOR_KEY                   0x0078</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_VIR                         0x007c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_YRGB_MST                    0x0080</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_CBR_MST                     0x0084</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_ACT_INFO                    0x0088</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_DSP_INFO                    0x008c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_DSP_ST                      0x0090</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_SCL_FACTOR_YRGB             0x0094</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_SCL_FACTOR_CBR              0x0098</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_SCL_OFFSET                  0x009c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_SRC_ALPHA_CTRL              0x00a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_DST_ALPHA_CTRL              0x00a4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_FADING_CTRL                 0x00a8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_CTRL2                       0x00ac</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_CTRL0                       0x00b0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_CTRL1                       0x00b4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_VIR0_1                      0x00b8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_VIR2_3                      0x00bc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_MST0                        0x00c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_INFO0                   0x00c4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_ST0                     0x00c8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_COLOR_KEY                   0x00cc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_MST1                        0x00d0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_INFO1                   0x00d4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_ST1                     0x00d8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_SRC_ALPHA_CTRL              0x00dc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_MST2                        0x00e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_INFO2                   0x00e4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_ST2                     0x00e8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DST_ALPHA_CTRL              0x00ec</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_MST3                        0x00f0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_INFO3                   0x00f4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_ST3                     0x00f8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_FADING_CTRL                 0x00fc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_CTRL0                       0x0100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_CTRL1                       0x0104</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_VIR0_1                      0x0108</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_VIR2_3                      0x010c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_MST0                        0x0110</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_INFO0                   0x0114</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_ST0                     0x0118</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_COLOR_KEY                   0x011c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_MST1                        0x0120</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_INFO1                   0x0124</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_ST1                     0x0128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_SRC_ALPHA_CTRL              0x012c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_MST2                        0x0130</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_INFO2                   0x0134</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_ST2                     0x0138</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DST_ALPHA_CTRL              0x013c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_MST3                        0x0140</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_INFO3                   0x0144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_ST3                     0x0148</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_FADING_CTRL                 0x014c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_CTRL0                        0x0150</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_CTRL1                        0x0154</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_MST                          0x0158</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_DSP_ST                       0x015c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_SRC_ALPHA_CTRL               0x0160</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_DST_ALPHA_CTRL               0x0164</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_FADING_CTRL                  0x0168</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_RESERVED1                    0x016c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_DSP_HACT_INFO               0x0170</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_DSP_VACT_INFO               0x0174</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_SCL_FACTOR_YRGB             0x0178</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_RESERVED                    0x017c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_SCL_CTRL                    0x0180</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_DSP_VACT_INFO_F1            0x0184</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_HTOTAL_HS_END                0x0188</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_HACT_ST_END                  0x018c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_VTOTAL_VS_END                0x0190</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_VACT_ST_END                  0x0194</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_VS_ST_END_F1                 0x0198</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DSP_VACT_ST_END_F1               0x019c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_PWM_CTRL                         0x01a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_PWM_PERIOD_HPR                   0x01a4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_PWM_DUTY_LPR                     0x01a8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_PWM_CNT                          0x01ac</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BCSH_COLOR_BAR                   0x01b0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BCSH_BCS                         0x01b4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BCSH_H                           0x01b8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BCSH_CTRL                        0x01bc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_CTRL0                       0x01c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_CTRL1                       0x01c4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_CTRL2                       0x01c8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_CTRL3                       0x01cc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAUSS_LINE0_0               0x01d0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAUSS_LINE0_1               0x01d4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAUSS_LINE1_0               0x01d8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAUSS_LINE1_1               0x01dc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAUSS_LINE2_0               0x01e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAUSS_LINE2_1               0x01e4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_FRC_LOWER01_0                    0x01e8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_FRC_LOWER01_1                    0x01ec</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_FRC_LOWER10_0                    0x01f0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_FRC_LOWER10_1                    0x01f4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_FRC_LOWER11_0                    0x01f8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_FRC_LOWER11_1                    0x01fc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD0_CTRL                      0x0200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD0_HDR_PTR                   0x0204</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD0_PIC_SIZE                  0x0208</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD0_STATUS                    0x020c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD1_CTRL                      0x0220</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD1_HDR_PTR                   0x0224</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD1_PIC_SIZE                  0x0228</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD1_STATUS                    0x022c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD2_CTRL                      0x0240</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD2_HDR_PTR                   0x0244</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD2_PIC_SIZE                  0x0248</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD2_STATUS                    0x024c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD3_CTRL                      0x0260</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD3_HDR_PTR                   0x0264</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD3_PIC_SIZE                  0x0268</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AFBCD3_STATUS                    0x026c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_EN0                         0x0280</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_CLEAR0                      0x0284</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_STATUS0                     0x0288</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_RAW_STATUS0                 0x028c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_EN1                         0x0290</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_CLEAR1                      0x0294</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_STATUS1                     0x0298</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_INTR_RAW_STATUS1                 0x029c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_LINE_FLAG                        0x02a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_VOP_STATUS                       0x02a4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BLANKING_VALUE                   0x02a8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_MCU_BYPASS_PORT                  0x02ac</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_DSP_BG                      0x02b0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_DSP_BG                      0x02b4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_DSP_BG                      0x02b8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_DSP_BG                      0x02bc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_YUV2YUV_WIN                      0x02c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_YUV2YUV_POST                     0x02c4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_AUTO_GATING_EN                   0x02cc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_DBG_POST_REG1                    0x036c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_CSC_COE                     0x03a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_CSC_COE                     0x03c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_CSC_COE                     0x03e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_CSC_COE                     0x0400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_CSC_COE                      0x0420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BCSH_R2Y_CSC_COE                 0x0440</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_BCSH_Y2R_CSC_COE                 0x0460</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_YUV2YUV_Y2R_COE             0x0480</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_YUV2YUV_3X3_COE             0x04a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_POST_YUV2YUV_R2Y_COE             0x04c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_YUV2YUV_Y2R                 0x04e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_YUV2YUV_3X3                 0x0500</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN0_YUV2YUV_R2Y                 0x0520</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_YUV2YUV_Y2R                 0x0540</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_YUV2YUV_3X3                 0x0560</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN1_YUV2YUV_R2Y                 0x0580</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_YUV2YUV_Y2R                 0x05a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_YUV2YUV_3X3                 0x05c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_YUV2YUV_R2Y                 0x05e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_YUV2YUV_Y2R                 0x0600</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_YUV2YUV_3X3                 0x0620</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_YUV2YUV_R2Y                 0x0640</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN2_LUT_ADDR                    0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_WIN3_LUT_ADDR                    0x1400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_HWC_LUT_ADDR                     0x1800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_CABC_GAMMA_LUT_ADDR              0x1c00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RK3399_GAMMA_LUT_ADDR                   0x2000</span></span><br></pre></td></tr></table></figure>

<h4 id="5-4-vo-win-init"><a href="#5-4-vo-win-init" class="headerlink" title="5.4 vo_win_init"></a>5.4 <code>vo_win_init</code></h4><p><code>vo_win_init</code>用于初始化<code>vop win</code>，那么什么是<code>vop win</code>，指定就是<code>vop</code>图层，以<code>RK3399</code>其<code>vop</code>包含4个图层；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Initialize the vop-&gt;win array elements.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vop_win_init</span><span class="params">(struct vop *vop)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> *<span class="title">vop_data</span> = <span class="title">vop</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历每一个图层</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vop_data-&gt;win_size; i++) &#123;</span><br><span class="line">                <span class="comment">// 获取第i个vop win</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span> *<span class="title">vop_win</span> = &amp;<span class="title">vop</span>-&gt;<span class="title">win</span>[<span class="title">i</span>];</span></span><br><span class="line">                <span class="comment">// 获取第i个vop win配置相关寄存器信息</span></span><br><span class="line">                <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span> *<span class="title">win_data</span> = &amp;<span class="title">vop_data</span>-&gt;<span class="title">win</span>[<span class="title">i</span>];</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 初始化成员</span></span><br><span class="line">                vop_win-&gt;data = win_data;</span><br><span class="line">                vop_win-&gt;vop = vop;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// rk3399定义了win_yuv2yuv，因此初始化yuv2yuv_data</span></span><br><span class="line">                <span class="keyword">if</span> (vop_data-&gt;win_yuv2yuv)</span><br><span class="line">                        vop_win-&gt;yuv2yuv_data = &amp;vop_data-&gt;win_yuv2yuv[i];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-5-vop-create-crtc"><a href="#5-5-vop-create-crtc" class="headerlink" title="5.5 vop_create_crtc"></a>5.5 <code>vop_create_crtc</code></h4><p><code>vop_create_crtc</code>用于初始化<code>crtc</code>对象，并和<code>plane</code>关联在一起，这里我们仍然以设备节点<code>vopb</code>为例进行分析；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vop_create_crtc</span><span class="params">(struct vop *vop)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="comment">// 获取vop data</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> *<span class="title">vop_data</span> = <span class="title">vop</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">        <span class="comment">// 获取device，对应的设备节点为vopb</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = <span class="title">vop</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">        <span class="comment">// 获取drm device</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">drm_dev</span> = <span class="title">vop</span>-&gt;<span class="title">drm_dev</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_plane</span> *<span class="title">primary</span> = <span class="title">NULL</span>, *<span class="title">cursor</span> = <span class="title">NULL</span>, *<span class="title">plane</span>, *<span class="title">tmp</span>;</span></span><br><span class="line">        <span class="comment">// 获取drm crtc</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc</span> *<span class="title">crtc</span> = &amp;<span class="title">vop</span>-&gt;<span class="title">crtc</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">port</span>;</span></span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Create drm_plane for primary and cursor planes first, since we need</span></span><br><span class="line"><span class="comment">         * to pass them to drm_crtc_init_with_planes, which sets the</span></span><br><span class="line"><span class="comment">         * &quot;possible_crtcs&quot; to the newly initialized crtc.         </span></span><br><span class="line"><span class="comment">         * 1. 遍历每一个vop win，每个vop win内部包含一个drm_plane，对类型为primary和cursor plane</span></span><br><span class="line"><span class="comment">         * 进行初始化</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vop_data-&gt;win_size; i++) &#123;</span><br><span class="line">                <span class="comment">// 获取第i个vop win</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span> *<span class="title">vop_win</span> = &amp;<span class="title">vop</span>-&gt;<span class="title">win</span>[<span class="title">i</span>];</span></span><br><span class="line">                <span class="comment">// 获取第i个vop win data</span></span><br><span class="line">                <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span> *<span class="title">win_data</span> = <span class="title">vop_win</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 只处理primary和cursor plane</span></span><br><span class="line">                <span class="keyword">if</span> (win_data-&gt;type != DRM_PLANE_TYPE_PRIMARY &amp;&amp;</span><br><span class="line">                    win_data-&gt;type != DRM_PLANE_TYPE_CURSOR)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">// 进行plane的初始化，其中funcs被设置为vop_plane_funcs</span></span><br><span class="line">                ret = drm_universal_plane_init(vop-&gt;drm_dev,    <span class="comment">// drm设备</span></span><br><span class="line">                                               &amp;vop_win-&gt;base,  <span class="comment">// 要初始化的plane对象</span></span><br><span class="line">                                               <span class="number">0</span>,  <span class="comment">// 可能的CRTCs的位掩码</span></span><br><span class="line">                                               &amp;vop_plane_funcs,  <span class="comment">// plane的控制函数集合</span></span><br><span class="line">                                               win_data-&gt;phy-&gt;data_formats,  <span class="comment">// 支持的格式数组（DRM_FORMAT_*）</span></span><br><span class="line">                                               win_data-&gt;phy-&gt;nformats,   <span class="comment">// formats数组的长度</span></span><br><span class="line">                                               win_data-&gt;phy-&gt;format_modifiers, </span><br><span class="line">                                               win_data-&gt;type, <span class="comment">// plane的类型</span></span><br><span class="line">                                               <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to init plane %d\n&quot;</span>,</span><br><span class="line">                                      ret);</span><br><span class="line">                        <span class="keyword">goto</span> err_cleanup_planes;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取当前plane</span></span><br><span class="line">                plane = &amp;vop_win-&gt;base;</span><br><span class="line">                <span class="comment">// 设置plane的辅助函数helper_private为plane_helper_funcs</span></span><br><span class="line">                drm_plane_helper_add(plane, &amp;plane_helper_funcs);</span><br><span class="line">                <span class="comment">// 如果vop win data配置了x_mir_en/y_mir_en，则调用drm_plane_create_rotation_property为plane附加rotation property</span></span><br><span class="line">                vop_plane_add_properties(plane, win_data);</span><br><span class="line">                <span class="comment">// 保存primary plane</span></span><br><span class="line">                <span class="keyword">if</span> (plane-&gt;type == DRM_PLANE_TYPE_PRIMARY)</span><br><span class="line">                        primary = plane;</span><br><span class="line">                <span class="comment">// 保存cursor plane</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (plane-&gt;type == DRM_PLANE_TYPE_CURSOR)</span><br><span class="line">                        cursor = plane;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 2. 使用指定的primary and cursor planes初始化的crtc对象，其中crtc回调函数funcs设置为vop_crtc_funcs</span></span><br><span class="line">        ret = drm_crtc_init_with_planes(drm_dev, crtc, primary, cursor,</span><br><span class="line">                                        &amp;vop_crtc_funcs, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">goto</span> err_cleanup_planes;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 设置crtc的辅助函数helper_private为vop_crtc_helper_funcs</span></span><br><span class="line">        drm_crtc_helper_add(crtc, &amp;vop_crtc_helper_funcs);</span><br><span class="line">        <span class="comment">// 进入</span></span><br><span class="line">        <span class="keyword">if</span> (vop-&gt;lut_regs) &#123;</span><br><span class="line">                drm_mode_crtc_set_gamma_size(crtc, vop_data-&gt;lut_size);</span><br><span class="line">                drm_crtc_enable_color_mgmt(crtc, <span class="number">0</span>, <span class="literal">false</span>, vop_data-&gt;lut_size);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Create drm_planes for overlay windows with possible_crtcs restricted</span></span><br><span class="line"><span class="comment">         * to the newly created crtc.</span></span><br><span class="line"><span class="comment">         * 4. 遍历每一个vop win，每个vop win内部包含一个drm_plane，对类型为overlay plane</span></span><br><span class="line"><span class="comment">         * 进行初始化</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vop_data-&gt;win_size; i++) &#123;</span><br><span class="line">                <span class="comment">// 获取第i个vop win</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span> *<span class="title">vop_win</span> = &amp;<span class="title">vop</span>-&gt;<span class="title">win</span>[<span class="title">i</span>];</span></span><br><span class="line">                <span class="comment">// 获取第i个vop win data</span></span><br><span class="line">                <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span> *<span class="title">win_data</span> = <span class="title">vop_win</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">long</span> possible_crtcs = drm_crtc_mask(crtc);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 只处理overlay plane</span></span><br><span class="line">                <span class="keyword">if</span> (win_data-&gt;type != DRM_PLANE_TYPE_OVERLAY)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 进行plane的初始化，其中funcs被设置为vop_plane_funcs</span></span><br><span class="line">                ret = drm_universal_plane_init(vop-&gt;drm_dev, &amp;vop_win-&gt;base,</span><br><span class="line">                                               possible_crtcs,</span><br><span class="line">                                               &amp;vop_plane_funcs,</span><br><span class="line">                                               win_data-&gt;phy-&gt;data_formats,</span><br><span class="line">                                               win_data-&gt;phy-&gt;nformats,</span><br><span class="line">                                               win_data-&gt;phy-&gt;format_modifiers,</span><br><span class="line">                                               win_data-&gt;type, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to init overlay %d\n&quot;</span>,</span><br><span class="line">                                      ret);</span><br><span class="line">                        <span class="keyword">goto</span> err_cleanup_crtc;</span><br><span class="line">                &#125;</span><br><span class="line">               <span class="comment">// 设置plane的辅助函数helper_private为plane_helper_funcs</span></span><br><span class="line">                drm_plane_helper_add(&amp;vop_win-&gt;base, &amp;plane_helper_funcs);</span><br><span class="line">                <span class="comment">// 如果vop win data配置了x_mir_en/y_mir_en，则调用drm_plane_create_rotation_property为plane附加rotation property</span></span><br><span class="line">                vop_plane_add_properties(&amp;vop_win-&gt;base, win_data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 从vopb节点的子节点列表中查找名为port的子节点，也就是vopb_out节点</span></span><br><span class="line">        port = of_get_child_by_name(dev-&gt;of_node, <span class="string">&quot;port&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!port) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;no port node found in %pOF\n&quot;</span>,</span><br><span class="line">                              dev-&gt;of_node);</span><br><span class="line">                ret = -ENOENT;</span><br><span class="line">                <span class="keyword">goto</span> err_cleanup_crtc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 初始化工作队列</span></span><br><span class="line">        drm_flip_work_init(&amp;vop-&gt;fb_unref_work, <span class="string">&quot;fb_unref&quot;</span>,</span><br><span class="line">                           vop_fb_unref_worker);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化完成量，</span></span><br><span class="line">        init_completion(&amp;vop-&gt;dsp_hold_completion);</span><br><span class="line">        init_completion(&amp;vop-&gt;line_flag_completion);</span><br><span class="line">        <span class="comment">// 设置port节点</span></span><br><span class="line">        crtc-&gt;port = port;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 对crtc进行自刷新相关的辅助函数初始化</span></span><br><span class="line">        ret = drm_self_refresh_helper_init(crtc);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                DRM_DEV_DEBUG_KMS(vop-&gt;dev,</span><br><span class="line">                        <span class="string">&quot;Failed to init %s with SR helpers %d, ignoring\n&quot;</span>,</span><br><span class="line">                        crtc-&gt;name, ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_cleanup_crtc:</span><br><span class="line">        drm_crtc_cleanup(crtc);</span><br><span class="line">err_cleanup_planes:</span><br><span class="line">        list_for_each_entry_safe(plane, tmp, &amp;drm_dev-&gt;mode_config.plane_list,</span><br><span class="line">                                 head)</span><br><span class="line">                drm_plane_cleanup(plane);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">err_cleanup_crtc:</span><br><span class="line">        drm_crtc_cleanup(crtc);</span><br><span class="line">err_cleanup_planes:</span><br><span class="line">        list_for_each_entry_safe(plane, tmp, &amp;drm_dev-&gt;mode_config.plane_list,</span><br><span class="line">                                 head)</span><br><span class="line">                drm_plane_cleanup(plane);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是该函数的主要步骤：</p>
<p>(1) 遍历每一个<code>vop win</code>，每个<code>vop win</code>内部包含一个<code>drm_plane</code>，对类型为<code>primary</code>和<code>cursor plane</code>进行初始化；</p>
<p>具体是调用<code>drm_universal_plane_init</code>来初始化<code>drm_plane</code>，并且添加<code>plane</code>辅助函数、设置属性等；</p>
<p>其中<code>funcs</code>被设置为<code>vop_plane_funcs</code>，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_plane_funcs</span> <span class="title">vop_plane_funcs</span> = &#123;</span></span><br><span class="line">        .update_plane   = drm_atomic_helper_update_plane,</span><br><span class="line">        .disable_plane  = drm_atomic_helper_disable_plane,</span><br><span class="line">        .destroy = vop_plane_destroy,</span><br><span class="line">        .reset = drm_atomic_helper_plane_reset,</span><br><span class="line">        .atomic_duplicate_state = drm_atomic_helper_plane_duplicate_state,</span><br><span class="line">        .atomic_destroy_state = drm_atomic_helper_plane_destroy_state,</span><br><span class="line">        .format_mod_supported = rockchip_mod_supported,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>helper_private</code>被设为<code>plane_helper_funcs</code>，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_plane_helper_funcs</span> <span class="title">plane_helper_funcs</span> = &#123;</span></span><br><span class="line">        .atomic_check = vop_plane_atomic_check,</span><br><span class="line">        .atomic_update = vop_plane_atomic_update,</span><br><span class="line">        .atomic_disable = vop_plane_atomic_disable,</span><br><span class="line">        .atomic_async_check = vop_plane_atomic_async_check,</span><br><span class="line">        .atomic_async_update = vop_plane_atomic_async_update,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>(2) 调用<code>drm_crtc_init_with_planes</code>使用指定的<code>primary and cursor planes</code>初始化的<code>crtc</code>对象，其中<code>crtc</code>回调函数<code>funcs</code>设置为<code>vop_crtc_funcs</code>，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_funcs</span> <span class="title">vop_crtc_funcs</span> = &#123;</span></span><br><span class="line">        .set_config = drm_atomic_helper_set_config,</span><br><span class="line">        .page_flip = drm_atomic_helper_page_flip,</span><br><span class="line">        .destroy = vop_crtc_destroy,</span><br><span class="line">        .reset = vop_crtc_reset,</span><br><span class="line">        .atomic_duplicate_state = vop_crtc_duplicate_state,</span><br><span class="line">        .atomic_destroy_state = vop_crtc_destroy_state,</span><br><span class="line">        .enable_vblank = vop_crtc_enable_vblank,</span><br><span class="line">        .disable_vblank = vop_crtc_disable_vblank,</span><br><span class="line">        .set_crc_source = vop_crtc_set_crc_source,</span><br><span class="line">        .verify_crc_source = vop_crtc_verify_crc_source,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>(3) 调用<code>drm_crtc_helper_add</code>设置<code>crtc</code>的辅助函数<code>helper_private</code>为<code>vop_crtc_helper_funcs</code>，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc_helper_funcs</span> <span class="title">vop_crtc_helper_funcs</span> = &#123;</span></span><br><span class="line">        .mode_fixup = vop_crtc_mode_fixup,</span><br><span class="line">        .atomic_check = vop_crtc_atomic_check,</span><br><span class="line">        .atomic_begin = vop_crtc_atomic_begin,</span><br><span class="line">        .atomic_flush = vop_crtc_atomic_flush,</span><br><span class="line">        .atomic_enable = vop_crtc_atomic_enable,</span><br><span class="line">        .atomic_disable = vop_crtc_atomic_disable,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>(4) 遍历每一个<code>vop win</code>，每个<code>vop win</code>内部包含一个<code>drm_plane</code>，对类型为<code>overlay plane</code>进行初始化；</p>
<p>(5) 调用<code>of_get_child_by_name</code>从<code>vopb</code>节点的子节点列表中查找名为<code>port</code>的子节点，也就是<code>vopb_out</code>节点；</p>
<p>(6) 调用<code>drm_flip_work_init(&amp;vop-&gt;fb_unref_work, &quot;fb_unref&quot;,vop_fb_unref_worker)</code>初始化工作队列；</p>
<p>函数<code>drm_flip_work_init</code>定义在<code>drivers/gpu/drm/drm_flip_work.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">flip_worker</span><span class="params">(struct work_struct *w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_flip_work</span> *<span class="title">work</span> = <span class="title">container_of</span>(<span class="title">w</span>, <span class="title">struct</span> <span class="title">drm_flip_work</span>, <span class="title">worker</span>);</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tasks</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">drm_flip_task</span> *<span class="title">task</span>, *<span class="title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line">                INIT_LIST_HEAD(&amp;tasks);</span><br><span class="line">                spin_lock_irqsave(&amp;work-&gt;lock, flags);</span><br><span class="line">                list_splice_tail(&amp;work-&gt;commited, &amp;tasks);</span><br><span class="line">                INIT_LIST_HEAD(&amp;work-&gt;commited);</span><br><span class="line">                spin_unlock_irqrestore(&amp;work-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (list_empty(&amp;tasks))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                list_for_each_entry_safe(task, tmp, &amp;tasks, node) &#123;</span><br><span class="line">                        work-&gt;func(work, task-&gt;data);</span><br><span class="line">                        kfree(task);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_flip_work_init - initialize flip-work</span></span><br><span class="line"><span class="comment"> * @work: the flip-work to initialize</span></span><br><span class="line"><span class="comment"> * @name: debug name</span></span><br><span class="line"><span class="comment"> * @func: the callback work function</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Initializes/allocates resources for the flip-work</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">drm_flip_work_init</span><span class="params">(struct drm_flip_work *work,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">drm_flip_func_t</span> func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        work-&gt;name = name;</span><br><span class="line">        INIT_LIST_HEAD(&amp;work-&gt;queued);</span><br><span class="line">        INIT_LIST_HEAD(&amp;work-&gt;commited);</span><br><span class="line">        spin_lock_init(&amp;work-&gt;lock);</span><br><span class="line">        work-&gt;func = func;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置work-&gt;worker工作函数为flip_worker</span></span><br><span class="line">        INIT_WORK(&amp;work-&gt;worker, flip_worker);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(7) 调用<code>drm_self_refresh_helper_init</code>对<code>crtc</code>进行自刷新相关的辅助函数初始化；</p>
<p><code>drm_self_refresh_helper_init</code>定义在<code>drivers/gpu/drm/drm_self_refresh_helper.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_self_refresh_helper_init - Initializes self refresh helpers for a crtc</span></span><br><span class="line"><span class="comment"> * @crtc: the crtc which supports self refresh supported displays</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns zero if successful or -errno on failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">drm_self_refresh_helper_init</span><span class="params">(struct drm_crtc *crtc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_self_refresh_data</span> *<span class="title">sr_data</span> = <span class="title">crtc</span>-&gt;<span class="title">self_refresh_data</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Helper is already initialized */</span></span><br><span class="line">        <span class="keyword">if</span> (WARN_ON(sr_data))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        sr_data = kzalloc(<span class="keyword">sizeof</span>(*sr_data), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!sr_data)</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">        INIT_DELAYED_WORK(&amp;sr_data-&gt;entry_work,</span><br><span class="line">                          drm_self_refresh_helper_entry_work);</span><br><span class="line">        sr_data-&gt;crtc = crtc;</span><br><span class="line">        mutex_init(&amp;sr_data-&gt;avg_mutex);</span><br><span class="line">        ewma_psr_time_init(&amp;sr_data-&gt;entry_avg_ms);</span><br><span class="line">        ewma_psr_time_init(&amp;sr_data-&gt;exit_avg_ms);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Seed the averages so they&#x27;re non-zero (and sufficiently large</span></span><br><span class="line"><span class="comment">         * for even poorly performing panels). As time goes on, this will be</span></span><br><span class="line"><span class="comment">         * averaged out and the values will trend to their true value.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ewma_psr_time_add(&amp;sr_data-&gt;entry_avg_ms, SELF_REFRESH_AVG_SEED_MS);</span><br><span class="line">        ewma_psr_time_add(&amp;sr_data-&gt;exit_avg_ms, SELF_REFRESH_AVG_SEED_MS);</span><br><span class="line"></span><br><span class="line">        crtc-&gt;self_refresh_data = sr_data;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-6-vop-initial"><a href="#5-6-vop-initial" class="headerlink" title="5.6 vop_initial"></a>5.6 <code>vop_initial</code></h4><p><code>vop_initial</code>用户<code>vop</code>初始化，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>；</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> int vop_initial(<span class="class"><span class="keyword">struct</span> <span class="title">vop</span></span> *vop)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">reset_control</span></span> *ahb_rst;</span><br><span class="line">        int i, ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据时钟名称hclk_vop获取时钟，设备节点属性clock-names、clocks，指定了名字为hclk_vop对应的时钟为&lt;&amp;cru HCLK_VOP0&gt;</span></span><br><span class="line">        vop-&gt;hclk = devm_clk_get(vop-&gt;dev, <span class="string">&quot;hclk_vop&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(vop-&gt;hclk)) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to get hclk source\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> PTR_ERR(vop-&gt;hclk);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 根据时钟名称aclk_vop获取时钟，设备节点属性clock-names、clocks，指定了名字为aclk_vop对应的时钟为&lt;&amp;cru ACLK_VOP0&gt;</span></span><br><span class="line">        vop-&gt;aclk = devm_clk_get(vop-&gt;dev, <span class="string">&quot;aclk_vop&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(vop-&gt;aclk)) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to get aclk source\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> PTR_ERR(vop-&gt;aclk);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 根据时钟名称dclk_vop获取时钟，设备节点属性clock-names、clocks，指定了名字为dclk_vop对应的时钟为&lt;&amp;cru DCLK_VOP0&gt;</span></span><br><span class="line">        vop-&gt;dclk = devm_clk_get(vop-&gt;dev, <span class="string">&quot;dclk_vop&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(vop-&gt;dclk)) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to get dclk source\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> PTR_ERR(vop-&gt;dclk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 电源相关，，使能设备的runtime pm功能 暂且忽略</span></span><br><span class="line">        ret = pm_runtime_resume_and_get(vop-&gt;dev);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to get pm runtime: %d\n&quot;</span>, ret);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">       <span class="comment">// dclk时钟准备，使其处于可用状态，但不启用它</span></span><br><span class="line">       ret = clk_prepare(vop-&gt;dclk);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to prepare dclk\n&quot;</span>);</span><br><span class="line">                goto err_put_pm_runtime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Enable both the hclk and aclk to setup the vop，hclk时钟准备和使能 */</span></span><br><span class="line">        ret = clk_prepare_enable(vop-&gt;hclk);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to prepare/enable hclk\n&quot;</span>);</span><br><span class="line">                goto err_unprepare_dclk;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// aclk时钟准备和使能</span></span><br><span class="line">        ret = clk_prepare_enable(vop-&gt;aclk);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to prepare/enable aclk\n&quot;</span>);</span><br><span class="line">                goto err_disable_hclk;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * do hclk_reset, reset all vop registers. 获取ahb相应的reset句柄</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ahb_rst = devm_reset_control_get(vop-&gt;dev, <span class="string">&quot;ahb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(ahb_rst)) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to get ahb reset\n&quot;</span>);</span><br><span class="line">                ret = PTR_ERR(ahb_rst);</span><br><span class="line">                goto err_disable_aclk;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对传入的reset资源进行复位操作</span></span><br><span class="line">        reset_control_assert(ahb_rst);</span><br><span class="line">        <span class="comment">// 睡眠，单位为微妙</span></span><br><span class="line">        usleep_range(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="comment">// 对传入的reset资源进行解复位操作</span></span><br><span class="line">        reset_control_deassert(ahb_rst);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置rk3399_vop_big.intr.clear所描述寄存器相应位的值</span></span><br><span class="line">        VOP_INTR_SET_TYPE(vop, clear, INTR_MASK, <span class="number">1</span>);       </span><br><span class="line">        <span class="comment">// 设置rk3399_vop_big.intr.enable所描述寄存器相应位的值</span></span><br><span class="line">        VOP_INTR_SET_TYPE(vop, enable, INTR_MASK, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 备份vop相关寄存器的值</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vop-&gt;len; i += sizeof(<span class="built_in">u32</span>))</span><br><span class="line">                vop-&gt;regsbak[i / <span class="number">4</span>] = readl_relaxed(vop-&gt;regs + i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置rk3399_vop_big.misc.global_regdone_en所描述寄存器相应位的值</span></span><br><span class="line">        VOP_REG_SET(vop, misc, global_regdone_en, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 设置rk3399_vop_big.common.dsp_blank所描述寄存器相应位的值</span></span><br><span class="line">        VOP_REG_SET(vop, common, dsp_blank, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历每一个vop win</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vop-&gt;data-&gt;win_size; i++) &#123;</span><br><span class="line">                <span class="comment">// 获取第i个vop win</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span></span> *vop_win = &amp;vop-&gt;win[i];</span><br><span class="line">                <span class="comment">// 获取第i个vop win data</span></span><br><span class="line">                <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win_data</span></span> *win = vop_win-&gt;data;</span><br><span class="line">                int channel = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 设置rk3399_vop_big.win[i].phy.channel所描述寄存器相应位的值</span></span><br><span class="line">                VOP_WIN_SET(vop, win, channel, (channel + <span class="number">1</span>) &lt;&lt; <span class="number">4</span> | channel);</span><br><span class="line">                <span class="comment">// 禁止当前vop win</span></span><br><span class="line">                vop_win_disable(vop, vop_win);</span><br><span class="line">                <span class="comment">// 设置rk3399_vop_big.win[i].phy.gate所描述寄存器相应位的值</span></span><br><span class="line">                VOP_WIN_SET(vop, win, gate, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置rk3399_vop_big.common.cfg_done所描述寄存器相应位的值，enable reg config</span></span><br><span class="line">        vop_cfg_done(vop);</span><br><span class="line">    </span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * do dclk_reset, let all config take affect. 获取dclk相应的reset句柄</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        vop-&gt;dclk_rst = devm_reset_control_get(vop-&gt;dev, <span class="string">&quot;dclk&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(vop-&gt;dclk_rst)) &#123;</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;failed to get dclk reset\n&quot;</span>);</span><br><span class="line">                ret = PTR_ERR(vop-&gt;dclk_rst);</span><br><span class="line">                goto err_disable_aclk;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 对传入的reset资源进行复位操作</span></span><br><span class="line">        reset_control_assert(vop-&gt;dclk_rst);</span><br><span class="line">        <span class="comment">// 睡眠，单位为微妙</span></span><br><span class="line">        usleep_range(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">         <span class="comment">// 对传入的reset资源进行解复位操作</span></span><br><span class="line">        reset_control_deassert(vop-&gt;dclk_rst);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 禁止时钟hclk</span></span><br><span class="line">        clk_disable(vop-&gt;hclk);</span><br><span class="line">        <span class="comment">// 禁止时钟aclk</span></span><br><span class="line">        clk_disable(vop-&gt;aclk);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使能标志位</span></span><br><span class="line">        vop-&gt;is_enabled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        pm_runtime_put_sync(vop-&gt;dev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_disable_aclk:</span><br><span class="line">        clk_disable_unprepare(vop-&gt;aclk);</span><br><span class="line">err_disable_hclk:</span><br><span class="line">        clk_disable_unprepare(vop-&gt;hclk);</span><br><span class="line">err_unprepare_dclk:</span><br><span class="line">        clk_unprepare(vop-&gt;dclk);</span><br><span class="line">err_put_pm_runtime:</span><br><span class="line">        pm_runtime_put_sync(vop-&gt;dev);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数主要做了两件事件：</p>
<ul>
<li><code>vop</code>相关时钟初始化：<code>aclk_vop</code>、<code>dclk_vop</code>、<code>hclk_vop</code>；</li>
<li><code>vop</code>相关寄存器配置，底层通过<code>vop_reg_set</code>设置配置寄存器值；</li>
</ul>
<h5 id="5-6-1-VOP-REG-SET"><a href="#5-6-1-VOP-REG-SET" class="headerlink" title="5.6.1 VOP_REG_SET"></a>5.6.1 <code>VOP_REG_SET</code></h5><p><code>VOP_REG_SET</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>，目的就是设置指定寄存器指定位的值；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">vop_reg_set</span><span class="params">(struct vop *vop, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> struct vop_reg *reg, <span class="comment">// 寄存器信息</span></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">uint32_t</span> _offset,   <span class="comment">// 寄存器偏移 传入0</span></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">uint32_t</span> _mask,  <span class="comment">// 掩码 传入0xffffffff</span></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">uint32_t</span> v, <span class="comment">// 值</span></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> <span class="keyword">char</span> *reg_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> offset, mask, shift;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (!reg || !reg-&gt;mask) &#123;</span><br><span class="line">                DRM_DEV_DEBUG(vop-&gt;dev, <span class="string">&quot;Warning: not support %s\n&quot;</span>, reg_name);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 偏移位</span></span><br><span class="line">        offset = reg-&gt;offset + _offset;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 掩码</span></span><br><span class="line">        mask = reg-&gt;mask &amp; _mask;</span><br><span class="line">        shift = reg-&gt;shift;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reg-&gt;write_mask) &#123; <span class="comment">// false</span></span><br><span class="line">                v = ((v &lt;&lt; shift) &amp; <span class="number">0xffff</span>) | (mask &lt;&lt; (shift + <span class="number">16</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 获取寄存器的值</span></span><br><span class="line">                <span class="keyword">uint32_t</span> cached_val = vop-&gt;regsbak[offset &gt;&gt; <span class="number">2</span>];</span><br><span class="line">                <span class="comment">// 计算新的值</span></span><br><span class="line">                v = (cached_val &amp; ~(mask &lt;&lt; shift)) | ((v &amp; mask) &lt;&lt; shift);</span><br><span class="line">                <span class="comment">// 保存新值</span></span><br><span class="line">                vop-&gt;regsbak[offset &gt;&gt; <span class="number">2</span>] = v;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reg-&gt;relaxed) <span class="comment">// true</span></span><br><span class="line">                <span class="comment">// 写寄存器</span></span><br><span class="line">                writel_relaxed(v, vop-&gt;regs + offset);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                writel(v, vop-&gt;regs + offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VOP_REG_SET(vop, group, name, v) \</span></span><br><span class="line">                    vop_reg_set(vop, &amp;vop-&gt;data-&gt;group-&gt;name, <span class="number">0</span>, ~<span class="number">0</span>, v, #name)</span><br></pre></td></tr></table></figure>

<p>比如<code>VOP_REG_SET(vop, common, dsp_blank, 0);</code>实际上就是配置<code>RK3399_DSP_CTRL0</code>寄存器位<code>[19:18]</code>为0；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rk3399_vop_big.common.dsp_blankk = VOP_REG(RK3399_DSP_CTRL0, <span class="number">0x3</span>, <span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<h5 id="5-6-2-VOP-INTR-SET-TYPE"><a href="#5-6-2-VOP-INTR-SET-TYPE" class="headerlink" title="5.6.2 VOP_INTR_SET_TYPE"></a>5.6.2 <code>VOP_INTR_SET_TYPE</code></h5><p><code>VOP_INTR_SET_TYPE</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>，目的就是设置指定寄存器指定位的值；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VOP_INTR_SET_MASK(vop, name, mask, v) \</span></span><br><span class="line">                vop_reg_set(vop, &amp;vop-&gt;data-&gt;intr-&gt;name, <span class="number">0</span>, mask, v, #name)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VOP_INTR_SET_TYPE(vop, name, type, v) \</span></span><br><span class="line">        <span class="keyword">do</span> &#123; \</span><br><span class="line">                <span class="keyword">int</span> i, reg = <span class="number">0</span>, mask = <span class="number">0</span>; \</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; vop-&gt;data-&gt;intr-&gt;nintrs; i++) &#123; \</span><br><span class="line">                        <span class="keyword">if</span> (vop-&gt;data-&gt;intr-&gt;intrs[i] &amp; type) &#123; \</span><br><span class="line">                                reg |= (v) &lt;&lt; i; \</span><br><span class="line">                                mask |= <span class="number">1</span> &lt;&lt; i; \</span><br><span class="line">                        &#125; \</span><br><span class="line">                &#125; \</span><br><span class="line">                VOP_INTR_SET_MASK(vop, name, mask, reg); \</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h5 id="5-6-3-VOP-WIN-SET"><a href="#5-6-3-VOP-WIN-SET" class="headerlink" title="5.6.3 VOP_WIN_SET"></a>5.6.3 <code>VOP_WIN_SET</code></h5><p><code>VOP_WIN_SET</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_vop.c</code>，目的就是设置指定寄存器指定位的值；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VOP_WIN_SET(vop, win, name, v) \</span></span><br><span class="line">                vop_reg_set(vop, &amp;win-&gt;phy-&gt;name, win-&gt;base, ~<span class="number">0</span>, v, #name)</span><br></pre></td></tr></table></figure>

<h4 id="5-7-vop-isr"><a href="#5-7-vop-isr" class="headerlink" title="5.7 vop_isr"></a>5.7 <code>vop_isr</code></h4><p><code>vop_isr</code>为<code>GIC_SPI</code>中断处理函数：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> irqreturn_t vop_isr(int irq, void *data)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vop</span></span> *vop = data;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_crtc</span></span> *crtc = &amp;vop-&gt;crtc;</span><br><span class="line">        uint32_t active_irqs;</span><br><span class="line">        int ret = IRQ_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The irq is shared with the iommu. If the runtime-pm state of the</span></span><br><span class="line"><span class="comment">         * vop-device is disabled the irq has to be targeted at the iommu.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!pm_runtime_get_if_in_use(vop-&gt;dev))</span><br><span class="line">                <span class="keyword">return</span> IRQ_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vop_core_clks_enable(vop)) &#123;</span><br><span class="line">                DRM_DEV_ERROR_RATELIMITED(vop-&gt;dev, <span class="string">&quot;couldn&#x27;t enable clocks\n&quot;</span>);</span><br><span class="line">                goto out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * interrupt register has interrupt status, enable and clear bits, we</span></span><br><span class="line"><span class="comment">         * must hold irq_lock to avoid a race with enable/disable_vblank().</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        spin_lock(&amp;vop-&gt;irq_lock);</span><br><span class="line"></span><br><span class="line">        active_irqs = VOP_INTR_GET_TYPE(vop, status, INTR_MASK);</span><br><span class="line">        <span class="comment">/* Clear all active interrupt sources */</span></span><br><span class="line">        <span class="keyword">if</span> (active_irqs)</span><br><span class="line">                VOP_INTR_SET_TYPE(vop, clear, active_irqs, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        spin_unlock(&amp;vop-&gt;irq_lock);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* This is expected for vop iommu irqs, since the irq is shared */</span></span><br><span class="line">        <span class="keyword">if</span> (!active_irqs)</span><br><span class="line">                goto out_disable;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (active_irqs &amp; DSP_HOLD_VALID_INTR) &#123;</span><br><span class="line">                <span class="comment">// 唤醒等待此特定complete事件的单个线程</span></span><br><span class="line">                complete(&amp;vop-&gt;dsp_hold_completion);</span><br><span class="line">                active_irqs &amp;= ~DSP_HOLD_VALID_INTR;</span><br><span class="line">                ret = IRQ_HANDLED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (active_irqs &amp; LINE_FLAG_INTR) &#123;</span><br><span class="line">               <span class="comment">// 唤醒等待此特定complete事件的单个线程</span></span><br><span class="line">                complete(&amp;vop-&gt;line_flag_completion);</span><br><span class="line">                active_irqs &amp;= ~LINE_FLAG_INTR;</span><br><span class="line">                ret = IRQ_HANDLED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (active_irqs &amp; FS_INTR) &#123;</span><br><span class="line">                drm_crtc_handle_vblank(crtc);</span><br><span class="line">                vop_handle_vblank(vop);</span><br><span class="line">                active_irqs &amp;= ~FS_INTR;</span><br><span class="line">                ret = IRQ_HANDLED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Unhandled irqs are spurious. */</span></span><br><span class="line">        <span class="keyword">if</span> (active_irqs)</span><br><span class="line">                DRM_DEV_ERROR(vop-&gt;dev, <span class="string">&quot;Unknown VOP IRQs: %#02x\n&quot;</span>,</span><br><span class="line">                              active_irqs);</span><br><span class="line"></span><br><span class="line">out_disable:</span><br><span class="line">        vop_core_clks_disable(vop);</span><br><span class="line">out:</span><br><span class="line">        pm_runtime_put(vop-&gt;dev);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-8-rockchip-drm-dma-init-device"><a href="#5-8-rockchip-drm-dma-init-device" class="headerlink" title="5.8 rockchip_drm_dma_init_device"></a>5.8 <code>rockchip_drm_dma_init_device</code></h4><p><code>rockchip_drm_dma_init_device</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_drv.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rockchip_drm_dma_init_device</span><span class="params">(struct drm_device *drm_dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_drm_private</span> *<span class="title">private</span> = <span class="title">drm_dev</span>-&gt;<span class="title">dev_private</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!device_iommu_mapped(dev))</span><br><span class="line">                <span class="keyword">private</span>-&gt;iommu_dev = ERR_PTR(-ENODEV);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">private</span>-&gt;iommu_dev)</span><br><span class="line">                <span class="keyword">private</span>-&gt;iommu_dev = dev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-9-总结"><a href="#5-9-总结" class="headerlink" title="5.9 总结"></a>5.9 总结</h4><p>经过上述的分析，我们大致了解到<code>vop_bind</code>的主要功能’；</p>
<ul>
<li><p>解析<code>vopb</code>设备节点；</p>
<ul>
<li>获取<code>aclk_vop</code>, <code>dclk_vop</code>, <code>hclk_vop</code>时钟，并进行时钟准备和使能功能；</li>
<li>获取<code>vop</code>中断，并申请<code>vop</code>中断；</li>
<li>获取<code>vopb</code>相关寄存器虚拟地址；</li>
<li>获取<code>ahb</code>、<code>dclk</code> 复位句柄，并通过复位句柄进行设备的复位操作；</li>
</ul>
</li>
<li><p>初始化<code>drm_crtc</code>，其中：</p>
<ul>
<li>回调函数<code>funcs</code>设置为<code>vop_crtc_funcs</code>；</li>
<li>辅助函数<code>helper_private</code>设置为<code>vop_crtc_helper_funcs</code>；</li>
</ul>
</li>
<li><p>由于<code>RK3399</code>有4个<code>vop win</code>，每个<code>vop win</code>内部包含一个<code>drm_plane</code>，对<code>drm_plane</code>进行初始化，其中：</p>
<ul>
<li>回调函数<code>funcs</code>设置为<code>vop_plane_funcs</code>；</li>
<li>辅助函数<code>helper_private</code>设置为<code>plane_helper_funcs</code> ；</li>
</ul>
</li>
<li><p>配置<code>vop</code>相关的寄存器，比如<code>rk3399_vop_big.intr.clear</code>、<code>rk3399_vop_big.intr.enable</code>等；</p>
</li>
</ul>
<p>需要注意的是：<code>vop_bind</code>中没有进行显示模式的配置，即显示的各种时序参数配置（与显示器息息相关）。</p>
<p><strong>参考文章</strong></p>
<p><strong>[1] <a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/category_9281458.html"><code>DRM (Direct Rendering Manager</code>)</a></strong></p>
<p><strong>[2] <code>Wiki</code>: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager"><code>Direct Rendering Manager</code></a></strong></p>
<p><strong>[3] <a target="_blank" rel="noopener" href="https://events.static.linuxfound.org/sites/events/files/slides/brezillon-drm-kms.pdf"><code>The DRM/KMS subsystem from a newbie’s point of view</code></a></strong></p>
<p><strong>[4] <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41709234/article/details/129472180"><code>DRM</code>驱动概念、组成、框架、源码分析</a></strong></p>
<p><strong>[5] <a target="_blank" rel="noopener" href="https://blog.csdn.net/zichuanning520/article/details/127047436"><code>linux</code>驱动系列学习之<code>DRM</code>（十）</a></strong></p>
<p><strong>[6] <a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/article/details/105180621"><code>DRM</code>驱动程序开发（<code>VKMS</code>）</a></strong></p>
<p><strong>[7] <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/92682047"><code>MIPI</code>自学笔记</a></strong></p>
<p><strong>[8] <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32276547/article/details/129020651"><code>Linux reset</code>子系统和驱动实例</a></strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20240222/">https://zhoujinjian.com/posts/20240222/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20240223/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</div></div></a></div><div class="next-post pull-right"><a href="/posts/20240221/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81LCD%E7%A1%AC%E4%BB%B6%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">一、LCD硬件原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-CRT%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 CRT介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-LCD%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 LCD示意图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E6%97%B6%E5%BA%8F%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 时序参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81crtc%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">二、crtc数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-struct-drm-crtc"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 struct drm_crtc</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-struct-drm-display-mode"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 struct drm_display_mode</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-struct-drm-crtc-state"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 struct drm_crtc_state</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 操作函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-struct-drm-crtc-funcs"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 struct drm_crtc_funcs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-struct-drm-crtc-helper-funcs"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 struct drm_crtc_helper_funcs</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%A0%B8%E5%BF%83API"><span class="toc-number">3.</span> <span class="toc-text">三、核心API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-drm-crtc-init-with-planes"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 drm_crtc_init_with_planes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-drm-crtc-crc-init"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 drm_crtc_crc_init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-drm-crtc-helper-add"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 drm_crtc_helper_add</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Rockchip-vop%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.</span> <span class="toc-text">四、Rockchip vop驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-DRM%E9%A9%B1%E5%8A%A8%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E5%9B%9E%E9%A1%BE"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 DRM驱动入口函数回顾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-vop-platform-driver"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 vop_platform_driver</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-of-match-table"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 of_match_table</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-vop-probe"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 vop_probe</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-vopb%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 vopb设备节点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-vop-bind"><span class="toc-number">5.</span> <span class="toc-text">五 vop_bind</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-struct-vop"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 struct vop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-struct-vop-data"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 struct vop_data</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-rk3288-modeset"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 rk3288_modeset</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2-rk3399-common"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 rk3399_common</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-3-rk3399-vop-wn-data"><span class="toc-number">5.2.3.</span> <span class="toc-text">5.2.3 rk3399_vop_wn_data</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-4-rk3399-vop-big-win-yuv2yuv-data"><span class="toc-number">5.2.4.</span> <span class="toc-text">5.2.4 rk3399_vop_big_win_yuv2yuv_data</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-rk3399-output"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 rk3399_output</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-vo-win-init"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 vo_win_init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-vop-create-crtc"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 vop_create_crtc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-vop-initial"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 vop_initial</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-6-1-VOP-REG-SET"><span class="toc-number">5.6.1.</span> <span class="toc-text">5.6.1 VOP_REG_SET</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-6-2-VOP-INTR-SET-TYPE"><span class="toc-number">5.6.2.</span> <span class="toc-text">5.6.2 VOP_INTR_SET_TYPE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-6-3-VOP-WIN-SET"><span class="toc-number">5.6.3.</span> <span class="toc-text">5.6.3 VOP_WIN_SET</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-vop-isr"><span class="toc-number">5.7.</span> <span class="toc-text">5.7 vop_isr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-rockchip-drm-dma-init-device"><span class="toc-number">5.8.</span> <span class="toc-text">5.8 rockchip_drm_dma_init_device</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-9-%E6%80%BB%E7%BB%93"><span class="toc-number">5.9.</span> <span class="toc-text">5.9 总结</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>