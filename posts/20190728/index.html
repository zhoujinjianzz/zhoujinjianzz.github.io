<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 9.0 App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（2）：Window加载显示流程分析 | zhoujinjian</title><meta name="keywords" content="Android,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 9.0 App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（2）：Window加载显示流程分析">
<meta property="og:url" content="https://zhoujinjian.com/posts/20190728/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.43.jpg">
<meta property="article:published_time" content="2019-07-28T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.960Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.43.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20190728/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.43.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 9.0 App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（2）：Window加载显示流程分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-07-28T01:25:00.000Z" title="发表于 2019-07-28 09:25:00">2019-07-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.960Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Graphics/">Graphics</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<p>注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。<br>（==<strong>文章基于 Kernel-3.18</strong>==）&amp;&amp;（==<strong>文章基于 Android 9.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://www.intrinsyc.com/snapdragon-embedded-development-kits/open-q-820-usom-development-kit/">【开发板 Intrinsyc Open-Q™ 820 µSOM Development Kit】</a><br><a target="_blank" rel="noopener" href="https://gitlab.com/zhoujinjianzz/apq8096_la.um.7.5.r1-03100-8x96.0_p_v5.0">【开发板 Android 9.0 &amp;&amp; Linux（Kernel 3.18）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p><a target="_blank" rel="noopener" href="http://charlesvincent.cc/">（1）【Android Display System】</a></p>
<hr>
<p>==源码（部分）==：<br><strong>packages/apps/testViewportGreen &amp;&amp; testViewportBlue &amp;&amp; testViewportRed/</strong><br><strong>frameworks/base/core/java/android/app/</strong><br><strong>frameworks/base/services/core/java/com/android/server/wm/</strong><br><strong>frameworks/base/services/core/java/com/android/server/am/</strong><br><strong>frameworks/base/services/core/java/com/android/server/policy/</strong><br><strong>frameworks/native/services/surfaceflinger/</strong><br><strong>frameworks/native/libs/gui/</strong><br><strong>frameworks/native/libs/ui/</strong></p>
<hr>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.Android-Graphics-Architecture.png" alt="enter image description here"> </p>
<h4 id="（一）、Window添加过程"><a href="#（一）、Window添加过程" class="headerlink" title="（一）、Window添加过程"></a>（一）、Window添加过程</h4><h5 id="（1）、ActivityThread-performLaunchActivity"><a href="#（1）、ActivityThread-performLaunchActivity" class="headerlink" title="（1）、ActivityThread.performLaunchActivity()"></a>（1）、ActivityThread.performLaunchActivity()</h5><p>接着上一篇文章开始分析，performLaunchActivity()方法完成了两件事：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\ActivityThread.java</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**  Core implementation of activity launch. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.i(TAG, <span class="string">&quot;performLaunchActivity&quot;</span>,<span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());;</span><br><span class="line"></span><br><span class="line">        ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">        <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ComponentName component = r.intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = r.intent.resolveActivity(</span><br><span class="line">                mInitialApplication.getPackageManager());</span><br><span class="line">            r.intent.setComponent(component);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">        Activity activity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to instantiate activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Performing launch of &quot;</span> + r);</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, r + <span class="string">&quot;: app=&quot;</span> + app</span><br><span class="line">                    + <span class="string">&quot;, appName=&quot;</span> + app.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, pkg=&quot;</span> + r.packageInfo.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, comp=&quot;</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                    + <span class="string">&quot;, dir=&quot;</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">                <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    config.updateFrom(r.overrideConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">&quot;Launching activity &quot;</span></span><br><span class="line">                        + r.activityInfo.name + <span class="string">&quot; with config &quot;</span> + config);</span><br><span class="line">                Window window = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                    window = r.mPendingRemoveWindow;</span><br><span class="line">                    r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                    r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                appContext.setOuterContext(activity);</span><br><span class="line">                activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback,</span><br><span class="line">                        r.assistToken);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    activity.mIntent = customIntent;</span><br><span class="line">                &#125;</span><br><span class="line">                r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">                checkAndBlockForNetworkAccess();</span><br><span class="line">                activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">                <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                    activity.setTheme(theme);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">&quot;Activity &quot;</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">&quot; did not call through to super.onCreate()&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.activity = activity;</span><br><span class="line">            &#125;</span><br><span class="line">            r.setState(ON_CREATE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// updatePendingActivityConfiguration() reads from mActivities to update</span></span><br><span class="line">            <span class="comment">// ActivityClientRecord which runs in a different thread. Protect modifications to</span></span><br><span class="line">            <span class="comment">// mActivities to avoid race.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">                mActivities.put(r.token, r);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to start activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>Activity窗口对象PhoneWindow的创建，通过attach函数来完成；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\Activity.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            Window window, ActivityConfigCallback activityConfigCallback)</span> </span>&#123;</span><br><span class="line">        attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">        mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">        mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">        mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">            mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (info.uiOptions != <span class="number">0</span>) &#123;</span><br><span class="line">            mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">        &#125;</span><br><span class="line">        mUiThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        mMainThread = aThread;</span><br><span class="line">        mInstrumentation = instr;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mIdent = ident;</span><br><span class="line">        mApplication = application;</span><br><span class="line">        mIntent = intent;</span><br><span class="line">        mReferrer = referrer;</span><br><span class="line">        mComponent = intent.getComponent();</span><br><span class="line">        mActivityInfo = info;</span><br><span class="line">        mTitle = title;</span><br><span class="line">        mParent = parent;</span><br><span class="line">        mEmbeddedID = id;</span><br><span class="line">        mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line">        <span class="keyword">if</span> (voiceInteractor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lastNonConfigurationInstances != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mVoiceInteractor = <span class="keyword">new</span> VoiceInteractor(voiceInteractor, <span class="keyword">this</span>, <span class="keyword">this</span>,</span><br><span class="line">                        Looper.myLooper());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mWindow.setContainer(mParent.getWindow());</span><br><span class="line">        &#125;</span><br><span class="line">        mWindowManager = mWindow.getWindowManager();</span><br><span class="line">        mCurrentConfig = config;</span><br><span class="line"></span><br><span class="line">        mWindow.setColorMode(info.colorMode);</span><br><span class="line"></span><br><span class="line">        setAutofillCompatibilityEnabled(application.isAutofillCompatibilityEnabled());</span><br><span class="line">        enableAutofillCompatibilityIfNeeded();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Activity视图对象的创建，通过callActivityOnCreate &gt;&gt;&gt; setContentView函数来完成；</li>
</ul>
<h5 id="（2）、Activity-setContentView"><a href="#（2）、Activity-setContentView" class="headerlink" title="（2）、Activity.setContentView()"></a>（2）、Activity.setContentView()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\Activity.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    mCanEnterPictureInPicture = <span class="keyword">true</span>;</span><br><span class="line">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">    <span class="keyword">if</span> (persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        onCreate(icicle, persistentState);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onCreate(icicle);</span><br><span class="line">    &#125;</span><br><span class="line">    writeEventLog(LOG_AM_ON_CREATE_CALLED, <span class="string">&quot;performCreate&quot;</span>);</span><br><span class="line">    mActivityTransitionState.readState(icicle);</span><br><span class="line"></span><br><span class="line">    mVisibleFromClient = !mWindow.getWindowStyle().getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.Window_windowNoDisplay, <span class="keyword">false</span>);</span><br><span class="line">    mFragments.dispatchActivityCreated();</span><br><span class="line">    mActivityTransitionState.setEnterActivityOptions(<span class="keyword">this</span>, getActivityOptions());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\Activity.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="meta">@LayoutRes</span> <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">        getWindow().setContentView(layoutResID);</span><br><span class="line">        initWindowDecorActionBar();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>getWindow()函数得到前面创建的窗口对象PhoneWindow，通过PhoneWindow来设置Activity的视图。<br>[-&gt;PhoneWindow.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\policy\PhoneWindow.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            installDecor();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Activity.onCreate()会调用setContentView(),整个过程主要是Activity的布局文件或View添加至窗口里，<br>详细过程不再赘述，详细加载过程请参考：<a target="_blank" rel="noopener" href="http://blog.csdn.net/yanbober/article/details/45970721"> Android应用setContentView与LayoutInflater加载解析机制源码分析</a><br>重点概括为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">● 创建一个DecorView的对象mDecor，该mDecor对象将作为整个应用窗口的根视图。</span><br><span class="line">● 依据Feature等style theme创建不同的窗口修饰布局文件，并且通过findViewById获取Activity布局文件该存放的地方（窗口修饰布局文件中id为content的FrameLayout）。</span><br><span class="line">● 将Activity的布局文件添加至id为content的FrameLayout内。</span><br><span class="line">● 当setContentView设置显示OK以后会回调Activity的onContentChanged方法。Activity的各种View的findViewById()方法等都可以放到该方法中，系统会帮忙回调。</span><br></pre></td></tr></table></figure>
<p>#####（3）、ActivityThread.handleResumeActivity()<br>在调用完performLaunchActivity()方法之后，其有掉用了handleResumeActivity()法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\ActivityThread.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finalStateRequest, <span class="keyword">boolean</span> isForward,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">&quot;Resume &quot;</span> + r + <span class="string">&quot; started activity: &quot;</span> + a.mStartedActivity</span><br><span class="line">                    + <span class="string">&quot;, hideForNow: &quot;</span> + r.hideForNow + <span class="string">&quot;, finished: &quot;</span> + a.mFinished);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> forwardBit = isForward</span><br><span class="line">                ? WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">            r.window = r.activity.getWindow();</span><br><span class="line">            View decor = r.window.getDecorView();</span><br><span class="line">            decor.setVisibility(View.INVISIBLE);</span><br><span class="line">            ViewManager wm = a.getWindowManager();</span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            a.mDecor = decor;</span><br><span class="line">            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line">            l.softInputMode |= forwardBit;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                    a.mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">                    wm.addView(decor, l);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    a.onWindowAttributesChanged(l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</span><br><span class="line">            r.hideForNow = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cleanUpPendingRemoveWindows(r, <span class="keyword">false</span> <span class="comment">/* force */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.newConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                performConfigurationChangedForActivity(r, r.newConfig);</span><br><span class="line">                r.newConfig = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Resuming &quot;</span> + r + <span class="string">&quot; with isForward=&quot;</span> + isForward);</span><br><span class="line">            WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">            <span class="keyword">if</span> ((l.softInputMode</span><br><span class="line">                    &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</span><br><span class="line">                    != forwardBit) &#123;</span><br><span class="line">                l.softInputMode = (l.softInputMode</span><br><span class="line">                        &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</span><br><span class="line">                        | forwardBit;</span><br><span class="line">                <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                    ViewManager wm = a.getWindowManager();</span><br><span class="line">                    View decor = r.window.getDecorView();</span><br><span class="line">                    wm.updateViewLayout(decor, l);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r.activity.mVisibleFromServer = <span class="keyword">true</span>;</span><br><span class="line">            mNumVisibleActivities++;</span><br><span class="line">            <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                r.activity.makeVisible();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.nextIdle = mNewActivities;</span><br><span class="line">        mNewActivities = r;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Scheduling idle handler for &quot;</span> + r);</span><br><span class="line">        Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们知道，在前面的performLaunchActivity函数中完成Activity的创建后，会将当前当前创建的Activity在应用程序进程端的描述符ActivityClientRecord以键值对的形式保存到ActivityThread的成员变量mActivities中：mActivities.put(r.token, r);，r.token就是Activity的身份证，即是IApplicationToken.Proxy代理对象，也用于与AMS通信。上面的函数首先通过performResumeActivity从mActivities变量中取出Activity的应用程序端描述符ActivityClientRecord，然后取出前面为Activity创建的视图对象DecorView和窗口管理器WindowManager，最后将视图对象添加到窗口管理器中。</p>
<p>#####（4）、ViewManager.addView()</p>
<p>ViewManager.addView()真正实现的的地方在WindowManagerImpl.java中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewManager.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[-&gt;WindowManagerImpl.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\WindowManagerImpl.java</span><br><span class="line"></span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>[-&gt;WindowManagerGlobal.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\WindowManagerGlobal.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</span><br><span class="line">    <span class="keyword">if</span> (parentWindow != <span class="keyword">null</span>) &#123;</span><br><span class="line">        parentWindow.adjustLayoutParamsForSubWindow(wparams);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Context context = view.getContext();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; (context.getApplicationInfo().flags</span><br><span class="line">                        &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>) &#123;</span><br><span class="line">            wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    ViewRootImpl root;</span><br><span class="line">    View panelParentView = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        ......</span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125; </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#####（5）、ViewRootImpl.setView()</p>
<h5 id="5-1、ViewRootImpl-构造过程"><a href="#5-1、ViewRootImpl-构造过程" class="headerlink" title="5.1、ViewRootImpl()构造过程"></a>5.1、ViewRootImpl()构造过程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> W mWindow;</span><br><span class="line">    <span class="keyword">final</span> Surface mSurface = <span class="keyword">new</span> Surface();</span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mWindowSession = WindowManagerGlobal.getWindowSession();</span><br><span class="line">        mDisplay = display;</span><br><span class="line">        mBasePackageName = context.getBasePackageName();</span><br><span class="line">        mThread = Thread.currentThread();</span><br><span class="line">        mLocation = <span class="keyword">new</span> WindowLeaked(<span class="keyword">null</span>);</span><br><span class="line">        mLocation.fillInStackTrace();</span><br><span class="line">        mWidth = -<span class="number">1</span>;</span><br><span class="line">        mHeight = -<span class="number">1</span>;</span><br><span class="line">        mDirty = <span class="keyword">new</span> Rect();</span><br><span class="line">        mTempRect = <span class="keyword">new</span> Rect();</span><br><span class="line">        mVisRect = <span class="keyword">new</span> Rect();</span><br><span class="line">        mWinFrame = <span class="keyword">new</span> Rect();</span><br><span class="line">        mWindow = <span class="keyword">new</span> W(<span class="keyword">this</span>);</span><br><span class="line">        mTargetSdkVersion = context.getApplicationInfo().targetSdkVersion;</span><br><span class="line">        mViewVisibility = View.GONE;</span><br><span class="line">        mTransparentRegion = <span class="keyword">new</span> Region();</span><br><span class="line">        mPreviousTransparentRegion = <span class="keyword">new</span> Region();</span><br><span class="line">        mFirst = <span class="keyword">true</span>; <span class="comment">// true for the first time the view is added</span></span><br><span class="line">        mAdded = <span class="keyword">false</span>;</span><br><span class="line">        mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler, <span class="keyword">this</span>,</span><br><span class="line">                context);</span><br><span class="line">        mAccessibilityManager = AccessibilityManager.getInstance(context);</span><br><span class="line">        mAccessibilityManager.addAccessibilityStateChangeListener(</span><br><span class="line">                mAccessibilityInteractionConnectionManager, mHandler);</span><br><span class="line">        mHighContrastTextManager = <span class="keyword">new</span> HighContrastTextManager();</span><br><span class="line">        mAccessibilityManager.addHighTextContrastStateChangeListener(</span><br><span class="line">                mHighContrastTextManager, mHandler);</span><br><span class="line">        mViewConfiguration = ViewConfiguration.get(context);</span><br><span class="line">        mDensity = context.getResources().getDisplayMetrics().densityDpi;</span><br><span class="line">        mNoncompatDensity = context.getResources().getDisplayMetrics().noncompatDensityDpi;</span><br><span class="line">        mFallbackEventHandler = <span class="keyword">new</span> PhoneFallbackEventHandler(context);</span><br><span class="line">        mChoreographer = Choreographer.getInstance();</span><br><span class="line">        mDisplayManager = (DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line">        loadSystemProperties();</span><br><span class="line">        mPerf = <span class="keyword">new</span> BoostFramework(context);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在ViewRootImpl的构造函数中初始化了一些成员变量，ViewRootImpl创建了以下几个主要对象：</p>
<p>(1)        通过WindowManagerGlobal.getWindowSession()得到IWindowSession的代理对象，该对象用于和WMS通信。</p>
<p>(2)        创建了一个W本地Binder对象，用于WMS与APP进程通信。</p>
<p>(3)        采用单例模式创建了一个Choreographer对象，用于统一调度窗口绘图。</p>
<p>(4)        创建ViewRootHandler对象，用于处理当前视图消息。</p>
<p>(5)        构造一个AttachInfo对象；</p>
<p>(6)        创建Surface对象，用于绘制当前视图，当然该Surface对象的真正创建是由WMS来完成的，只不过是WMS传递给应用程序进程的。</p>
<h5 id="5-1-1、IWindowSession代理获取过程"><a href="#5-1-1、IWindowSession代理获取过程" class="headerlink" title="5.1.1、IWindowSession代理获取过程"></a>5.1.1、IWindowSession代理获取过程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\WindowManagerGlobal.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWindowSession <span class="title">getWindowSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (WindowManagerGlobal.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sWindowSession == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    InputMethodManager imm = InputMethodManager.getInstance();</span><br><span class="line">                    IWindowManager windowManager = getWindowManagerService();</span><br><span class="line">                    sWindowSession = windowManager.openSession(</span><br><span class="line">                            <span class="keyword">new</span> IWindowSessionCallback.Stub() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimatorScaleChanged</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</span><br><span class="line">                                    ValueAnimator.setDurationScale(scale);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            imm.getClient(), imm.getInputContext());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sWindowSession;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="5-1-1-1、WindowManagerService-openSession"><a href="#5-1-1-1、WindowManagerService-openSession" class="headerlink" title="5.1.1.1、WindowManagerService.openSession()"></a>5.1.1.1、WindowManagerService.openSession()</h6><p>通过Binder通信WindowManagerService.openSession()<br>通过WMS的openSession函数创建应用程序与WMS之间的连接通道，即获取IWindowSession代理对象，并将该代理对象保存到ViewRootImpl的静态成员变量sWindowSession中,因此在应用程序进程中有且只有一个IWindowSession代理对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IWindowSession <span class="title">openSession</span><span class="params">(IWindowSessionCallback callback, IInputMethodClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">            IInputContext inputContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;null client&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (inputContext == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;null inputContext&quot;</span>);</span><br><span class="line">        Session session = <span class="keyword">new</span> Session(<span class="keyword">this</span>, callback, client, inputContext);</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="5-1-1-2、new-Session"><a href="#5-1-1-2、new-Session" class="headerlink" title="5.1.1.2、new Session()"></a>5.1.1.2、new Session()</h6><p>在WMS服务端构造了一个Session实例对象。ViewRootImpl 是一很重要的类，类似 ActivityThread 负责跟AmS通信一样，ViewRootImpl 的一个重要职责就是跟 WmS 通信，它通静态变量 sWindowSession（IWindowSession实例）与 WmS 进行通信。每个应用进程，仅有一个 sWindowSession 对象，它对应了 WmS 中的 Session 子类，WmS 为每一个应用进程分配一个 Session 对象。WindowState 类有一个 IWindow mClient 参数，是在构造方法中赋值的，是由 Session 调用 addWindow 传递过来了，对应了 ViewRootImpl 中的 W 类的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\Session.java</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">IWindowSession</span>.<span class="title">Stub</span> <span class="keyword">implements</span> <span class="title">IBinder</span>.<span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WindowManagerService mService;</span><br><span class="line">    <span class="keyword">final</span> IWindowSessionCallback mCallback;</span><br><span class="line">    <span class="keyword">final</span> IInputMethodClient mClient;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mUid;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mPid;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mStringName;</span><br><span class="line">    SurfaceSession mSurfaceSession;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mNumWindow = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Set of visible application overlay window surfaces connected to this session.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;WindowSurfaceController&gt; mAppOverlaySurfaces = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">// Set of visible alert window surfaces connected to this session.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;WindowSurfaceController&gt; mAlertWindowSurfaces = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DragDropController mDragDropController;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mCanAddInternalSystemWindow;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mCanHideNonSystemOverlayWindows;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mCanAcquireSleepToken;</span><br><span class="line">    <span class="keyword">private</span> AlertWindowNotification mAlertWindowNotification;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mShowingAlertWindowNotificationAllowed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mClientDead = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mLastReportedAnimatorScale;</span><br><span class="line">    <span class="keyword">private</span> String mPackageName;</span><br><span class="line">    <span class="keyword">private</span> String mRelayoutTag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Session</span><span class="params">(WindowManagerService service, IWindowSessionCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">            IInputMethodClient client, IInputContext inputContext)</span> </span>&#123;</span><br><span class="line">        mService = service;</span><br><span class="line">        mCallback = callback;</span><br><span class="line">        mClient = client;</span><br><span class="line">        ......</span><br><span class="line">        mDragDropController = mService.mDragDropController;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">synchronized</span> (mService.mWindowMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mInputMethodManager == <span class="keyword">null</span> &amp;&amp; mService.mHaveInputMethods) &#123;</span><br><span class="line">                IBinder b = ServiceManager.getService(</span><br><span class="line">                        Context.INPUT_METHOD_SERVICE);</span><br><span class="line">                mService.mInputMethodManager = IInputMethodManager.Stub.asInterface(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.mInputMethodManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mService.mInputMethodManager.addClient(client, inputContext,</span><br><span class="line">                        mUid, mPid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                client.setUsingInputMethod(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            client.asBinder().linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">           ......</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="5-1-2、创建W本地Binder对象"><a href="#5-1-2、创建W本地Binder对象" class="headerlink" title="5.1.2、创建W本地Binder对象"></a>5.1.2、创建W本地Binder对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">W</span> <span class="keyword">extends</span> <span class="title">IWindow</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;ViewRootImpl&gt; mViewAncestor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IWindowSession mWindowSession;</span><br><span class="line"></span><br><span class="line">    W(ViewRootImpl viewAncestor) &#123;</span><br><span class="line">        mViewAncestor = <span class="keyword">new</span> WeakReference&lt;ViewRootImpl&gt;(viewAncestor);</span><br><span class="line">        mWindowSession = viewAncestor.mWindowSession;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.IWindow_session.png" alt="enter image description here"> </p>
<h5 id="5-1-3、Choreographer创建"><a href="#5-1-3、Choreographer创建" class="headerlink" title="5.1.3、Choreographer创建"></a>5.1.3、Choreographer创建</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Choreographer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Choreographer</span><span class="params">(Looper looper, <span class="keyword">int</span> vsyncSource)</span> </span>&#123;</span><br><span class="line">        mLooper = looper;</span><br><span class="line">        mHandler = <span class="keyword">new</span> FrameHandler(looper);</span><br><span class="line">        mDisplayEventReceiver = USE_VSYNC</span><br><span class="line">                ? <span class="keyword">new</span> FrameDisplayEventReceiver(looper, vsyncSource)</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line">        mLastFrameTimeNanos = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        mFrameIntervalNanos = (<span class="keyword">long</span>)(<span class="number">1000000000</span> / getRefreshRate());</span><br><span class="line"></span><br><span class="line">        mCallbackQueues = <span class="keyword">new</span> CallbackQueue[CALLBACK_LAST + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= CALLBACK_LAST; i++) &#123;</span><br><span class="line">            mCallbackQueues[i] = <span class="keyword">new</span> CallbackQueue();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// b/68769804: For low FPS experiments.</span></span><br><span class="line">        setFPSDivisor(SystemProperties.getInt(ThreadedRenderer.DEBUG_FPS_DIVISOR, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Choreographer.java</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameDisplayEventReceiver</span> <span class="keyword">extends</span> <span class="title">DisplayEventReceiver</span></span></span><br><span class="line"><span class="class">            <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FrameDisplayEventReceiver</span><span class="params">(Looper looper, <span class="keyword">int</span> vsyncSource)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper, vsyncSource);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>FrameDisplayEventReceiver 继承 DisplayEventReceiver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\DisplayEventReceiver.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DisplayEventReceiver</span><span class="params">(Looper looper, <span class="keyword">int</span> vsyncSource)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mMessageQueue = looper.getQueue();</span><br><span class="line">        mReceiverPtr = nativeInit(<span class="keyword">new</span> WeakReference&lt;DisplayEventReceiver&gt;(<span class="keyword">this</span>), mMessageQueue,</span><br><span class="line">                vsyncSource);</span><br><span class="line"></span><br><span class="line">        mCloseGuard.open(<span class="string">&quot;dispose&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;JNI</span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\jni\android_view_DisplayEventReceiver.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeInit</span><span class="params">(JNIEnv* env, jclass clazz, jobject receiverWeak,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject messageQueueObj, jint vsyncSource)</span> </span>&#123;</span><br><span class="line">    sp&lt;MessageQueue&gt; messageQueue = android_os_MessageQueue_getMessageQueue(env, messageQueueObj);</span><br><span class="line">    <span class="keyword">if</span> (messageQueue == NULL) &#123;</span><br><span class="line">        jniThrowRuntimeException(env, <span class="string">&quot;MessageQueue is not initialized.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;NativeDisplayEventReceiver&gt; receiver = <span class="keyword">new</span> NativeDisplayEventReceiver(env,</span><br><span class="line">            receiverWeak, messageQueue, vsyncSource);</span><br><span class="line">    status_t status = receiver-&gt;initialize();</span><br><span class="line">    <span class="keyword">if</span> (status) &#123;</span><br><span class="line">        String8 message;</span><br><span class="line">        message.appendFormat(<span class="string">&quot;Failed to initialize display event receiver.  status=%d&quot;</span>, status);</span><br><span class="line">        jniThrowRuntimeException(env, message.string());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receiver-&gt;incStrong(gDisplayEventReceiverClassInfo.clazz); <span class="comment">// retain a reference for the object</span></span><br><span class="line">    <span class="keyword">return</span> reinterpret_cast&lt;jlong&gt;(receiver.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NativeDisplayEventReceiver::NativeDisplayEventReceiver(JNIEnv* env,</span><br><span class="line">        jobject receiverWeak, <span class="keyword">const</span> sp&lt;MessageQueue&gt;&amp; messageQueue, jint vsyncSource) :</span><br><span class="line">        DisplayEventDispatcher(messageQueue-&gt;getLooper(),</span><br><span class="line">                static_cast&lt;ISurfaceComposer::VsyncSource&gt;(vsyncSource)),</span><br><span class="line">        mReceiverWeakGlobal(env-&gt;NewGlobalRef(receiverWeak)),</span><br><span class="line">        mMessageQueue(messageQueue) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;receiver %p ~ Initializing display event receiver.&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>NativeDisplayEventReceiver 继承与DisplayEventDispatcher，所以DisplayEventDispatcher会执行初始化操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\libs\androidfw\DisplayEventDispatcher.cpp</span><br><span class="line"></span><br><span class="line">DisplayEventDispatcher::DisplayEventDispatcher(<span class="keyword">const</span> sp&lt;Looper&gt;&amp; looper,</span><br><span class="line">        ISurfaceComposer::VsyncSource vsyncSource) :</span><br><span class="line">        mLooper(looper), mReceiver(vsyncSource), mWaitingForVsync(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;dispatcher %p ~ Initializing display event dispatcher.&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">DisplayEventDispatcher::initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">status_t</span> result = mReceiver.initCheck();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;Failed to initialize display event receiver, status=%d&quot;</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rc = mLooper-&gt;addFd(mReceiver.getFd(), <span class="number">0</span>, Looper::EVENT_INPUT,</span><br><span class="line">            <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 监听mReceiver的所获取的文件句柄，一旦有数据到来，则回调this(此处NativeDisplayEventReceiver)中所复写LooperCallback对象的 handleEvent。</p>
<h5 id="5-1-3-1、Native-DisplayEventReceiver初始化"><a href="#5-1-3-1、Native-DisplayEventReceiver初始化" class="headerlink" title="5.1.3.1、Native DisplayEventReceiver初始化"></a>5.1.3.1、Native DisplayEventReceiver初始化</h5><p>mReceiver为DisplayEventReceiver实例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\DisplayEventReceiver.cpp</span><br><span class="line"></span><br><span class="line">DisplayEventReceiver::DisplayEventReceiver(ISurfaceComposer::VsyncSource vsyncSource) &#123;</span><br><span class="line">    <span class="function">sp&lt;ISurfaceComposer&gt; <span class="title">sf</span><span class="params">(ComposerService::getComposerService())</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (sf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mEventConnection = sf-&gt;createDisplayEventConnection(vsyncSource);</span><br><span class="line">        <span class="keyword">if</span> (mEventConnection != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            mDataChannel = <span class="built_in">std</span>::make_unique&lt;gui::BitTube&gt;();</span><br><span class="line">            mEventConnection-&gt;stealReceiveChannel(mDataChannel.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处通过binder通信与SurfaceFlinger建立连接，直接看SurfaceFlinger服务端的实现</p>
<h5 id="5-1-3-2、createDisplayEventConnection"><a href="#5-1-3-2、createDisplayEventConnection" class="headerlink" title="5.1.3.2、createDisplayEventConnection"></a>5.1.3.2、createDisplayEventConnection</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\SurfaceFlinger.cpp</span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;IDisplayEventConnection&gt; <span class="title">SurfaceFlinger::createDisplayEventConnection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ISurfaceComposer::VsyncSource vsyncSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (vsyncSource == eVsyncSourceSurfaceFlinger) &#123;</span><br><span class="line">        <span class="keyword">return</span> mSFEventThread-&gt;createEventConnection();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mEventThread-&gt;createEventConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们这里不是eVsyncSourceSurfaceFlinger，所以会走mEventThread-&gt;createEventConnection() 分支，为app进程创建一个Connection，会首先调用Connection::onFirstRef()，然后加入到mDisplayEventConnections中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\EventThread.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;BnDisplayEventConnection&gt; <span class="title">EventThread::createEventConnection</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Connection(<span class="keyword">const_cast</span>&lt;EventThread*&gt;(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventThread::Connection::Connection(EventThread* eventThread)</span><br><span class="line">      : count(<span class="number">-1</span>), mEventThread(eventThread), mChannel(gui::BitTube::DefaultSize) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> EventThread::Connection::onFirstRef() &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> mEventThread doesn&#x27;t hold a strong reference on us</span></span><br><span class="line">    mEventThread-&gt;registerDisplayEventConnection(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">EventThread::registerDisplayEventConnection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;EventThread::Connection&gt;&amp; connection)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">    mDisplayEventConnections.add(connection);</span><br><span class="line">    mCondition.notify_all();</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="5-1-3-3、mEventConnection-gt-stealReceiveChannel-mDataChannel-get"><a href="#5-1-3-3、mEventConnection-gt-stealReceiveChannel-mDataChannel-get" class="headerlink" title="5.1.3.3、mEventConnection-&gt;stealReceiveChannel(mDataChannel.get())"></a>5.1.3.3、mEventConnection-&gt;stealReceiveChannel(mDataChannel.get())</h5><p>Binder通信直接看服务端实现，将从客户端传来的BitTube设置到接收VSync信号的FD</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\EventThread.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> EventThread::Connection::stealReceiveChannel(gui::BitTube* outChannel) &#123;</span><br><span class="line">    outChannel-&gt;setReceiveFd(mChannel.moveReceiveFd());</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\BitTube.cpp</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BitTube::setReceiveFd</span><span class="params">(base::unique_fd&amp;&amp; receiveFd)</span> </span>&#123;</span><br><span class="line">    mReceiveFd = <span class="built_in">std</span>::move(receiveFd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="5-1-4、构造AttachInfo对象"><a href="#5-1-4、构造AttachInfo对象" class="headerlink" title="5.1.4、构造AttachInfo对象"></a>5.1.4、构造AttachInfo对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\View.java</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachInfo</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> IWindowSession mSession;</span><br><span class="line">        <span class="keyword">final</span> IWindow mWindow;</span><br><span class="line">        <span class="keyword">final</span> IBinder mWindowToken;</span><br><span class="line">        Display mDisplay;</span><br><span class="line">        <span class="keyword">final</span> Callbacks mRootCallbacks;</span><br><span class="line">        IWindowId mIWindowId;</span><br><span class="line">        WindowId mWindowId;</span><br><span class="line">        View mRootView;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> ViewTreeObserver mTreeObserver;</span><br><span class="line">        Canvas mCanvas;</span><br><span class="line">        <span class="keyword">final</span> ViewRootImpl mViewRootImpl;</span><br><span class="line">        <span class="keyword">final</span> Handler mHandler;</span><br><span class="line">        ......</span><br><span class="line">        AttachInfo(IWindowSession session, IWindow window, Display display,</span><br><span class="line">                ViewRootImpl viewRootImpl, Handler handler, Callbacks effectPlayer,</span><br><span class="line">                Context context) &#123;</span><br><span class="line">            mSession = session;</span><br><span class="line">            mWindow = window;</span><br><span class="line">            mWindowToken = window.asBinder();</span><br><span class="line">            mDisplay = display;</span><br><span class="line">            mViewRootImpl = viewRootImpl;</span><br><span class="line">            mHandler = handler;</span><br><span class="line">            mRootCallbacks = effectPlayer;</span><br><span class="line">            mTreeObserver = <span class="keyword">new</span> ViewTreeObserver(context);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2、视图View添加过程"><a href="#5-2、视图View添加过程" class="headerlink" title="5.2、视图View添加过程"></a>5.2、视图View添加过程</h5><p>窗口管理器WindowManagerImpl为当前添加的窗口创建好各种对象后，调用ViewRootImpl的setView函数向WMS服务添加一个窗口对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mView = view;<span class="comment">//将DecorView保存到ViewRootImpl的成员变量mView中</span></span><br><span class="line"></span><br><span class="line">                mAttachInfo.mDisplayState = mDisplay.getState();</span><br><span class="line">                mDisplayManager.registerDisplayListener(mDisplayListener, mHandler);</span><br><span class="line"></span><br><span class="line">                mViewLayoutDirectionInitial = mView.getRawLayoutDirection();</span><br><span class="line">                mFallbackEventHandler.setView(view);</span><br><span class="line">                mWindowAttributes.copyFrom(attrs);</span><br><span class="line">                ......</span><br><span class="line">                attrs = mWindowAttributes;</span><br><span class="line">                setTag();</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                mClientWindowLayoutFlags = attrs.flags;</span><br><span class="line"></span><br><span class="line">                setAccessibilityFocus(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">                CompatibilityInfo compatibilityInfo =</span><br><span class="line">                        mDisplay.getDisplayAdjustments().getCompatibilityInfo();</span><br><span class="line">                mTranslator = compatibilityInfo.getTranslator();</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LAYOUT) Log.d(mTag, <span class="string">&quot;WindowLayout in setView:&quot;</span> + attrs);</span><br><span class="line">---------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">    Line <span class="number">2310</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.961</span> D/ViewRootImpl[TestActivity]( <span class="number">2602</span>): WindowLayout in setView:&#123;(<span class="number">0</span>,<span class="number">0</span>)(fillxfill) sim=&#123;forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line">    Line <span class="number">2311</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.961</span> D/ViewRootImpl[TestActivity]( <span class="number">2602</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;</span><br><span class="line">---------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (!compatibilityInfo.supportsScreen()) &#123;</span><br><span class="line">                    attrs.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW;</span><br><span class="line">                    mLastInCompatMode = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mSoftInputMode = attrs.softInputMode;</span><br><span class="line">                mWindowAttributesChanged = <span class="keyword">true</span>;</span><br><span class="line">                mWindowAttributesChangesFlag = WindowManager.LayoutParams.EVERYTHING_CHANGED;</span><br><span class="line">                <span class="comment">//同时将DecorView保存到mAttachInfo中  </span></span><br><span class="line">                mAttachInfo.mRootView = view;</span><br><span class="line">                mAttachInfo.mScalingRequired = mTranslator != <span class="keyword">null</span>;</span><br><span class="line">                mAttachInfo.mApplicationScale =</span><br><span class="line">                        mTranslator == <span class="keyword">null</span> ? <span class="number">1.0f</span> : mTranslator.applicationScale;</span><br><span class="line">                <span class="keyword">if</span> (panelParentView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mAttachInfo.mPanelParentWindowToken</span><br><span class="line">                            = panelParentView.getApplicationWindowToken();</span><br><span class="line">                &#125;</span><br><span class="line">                mAdded = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">int</span> res; <span class="comment">/* = WindowManagerImpl.ADD_OKAY; */</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Schedule the first layout -before- adding to the window</span></span><br><span class="line">                <span class="comment">// manager, to make sure we do the relayout before receiving</span></span><br><span class="line">                <span class="comment">// any other events from the system.</span></span><br><span class="line">                <span class="number">1</span>）在添加窗口前进行UI布局 </span><br><span class="line">                requestLayout();</span><br><span class="line">                <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</span><br><span class="line">                        &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</span><br><span class="line">                    mInputChannel = <span class="keyword">new</span> InputChannel();</span><br><span class="line">                &#125;</span><br><span class="line">                mForceDecorViewVisibility = (mWindowAttributes.privateFlags</span><br><span class="line">                        &amp; PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mOrigWindowType = mWindowAttributes.type;</span><br><span class="line">                    mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">true</span>;</span><br><span class="line">                    collectViewAttributes();</span><br><span class="line">                     </span><br><span class="line">                    <span class="comment">// 2)将窗口添加到WMS服务中，mWindow为W本地Binder对象，通过Binder传输到WMS服务端后，变为IWindow代理对象  </span></span><br><span class="line">                    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                            getHostVisibility(), mDisplay.getDisplayId(), mWinFrame,</span><br><span class="line">                            mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                            mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    mAdded = <span class="keyword">false</span>;</span><br><span class="line">                    mView = <span class="keyword">null</span>;</span><br><span class="line">                    mAttachInfo.mRootView = <span class="keyword">null</span>;</span><br><span class="line">                    mInputChannel = <span class="keyword">null</span>;</span><br><span class="line">                    mFallbackEventHandler.setView(<span class="keyword">null</span>);</span><br><span class="line">                    unscheduleTraversals();</span><br><span class="line">                    setAccessibilityFocus(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Adding window failed&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (restore) &#123;</span><br><span class="line">                        attrs.restore();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.968</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Added window android.view.ViewRootImpl$W<span class="meta">@ad597e9</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;Added window &quot;</span> + mWindow);</span><br><span class="line">                ......</span><br><span class="line">                <span class="comment">//3)建立窗口消息通道  </span></span><br><span class="line">                <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mInputQueue = <span class="keyword">new</span> InputQueue();</span><br><span class="line">                        mInputQueueCallback.onInputQueueCreated(mInputQueue);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                            Looper.myLooper());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                view.assignParent(<span class="keyword">this</span>);</span><br><span class="line">                mAddedTouchMode = (res &amp; WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE) != <span class="number">0</span>;</span><br><span class="line">                mAppVisible = (res &amp; WindowManagerGlobal.ADD_FLAG_APP_VISIBLE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mAccessibilityManager.isEnabled()) &#123;</span><br><span class="line">                    mAccessibilityInteractionConnectionManager.ensureConnection();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (view.getImportantForAccessibility() == View.IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</span><br><span class="line">                    view.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_YES);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set up the input pipeline.</span></span><br><span class="line">                CharSequence counterSuffix = attrs.getTitle();</span><br><span class="line">                mSyntheticInputStage = <span class="keyword">new</span> SyntheticInputStage();</span><br><span class="line">                InputStage viewPostImeStage = <span class="keyword">new</span> ViewPostImeInputStage(mSyntheticInputStage);</span><br><span class="line">                InputStage nativePostImeStage = <span class="keyword">new</span> NativePostImeInputStage(viewPostImeStage,</span><br><span class="line">                        <span class="string">&quot;aq:native-post-ime:&quot;</span> + counterSuffix);</span><br><span class="line">                InputStage earlyPostImeStage = <span class="keyword">new</span> EarlyPostImeInputStage(nativePostImeStage);</span><br><span class="line">                InputStage imeStage = <span class="keyword">new</span> ImeInputStage(earlyPostImeStage,</span><br><span class="line">                        <span class="string">&quot;aq:ime:&quot;</span> + counterSuffix);</span><br><span class="line">                InputStage viewPreImeStage = <span class="keyword">new</span> ViewPreImeInputStage(imeStage);</span><br><span class="line">                InputStage nativePreImeStage = <span class="keyword">new</span> NativePreImeInputStage(viewPreImeStage,</span><br><span class="line">                        <span class="string">&quot;aq:native-pre-ime:&quot;</span> + counterSuffix);</span><br><span class="line"></span><br><span class="line">                mFirstInputStage = nativePreImeStage;</span><br><span class="line">                mFirstPostImeInputStage = earlyPostImeStage;</span><br><span class="line">                mPendingInputEventQueueLengthCounterName = <span class="string">&quot;aq:pending:&quot;</span> + counterSuffix;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过前面的分析可以知道，用户自定义的UI作为一个子View被添加到DecorView中，然后将顶级视图DecorView添加到应用程序进程的窗口管理器中，窗口管理器首先为当前添加的View创建一个ViewRootImpl对象、一个布局参数对象ViewGroup.LayoutParams，然后将这三个对象分别保存到当前应用程序进程的窗口管理器WindowManagerImpl中，最后通过ViewRootImpl对象将当前视图对象注册到WMS服务中。</p>
<p>ViewRootImpl的setView函数向WMS服务添加一个窗口对象过程：</p>
<p>(1)         requestLayout()在应用程序进程中进行窗口UI布局；</p>
<p>(2)         WindowSession.addToDisplay()向WMS服务注册一个窗口对象；</p>
<p>(3)         注册应用程序进程端的消息接收通道；</p>
<h5 id="5-2-1、窗口UI布局过程-ViewRootImpl-requestLayout"><a href="#5-2-1、窗口UI布局过程-ViewRootImpl-requestLayout" class="headerlink" title="5.2.1、窗口UI布局过程 ViewRootImpl.requestLayout()"></a>5.2.1、窗口UI布局过程 ViewRootImpl.requestLayout()</h5><p>requestLayout函数调用里面使用了Hanlder的一个小手段，那就是利用postSyncBarrier添加了一个Barrier（挡板），这个挡板的作用是阻塞普通的同步消息的执行，在挡板被撤销之前，只会执行异步消息，而requestLayout先添加了一个挡板Barrier，之后自己插入了一个异步任务mTraversalRunnable，其主要作用就是保证mTraversalRunnable在所有同步Message之前被执行，保证View绘制的最高优先级。具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> TraversalRunnable mTraversalRunnable = <span class="keyword">new</span> TraversalRunnable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</span><br><span class="line">        mChoreographer.postCallback(</span><br><span class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</span><br><span class="line">            scheduleConsumeBatchedInput();</span><br><span class="line">        &#125;</span><br><span class="line">        notifyRendererOfFramePending();</span><br><span class="line">        pokeDrawLockIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-2-2、添加回调过程-mChoreographer-postCallback"><a href="#5-2-2、添加回调过程-mChoreographer-postCallback" class="headerlink" title="5.2.2、添加回调过程 mChoreographer.postCallback()"></a>5.2.2、添加回调过程 mChoreographer.postCallback()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Choreographer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallback</span><span class="params">(<span class="keyword">int</span> callbackType, Runnable action, Object token)</span> </span>&#123;</span><br><span class="line">        postCallbackDelayed(callbackType, action, token, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCallbackDelayed</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">            Runnable action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        postCallbackDelayedInternal(callbackType, action, token, delayMillis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object action, Object token, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;PostCallback: type=&quot;</span> + callbackType</span><br><span class="line">                    + <span class="string">&quot;, action=&quot;</span> + action + <span class="string">&quot;, token=&quot;</span> + token</span><br><span class="line">                    + <span class="string">&quot;, delayMillis=&quot;</span> + delayMillis);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</span><br><span class="line">           <span class="comment">//将要执行的回调封装成CallbackRecord对象，保存到mCallbackQueues数组中</span></span><br><span class="line">            mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dueTime &lt;= now) &#123;</span><br><span class="line">                scheduleFrameLocked(now);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</span><br><span class="line">                msg.arg1 = callbackType;</span><br><span class="line">                msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                mHandler.sendMessageAtTime(msg, dueTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     scheduleFrameLocked(<span class="keyword">long</span> now) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mFrameScheduled) &#123;</span><br><span class="line">            mFrameScheduled = <span class="keyword">true</span>;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (USE_VSYNC) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;Scheduling next frame on vsync.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If running on the Looper thread, then schedule the vsync immediately,</span></span><br><span class="line">                <span class="comment">// otherwise post a message to schedule the vsync from the UI thread</span></span><br><span class="line">                <span class="comment">// as soon as possible.</span></span><br><span class="line">                <span class="keyword">if</span> (isRunningOnLooperThreadLocked()) &#123;</span><br><span class="line">                    scheduleVsyncLocked();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC);</span><br><span class="line">                    msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                    mHandler.sendMessageAtFrontOfQueue(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> nextFrameTime = Math.max(</span><br><span class="line">                        mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;Scheduling next frame in &quot;</span> + (nextFrameTime - now) + <span class="string">&quot; ms.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                Message msg = mHandler.obtainMessage(MSG_DO_FRAME);</span><br><span class="line">                msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">                mHandler.sendMessageAtTime(msg, nextFrameTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>消息处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Choreographer.java</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FrameHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MSG_DO_FRAME:</span><br><span class="line">                    doFrame(System.nanoTime(), <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MSG_DO_SCHEDULE_VSYNC:</span><br><span class="line">                    doScheduleVsync();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MSG_DO_SCHEDULE_CALLBACK:</span><br><span class="line">                    doScheduleCallback(msg.arg1);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doScheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFrameScheduled) &#123;</span><br><span class="line">                scheduleVsyncLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleVsyncLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mDisplayEventReceiver.scheduleVsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在该函数中考虑了两种情况，一种是系统没有使用Vsync机制，在这种情况下，首先根据屏幕刷新频率计算下一次刷新时间，通过异步消息方式延时执行doFrame()函数实现屏幕刷新。如果系统使用了Vsync机制，并且当前线程具备消息循环，则直接请求Vsync信号，否则就通过主线程来请求Vsync信号。</p>
<h5 id="5-2-3、Vsync请求过程-mDisplayEventReceiver-scheduleVsync"><a href="#5-2-3、Vsync请求过程-mDisplayEventReceiver-scheduleVsync" class="headerlink" title="5.2.3、Vsync请求过程 mDisplayEventReceiver.scheduleVsync()"></a>5.2.3、Vsync请求过程 mDisplayEventReceiver.scheduleVsync()</h5><p>我们知道在Choreographer构造函数中，构造了一个FrameDisplayEventReceiver对象，用于请求并接收Vsync信号，Vsync信号请求过程如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\DisplayEventReceiver.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mReceiverPtr == <span class="number">0</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Attempted to schedule a vertical sync pulse but the display event &quot;</span></span><br><span class="line">                    + <span class="string">&quot;receiver has already been disposed.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nativeScheduleVsync(mReceiverPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\android_view_DisplayEventReceiver.cpp</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeScheduleVsync</span><span class="params">(JNIEnv* env, jclass clazz, jlong receiverPtr)</span> </span>&#123;</span><br><span class="line">    sp&lt;NativeDisplayEventReceiver&gt; receiver =</span><br><span class="line">            <span class="keyword">reinterpret_cast</span>&lt;NativeDisplayEventReceiver*&gt;(receiverPtr);</span><br><span class="line">    <span class="keyword">status_t</span> status = receiver-&gt;scheduleVsync();</span><br><span class="line">    <span class="keyword">if</span> (status) &#123;</span><br><span class="line">        String8 message;</span><br><span class="line">        message.appendFormat(<span class="string">&quot;Failed to schedule next vertical sync pulse.  status=%d&quot;</span>, status);</span><br><span class="line">        jniThrowRuntimeException(env, message.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VSync请求过程又转交给了DisplayEventDispatcher： [-&gt;DisplayEventDispatcher.cpp]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\libs\androidfw\DisplayEventDispatcher.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">DisplayEventDispatcher::scheduleVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mWaitingForVsync) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;dispatcher %p ~ Scheduling vsync.&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Drain all pending events.</span></span><br><span class="line">        <span class="keyword">nsecs_t</span> vsyncTimestamp;</span><br><span class="line">        <span class="keyword">int32_t</span> vsyncDisplayId;</span><br><span class="line">        <span class="keyword">uint32_t</span> vsyncCount;</span><br><span class="line">        <span class="comment">//处理显示设备插入</span></span><br><span class="line">        <span class="keyword">if</span> (processPendingEvents(&amp;vsyncTimestamp, &amp;vsyncDisplayId, &amp;vsyncCount)) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;dispatcher %p ~ last event processed while scheduling was for %&quot;</span> PRId64 <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="keyword">this</span>, ns2ms(<span class="keyword">static_cast</span>&lt;<span class="keyword">nsecs_t</span>&gt;(vsyncTimestamp)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">status_t</span> status = mReceiver.requestNextVsync();</span><br><span class="line">        <span class="keyword">if</span> (status) &#123;</span><br><span class="line">            ALOGW(<span class="string">&quot;Failed to request next vsync, status=%d&quot;</span>, status);</span><br><span class="line">            <span class="keyword">return</span> status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mWaitingForVsync = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VSync请求过程又转交给了DisplayEventReceiver： [-&gt;DisplayEventReceiver.cpp]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\DisplayEventReceiver.cpp</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">DisplayEventReceiver::requestNextVsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mEventConnection != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mEventConnection-&gt;requestNextVsync();</span><br><span class="line">        <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_INIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看服务端的实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\EventThread.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventThread::requestNextVsync</span><span class="params">(<span class="keyword">const</span> sp&lt;EventThread::Connection&gt;&amp; connection)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mResyncWithRateLimitCallback) &#123;</span><br><span class="line">        mResyncWithRateLimitCallback();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connection-&gt;count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        connection-&gt;count = <span class="number">0</span>;</span><br><span class="line">        mCondition.notify_all();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventThread::threadMain</span><span class="params">()</span> NO_THREAD_SAFETY_ANALYSIS </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (mKeepRunning) &#123;</span><br><span class="line">        DisplayEventReceiver::Event event;</span><br><span class="line">        Vector&lt;sp&lt;EventThread::Connection&gt; &gt; signalConnections;</span><br><span class="line">        signalConnections = waitForEventLocked(&amp;lock, &amp;event);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// dispatch events to listeners...</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> count = signalConnections.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">const</span> sp&lt;Connection&gt;&amp; <span class="title">conn</span><span class="params">(signalConnections[i])</span></span>;</span><br><span class="line">            <span class="comment">// now see if we still need to report this event</span></span><br><span class="line">            <span class="keyword">status_t</span> err = conn-&gt;postEvent(event);</span><br><span class="line">            <span class="keyword">if</span> (err == -EAGAIN || err == -EWOULDBLOCK) &#123;</span><br><span class="line">                <span class="comment">// The destination doesn&#x27;t accept events anymore, it&#x27;s probably</span></span><br><span class="line">                <span class="comment">// full. For now, we just drop the events on the floor.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">FIXME:</span> Note that some events cannot be dropped and would have</span></span><br><span class="line">                <span class="comment">// to be re-sent later.</span></span><br><span class="line">                <span class="comment">// Right-now we don&#x27;t have the ability to do this.</span></span><br><span class="line">                ALOGW(<span class="string">&quot;EventThread: dropping event (%08x) for connection %p&quot;</span>, event.header.type,</span><br><span class="line">                      conn.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// handle any other error on the pipe as fatal. the only</span></span><br><span class="line">                <span class="comment">// reasonable thing to do is to clean-up this connection.</span></span><br><span class="line">                <span class="comment">// The most common error we&#x27;ll get here is -EPIPE.</span></span><br><span class="line">                removeDisplayEventConnectionLocked(signalConnections[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>waitForEventLocked()函数中等待下一个VSYNC的trigger.。</p>
<p>需要说明的是</p>
<p>/<strong><strong><strong>**</strong></strong></strong>Vsync start**<strong><strong>****</strong></strong>/<br>/<strong><strong><strong>**</strong></strong></strong>Vsync end**<strong><strong>****</strong></strong>/<br>之间的代码此时其实还未执行，call requestNextVsync()来告诉系统我要在下一个VSYNC需要被trigger.</p>
<p>继续ViewRootImpl的setView函数中的WindowSession.addToDisplay()。</p>
<h5 id="5-3、mWindowSession-addToDisplay-向WMS服务注册一个窗口对象"><a href="#5-3、mWindowSession-addToDisplay-向WMS服务注册一个窗口对象" class="headerlink" title="5.3、mWindowSession.addToDisplay()向WMS服务注册一个窗口对象"></a>5.3、mWindowSession.addToDisplay()向WMS服务注册一个窗口对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\Session.java</span><br><span class="line"></span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addToDisplay</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId, Rect outFrame, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">        DisplayCutout.ParcelableWrapper outDisplayCutout, InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mService.addWindow(<span class="keyword">this</span>, window, seq, attrs, viewVisibility, displayId, outFrame,</span><br><span class="line">            outContentInsets, outStableInsets, outOutsets, outDisplayCutout, outInputChannel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看WindowManagerService.java的addWindow()实现</p>
<h6 id="5-3-1、WindowManagerService-addWindow"><a href="#5-3-1、WindowManagerService-addWindow" class="headerlink" title="5.3.1、WindowManagerService.addWindow()"></a>5.3.1、WindowManagerService.addWindow()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></span><br><span class="line"><span class="function"><span class="params">            LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId, Rect outFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</span></span></span><br><span class="line"><span class="function"><span class="params">            DisplayCutout.ParcelableWrapper outDisplayCutout, InputChannel outInputChannel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] appOp = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> reportNewConfig = <span class="keyword">false</span>;</span><br><span class="line">        WindowState parentWindow = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">long</span> origId;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> type = attrs.type;</span><br><span class="line"></span><br><span class="line">        mFocusingActivity = attrs.getTitle().toString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            .......</span><br><span class="line">            <span class="keyword">final</span> DisplayContent displayContent = getDisplayContentOrCreate(displayId);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            AppWindowToken atoken = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> hasParent = parentWindow != <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// Use existing parent window token for child windows since they go in the same token</span></span><br><span class="line">            <span class="comment">// as there parent window so we can apply the same policy on them.</span></span><br><span class="line">            WindowToken token = displayContent.getWindowToken(</span><br><span class="line">                    hasParent ? parentWindow.mAttrs.token : attrs.token);</span><br><span class="line">            <span class="comment">// If this is a child window, we want to apply the same type checking rules as the</span></span><br><span class="line">            <span class="comment">// parent window type.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> rootType = hasParent ? parentWindow.mAttrs.type : type;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> addToastWindowRequiresToken = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">                .......</span><br><span class="line">                <span class="keyword">final</span> IBinder binder = attrs.token != <span class="keyword">null</span> ? attrs.token : client.asBinder();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isRoundedCornerOverlay =</span><br><span class="line">                        (attrs.privateFlags &amp; PRIVATE_FLAG_IS_ROUNDED_CORNERS_OVERLAY) != <span class="number">0</span>;</span><br><span class="line">                token = <span class="keyword">new</span> WindowToken(<span class="keyword">this</span>, binder, type, <span class="keyword">false</span>, displayContent,</span><br><span class="line">                        session.mCanAddInternalSystemWindow, isRoundedCornerOverlay);</span><br><span class="line">            &#125; ......</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.asAppWindowToken() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_WM, <span class="string">&quot;Non-null appWindowToken for system window of rootType=&quot;</span> + rootType);</span><br><span class="line">                <span class="comment">// It is not valid to use an app token with other system types; we will</span></span><br><span class="line">                <span class="comment">// instead make a new token for it (as if null had been passed in for the token).</span></span><br><span class="line">                attrs.token = <span class="keyword">null</span>;</span><br><span class="line">                token = <span class="keyword">new</span> WindowToken(<span class="keyword">this</span>, client.asBinder(), type, <span class="keyword">false</span>, displayContent,</span><br><span class="line">                        session.mCanAddInternalSystemWindow);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token, parentWindow,</span><br><span class="line">                    appOp[<span class="number">0</span>], seq, attrs, viewVisibility, session.mUid,</span><br><span class="line">                    session.mCanAddInternalSystemWindow);</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> hasStatusBarServicePermission =</span><br><span class="line">                    mContext.checkCallingOrSelfPermission(permission.STATUS_BAR_SERVICE)</span><br><span class="line">                            == PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            mPolicy.adjustWindowParamsLw(win, win.mAttrs, hasStatusBarServicePermission);</span><br><span class="line">            win.setShowToOwnerOnlyLocked(mPolicy.checkShowToOwnerOnly(attrs));</span><br><span class="line"></span><br><span class="line">            res = mPolicy.prepareAddWindowLw(win, attrs);</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> openInputChannels = (outInputChannel != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (attrs.inputFeatures &amp; INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>  (openInputChannels) &#123;</span><br><span class="line">                win.openInputChannel(outInputChannel);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            res = WindowManagerGlobal.ADD_OKAY;</span><br><span class="line">            ......</span><br><span class="line">            origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            win.attach();</span><br><span class="line">            <span class="comment">//将win加入到mWindowMap中</span></span><br><span class="line">            mWindowMap.put(client.asBinder(), win);</span><br><span class="line"></span><br><span class="line">            win.initAppOpsState();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> suspended = mPmInternal.isPackageSuspended(win.getOwningPackage(),</span><br><span class="line">                    UserHandle.getUserId(win.getOwningUid()));</span><br><span class="line">            win.setHiddenWhileSuspended(suspended);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> hideSystemAlertWindows = !mHidingNonSystemOverlayWindows.isEmpty();</span><br><span class="line">            win.setForceHideNonSystemOverlayWindowIfNeeded(hideSystemAlertWindows);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> AppWindowToken aToken = token.asAppWindowToken();</span><br><span class="line">            <span class="keyword">if</span> (type == TYPE_APPLICATION_STARTING &amp;&amp; aToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                aToken.startingWindow = win;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STARTING_WINDOW) Slog.v (TAG_WM, <span class="string">&quot;addWindow: &quot;</span> + aToken</span><br><span class="line">                        + <span class="string">&quot; startingWindow=&quot;</span> + win);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> imMayMove = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//将win加入到mToken中</span></span><br><span class="line">            win.mToken.addWindow(win);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == TYPE_INPUT_METHOD) &#123;</span><br><span class="line">                win.mGivenInsetsPending = <span class="keyword">true</span>;</span><br><span class="line">                setInputMethodWindowLocked(win);</span><br><span class="line">                imMayMove = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TYPE_INPUT_METHOD_DIALOG) &#123;</span><br><span class="line">                displayContent.computeImeTarget(<span class="keyword">true</span> <span class="comment">/* updateImeTarget */</span>);</span><br><span class="line">                imMayMove = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (type == TYPE_WALLPAPER) &#123;</span><br><span class="line">                    displayContent.mWallpaperController.clearLastWallpaperTimeoutTime();</span><br><span class="line">                    displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((attrs.flags&amp;FLAG_SHOW_WALLPAPER) != <span class="number">0</span>) &#123;</span><br><span class="line">                    displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (displayContent.mWallpaperController.isBelowWallpaperTarget(win)) &#123;</span><br><span class="line">                    <span class="comment">// If there is currently a wallpaper being shown, and</span></span><br><span class="line">                    <span class="comment">// the base layer of the new window is below the current</span></span><br><span class="line">                    <span class="comment">// layer of the target window, then adjust the wallpaper.</span></span><br><span class="line">                    <span class="comment">// This is to avoid a new window being placed between the</span></span><br><span class="line">                    <span class="comment">// wallpaper and its target.</span></span><br><span class="line">                    displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the window is being added to a stack that&#x27;s currently adjusted for IME,</span></span><br><span class="line">            <span class="comment">// make sure to apply the same adjust to this new window.</span></span><br><span class="line">            win.applyAdjustForImeIfNeeded();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == TYPE_DOCK_DIVIDER) &#123;</span><br><span class="line">                mRoot.getDisplayContent(displayId).getDockedDividerController().setWindow(win);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> WindowStateAnimator winAnimator = win.mWinAnimator;</span><br><span class="line">            winAnimator.mEnterAnimationPending = <span class="keyword">true</span>;</span><br><span class="line">            winAnimator.mEnteringAnimation = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// Check if we need to prepare a transition for replacing window first.</span></span><br><span class="line">            <span class="keyword">if</span> (atoken != <span class="keyword">null</span> &amp;&amp; atoken.isVisible()</span><br><span class="line">                    &amp;&amp; !prepareWindowReplacementTransition(atoken)) &#123;</span><br><span class="line">                <span class="comment">// If not, check if need to set up a dummy transition during display freeze</span></span><br><span class="line">                <span class="comment">// so that the unfreeze wait for the apps to draw. This might be needed if</span></span><br><span class="line">                <span class="comment">// the app is relaunching.</span></span><br><span class="line">                prepareNoneTransitionForRelaunching(atoken);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> DisplayFrames displayFrames = displayContent.mDisplayFrames;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Not sure if onDisplayInfoUpdated() call is needed.</span></span><br><span class="line">            <span class="keyword">final</span> DisplayInfo displayInfo = displayContent.getDisplayInfo();</span><br><span class="line">            displayFrames.onDisplayInfoUpdated(displayInfo,</span><br><span class="line">                    displayContent.calculateDisplayCutoutForRotation(displayInfo.rotation));</span><br><span class="line">            <span class="keyword">final</span> Rect taskBounds;</span><br><span class="line">            <span class="keyword">if</span> (atoken != <span class="keyword">null</span> &amp;&amp; atoken.getTask() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                taskBounds = mTmpRect;</span><br><span class="line">                atoken.getTask().getBounds(mTmpRect);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                taskBounds = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPolicy.getLayoutHintLw(win.mAttrs, taskBounds, displayFrames, outFrame,</span><br><span class="line">                    outContentInsets, outStableInsets, outOutsets, outDisplayCutout)) &#123;</span><br><span class="line">                res |= WindowManagerGlobal.ADD_FLAG_ALWAYS_CONSUME_NAV_BAR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mInTouchMode) &#123;</span><br><span class="line">                res |= WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (win.mAppToken == <span class="keyword">null</span> || !win.mAppToken.isClientHidden()) &#123;</span><br><span class="line">                res |= WindowManagerGlobal.ADD_FLAG_APP_VISIBLE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> focusChanged = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (win.canReceiveKeys()) &#123;</span><br><span class="line">                focusChanged = updateFocusedWindowLocked(UPDATE_FOCUS_WILL_ASSIGN_LAYERS,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</span><br><span class="line">                <span class="keyword">if</span> (focusChanged) &#123;</span><br><span class="line">                    imMayMove = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (imMayMove) &#123;</span><br><span class="line">                displayContent.computeImeTarget(<span class="keyword">true</span> <span class="comment">/* updateImeTarget */</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Don&#x27;t do layout here, the window must call</span></span><br><span class="line">            <span class="comment">// relayout to be displayed, so we&#x27;ll do it there.</span></span><br><span class="line">            win.getParent().assignChildLayers();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (focusChanged) &#123;</span><br><span class="line">                mInputMonitor.setInputFocusLw(mCurrentFocus, <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</span><br><span class="line">            &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.967</span> D/WindowManager( <span class="number">1049</span>): addInputWindowHandle: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;, Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;, layer=<span class="number">0</span>, frame=[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>], touchableRegion=SkRegion((<span class="number">0</span>,<span class="number">0</span>,<span class="number">480</span>,<span class="number">854</span>)), visible=<span class="keyword">false</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">            mInputMonitor.updateInputWindowsLw(<span class="keyword">false</span> <span class="comment">/*force*/</span>);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.968</span> V/WindowManager( <span class="number">1049</span>): addWindow: New client android.os.BinderProxy<span class="meta">@b9baf64</span>: window=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; Callers=com.android.server.wm.Session.addToDisplay:<span class="number">205</span> android.view.IWindowSession$Stub.onTransact:<span class="number">129</span> com.android.server.wm.Session.onTransact:<span class="number">164</span> android.os.Binder.execTransact:<span class="number">731</span> &lt;bottom of call stack&gt; </span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (localLOGV || DEBUG_ADD_REMOVE) Slog.v(TAG_WM, <span class="string">&quot;addWindow: New client &quot;</span></span><br><span class="line">                    + client.asBinder() + <span class="string">&quot;: window=&quot;</span> + win + <span class="string">&quot; Callers=&quot;</span> + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (win.isVisibleOrAdding() &amp;&amp; updateOrientationFromAppTokensLocked(displayId)) &#123;</span><br><span class="line">                reportNewConfig = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reportNewConfig) &#123;</span><br><span class="line">            sendNewConfiguration(displayId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="5-3-1-1、WindowState创建"><a href="#5-3-1-1、WindowState创建" class="headerlink" title="5.3.1.1、WindowState创建"></a>5.3.1.1、WindowState创建</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowState.java</span><br><span class="line"></span><br><span class="line">    WindowState(WindowManagerService service, Session s, IWindow c, WindowToken token,</span><br><span class="line">            WindowState parentWindow, <span class="keyword">int</span> appOp, <span class="keyword">int</span> seq, WindowManager.LayoutParams a,</span><br><span class="line">            <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> ownerId, <span class="keyword">boolean</span> ownerCanAddInternalSystemWindow,</span><br><span class="line">            PowerManagerWrapper powerManagerWrapper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(service);</span><br><span class="line">        mSession = s;</span><br><span class="line">        mClient = c;</span><br><span class="line">        mAppOp = appOp;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mAppToken = mToken.asAppWindowToken();</span><br><span class="line">        mOwnerUid = ownerId;</span><br><span class="line">        mOwnerCanAddInternalSystemWindow = ownerCanAddInternalSystemWindow;</span><br><span class="line">        mWindowId = <span class="keyword">new</span> WindowId(<span class="keyword">this</span>);</span><br><span class="line">        mAttrs.copyFrom(a);</span><br><span class="line">        mLastSurfaceInsets.set(mAttrs.surfaceInsets);</span><br><span class="line">        mViewVisibility = viewVisibility;</span><br><span class="line">        mPolicy = mService.mPolicy;</span><br><span class="line">        mContext = mService.mContext;</span><br><span class="line">        DeathRecipient deathRecipient = <span class="keyword">new</span> DeathRecipient();</span><br><span class="line">        mSeq = seq;</span><br><span class="line">        mEnforceSizeCompat = (mAttrs.privateFlags &amp; PRIVATE_FLAG_COMPATIBLE_WINDOW) != <span class="number">0</span>;</span><br><span class="line">        mPowerManagerWrapper = powerManagerWrapper;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.964</span> V/WindowState( <span class="number">1049</span>): Window Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; client=android.os.BinderProxy<span class="meta">@b9baf64</span> token=AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125; (Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;) params=&#123;(<span class="number">0</span>,<span class="number">0</span>)(fillxfill) sim=&#123;forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.964</span> V/WindowState( <span class="number">1049</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;Window &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; client=&quot;</span> + c.asBinder()</span><br><span class="line">            + <span class="string">&quot; token=&quot;</span> + token + <span class="string">&quot; (&quot;</span> + mAttrs.token + <span class="string">&quot;)&quot;</span> + <span class="string">&quot; params=&quot;</span> + a);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c.asBinder().linkToDeath(deathRecipient, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            mDeathRecipient = <span class="keyword">null</span>;</span><br><span class="line">            mIsChildWindow = <span class="keyword">false</span>;</span><br><span class="line">            mLayoutAttached = <span class="keyword">false</span>;</span><br><span class="line">            mIsImWindow = <span class="keyword">false</span>;</span><br><span class="line">            mIsWallpaper = <span class="keyword">false</span>;</span><br><span class="line">            mIsFloatingLayer = <span class="keyword">false</span>;</span><br><span class="line">            mBaseLayer = <span class="number">0</span>;</span><br><span class="line">            mSubLayer = <span class="number">0</span>;</span><br><span class="line">            mInputWindowHandle = <span class="keyword">null</span>;</span><br><span class="line">            mWinAnimator = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDeathRecipient = deathRecipient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//charlesvincent start</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;com.android.testred&quot;</span>.equals(mAttrs.packageName) </span><br><span class="line">            || <span class="string">&quot;com.android.testgreen&quot;</span>.equals(mAttrs.packageName)</span><br><span class="line">            || <span class="string">&quot;com.android.testblue&quot;</span>.equals(mAttrs.packageName))&#123;</span><br><span class="line">            mBaseLayer = <span class="number">21010</span>;</span><br><span class="line">            mSubLayer = <span class="number">0</span>;</span><br><span class="line">            mIsChildWindow = <span class="keyword">false</span>;</span><br><span class="line">            mLayoutAttached = <span class="keyword">false</span>;</span><br><span class="line">            mIsImWindow = mAttrs.type == TYPE_INPUT_METHOD</span><br><span class="line">                    || mAttrs.type == TYPE_INPUT_METHOD_DIALOG;</span><br><span class="line">            mIsWallpaper = mAttrs.type == TYPE_WALLPAPER;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mAttrs.type &gt;= FIRST_SUB_WINDOW &amp;&amp; mAttrs.type &lt;= LAST_SUB_WINDOW) &#123;</span><br><span class="line">                <span class="comment">// The multiplier here is to reserve space for multiple</span></span><br><span class="line">                <span class="comment">// windows in the same type layer.</span></span><br><span class="line">                mBaseLayer = mPolicy.getWindowLayerLw(parentWindow)</span><br><span class="line">                        * TYPE_LAYER_MULTIPLIER + TYPE_LAYER_OFFSET;</span><br><span class="line">                mSubLayer = mPolicy.getSubWindowLayerFromTypeLw(a.type);</span><br><span class="line">                mIsChildWindow = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.v(TAG, <span class="string">&quot;Adding &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; to &quot;</span> + parentWindow);</span><br><span class="line">                parentWindow.addChild(<span class="keyword">this</span>, sWindowSubLayerComparator);</span><br><span class="line"></span><br><span class="line">                mLayoutAttached = mAttrs.type !=</span><br><span class="line">                        WindowManager.LayoutParams.TYPE_APPLICATION_ATTACHED_DIALOG;</span><br><span class="line">                mIsImWindow = parentWindow.mAttrs.type == TYPE_INPUT_METHOD</span><br><span class="line">                        || parentWindow.mAttrs.type == TYPE_INPUT_METHOD_DIALOG;</span><br><span class="line">                mIsWallpaper = parentWindow.mAttrs.type == TYPE_WALLPAPER;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The multiplier here is to reserve space for multiple</span></span><br><span class="line">                <span class="comment">// windows in the same type layer.</span></span><br><span class="line">                mBaseLayer = mPolicy.getWindowLayerLw(<span class="keyword">this</span>)</span><br><span class="line">                        * TYPE_LAYER_MULTIPLIER + TYPE_LAYER_OFFSET;</span><br><span class="line">                mSubLayer = <span class="number">0</span>;</span><br><span class="line">                mIsChildWindow = <span class="keyword">false</span>;</span><br><span class="line">                mLayoutAttached = <span class="keyword">false</span>;</span><br><span class="line">                mIsImWindow = mAttrs.type == TYPE_INPUT_METHOD</span><br><span class="line">                        || mAttrs.type == TYPE_INPUT_METHOD_DIALOG;</span><br><span class="line">                mIsWallpaper = mAttrs.type == TYPE_WALLPAPER;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//charlesvincent end</span></span><br><span class="line"></span><br><span class="line">        mIsFloatingLayer = mIsImWindow || mIsWallpaper;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAppToken != <span class="keyword">null</span> &amp;&amp; mAppToken.mShowForAllUsers) &#123;</span><br><span class="line">            <span class="comment">// Windows for apps that can show for all users should also show when the device is</span></span><br><span class="line">            <span class="comment">// locked.</span></span><br><span class="line">            mAttrs.flags |= FLAG_SHOW_WHEN_LOCKED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建WindowStateAnimator</span></span><br><span class="line">        mWinAnimator = <span class="keyword">new</span> WindowStateAnimator(<span class="keyword">this</span>);</span><br><span class="line">        mWinAnimator.mAlpha = a.alpha;</span><br><span class="line"></span><br><span class="line">        mRequestedWidth = <span class="number">0</span>;</span><br><span class="line">        mRequestedHeight = <span class="number">0</span>;</span><br><span class="line">        mLastRequestedWidth = <span class="number">0</span>;</span><br><span class="line">        mLastRequestedHeight = <span class="number">0</span>;</span><br><span class="line">        mLayer = <span class="number">0</span>;</span><br><span class="line">        mInputWindowHandle = <span class="keyword">new</span> InputWindowHandle(</span><br><span class="line">                mAppToken != <span class="keyword">null</span> ? mAppToken.mInputApplicationHandle : <span class="keyword">null</span>, <span class="keyword">this</span>, c,</span><br><span class="line">                    getDisplayId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="5-3-1-2、WindowState-attach"><a href="#5-3-1-2、WindowState-attach" class="headerlink" title="5.3.1.2、WindowState.attach()"></a>5.3.1.2、WindowState.attach()</h6><p>在WMS服务端创建了所需对象后，接着调用了WindowState的attach()来进一步完成窗口添加。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowState.java</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.964</span> V/WindowState( <span class="number">1049</span>): Attaching Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; token=AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Attaching &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; token=&quot;</span> + mToken);</span><br><span class="line">        mSession.windowAddedLocked(mAttrs.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="5-3-1-3、mSession-windowAddedLocked-mAttrs-packageName"><a href="#5-3-1-3、mSession-windowAddedLocked-mAttrs-packageName" class="headerlink" title="5.3.1.3、mSession.windowAddedLocked(mAttrs.packageName)"></a>5.3.1.3、mSession.windowAddedLocked(mAttrs.packageName)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\Session.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">windowAddedLocked</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        mRelayoutTag = <span class="string">&quot;relayoutWindow: &quot;</span> + mPackageName;</span><br><span class="line">        <span class="keyword">if</span> (mSurfaceSession == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.964</span> V/WindowManager( <span class="number">1049</span>): First window added to Session&#123;e6e78f6 <span class="number">2602</span>:u0a10088&#125;, creating SurfaceSession</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.965</span> I/WindowManager( <span class="number">1049</span>):   NEW SURFACE SESSION android.view.SurfaceSession@<span class="number">3812e82</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">                TAG_WM, <span class="string">&quot;First window added to &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;, creating SurfaceSession&quot;</span>);</span><br><span class="line">            mSurfaceSession = <span class="keyword">new</span> SurfaceSession();</span><br><span class="line">            <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(</span><br><span class="line">                    TAG_WM, <span class="string">&quot;  NEW SURFACE SESSION &quot;</span> + mSurfaceSession);</span><br><span class="line">            mService.mSessions.add(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) &#123;</span><br><span class="line">                mService.dispatchNewAnimatorScaleLocked(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mNumWindow++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="5-3-1-4、SurfaceSession建立过程"><a href="#5-3-1-4、SurfaceSession建立过程" class="headerlink" title="5.3.1.4、SurfaceSession建立过程"></a>5.3.1.4、SurfaceSession建立过程</h6><p>SurfaceSession对象承担了应用程序与SurfaceFlinger之间的通信过程，每一个需要与SurfaceFlinger进程交互的应用程序端都需要创建一个SurfaceSession对象。</p>
<p>客户端请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\SurfaceSession.java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An instance of this class represents a connection to the surface</span></span><br><span class="line"><span class="comment"> * flinger, from which you can create one or more Surface instances that will</span></span><br><span class="line"><span class="comment"> * be composited to the screen.</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SurfaceSession</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Note: This field is accessed by native code.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mNativeClient; <span class="comment">// SurfaceComposerClient*</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Create a new connection with the surface flinger. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SurfaceSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mNativeClient = nativeCreate();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java层的SurfaceSession对象构造过程会通过JNI在native层创建一个SurfaceComposerClient对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\android_view_SurfaceSession.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz)</span> </span>&#123;</span><br><span class="line">    SurfaceComposerClient* client = <span class="keyword">new</span> SurfaceComposerClient();</span><br><span class="line">    client-&gt;incStrong((<span class="keyword">void</span>*)nativeCreate);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(client);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Java层的SurfaceSession对象与C++层的SurfaceComposerClient对象之间是一对一关系。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\SurfaceComposerClient.cpp</span><br><span class="line"></span><br><span class="line">SurfaceComposerClient::SurfaceComposerClient()</span><br><span class="line">    : mStatus(NO_INIT)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SurfaceComposerClient::onFirstRef</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">sp&lt;ISurfaceComposer&gt; <span class="title">sf</span><span class="params">(ComposerService::getComposerService())</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (sf != <span class="number">0</span> &amp;&amp; mStatus == NO_INIT) &#123;</span><br><span class="line">        <span class="keyword">auto</span> rootProducer = mParent.promote();</span><br><span class="line">        sp&lt;ISurfaceComposerClient&gt; conn;</span><br><span class="line">        conn = (rootProducer != <span class="literal">nullptr</span>) ? sf-&gt;createScopedConnection(rootProducer) :</span><br><span class="line">                sf-&gt;createConnection();</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="number">0</span>) &#123;</span><br><span class="line">            mClient = conn;</span><br><span class="line">            mStatus = NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SurfaceComposerClient继承于RefBase类，当第一次被强引用时，onFirstRef函数被回调，在该函数中SurfaceComposerClient会请求SurfaceFlinger为当前应用程序创建一个Client对象，专门接收该应用程序的请求，在SurfaceFlinger端创建好Client本地Binder对象后，将该Binder代理对象返回给应用程序端，并保存在SurfaceComposerClient的成员变量mClient中。</p>
<p>服务端处理 在SurfaceFlinger服务端为应用程序创建交互的Client对象 [SurfaceFlinger.cpp]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\SurfaceFlinger.cpp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;ISurfaceComposerClient&gt; <span class="title">SurfaceFlinger::createConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> initClient(<span class="keyword">new</span> Client(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;ISurfaceComposerClient&gt; <span class="title">SurfaceFlinger::createScopedConnection</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; gbp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (authenticateSurfaceTexture(gbp) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; layer = (<span class="keyword">static_cast</span>&lt;MonitoredProducer*&gt;(gbp.get()))-&gt;getLayer();</span><br><span class="line">    <span class="keyword">if</span> (layer == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> initClient(<span class="keyword">new</span> Client(<span class="keyword">this</span>, layer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.SurfaceFlinger-Create-Layer.png" alt="enter image description here"> </p>
<h6 id="5-3-1-5、win-mToken-addWindow-win"><a href="#5-3-1-5、win-mToken-addWindow-win" class="headerlink" title="5.3.1.5、win.mToken.addWindow(win)"></a>5.3.1.5、win.mToken.addWindow(win)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowToken.java</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.965</span> D/WindowManager( <span class="number">1049</span>): addWindow: win=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; Callers=com.android.server.wm.AppWindowToken.addWindow:<span class="number">989</span> com.android.server.wm.WindowManagerService.addWindow:<span class="number">1426</span> com.android.server.wm.Session.addToDisplay:<span class="number">205</span> android.view.IWindowSession$Stub.onTransact:<span class="number">129</span> com.android.server.wm.Session.onTransact:<span class="number">164</span> </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.965</span> V/WindowManager( <span class="number">1049</span>): Adding Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; to AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addWindow</span><span class="params">(<span class="keyword">final</span> WindowState win)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FOCUS) Slog.d(TAG_WM,</span><br><span class="line">                <span class="string">&quot;addWindow: win=&quot;</span> + win + <span class="string">&quot; Callers=&quot;</span> + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (win.isChildWindow()) &#123;</span><br><span class="line">            <span class="comment">// Child windows are added to their parent windows.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!mChildren.contains(win)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.v(TAG_WM, <span class="string">&quot;Adding &quot;</span> + win + <span class="string">&quot; to &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">            addChild(win, mWindowComparator);</span><br><span class="line">            mService.mWindowsChanged = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Should we also be setting layout needed here and other places?</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Vsync-start"><a href="#Vsync-start" class="headerlink" title="/**Vsync start******/"></a>/<strong><strong><strong>**</strong></strong></strong>Vsync start**<strong><strong>****</strong></strong>/</h2><h4 id="（二）、Vsync-trigger"><a href="#（二）、Vsync-trigger" class="headerlink" title="（二）、Vsync trigger"></a>（二）、Vsync trigger</h4><p>#####（1）、DisplayEventReceiver::sendEvents</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\EventThread.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventThread::threadMain</span><span class="params">()</span> NO_THREAD_SAFETY_ANALYSIS </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (mKeepRunning) &#123;</span><br><span class="line">        DisplayEventReceiver::Event event;</span><br><span class="line">        Vector&lt;sp&lt;EventThread::Connection&gt; &gt; signalConnections;</span><br><span class="line">        signalConnections = waitForEventLocked(&amp;lock, &amp;event);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// dispatch events to listeners...</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> count = signalConnections.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">const</span> sp&lt;Connection&gt;&amp; <span class="title">conn</span><span class="params">(signalConnections[i])</span></span>;</span><br><span class="line">            <span class="comment">// now see if we still need to report this event</span></span><br><span class="line">            <span class="keyword">status_t</span> err = conn-&gt;postEvent(event);</span><br><span class="line">            <span class="keyword">if</span> (err == -EAGAIN || err == -EWOULDBLOCK) &#123;</span><br><span class="line">                <span class="comment">// The destination doesn&#x27;t accept events anymore, it&#x27;s probably</span></span><br><span class="line">                <span class="comment">// full. For now, we just drop the events on the floor.</span></span><br><span class="line">                <span class="comment">// <span class="doctag">FIXME:</span> Note that some events cannot be dropped and would have</span></span><br><span class="line">                <span class="comment">// to be re-sent later.</span></span><br><span class="line">                <span class="comment">// Right-now we don&#x27;t have the ability to do this.</span></span><br><span class="line">                ALOGW(<span class="string">&quot;EventThread: dropping event (%08x) for connection %p&quot;</span>, event.header.type,</span><br><span class="line">                      conn.get());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// handle any other error on the pipe as fatal. the only</span></span><br><span class="line">                <span class="comment">// reasonable thing to do is to clean-up this connection.</span></span><br><span class="line">                <span class="comment">// The most common error we&#x27;ll get here is -EPIPE.</span></span><br><span class="line">                removeDisplayEventConnectionLocked(signalConnections[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">status_t</span> EventThread::Connection::postEvent(<span class="keyword">const</span> DisplayEventReceiver::Event&amp; event) &#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> size = DisplayEventReceiver::sendEvents(&amp;mChannel, &amp;event, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? <span class="keyword">status_t</span>(size) : <span class="keyword">status_t</span>(NO_ERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当有Vsync信号来到时，会调用conn-&gt;postEvent(event)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\DisplayEventReceiver.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">DisplayEventReceiver::sendEvents</span><span class="params">(gui::BitTube* dataChannel,</span></span></span><br><span class="line"><span class="function"><span class="params">        Event <span class="keyword">const</span>* events, <span class="keyword">size_t</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gui::BitTube::sendObjects(dataChannel, events, count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\sensor\BitTube.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">BitTube::sendObjects</span><span class="params">(<span class="keyword">const</span> sp&lt;BitTube&gt;&amp; tube,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">void</span> <span class="keyword">const</span>* events, <span class="keyword">size_t</span> count, <span class="keyword">size_t</span> objSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* vaddr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt;(events);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = tube-&gt;write(vaddr, count*objSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// should never happen because of SOCK_SEQPACKET</span></span><br><span class="line">    LOG_ALWAYS_FATAL_IF((size &gt;= <span class="number">0</span>) &amp;&amp; (size % <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize)),</span><br><span class="line">            <span class="string">&quot;BitTube::sendObjects(count=%zu, size=%zu), res=%zd (partial events were sent!)&quot;</span>,</span><br><span class="line">            count, objSize, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ALOGE_IF(size&lt;0, &quot;error %d sending %d events&quot;, size, count);</span></span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? size : size / <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">BitTube::write</span><span class="params">(<span class="keyword">void</span> <span class="keyword">const</span>* vaddr, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> err, len;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = ::send(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL);</span><br><span class="line">        <span class="comment">// cannot return less than size, since we&#x27;re using SOCK_SEQPACKET</span></span><br><span class="line">        err = len &lt; <span class="number">0</span> ? errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == EINTR);</span><br><span class="line">    <span class="keyword">return</span> err == <span class="number">0</span> ? len : -err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从BitTube的初始化函数可以看出使用了套接来通讯</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\sensor\BitTube.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BitTube::init</span><span class="params">(<span class="keyword">size_t</span> rcvbuf, <span class="keyword">size_t</span> sndbuf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_SEQPACKET, <span class="number">0</span>, sockets) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> size = DEFAULT_SOCKET_BUFFER_SIZE;</span><br><span class="line">        setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;rcvbuf, <span class="keyword">sizeof</span>(rcvbuf));</span><br><span class="line">        setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;sndbuf, <span class="keyword">sizeof</span>(sndbuf));</span><br><span class="line">        <span class="comment">// sine we don&#x27;t use the &quot;return channel&quot;, we keep it small...</span></span><br><span class="line">        setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;size, <span class="keyword">sizeof</span>(size));</span><br><span class="line">        setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;size, <span class="keyword">sizeof</span>(size));</span><br><span class="line">        fcntl(sockets[<span class="number">0</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        fcntl(sockets[<span class="number">1</span>], F_SETFL, O_NONBLOCK);</span><br><span class="line">        mReceiveFd = sockets[<span class="number">0</span>];</span><br><span class="line">        mSendFd = sockets[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mReceiveFd = -errno;</span><br><span class="line">        ALOGE(<span class="string">&quot;BitTube: pipe creation failed (%s)&quot;</span>, strerror(-mReceiveFd));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\sensor\BitTube.cpp</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">BitTube::recvObjects</span><span class="params">(BitTube* tube, <span class="keyword">void</span>* events, <span class="keyword">size_t</span> count, <span class="keyword">size_t</span> objSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* vaddr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span>*&gt;(events);</span><br><span class="line">    <span class="keyword">ssize_t</span> size = tube-&gt;read(vaddr, count * objSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// should never happen because of SOCK_SEQPACKET</span></span><br><span class="line">    LOG_ALWAYS_FATAL_IF((size &gt;= <span class="number">0</span>) &amp;&amp; (size % <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize)),</span><br><span class="line">                        <span class="string">&quot;BitTube::recvObjects(count=%zu, size=%zu), res=%zd (partial events were &quot;</span></span><br><span class="line">                        <span class="string">&quot;received!)&quot;</span>,</span><br><span class="line">                        count, objSize, size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ALOGE_IF(size&lt;0, &quot;error %d receiving %d events&quot;, size, count);</span></span><br><span class="line">    <span class="keyword">return</span> size &lt; <span class="number">0</span> ? size : size / <span class="keyword">static_cast</span>&lt;<span class="keyword">ssize_t</span>&gt;(objSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\sensor\BitTube.cpp</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">BitTube::read</span><span class="params">(<span class="keyword">void</span>* vaddr, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> err, len;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        len = ::recv(mReceiveFd, vaddr, size, MSG_DONTWAIT);</span><br><span class="line">        err = len &lt; <span class="number">0</span> ? errno : <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (err == EINTR);</span><br><span class="line">    <span class="keyword">if</span> (err == EAGAIN || err == EWOULDBLOCK) &#123;</span><br><span class="line">        <span class="comment">// EAGAIN means that we have non-blocking I/O but there was no data to be read. Nothing the</span></span><br><span class="line">        <span class="comment">// client should care about.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err == <span class="number">0</span> ? len : -err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#####（2）、DisplayEventDispatcher::handleEvent</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\libs\androidfw\DisplayEventDispatcher.cpp</span><br><span class="line"></span><br><span class="line">DisplayEventDispatcher::DisplayEventDispatcher(<span class="keyword">const</span> sp&lt;Looper&gt;&amp; looper,</span><br><span class="line">        ISurfaceComposer::VsyncSource vsyncSource) :</span><br><span class="line">        mLooper(looper), mReceiver(vsyncSource), mWaitingForVsync(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;dispatcher %p ~ Initializing display event dispatcher.&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">DisplayEventDispatcher::initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">status_t</span> result = mReceiver.initCheck();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;Failed to initialize display event receiver, status=%d&quot;</span>, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rc = mLooper-&gt;addFd(mReceiver.getFd(), <span class="number">0</span>, Looper::EVENT_INPUT,</span><br><span class="line">            <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而最终在addFd中注册的回调时this，这个我们之前在分析Looper的时候分析过，也就是会调用这个类的handleEvent函数,在这个函数中调用dispatchVsync继续分发VSync信号。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\libs\androidfw\DisplayEventDispatcher.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DisplayEventDispatcher::handleEvent</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span> events, <span class="keyword">void</span>*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (events &amp; (Looper::EVENT_ERROR | Looper::EVENT_HANGUP)) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Display event receiver pipe was closed or an error occurred.  &quot;</span></span><br><span class="line">                <span class="string">&quot;events=0x%x&quot;</span>, events);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// remove the callback</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(events &amp; Looper::EVENT_INPUT)) &#123;</span><br><span class="line">        ALOGW(<span class="string">&quot;Received spurious callback for unhandled poll event.  &quot;</span></span><br><span class="line">                <span class="string">&quot;events=0x%x&quot;</span>, events);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// keep the callback</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Drain all pending events, keep the last vsync.</span></span><br><span class="line">    <span class="keyword">nsecs_t</span> vsyncTimestamp;</span><br><span class="line">    <span class="keyword">int32_t</span> vsyncDisplayId;</span><br><span class="line">    <span class="keyword">uint32_t</span> vsyncCount;</span><br><span class="line">    <span class="keyword">if</span> (processPendingEvents(&amp;vsyncTimestamp, &amp;vsyncDisplayId, &amp;vsyncCount)) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;dispatcher %p ~ Vsync pulse: timestamp=%&quot;</span> PRId64 <span class="string">&quot;, id=%d, count=%d&quot;</span>,</span><br><span class="line">                <span class="keyword">this</span>, ns2ms(vsyncTimestamp), vsyncDisplayId, vsyncCount);</span><br><span class="line">        mWaitingForVsync = <span class="literal">false</span>;</span><br><span class="line">        dispatchVsync(vsyncTimestamp, vsyncDisplayId, vsyncCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// keep the callback</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\android_view_DisplayEventReceiver.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">NativeDisplayEventReceiver::dispatchVsync</span><span class="params">(<span class="keyword">nsecs_t</span> timestamp, <span class="keyword">int32_t</span> id, <span class="keyword">uint32_t</span> count)</span> </span>&#123;</span><br><span class="line">    JNIEnv* env = AndroidRuntime::getJNIEnv();</span><br><span class="line"></span><br><span class="line">    <span class="function">ScopedLocalRef&lt;jobject&gt; <span class="title">receiverObj</span><span class="params">(env, jniGetReferent(env, mReceiverWeakGlobal))</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (receiverObj.get()) &#123;</span><br><span class="line">        ALOGV(<span class="string">&quot;receiver %p ~ Invoking vsync handler.&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        env-&gt;CallVoidMethod(receiverObj.get(),</span><br><span class="line">                gDisplayEventReceiverClassInfo.dispatchVsync, timestamp, id, count);</span><br><span class="line">        ALOGV(<span class="string">&quot;receiver %p ~ Returned from vsync handler.&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mMessageQueue-&gt;raiseAndClearException(env, <span class="string">&quot;dispatchVsync&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是利用jni反调了DisplayEventReceiver.java类的dispatchVsync函数。<br>#####（3）、DisplayEventReceiver.dispatchVsync()（Java层回调）</p>
<p>我们再来看看DisplayEventReceiver java类的dispatchVsync函数，调用了onVsync函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\DisplayEventReceiver.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchVsync</span><span class="params">(<span class="keyword">long</span> timestampNanos, <span class="keyword">int</span> builtInDisplayId, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">    onVsync(timestampNanos, builtInDisplayId, frame);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而这个onVsync是一个空函数，具体在其子类中实现了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Choreographer.java</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameDisplayEventReceiver</span> <span class="keyword">extends</span> <span class="title">DisplayEventReceiver</span></span></span><br><span class="line"><span class="class">            <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mHavePendingVsync;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> mTimestampNanos;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mFrame;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FrameDisplayEventReceiver</span><span class="params">(Looper looper, <span class="keyword">int</span> vsyncSource)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper, vsyncSource);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVsync</span><span class="params">(<span class="keyword">long</span> timestampNanos, <span class="keyword">int</span> builtInDisplayId, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (builtInDisplayId != SurfaceControl.BUILT_IN_DISPLAY_ID_MAIN) &#123;</span><br><span class="line">                ......</span><br><span class="line">                scheduleVsync();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">long</span> now = System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (timestampNanos &gt; now) &#123;</span><br><span class="line">                ......</span><br><span class="line">                timestampNanos = now;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mHavePendingVsync) &#123;</span><br><span class="line">               ......</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mHavePendingVsync = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mTimestampNanos = timestampNanos;</span><br><span class="line">            mFrame = frame;</span><br><span class="line">            Message msg = Message.obtain(mHandler, <span class="keyword">this</span>);</span><br><span class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">            mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mHavePendingVsync = <span class="keyword">false</span>;</span><br><span class="line">            doFrame(mTimestampNanos, mFrame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Message msg = Message.obtain(mHandler, this)最终会调用run()。</p>
<p>#####（4）、 doFrame(mTimestampNanos, mFrame)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Choreographer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doFrame</span><span class="params">(<span class="keyword">long</span> frameTimeNanos, <span class="keyword">int</span> frame)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> startNanos;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">long</span> intendedFrameTimeNanos = frameTimeNanos;</span><br><span class="line">            startNanos = System.nanoTime();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jitterNanos = startNanos - frameTimeNanos;</span><br><span class="line">            <span class="keyword">if</span> (jitterNanos &gt;= mFrameIntervalNanos) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> skippedFrames = jitterNanos / mFrameIntervalNanos;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> lastFrameOffset = jitterNanos % mFrameIntervalNanos;</span><br><span class="line">                ......</span><br><span class="line">                frameTimeNanos = startNanos - lastFrameOffset;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (frameTimeNanos &lt; mLastFrameTimeNanos) &#123;</span><br><span class="line">                ......</span><br><span class="line">                scheduleVsyncLocked();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mFPSDivisor &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> timeSinceVsync = frameTimeNanos - mLastFrameTimeNanos;</span><br><span class="line">                <span class="keyword">if</span> (timeSinceVsync &lt; (mFrameIntervalNanos * mFPSDivisor) &amp;&amp; timeSinceVsync &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    scheduleVsyncLocked();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mFrameInfo.setVsync(intendedFrameTimeNanos, frameTimeNanos);</span><br><span class="line">            mFrameScheduled = <span class="keyword">false</span>;</span><br><span class="line">            mLastFrameTimeNanos = frameTimeNanos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">&quot;Choreographer#doFrame&quot;</span>);</span><br><span class="line">            AnimationUtils.lockAnimationClock(frameTimeNanos / TimeUtils.NANOS_PER_MS);</span><br><span class="line"></span><br><span class="line">            mFrameInfo.markInputHandlingStart();</span><br><span class="line">            doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">            mFrameInfo.markAnimationsStart();</span><br><span class="line">            doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">            mFrameInfo.markPerformTraversalsStart();</span><br><span class="line">            doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);</span><br><span class="line"></span><br><span class="line">            doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            AnimationUtils.unlockAnimationClock();</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">       .....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Choreographer类中分别定义了CallbackRecord、CallbackQueue内部类，CallbackQueue是一个按时间先后顺序保存CallbackRecord的单向循环链表。</p>
<p>在Choreographer中定义了三个CallbackQueue队列，用数组mCallbackQueues表示，用于分别保存CALLBACK_INPUT、CALLBACK_ANIMATION、CALLBACK_TRAVERSAL这三种类型的Callback，当调用Choreographer类的postCallback()函数时，就是往指定类型的CallbackQueue队列中通过addCallbackLocked()函数添加一个CallbackRecord项：首先构造一个CallbackRecord对象，然后按时间先后顺序插入到CallbackQueue链表中。从代码注释中，我们可以知道CALLBACK_INPUT是指输入回调，该回调优先级最高，首先得到执行，而CALLBACK_TRAVERSAL是指处理布局和绘图的回调，只有在所有异步消息都执行完后才得到执行，CALLBACK_ANIMATION是指动画回调，比CALLBACK_TRAVERSAL优先执行，从doFrame()函数中的doCallbacks调用就能印证这点。 当Vsync事件到来时，顺序执行CALLBACK_INPUT、CALLBACK_ANIMATION、CALLBACK_TRAVERSAL 和CALLBACK_COMMIT 对应CallbackQueue队列中注册的回调。</p>
<p>关于Choreographer的postCallback()用法在前面进行了详细的介绍，当Vsync事件到来时，mTraversalRunnable对象的run()函数将被调用。</p>
<p>mTraversalRunnable对象的类型为TraversalRunnable，该类实现了Runnable接口，在其run()函数中调用了doTraversal()函数来完成窗口布局。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#####（5）、 ViewRootImpl.doTraversal()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mTraversalScheduled) &#123;</span><br><span class="line">            mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">                Debug.startMethodTracing(<span class="string">&quot;ViewAncestor&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            performTraversals();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">                Debug.stopMethodTracing();</span><br><span class="line">                mProfile = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="（三）、Vsync-信号处理"><a href="#（三）、Vsync-信号处理" class="headerlink" title="（三）、Vsync 信号处理"></a>（三）、Vsync 信号处理</h4><p>performTraversals函数相当复杂，其主要实现以下几个重要步骤：</p>
<ul>
<li><p>1.执行窗口测量；</p>
</li>
<li><p>2.执行窗口注册；</p>
</li>
<li><p>3.执行窗口布局；</p>
</li>
<li><p>4.执行窗口绘图；</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// cache mView since it is used so much below...</span></span><br><span class="line">        <span class="keyword">final</span> View host = mView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.978</span> I/System.out( <span class="number">2602</span>): ======================================</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.978</span> I/System.out( <span class="number">2602</span>): performTraversals</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.978</span> D/View    ( <span class="number">2602</span>):   + DecorView@<span class="number">515e1</span>ca[TestActivity]</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.978</span> D/View    ( <span class="number">2602</span>):       frame=&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.978</span> D/View    ( <span class="number">2602</span>):       mMeasureWidth=<span class="number">0</span> mMeasureHeight=<span class="number">0</span></span><br><span class="line">view.java  ===&gt;&gt;&gt; output = mLayoutParams.debug(output);</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.991</span> D/Debug   ( <span class="number">2602</span>):       Contents of &#123;(<span class="number">0</span>,<span class="number">0</span>)(fillxfill) sim=&#123;forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.991</span> D/Debug   ( <span class="number">2602</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;:</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.991</span> D/Debug   ( <span class="number">2602</span>): ViewGroup.LayoutParams=&#123; width=match-parent, height=match-parent &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.991</span> D/Debug   ( <span class="number">2602</span>): </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.991</span> D/Debug   ( <span class="number">2602</span>): WindowManager.LayoutParams=&#123;title=com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;performTraversals&quot;</span>);</span><br><span class="line">            host.debug();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (host == <span class="keyword">null</span> || !mAdded)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        mIsInTraversal = <span class="keyword">true</span>;</span><br><span class="line">        mWillDrawSoon = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> windowSizeMayChange = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> newSurface = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> surfaceChanged = <span class="keyword">false</span>;</span><br><span class="line">        WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> viewVisibility = getHostVisibility();</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> viewUserVisibilityChanged = !mFirst &amp;&amp;</span><br><span class="line">                ((mViewVisibility == View.VISIBLE) != (viewVisibility == View.VISIBLE));</span><br><span class="line"></span><br><span class="line">        WindowManager.LayoutParams params = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mWindowAttributesChanged) &#123;</span><br><span class="line">            mWindowAttributesChanged = <span class="keyword">false</span>;</span><br><span class="line">            surfaceChanged = <span class="keyword">true</span>;</span><br><span class="line">            params = lp;</span><br><span class="line">        &#125;</span><br><span class="line">        CompatibilityInfo compatibilityInfo =</span><br><span class="line">                mDisplay.getDisplayAdjustments().getCompatibilityInfo();</span><br><span class="line">        <span class="keyword">if</span> (compatibilityInfo.supportsScreen() == mLastInCompatMode) &#123;</span><br><span class="line">            params = lp;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (mLastInCompatMode) &#123;</span><br><span class="line">                params.privateFlags &amp;= ~WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW;</span><br><span class="line">                mLastInCompatMode = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                params.privateFlags |= WindowManager.LayoutParams.PRIVATE_FLAG_COMPATIBLE_WINDOW;</span><br><span class="line">                mLastInCompatMode = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mWindowAttributesChangesFlag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        Rect frame = mWinFrame;</span><br><span class="line">        <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Configuration config = mContext.getResources().getConfiguration();</span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">                <span class="comment">// NOTE -- system code, won&#x27;t try to do compat mode.</span></span><br><span class="line">                Point size = <span class="keyword">new</span> Point();</span><br><span class="line">                mDisplay.getRealSize(size);</span><br><span class="line">                desiredWindowWidth = size.x;</span><br><span class="line">                desiredWindowHeight = size.y;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                desiredWindowWidth = mWinFrame.width();</span><br><span class="line">                desiredWindowHeight = mWinFrame.height();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// Set the layout direction if it has not been set before (inherit is the default)</span></span><br><span class="line">            <span class="keyword">if</span> (mViewLayoutDirectionInitial == View.LAYOUT_DIRECTION_INHERIT) &#123;</span><br><span class="line">                host.setLayoutDirection(config.getLayoutDirection());</span><br><span class="line">            &#125;</span><br><span class="line">            host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(<span class="keyword">true</span>);</span><br><span class="line">            dispatchApplyInsets(host);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            desiredWindowWidth = frame.width();</span><br><span class="line">            desiredWindowHeight = frame.height();</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">        <span class="keyword">boolean</span> insetsChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">        <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Resources res = mView.getContext().getResources();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">                <span class="comment">// make sure touch mode code executes by setting cached value</span></span><br><span class="line">                <span class="comment">// to opposite of the added touch mode.</span></span><br><span class="line">                mAttachInfo.mInTouchMode = !mAddedTouchMode;</span><br><span class="line">                ensureTouchModeLocally(mAddedTouchMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (!mPendingVisibleInsets.equals(mAttachInfo.mVisibleInsets)) &#123;</span><br><span class="line">                    mAttachInfo.mVisibleInsets.set(mPendingVisibleInsets);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;Visible insets changing to: &quot;</span></span><br><span class="line">                            + mAttachInfo.mVisibleInsets);</span><br><span class="line">                &#125;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT</span><br><span class="line">                        || lp.height == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">                    windowSizeMayChange = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">                        <span class="comment">// NOTE -- system code, won&#x27;t try to do compat mode.</span></span><br><span class="line">                        Point size = <span class="keyword">new</span> Point();</span><br><span class="line">                        mDisplay.getRealSize(size);</span><br><span class="line">                        desiredWindowWidth = size.x;</span><br><span class="line">                        desiredWindowHeight = size.y;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Configuration config = res.getConfiguration();</span><br><span class="line">                        desiredWindowWidth = dipToPx(config.screenWidthDp);</span><br><span class="line">                        desiredWindowHeight = dipToPx(config.screenHeightDp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line">            windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                    desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (collectViewAttributes()) &#123;</span><br><span class="line">            params = lp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mForceReportNewAttributes) &#123;</span><br><span class="line">            mAttachInfo.mForceReportNewAttributes = <span class="keyword">false</span>;</span><br><span class="line">            params = lp;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************执行窗口测量******************/</span>  </span><br><span class="line">        <span class="keyword">if</span> (mApplyInsetsRequested) &#123;</span><br><span class="line">            mApplyInsetsRequested = <span class="keyword">false</span>;</span><br><span class="line">            mLastOverscanRequested = mAttachInfo.mOverscanRequested;</span><br><span class="line">            dispatchApplyInsets(host);</span><br><span class="line">            <span class="keyword">if</span> (mLayoutRequested) &#123;</span><br><span class="line">                <span class="comment">// Short-circuit catching a new layout request here, so</span></span><br><span class="line">                <span class="comment">// we don&#x27;t need to go through two layout passes when things</span></span><br><span class="line">                <span class="comment">// change due to fitting system windows, which can happen a lot.</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.985</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Measuring DecorView@<span class="number">515e1</span>ca[TestActivity] in display <span class="number">480</span>x782...</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.988</span> I/System.out( <span class="number">2602</span>): ======================================</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.988</span> I/System.out( <span class="number">2602</span>): performTraversals -- after measure</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                windowSizeMayChange |= measureHierarchy(host, lp,</span><br><span class="line">                        mView.getContext().getResources(),</span><br><span class="line">                        desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">            <span class="comment">// Clear this now, so that if anything requests a layout in the</span></span><br><span class="line">            <span class="comment">// rest of this function we will catch it and re-run a full</span></span><br><span class="line">            <span class="comment">// layout pass.</span></span><br><span class="line">            mLayoutRequested = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> windowShouldResize ...;</span><br><span class="line">        windowShouldResize |= mDragResizing &amp;&amp; mResizeMode == RESIZE_MODE_FREEFORM;</span><br><span class="line"></span><br><span class="line">        windowShouldResize |= mActivityRelaunched;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> computesInternalInsets ...;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> insetsPending = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> relayoutResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> updatedConfiguration = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> surfaceGenerationId = mSurface.getGenerationId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isViewVisible = viewVisibility == View.VISIBLE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> windowRelayoutWasForced = mForceNextWindowRelayout;</span><br><span class="line">        <span class="keyword">if</span> (mFirst || windowShouldResize || insetsChanged ||</span><br><span class="line">                viewVisibilityChanged || params != <span class="keyword">null</span> || mForceNextWindowRelayout) &#123;</span><br><span class="line">            mForceNextWindowRelayout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isViewVisible) &#123;</span><br><span class="line">                insetsPending = computesInternalInsets &amp;&amp; (mFirst || viewVisibilityChanged);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mSurfaceHolder.mSurfaceLock.lock();</span><br><span class="line">                mDrawingAllowed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> hwInitialized = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">boolean</span> contentInsetsChanged = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">boolean</span> hadSurface = mSurface.isValid();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.995</span> I/ViewRootImpl[TestActivity]( <span class="number">2602</span>): host=w:<span class="number">480</span>, h:<span class="number">782</span>, params=&#123;(<span class="number">0</span>,<span class="number">0</span>)(fillxfill) sim=&#123;adjust=pan forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.995</span> I/ViewRootImpl[TestActivity]( <span class="number">2602</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LAYOUT) &#123;</span><br><span class="line">                    Log.i(mTag, <span class="string">&quot;host=w:&quot;</span> + host.getMeasuredWidth() + <span class="string">&quot;, h:&quot;</span> +</span><br><span class="line">                            host.getMeasuredHeight() + <span class="string">&quot;, params=&quot;</span> + params);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer.pauseSurface(mSurface)) &#123;</span><br><span class="line">                        mDirty.set(<span class="number">0</span>, <span class="number">0</span>, mWidth, mHeight);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mChoreographer.mFrameInfo.addFlags(FrameInfo.FLAG_WINDOW_LAYOUT_CHANGED);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line"> <span class="comment">/****************请求WMS服务relayout窗口******************/</span>  </span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.997</span> D/ViewRootImpl[TestActivity]( <span class="number">2602</span>): WindowLayout in layoutWindow:&#123;(<span class="number">0</span>,<span class="number">0</span>)(fillxfill) sim=&#123;adjust=pan forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.997</span> D/ViewRootImpl[TestActivity]( <span class="number">2602</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（1）、请求WMS服务relayout窗口mWindowSession-relayout"><a href="#（1）、请求WMS服务relayout窗口mWindowSession-relayout" class="headerlink" title="（1）、请求WMS服务relayout窗口mWindowSession.relayout()"></a>（1）、请求WMS服务relayout窗口mWindowSession.relayout()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(WindowManager.LayoutParams params, <span class="keyword">int</span> viewVisibility,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> insetsPending)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> appScale = mAttachInfo.mApplicationScale;</span><br><span class="line">        <span class="keyword">boolean</span> restore = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            restore = <span class="keyword">true</span>;</span><br><span class="line">            params.backup();</span><br><span class="line">            mTranslator.translateWindowLayout(params);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DBG) Log.d(mTag, <span class="string">&quot;WindowLayout in layoutWindow:&quot;</span> + params);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mOrigWindowType != params.type) &#123;</span><br><span class="line">                <span class="comment">// For compatibility with old apps, don&#x27;t crash here.</span></span><br><span class="line">                <span class="keyword">if</span> (mTargetSdkVersion &lt; Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</span><br><span class="line">                    Slog.w(mTag, <span class="string">&quot;Window type can not be changed after &quot;</span></span><br><span class="line">                            + <span class="string">&quot;the window is added; ignoring change of &quot;</span> + mView);</span><br><span class="line">                    params.type = mOrigWindowType;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> frameNumber = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (mSurface.isValid()) &#123;</span><br><span class="line">            frameNumber = mSurface.getNextFrameNumber();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//charlesvincent start</span></span><br><span class="line">        <span class="keyword">int</span> relayoutResult = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(params != <span class="keyword">null</span> )&#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="string">&quot;com.android.testred&quot;</span>.equals(params.packageName) </span><br><span class="line">                || <span class="string">&quot;com.android.testgreen&quot;</span>.equals(params.packageName)</span><br><span class="line">                || <span class="string">&quot;com.android.testblue&quot;</span>.equals(params.packageName))&#123;</span><br><span class="line">                Point size = <span class="keyword">new</span> Point();</span><br><span class="line">                mDisplay.getRealSize(size);</span><br><span class="line">                params.width = (<span class="keyword">int</span>) size.x / <span class="number">3</span>;</span><br><span class="line">                params.height = (<span class="keyword">int</span>) size.y;</span><br><span class="line"></span><br><span class="line">                relayoutResult = mWindowSession.relayout(mWindow, mSeq, params,</span><br><span class="line">                (<span class="keyword">int</span>) size.x / <span class="number">3</span>,</span><br><span class="line">                (<span class="keyword">int</span>) size.y, viewVisibility,</span><br><span class="line">                insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>, frameNumber,</span><br><span class="line">                mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">                mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingDisplayCutout,</span><br><span class="line">                mPendingMergedConfiguration, mSurface);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                relayoutResult = mWindowSession.relayout(mWindow, mSeq, params,</span><br><span class="line">                (<span class="keyword">int</span>) (mView.getMeasuredWidth() * appScale + <span class="number">0.5f</span>),</span><br><span class="line">                (<span class="keyword">int</span>) (mView.getMeasuredHeight() * appScale + <span class="number">0.5f</span>), viewVisibility,</span><br><span class="line">                insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="number">0</span>, frameNumber,</span><br><span class="line">                mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</span><br><span class="line">                mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingDisplayCutout,</span><br><span class="line">                mPendingMergedConfiguration, mSurface);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//charlesvincent end</span></span><br><span class="line">        mPendingAlwaysConsumeNavBar =</span><br><span class="line">                (relayoutResult &amp; WindowManagerGlobal.RELAYOUT_RES_CONSUME_ALWAYS_NAV_BAR) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (restore) &#123;</span><br><span class="line">            params.restore();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTranslator.translateRectInScreenToAppWinFrame(mWinFrame);</span><br><span class="line">            mTranslator.translateRectInScreenToAppWindow(mPendingOverscanInsets);</span><br><span class="line">            mTranslator.translateRectInScreenToAppWindow(mPendingContentInsets);</span><br><span class="line">            mTranslator.translateRectInScreenToAppWindow(mPendingVisibleInsets);</span><br><span class="line">            mTranslator.translateRectInScreenToAppWindow(mPendingStableInsets);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> relayoutResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里通过前面获取的IWindowSession代理对象请求WMS服务执行窗口布局，mSurface是ViewRootImpl的成员变量 [-&gt;ViewRootImpl.java]</p>
<p>该Surface构造函数仅仅创建了一个空Surface对象，并没有对该Surface进程native层的初始化，到此我们知道应用程序进程为每个窗口对象都创建了一个Surface对象。并且将该Surface通过跨进程方式传输给WMS服务进程，我们知道，在Android系统中，如果一个对象需要在不同进程间传输，必须实现Parcelable接口，Surface类正好实现了Parcelable接口。ViewRootImpl通过IWindowSession接口请求WMS的完整过程如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">Android <span class="number">9.0</span>已改变没有直接提供Java源码，而是.class文件打包为classes-header.jar和classes.jar。</span><br><span class="line">android\out\target\common\obj\JAVA_LIBRARIES\framework_intermediates\</span><br><span class="line">classes-header.jar</span><br><span class="line">classes.jar解压：</span><br><span class="line">classes/android/view/</span><br><span class="line">    IWindowSession.class</span><br><span class="line">    IWindowSession$Stub.class</span><br><span class="line">    IWindowSession$Stub$Proxy.class</span><br><span class="line"></span><br><span class="line">[解压后在线反编译](http:<span class="comment">//www.javadecompilers.com/)</span></span><br><span class="line">or</span><br><span class="line">[解压后在线反编译](http:<span class="comment">//javare.cn/)</span></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">IWindowSession.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IWindowSession</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;</span><br><span class="line">  ......</span><br><span class="line">   <span class="function"><span class="keyword">int</span> <span class="title">addToDisplay</span><span class="params">(IWindow var1, <span class="keyword">int</span> var2, LayoutParams var3, <span class="keyword">int</span> var4, <span class="keyword">int</span> var5, Rect var6, Rect var7, Rect var8, Rect var9, ParcelableWrapper var10, InputChannel var11)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow var1, <span class="keyword">int</span> var2, LayoutParams var3, <span class="keyword">int</span> var4, <span class="keyword">int</span> var5, <span class="keyword">int</span> var6, <span class="keyword">int</span> var7, <span class="keyword">long</span> var8, Rect var10, Rect var11, Rect var12, Rect var13, Rect var14, Rect var15, Rect var16, ParcelableWrapper var17, MergedConfiguration var18, Surface var19)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">IWindowSession$Stub.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IWindowSession</span>$<span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IWindowSession</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DESCRIPTOR = <span class="string">&quot;android.view.IWindowSession&quot;</span>;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addToDisplay = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_relayout = <span class="number">6</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">      String descriptor = <span class="string">&quot;android.view.IWindowSession&quot;</span>;</span><br><span class="line">      IWindow _arg0;</span><br><span class="line">      ......</span><br><span class="line">      <span class="keyword">switch</span>(code) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">         data.enforceInterface(descriptor);</span><br><span class="line">         _arg0 = Stub.asInterface(data.readStrongBinder());</span><br><span class="line">         _arg1 = data.readInt();</span><br><span class="line">         <span class="keyword">if</span>(<span class="number">0</span> != data.readInt()) &#123;</span><br><span class="line">            _arg25 = (LayoutParams)LayoutParams.CREATOR.createFromParcel(data);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _arg25 = <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         _arg3 = data.readInt();</span><br><span class="line">         _arg4 = data.readInt();</span><br><span class="line">         _arg53 = <span class="keyword">new</span> Rect();</span><br><span class="line">         _arg63 = <span class="keyword">new</span> Rect();</span><br><span class="line">         Rect _result6 = <span class="keyword">new</span> Rect();</span><br><span class="line">         Rect _arg81 = <span class="keyword">new</span> Rect();</span><br><span class="line">         ParcelableWrapper _result8 = <span class="keyword">new</span> ParcelableWrapper();</span><br><span class="line">         InputChannel _arg91 = <span class="keyword">new</span> InputChannel();</span><br><span class="line">         <span class="keyword">int</span> _arg101 = <span class="keyword">this</span>.addToDisplay(_arg0, _arg1, _arg25, _arg3, _arg4, _arg53, _arg63, _result6, _arg81, _result8, _arg91);</span><br><span class="line">         ......</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">         data.enforceInterface(descriptor);</span><br><span class="line">         _arg0 = Stub.asInterface(data.readStrongBinder());</span><br><span class="line">         _arg1 = data.readInt();</span><br><span class="line">         <span class="keyword">if</span>(<span class="number">0</span> != data.readInt()) &#123;</span><br><span class="line">            _arg25 = (LayoutParams)LayoutParams.CREATOR.createFromParcel(data);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _arg25 = <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">         ParcelableWrapper _arg15 = <span class="keyword">new</span> ParcelableWrapper();</span><br><span class="line">         MergedConfiguration _arg16 = <span class="keyword">new</span> MergedConfiguration();</span><br><span class="line">         Surface _arg17 = <span class="keyword">new</span> Surface();</span><br><span class="line">         <span class="keyword">int</span> _result2 = <span class="keyword">this</span>.relayout(_arg0, _arg1, _arg25, _arg3, _arg4, _arg5, _arg62, _result4, _result7, _arg9, _arg10, _arg11, _arg12, _arg13, _arg14, _arg15, _arg16, _arg17);</span><br><span class="line">         ......</span><br><span class="line">         <span class="keyword">if</span>(_arg17 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            reply.writeInt(<span class="number">1</span>);</span><br><span class="line">            _arg17.writeToParcel(reply, <span class="number">1</span>);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reply.writeInt(<span class="number">0</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从该函数的实现可以看出，应用程序进程中创建的Surface对象并没有传递到WMS服务进程，只是读取WMS服务进程返回来的Surface。那么WMS服务进程是如何响应应用程序进程布局请求的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">IWindowSession$Stub$Proxy.java</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IWindowSession</span>$<span class="title">Stub</span>$<span class="title">Proxy</span></span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">IWindowSession</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> IBinder mRemote;</span><br><span class="line">  </span><br><span class="line">  IWindowSession$Stub$Proxy(IBinder remote)</span><br><span class="line">  &#123;</span><br><span class="line">    mRemote = remote;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mRemote;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;android.view.IWindowSession&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addToDisplay</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> layerStackId, Rect outFrame, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, DisplayCutout.ParcelableWrapper displayCutout, InputChannel outInputChannel)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel _data = Parcel.obtain();</span><br><span class="line">    Parcel _reply = Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      _data.writeInterfaceToken(<span class="string">&quot;android.view.IWindowSession&quot;</span>);</span><br><span class="line">      _data.writeStrongBinder(window != <span class="keyword">null</span> ? window.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">      _data.writeInt(seq);</span><br><span class="line">      <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        attrs.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      _data.writeInt(viewVisibility);</span><br><span class="line">      _data.writeInt(layerStackId);</span><br><span class="line">      mRemote.transact(<span class="number">2</span>, _data, _reply, <span class="number">0</span>);</span><br><span class="line">      _reply.readException();</span><br><span class="line">      <span class="keyword">int</span> _result = _reply.readInt();</span><br><span class="line">      ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      _reply.recycle();</span><br><span class="line">      _data.recycle(); &#125;</span><br><span class="line">    <span class="keyword">int</span> _result;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags, <span class="keyword">long</span> frameNumber, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets, Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame, DisplayCutout.ParcelableWrapper displayCutout, MergedConfiguration outMergedConfiguration, Surface outSurface)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel _data = Parcel.obtain();</span><br><span class="line">    Parcel _reply = Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      _data.writeInterfaceToken(<span class="string">&quot;android.view.IWindowSession&quot;</span>);</span><br><span class="line">      _data.writeStrongBinder(window != <span class="keyword">null</span> ? window.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">      _data.writeInt(seq);</span><br><span class="line">      <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        attrs.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      _data.writeInt(requestedWidth);</span><br><span class="line">      _data.writeInt(requestedHeight);</span><br><span class="line">      _data.writeInt(viewVisibility);</span><br><span class="line">      _data.writeInt(flags);</span><br><span class="line">      _data.writeLong(frameNumber);</span><br><span class="line">      mRemote.transact(<span class="number">6</span>, _data, _reply, <span class="number">0</span>);</span><br><span class="line">      _reply.readException();</span><br><span class="line">      <span class="keyword">int</span> _result = _reply.readInt();</span><br><span class="line">      ......</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> != _reply.readInt()) &#123;</span><br><span class="line">        outSurface.readFromParcel(_reply);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      _reply.recycle();</span><br><span class="line">      _data.recycle(); &#125;</span><br><span class="line">    <span class="keyword">int</span> _result;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>该函数可以看出，WMS服务在响应应用程序进程请求添加窗口时，首先在当前进程空间创建一个Surface对象，然后调用Session的relayout()函数进一步完成窗口添加过程，最后将WMS服务中创建的Surface返回给应用程序进程。</p>
<h5 id="1-1、Session-relayout"><a href="#1-1、Session-relayout" class="headerlink" title="1.1、Session.relayout()"></a>1.1、Session.relayout()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\Session.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewFlags, <span class="keyword">int</span> flags, <span class="keyword">long</span> frameNumber,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outFrame, Rect outOverscanInsets, Rect outContentInsets, Rect outVisibleInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">            DisplayCutout.ParcelableWrapper cutout, MergedConfiguration mergedConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params">            Surface outSurface)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) Slog.d(TAG_WM, <span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt; ENTERED relayout from &quot;</span></span><br><span class="line">                + Binder.getCallingPid());</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, mRelayoutTag);</span><br><span class="line">        <span class="keyword">int</span> res = mService.relayoutWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">                requestedWidth, requestedHeight, viewFlags, flags, frameNumber,</span><br><span class="line">                outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</span><br><span class="line">                outStableInsets, outsets, outBackdropFrame, cutout,</span><br><span class="line">                mergedConfiguration, outSurface);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) Slog.d(TAG_WM, <span class="string">&quot;&lt;&lt;&lt;&lt;&lt;&lt; EXITING relayout to &quot;</span></span><br><span class="line">                + Binder.getCallingPid());</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-2、WindowManagerService-relayoutWindow"><a href="#1-2、WindowManagerService-relayoutWindow" class="headerlink" title="1.2、WindowManagerService.relayoutWindow()"></a>1.2、WindowManagerService.relayoutWindow()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayoutWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq, LayoutParams attrs,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> frameNumber, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">            DisplayCutout.ParcelableWrapper outCutout, MergedConfiguration mergedConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params">            Surface outSurface)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> configChanged;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> displayId;</span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.998</span> V/WindowManager( <span class="number">1049</span>): Looking up client android.os.BinderProxy<span class="meta">@b9baf64</span>: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> WindowState <span class="title">windowForClientLocked</span><span class="params">(Session session, IBinder client, <span class="keyword">boolean</span> throwOnError)</span> </span>&#123;</span><br><span class="line">        WindowState win = mWindowMap.get(client);</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG_WM, <span class="string">&quot;Looking up client &quot;</span> + client + <span class="string">&quot;: &quot;</span> + win);</span><br><span class="line">        <span class="keyword">return</span> win;</span><br><span class="line">    &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            WindowState win = windowForClientLocked(session, client, <span class="keyword">false</span>);</span><br><span class="line">            </span><br><span class="line">            displayId = win.getDisplayId();</span><br><span class="line">            <span class="comment">//得到WindowStateAnimator</span></span><br><span class="line">            WindowStateAnimator winAnimator = win.mWinAnimator;</span><br><span class="line">            ......</span><br><span class="line">            win.setFrameNumber(frameNumber);</span><br><span class="line">            <span class="keyword">int</span> attrChanges = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> flagChanges = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPolicy.adjustWindowParamsLw(win, attrs, hasStatusBarServicePermission);</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.000</span> V/WindowManager( <span class="number">1049</span>): Relayout Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: viewVisibility=<span class="number">0</span> req=<span class="number">160</span>x854 &#123;(<span class="number">0</span>,<span class="number">0</span>)(<span class="number">160</span>x854) sim=&#123;adjust=pan forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.000</span> V/WindowManager( <span class="number">1049</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.v(TAG_WM, <span class="string">&quot;Relayout &quot;</span> + win + <span class="string">&quot;: viewVisibility=&quot;</span> + viewVisibility</span><br><span class="line">                    + <span class="string">&quot; req=&quot;</span> + requestedWidth + <span class="string">&quot;x&quot;</span> + requestedHeight + <span class="string">&quot; &quot;</span> + win.mAttrs);</span><br><span class="line">            ......</span><br><span class="line">            win.setWindowScale(win.mRequestedWidth, win.mRequestedHeight);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> oldVisibility = win.mViewVisibility;</span><br><span class="line"></span><br><span class="line">            .......</span><br><span class="line">            win.mViewVisibility = viewVisibility;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SCREEN_ON) &#123;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>): Relayout Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: oldVis=<span class="number">4</span> newVis=<span class="number">0</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>): java.lang.RuntimeException</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>):     at com.android.server.wm.WindowManagerService.relayoutWindow(WindowManagerService.java:<span class="number">1994</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>):     at com.android.server.wm.Session.relayout(Session.java:<span class="number">244</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>):     at android.view.IWindowSession$Stub.onTransact(IWindowSession.java:<span class="number">309</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>):     at com.android.server.wm.Session.onTransact(Session.java:<span class="number">164</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/WindowManager( <span class="number">1049</span>):     at android.os.Binder.execTransact(Binder.java:<span class="number">731</span>)</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                RuntimeException stack = <span class="keyword">new</span> RuntimeException();</span><br><span class="line">                stack.fillInStackTrace();</span><br><span class="line">                Slog.i(TAG_WM, <span class="string">&quot;Relayout &quot;</span> + win + <span class="string">&quot;: oldVis=&quot;</span> + oldVisibility</span><br><span class="line">                        + <span class="string">&quot; newVis=&quot;</span> + viewVisibility, stack);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> W/WindowManager( <span class="number">1049</span>): setLayoutNeeded: callers=com.android.server.wm.WindowState.setDisplayLayoutNeeded:<span class="number">2250</span> com.android.server.wm.WindowManagerService.relayoutWindow:<span class="number">1999</span> com.android.server.wm.Session.relayout:<span class="number">244</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowState.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setLayoutNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.w(TAG_WM, <span class="string">&quot;setLayoutNeeded: callers=&quot;</span> + Debug.getCallers(<span class="number">3</span>));</span><br><span class="line">        mLayoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            win.setDisplayLayoutNeeded();</span><br><span class="line">            win.mGivenInsetsPending = (flags &amp; WindowManagerGlobal.RELAYOUT_INSETS_PENDING) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// We may be deferring layout passes at the moment, but since the client is interested</span></span><br><span class="line">            <span class="comment">// in the new out values right now we need to force a layout.</span></span><br><span class="line">            mWindowPlacerLocked.performSurfacePlacement(<span class="keyword">true</span> <span class="comment">/* force */</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (shouldRelayout) &#123;</span><br><span class="line">               </span><br><span class="line">                result = win.relayoutVisibleWindow(result, attrChanges, oldVisibility);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    result = createSurfaceControl(outSurface, result, win, winAnimator);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="string">&quot;relayoutWindow: viewVisibility_2&quot;</span>);</span><br><span class="line"></span><br><span class="line">                winAnimator.mEnterAnimationPending = <span class="keyword">false</span>;</span><br><span class="line">                winAnimator.mEnteringAnimation = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (viewVisibility == View.VISIBLE &amp;&amp; winAnimator.hasSurface()) &#123;</span><br><span class="line">                    winAnimator.mSurfaceController.getSurface(outSurface);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.i(TAG_WM, <span class="string">&quot;Releasing surface in: &quot;</span> + win);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        outSurface.release();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (focusMayChange) &#123;</span><br><span class="line">                <span class="comment">//System.out.println(&quot;Focus may change: &quot; + win.mAttrs.getTitle());</span></span><br><span class="line">                <span class="comment">//更新Focus窗口</span></span><br><span class="line">                <span class="keyword">if</span> (updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>)) &#123;</span><br><span class="line">                    imMayMove = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// updateFocusedWindowLocked() already assigned layers so we only need to</span></span><br><span class="line">            <span class="comment">// reassign them at this point if the IM window state gets shuffled</span></span><br><span class="line">            <span class="keyword">boolean</span> toBeDisplayed = (result &amp; WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> DisplayContent dc = win.getDisplayContent();</span><br><span class="line">            <span class="keyword">if</span> (imMayMove) &#123;</span><br><span class="line">                dc.computeImeTarget(<span class="keyword">true</span> <span class="comment">/* updateImeTarget */</span>);</span><br><span class="line">                <span class="keyword">if</span> (toBeDisplayed) &#123;</span><br><span class="line">                    dc.assignWindowLayers(<span class="keyword">false</span> <span class="comment">/* setLayoutNeeded */</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">           .......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">Line <span class="number">3541</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.071</span> V/WindowManager( <span class="number">1049</span>): Relayout given client android.os.BinderProxy<span class="meta">@b9baf64</span>, requestedWidth=<span class="number">160</span>, requestedHeight=<span class="number">854</span>, viewVisibility=<span class="number">0</span></span><br><span class="line">Line <span class="number">3542</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.071</span> V/WindowManager( <span class="number">1049</span>): Relayout returning frame=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">160</span>, <span class="number">854</span>), surface=Surface(name=<span class="keyword">null</span>)/@<span class="number">0xc820bda</span></span><br><span class="line">Line <span class="number">3543</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.071</span> V/WindowManager( <span class="number">1049</span>): Relayout of Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: focusMayChange=<span class="keyword">true</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                TAG_WM, <span class="string">&quot;Relayout given client &quot;</span> + client.asBinder()</span><br><span class="line">                + <span class="string">&quot;, requestedWidth=&quot;</span> + requestedWidth</span><br><span class="line">                + <span class="string">&quot;, requestedHeight=&quot;</span> + requestedHeight</span><br><span class="line">                + <span class="string">&quot;, viewVisibility=&quot;</span> + viewVisibility</span><br><span class="line">                + <span class="string">&quot;\nRelayout returning frame=&quot;</span> + outFrame</span><br><span class="line">                + <span class="string">&quot;, surface=&quot;</span> + outSurface);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (localLOGV || DEBUG_FOCUS) Slog.v(</span><br><span class="line">                TAG_WM, <span class="string">&quot;Relayout of &quot;</span> + win + <span class="string">&quot;: focusMayChange=&quot;</span> + focusMayChange);</span><br><span class="line"></span><br><span class="line">            result |= mInTouchMode ? WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mInputMonitor.updateInputWindowsLw(<span class="keyword">true</span> <span class="comment">/*force*/</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LAYOUT) &#123;</span><br><span class="line">                Slog.v(TAG_WM, <span class="string">&quot;Relayout complete &quot;</span> + win + <span class="string">&quot;: outFrame=&quot;</span> + outFrame.toShortString());</span><br><span class="line">            &#125;</span><br><span class="line">            win.mInRelayout = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-1、WindowSurfacePlacer-performSurfacePlaRelayout-complete-cement-true-force"><a href="#1-2-1、WindowSurfacePlacer-performSurfacePlaRelayout-complete-cement-true-force" class="headerlink" title="1.2.1、WindowSurfacePlacer.performSurfacePlaRelayout complete cement(true /* force */)"></a>1.2.1、WindowSurfacePlacer.performSurfacePlaRelayout complete cement(true /* force */)</h5><p>首先看下堆栈信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> V/RootWindowContainer( <span class="number">1049</span>): performSurfacePlacementInner: entry. Called by com.android.server.wm.WindowSurfacePlacer.performSurfacePlacementLoop:<span class="number">207</span> com.android.server.wm.WindowSurfacePlacer.performSurfacePlacement:<span class="number">155</span> com.android.server.wm.WindowManagerService.relayoutWindow:<span class="number">2031</span> </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowSurfacePlacer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performSurfacePlacement</span><span class="params">(<span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDeferDepth &gt; <span class="number">0</span> &amp;&amp; !force) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> loopCount = <span class="number">6</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            mTraversalScheduled = <span class="keyword">false</span>;</span><br><span class="line">            performSurfacePlacementLoop();</span><br><span class="line">            mService.mAnimationHandler.removeCallbacks(mPerformSurfacePlacement);</span><br><span class="line">            loopCount--;</span><br><span class="line">        &#125; <span class="keyword">while</span> (mTraversalScheduled &amp;&amp; loopCount &gt; <span class="number">0</span>);</span><br><span class="line">        mService.mRoot.mWallpaperActionPending = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performSurfacePlacementLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mInLayout = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> recoveringMemory = <span class="keyword">false</span>;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mService.mRoot.performSurfacePlacement(recoveringMemory);</span><br><span class="line"></span><br><span class="line">            mInLayout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mService.mRoot.isLayoutNeeded()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (++mLayoutRepeatCount &lt; <span class="number">6</span>) &#123;</span><br><span class="line">                    requestTraversal();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Performed 6 layouts in a row. Skipping&quot;</span>);</span><br><span class="line">                    mLayoutRepeatCount = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mLayoutRepeatCount = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mService.mWindowsChanged &amp;&amp; !mService.mWindowChangeListeners.isEmpty()) &#123;</span><br><span class="line">                mService.mH.removeMessages(REPORT_WINDOWS_CHANGE);</span><br><span class="line">                mService.mH.sendEmptyMessage(REPORT_WINDOWS_CHANGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            mInLayout = <span class="keyword">false</span>;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">&quot;Unhandled exception while laying out windows&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-2-2、RootWindowContainer-performSurfacePlacement-recoveringMemory"><a href="#1-2-2、RootWindowContainer-performSurfacePlacement-recoveringMemory" class="headerlink" title="1.2.2、RootWindowContainer.performSurfacePlacement(recoveringMemory)"></a>1.2.2、RootWindowContainer.performSurfacePlacement(recoveringMemory)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\RootWindowContainer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">performSurfacePlacement</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_TRACE) Slog.v(TAG, <span class="string">&quot;performSurfacePlacementInner: entry. Called by &quot;</span></span><br><span class="line">                + Debug.getCallers(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">boolean</span> updateInputWindowsNeeded = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.mFocusMayChange) &#123;</span><br><span class="line">            mService.mFocusMayChange = <span class="keyword">false</span>;</span><br><span class="line">            updateInputWindowsNeeded = mService.updateFocusedWindowLocked(</span><br><span class="line">                    UPDATE_FOCUS_WILL_PLACE_SURFACES, <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize state of exiting tokens.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mChildren.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> DisplayContent displayContent = mChildren.get(displayNdx);</span><br><span class="line">            displayContent.setExitingTokensHasVisible(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mHoldScreen = <span class="keyword">null</span>;</span><br><span class="line">        mScreenBrightness = -<span class="number">1</span>;</span><br><span class="line">        mUserActivityTimeout = -<span class="number">1</span>;</span><br><span class="line">        mObscureApplicationContentOnSecondaryDisplays = <span class="keyword">false</span>;</span><br><span class="line">        mSustainedPerformanceModeCurrent = <span class="keyword">false</span>;</span><br><span class="line">        mService.mTransactionSequence++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> DisplayContent defaultDisplay = mService.getDefaultDisplayContentLocked();</span><br><span class="line">        <span class="keyword">final</span> DisplayInfo defaultInfo = defaultDisplay.getDisplayInfo();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> defaultDw = defaultInfo.logicalWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> defaultDh = defaultInfo.logicalHeight;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> I/RootWindowContainer( <span class="number">1049</span>): &gt;&gt;&gt; OPEN TRANSACTION performLayoutAndPlaceSurfaces</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> W/WindowManager( <span class="number">1049</span>): clearLayoutNeeded: callers=com.android.server.wm.DisplayContent.performLayout:<span class="number">2967</span> com.android.server.wm.DisplayContent.applySurfaceChangesTransaction:<span class="number">2880</span> com.android.server.wm.RootWindowContainer.applySurfaceChangesTransaction:<span class="number">852</span> </span><br><span class="line">......</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.009</span> I/RootWindowContainer( <span class="number">1049</span>): &lt;&lt;&lt; CLOSE TRANSACTION performLayoutAndPlaceSurfaces</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SHOW_LIGHT_TRANSACTIONS) Slog.i(TAG,</span><br><span class="line">                <span class="string">&quot;&gt;&gt;&gt; OPEN TRANSACTION performLayoutAndPlaceSurfaces&quot;</span>);</span><br><span class="line">        mService.openSurfaceTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            applySurfaceChangesTransaction(recoveringMemory, defaultDw, defaultDh);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">&quot;Unhandled exception in Window Manager&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mService.closeSurfaceTransaction(<span class="string">&quot;performLayoutAndPlaceSurfaces&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (SHOW_LIGHT_TRANSACTIONS) Slog.i(TAG,</span><br><span class="line">                    <span class="string">&quot;&lt;&lt;&lt; CLOSE TRANSACTION performLayoutAndPlaceSurfaces&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mService.mAnimator.executeAfterPrepareSurfacesRunnables();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowSurfacePlacer surfacePlacer = mService.mWindowPlacerLocked;</span><br><span class="line">        <span class="comment">// If we are ready to perform an app transition, check through all of the app tokens to be</span></span><br><span class="line">        <span class="comment">// shown and see if they are ready to go.</span></span><br><span class="line">        <span class="keyword">if</span> (mService.mAppTransition.isReady()) &#123;</span><br><span class="line">            <span class="comment">// This needs to be split into two expressions, as handleAppTransitionReadyLocked may</span></span><br><span class="line">            <span class="comment">// modify dc.pendingLayoutChanges, which would get lost when writing</span></span><br><span class="line">            <span class="comment">// defaultDisplay.pendingLayoutChanges |= handleAppTransitionReadyLocked()</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> layoutChanges = surfacePlacer.handleAppTransitionReadyLocked();</span><br><span class="line">            defaultDisplay.pendingLayoutChanges |= layoutChanges;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LAYOUT_REPEATS)</span><br><span class="line">                surfacePlacer.debugLayoutRepeats(<span class="string">&quot;after handleAppTransitionReadyLocked&quot;</span>,</span><br><span class="line">                        defaultDisplay.pendingLayoutChanges);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Check to see if we are now in a state where the screen should</span></span><br><span class="line">        <span class="comment">// be enabled, because the window obscured flags have changed.</span></span><br><span class="line">        mService.enableScreenIfNeededLocked();</span><br><span class="line"></span><br><span class="line">        mService.scheduleAnimationLocked();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_TRACE) Slog.e(TAG,</span><br><span class="line">                <span class="string">&quot;performSurfacePlacementInner exit: animating=&quot;</span> + mService.mAnimator.isAnimating());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h6 id="1-2-2-1、applySurfaceChangesTransaction-recoveringMemory-defaultDw-defaultDh"><a href="#1-2-2-1、applySurfaceChangesTransaction-recoveringMemory-defaultDw-defaultDh" class="headerlink" title="1.2.2.1、applySurfaceChangesTransaction(recoveringMemory, defaultDw, defaultDh)"></a>1.2.2.1、applySurfaceChangesTransaction(recoveringMemory, defaultDw, defaultDh)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\RootWindowContainer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applySurfaceChangesTransaction</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory, <span class="keyword">int</span> defaultDw,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> defaultDh)</span> </span>&#123;</span><br><span class="line">        mHoldScreenWindow = <span class="keyword">null</span>;</span><br><span class="line">        mObscuringWindow = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">         ......</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">boolean</span> focusDisplayed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mChildren.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; count; ++j) &#123;</span><br><span class="line">            <span class="keyword">final</span> DisplayContent dc = mChildren.get(j);</span><br><span class="line">            focusDisplayed |= dc.applySurfaceChangesTransaction(recoveringMemory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (focusDisplayed) &#123;</span><br><span class="line">            mService.mH.sendEmptyMessage(REPORT_LOSING_FOCUS);</span><br><span class="line">        &#125;</span><br><span class="line">        mService.mDisplayManagerInternal.performTraversal(mDisplayTransaction);</span><br><span class="line">        SurfaceControl.mergeToGlobalTransaction(mDisplayTransaction);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-2-2、DisplayContent-applySurfaceChangesTransaction-recoveringMemory"><a href="#1-2-2-2、DisplayContent-applySurfaceChangesTransaction-recoveringMemory" class="headerlink" title="1.2.2.2、DisplayContent.applySurfaceChangesTransaction(recoveringMemory)"></a>1.2.2.2、DisplayContent.applySurfaceChangesTransaction(recoveringMemory)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\DisplayContent.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">applySurfaceChangesTransaction</span><span class="params">(<span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dw = mDisplayInfo.logicalWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dh = mDisplayInfo.logicalHeight;</span><br><span class="line">        <span class="keyword">final</span> WindowSurfacePlacer surfacePlacer = mService.mWindowPlacerLocked;</span><br><span class="line"></span><br><span class="line">        mTmpUpdateAllDrawn.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> repeats = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((pendingLayoutChanges &amp; FINISH_LAYOUT_REDO_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">                setLayoutNeeded();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FIRST LOOP: Perform a layout, if needed.</span></span><br><span class="line">            <span class="keyword">if</span> (repeats &lt; LAYOUT_REPEAT_THRESHOLD) &#123;</span><br><span class="line">                performLayout(repeats == <span class="number">1</span>, <span class="keyword">false</span> <span class="comment">/* updateInputWindows */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Layout repeat skipped after too many iterations&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FIRST AND ONE HALF LOOP: Make WindowManagerPolicy think it is animating.</span></span><br><span class="line">            pendingLayoutChanges = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">                mService.mPolicy.beginPostLayoutPolicyLw(dw, dh);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.003</span> I/WindowManager( <span class="number">1049</span>): Win Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: affectsSystemUi=<span class="keyword">false</span></span><br><span class="line">......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                forAllWindows(mApplyPostLayoutPolicy, <span class="keyword">true</span> <span class="comment">/* traverseTopToBottom */</span>);</span><br><span class="line">                pendingLayoutChanges |= mService.mPolicy.finishPostLayoutPolicyLw();</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LAYOUT_REPEATS) surfacePlacer.debugLayoutRepeats(</span><br><span class="line">                        <span class="string">&quot;after finishPostLayoutPolicyLw&quot;</span>, pendingLayoutChanges);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pendingLayoutChanges != <span class="number">0</span>);</span><br><span class="line">        mTmpApplySurfaceChangesTransactionState.reset();</span><br><span class="line">        resetDimming();</span><br><span class="line"></span><br><span class="line">        mTmpRecoveringMemory = recoveringMemory;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.007</span> V/AppWindowToken( <span class="number">1049</span>): Eval win Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: isDrawn=<span class="keyword">false</span>, isAnimationSet=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.007</span> V/AppWindowToken( <span class="number">1049</span>): Not displayed: s=<span class="keyword">null</span> pv=<span class="keyword">true</span> mDrawState=NO_SURFACE ph=<span class="keyword">false</span> th=<span class="keyword">false</span> a=<span class="keyword">true</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        forAllWindows(mApplySurfaceChangesTransaction, <span class="keyword">true</span> <span class="comment">/* traverseTopToBottom */</span>);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mTmpApplySurfaceChangesTransactionState.focusDisplayed;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-2-3、DisplayContent-performLayout"><a href="#1-2-2-3、DisplayContent-performLayout" class="headerlink" title="1.2.2.3、DisplayContent.performLayout()"></a>1.2.2.3、DisplayContent.performLayout()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\DisplayContent.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(<span class="keyword">boolean</span> initial, <span class="keyword">boolean</span> updateInputWindows)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isLayoutNeeded()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clearLayoutNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dw = mDisplayInfo.logicalWidth;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dh = mDisplayInfo.logicalHeight;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> V/DisplayContent( <span class="number">1049</span>): -------------------------------------</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.001</span> V/DisplayContent( <span class="number">1049</span>): performLayout: needed=<span class="keyword">false</span> dw=<span class="number">480</span> dh=<span class="number">854</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LAYOUT) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">&quot;-------------------------------------&quot;</span>);</span><br><span class="line">            Slog.v(TAG, <span class="string">&quot;performLayout: needed=&quot;</span> + isLayoutNeeded() + <span class="string">&quot; dw=&quot;</span> + dw + <span class="string">&quot; dh=&quot;</span> + dh);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDisplayFrames.onDisplayInfoUpdated(mDisplayInfo,</span><br><span class="line">                calculateDisplayCutoutForRotation(mDisplayInfo.rotation));</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Not sure if we really need to set the rotation here since we are updating from the</span></span><br><span class="line">        <span class="comment">// display info above...</span></span><br><span class="line">        mDisplayFrames.mRotation = mRotation;</span><br><span class="line">        <span class="comment">//处理NavigationBar StatusBar窗口布局</span></span><br><span class="line">        mService.mPolicy.beginLayoutLw(mDisplayFrames, getConfiguration().uiMode);</span><br><span class="line">        <span class="keyword">if</span> (isDefaultDisplay) &#123;</span><br><span class="line">            <span class="comment">// Not needed on non-default displays.</span></span><br><span class="line">            mService.mSystemDecorLayer = mService.mPolicy.getSystemDecorLayerLw();</span><br><span class="line">            mService.mScreenRect.set(<span class="number">0</span>, <span class="number">0</span>, dw, dh);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> seq = mLayoutSeq + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (seq &lt; <span class="number">0</span>) seq = <span class="number">0</span>;</span><br><span class="line">        mLayoutSeq = seq;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Used to indicate that we have processed the dream window and all additional windows are</span></span><br><span class="line">        <span class="comment">// behind it.</span></span><br><span class="line">        mTmpWindow = <span class="keyword">null</span>;</span><br><span class="line">        mTmpInitial = initial;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First perform layout of any root windows (not attached to another window).</span></span><br><span class="line">        forAllWindows(mPerformLayout, <span class="keyword">true</span> <span class="comment">/* traverseTopToBottom */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Used to indicate that we have processed the dream window and all additional attached</span></span><br><span class="line">        <span class="comment">// windows are behind it.</span></span><br><span class="line">        mTmpWindow2 = mTmpWindow;</span><br><span class="line">        mTmpWindow = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now perform layout of attached windows, which usually depend on the position of the</span></span><br><span class="line">        <span class="comment">// window they are attached to. XXX does not deal with windows that are attached to windows</span></span><br><span class="line">        <span class="comment">// that are themselves attached.</span></span><br><span class="line">        forAllWindows(mPerformLayoutAttached, <span class="keyword">true</span> <span class="comment">/* traverseTopToBottom */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Window frames may have changed. Tell the input dispatcher about it.</span></span><br><span class="line">        mService.mInputMonitor.layoutInputConsumers(dw, dh);</span><br><span class="line">        mService.mInputMonitor.setUpdateInputWindowsNeededLw();</span><br><span class="line">        <span class="keyword">if</span> (updateInputWindows) &#123;</span><br><span class="line">            mService.mInputMonitor.updateInputWindowsLw(<span class="keyword">false</span> <span class="comment">/*force*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mService.mH.sendEmptyMessage(UPDATE_DOCKED_STACK_DIVIDER);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-2-4、DisplayContent-forAllWindows-mPerformLayout-…"><a href="#1-2-2-4、DisplayContent-forAllWindows-mPerformLayout-…" class="headerlink" title="1.2.2.4、DisplayContent.forAllWindows(mPerformLayout, …)"></a>1.2.2.4、DisplayContent.forAllWindows(mPerformLayout, …)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\DisplayContent.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Consumer&lt;WindowState&gt; mPerformLayout = w -&gt; &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t do layout of a window if it is not visible, or soon won&#x27;t be visible, to avoid</span></span><br><span class="line">        <span class="comment">// wasting time and funky changes while a window is animating away.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> gone = (mTmpWindow != <span class="keyword">null</span> &amp;&amp; mService.mPolicy.canBeHiddenByKeyguardLw(w))</span><br><span class="line">                || w.isGoneForLayoutLw();</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">......</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.002</span> V/DisplayContent( <span class="number">1049</span>): <span class="number">1</span>ST PASS Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: gone=<span class="keyword">false</span> mHaveFrame=<span class="keyword">false</span> mLayoutAttached=<span class="keyword">false</span> screen changed=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.002</span> V/DisplayContent( <span class="number">1049</span>):   VIS: mViewVisibility=<span class="number">0</span> mRelayoutCalled=<span class="keyword">true</span> hidden=<span class="keyword">true</span> hiddenRequested=<span class="keyword">false</span> parentHidden=<span class="keyword">false</span></span><br><span class="line">......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LAYOUT &amp;&amp; !w.mLayoutAttached) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">&quot;1ST PASS &quot;</span> + w + <span class="string">&quot;: gone=&quot;</span> + gone + <span class="string">&quot; mHaveFrame=&quot;</span> + w.mHaveFrame</span><br><span class="line">                    + <span class="string">&quot; mLayoutAttached=&quot;</span> + w.mLayoutAttached</span><br><span class="line">                    + <span class="string">&quot; screen changed=&quot;</span> + w.isConfigChanged());</span><br><span class="line">            <span class="keyword">final</span> AppWindowToken atoken = w.mAppToken;</span><br><span class="line">            <span class="keyword">if</span> (gone) Slog.v(TAG, <span class="string">&quot;  GONE: mViewVisibility=&quot;</span> + w.mViewVisibility</span><br><span class="line">                    + <span class="string">&quot; mRelayoutCalled=&quot;</span> + w.mRelayoutCalled + <span class="string">&quot; hidden=&quot;</span> + w.mToken.isHidden()</span><br><span class="line">                    + <span class="string">&quot; hiddenRequested=&quot;</span> + (atoken != <span class="keyword">null</span> &amp;&amp; atoken.hiddenRequested)</span><br><span class="line">                    + <span class="string">&quot; parentHidden=&quot;</span> + w.isParentWindowHidden());</span><br><span class="line">            <span class="keyword">else</span> Slog.v(TAG, <span class="string">&quot;  VIS: mViewVisibility=&quot;</span> + w.mViewVisibility</span><br><span class="line">                    + <span class="string">&quot; mRelayoutCalled=&quot;</span> + w.mRelayoutCalled + <span class="string">&quot; hidden=&quot;</span> + w.mToken.isHidden()</span><br><span class="line">                    + <span class="string">&quot; hiddenRequested=&quot;</span> + (atoken != <span class="keyword">null</span> &amp;&amp; atoken.hiddenRequested)</span><br><span class="line">                    + <span class="string">&quot; parentHidden=&quot;</span> + w.isParentWindowHidden());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this view is GONE, then skip it -- keep the current frame, and let the caller know</span></span><br><span class="line">        <span class="comment">// so they can ignore it if they want.  (We do the normal layout for INVISIBLE windows,</span></span><br><span class="line">        <span class="comment">// since that means &quot;perform layout as normal, just don&#x27;t display&quot;).</span></span><br><span class="line">        <span class="keyword">if</span> (!gone || !w.mHaveFrame || w.mLayoutNeeded</span><br><span class="line">                || ((w.isConfigChanged() || w.setReportResizeHints())</span><br><span class="line">                &amp;&amp; !w.isGoneForLayoutLw() &amp;&amp;</span><br><span class="line">                ((w.mAttrs.privateFlags &amp; PRIVATE_FLAG_KEYGUARD) != <span class="number">0</span> ||</span><br><span class="line">                        (w.mHasSurface &amp;&amp; w.mAppToken != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                w.mAppToken.layoutConfigChanges)))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!w.mLayoutAttached) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mTmpInitial) &#123;</span><br><span class="line">                    <span class="comment">//Slog.i(TAG, &quot;Window &quot; + this + &quot; clearing mContentChanged - initial&quot;);</span></span><br><span class="line">                    w.mContentChanged = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (w.mAttrs.type == TYPE_DREAM) &#123;</span><br><span class="line">                    <span class="comment">// Don&#x27;t layout windows behind a dream, so that if it does stuff like hide</span></span><br><span class="line">                    <span class="comment">// the status bar we won&#x27;t get a bad transition when it goes away.</span></span><br><span class="line">                    mTmpWindow = w;</span><br><span class="line">                &#125;</span><br><span class="line">                w.mLayoutNeeded = <span class="keyword">false</span>;</span><br><span class="line">                w.prelayout();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> firstLayout = !w.isLaidOut();</span><br><span class="line">                mService.mPolicy.layoutWindowLw(w, <span class="keyword">null</span>, mDisplayFrames);</span><br><span class="line">                w.mLayoutSeq = mLayoutSeq;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If this is the first layout, we need to initialize the last inset values as</span></span><br><span class="line">                <span class="comment">// otherwise we&#x27;d immediately cause an unnecessary resize.</span></span><br><span class="line">                <span class="keyword">if</span> (firstLayout) &#123;</span><br><span class="line">                    w.updateLastInsetValues();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (w.mAppToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    w.mAppToken.layoutLetterbox(w);</span><br><span class="line">                &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.002</span> V/DisplayContent( <span class="number">1049</span>):   LAYOUT: mFrame=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">160</span>, <span class="number">854</span>) mContainingFrame=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">160</span>, <span class="number">854</span>) mDisplayFrame=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">160</span>, <span class="number">854</span>)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.v(TAG, <span class="string">&quot;  LAYOUT: mFrame=&quot;</span> + w.mFrame</span><br><span class="line">                        + <span class="string">&quot; mContainingFrame=&quot;</span> + w.mContainingFrame</span><br><span class="line">                        + <span class="string">&quot; mDisplayFrame=&quot;</span> + w.mDisplayFrame);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-2-5、mService-mPolicy-PhoneWindowManager-layoutWindowLw-w-null-mDisplayFrames"><a href="#1-2-2-5、mService-mPolicy-PhoneWindowManager-layoutWindowLw-w-null-mDisplayFrames" class="headerlink" title="1.2.2.5、mService.mPolicy[PhoneWindowManager].layoutWindowLw(w, null, mDisplayFrames)"></a>1.2.2.5、mService.mPolicy[PhoneWindowManager].layoutWindowLw(w, null, mDisplayFrames)</h6><p>由之前加入的patch可以知道，我们将App（com.android.testred）的Window宽度强制设置为1/3屏幕宽度，即160。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layoutWindowLw</span><span class="params">(WindowState win, WindowState attached, DisplayFrames displayFrames)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// We&#x27;ve already done the navigation bar, status bar, and all screen decor windows. If the</span></span><br><span class="line">        <span class="comment">// status bar can receive input, we need to layout it again to accommodate for the IME</span></span><br><span class="line">        <span class="comment">// window.</span></span><br><span class="line">        <span class="keyword">if</span> ((win == mStatusBar &amp;&amp; !canReceiveInput(win)) || win == mNavigationBar</span><br><span class="line">                || mScreenDecorWindows.contains(win)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> WindowManager.LayoutParams attrs = win.getAttrs();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isDefaultDisplay = win.isDefaultDisplay();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> needsToOffsetInputMethodTarget = isDefaultDisplay &amp;&amp;</span><br><span class="line">                (win == mLastInputMethodTargetWindow &amp;&amp; mLastInputMethodWindow != <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (needsToOffsetInputMethodTarget) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.i(TAG, <span class="string">&quot;Offset ime target window by the last ime window state&quot;</span>);</span><br><span class="line">            offsetInputMethodWindowLw(mLastInputMethodWindow, displayFrames);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> type = attrs.type;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> fl = PolicyControl.getWindowFlags(win, attrs);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pfl = attrs.privateFlags;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sim = attrs.softInputMode;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> requestedSysUiFl = PolicyControl.getSystemUiVisibility(<span class="keyword">null</span>, attrs);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sysUiFl = requestedSysUiFl | getImpliedSysUiFlagsForLayout(attrs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Rect pf = mTmpParentFrame;</span><br><span class="line">        <span class="keyword">final</span> Rect df = mTmpDisplayFrame;</span><br><span class="line">        <span class="keyword">final</span> Rect of = mTmpOverscanFrame;</span><br><span class="line">        <span class="keyword">final</span> Rect cf = mTmpContentFrame;</span><br><span class="line">        <span class="keyword">final</span> Rect vf = mTmpVisibleFrame;</span><br><span class="line">        <span class="keyword">final</span> Rect dcf = mTmpDecorFrame;</span><br><span class="line">        <span class="keyword">final</span> Rect sf = mTmpStableFrame;</span><br><span class="line">        Rect osf = <span class="keyword">null</span>;</span><br><span class="line">        dcf.setEmpty();</span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">if</span> (layoutInScreen &amp;&amp; layoutInsetDecor) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.v(TAG, <span class="string">&quot;layoutWindowLw(&quot;</span> + attrs.getTitle()</span><br><span class="line">                        + <span class="string">&quot;): IN_SCREEN, INSET_DECOR&quot;</span>);</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="comment">//charlesvincent</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;com.android.testred&quot;</span>.equals(win.getAttrs().packageName)) &#123;</span><br><span class="line">           pf.left = df.left = of.left = cf.left = displayFrames.mOverscan.left;</span><br><span class="line">           pf.top = df.top = of.top = cf.top = displayFrames.mOverscan.top;</span><br><span class="line">           pf.right = df.right = of.right = cf.right</span><br><span class="line">                   = displayFrames.mOverscan.left + displayFrames.mOverscan.right / <span class="number">3</span>;</span><br><span class="line">           pf.bottom = df.bottom = of.bottom = cf.bottom</span><br><span class="line">                   = displayFrames.mOverscan.top + displayFrames.mOverscan.bottom;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//charlesvincent</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;com.android.testgreen&quot;</span>.equals(win.getAttrs().packageName)) &#123;</span><br><span class="line">           pf.left = df.left = of.left = cf.left = displayFrames.mOverscan.left  + displayFrames.mOverscan.right / <span class="number">3</span>;</span><br><span class="line">           pf.top = df.top = of.top = cf.top = displayFrames.mOverscan.top;</span><br><span class="line">           pf.right = df.right = of.right = cf.right</span><br><span class="line">                   = displayFrames.mOverscan.left  + displayFrames.mOverscan.right * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">           pf.bottom = df.bottom = of.bottom = cf.bottom</span><br><span class="line">                   = displayFrames.mOverscan.top + displayFrames.mOverscan.bottom;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//charlesvincent</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;com.android.testblue&quot;</span>.equals(win.getAttrs().packageName)) &#123;</span><br><span class="line">           pf.left = df.left = of.left = cf.left = displayFrames.mOverscan.left  + displayFrames.mOverscan.right * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">           pf.top = df.top = of.top = cf.top = displayFrames.mOverscan.top;</span><br><span class="line">           pf.right = df.right = of.right = cf.right</span><br><span class="line">                   = displayFrames.mOverscan.left  + displayFrames.mOverscan.right * <span class="number">3</span> / <span class="number">3</span>;</span><br><span class="line">           pf.bottom = df.bottom = of.bottom = cf.bottom</span><br><span class="line">                   = displayFrames.mOverscan.top + displayFrames.mOverscan.bottom;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">......</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.002</span> V/WindowManager( <span class="number">1049</span>): layoutWindowLw(com.android.testred/com.android.testred.TestActivity): IN_SCREEN, INSET_DECOR</span><br><span class="line">04-16 13:08:37.002 V/WindowManager( 1049): Compute frame com.android.testred/com.android.testred.TestActivity: sim=#120 attach=null type=1 flags=0x01810100 pf=[0,0][160,854] df=[0,0][160,854] of=[0,0][160,854] cf=[0,0][160,854] vf=[0,36][480,782] dcf=[0,36][480,782] sf=[0,36][480,782] osf=null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.v(TAG, <span class="string">&quot;Compute frame &quot;</span> + attrs.getTitle()</span><br><span class="line">                + <span class="string">&quot;: sim=#&quot;</span> + Integer.toHexString(sim)</span><br><span class="line">                + <span class="string">&quot; attach=&quot;</span> + attached + <span class="string">&quot; type=&quot;</span> + type</span><br><span class="line">                + String.format(<span class="string">&quot; flags=0x%08x&quot;</span>, fl)</span><br><span class="line">                + <span class="string">&quot; pf=&quot;</span> + pf.toShortString() + <span class="string">&quot; df=&quot;</span> + df.toShortString()</span><br><span class="line">                + <span class="string">&quot; of=&quot;</span> + of.toShortString()</span><br><span class="line">                + <span class="string">&quot; cf=&quot;</span> + cf.toShortString() + <span class="string">&quot; vf=&quot;</span> + vf.toShortString()</span><br><span class="line">                + <span class="string">&quot; dcf=&quot;</span> + dcf.toShortString()</span><br><span class="line">                + <span class="string">&quot; sf=&quot;</span> + sf.toShortString()</span><br><span class="line">                + <span class="string">&quot; osf=&quot;</span> + (osf == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : osf.toShortString()));</span><br><span class="line"></span><br><span class="line">        win.computeFrameLw(pf, df, of, cf, vf, dcf, sf, osf, displayFrames.mDisplayCutout,</span><br><span class="line">                parentFrameWasClippedByDisplayCutout);</span><br><span class="line">        <span class="comment">// Dock windows carve out the bottom of the screen, so normal windows</span></span><br><span class="line">        <span class="comment">// can&#x27;t appear underneath them.</span></span><br><span class="line">        <span class="keyword">if</span> (type == TYPE_INPUT_METHOD &amp;&amp; win.isVisibleLw()</span><br><span class="line">                &amp;&amp; !win.getGivenInsetsPendingLw()) &#123;</span><br><span class="line">            setLastInputMethodWindowLw(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            offsetInputMethodWindowLw(win, displayFrames);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (type == TYPE_VOICE_INTERACTION &amp;&amp; win.isVisibleLw()</span><br><span class="line">                &amp;&amp; !win.getGivenInsetsPendingLw()) &#123;</span><br><span class="line">            offsetVoiceInputWindowLw(win, displayFrames);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="1-2-2-5、WindowState-computeFrameLw"><a href="#1-2-2-5、WindowState-computeFrameLw" class="headerlink" title="1.2.2.5、WindowState.computeFrameLw()"></a>1.2.2.5、WindowState.computeFrameLw()</h6><p>WindowState大小复杂计算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeFrameLw</span><span class="params">(Rect parentFrame, Rect displayFrame, Rect overscanFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect contentFrame, Rect visibleFrame, Rect decorFrame, Rect stableFrame,</span></span></span><br><span class="line"><span class="function"><span class="params">            Rect outsetFrame, WmDisplayCutout displayCutout,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> parentFrameWasClippedByDisplayCutout)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        mHaveFrame = <span class="keyword">true</span>;</span><br><span class="line">        mParentFrameWasClippedByDisplayCutout = parentFrameWasClippedByDisplayCutout;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Task task = getTask();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> inFullscreenContainer = inFullscreenContainer();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> windowsAreFloating = task != <span class="keyword">null</span> &amp;&amp; task.isFloating();</span><br><span class="line">        <span class="keyword">final</span> DisplayContent dc = getDisplayContent();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pw = mContainingFrame.width();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> ph = mContainingFrame.height();</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        mOverscanFrame.set(overscanFrame);</span><br><span class="line">        mContentFrame.set(contentFrame);</span><br><span class="line">        mVisibleFrame.set(visibleFrame);</span><br><span class="line">        mDecorFrame.set(decorFrame);</span><br><span class="line">        mStableFrame.set(stableFrame);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> hasOutsets = outsetFrame != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (hasOutsets) &#123;</span><br><span class="line">            mOutsetFrame.set(outsetFrame);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> fw = mFrame.width();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> fh = mFrame.height();</span><br><span class="line"></span><br><span class="line">        applyGravityAndUpdateFrame(layoutContainingFrame, layoutDisplayFrame);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (windowsAreFloating &amp;&amp; !mFrame.isEmpty()) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mContentFrame.set(Math.max(mContentFrame.left, mFrame.left),</span><br><span class="line">                    Math.max(mContentFrame.top, mFrame.top),</span><br><span class="line">                    Math.min(mContentFrame.right, mFrame.right),</span><br><span class="line">                    Math.min(mContentFrame.bottom, mFrame.bottom));</span><br><span class="line"></span><br><span class="line">            mVisibleFrame.set(Math.max(mVisibleFrame.left, mFrame.left),</span><br><span class="line">                    Math.max(mVisibleFrame.top, mFrame.top),</span><br><span class="line">                    Math.min(mVisibleFrame.right, mFrame.right),</span><br><span class="line">                    Math.min(mVisibleFrame.bottom, mFrame.bottom));</span><br><span class="line"></span><br><span class="line">            mStableFrame.set(Math.max(mStableFrame.left, mFrame.left),</span><br><span class="line">                    Math.max(mStableFrame.top, mFrame.top),</span><br><span class="line">                    Math.min(mStableFrame.right, mFrame.right),</span><br><span class="line">                    Math.min(mStableFrame.bottom, mFrame.bottom));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (mAttrs.type == TYPE_DOCK_DIVIDER) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            getDisplayContent().getBounds(mTmpRect);</span><br><span class="line">            <span class="comment">// Override right and/or bottom insets in case if the frame doesn&#x27;t fit the screen in</span></span><br><span class="line">            <span class="comment">// non-fullscreen mode.</span></span><br><span class="line">            <span class="keyword">boolean</span> overrideRightInset = !windowsAreFloating &amp;&amp; !inFullscreenContainer</span><br><span class="line">                    &amp;&amp; mFrame.right &gt; mTmpRect.right;</span><br><span class="line">            <span class="keyword">boolean</span> overrideBottomInset = !windowsAreFloating &amp;&amp; !inFullscreenContainer</span><br><span class="line">                    &amp;&amp; mFrame.bottom &gt; mTmpRect.bottom;</span><br><span class="line">            mContentInsets.set(mContentFrame.left - mFrame.left,</span><br><span class="line">                    mContentFrame.top - mFrame.top,</span><br><span class="line">                    overrideRightInset ? mTmpRect.right - mContentFrame.right</span><br><span class="line">                            : mFrame.right - mContentFrame.right,</span><br><span class="line">                    overrideBottomInset ? mTmpRect.bottom - mContentFrame.bottom</span><br><span class="line">                            : mFrame.bottom - mContentFrame.bottom);</span><br><span class="line"></span><br><span class="line">            mVisibleInsets.set(mVisibleFrame.left - mFrame.left,</span><br><span class="line">                    mVisibleFrame.top - mFrame.top,</span><br><span class="line">                    overrideRightInset ? mTmpRect.right - mVisibleFrame.right</span><br><span class="line">                            : mFrame.right - mVisibleFrame.right,</span><br><span class="line">                    overrideBottomInset ? mTmpRect.bottom - mVisibleFrame.bottom</span><br><span class="line">                            : mFrame.bottom - mVisibleFrame.bottom);</span><br><span class="line"></span><br><span class="line">            mStableInsets.set(Math.max(mStableFrame.left - mFrame.left, <span class="number">0</span>),</span><br><span class="line">                    Math.max(mStableFrame.top - mFrame.top, <span class="number">0</span>),</span><br><span class="line">                    overrideRightInset ? Math.max(mTmpRect.right - mStableFrame.right, <span class="number">0</span>)</span><br><span class="line">                            : Math.max(mFrame.right - mStableFrame.right, <span class="number">0</span>),</span><br><span class="line">                    overrideBottomInset ? Math.max(mTmpRect.bottom - mStableFrame.bottom, <span class="number">0</span>)</span><br><span class="line">                            :  Math.max(mFrame.bottom - mStableFrame.bottom, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDisplayCutout = displayCutout.calculateRelativeTo(mFrame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Offset the actual frame by the amount layout frame is off.</span></span><br><span class="line">        mFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">        mCompatFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">        mContentFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">        mVisibleFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line">        mStableFrame.offset(-layoutXDiff, -layoutYDiff);</span><br><span class="line"></span><br><span class="line">        mCompatFrame.set(mFrame);</span><br><span class="line">        ......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.002</span> V/WindowState( <span class="number">1049</span>): Resolving (mRequestedWidth=<span class="number">160</span>, mRequestedheight=<span class="number">854</span>) to (pw=<span class="number">160</span>, ph=<span class="number">854</span>): frame=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">160</span>,<span class="number">854</span>] ci=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">0</span>,<span class="number">0</span>] vi=[<span class="number">0</span>,<span class="number">36</span>][<span class="number">0</span>,<span class="number">72</span>] si=[<span class="number">0</span>,<span class="number">36</span>][<span class="number">0</span>,<span class="number">72</span>] of=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LAYOUT || localLOGV) Slog.v(TAG,</span><br><span class="line">                <span class="string">&quot;Resolving (mRequestedWidth=&quot;</span></span><br><span class="line">                + mRequestedWidth + <span class="string">&quot;, mRequestedheight=&quot;</span></span><br><span class="line">                + mRequestedHeight + <span class="string">&quot;) to&quot;</span> + <span class="string">&quot; (pw=&quot;</span> + pw + <span class="string">&quot;, ph=&quot;</span> + ph</span><br><span class="line">                + <span class="string">&quot;): frame=&quot;</span> + mFrame.toShortString()</span><br><span class="line">                + <span class="string">&quot; ci=&quot;</span> + mContentInsets.toShortString()</span><br><span class="line">                + <span class="string">&quot; vi=&quot;</span> + mVisibleInsets.toShortString()</span><br><span class="line">                + <span class="string">&quot; si=&quot;</span> + mStableInsets.toShortString()</span><br><span class="line">                + <span class="string">&quot; of=&quot;</span> + mOutsets.toShortString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>继续看看DisplayContent方法中的RootWindowContainer.performSurfacePlacement(recoveringMemory)</p>
<h5 id="1-2-3、surfacePlacer-handleAppTransitionReadyLocked"><a href="#1-2-3、surfacePlacer-handleAppTransitionReadyLocked" class="headerlink" title="1.2.3、surfacePlacer.handleAppTransitionReadyLocked()"></a>1.2.3、surfacePlacer.handleAppTransitionReadyLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowSurfacePlacer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">handleAppTransitionReadyLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> appsCount = mService.mOpeningApps.size();</span><br><span class="line">        <span class="keyword">if</span> (!transitionGoodToGo(appsCount, mTempTransitionReasons)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">transitionGoodToGo</span><span class="params">(<span class="keyword">int</span> appsCount, SparseIntArray outReasons)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_APP_TRANSITIONS) Slog.v(TAG,</span><br><span class="line">                <span class="string">&quot;Checking &quot;</span> + appsCount + <span class="string">&quot; opening apps (frozen=&quot;</span></span><br><span class="line">                        + mService.mDisplayFrozen + <span class="string">&quot; timeout=&quot;</span></span><br><span class="line">                        + mService.mAppTransition.isTimeout() + <span class="string">&quot;)...&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> ScreenRotationAnimation screenRotationAnimation =</span><br><span class="line">            mService.mAnimator.getScreenRotationAnimationLocked(</span><br><span class="line">                    Display.DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">        outReasons.clear();</span><br><span class="line">        <span class="keyword">if</span> (!mService.mAppTransition.isTimeout()) &#123;</span><br><span class="line">           ......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.009</span> V/WindowSurfacePlacer( <span class="number">1049</span>): Checking <span class="number">1</span> <span class="function">opening <span class="title">apps</span> <span class="params">(frozen=<span class="keyword">false</span> timeout=<span class="keyword">false</span>)</span>...</span></span><br><span class="line"><span class="function">04-16 13:08:37.009 V/<span class="title">WindowSurfacePlacer</span><span class="params">( <span class="number">1049</span>)</span>: Check opening app</span>=AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125;: allDrawn=<span class="keyword">false</span> startingDisplayed=<span class="keyword">false</span> startingMoved=<span class="function"><span class="keyword">false</span> <span class="title">isRelaunching</span><span class="params">()</span></span>=<span class="keyword">false</span> startingWindow=<span class="keyword">null</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; appsCount; i++) &#123;</span><br><span class="line">                AppWindowToken wtoken = mService.mOpeningApps.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_APP_TRANSITIONS) Slog.v(TAG,</span><br><span class="line">                        <span class="string">&quot;Check opening app=&quot;</span> + wtoken + <span class="string">&quot;: allDrawn=&quot;</span></span><br><span class="line">                        + wtoken.allDrawn + <span class="string">&quot; startingDisplayed=&quot;</span></span><br><span class="line">                        + wtoken.startingDisplayed + <span class="string">&quot; startingMoved=&quot;</span></span><br><span class="line">                        + wtoken.startingMoved + <span class="string">&quot; isRelaunching()=&quot;</span></span><br><span class="line">                        + wtoken.isRelaunching() + <span class="string">&quot; startingWindow=&quot;</span></span><br><span class="line">                        + wtoken.startingWindow);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> allDrawn = wtoken.allDrawn &amp;&amp; !wtoken.isRelaunching();</span><br><span class="line">                <span class="keyword">if</span> (!allDrawn &amp;&amp; !wtoken.startingDisplayed &amp;&amp; !wtoken.startingMoved) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> windowingMode = wtoken.getWindowingMode();</span><br><span class="line">                <span class="keyword">if</span> (allDrawn) &#123;</span><br><span class="line">                    outReasons.put(windowingMode,  APP_TRANSITION_WINDOWS_DRAWN);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outReasons.put(windowingMode,</span><br><span class="line">                            wtoken.startingData <span class="keyword">instanceof</span> SplashScreenStartingData</span><br><span class="line">                                    ? APP_TRANSITION_SPLASH_SCREEN</span><br><span class="line">                                    : APP_TRANSITION_SNAPSHOT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">           ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>根据前面分析可知道，现在App（com.android.testred）的大小和布局都处理好了，等待显示，但现在还么有mDrawState=NO_SURFACE ，肯定无法显示出来的，接下来看看Surface创建过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.007</span> V/AppWindowToken( <span class="number">1049</span>): Eval win Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: isDrawn=<span class="keyword">false</span>, isAnimationSet=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.007</span> V/AppWindowToken( <span class="number">1049</span>): Not displayed: s=<span class="keyword">null</span> pv=<span class="keyword">true</span> mDrawState=NO_SURFACE ph=<span class="keyword">false</span> th=<span class="keyword">false</span> a=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>继续看看WindowManagerService.relayoutWindow()</p>
<h5 id="（2）、Surface创建过程"><a href="#（2）、Surface创建过程" class="headerlink" title="（2）、Surface创建过程"></a>（2）、Surface创建过程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSurfaceControl</span><span class="params">(Surface outSurface, <span class="keyword">int</span> result, WindowState win,</span></span></span><br><span class="line"><span class="function"><span class="params">            WindowStateAnimator winAnimator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!win.mHasSurface) &#123;</span><br><span class="line">            result |= RELAYOUT_RES_SURFACE_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WindowSurfaceController surfaceController;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="string">&quot;createSurfaceControl&quot;</span>);</span><br><span class="line">            surfaceController = winAnimator.createSurfaceLocked(win.mAttrs.type, win.mOwnerUid);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (surfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">            surfaceController.getSurface(outSurface);</span><br><span class="line">            <span class="keyword">if</span> (SHOW_TRANSACTIONS) Slog.i(TAG_WM, <span class="string">&quot;  OUT SURFACE &quot;</span> + outSurface + <span class="string">&quot;: copied&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// For some reason there isn&#x27;t a surface.  Clear the</span></span><br><span class="line">            <span class="comment">// caller&#x27;s object so they see the same state.</span></span><br><span class="line">            Slog.w(TAG_WM, <span class="string">&quot;Failed to create surface control for &quot;</span> + win);</span><br><span class="line">            outSurface.release();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-1、winAnimator-createSurfaceLocked"><a href="#2-1、winAnimator-createSurfaceLocked" class="headerlink" title="2.1、winAnimator.createSurfaceLocked()"></a>2.1、winAnimator.createSurfaceLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowStateAnimator.java</span><br><span class="line"></span><br><span class="line">    <span class="function">WindowSurfaceController <span class="title">createSurfaceLocked</span><span class="params">(<span class="keyword">int</span> windowType, <span class="keyword">int</span> ownerUid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState w = mWin;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSurfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">        &#125;</span><br><span class="line">        mChildrenDetached = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((mWin.mAttrs.privateFlags &amp; PRIVATE_FLAG_IS_ROUNDED_CORNERS_OVERLAY) != <span class="number">0</span>) &#123;</span><br><span class="line">            windowType = SurfaceControl.WINDOW_TYPE_DONT_SCREENSHOT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        w.setHasSurface(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ANIM || DEBUG_ORIENTATION) Slog.i(TAG,</span><br><span class="line">                <span class="string">&quot;createSurface &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;: mDrawState=DRAW_PENDING&quot;</span>);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.010</span> I/WindowStateAnimator( <span class="number">1049</span>): createSurface WindowStateAnimator&#123;<span class="number">4f</span>b81c9 com.android.testred/com.android.testred.TestActivity&#125;: mDrawState=DRAW_PENDING</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        resetDrawState();</span><br><span class="line"></span><br><span class="line">        mService.makeWindowFreezingScreenIfNeededLocked(w);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> flags = SurfaceControl.HIDDEN;<span class="comment">//设置flags 为 HIDDEN</span></span><br><span class="line">        <span class="keyword">final</span> WindowManager.LayoutParams attrs = w.mAttrs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.isSecureLocked(w)) &#123;</span><br><span class="line">            flags |= SurfaceControl.SECURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mTmpSize.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//计算Surface大小</span></span><br><span class="line">        calculateSurfaceBounds(w, attrs);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> width = mTmpSize.width();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = mTmpSize.height();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_VISIBILITY) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">&quot;Creating surface in session &quot;</span></span><br><span class="line">                    + mSession.mSurfaceSession + <span class="string">&quot; window &quot;</span> + <span class="keyword">this</span></span><br><span class="line">                    + <span class="string">&quot; w=&quot;</span> + width + <span class="string">&quot; h=&quot;</span> + height</span><br><span class="line">                    + <span class="string">&quot; x=&quot;</span> + mTmpSize.left + <span class="string">&quot; y=&quot;</span> + mTmpSize.top</span><br><span class="line">                    + <span class="string">&quot; format=&quot;</span> + attrs.format + <span class="string">&quot; flags=&quot;</span> + flags);</span><br><span class="line">        &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.010</span> V/WindowStateAnimator( <span class="number">1049</span>): Creating surface in session android.view.SurfaceSession@<span class="number">3812e82</span> window WindowStateAnimator&#123;<span class="number">4f</span>b81c9 com.android.testred/com.android.testred.TestActivity&#125; w=<span class="number">160</span> h=<span class="number">854</span> x=<span class="number">0</span> y=<span class="number">0</span> format=-<span class="number">2</span> flags=<span class="number">4</span></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="comment">// We may abort, so initialize to defaults.</span></span><br><span class="line">        mLastClipRect.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up surface control with initial size.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isHwAccelerated = (attrs.flags &amp; FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> format = isHwAccelerated ? PixelFormat.TRANSLUCENT : attrs.format;</span><br><span class="line">            <span class="keyword">if</span> (!PixelFormat.formatHasAlpha(attrs.format)</span><br><span class="line">                    <span class="comment">// Don&#x27;t make surface with surfaceInsets opaque as they display a</span></span><br><span class="line">                    <span class="comment">// translucent shadow.</span></span><br><span class="line">                    &amp;&amp; attrs.surfaceInsets.left == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; attrs.surfaceInsets.top == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; attrs.surfaceInsets.right == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; attrs.surfaceInsets.bottom == <span class="number">0</span></span><br><span class="line">                    <span class="comment">// Don&#x27;t make surface opaque when resizing to reduce the amount of</span></span><br><span class="line">                    <span class="comment">// artifacts shown in areas the app isn&#x27;t drawing content to.</span></span><br><span class="line">                    &amp;&amp; !w.isDragResizing()) &#123;</span><br><span class="line">                flags |= SurfaceControl.OPAQUE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mSurfaceController = <span class="keyword">new</span> WindowSurfaceController(mSession.mSurfaceSession,</span><br><span class="line">                    attrs.getTitle().toString(), width, height, format, flags, <span class="keyword">this</span>,</span><br><span class="line">                    windowType, ownerUid);</span><br><span class="line"></span><br><span class="line">            setOffsetPositionForStackResize(<span class="keyword">false</span>);</span><br><span class="line">            mSurfaceFormat = format;</span><br><span class="line"></span><br><span class="line">            w.setHasSurface(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (SHOW_TRANSACTIONS || SHOW_SURFACE_ALLOC) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;  CREATE SURFACE &quot;</span></span><br><span class="line">                        + mSurfaceController + <span class="string">&quot; IN SESSION &quot;</span></span><br><span class="line">                        + mSession.mSurfaceSession</span><br><span class="line">                        + <span class="string">&quot;: pid=&quot;</span> + mSession.mPid + <span class="string">&quot; format=&quot;</span></span><br><span class="line">                        + attrs.format + <span class="string">&quot; flags=0x&quot;</span></span><br><span class="line">                        + Integer.toHexString(flags)</span><br><span class="line">                        + <span class="string">&quot; / &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> I/WindowStateAnimator( <span class="number">1049</span>):   <span class="function">CREATE SURFACE <span class="title">Surface</span><span class="params">(name=com.android.testred/com.android.testred.TestActivity)</span>/@0xb17b0ce IN SESSION android.view.SurfaceSession@3812e82: pid</span>=<span class="number">2602</span> format=-<span class="number">2</span> flags=<span class="number">0x4</span> / WindowStateAnimator&#123;<span class="number">4f</span>b81c9 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OutOfResourcesException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;OutOfResourcesException creating surface&quot;</span>);</span><br><span class="line">            mService.mRoot.reclaimSomeSurfaceMemory(<span class="keyword">this</span>, <span class="string">&quot;create&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">            mDrawState = NO_SURFACE;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;Exception creating surface (parent dead?)&quot;</span>, e);</span><br><span class="line">            mDrawState = NO_SURFACE;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(TAG, <span class="string">&quot;Got surface: &quot;</span> + mSurfaceController</span><br><span class="line">                + <span class="string">&quot;, set left=&quot;</span> + w.mFrame.left + <span class="string">&quot; top=&quot;</span> + w.mFrame.top</span><br><span class="line">                + <span class="string">&quot;, animLayer=&quot;</span> + mAnimLayer);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> V/WindowStateAnimator( <span class="number">1049</span>): Got surface: Surface(name=com.android.testred/com.android.testred.TestActivity)/@<span class="number">0xb17b0ce</span>, set left=<span class="number">0</span> top=<span class="number">0</span>, animLayer=<span class="number">0</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (SHOW_LIGHT_TRANSACTIONS) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;&gt;&gt;&gt; OPEN TRANSACTION createSurfaceLocked&quot;</span>);</span><br><span class="line">            WindowManagerService.logSurface(w, <span class="string">&quot;CREATE pos=(&quot;</span></span><br><span class="line">                    + w.mFrame.left + <span class="string">&quot;,&quot;</span> + w.mFrame.top + <span class="string">&quot;) (&quot;</span></span><br><span class="line">                    + width + <span class="string">&quot;x&quot;</span> + height + <span class="string">&quot;), layer=&quot;</span> + mAnimLayer + <span class="string">&quot; HIDE&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLastHidden = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(TAG, <span class="string">&quot;Created surface &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> I/WindowStateAnimator( <span class="number">1049</span>): &gt;&gt;&gt; OPEN TRANSACTION createSurfaceLocked</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> I/WindowManager( <span class="number">1049</span>):   SURFACE CREATE pos=(<span class="number">0</span>,<span class="number">0</span>) (<span class="number">160</span>x854), layer=<span class="number">0</span> HIDE: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> V/WindowStateAnimator( <span class="number">1049</span>): Created surface WindowStateAnimator&#123;<span class="number">4f</span>b81c9 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">return</span> mSurfaceController;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="2-1-1、new-WindowSurfaceController"><a href="#2-1-1、new-WindowSurfaceController" class="headerlink" title="2.1.1、new WindowSurfaceController()"></a>2.1.1、new WindowSurfaceController()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowSurfaceController.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WindowSurfaceController</span><span class="params">(SurfaceSession s, String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> flags, WindowStateAnimator animator, <span class="keyword">int</span> windowType, <span class="keyword">int</span> ownerUid)</span> </span>&#123;</span><br><span class="line">        mAnimator = animator;</span><br><span class="line"></span><br><span class="line">        mSurfaceW = w;</span><br><span class="line">        mSurfaceH = h;</span><br><span class="line"></span><br><span class="line">        title = name;</span><br><span class="line"></span><br><span class="line">        mService = animator.mService;</span><br><span class="line">        <span class="keyword">final</span> WindowState win = animator.mWin;</span><br><span class="line">        mWindowType = windowType;</span><br><span class="line">        mWindowSession = win.mSession;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="string">&quot;new SurfaceControl&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> SurfaceControl.Builder b = win.makeSurface()</span><br><span class="line">                .setParent(win.getSurfaceControl())</span><br><span class="line">                .setName(name)</span><br><span class="line">                .setSize(w, h)</span><br><span class="line">                .setFormat(format)</span><br><span class="line">                .setFlags(flags)</span><br><span class="line">                .setMetadata(windowType, ownerUid);</span><br><span class="line">        mSurfaceControl = b.build();</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-1-1-1、创建SurfaceControl-build"><a href="#2-1-1-1、创建SurfaceControl-build" class="headerlink" title="2.1.1.1、创建SurfaceControl build()"></a>2.1.1.1、创建SurfaceControl build()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\SurfaceControl.java</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SurfaceControl <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mWidth &lt;= <span class="number">0</span> || mHeight &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;width and height must be set&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SurfaceControl(mSession, mName, mWidth, mHeight, mFormat,</span><br><span class="line">                    mFlags, mParent, mWindowType, mOwnerUid);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-1-1-2、new-SurfaceControl"><a href="#2-1-1-2、new-SurfaceControl" class="headerlink" title="2.1.1.2、new SurfaceControl()"></a>2.1.1.2、new SurfaceControl()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a surface with a name.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * The surface creation flags specify what kind of surface to create and</span></span><br><span class="line"><span class="comment">     * certain options such as whether the surface can be assumed to be opaque</span></span><br><span class="line"><span class="comment">     * and whether it should be initially hidden.  Surfaces should always be</span></span><br><span class="line"><span class="comment">     * created with the &#123;<span class="doctag">@link</span> #HIDDEN&#125; flag set to ensure that they are not</span></span><br><span class="line"><span class="comment">     * made visible prematurely before all of the surface&#x27;s properties have been</span></span><br><span class="line"><span class="comment">     * configured.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Good practice is to first create the surface with the &#123;<span class="doctag">@link</span> #HIDDEN&#125; flag</span></span><br><span class="line"><span class="comment">     * specified, open a transaction, set the surface layer, layer stack, alpha,</span></span><br><span class="line"><span class="comment">     * and position, call &#123;<span class="doctag">@link</span> #show&#125; if appropriate, and close the transaction.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session The surface session, must not be null.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name The surface name, must not be null.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> w The surface initial width.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> h The surface initial height.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flags The surface creation flags.  Should always include &#123;<span class="doctag">@link</span> #HIDDEN&#125;</span></span><br><span class="line"><span class="comment">     * in the creation flags.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> windowType The type of the window as specified in WindowManager.java.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ownerUid A unique per-app ID.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> throws OutOfResourcesException If the SurfaceControl cannot be created.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SurfaceControl</span><span class="params">(SurfaceSession session, String name, <span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> format, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            SurfaceControl parent, <span class="keyword">int</span> windowType, <span class="keyword">int</span> ownerUid)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> OutOfResourcesException, IllegalArgumentException </span>&#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; SurfaceControl.HIDDEN) == <span class="number">0</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Surfaces should always be created with the HIDDEN flag set &quot;</span></span><br><span class="line">                    + <span class="string">&quot;to ensure that they are not made visible prematurely before &quot;</span></span><br><span class="line">                    + <span class="string">&quot;all of the surface&#x27;s properties have been configured.  &quot;</span></span><br><span class="line">                    + <span class="string">&quot;Set the other properties and make the surface visible within &quot;</span></span><br><span class="line">                    + <span class="string">&quot;a transaction.  New surface name: &quot;</span> + name,</span><br><span class="line">                    <span class="keyword">new</span> Throwable());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mName = name;</span><br><span class="line">        mWidth = w;</span><br><span class="line">        mHeight = h;</span><br><span class="line">        mNativeObject = nativeCreate(session, name, w, h, format, flags,</span><br><span class="line">            parent != <span class="keyword">null</span> ? parent.mNativeObject : <span class="number">0</span>, windowType, ownerUid);</span><br><span class="line">        ......</span><br><span class="line">        mCloseGuard.open(<span class="string">&quot;release&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\jni\android_view_SurfaceControl.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeCreate</span><span class="params">(JNIEnv* env, jclass clazz, jobject sessionObj,</span></span></span><br><span class="line"><span class="function"><span class="params">        jstring nameStr, jint w, jint h, jint format, jint flags, jlong parentObject,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint windowType, jint ownerUid)</span> </span>&#123;</span><br><span class="line">    <span class="function">ScopedUtfChars <span class="title">name</span><span class="params">(env, nameStr)</span></span>;</span><br><span class="line">    <span class="function">sp&lt;SurfaceComposerClient&gt; <span class="title">client</span><span class="params">(android_view_SurfaceSession_getClient(env, sessionObj)</span>)</span>;</span><br><span class="line">    SurfaceControl *parent = reinterpret_cast&lt;SurfaceControl*&gt;(parentObject);</span><br><span class="line">    sp&lt;SurfaceControl&gt; surface;</span><br><span class="line">    status_t err = client-&gt;createSurfaceChecked(</span><br><span class="line">            String8(name.c_str()), w, h, format, &amp;surface, flags, parent, windowType, ownerUid);</span><br><span class="line">    <span class="keyword">if</span> (err == NAME_NOT_FOUND) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalArgumentException&quot;</span>, NULL);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">        jniThrowException(env, OutOfResourcesException, NULL);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    surface-&gt;incStrong((<span class="keyword">void</span> *)nativeCreate);</span><br><span class="line">    <span class="keyword">return</span> reinterpret_cast&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数首先得到前面创建好的SurfaceComposerClient对象，通过该对象向SurfaceFlinger端的Client对象发送创建Surface的请求，最后得到一个SurfaceControl对象<br>看看createSurfaceChecked()函数实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\SurfaceComposerClient.cpp</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">SurfaceComposerClient::createSurfaceChecked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String8&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> w,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> h,</span></span></span><br><span class="line"><span class="function"><span class="params">        PixelFormat format,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;SurfaceControl&gt;* outSurface,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        SurfaceControl* parent,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int32_t</span> windowType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int32_t</span> ownerUid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;SurfaceControl&gt; sur;</span><br><span class="line">    <span class="keyword">status_t</span> err = mStatus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStatus == NO_ERROR) &#123;</span><br><span class="line">        sp&lt;IBinder&gt; handle;</span><br><span class="line">        sp&lt;IBinder&gt; parentHandle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt; gbp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            parentHandle = parent-&gt;getHandle();</span><br><span class="line">        &#125;</span><br><span class="line">        err = mClient-&gt;createSurface(name, w, h, format, flags, parentHandle,</span><br><span class="line">                windowType, ownerUid, &amp;handle, &amp;gbp);</span><br><span class="line">        ALOGE_IF(err, <span class="string">&quot;SurfaceComposerClient::createSurface error %s&quot;</span>, strerror(-err));</span><br><span class="line">        <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">            *outSurface = <span class="keyword">new</span> SurfaceControl(<span class="keyword">this</span>, handle, gbp, <span class="literal">true</span> <span class="comment">/* owned */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\SurfaceControl.cpp</span><br><span class="line">SurfaceControl::SurfaceControl(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;SurfaceComposerClient&gt;&amp; client,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; handle,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; gbp,</span><br><span class="line">        <span class="keyword">bool</span> owned)</span><br><span class="line">    : mClient(client), mHandle(handle), mGraphicBufferProducer(gbp), mOwned(owned)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>SurfaceComposerClient将Surface创建请求转交给保存在其成员变量中的Bp SurfaceComposerClient对象来完成，在SurfaceFlinger端的Client本地对象会返回一个ISurface代理对象给应用程序，通过该代理对象为应用程序当前创建的Surface创建一个SurfaceControl对象。 [ISurfaceComposerClient.cpp]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\ISurfaceComposerClient.cpp</span><br><span class="line">    <span class="function"><span class="keyword">status_t</span> <span class="title">createSurface</span><span class="params">(<span class="keyword">const</span> String8&amp; name, <span class="keyword">uint32_t</span> width, <span class="keyword">uint32_t</span> height, PixelFormat format,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">uint32_t</span> flags, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; parent, <span class="keyword">int32_t</span> windowType,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">int32_t</span> ownerUid, sp&lt;IBinder&gt;* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">                           sp&lt;IGraphicBufferProducer&gt;* gbp)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> callRemote&lt;<span class="keyword">decltype</span>(&amp;ISurfaceComposerClient::createSurface)&gt;(Tag::CREATE_SURFACE,</span><br><span class="line">                                                                            name, width, height,</span><br><span class="line">                                                                            format, flags, parent,</span><br><span class="line">                                                                            windowType, ownerUid,</span><br><span class="line">                                                                            handle, gbp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h6 id="2-1-1-3、Client-gt-createSurface"><a href="#2-1-1-3、Client-gt-createSurface" class="headerlink" title="2.1.1.3、Client-&gt;createSurface()"></a>2.1.1.3、Client-&gt;createSurface()</h6><p>MessageCreateSurface消息是专门为应用程序请求创建Surface而定义的一种消息类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\Client.cpp</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Client::createSurface</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String8&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; parentHandle, <span class="keyword">int32_t</span> windowType, <span class="keyword">int32_t</span> ownerUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IBinder&gt;* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IGraphicBufferProducer&gt;* gbp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;Layer&gt; parent = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (parentHandle != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">auto</span> layerHandle = <span class="keyword">reinterpret_cast</span>&lt;Layer::Handle*&gt;(parentHandle.get());</span><br><span class="line">        parent = layerHandle-&gt;owner.promote();</span><br><span class="line">        <span class="keyword">if</span> (parent == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NAME_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parent == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">bool</span> parentDied;</span><br><span class="line">        parent = getParentLayer(&amp;parentDied);</span><br><span class="line">        <span class="comment">// If we had a parent, but it died, we&#x27;ve lost all</span></span><br><span class="line">        <span class="comment">// our capabilities.</span></span><br><span class="line">        <span class="keyword">if</span> (parentDied) &#123;</span><br><span class="line">            <span class="keyword">return</span> NAME_NOT_FOUND;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * createSurface must be called from the GL thread so that it can</span></span><br><span class="line"><span class="comment">     * have access to the GL context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MessageCreateLayer</span> :</span> <span class="keyword">public</span> MessageBase &#123;</span><br><span class="line">        SurfaceFlinger* flinger;</span><br><span class="line">        Client* client;</span><br><span class="line">        sp&lt;IBinder&gt;* handle;</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp;</span><br><span class="line">        <span class="keyword">status_t</span> result;</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name;</span><br><span class="line">        <span class="keyword">uint32_t</span> w, h;</span><br><span class="line">        PixelFormat format;</span><br><span class="line">        <span class="keyword">uint32_t</span> flags;</span><br><span class="line">        sp&lt;Layer&gt;* parent;</span><br><span class="line">        <span class="keyword">int32_t</span> windowType;</span><br><span class="line">        <span class="keyword">int32_t</span> ownerUid;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        MessageCreateLayer(SurfaceFlinger* flinger,</span><br><span class="line">                <span class="keyword">const</span> String8&amp; name, Client* client,</span><br><span class="line">                <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span><br><span class="line">                sp&lt;IBinder&gt;* handle, <span class="keyword">int32_t</span> windowType, <span class="keyword">int32_t</span> ownerUid,</span><br><span class="line">                sp&lt;IGraphicBufferProducer&gt;* gbp,</span><br><span class="line">                sp&lt;Layer&gt;* parent)</span><br><span class="line">            : flinger(flinger), client(client),</span><br><span class="line">              handle(handle), gbp(gbp), result(NO_ERROR),</span><br><span class="line">              name(name), w(w), h(h), format(format), flags(flags),</span><br><span class="line">              parent(parent), windowType(windowType), ownerUid(ownerUid) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">status_t</span> <span class="title">getResult</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> result; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">handler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            result = flinger-&gt;createLayer(name, client, w, h, format, flags,</span><br><span class="line">                    windowType, ownerUid, handle, gbp, parent);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageBase&gt; msg = <span class="keyword">new</span> MessageCreateLayer(mFlinger.get(),</span><br><span class="line">            name, <span class="keyword">this</span>, w, h, format, flags, handle,</span><br><span class="line">            windowType, ownerUid, gbp, &amp;parent);</span><br><span class="line">    mFlinger-&gt;postMessageSync(msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;MessageCreateLayer*&gt;( msg.get() )-&gt;getResult();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>SurfaceFlinger根据标志位创建对应类型的Surface，当前系统定义了2种类型的Layer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\<span class="keyword">native</span>\libs\gui\include\gui\ISurfaceComposerClient.h</span><br><span class="line"></span><br><span class="line">        eFXSurfaceNormal = <span class="number">0x00000000</span>,<span class="comment">//正常surface</span></span><br><span class="line">        eFXSurfaceColor = <span class="number">0x00020000</span>,<span class="comment">//只有颜色数据surface</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\SurfaceFlinger.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">SurfaceFlinger::createLayer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String8&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, PixelFormat format, <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int32_t</span> windowType, <span class="keyword">int32_t</span> ownerUid, sp&lt;IBinder&gt;* handle,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">int32_t</span>(w|h) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;createLayer() failed, w or h is negative (w=%d, h=%d)&quot;</span>,</span><br><span class="line">                <span class="keyword">int</span>(w), <span class="keyword">int</span>(h));</span><br><span class="line">        <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line"></span><br><span class="line">    sp&lt;Layer&gt; layer;</span><br><span class="line"></span><br><span class="line">    String8 uniqueName = getUniqueLayerName(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (flags &amp; ISurfaceComposerClient::eFXSurfaceMask) &#123;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceNormal:</span><br><span class="line">            result = createBufferLayer(client,</span><br><span class="line">                    uniqueName, w, h, flags, format,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ISurfaceComposerClient::eFXSurfaceColor:</span><br><span class="line">            result = createColorLayer(client,</span><br><span class="line">                    uniqueName, w, h, flags,</span><br><span class="line">                    handle, &amp;layer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = BAD_VALUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// window type is WINDOW_TYPE_DONT_SCREENSHOT from SurfaceControl.java</span></span><br><span class="line">    <span class="comment">// TODO b/64227542</span></span><br><span class="line">    <span class="keyword">if</span> (windowType == <span class="number">441731</span>) &#123;</span><br><span class="line">        windowType = <span class="number">2024</span>; <span class="comment">// TYPE_NAVIGATION_BAR_PANEL</span></span><br><span class="line">        layer-&gt;setPrimaryDisplayOnly();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    layer-&gt;setInfo(windowType, ownerUid);</span><br><span class="line"></span><br><span class="line">    result = addClientLayer(client, *handle, *gbp, layer, *parent);</span><br><span class="line">    <span class="keyword">if</span> (result != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    mInterceptor-&gt;saveSurfaceCreation(layer);</span><br><span class="line"></span><br><span class="line">    setTransactionFlags(eTransactionNeeded);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有前面java层可知flags = SurfaceControl.HIDDEN，flags &amp; ISurfaceComposerClient::eFXSurfaceMask == eFXSurfaceNormal = 0x00000000，所以此外走createBufferLayer()分支</p>
<h6 id="2-1-1-4、createBufferLayer"><a href="#2-1-1-4、createBufferLayer" class="headerlink" title="2.1.1.4、createBufferLayer()"></a>2.1.1.4、createBufferLayer()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\<span class="keyword">native</span>\services\surfaceflinger\SurfaceFlinger.cpp</span><br><span class="line"></span><br><span class="line">status_t SurfaceFlinger::createBufferLayer(<span class="keyword">const</span> sp&lt;Client&gt;&amp; client,</span><br><span class="line">        <span class="keyword">const</span> String8&amp; name, uint32_t w, uint32_t h, uint32_t flags, PixelFormat&amp; format,</span><br><span class="line">        sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* outLayer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// initialize the surfaces</span></span><br><span class="line">    <span class="keyword">switch</span> (format) &#123;</span><br><span class="line">    <span class="keyword">case</span> PIXEL_FORMAT_TRANSPARENT:</span><br><span class="line">    <span class="keyword">case</span> PIXEL_FORMAT_TRANSLUCENT:</span><br><span class="line">        format = PIXEL_FORMAT_RGBA_8888;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PIXEL_FORMAT_OPAQUE:</span><br><span class="line">        format = PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;BufferLayer&gt; layer = DisplayUtils::getInstance()-&gt;getBufferLayerInstance(</span><br><span class="line">                            <span class="keyword">this</span>, client, name, w, h, flags);</span><br><span class="line">    status_t err = layer-&gt;setBuffers(w, h, format, flags);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line">status_t BufferLayer::setBuffers(uint32_t w, uint32_t h, PixelFormat format, uint32_t flags) &#123;</span><br><span class="line">    uint32_t <span class="keyword">const</span> maxSurfaceDims =</span><br><span class="line">            min(mFlinger-&gt;getMaxTextureSize(), mFlinger-&gt;getMaxViewportDims());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// never allow a surface larger than what our underlying GL implementation</span></span><br><span class="line">    <span class="comment">// can handle.</span></span><br><span class="line">    <span class="keyword">if</span> ((uint32_t(w) &gt; maxSurfaceDims) || (uint32_t(h) &gt; maxSurfaceDims)) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;dimensions too large %u x %u&quot;</span>, uint32_t(w), uint32_t(h));</span><br><span class="line">        <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mFormat = format;</span><br><span class="line"></span><br><span class="line">    mPotentialCursor = (flags &amp; ISurfaceComposerClient::eCursorWindow) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    mProtectedByApp = (flags &amp; ISurfaceComposerClient::eProtectedByApp) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    mCurrentOpacity = getOpacityForFormat(format);</span><br><span class="line"></span><br><span class="line">    mConsumer-&gt;setDefaultBufferSize(w, h);</span><br><span class="line">    mConsumer-&gt;setDefaultBufferFormat(format);</span><br><span class="line">    mConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">04-16 13:08:37.011 V/BufferQueueConsumer(  739): [com.android.testred/com.android.testred.TestActivity#0] setDefaultBufferSize: width=160 height=854</span><br><span class="line">04-16 13:08:37.011 V/BufferQueueConsumer(  739): [com.android.testred/com.android.testred.TestActivity#0] setDefaultBufferFormat: 1</span><br><span class="line">04-16 13:08:37.011 V/BufferQueueConsumer(  739): [com.android.testred/com.android.testred.TestActivity#0] setConsumerUsageBits: 0x900</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</span><br><span class="line">        *handle = layer-&gt;getHandle();</span><br><span class="line">        *gbp = layer-&gt;getProducer();</span><br><span class="line">        *outLayer = layer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ALOGE_IF(err, <span class="string">&quot;createBufferLayer() failed (%s)&quot;</span>, strerror(-err));</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="2-1-1-5、DisplayUtils-getInstance-gt-getBufferLayerInstance"><a href="#2-1-1-5、DisplayUtils-getInstance-gt-getBufferLayerInstance" class="headerlink" title="2.1.1.5、DisplayUtils::getInstance()-&gt;getBufferLayerInstance()"></a>2.1.1.5、DisplayUtils::getInstance()-&gt;getBufferLayerInstance()</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\DisplayUtils.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">BufferLayer* <span class="title">DisplayUtils::getBufferLayerInstance</span><span class="params">(SurfaceFlinger* flinger,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> sp&lt;Client&gt;&amp; client, <span class="keyword">const</span> String8&amp; name,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sUseExtendedImpls) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExBufferLayer(flinger, client, name, w, h, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferLayer(flinger, client, name, w, h, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-1-1-6、new-BufferLayer"><a href="#2-1-1-6、new-BufferLayer" class="headerlink" title="2.1.1.6、new BufferLayer()"></a>2.1.1.6、new BufferLayer()</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\BufferLayer.cpp</span><br><span class="line"></span><br><span class="line">BufferLayer::BufferLayer(SurfaceFlinger* flinger, <span class="keyword">const</span> sp&lt;Client&gt;&amp; client, <span class="keyword">const</span> String8&amp; name,</span><br><span class="line">                         <span class="keyword">uint32_t</span> w, <span class="keyword">uint32_t</span> h, <span class="keyword">uint32_t</span> flags)</span><br><span class="line">      : Layer(flinger, client, name, w, h, flags),</span><br><span class="line">        mConsumer(<span class="literal">nullptr</span>),</span><br><span class="line">        mTextureName(UINT32_MAX),</span><br><span class="line">        mFormat(PIXEL_FORMAT_NONE),</span><br><span class="line">        mCurrentScalingMode(NATIVE_WINDOW_SCALING_MODE_FREEZE),</span><br><span class="line">        mBufferLatched(<span class="literal">false</span>),</span><br><span class="line">        mPreviousFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mUpdateTexImageFailed(<span class="literal">false</span>),</span><br><span class="line">        mRefreshPending(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGV(<span class="string">&quot;Creating Layer %s&quot;</span>, name.<span class="built_in">string</span>());</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferLayer(  <span class="number">739</span>): Creating Layer com.android.testred/com.android.testred.TestActivity#<span class="number">0</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    <span class="comment">//生成Textures并初始化</span></span><br><span class="line">    mFlinger-&gt;getRenderEngine().genTextures(<span class="number">1</span>, &amp;mTextureName);</span><br><span class="line">    mTexture.init(Texture::TEXTURE_EXTERNAL, mTextureName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; ISurfaceComposerClient::eNonPremultiplied) mPremultipliedAlpha = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    mCurrentState.requested = mCurrentState.active;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// drawing state &amp; current state are identical</span></span><br><span class="line">    mDrawingState = mCurrentState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>回到SurfaceComposerClient.cpp中<br>继续看看，根据回传的 sp<IBinder> handle和 sp<IGraphicBufferProducer> gbp 创建SurfaceControl<br><em>outSurface = new SurfaceControl(this, handle, gbp, true /</em> owned */)</p>
<p>然后android_view_SurfaceControl.cpp nativeCreate()函数中将 reinterpret_cast<jlong>(surface.get()) 的地址返回给Java层。</p>
<h6 id="2-1-1-7、BufferLayer-gt-onFirstRef"><a href="#2-1-1-7、BufferLayer-gt-onFirstRef" class="headerlink" title="2.1.1.7、BufferLayer-&gt;onFirstRef()"></a>2.1.1.7、BufferLayer-&gt;onFirstRef()</h6><p>第一次强引用Layer对象时，onFirstRef()函数被回调 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\BufferLayer.cpp</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BufferLayer::onFirstRef</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Creates a custom BufferQueue for SurfaceFlingerConsumer to use</span></span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">    sp&lt;IGraphicBufferConsumer&gt; consumer;</span><br><span class="line">    BufferQueue::createBufferQueue(&amp;producer, &amp;consumer, <span class="literal">true</span>);</span><br><span class="line">    mProducer = <span class="keyword">new</span> MonitoredProducer(producer, mFlinger, <span class="keyword">this</span>);</span><br><span class="line">    mConsumer = <span class="keyword">new</span> BufferLayerConsumer(consumer,</span><br><span class="line">            mFlinger-&gt;getRenderEngine(), mTextureName, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferQueueConsumer(  <span class="number">739</span>): [unnamed<span class="number">-739</span><span class="number">-40</span>] setConsumerUsageBits: <span class="number">0x900</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/ConsumerBase(  <span class="number">739</span>): [unnamed<span class="number">-739</span><span class="number">-40</span>] setFrameAvailableListener</span><br><span class="line">04-16 13:08:37.011 V/BufferQueueConsumer(  739): [unnamed-739-40] setConsumerName: &#x27;com.android.testred/com.android.testred.TestActivity#0&#x27;</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferQueueProducer(  <span class="number">739</span>): [] setMaxDequeuedBufferCount: maxDequeuedBuffers = <span class="number">2</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    mConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(<span class="number">0</span>));</span><br><span class="line">    mConsumer-&gt;setContentsChangedListener(<span class="keyword">this</span>);</span><br><span class="line">    mConsumer-&gt;setName(mName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFlinger-&gt;isLayerTripleBufferingDisabled()) &#123;</span><br><span class="line">        mProducer-&gt;setMaxDequeuedBufferCount(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">const</span> sp&lt;<span class="keyword">const</span> DisplayDevice&gt; <span class="title">hw</span><span class="params">(mFlinger-&gt;getDefaultDisplayDevice())</span></span>;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferQueueConsumer(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] setTransformHint: <span class="number">0</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    updateTransformHint(hw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.SurfaceFlinger-ConsumeLisener-onFrameAvailable.png" alt="enter image description here"> </p>
<h6 id="2-1-1-8、BufferQueue-createBufferQueue"><a href="#2-1-1-8、BufferQueue-createBufferQueue" class="headerlink" title="2.1.1.8、BufferQueue::createBufferQueue()"></a>2.1.1.8、BufferQueue::createBufferQueue()</h6><p>所以核心都是这个BufferQueueCore，他是管理图形缓冲区的中枢。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\BufferQueue.cpp</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BufferQueue::createBufferQueue</span><span class="params">(sp&lt;IGraphicBufferProducer&gt;* outProducer,</span></span></span><br><span class="line"><span class="function"><span class="params">        sp&lt;IGraphicBufferConsumer&gt;* outConsumer,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">bool</span> consumerIsSurfaceFlinger)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="function">sp&lt;BufferQueueCore&gt; <span class="title">core</span><span class="params">(<span class="keyword">new</span> BufferQueueCore())</span></span>;</span><br><span class="line">    <span class="function">sp&lt;IGraphicBufferProducer&gt; <span class="title">producer</span><span class="params">(<span class="keyword">new</span> BufferQueueProducer(core, consumerIsSurfaceFlinger))</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">sp&lt;IGraphicBufferConsumer&gt; <span class="title">consumer</span><span class="params">(<span class="keyword">new</span> BufferQueueConsumer(core))</span></span>;</span><br><span class="line">    *outProducer = producer;</span><br><span class="line">    *outConsumer = consumer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\BufferQueueCore.cpp</span><br><span class="line">BufferQueueCore::BufferQueueCore() :</span><br><span class="line">    ......</span><br><span class="line">    mUniqueId(getUniqueId())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> numStartingBuffers = getMaxBufferCountLocked();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; numStartingBuffers; s++) &#123;</span><br><span class="line">        mFreeSlots.insert(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//static constexpr int NUM_BUFFER_SLOTS = 64;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> s = numStartingBuffers; s &lt; BufferQueueDefs::NUM_BUFFER_SLOTS;</span><br><span class="line">            s++) &#123;</span><br><span class="line">        mUnusedSlots.push_front(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="2-1-1-9、new-BufferLayerConsumer"><a href="#2-1-1-9、new-BufferLayerConsumer" class="headerlink" title="2.1.1.9、new BufferLayerConsumer()"></a>2.1.1.9、new BufferLayerConsumer()</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\services\surfaceflinger\BufferLayerConsumer.cpp</span><br><span class="line"></span><br><span class="line">BufferLayerConsumer::BufferLayerConsumer(<span class="keyword">const</span> sp&lt;IGraphicBufferConsumer&gt;&amp; bq,</span><br><span class="line">                                         RE::RenderEngine&amp; engine, <span class="keyword">uint32_t</span> tex, Layer* layer)</span><br><span class="line">      : ConsumerBase(bq, <span class="literal">false</span>),</span><br><span class="line">        mCurrentCrop(Rect::EMPTY_RECT),</span><br><span class="line">        mCurrentTransform(<span class="number">0</span>),</span><br><span class="line">        mCurrentScalingMode(NATIVE_WINDOW_SCALING_MODE_FREEZE),</span><br><span class="line">        mCurrentFence(Fence::NO_FENCE),</span><br><span class="line">        mCurrentTimestamp(<span class="number">0</span>),</span><br><span class="line">        mCurrentDataSpace(ui::Dataspace::UNKNOWN),</span><br><span class="line">        mCurrentFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mCurrentTransformToDisplayInverse(<span class="literal">false</span>),</span><br><span class="line">        mCurrentSurfaceDamage(),</span><br><span class="line">        mCurrentApi(<span class="number">0</span>),</span><br><span class="line">        mDefaultWidth(<span class="number">1</span>),</span><br><span class="line">        mDefaultHeight(<span class="number">1</span>),</span><br><span class="line">        mFilteringEnabled(<span class="literal">true</span>),</span><br><span class="line">        mRE(engine),</span><br><span class="line">        mTexName(tex),</span><br><span class="line">        mLayer(layer),</span><br><span class="line">        mCurrentTexture(BufferQueue::INVALID_BUFFER_SLOT) &#123;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferLayerConsumer(  <span class="number">739</span>): [unnamed<span class="number">-739</span><span class="number">-40</span>] BufferLayerConsumer</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    BLC_LOGV(<span class="string">&quot;BufferLayerConsumer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(mCurrentTransformMatrix, mtxIdentity.asArray(), <span class="keyword">sizeof</span>(mCurrentTransformMatrix));</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferQueueConsumer(  <span class="number">739</span>): [unnamed<span class="number">-739</span><span class="number">-40</span>] setConsumerUsageBits: <span class="number">0x100</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">    mConsumer-&gt;setConsumerUsageBits(DEFAULT_USAGE_FLAGS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>BufferLayerConsumer会首先初始化ConsumerBase</p>
<h6 id="2-1-1-10、ConsumerBase"><a href="#2-1-1-10、ConsumerBase" class="headerlink" title="2.1.1.10、ConsumerBase()"></a>2.1.1.10、ConsumerBase()</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\ConsumerBase.cpp</span><br><span class="line"></span><br><span class="line">ConsumerBase::ConsumerBase(<span class="keyword">const</span> sp&lt;IGraphicBufferConsumer&gt;&amp; bufferQueue, <span class="keyword">bool</span> controlledByApp) :</span><br><span class="line">        mAbandoned(<span class="literal">false</span>),</span><br><span class="line">        mConsumer(bufferQueue),</span><br><span class="line">        mPrevFinalReleaseFence(Fence::NO_FENCE) &#123;</span><br><span class="line">    <span class="comment">// Choose a name using the PID and a process-unique ID.</span></span><br><span class="line">    mName = String8::format(<span class="string">&quot;unnamed-%d-%d&quot;</span>, getpid(), createProcessUniqueId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that we can&#x27;t create an sp&lt;...&gt;(this) in a ctor that will not keep a</span></span><br><span class="line">    <span class="comment">// reference once the ctor ends, as that would cause the refcount of &#x27;this&#x27;</span></span><br><span class="line">    <span class="comment">// dropping to 0 at the end of the ctor.  Since all we need is a wp&lt;...&gt;</span></span><br><span class="line">    <span class="comment">// that&#x27;s what we create.</span></span><br><span class="line">    wp&lt;ConsumerListener&gt; listener = <span class="keyword">static_cast</span>&lt;ConsumerListener*&gt;(<span class="keyword">this</span>);</span><br><span class="line">    sp&lt;IConsumerListener&gt; proxy = <span class="keyword">new</span> BufferQueue::ProxyConsumerListener(listener);</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.011</span> V/BufferQueueConsumer(  <span class="number">739</span>): [] connect: controlledByApp=<span class="literal">false</span></span><br><span class="line">04-16 13:08:37.011 V/BufferQueueConsumer(  739): [] setConsumerName: &#x27;unnamed-739-40&#x27;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = mConsumer-&gt;consumerConnect(proxy, controlledByApp);</span><br><span class="line">    <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">        CB_LOGE(<span class="string">&quot;ConsumerBase: error connecting to BufferQueue: %s (%d)&quot;</span>,</span><br><span class="line">                strerror(-err), err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mConsumer-&gt;setConsumerName(mName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.consumerbase.png" alt="enter image description here"> </p>
<h5 id="2-2、winAnimator-createSurfaceLocked"><a href="#2-2、winAnimator-createSurfaceLocked" class="headerlink" title="2.2、winAnimator.createSurfaceLocked()"></a>2.2、winAnimator.createSurfaceLocked()</h5><p>饶了一大圈，现在Surface创建好了，现象看看如何传回App进程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSurfaceControl</span><span class="params">(Surface outSurface, <span class="keyword">int</span> result, WindowState win,</span></span></span><br><span class="line"><span class="function"><span class="params">        WindowStateAnimator winAnimator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!win.mHasSurface) &#123;</span><br><span class="line">        result |= RELAYOUT_RES_SURFACE_CHANGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WindowSurfaceController surfaceController;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="string">&quot;createSurfaceControl&quot;</span>);</span><br><span class="line">        surfaceController = winAnimator.createSurfaceLocked(win.mAttrs.type, win.mOwnerUid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (surfaceController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        surfaceController.getSurface(outSurface);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> I/WindowManager( <span class="number">1049</span>):   <span class="function">OUT SURFACE <span class="title">Surface</span><span class="params">(name=<span class="keyword">null</span>)</span>/@0xe493bef: copied</span></span><br><span class="line"><span class="function">----------------------------------------------------------------</span></span><br><span class="line"><span class="function">        <span class="title">if</span> <span class="params">(SHOW_TRANSACTIONS)</span> Slog.<span class="title">i</span><span class="params">(TAG_WM, <span class="string">&quot;  OUT SURFACE &quot;</span> + outSurface + <span class="string">&quot;: copied&quot;</span>)</span></span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// For some reason there isn&#x27;t a surface.  Clear the</span></span><br><span class="line">        <span class="comment">// caller&#x27;s object so they see the same state.</span></span><br><span class="line">        Slog.w(TAG_WM, <span class="string">&quot;Failed to create surface control for &quot;</span> + win);</span><br><span class="line">        outSurface.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-1、surfaceController-getSurface-outSurface"><a href="#2-2-1、surfaceController-getSurface-outSurface" class="headerlink" title="2.2.1、surfaceController.getSurface(outSurface)"></a>2.2.1、surfaceController.getSurface(outSurface)</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowSurfaceController.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getSurface</span><span class="params">(Surface outSurface)</span> </span>&#123;</span><br><span class="line">    outSurface.copyFrom(mSurfaceControl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="2-2-2、outSurface-copyFrom-mSurfaceControl"><a href="#2-2-2、outSurface-copyFrom-mSurfaceControl" class="headerlink" title="2.2.2、outSurface.copyFrom(mSurfaceControl)"></a>2.2.2、outSurface.copyFrom(mSurfaceControl)</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\android\view\Surface.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyFrom</span><span class="params">(SurfaceControl other)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">long</span> surfaceControlPtr = other.mNativeObject;</span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">long</span> newNativeObject = nativeGetFromSurfaceControl(surfaceControlPtr);</span><br><span class="line"></span><br><span class="line">        synchronized (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mNativeObject != <span class="number">0</span>) &#123;</span><br><span class="line">                nativeRelease(mNativeObject);</span><br><span class="line">            &#125;</span><br><span class="line">            setNativeObjectLocked(newNativeObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="2-2-3、nativeGetFromSurfaceControl"><a href="#2-2-3、nativeGetFromSurfaceControl" class="headerlink" title="2.2.3、nativeGetFromSurfaceControl()"></a>2.2.3、nativeGetFromSurfaceControl()</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\android_view_Surface.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeGetFromSurfaceControl</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong surfaceControlNativeObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This is used by the WindowManagerService just after constructing</span></span><br><span class="line"><span class="comment">     * a Surface and is necessary for returning the Surface reference to</span></span><br><span class="line"><span class="comment">     * the caller. At this point, we should only have a SurfaceControl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function">sp&lt;SurfaceControl&gt; <span class="title">ctrl</span><span class="params">(<span class="keyword">reinterpret_cast</span>&lt;SurfaceControl *&gt;(surfaceControlNativeObj))</span></span>;</span><br><span class="line">    <span class="function">sp&lt;Surface&gt; <span class="title">surface</span><span class="params">(ctrl-&gt;getSurface())</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        surface-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\native\libs\gui\SurfaceControl.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;Surface&gt; <span class="title">SurfaceControl::generateSurfaceLocked</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// This surface is always consumed by SurfaceFlinger, so the</span></span><br><span class="line">    <span class="comment">// producerControlledByApp value doesn&#x27;t matter; using false.</span></span><br><span class="line">    mSurfaceData = <span class="keyword">new</span> Surface(mGraphicBufferProducer, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;Surface&gt; <span class="title">SurfaceControl::getSurface</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    <span class="keyword">if</span> (mSurfaceData == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> generateSurfaceLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mSurfaceData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h6 id="2-2-4、Nativie-Surface创建过程"><a href="#2-2-4、Nativie-Surface创建过程" class="headerlink" title="2.2.4、Nativie Surface创建过程"></a>2.2.4、Nativie Surface创建过程</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Surface::Surface(<span class="keyword">const</span> sp&lt;IGraphicBufferProducer&gt;&amp; bufferProducer, <span class="keyword">bool</span> controlledByApp)</span><br><span class="line">      : mGraphicBufferProducer(bufferProducer),</span><br><span class="line">        mCrop(Rect::EMPTY_RECT),</span><br><span class="line">        mBufferAge(<span class="number">0</span>),</span><br><span class="line">        mGenerationNumber(<span class="number">0</span>),</span><br><span class="line">        mSharedBufferMode(<span class="literal">false</span>),</span><br><span class="line">        mAutoRefresh(<span class="literal">false</span>),</span><br><span class="line">        mSharedBufferSlot(BufferItem::INVALID_BUFFER_SLOT),</span><br><span class="line">        mSharedBufferHasBeenQueued(<span class="literal">false</span>),</span><br><span class="line">        mQueriedSupportedTimestamps(<span class="literal">false</span>),</span><br><span class="line">        mFrameTimestampsSupportsPresent(<span class="literal">false</span>),</span><br><span class="line">        mEnableFrameTimestamps(<span class="literal">false</span>),</span><br><span class="line">        mFrameEventHistory(<span class="built_in">std</span>::make_unique&lt;ProducerFrameEventHistory&gt;()) &#123;</span><br><span class="line">    <span class="comment">// Initialize the ANativeWindow function pointers.</span></span><br><span class="line">    ANativeWindow::setSwapInterval  = hook_setSwapInterval;</span><br><span class="line">    ANativeWindow::dequeueBuffer    = hook_dequeueBuffer;</span><br><span class="line">    ANativeWindow::cancelBuffer     = hook_cancelBuffer;</span><br><span class="line">    ANativeWindow::queueBuffer      = hook_queueBuffer;</span><br><span class="line">    ANativeWindow::query            = hook_query;</span><br><span class="line">    ANativeWindow::perform          = hook_perform;</span><br><span class="line"></span><br><span class="line">    ANativeWindow::dequeueBuffer_DEPRECATED = hook_dequeueBuffer_DEPRECATED;</span><br><span class="line">    ANativeWindow::cancelBuffer_DEPRECATED  = hook_cancelBuffer_DEPRECATED;</span><br><span class="line">    ANativeWindow::lockBuffer_DEPRECATED    = hook_lockBuffer_DEPRECATED;</span><br><span class="line">    ANativeWindow::queueBuffer_DEPRECATED   = hook_queueBuffer_DEPRECATED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::minSwapInterval) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const_cast</span>&lt;<span class="keyword">int</span>&amp;&gt;(ANativeWindow::maxSwapInterval) = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    mReqWidth = <span class="number">0</span>;</span><br><span class="line">    mReqHeight = <span class="number">0</span>;</span><br><span class="line">    mReqFormat = <span class="number">0</span>;</span><br><span class="line">    mReqUsage = <span class="number">0</span>;</span><br><span class="line">    mTimestamp = NATIVE_WINDOW_TIMESTAMP_AUTO;</span><br><span class="line">    mDataSpace = Dataspace::UNKNOWN;</span><br><span class="line">    mScalingMode = NATIVE_WINDOW_SCALING_MODE_FREEZE;</span><br><span class="line">    mTransform = <span class="number">0</span>;</span><br><span class="line">    mStickyTransform = <span class="number">0</span>;</span><br><span class="line">    mDefaultWidth = <span class="number">0</span>;</span><br><span class="line">    mDefaultHeight = <span class="number">0</span>;</span><br><span class="line">    mUserWidth = <span class="number">0</span>;</span><br><span class="line">    mUserHeight = <span class="number">0</span>;</span><br><span class="line">    mTransformHint = <span class="number">0</span>;</span><br><span class="line">    mConsumerRunningBehind = <span class="literal">false</span>;</span><br><span class="line">    mConnectedToCpu = <span class="literal">false</span>;</span><br><span class="line">    mProducerControlledByApp = controlledByApp;</span><br><span class="line">    mSwapIntervalZero = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="2-2-5、Surface跨进程传递（-WMS-gt-App）writeToParcel"><a href="#2-2-5、Surface跨进程传递（-WMS-gt-App）writeToParcel" class="headerlink" title="2.2.5、Surface跨进程传递（ WMS-&gt;App）writeToParcel()"></a>2.2.5、Surface跨进程传递（ WMS-&gt;App）writeToParcel()</h6><p>得到真正的Surface后，[-&gt;IWindowSession$Stub.java]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">   ......</span><br><span class="line">   Surface _arg17 = <span class="keyword">new</span> Surface();</span><br><span class="line">   <span class="keyword">int</span> _result2 = <span class="keyword">this</span>.relayout(_arg0, _arg1, _arg25, _arg3, _arg4, _arg5, _arg62, _result4, _result7, _arg9, _arg10, _arg11, _arg12, _arg13, _arg14, _arg15, _arg16, _arg17);</span><br><span class="line">   ......</span><br><span class="line">   <span class="keyword">if</span>(_arg17 != null) &#123;</span><br><span class="line">      reply.writeInt(<span class="number">1</span>);</span><br><span class="line">      _arg17.writeToParcel(reply, <span class="number">1</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      reply.writeInt(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>WMS会首先通过writeToParcel()函数将Surface对象写入App 进程端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Surface.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (dest == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;dest must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">            <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">            dest.writeString(mName);</span><br><span class="line">            dest.writeInt(mIsSingleBuffered ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">            nativeWriteToParcel(mNativeObject, dest);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; Parcelable.PARCELABLE_WRITE_RETURN_VALUE) != <span class="number">0</span>) &#123;</span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\jni\android_view_Surface.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeWriteToParcel</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong nativeObject, jobject parcelObj)</span> </span>&#123;</span><br><span class="line">    Parcel* parcel = parcelForJavaObject(env, parcelObj);</span><br><span class="line">    <span class="keyword">if</span> (parcel == NULL) &#123;</span><br><span class="line">        doThrowNPE(env);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">sp&lt;Surface&gt; <span class="title">self</span><span class="params">(reinterpret_cast&lt;Surface *&gt;(nativeObject)</span>)</span>;</span><br><span class="line">    android::view::Surface surfaceShim;</span><br><span class="line">    <span class="keyword">if</span> (self != nullptr) &#123;</span><br><span class="line">        surfaceShim.graphicBufferProducer = self-&gt;getIGraphicBufferProducer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Calling code in Surface.java has already written the name of the Surface</span></span><br><span class="line">    <span class="comment">// to the Parcel</span></span><br><span class="line">    surfaceShim.writeToParcel(parcel, <span class="comment">/*nameAlreadyWritten*/</span><span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="2-2-6、Surface跨进程传递（-App-gt-WMS）readFromParcel"><a href="#2-2-6、Surface跨进程传递（-App-gt-WMS）readFromParcel" class="headerlink" title="2.2.6、Surface跨进程传递（ App-&gt;WMS）readFromParcel()"></a>2.2.6、Surface跨进程传递（ App-&gt;WMS）readFromParcel()</h6><p>[-&gt;IWindowSession$Stub$Proxy.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">relayout</span><span class="params">(IWindow window, <span class="keyword">int</span> seq, WindowManager.LayoutParams attrs, <span class="keyword">int</span> requestedWidth, <span class="keyword">int</span> requestedHeight, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> flags, <span class="keyword">long</span> frameNumber, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets, Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame, DisplayCutout.ParcelableWrapper displayCutout, MergedConfiguration outMergedConfiguration, Surface outSurface)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel _data = Parcel.obtain();</span><br><span class="line">    Parcel _reply = Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">   ......</span><br><span class="line">   mRemote.transact(<span class="number">6</span>, _data, _reply, <span class="number">0</span>);</span><br><span class="line">   _reply.readException();</span><br><span class="line">   <span class="keyword">int</span> _result = _reply.readInt();</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != _reply.readInt()) &#123;</span><br><span class="line">    outSurface.readFromParcel(_reply);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APP进程通过readFromParcel() 读取WMS写入的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\Surface.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFromParcel</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (source == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;source must not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// nativeReadFromParcel() will either return mNativeObject, or</span></span><br><span class="line">            <span class="comment">// create a new native Surface and return it after reducing</span></span><br><span class="line">            <span class="comment">// the reference count on mNativeObject.  Either way, it is</span></span><br><span class="line">            <span class="comment">// not necessary to call nativeRelease() here.</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> This must be kept synchronized with the native parceling code</span></span><br><span class="line">            <span class="comment">// in frameworks/native/libs/Surface.cpp</span></span><br><span class="line">            mName = source.readString();</span><br><span class="line">            mIsSingleBuffered = source.readInt() != <span class="number">0</span>;</span><br><span class="line">            setNativeObjectLocked(nativeReadFromParcel(mNativeObject, source));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\jni\android_view_Surface.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeReadFromParcel</span><span class="params">(JNIEnv* env, jclass clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">        jlong nativeObject, jobject parcelObj)</span> </span>&#123;</span><br><span class="line">    Parcel* parcel = parcelForJavaObject(env, parcelObj);</span><br><span class="line">    <span class="keyword">if</span> (parcel == NULL) &#123;</span><br><span class="line">        doThrowNPE(env);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    android::view::Surface surfaceShim;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calling code in Surface.java has already read the name of the Surface</span></span><br><span class="line">    <span class="comment">// from the Parcel</span></span><br><span class="line">    surfaceShim.readFromParcel(parcel, <span class="comment">/*nameAlreadyRead*/</span><span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">sp&lt;Surface&gt; <span class="title">self</span><span class="params">(reinterpret_cast&lt;Surface *&gt;(nativeObject)</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the Surface only if the underlying IGraphicBufferProducer</span></span><br><span class="line">    <span class="comment">// has changed.</span></span><br><span class="line">    <span class="keyword">if</span> (self != nullptr</span><br><span class="line">            &amp;&amp; (IInterface::asBinder(self-&gt;getIGraphicBufferProducer()) ==</span><br><span class="line">                    IInterface::asBinder(surfaceShim.graphicBufferProducer))) &#123;</span><br><span class="line">        <span class="comment">// same IGraphicBufferProducer, return ourselves</span></span><br><span class="line">        <span class="keyword">return</span> jlong(self.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;Surface&gt; sur;</span><br><span class="line">    <span class="keyword">if</span> (surfaceShim.graphicBufferProducer != nullptr) &#123;</span><br><span class="line">        <span class="comment">// we have a new IGraphicBufferProducer, create a new Surface for it</span></span><br><span class="line">        sur = <span class="keyword">new</span> Surface(surfaceShim.graphicBufferProducer, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// and keep a reference before passing to java</span></span><br><span class="line">        sur-&gt;incStrong(&amp;sRefBaseOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self != NULL) &#123;</span><br><span class="line">        <span class="comment">// and loose the java reference to ourselves</span></span><br><span class="line">        self-&gt;decStrong(&amp;sRefBaseOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jlong(sur.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.Surface-SurfaceControl.png" alt="enter image description here"> </p>
<h5 id="（3）、焦点窗口更新updateFocusedWindowLocked"><a href="#（3）、焦点窗口更新updateFocusedWindowLocked" class="headerlink" title="（3）、焦点窗口更新updateFocusedWindowLocked()"></a>（3）、焦点窗口更新updateFocusedWindowLocked()</h5><p>继续看看relayoutWindow()方法，createSurfaceControl()之后会更新焦点窗口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\WindowManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move to DisplayContent</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">updateFocusedWindowLocked</span><span class="params">(<span class="keyword">int</span> mode, <span class="keyword">boolean</span> updateInputWindows)</span> </span>&#123;</span><br><span class="line">        WindowState newFocus = mRoot.computeFocusedWindow();</span><br><span class="line">        <span class="keyword">if</span> (mCurrentFocus != newFocus) &#123;</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="string">&quot;wmUpdateFocus&quot;</span>);</span><br><span class="line">            <span class="comment">// This check makes sure that we don&#x27;t already have the focus</span></span><br><span class="line">            <span class="comment">// change message pending.</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.018</span> I/WindowManager( <span class="number">1049</span>): Focus moving from <span class="keyword">null</span> to Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.018</span> I/WindowManager( <span class="number">1049</span>): Gaining focus: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            mH.removeMessages(H.REPORT_FOCUS_CHANGE);</span><br><span class="line">            mH.sendEmptyMessage(H.REPORT_FOCUS_CHANGE);</span><br><span class="line">            <span class="comment">// TODO(multidisplay): Focused windows on default display only.</span></span><br><span class="line">            <span class="keyword">final</span> DisplayContent displayContent = getDefaultDisplayContentLocked();</span><br><span class="line">            <span class="keyword">boolean</span> imWindowChanged = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//处理输入法相关</span></span><br><span class="line">            ......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> V/WindowManager( <span class="number">1049</span>): Changing focus from <span class="keyword">null</span> to Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; Callers=com.android.server.wm.WindowManagerService.relayoutWindow:<span class="number">2088</span> com.android.server.wm.Session.relayout:<span class="number">244</span> android.view.IWindowSession$Stub.onTransact:<span class="number">309</span> com.android.server.wm.Session.onTransact:<span class="number">164</span> </span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_FOCUS_LIGHT || localLOGV) Slog.v(TAG_WM, <span class="string">&quot;Changing focus from &quot;</span> +</span><br><span class="line">                    mCurrentFocus + <span class="string">&quot; to &quot;</span> + newFocus + <span class="string">&quot; Callers=&quot;</span> + Debug.getCallers(<span class="number">4</span>));</span><br><span class="line">            <span class="keyword">final</span> WindowState oldFocus = mCurrentFocus;</span><br><span class="line">            mCurrentFocus = newFocus;</span><br><span class="line">            mLosingFocus.remove(newFocus);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mCurrentFocus != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mWinAddedSinceNullFocus.clear();</span><br><span class="line">                mWinRemovedSinceNullFocus.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> focusChanged = mPolicy.focusChangedLw(oldFocus, newFocus);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.013</span> D/WindowManager( <span class="number">1049</span>): Input focus has changed to Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (mode != UPDATE_FOCUS_WILL_ASSIGN_LAYERS) &#123;</span><br><span class="line">                mInputMonitor.setInputFocusLw(mCurrentFocus, updateInputWindows);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            displayContent.adjustForImeIfNeeded();</span><br><span class="line">            displayContent.scheduleToastWindowsTimeoutIfNeededLocked(oldFocus, newFocus);</span><br><span class="line"></span><br><span class="line">            Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="3-1、RootWindowContainer-computeFocusedWindow"><a href="#3-1、RootWindowContainer-computeFocusedWindow" class="headerlink" title="3.1、RootWindowContainer.computeFocusedWindow()"></a>3.1、RootWindowContainer.computeFocusedWindow()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\RootWindowContainer.java</span><br><span class="line"></span><br><span class="line">    <span class="function">WindowState <span class="title">computeFocusedWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// While the keyguard is showing, we must focus anything besides the main display.</span></span><br><span class="line">        <span class="comment">// Otherwise we risk input not going to the keyguard when the user expects it to.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> forceDefaultDisplay = mService.isKeyguardShowingAndNotOccluded();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mChildren.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">final</span> DisplayContent dc = mChildren.get(i);</span><br><span class="line">            <span class="keyword">final</span> WindowState win = dc.findFocusedWindow();</span><br><span class="line">            <span class="keyword">if</span> (win != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (forceDefaultDisplay &amp;&amp; !dc.isDefaultDisplay) &#123;</span><br><span class="line">                    EventLog.writeEvent(<span class="number">0x534e4554</span>, <span class="string">&quot;71786287&quot;</span>, win.mOwnerUid, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> win;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-1、DisplayContent-findFocusedWindow"><a href="#3-1-1、DisplayContent-findFocusedWindow" class="headerlink" title="3.1.1、DisplayContent.findFocusedWindow()"></a>3.1.1、DisplayContent.findFocusedWindow()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\DisplayContent.java</span><br><span class="line">    <span class="function">WindowState <span class="title">findFocusedWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mTmpWindow = <span class="keyword">null</span>;</span><br><span class="line">        forAllWindows(mFindFocusedWindow, <span class="keyword">true</span> <span class="comment">/* traverseTopToBottom */</span>);</span><br><span class="line">        <span class="keyword">return</span> mTmpWindow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ToBooleanFunction&lt;WindowState&gt; mFindFocusedWindow = w -&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> AppWindowToken focusedApp = mService.mFocusedApp;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> V/WindowManager( <span class="number">1049</span>): Looking <span class="keyword">for</span> focus: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;, flags=<span class="number">25231616</span>, canReceive=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.012</span> V/WindowManager( <span class="number">1049</span>): findFocusedWindow: Found <span class="keyword">new</span> focus @ Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FOCUS) Slog.v(TAG_WM, <span class="string">&quot;Looking for focus: &quot;</span> + w</span><br><span class="line">                + <span class="string">&quot;, flags=&quot;</span> + w.mAttrs.flags + <span class="string">&quot;, canReceive=&quot;</span> + w.canReceiveKeys());</span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">final</span> AppWindowToken wtoken = w.mAppToken;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FOCUS_LIGHT) Slog.v(TAG_WM, <span class="string">&quot;findFocusedWindow: Found new focus @ &quot;</span> + w);</span><br><span class="line">        mTmpWindow = w;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>


<h5 id="3-2、Visibility更新AppWindowToken-updateReportedVisibilityLocked"><a href="#3-2、Visibility更新AppWindowToken-updateReportedVisibilityLocked" class="headerlink" title="3.2、Visibility更新AppWindowToken.updateReportedVisibilityLocked()"></a>3.2、Visibility更新AppWindowToken.updateReportedVisibilityLocked()</h5><p>根据WindowState 的 mDrawState=1  可知，现在WindowState  状态是DRAW_PENDING。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\AppWindowToken.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">08</span>:<span class="number">37.013</span> V/AppWindowToken( <span class="number">1049</span>): Update reported visibility: AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.013</span> V/WindowState( <span class="number">1049</span>): Win Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: isDrawn=<span class="keyword">false</span>, isAnimationSet=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.013</span> V/WindowState( <span class="number">1049</span>): Not displayed: s=Surface(name=com.android.testred/com.android.testred.TestActivity)/@<span class="number">0xb17b0ce</span> pv=<span class="keyword">true</span> mDrawState=<span class="number">1</span> ph=<span class="keyword">false</span> th=<span class="keyword">false</span> a=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.013</span> V/AppWindowToken( <span class="number">1049</span>): VIS AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125;: interesting=<span class="number">1</span> visible=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateReportedVisibilityLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG, <span class="string">&quot;Update reported visibility: &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mChildren.size();</span><br><span class="line"></span><br><span class="line">        mReportedVisibilityResults.reset();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> WindowState win = mChildren.get(i);</span><br><span class="line">            win.updateReportedVisibility(mReportedVisibilityResults);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> numInteresting = mReportedVisibilityResults.numInteresting;</span><br><span class="line">        <span class="keyword">int</span> numVisible = mReportedVisibilityResults.numVisible;</span><br><span class="line">        <span class="keyword">int</span> numDrawn = mReportedVisibilityResults.numDrawn;</span><br><span class="line">        <span class="keyword">boolean</span> nowGone = mReportedVisibilityResults.nowGone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> nowDrawn = numInteresting &gt; <span class="number">0</span> &amp;&amp; numDrawn &gt;= numInteresting;</span><br><span class="line">        <span class="keyword">boolean</span> nowVisible = numInteresting &gt; <span class="number">0</span> &amp;&amp; numVisible &gt;= numInteresting &amp;&amp; !isHidden();</span><br><span class="line">        <span class="keyword">if</span> (!nowGone) &#123;</span><br><span class="line">            <span class="comment">// If the app is not yet gone, then it can only become visible/drawn.</span></span><br><span class="line">            <span class="keyword">if</span> (!nowDrawn) &#123;</span><br><span class="line">                nowDrawn = reportedDrawn;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!nowVisible) &#123;</span><br><span class="line">                nowVisible = reportedVisible;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG, <span class="string">&quot;VIS &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;: interesting=&quot;</span></span><br><span class="line">                + numInteresting + <span class="string">&quot; visible=&quot;</span> + numVisible);</span><br><span class="line">        <span class="keyword">final</span> AppWindowContainerController controller = getController();</span><br><span class="line">        <span class="keyword">if</span> (nowDrawn != reportedDrawn) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nowDrawn) &#123;</span><br><span class="line">                <span class="keyword">if</span> (controller != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    controller.reportWindowsDrawn();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            reportedDrawn = nowDrawn;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nowVisible != reportedVisible) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG,</span><br><span class="line">                    <span class="string">&quot;Visibility changed in &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;: vis=&quot;</span> + nowVisible);</span><br><span class="line">            reportedVisible = nowVisible;</span><br><span class="line">            <span class="keyword">if</span> (controller != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nowVisible) &#123;</span><br><span class="line">                    controller.reportWindowsVisible();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    controller.reportWindowsGone();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此<br>ViewRootImpl.java 的 performTraversals() 方法中的relayoutWindow(params, viewVisibility, insetsPending)终于完成了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.015</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): relayout: frame=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">160</span>,<span class="number">854</span>] overscan=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">0</span>,<span class="number">0</span>] content=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">0</span>,<span class="number">0</span>] visible=[<span class="number">0</span>,<span class="number">36</span>][<span class="number">0</span>,<span class="number">72</span>] stable=[<span class="number">0</span>,<span class="number">36</span>][<span class="number">0</span>,<span class="number">72</span>] cutout=DisplayCutout&#123;insets=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">0</span>, <span class="number">0</span>) boundingRect=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">0</span>, <span class="number">0</span>)&#125; outsets=[<span class="number">0</span>,<span class="number">0</span>][<span class="number">0</span>,<span class="number">0</span>] surface=Surface(name=<span class="keyword">null</span>)/@<span class="number">0x266c9a5</span></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;relayout: frame=&quot;</span> + frame.toShortString()</span><br><span class="line">                        + <span class="string">&quot; overscan=&quot;</span> + mPendingOverscanInsets.toShortString()</span><br><span class="line">                        + <span class="string">&quot; content=&quot;</span> + mPendingContentInsets.toShortString()</span><br><span class="line">                        + <span class="string">&quot; visible=&quot;</span> + mPendingVisibleInsets.toShortString()</span><br><span class="line">                        + <span class="string">&quot; stable=&quot;</span> + mPendingStableInsets.toShortString()</span><br><span class="line">                        + <span class="string">&quot; cutout=&quot;</span> + mPendingDisplayCutout.get().toString()</span><br><span class="line">                        + <span class="string">&quot; outsets=&quot;</span> + mPendingOutsets.toShortString()</span><br><span class="line">                        + <span class="string">&quot; surface=&quot;</span> + mSurface);</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.015</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Visible with <span class="keyword">new</span> config: &#123;<span class="number">1.0</span> ?mcc?mnc [en_US] ldltr sw320dp w320dp h497dp <span class="number">240d</span>pi nrml port finger -keyb/v/h -nav/h winConfig=&#123; mBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">854</span>) mAppBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">782</span>) mWindowingMode=fullscreen mActivityType=standard&#125; s.<span class="number">5</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.015</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Applying <span class="keyword">new</span> config to window com.android.testred/com.android.testred.TestActivity, globalConfig: &#123;<span class="number">1.0</span> ?mcc?mnc [en_US] ldltr sw320dp w320dp h497dp <span class="number">240d</span>pi nrml port finger -keyb/v/h -nav/h winConfig=&#123; mBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">782</span>) </span><br><span class="line">mAppBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">782</span>) mWindowingMode=fullscreen mActivityType=undefined&#125; s.<span class="number">5</span>&#125;, overrideConfig: &#123;<span class="number">1.0</span> ?mcc?mnc [en_US] ldltr sw320dp w320dp h497dp <span class="number">240d</span>pi nrml port finger -keyb/v/h -nav/h winConfig=&#123; mBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">854</span>) mAppBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">782</span>) mWindowingMode=fullscreen mActivityType=standard&#125; s.<span class="number">5</span>&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (!mPendingMergedConfiguration.equals(mLastReportedMergedConfiguration)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_CONFIGURATION) Log.v(mTag, <span class="string">&quot;Visible with new config: &quot;</span></span><br><span class="line">                            + mPendingMergedConfiguration.getMergedConfiguration());</span><br><span class="line">                    performConfigurationChange(mPendingMergedConfiguration, !mFirst,</span><br><span class="line">                            INVALID_DISPLAY <span class="comment">/* same display */</span>);</span><br><span class="line">                    updatedConfiguration = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">if</span> (contentInsetsChanged) &#123;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.015</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Content insets changing to: Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                    mAttachInfo.mContentInsets.set(mPendingContentInsets);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;Content insets changing to: &quot;</span></span><br><span class="line">                            + mAttachInfo.mContentInsets);</span><br><span class="line">                &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.015</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Decor insets changing to: Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">0</span>, <span class="number">72</span>)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (stableInsetsChanged) &#123;</span><br><span class="line">                    mAttachInfo.mStableInsets.set(mPendingStableInsets);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;Decor insets changing to: &quot;</span></span><br><span class="line">                            + mAttachInfo.mStableInsets);</span><br><span class="line">                    <span class="comment">// Need to relayout with content insets.</span></span><br><span class="line">                    contentInsetsChanged = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.015</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Visible insets changing to: Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">0</span>, <span class="number">72</span>)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (visibleInsetsChanged) &#123;</span><br><span class="line">                    mAttachInfo.mVisibleInsets.set(mPendingVisibleInsets);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;Visible insets changing to: &quot;</span></span><br><span class="line">                            + mAttachInfo.mVisibleInsets);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                .......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ORIENTATION) Log.v(</span><br><span class="line">                    TAG, <span class="string">&quot;Relayout returned: frame=&quot;</span> + frame + <span class="string">&quot;, surface=&quot;</span> + mSurface);</span><br><span class="line"></span><br><span class="line">            mAttachInfo.mWindowLeft = frame.left;</span><br><span class="line">            mAttachInfo.mWindowTop = frame.top;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// !!FIXME!! This next section handles the case where we did not get the</span></span><br><span class="line">            <span class="comment">// window size we asked for. We should avoid this by getting a maximum size from</span></span><br><span class="line">            <span class="comment">// the window session beforehand.</span></span><br><span class="line">            <span class="keyword">if</span> (mWidth != frame.width() || mHeight != frame.height()) &#123;</span><br><span class="line">                mWidth = frame.width();</span><br><span class="line">                mHeight = frame.height();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ThreadedRenderer threadedRenderer = mAttachInfo.mThreadedRenderer;</span><br><span class="line">            <span class="keyword">if</span> (threadedRenderer != <span class="keyword">null</span> &amp;&amp; threadedRenderer.isEnabled()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (hwInitialized</span><br><span class="line">                        || mWidth != threadedRenderer.getWidth()</span><br><span class="line">                        || mHeight != threadedRenderer.getHeight()</span><br><span class="line">                        || mNeedsRendererSetup) &#123;</span><br><span class="line">                    threadedRenderer.setup(mWidth, mHeight, mAttachInfo,</span><br><span class="line">                            mWindowAttributes.surfaceInsets);</span><br><span class="line">                    mNeedsRendererSetup = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                        (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                        || mHeight != host.getMeasuredHeight() || contentInsetsChanged ||</span><br><span class="line">                        updatedConfiguration) &#123;</span><br><span class="line">                    <span class="keyword">int</span> childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</span><br><span class="line">                    <span class="keyword">int</span> childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.016</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Ooops, something changed!  mWidth=<span class="number">160</span> measuredWidth=<span class="number">480</span> mHeight=<span class="number">854</span> measuredHeight=<span class="number">782</span> coveredInsetsChanged=<span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT) Log.v(mTag, <span class="string">&quot;Ooops, something changed!  mWidth=&quot;</span></span><br><span class="line">                            + mWidth + <span class="string">&quot; measuredWidth=&quot;</span> + host.getMeasuredWidth()</span><br><span class="line">                            + <span class="string">&quot; mHeight=&quot;</span> + mHeight</span><br><span class="line">                            + <span class="string">&quot; measuredHeight=&quot;</span> + host.getMeasuredHeight()</span><br><span class="line">                            + <span class="string">&quot; coveredInsetsChanged=&quot;</span> + contentInsetsChanged);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     <span class="comment">// Ask host how big it wants to be</span></span><br><span class="line"><span class="comment">/****************执行View控件大小计算******************/</span>  </span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> width = host.getMeasuredWidth();</span><br><span class="line">                    <span class="keyword">int</span> height = host.getMeasuredHeight();</span><br><span class="line">                    <span class="keyword">boolean</span> measureAgain = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (lp.horizontalWeight &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                        width += (<span class="keyword">int</span>) ((mWidth - width) * lp.horizontalWeight);</span><br><span class="line">                        childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width,</span><br><span class="line">                                MeasureSpec.EXACTLY);</span><br><span class="line">                        measureAgain = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (lp.verticalWeight &gt; <span class="number">0.0f</span>) &#123;</span><br><span class="line">                        height += (<span class="keyword">int</span>) ((mHeight - height) * lp.verticalWeight);</span><br><span class="line">                        childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height,</span><br><span class="line">                                MeasureSpec.EXACTLY);</span><br><span class="line">                        measureAgain = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ......</span><br><span class="line">                    layoutRequested = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************执行窗口布局******************/</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">        <span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</span><br><span class="line">                || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">        <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">            performLayout(lp, mWidth, mHeight);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// By this point all views have been sized and positioned</span></span><br><span class="line">            <span class="comment">// We can compute the transparent area</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// start out transparent</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> AVOID THAT CALL BY CACHING THE RESULT?</span></span><br><span class="line">                host.getLocationInWindow(mTmpLocation);</span><br><span class="line">                mTransparentRegion.set(mTmpLocation[<span class="number">0</span>], mTmpLocation[<span class="number">1</span>],</span><br><span class="line">                        mTmpLocation[<span class="number">0</span>] + host.mRight - host.mLeft,</span><br><span class="line">                        mTmpLocation[<span class="number">1</span>] + host.mBottom - host.mTop);</span><br><span class="line"></span><br><span class="line">                host.gatherTransparentRegion(mTransparentRegion);</span><br><span class="line">                <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mTranslator.translateRegionInWindowToScreen(mTransparentRegion);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mTransparentRegion.equals(mPreviousTransparentRegion)) &#123;</span><br><span class="line">                    mPreviousTransparentRegion.set(mTransparentRegion);</span><br><span class="line">                    mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="comment">// reconfigure window manager</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mWindowSession.setTransparentRegion(mWindow, mTransparentRegion);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> I/System.out( <span class="number">2602</span>): ======================================</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> I/System.out( <span class="number">2602</span>): performTraversals -- after setFrame</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;performTraversals -- after setFrame&quot;</span>);</span><br><span class="line">                host.debug();</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> D/View    ( <span class="number">2602</span>):   + DecorView@<span class="number">515e1</span>ca[TestActivity]</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> D/View    ( <span class="number">2602</span>):       frame=&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">160</span>, <span class="number">854</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.018</span> D/View    ( <span class="number">2602</span>):       mMeasureWidth=<span class="number">160</span> mMeasureHeight=<span class="number">854</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/Debug   ( <span class="number">2602</span>):       Contents of &#123;(<span class="number">0</span>,<span class="number">0</span>)(fillxfill) sim=&#123;forwardNavigation&#125; ty=BASE_APPLICATION fmt=TRANSPARENT wanim=<span class="number">0x1030000</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/Debug   ( <span class="number">2602</span>):   fl=LAYOUT_IN_SCREEN LAYOUT_INSET_DECOR SPLIT_TOUCH HARDWARE_ACCELERATED&#125;:</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/Debug   ( <span class="number">2602</span>): ViewGroup.LayoutParams=&#123; width=match-parent, height=match-parent &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/Debug   ( <span class="number">2602</span>): </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/Debug   ( <span class="number">2602</span>): WindowManager.LayoutParams=&#123;title=com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>): </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):       flags=&#123;&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):       privateFlags=&#123;IS_ROOT_NAMESPACE HAS_BOUNDS DRAWN&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):       &#123;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):       + android.widget.LinearLayout&#123;c1507be V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">854</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           frame=&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">160</span>, <span class="number">854</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           mMeasureWidth=<span class="number">160</span> mMeasureHeight=<span class="number">854</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           ViewGroup.LayoutParams=&#123; width=match-parent, height=match-parent &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           flags=&#123;&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           privateFlags=&#123;HAS_BOUNDS&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           &#123;</span><br><span class="line">04-16 13:08:37.020 D/View    ( 2602):           + android.view.ViewStub&#123;870dc6e G.E...... ......I. 0,0-0,0 #102018a android:id/action_mode_bar_stub&#125; (id=16908682)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               frame=&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               mMeasureWidth=<span class="number">0</span> mMeasureHeight=<span class="number">0</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               LinearLayout.LayoutParams=&#123;width=match-parent, height=wrap-content weight=<span class="number">0.0</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               flags=&#123;GONE&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               privateFlags=&#123;DRAWN&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):           + android.widget.FrameLayout&#123;b582935 V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">38</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               frame=&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">160</span>, <span class="number">38</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               padding=&#123;<span class="number">6</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               mMeasureWidth=<span class="number">160</span> mMeasureHeight=<span class="number">38</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               LinearLayout.LayoutParams=&#123;width=match-parent, height=<span class="number">38</span> weight=<span class="number">0.0</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               flags=&#123;&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               privateFlags=&#123;HAS_BOUNDS&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):               &#123;</span><br><span class="line">04-16 13:08:37.020 D/View    ( 2602):               + android.widget.TextView&#123;64b8f0f V.ED..... ......ID 6,1-154,36 #1020016 android:id/title&#125; (id=16908310)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):                   frame=&#123;<span class="number">6</span>, <span class="number">1</span>, <span class="number">154</span>, <span class="number">36</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):                   mMeasureWidth=<span class="number">148</span> mMeasureHeight=<span class="number">35</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.020</span> D/View    ( <span class="number">2602</span>):                   ViewGroup.LayoutParams=&#123; width=match-parent, height=match-parent &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   flags=&#123;&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   privateFlags=&#123;HAS_BOUNDS&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   frame=&#123;<span class="number">6</span>, <span class="number">1</span>, <span class="number">154</span>, <span class="number">36</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; mText=<span class="string">&quot;Test Viewport&quot;</span> mLayout width=<span class="number">1048576</span> height=<span class="number">29</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               &#125;</span><br><span class="line">04-16 13:08:37.021 D/View    ( 2602):           + android.widget.FrameLayout&#123;158df3b V.ED..... ......ID 0,38-160,854 #1020002 android:id/content&#125; (id=16908290)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               frame=&#123;<span class="number">0</span>, <span class="number">38</span>, <span class="number">160</span>, <span class="number">854</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               mMeasureWidth=<span class="number">160</span> mMeasureHeight=<span class="number">816</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               LinearLayout.LayoutParams=&#123;width=match-parent, height=<span class="number">0</span> weight=<span class="number">1.0</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               flags=&#123;&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               privateFlags=&#123;HAS_BOUNDS&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               &#123;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               + com.android.testred.TestView&#123;<span class="number">85</span>cab9c VFE...... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">816</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   frame=&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">160</span>, <span class="number">816</span>&#125; scroll=&#123;<span class="number">0</span>, <span class="number">0</span>&#125; </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   mMeasureWidth=<span class="number">160</span> mMeasureHeight=<span class="number">816</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   ViewGroup.LayoutParams=&#123; width=match-parent, height=match-parent &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   flags=&#123;TAKES_FOCUS&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):                   privateFlags=&#123;HAS_BOUNDS&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):               &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):           &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> D/View    ( <span class="number">2602</span>):       &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sAlwaysAssignFocus || !isInTouchMode()) &#123;</span><br><span class="line">                <span class="comment">// handle first focus request</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): First: mView.hasFocus()=<span class="keyword">false</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INPUT_RESIZE) &#123;</span><br><span class="line">                    Log.v(mTag, <span class="string">&quot;First: mView.hasFocus()=&quot;</span> + mView.hasFocus());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mView.hasFocus()) &#123;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">mView.restoreDefaultFocus();对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> I/System.out( <span class="number">2602</span>): DecorView@<span class="number">515e1</span>ca[TestActivity] ViewGroup.requestFocus direction=<span class="number">130</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> I/System.out( <span class="number">2602</span>): android.widget.LinearLayout&#123;c1507be V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">854</span>&#125; ViewGroup.requestFocus direction=<span class="number">130</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> I/System.out( <span class="number">2602</span>): android.widget.FrameLayout&#123;b582935 V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">38</span>&#125; ViewGroup.requestFocus direction=<span class="number">130</span></span><br><span class="line">04-16 13:08:37.021 I/System.out( 2602): android.widget.FrameLayout&#123;158df3b V.ED..... ......ID 0,38-160,854 #1020002 android:id/content&#125; ViewGroup.requestFocus direction=130</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> I/System.out( <span class="number">2602</span>): com.android.testred.TestView&#123;<span class="number">85</span>cab9c VFE...... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">816</span>&#125; requestFocus()</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.021</span> I/System.out( <span class="number">2602</span>): Find focus in DecorView@<span class="number">515e1</span>ca[TestActivity]: flags=<span class="keyword">false</span>, child=<span class="keyword">null</span></span><br><span class="line">04-16 13:08:37.021 I/System.out( 2602): android.widget.FrameLayout&#123;158df3b V.ED..... ......ID 0,38-160,854 #1020002 android:id/content&#125; requestChildFocus()</span><br><span class="line">04-16 13:08:37.021 I/System.out( 2602): android.widget.FrameLayout&#123;158df3b V.ED..... ......ID 0,38-160,854 #1020002 android:id/content&#125; unFocus()</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> I/System.out( <span class="number">2602</span>): android.widget.LinearLayout&#123;c1507be V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">854</span>&#125; requestChildFocus()</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> I/System.out( <span class="number">2602</span>): android.widget.LinearLayout&#123;c1507be V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">854</span>&#125; unFocus()</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> I/System.out( <span class="number">2602</span>): DecorView@<span class="number">515e1</span>ca[TestActivity] requestChildFocus()</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> I/System.out( <span class="number">2602</span>): DecorView@<span class="number">515e1</span>ca[TestActivity] unFocus()</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Request child focus: focus now com.android.testred.TestView&#123;<span class="number">85</span>cab9c VFE...... .F....ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">816</span>&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> I/System.out( <span class="number">2602</span>): Find focus in DecorView@<span class="number">515e1</span>ca[TestActivity]: flags=<span class="keyword">false</span>, child=android.widget.LinearLayout&#123;c1507be V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">854</span>&#125;</span><br><span class="line">04-16 13:08:37.022 I/System.out( 2602): Find focus in android.widget.LinearLayout&#123;c1507be V.ED..... ......ID 0,0-160,854&#125;: flags=false, child=android.widget.FrameLayout&#123;158df3b V.ED..... ......ID 0,38-160,854 #1020002 android:id/content&#125;</span><br><span class="line">04-16 13:08:37.022 I/System.out( 2602): Find focus in android.widget.FrameLayout&#123;158df3b V.ED..... ......ID 0,38-160,854 #1020002 android:id/content&#125;: flags=false, child=com.android.testred.TestView&#123;85cab9c VFE...... .F....ID 0,0-160,816&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.022</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): First: requested focused view=com.android.testred.TestView&#123;<span class="number">85</span>cab9c VFE...... .F....ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">160</span>,<span class="number">816</span>&#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">                        mView.restoreDefaultFocus();</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_INPUT_RESIZE) &#123;</span><br><span class="line">                            Log.v(mTag, <span class="string">&quot;First: requested focused view=&quot;</span> + mView.findFocus());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_INPUT_RESIZE) &#123;</span><br><span class="line">                            Log.v(mTag, <span class="string">&quot;First: existing focused view=&quot;</span> + mView.findFocus());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Some views (like ScrollView) won&#x27;t hand focus to descendants that aren&#x27;t within</span></span><br><span class="line">                <span class="comment">// their viewport. Before layout, there&#x27;s a good change these views are size 0</span></span><br><span class="line">                <span class="comment">// which means no children can get focus. After layout, this view now has size, but</span></span><br><span class="line">                <span class="comment">// is not guaranteed to hand-off focus to a focusable child (specifically, the edge-</span></span><br><span class="line">                <span class="comment">// case where the child has a size prior to layout and thus won&#x27;t trigger</span></span><br><span class="line">                <span class="comment">// focusableViewAvailable).</span></span><br><span class="line">                View focused = mView.findFocus();</span><br><span class="line">                <span class="keyword">if</span> (focused <span class="keyword">instanceof</span> ViewGroup</span><br><span class="line">                        &amp;&amp; ((ViewGroup) focused).getDescendantFocusability()</span><br><span class="line">                                == ViewGroup.FOCUS_AFTER_DESCENDANTS) &#123;</span><br><span class="line">                    focused.restoreDefaultFocus();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/****************执行窗口绘制******************/</span>  </span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Remember if we must report the next draw.</span></span><br><span class="line">        <span class="keyword">if</span> ((relayoutResult &amp; WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">            reportNextDraw();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;</span><br><span class="line">            ......</span><br><span class="line">            performDraw();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isViewVisible) &#123;</span><br><span class="line">                scheduleTraversals();</span><br><span class="line">            &#125; ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mIsInTraversal = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="（4）、执行窗口布局performLayout"><a href="#（4）、执行窗口布局performLayout" class="headerlink" title="（4）、执行窗口布局performLayout()"></a>（4）、执行窗口布局performLayout()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">        mLayoutRequested = <span class="keyword">false</span>;</span><br><span class="line">        mScrollMayChange = <span class="keyword">true</span>;</span><br><span class="line">        mInLayout = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> View host = mView;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Laying out DecorView@<span class="number">515e1</span>ca[TestActivity] to (<span class="number">160</span>, <span class="number">854</span>)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_LAYOUT) &#123;</span><br><span class="line">            Log.v(mTag, <span class="string">&quot;Laying out &quot;</span> + host + <span class="string">&quot; to (&quot;</span> +</span><br><span class="line">                    host.getMeasuredWidth() + <span class="string">&quot;, &quot;</span> + host.getMeasuredHeight() + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">&quot;layout&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">            mInLayout = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> numViewsRequestingLayout = mLayoutRequesters.size();</span><br><span class="line">            ......</span><br><span class="line">        mInLayout = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="4-1、View-layout-0-0-host-getMeasuredWidth-host-getMeasuredHeight"><a href="#4-1、View-layout-0-0-host-getMeasuredWidth-host-getMeasuredHeight" class="headerlink" title="4.1、View.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight())"></a>4.1、View.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight())</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\View.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">            onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</span><br><span class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> oldL = mLeft;</span><br><span class="line">        <span class="keyword">int</span> oldT = mTop;</span><br><span class="line">        <span class="keyword">int</span> oldB = mBottom;</span><br><span class="line">        <span class="keyword">int</span> oldR = mRight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</span><br><span class="line">                setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">            onLayout(changed, l, t, r, b);</span><br><span class="line">            ......</span><br><span class="line">            mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</span><br><span class="line"></span><br><span class="line">            ListenerInfo li = mListenerInfo;</span><br><span class="line">            <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</span><br><span class="line">                        (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</span><br><span class="line">                <span class="keyword">int</span> numListeners = listenersCopy.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                    listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> wasLayoutValid = isLayoutValid();</span><br><span class="line"></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">        mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h6 id="4-1-1、View-setFrame"><a href="#4-1-1、View-setFrame" class="headerlink" title="4.1.1、View.setFrame"></a>4.1.1、View.setFrame</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\View.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setFrame</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">            Log.d(VIEW_LOG_TAG, <span class="keyword">this</span> + <span class="string">&quot; View.setFrame(&quot;</span> + left + <span class="string">&quot;,&quot;</span> + top + <span class="string">&quot;,&quot;</span></span><br><span class="line">                    + right + <span class="string">&quot;,&quot;</span> + bottom + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> D/View    ( <span class="number">2602</span>): DecorView@<span class="number">515e1</span>ca[TestActivity] View.setFrame(<span class="number">0</span>,<span class="number">0</span>,<span class="number">160</span>,<span class="number">854</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Invalidate child: Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">160</span>, <span class="number">854</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> D/View    ( <span class="number">2602</span>): android.widget.LinearLayout&#123;c1507be V.ED..... ......I. <span class="number">0</span>,<span class="number">0</span>-<span class="number">0</span>,<span class="number">0</span>&#125; View.setFrame(<span class="number">0</span>,<span class="number">0</span>,<span class="number">160</span>,<span class="number">854</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> D/View    ( <span class="number">2602</span>): android.widget.FrameLayout&#123;b582935 V.ED..... ......ID <span class="number">0</span>,<span class="number">0</span>-<span class="number">0</span>,<span class="number">0</span>&#125; View.setFrame(<span class="number">0</span>,<span class="number">0</span>,<span class="number">160</span>,<span class="number">38</span>)</span><br><span class="line">04-16 13:08:37.017 D/View    ( 2602): android.widget.TextView&#123;64b8f0f V.ED..... ......ID 0,0-0,0 #1020016 android:id/title&#125; View.setFrame(6,1,154,36)</span><br><span class="line">04-16 13:08:37.017 D/View    ( 2602): android.widget.FrameLayout&#123;158df3b V.ED..... ......I. 0,0-0,0 #1020002 android:id/content&#125; View.setFrame(0,38,160,854)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.017</span> D/View    ( <span class="number">2602</span>): com.android.testred.TestView&#123;<span class="number">85</span>cab9c VFE...... ......I. <span class="number">0</span>,<span class="number">0</span>-<span class="number">0</span>,<span class="number">0</span>&#125; View.setFrame(<span class="number">0</span>,<span class="number">0</span>,<span class="number">160</span>,<span class="number">816</span>)</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Remember our drawn bit</span></span><br><span class="line">            <span class="keyword">int</span> drawn = mPrivateFlags &amp; PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> oldWidth = mRight - mLeft;</span><br><span class="line">            <span class="keyword">int</span> oldHeight = mBottom - mTop;</span><br><span class="line">            <span class="keyword">int</span> newWidth = right - left;</span><br><span class="line">            <span class="keyword">int</span> newHeight = bottom - top;</span><br><span class="line">            <span class="keyword">boolean</span> sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Invalidate our old position</span></span><br><span class="line">            invalidate(sizeChanged);</span><br><span class="line"></span><br><span class="line">            mLeft = left;</span><br><span class="line">            mTop = top;</span><br><span class="line">            mRight = right;</span><br><span class="line">            mBottom = bottom;</span><br><span class="line">            mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</span><br><span class="line"></span><br><span class="line">            mPrivateFlags |= PFLAG_HAS_BOUNDS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">                sizeChange(newWidth, newHeight, oldWidth, oldHeight);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || mGhostView != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                mPrivateFlags |= PFLAG_DRAWN;</span><br><span class="line">                invalidate(sizeChanged);</span><br><span class="line"></span><br><span class="line">                invalidateParentCaches();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset drawn bit to original value (invalidate turns it off)</span></span><br><span class="line">            mPrivateFlags |= drawn;</span><br><span class="line"></span><br><span class="line">            mBackgroundSizeChanged = <span class="keyword">true</span>;</span><br><span class="line">            mDefaultFocusHighlightSizeChanged = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (mForegroundInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mForegroundInfo.mBoundsChanged = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            notifySubtreeAccessibilityStateChangedIfNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> changed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="4-1-2、SurfaceView-setFrame"><a href="#4-1-2、SurfaceView-setFrame" class="headerlink" title="4.1.2、SurfaceView.setFrame"></a>4.1.2、SurfaceView.setFrame</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\view\SurfaceView.java</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setFrame</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">super</span>.setFrame(left, top, right, bottom);</span><br><span class="line">    updateSurface();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateSurface</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ViewRootImpl viewRoot = getViewRootImpl();</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (creating || formatChanged || sizeChanged || visibleChanged || windowVisibleChanged) &#123;</span><br><span class="line">            getLocationInWindow(mLocation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> visible = mVisible = mRequestedVisible;</span><br><span class="line">                .......</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (creating) &#123;</span><br><span class="line">                    mSurfaceSession = <span class="keyword">new</span> SurfaceSession(viewRoot.mSurface);</span><br><span class="line">                    mDeferredDestroySurfaceControl = mSurfaceControl;</span><br><span class="line"></span><br><span class="line">                    updateOpaqueFlag();</span><br><span class="line">                    <span class="keyword">final</span> String name = <span class="string">&quot;SurfaceView - &quot;</span> + viewRoot.getTitle().toString();</span><br><span class="line"></span><br><span class="line">                    mSurfaceControl = <span class="keyword">new</span> SurfaceControlWithBackground(</span><br><span class="line">                            name,</span><br><span class="line">                            (mSurfaceFlags &amp; SurfaceControl.OPAQUE) != <span class="number">0</span>,</span><br><span class="line">                            <span class="keyword">new</span> SurfaceControl.Builder(mSurfaceSession)</span><br><span class="line">                                    .setSize(mSurfaceWidth, mSurfaceHeight)</span><br><span class="line">                                    .setFormat(mFormat)</span><br><span class="line">                                    .setFlags(mSurfaceFlags));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSurfaceControl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">04-16 13:08:37.023 V/BufferLayer(  739): Creating Layer SurfaceView - com.android.testred/com.android.testred.TestActivity#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferQueueConsumer(  <span class="number">739</span>): [] connect: controlledByApp=<span class="keyword">false</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferQueueConsumer(  <span class="number">739</span>): [] setConsumerName: <span class="string">&#x27;unnamed-739-41&#x27;</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferLayerConsumer(  <span class="number">739</span>): [unnamed-<span class="number">739</span>-<span class="number">41</span>] BufferLayerConsumer</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferQueueConsumer(  <span class="number">739</span>): [unnamed-<span class="number">739</span>-<span class="number">41</span>] setConsumerUsageBits: <span class="number">0x100</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferQueueConsumer(  <span class="number">739</span>): [unnamed-<span class="number">739</span>-<span class="number">41</span>] setConsumerUsageBits: <span class="number">0x900</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/ConsumerBase(  <span class="number">739</span>): [unnamed-<span class="number">739</span>-<span class="number">41</span>] setFrameAvailableListener</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferQueueConsumer(  <span class="number">739</span>): [unnamed-<span class="number">739</span>-<span class="number">41</span>] setConsumerName: <span class="string">&#x27;SurfaceView - com.android.testred/com.android.testred.TestActivity#0&#x27;</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.023</span> V/BufferQueueProducer(  <span class="number">739</span>): [] setMaxDequeuedBufferCount: maxDequeuedBuffers = <span class="number">2</span></span><br><span class="line">04-16 13:08:37.023 V/BufferQueueConsumer(  739): [SurfaceView - com.android.testred/com.android.testred.TestActivity#0] setTransformHint: 0</span><br><span class="line">04-16 13:08:37.023 V/BufferQueueConsumer(  739): [SurfaceView - com.android.testred/com.android.testred.TestActivity#0] setDefaultBufferSize: width=160 height=816</span><br><span class="line">04-16 13:08:37.023 V/BufferQueueConsumer(  739): [SurfaceView - com.android.testred/com.android.testred.TestActivity#0] setDefaultBufferFormat: 4</span><br><span class="line">04-16 13:08:37.023 V/BufferQueueConsumer(  739): [SurfaceView - com.android.testred/com.android.testred.TestActivity#0] setConsumerUsageBits: 0x900</span><br><span class="line">----------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p> updateSurface()会请求创建surface，创建过程前面已经分析过了</p>
<h5 id="（5）、执行窗口绘制performDraw"><a href="#（5）、执行窗口绘制performDraw" class="headerlink" title="（5）、执行窗口绘制performDraw()"></a>（5）、执行窗口绘制performDraw()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/android/view/ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> fullRedrawNeeded = mFullRedrawNeeded || mReportNextDraw;</span><br><span class="line">        mFullRedrawNeeded = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        mIsDrawing = <span class="keyword">true</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">&quot;draw&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> usingAsyncReport = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mReportNextDraw &amp;&amp; mAttachInfo.mThreadedRenderer != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;</span><br><span class="line">            usingAsyncReport = <span class="keyword">true</span>;</span><br><span class="line">            mAttachInfo.mThreadedRenderer.setFrameCompleteCallback((<span class="keyword">long</span> frameNr) -&gt; &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Use the frame number</span></span><br><span class="line">                pendingDrawFinished();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> canUseAsync = draw(fullRedrawNeeded);</span><br><span class="line">            <span class="keyword">if</span> (usingAsyncReport &amp;&amp; !canUseAsync) &#123;</span><br><span class="line">                mAttachInfo.mThreadedRenderer.setFrameCompleteCallback(<span class="keyword">null</span>);</span><br><span class="line">                usingAsyncReport = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mIsDrawing = <span class="keyword">false</span>;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For whatever reason we didn&#x27;t create a HardwareRenderer, end any</span></span><br><span class="line">        <span class="comment">// hardware animations that are now dangling</span></span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mPendingAnimatingRenderNodes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = mAttachInfo.mPendingAnimatingRenderNodes.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</span><br><span class="line">            &#125;</span><br><span class="line">            mAttachInfo.mPendingAnimatingRenderNodes.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReportNextDraw) &#123;</span><br><span class="line">            mReportNextDraw = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// if we&#x27;re using multi-thread renderer, wait for the window frame draws</span></span><br><span class="line">            <span class="keyword">if</span> (mWindowDrawCountDown != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mWindowDrawCountDown.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Log.e(mTag, <span class="string">&quot;Window redraw count down interrupted!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mWindowDrawCountDown = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mAttachInfo.mThreadedRenderer.setStopped(mStopped);</span><br><span class="line">            &#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.113</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): FINISHED DRAWING: com.android.testred/com.android.testred.TestActivity</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (LOCAL_LOGV) &#123;</span><br><span class="line">                Log.v(mTag, <span class="string">&quot;FINISHED DRAWING: &quot;</span> + mWindowAttributes.getTitle());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//绘制完成后会执行回调</span></span><br><span class="line">            <span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span> &amp;&amp; mSurface.isValid()) &#123;</span><br><span class="line">                SurfaceCallbackHelper sch = <span class="keyword">new</span> SurfaceCallbackHelper(<span class="keyword">this</span>::postDrawFinished);</span><br><span class="line">                SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</span><br><span class="line"></span><br><span class="line">                sch.dispatchSurfaceRedrawNeededAsync(mSurfaceHolder, callbacks);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!usingAsyncReport) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mAttachInfo.mThreadedRenderer.fence();</span><br><span class="line">                &#125;</span><br><span class="line">                pendingDrawFinished();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</span><br><span class="line">        Surface surface = mSurface;</span><br><span class="line">        <span class="keyword">if</span> (!surface.isValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_FPS) &#123;</span><br><span class="line">            trackFPS();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!sFirstDrawComplete) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (sFirstDrawHandlers) &#123;</span><br><span class="line">                sFirstDrawComplete = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> count = sFirstDrawHandlers.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; count; i++) &#123;</span><br><span class="line">                    mHandler.post(sFirstDrawHandlers.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        scrollToRectOrFocus(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">final</span> Rect dirty = mDirty;</span><br><span class="line">        <span class="keyword">if</span> (mSurfaceHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// The app owns the surface, we won&#x27;t draw.</span></span><br><span class="line">            dirty.setEmpty();</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fullRedrawNeeded) &#123;</span><br><span class="line">            mAttachInfo.mIgnoreDirtyState = <span class="keyword">true</span>;</span><br><span class="line">            dirty.set(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">int</span>) (mWidth * appScale + <span class="number">0.5f</span>), (<span class="keyword">int</span>) (mHeight * appScale + <span class="number">0.5f</span>));</span><br><span class="line">        &#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.074</span> V/ViewRootImpl[TestActivity]( <span class="number">2602</span>): Draw DecorView@<span class="number">515e1</span>ca[TestActivity]/com.android.testred/com.android.testred.TestActivity: dirty=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">160</span>,<span class="number">854</span>&#125; surface=Surface(name=<span class="keyword">null</span>)/@<span class="number">0x266c9a5</span> surface.isValid()=<span class="keyword">true</span>, appScale:<span class="number">1.0</span>, width=<span class="number">160</span>, height=<span class="number">854</span></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ORIENTATION || DEBUG_DRAW) &#123;</span><br><span class="line">            Log.v(mTag, <span class="string">&quot;Draw &quot;</span> + mView + <span class="string">&quot;/&quot;</span></span><br><span class="line">                    + mWindowAttributes.getTitle()</span><br><span class="line">                    + <span class="string">&quot;: dirty=&#123;&quot;</span> + dirty.left + <span class="string">&quot;,&quot;</span> + dirty.top</span><br><span class="line">                    + <span class="string">&quot;,&quot;</span> + dirty.right + <span class="string">&quot;,&quot;</span> + dirty.bottom + <span class="string">&quot;&#125; surface=&quot;</span></span><br><span class="line">                    + surface + <span class="string">&quot; surface.isValid()=&quot;</span> + surface.isValid() + <span class="string">&quot;, appScale:&quot;</span> +</span><br><span class="line">                    appScale + <span class="string">&quot;, width=&quot;</span> + mWidth + <span class="string">&quot;, height=&quot;</span> + mHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAttachInfo.mTreeObserver.dispatchOnDraw();</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">return</span> useAsyncReport;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>布局完成后接着Vsync又一次Trigger 。(画图)</p>
<p>GLSurfaceView绘制流程</p>
<p><strong>GLSurfaceView提供了下列特性：</strong></p>
<blockquote>
<p>1&gt; 管理一个surface，这个surface就是一块特殊的内存，能直接排版到android的视图view上。<br>2&gt; 管理一个EGL display，它能让opengl把内容渲染到上述的surface上。<br>3&gt; 用户自定义渲染器(render)。<br>4&gt; 让渲染器在独立的线程里运作，和UI线程分离。<br>5&gt; 支持按需渲染(on-demand)和连续渲染(continuous)。<br>6&gt; 一些可选工具，如调试。</p>
</blockquote>
<p><strong>概念：</strong></p>
<blockquote>
<p>Display(EGLDisplay) 是对实际显示设备的抽象。<br>Surface（EGLSurface）是对用来存储图像的内存区域FrameBuffer的抽象，包括Color Buffer, Stencil Buffer ,Depth Buffer.<br>Context (EGLContext) 存储OpenGL ES绘图的一些状态信息。</p>
</blockquote>
<p><strong>步骤：</strong></p>
<blockquote>
<p>获取EGLDisplay对象<br>初始化与EGLDisplay 之间的连接。<br>获取EGLConfig对象<br>创建EGLContext 实例<br>创建EGLSurface实例<br>连接EGLContext和EGLSurface.<br>使用GL指令绘制图形<br>断开并释放与EGLSurface关联的EGLContext对象<br>删除EGLSurface对象<br>删除EGLContext对象<br>终止与EGLDisplay之间的连接。</p>
</blockquote>
<p>GLSurfaceView的主要绘制过程都是在一个子线程中完成，即整个绘制最终都是guardenRun()中完成。在这个过程中完成了整个EGL绘制的所有步骤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/opengl/java/android/opengl/GLSurfaceView.java</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">guardedRun</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            mEglHelper = <span class="keyword">new</span> EglHelper(mGLSurfaceViewWeakRef);</span><br><span class="line">            mHaveEglContext = <span class="keyword">false</span>;</span><br><span class="line">            mHaveEglSurface = <span class="keyword">false</span>;</span><br><span class="line">            mWantRenderNotification = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                GL10 gl = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">boolean</span> createEglContext = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> createEglSurface = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> createGlInterface = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> lostEglContext = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> sizeChanged = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> wantRenderNotification = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> doRenderNotification = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">boolean</span> askedToReleaseEglContext = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> w = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line">                Runnable event = <span class="keyword">null</span>;</span><br><span class="line">                Runnable finishDrawingRunnable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (sGLThreadManager) &#123;</span><br><span class="line">                        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                            ......</span><br><span class="line"></span><br><span class="line">                            ......</span><br><span class="line">                            <span class="keyword">if</span> (readyToDraw()) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// If we don&#x27;t have an EGL context, try to acquire one.</span></span><br><span class="line">                                <span class="keyword">if</span> (! mHaveEglContext) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (askedToReleaseEglContext) &#123;</span><br><span class="line">                                        askedToReleaseEglContext = <span class="keyword">false</span>;</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="keyword">try</span> &#123;</span><br><span class="line">                                            mEglHelper.start();</span><br><span class="line">                                        &#125; <span class="keyword">catch</span> (RuntimeException t) &#123;</span><br><span class="line">                                            ......</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        mHaveEglContext = <span class="keyword">true</span>;</span><br><span class="line">                                        createEglContext = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                                        sGLThreadManager.notifyAll();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (mHaveEglContext &amp;&amp; !mHaveEglSurface) &#123;</span><br><span class="line">                                    mHaveEglSurface = <span class="keyword">true</span>;</span><br><span class="line">                                    createEglSurface = <span class="keyword">true</span>;</span><br><span class="line">                                    createGlInterface = <span class="keyword">true</span>;</span><br><span class="line">                                    sizeChanged = <span class="keyword">true</span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (mHaveEglSurface) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (mSizeChanged) &#123;</span><br><span class="line">                                        sizeChanged = <span class="keyword">true</span>;</span><br><span class="line">                                        w = mWidth;</span><br><span class="line">                                        h = mHeight;</span><br><span class="line">                                        mWantRenderNotification = <span class="keyword">true</span>;</span><br><span class="line">                                        ......</span><br><span class="line">                                        createEglSurface = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                                        mSizeChanged = <span class="keyword">false</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    mRequestRender = <span class="keyword">false</span>;</span><br><span class="line">                                    ......</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                ......</span><br><span class="line">                            &#125;</span><br><span class="line">                            .......</span><br><span class="line">                            sGLThreadManager.wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; </span><br><span class="line">                    ......</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (createEglSurface) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (LOG_SURFACE) &#123;</span><br><span class="line">                            Log.w(<span class="string">&quot;GLThread&quot;</span>, <span class="string">&quot;egl createSurface&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (mEglHelper.createSurface()) &#123;</span><br><span class="line">                            <span class="keyword">synchronized</span>(sGLThreadManager) &#123;</span><br><span class="line">                                mFinishedCreatingEglSurface = <span class="keyword">true</span>;</span><br><span class="line">                                sGLThreadManager.notifyAll();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">synchronized</span>(sGLThreadManager) &#123;</span><br><span class="line">                                mFinishedCreatingEglSurface = <span class="keyword">true</span>;</span><br><span class="line">                                mSurfaceIsBad = <span class="keyword">true</span>;</span><br><span class="line">                                sGLThreadManager.notifyAll();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        createEglSurface = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (createGlInterface) &#123;</span><br><span class="line">                        gl = (GL10) mEglHelper.createGL();</span><br><span class="line"></span><br><span class="line">                        createGlInterface = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (createEglContext) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (LOG_RENDERER) &#123;</span><br><span class="line">                            Log.w(<span class="string">&quot;GLThread&quot;</span>, <span class="string">&quot;onSurfaceCreated&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        GLSurfaceView view = mGLSurfaceViewWeakRef.get();</span><br><span class="line">                        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                </span><br><span class="line">                                view.mRenderer.onSurfaceCreated(gl, mEglHelper.mEglConfig);</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                </span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        createEglContext = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (LOG_RENDERER) &#123;</span><br><span class="line">                            Log.w(<span class="string">&quot;GLThread&quot;</span>, <span class="string">&quot;onSurfaceChanged(&quot;</span> + w + <span class="string">&quot;, &quot;</span> + h + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        GLSurfaceView view = mGLSurfaceViewWeakRef.get();</span><br><span class="line">                        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">&quot;onSurfaceChanged&quot;</span>);</span><br><span class="line">                                view.mRenderer.onSurfaceChanged(gl, w, h);</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        sizeChanged = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (LOG_RENDERER_DRAW_FRAME) &#123;</span><br><span class="line">                        Log.w(<span class="string">&quot;GLThread&quot;</span>, <span class="string">&quot;onDrawFrame tid=&quot;</span> + getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#123;</span><br><span class="line">                        GLSurfaceView view = mGLSurfaceViewWeakRef.get();</span><br><span class="line">                        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">&quot;onDrawFrame&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span> (mFinishDrawingRunnable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    finishDrawingRunnable = mFinishDrawingRunnable;</span><br><span class="line">                                    mFinishDrawingRunnable = <span class="keyword">null</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                view.mRenderer.onDrawFrame(gl);</span><br><span class="line">                                <span class="keyword">if</span> (finishDrawingRunnable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    finishDrawingRunnable.run();</span><br><span class="line">                                    finishDrawingRunnable = <span class="keyword">null</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> swapError = mEglHelper.swap();</span><br><span class="line">                    .......</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * clean-up everything...</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">synchronized</span> (sGLThreadManager) &#123;</span><br><span class="line">                    stopEglSurfaceLocked();</span><br><span class="line">                    stopEglContextLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>我们直接看看GLSurfaceView绘制的过程，绘制过程opengl准备工作。</p>
<h5 id="5-1、EglHelper-start"><a href="#5-1、EglHelper-start" class="headerlink" title="5.1、EglHelper.start()"></a>5.1、EglHelper.start()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GLSurfaceView 绘制流程分析</span></span><br><span class="line">/frameworks/base/opengl/java/android/opengl/GLSurfaceView.java</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EglHelper</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EglHelper</span><span class="params">(WeakReference&lt;GLSurfaceView&gt; glSurfaceViewWeakRef)</span> </span>&#123;</span><br><span class="line">            mGLSurfaceViewWeakRef = glSurfaceViewWeakRef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG_EGL) &#123;</span><br><span class="line">                Log.w(<span class="string">&quot;EglHelper&quot;</span>, <span class="string">&quot;start() tid=&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mEgl = (EGL10) EGLContext.getEGL();</span><br><span class="line"></span><br><span class="line">            mEglDisplay = mEgl.eglGetDisplay(EGL10.EGL_DEFAULT_DISPLAY);</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">int</span>[] version = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">if</span>(!mEgl.eglInitialize(mEglDisplay, version)) &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">            GLSurfaceView view = mGLSurfaceViewWeakRef.get();</span><br><span class="line">            <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mEglConfig = <span class="keyword">null</span>;</span><br><span class="line">                mEglContext = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mEglConfig = view.mEGLConfigChooser.chooseConfig(mEgl, mEglDisplay);</span><br><span class="line"></span><br><span class="line">                mEglContext = view.mEGLContextFactory.createContext(mEgl, mEglDisplay, mEglConfig);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mEglContext == <span class="keyword">null</span> || mEglContext == EGL10.EGL_NO_CONTEXT) &#123;</span><br><span class="line">                mEglContext = <span class="keyword">null</span>;</span><br><span class="line">                throwEglException(<span class="string">&quot;createContext&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mEglSurface = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> WeakReference&lt;GLSurfaceView&gt; mGLSurfaceViewWeakRef;</span><br><span class="line">        EGL10 mEgl;</span><br><span class="line">        EGLDisplay mEglDisplay;</span><br><span class="line">        EGLSurface mEglSurface;</span><br><span class="line">        EGLConfig mEglConfig;</span><br><span class="line">        EGLContext mEglContext;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mEglHelper.start()就完成了4步：</p>
<ul>
<li><p>1，获取EGLDisplay对象</p>
</li>
<li><p>2，初始化与EGLDisplay 之间的连接。</p>
</li>
<li><p>3，获取EGLConfig对象</p>
</li>
<li><p>4，创建EGLContext 实例</p>
</li>
</ul>
<p>接下来createSurface()</p>
<h5 id="5-2、EglHelper-createSurface"><a href="#5-2、EglHelper-createSurface" class="headerlink" title="5.2、EglHelper.createSurface()"></a>5.2、EglHelper.createSurface()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EglHelper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EglHelper</span><span class="params">(WeakReference&lt;GLSurfaceView&gt; glSurfaceViewWeakRef)</span> </span>&#123;</span><br><span class="line">        mGLSurfaceViewWeakRef = glSurfaceViewWeakRef;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">createSurface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG_EGL) &#123;</span><br><span class="line">            Log.w(<span class="string">&quot;EglHelper&quot;</span>, <span class="string">&quot;createSurface()  tid=&quot;</span> + Thread.currentThread().getId());</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        GLSurfaceView view = mGLSurfaceViewWeakRef.get();</span><br><span class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mEglSurface = view.mEGLWindowSurfaceFactory.createWindowSurface(mEgl,</span><br><span class="line">                    mEglDisplay, mEglConfig, view.getHolder());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mEglSurface = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (!mEgl.eglMakeCurrent(mEglDisplay, mEglSurface, mEglSurface, mEglContext)) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">private</span> WeakReference&lt;GLSurfaceView&gt; mGLSurfaceViewWeakRef;</span><br><span class="line">    EGL10 mEgl;</span><br><span class="line">    EGLDisplay mEglDisplay;</span><br><span class="line">    EGLSurface mEglSurface;</span><br><span class="line">    EGLConfig mEglConfig;</span><br><span class="line">    EGLContext mEglContext;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终会调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/native/opengl/libs/EGL/eglApi.cpp</span><br><span class="line"><span class="function">EGLSurface <span class="title">eglCreateWindowSurface</span><span class="params">(  EGLDisplay dpy, EGLConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    NativeWindowType window,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">const</span> EGLint *attrib_list)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> EGLint *origAttribList = attrib_list;</span><br><span class="line">    clearError();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">egl_connection_t</span>* cnx = <span class="literal">NULL</span>;</span><br><span class="line">    egl_display_ptr dp = validate_display_connection(dpy, cnx);</span><br><span class="line">    <span class="keyword">if</span> (dp) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">int</span> value = <span class="number">0</span>;</span><br><span class="line">        window-&gt;query(window, NATIVE_WINDOW_IS_VALID, &amp;value);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> result = native_window_api_connect(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EGLDisplay iDpy = dp-&gt;disp.dpy;</span><br><span class="line">        android_pixel_format format;</span><br><span class="line">        getNativePixelFormat(iDpy, cnx, config, &amp;format);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now select correct colorspace and dataspace based on user&#x27;s attribute list</span></span><br><span class="line">        EGLint colorSpace = EGL_UNKNOWN;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;EGLint&gt; strippedAttribList;</span><br><span class="line">        <span class="keyword">if</span> (!processAttributes(dp, window, format, attrib_list, &amp;colorSpace,</span><br><span class="line">                               &amp;strippedAttribList)) &#123;</span><br><span class="line">           ......</span><br><span class="line">        &#125;</span><br><span class="line">        attrib_list = strippedAttribList.data();</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> err = native_window_set_buffers_format(window, format);</span><br><span class="line">            ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        android_dataspace dataSpace = dataSpaceFromEGLColorSpace(colorSpace);</span><br><span class="line">        <span class="keyword">if</span> (dataSpace != HAL_DATASPACE_UNKNOWN) &#123;</span><br><span class="line">            <span class="keyword">int</span> err = native_window_set_buffers_data_space(window, dataSpace);</span><br><span class="line">            ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// the EGL spec requires that a new EGLSurface default to swap interval</span></span><br><span class="line">        <span class="comment">// 1, so explicitly set that on the window here.</span></span><br><span class="line">        ANativeWindow* anw = <span class="keyword">reinterpret_cast</span>&lt;ANativeWindow*&gt;(window);</span><br><span class="line">        anw-&gt;setSwapInterval(anw, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        EGLSurface surface = cnx-&gt;egl.eglCreateWindowSurface(</span><br><span class="line">                iDpy, config, window, attrib_list);</span><br><span class="line">        <span class="keyword">if</span> (surface != EGL_NO_SURFACE) &#123;</span><br><span class="line">            <span class="keyword">egl_surface_t</span>* s =</span><br><span class="line">                    <span class="keyword">new</span> <span class="keyword">egl_surface_t</span>(dp.get(), config, window, surface,</span><br><span class="line">                                      getReportedColorSpace(colorSpace), cnx);</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// EGLSurface creation failed</span></span><br><span class="line">        native_window_set_buffers_format(window, <span class="number">0</span>);</span><br><span class="line">        native_window_api_disconnect(window, NATIVE_WINDOW_API_EGL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EGL_NO_SURFACE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"> I/OpenGLRenderer( <span class="number">2602</span>): Initialized EGL, version <span class="number">1.4</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.030</span> D/OpenGLRenderer( <span class="number">2602</span>): Swap behavior <span class="number">2</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.040</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.040</span> V/Surface ( <span class="number">2602</span>): Surface::connect</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.041</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] connect: api=<span class="number">1</span> producerControlledByApp=<span class="literal">false</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.042</span> V/Surface ( <span class="number">2602</span>): Surface::setBuffersFormat</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.042</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] setAsyncMode: async = <span class="number">0</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.042</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.042</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] query: <span class="number">10</span>? <span class="number">2304</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.043</span> V/Surface ( <span class="number">2602</span>): Surface::setUsage</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.043</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.043</span> I/chatty  ( <span class="number">2602</span>): uid=<span class="number">10088</span>(com.android.testred) GLThread <span class="number">199</span> identical <span class="number">1</span> line</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.043</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.043</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] query: <span class="number">10</span>? <span class="number">2304</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.043</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.044</span> V/BufferQueueProducer(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] connect: api=<span class="number">1</span> producerControlledByApp=<span class="literal">true</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.045</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.045</span> V/BufferQueueProducer(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] query: <span class="number">10</span>? <span class="number">2304</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.046</span> V/Surface ( <span class="number">2602</span>): Surface::query</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.047</span> V/Surface ( <span class="number">2602</span>): Surface::setBuffersDimensions</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="5-3、-mEgl-eglMakeCurrent"><a href="#5-3、-mEgl-eglMakeCurrent" class="headerlink" title="5.3、 mEgl.eglMakeCurrent()"></a>5.3、 mEgl.eglMakeCurrent()</h5><p>现在用于绘制图像的Surface已经创建好啦</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">  -&gt; eglMakeCurrent </span><br><span class="line">    -&gt; eglMakeCurrent(OEM EGL) </span><br><span class="line">      -&gt; <span class="keyword">egl_window_surface_v2_t</span>::connect()</span><br><span class="line">      -&gt; Surface::hook_dequeueBuffer() </span><br><span class="line">        -&gt; Surface::dequeueBuffer() </span><br><span class="line">            -&gt; BpGraphicBufferProducer::dequeueBuffer()</span><br><span class="line">            -&gt; BpGraphicBufferProducer::requestBuffer()</span><br><span class="line"></span><br><span class="line">对应<span class="built_in">log</span>：</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.047</span> V/Surface ( <span class="number">2602</span>): Surface::dequeueBuffer</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.047</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] dequeueBuffer: w=<span class="number">160</span> h=<span class="number">816</span> format=<span class="number">0x2</span>, usage=<span class="number">0x10000900</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.047</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] dequeueBuffer: setting buffer age to <span class="number">0</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.047</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] dequeueBuffer: allocating a <span class="keyword">new</span> buffer <span class="keyword">for</span> slot <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.048</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] dequeueBuffer: returning slot=<span class="number">0</span>/<span class="number">0</span> buf=<span class="number">0x7075427380</span> flags=<span class="number">0x1</span></span><br><span class="line"></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.048</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] requestBuffer: slot <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.059</span> V/Surface ( <span class="number">2602</span>): Surface::setBuffersTransform</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.059</span> V/Surface ( <span class="number">2602</span>): Surface::queueBuffer</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.059</span> V/Surface ( <span class="number">2602</span>): Surface::queueBuffer making up timestamp: <span class="number">83377.24</span> ms</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] </span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/ConsumerBase(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] onFrameAvailable</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/ConsumerBase(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] actually calling onFrameAvailable</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] addAndGetFrameTimestamps</span><br><span class="line"></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferQueueProducer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] query: <span class="number">11</span>? <span class="number">0</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] updateTexImage</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferQueueConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] acquireBuffer: accept desire=<span class="number">83377236737</span> expect=<span class="number">83393818427</span> (<span class="number">-16581690</span>) now=<span class="number">83378380070</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferQueueConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] acquireBuffer: acquiring &#123; slot=<span class="number">0</span>/<span class="number">1</span> buffer=<span class="number">0x7075427380</span> &#125;</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/ConsumerBase(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] acquireBufferLocked: -&gt; slot=<span class="number">0</span>/<span class="number">1</span></span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] syncForReleaseLocked</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] updateAndRelease: (slot=<span class="number">-1</span> buf=<span class="number">0x0</span>) -&gt; (slot=<span class="number">0</span> buf=<span class="number">0x7075427380</span>)</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.060</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] computeCurrentTransformMatrixLocked</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.061</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] getFrameNumber</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.061</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] getFrameNumber</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.061</span> V/BufferLayerConsumer(  <span class="number">739</span>): [SurfaceView - com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>]</span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时可以看到进行一了一次queueBuffer()操作。此时由于还没有进行绘制操作，所以屏幕肯定是没有显示的。</p>
<h5 id="5-4、Renderer-onDrawFrame"><a href="#5-4、Renderer-onDrawFrame" class="headerlink" title="5.4、Renderer.onDrawFrame()"></a>5.4、Renderer.onDrawFrame()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/packages/apps/TestViewportRed/src/com/android/testred/TestView.java</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    TestView(Context context) &#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setRenderer(<span class="keyword">new</span> Renderer());</span><br><span class="line">        setRenderMode(RENDERMODE_WHEN_DIRTY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Renderer</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;Renderer&quot;</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 gl, EGLConfig config)</span> </span>&#123;</span><br><span class="line">                gl.glClearColor(<span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 gl, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">                gl.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</span><br><span class="line">                gl.glClear(GL10.GL_COLOR_BUFFER_BIT);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时图像数据已经用OpenGl绘制好了，一块红色的区域（160x854）;</p>
<h5 id="5-5、finishDrawingRunnable-run"><a href="#5-5、finishDrawingRunnable-run" class="headerlink" title="5.5、finishDrawingRunnable.run()"></a>5.5、finishDrawingRunnable.run()</h5><p>接着会执行ViewRootImpl.java 的 postDrawFinished() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/android/view/ViewRootImpl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pendingDrawFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDrawsNeededToReport == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unbalanced drawPending/pendingDrawFinished calls&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mDrawsNeededToReport--;</span><br><span class="line">        <span class="keyword">if</span> (mDrawsNeededToReport == <span class="number">0</span>) &#123;</span><br><span class="line">            reportDrawFinished();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postDrawFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mHandler.sendEmptyMessage(MSG_DRAW_FINISHED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportDrawFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mDrawsNeededToReport = <span class="number">0</span>;</span><br><span class="line">            mWindowSession.finishDrawing(mWindow);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Have fun!</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mWindowSession.finishDrawing(mWindow) 通过binder通信进入</p>
<p>WMS。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/Session.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishDrawing</span><span class="params">(IWindow window)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">            TAG_WM, <span class="string">&quot;IWindow finishDrawing called for &quot;</span> + window);</span><br><span class="line">        mService.finishDrawingWindow(<span class="keyword">this</span>, window);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">finishDrawingWindow</span><span class="params">(Session session, IWindow client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mWindowMap) &#123;</span><br><span class="line">                WindowState win = windowForClientLocked(session, client, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.d(TAG_WM, <span class="string">&quot;finishDrawingWindow: &quot;</span> + win + <span class="string">&quot; mDrawState=&quot;</span></span><br><span class="line">                        + (win != <span class="keyword">null</span> ? win.mWinAnimator.drawStateToString() : <span class="string">&quot;null&quot;</span>));</span><br><span class="line">                <span class="keyword">if</span> (win != <span class="keyword">null</span> &amp;&amp; win.mWinAnimator.finishDrawingLocked()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((win.mAttrs.flags &amp; FLAG_SHOW_WALLPAPER) != <span class="number">0</span>) &#123;</span><br><span class="line">                        win.getDisplayContent().pendingLayoutChanges |=</span><br><span class="line">                                WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">                    &#125;</span><br><span class="line">                    win.setDisplayLayoutNeeded();</span><br><span class="line">                    mWindowPlacerLocked.requestTraversal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowState.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDisplayLayoutNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent dc = getDisplayContent();</span><br><span class="line">        <span class="keyword">if</span> (dc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            dc.setLayoutNeeded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setLayoutNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LAYOUT) Slog.w(TAG_WM, <span class="string">&quot;setLayoutNeeded: callers=&quot;</span> + Debug.getCallers(<span class="number">3</span>));</span><br><span class="line">        mLayoutNeeded = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.115</span> V/WindowManager( <span class="number">1049</span>): IWindow finishDrawing called <span class="keyword">for</span> android.view.IWindow$Stub$Proxy@<span class="number">44816e8</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.115</span> V/WindowManager( <span class="number">1049</span>): Looking up client android.os.BinderProxy<span class="meta">@b9baf64</span>: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.115</span> D/WindowManager( <span class="number">1049</span>): finishDrawingWindow: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; mDrawState=DRAW_PENDING</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.115</span> V/WindowStateAnimator( <span class="number">1049</span>): finishDrawingLocked: mDrawState=COMMIT_DRAW_PENDING Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; <span class="function">in <span class="title">Surface</span><span class="params">(name=com.android.testred/com.android.testred.TestActivity)</span>/@0xb17b0ce</span></span><br><span class="line"><span class="function">04-16 13:08:37.115 W/<span class="title">WindowManager</span><span class="params">( <span class="number">1049</span>)</span>: setLayoutNeeded: callers</span>=com.android.server.wm.WindowState.setDisplayLayoutNeeded:<span class="number">2250</span> com.android.server.wm.WindowManagerService.finishDrawingWindow:<span class="number">2305</span> com.android.server.wm.Session.finishDrawing:<span class="number">281</span> </span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h5 id="5-6、mEglHelper-swap"><a href="#5-6、mEglHelper-swap" class="headerlink" title="5.6、mEglHelper.swap()"></a>5.6、mEglHelper.swap()</h5><p>swap()最终会调用swapBuffers()函数的queueBuffer()通知SurfaceFlinger合成。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\opengl\libagl\egl.cpp]</span><br><span class="line"><span class="function">EGLBoolean <span class="title">egl_window_surface_v2_t::swapBuffers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">nativeWindow-&gt;queueBuffer(nativeWindow, buffer); </span><br><span class="line">nativeWindow-&gt;dequeueBuffer(nativeWindow, &amp;buffer);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.112</span> V/Surface ( <span class="number">2602</span>): Surface::queueBuffer</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.112</span> V/Surface ( <span class="number">2602</span>): Surface::queueBuffer making up timestamp: <span class="number">83429.66</span> ms</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.112</span> V/BufferQueueProducer(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] queueBuffer: slot=<span class="number">0</span>/<span class="number">1</span> time=<span class="number">83429663560</span> dataSpace=<span class="number">0</span> validHdrMetadataTypes=<span class="number">0x0</span> crop=[<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>] transform=<span class="number">0</span> scale=FREEZE</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.112</span> V/ConsumerBase(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] onFrameAvailable</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.112</span> V/ConsumerBase(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] actually calling onFrameAvailable</span><br><span class="line"><span class="number">04</span><span class="number">-16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.112</span> V/BufferQueueProducer(  <span class="number">739</span>): [com.android.testred/com.android.testred.TestActivity#<span class="number">0</span>] addAndGetFrameTimestamps</span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h5 id="5-7、WindowStateAnimator-commitFinishDrawingLocked"><a href="#5-7、WindowStateAnimator-commitFinishDrawingLocked" class="headerlink" title="5.7、WindowStateAnimator.commitFinishDrawingLocked()"></a>5.7、WindowStateAnimator.commitFinishDrawingLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.116</span> V/RootWindowContainer( <span class="number">1049</span>): performSurfacePlacementInner: entry. Called by com.android.server.wm.WindowSurfacePlacer.performSurfacePlacementLoop:<span class="number">207</span> com.android.server.wm.WindowSurfacePlacer.performSurfacePlacement:<span class="number">155</span> com.android.server.wm.WindowSurfacePlacer.performSurfacePlacement:<span class="number">145</span> </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.116</span> I/RootWindowContainer( <span class="number">1049</span>): &gt;&gt;&gt; OPEN TRANSACTION performLayoutAndPlaceSurfaces</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.116</span> W/WindowManager( <span class="number">1049</span>): clearLayoutNeeded: callers=com.android.server.wm.DisplayContent.performLayout:<span class="number">2967</span> com.android.server.wm.DisplayContent.applySurfaceChangesTransaction:<span class="number">2880</span> com.android.server.wm.RootWindowContainer.applySurfaceChangesTransaction:<span class="number">852</span> </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.116</span> V/DisplayContent( <span class="number">1049</span>): -------------------------------------</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.116</span> V/DisplayContent( <span class="number">1049</span>): performLayout: needed=<span class="keyword">false</span> dw=<span class="number">480</span> dh=<span class="number">854</span></span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>boolean applySurfaceChangesTransaction(boolean recoveringMemory)<br>方法中<br>performLayout(repeats == 1, false /* updateInputWindows */);进行布局</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.118</span> V/DisplayContent( <span class="number">1049</span>): <span class="number">1</span>ST PASS Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: gone=<span class="keyword">false</span> mHaveFrame=<span class="keyword">true</span> mLayoutAttached=<span class="keyword">false</span> screen changed=<span class="keyword">false</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.118</span> V/DisplayContent( <span class="number">1049</span>):   VIS: mViewVisibility=<span class="number">0</span> mRelayoutCalled=<span class="keyword">true</span> hidden=<span class="keyword">true</span> hiddenRequested=<span class="keyword">false</span> parentHidden=<span class="keyword">false</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.118</span> V/WindowManager( <span class="number">1049</span>): layoutWindowLw(com.android.testred/com.android.testred.TestActivity): IN_SCREEN, INSET_DECOR</span><br><span class="line">04-16 13:08:37.118 V/WindowManager( 1049): Compute frame com.android.testred/com.android.testred.TestActivity: sim=#120 attach=null type=1 flags=0x01810100 pf=[0,0][160,854] df=[0,0][160,854] of=[0,0][160,854] cf=[0,0][160,854] vf=[0,36][480,782] dcf=[0,36][480,782] sf=[0,36][480,782] osf=null</span><br></pre></td></tr></table></figure>
<p>接着看看boolean applySurfaceChangesTransaction(boolean recoveringMemory)<br>方法中的<br> forAllWindows(mApplySurfaceChangesTransaction, true /* traverseTopToBottom */);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Consumer&lt;WindowState&gt; mApplySurfaceChangesTransaction = w -&gt; &#123;</span><br><span class="line">        <span class="keyword">final</span> WindowSurfacePlacer surfacePlacer = mService.mWindowPlacerLocked;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> obscuredChanged = w.mObscured !=</span><br><span class="line">                mTmpApplySurfaceChangesTransactionState.obscured;</span><br><span class="line">        <span class="keyword">final</span> RootWindowContainer root = mService.mRoot;</span><br><span class="line">        <span class="comment">// Only used if default window</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> someoneLosingFocus = !mService.mLosingFocus.isEmpty();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update effect.</span></span><br><span class="line">        w.mObscured = mTmpApplySurfaceChangesTransactionState.obscured;</span><br><span class="line">        <span class="keyword">if</span> (!mTmpApplySurfaceChangesTransactionState.obscured) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isDisplayed = w.isDisplayedLw();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isDisplayed &amp;&amp; w.isObscuringDisplay()) &#123;</span><br><span class="line">                <span class="comment">// This window completely covers everything behind it, so we want to leave all</span></span><br><span class="line">                <span class="comment">// of them as undimmed (for performance reasons).</span></span><br><span class="line">                root.mObscuringWindow = w;</span><br><span class="line">                mTmpApplySurfaceChangesTransactionState.obscured = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mTmpApplySurfaceChangesTransactionState.displayHasContent |=</span><br><span class="line">                    root.handleNotObscuredLocked(w,</span><br><span class="line">                            mTmpApplySurfaceChangesTransactionState.obscured,</span><br><span class="line">                            mTmpApplySurfaceChangesTransactionState.syswin);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (w.mHasSurface &amp;&amp; isDisplayed) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> type = w.mAttrs.type;</span><br><span class="line">                <span class="keyword">if</span> (type == TYPE_SYSTEM_DIALOG || type == TYPE_SYSTEM_ERROR</span><br><span class="line">                        || (w.mAttrs.privateFlags &amp; PRIVATE_FLAG_KEYGUARD) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mTmpApplySurfaceChangesTransactionState.syswin = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mTmpApplySurfaceChangesTransactionState.preferredRefreshRate == <span class="number">0</span></span><br><span class="line">                        &amp;&amp; w.mAttrs.preferredRefreshRate != <span class="number">0</span>) &#123;</span><br><span class="line">                    mTmpApplySurfaceChangesTransactionState.preferredRefreshRate</span><br><span class="line">                            = w.mAttrs.preferredRefreshRate;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mTmpApplySurfaceChangesTransactionState.preferredModeId == <span class="number">0</span></span><br><span class="line">                        &amp;&amp; w.mAttrs.preferredDisplayModeId != <span class="number">0</span>) &#123;</span><br><span class="line">                    mTmpApplySurfaceChangesTransactionState.preferredModeId</span><br><span class="line">                            = w.mAttrs.preferredDisplayModeId;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isDefaultDisplay &amp;&amp; obscuredChanged &amp;&amp; w.isVisibleLw()</span><br><span class="line">                &amp;&amp; mWallpaperController.isWallpaperTarget(w)) &#123;</span><br><span class="line">            <span class="comment">// This is the wallpaper target and its obscured state changed... make sure the</span></span><br><span class="line">            <span class="comment">// current wallpaper&#x27;s visibility has been updated accordingly.</span></span><br><span class="line">            mWallpaperController.updateWallpaperVisibility();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        w.handleWindowMovedIfNeeded();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowStateAnimator winAnimator = w.mWinAnimator;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Slog.i(TAG, &quot;Window &quot; + this + &quot; clearing mContentChanged - done placing&quot;);</span></span><br><span class="line">        w.mContentChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Moved from updateWindowsAndWallpaperLocked().</span></span><br><span class="line">        <span class="keyword">if</span> (w.mHasSurface) &#123;</span><br><span class="line">            <span class="comment">// Take care of the window being ready to display.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> committed = winAnimator.commitFinishDrawingLocked();</span><br><span class="line">            <span class="keyword">if</span> (isDefaultDisplay &amp;&amp; committed) &#123;</span><br><span class="line">                <span class="keyword">if</span> (w.mAttrs.type == TYPE_DREAM) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">HACK:</span> When a dream is shown, it may at that point hide the lock screen.</span></span><br><span class="line">                    <span class="comment">// So we need to redo the layout to let the phone window manager make this</span></span><br><span class="line">                    <span class="comment">// happen.</span></span><br><span class="line">                    pendingLayoutChanges |= FINISH_LAYOUT_REDO_LAYOUT;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT_REPEATS) &#123;</span><br><span class="line">                        surfacePlacer.debugLayoutRepeats(</span><br><span class="line">                                <span class="string">&quot;dream and commitFinishDrawingLocked true&quot;</span>,</span><br><span class="line">                                pendingLayoutChanges);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((w.mAttrs.flags &amp; FLAG_SHOW_WALLPAPER) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_WALLPAPER_LIGHT) Slog.v(TAG,</span><br><span class="line">                            <span class="string">&quot;First draw done in potential wallpaper target &quot;</span> + w);</span><br><span class="line">                    root.mWallpaperMayChange = <span class="keyword">true</span>;</span><br><span class="line">                    pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_LAYOUT_REPEATS) &#123;</span><br><span class="line">                        surfacePlacer.debugLayoutRepeats(</span><br><span class="line">                                <span class="string">&quot;wallpaper and commitFinishDrawingLocked true&quot;</span>,</span><br><span class="line">                                pendingLayoutChanges);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AppWindowToken atoken = w.mAppToken;</span><br><span class="line">        <span class="keyword">if</span> (atoken != <span class="keyword">null</span>) &#123;</span><br><span class="line">            atoken.updateLetterboxSurface(w);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> updateAllDrawn = atoken.updateDrawnWindowStates(w);</span><br><span class="line">            <span class="keyword">if</span> (updateAllDrawn &amp;&amp; !mTmpUpdateAllDrawn.contains(atoken)) &#123;</span><br><span class="line">                mTmpUpdateAllDrawn.add(atoken);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isDefaultDisplay &amp;&amp; someoneLosingFocus &amp;&amp; w == mService.mCurrentFocus</span><br><span class="line">                &amp;&amp; w.isDisplayedLw()) &#123;</span><br><span class="line">            mTmpApplySurfaceChangesTransactionState.focusDisplayed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        w.updateResizingWindowIfNeeded();</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowStateAnimator.java</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This must be called while inside a transaction.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">commitFinishDrawingLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STARTING_WINDOW_VERBOSE &amp;&amp;</span><br><span class="line">                mWin.mAttrs.type == WindowManager.LayoutParams.TYPE_APPLICATION_STARTING) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;commitFinishDrawingLocked: &quot;</span> + mWin + <span class="string">&quot; cur mDrawState=&quot;</span></span><br><span class="line">                    + drawStateToString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mDrawState != COMMIT_DRAW_PENDING &amp;&amp; mDrawState != READY_TO_SHOW) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.123</span> I/WindowStateAnimator( <span class="number">1049</span>): commitFinishDrawingLocked: mDrawState=<span class="function">READY_TO_SHOW <span class="title">Surface</span><span class="params">(name=com.android.testred/com.android.testred.TestActivity)</span>/@0xb17b0ce</span></span><br><span class="line"><span class="function">---------------------------------------------------------</span></span><br><span class="line"><span class="function">        <span class="title">if</span> <span class="params">(DEBUG_ANIM)</span> </span>&#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;commitFinishDrawingLocked: mDrawState=READY_TO_SHOW &quot;</span> + mSurfaceController);</span><br><span class="line">        &#125;</span><br><span class="line">        mDrawState = READY_TO_SHOW;</span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">final</span> AppWindowToken atoken = mWin.mAppToken;</span><br><span class="line">        <span class="keyword">if</span> (atoken == <span class="keyword">null</span> || atoken.allDrawn || mWin.mAttrs.type == TYPE_APPLICATION_STARTING) &#123;</span><br><span class="line">            result = mWin.performShowLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="5-7-1、AppWindowToken-updateDrawnWindowStates"><a href="#5-7-1、AppWindowToken-updateDrawnWindowStates" class="headerlink" title="5.7.1、AppWindowToken.updateDrawnWindowStates()"></a>5.7.1、AppWindowToken.updateDrawnWindowStates()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/AppWindowToken.java</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> V/AppWindowToken( <span class="number">1049</span>): Eval win Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;: isDrawn=<span class="keyword">true</span>, isAnimationSet=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> V/AppWindowToken( <span class="number">1049</span>): tokenMayBeDrawn: AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125; w=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; numInteresting=<span class="number">1</span> freezingScreen=<span class="keyword">false</span> mAppFreezing=<span class="keyword">false</span></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">updateDrawnWindowStates</span><span class="params">(WindowState w)</span> </span>&#123;</span><br><span class="line">        w.setDrawnStateEvaluated(<span class="keyword">true</span> <span class="comment">/*evaluated*/</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STARTING_WINDOW_VERBOSE &amp;&amp; w == startingWindow) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">&quot;updateWindows: starting &quot;</span> + w + <span class="string">&quot; isOnScreen=&quot;</span> + w.isOnScreen()</span><br><span class="line">                    + <span class="string">&quot; allDrawn=&quot;</span> + allDrawn + <span class="string">&quot; freezingScreen=&quot;</span> + mFreezingScreen);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allDrawn &amp;&amp; !mFreezingScreen) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLastTransactionSequence != mService.mTransactionSequence) &#123;</span><br><span class="line">            mLastTransactionSequence = mService.mTransactionSequence;</span><br><span class="line">            mNumDrawnWindows = <span class="number">0</span>;</span><br><span class="line">            startingDisplayed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// There is the main base application window, even if it is exiting, wait for it</span></span><br><span class="line">            mNumInterestingWindows = findMainWindow(<span class="keyword">false</span> <span class="comment">/* includeStartingApp */</span>) != <span class="keyword">null</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WindowStateAnimator winAnimator = w.mWinAnimator;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isInterestingAndDrawn = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allDrawn &amp;&amp; w.mightAffectAllDrawn()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_VISIBILITY || DEBUG_ORIENTATION) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">&quot;Eval win &quot;</span> + w + <span class="string">&quot;: isDrawn=&quot;</span> + w.isDrawnLw()</span><br><span class="line">                        + <span class="string">&quot;, isAnimationSet=&quot;</span> + isSelfAnimating());</span><br><span class="line">                <span class="keyword">if</span> (!w.isDrawnLw()) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">&quot;Not displayed: s=&quot;</span> + winAnimator.mSurfaceController</span><br><span class="line">                            + <span class="string">&quot; pv=&quot;</span> + w.mPolicyVisibility</span><br><span class="line">                            + <span class="string">&quot; mDrawState=&quot;</span> + winAnimator.drawStateToString()</span><br><span class="line">                            + <span class="string">&quot; ph=&quot;</span> + w.isParentWindowHidden() + <span class="string">&quot; th=&quot;</span> + hiddenRequested</span><br><span class="line">                            + <span class="string">&quot; a=&quot;</span> + isSelfAnimating());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (w != startingWindow) &#123;</span><br><span class="line">                <span class="keyword">if</span> (w.isInteresting()) &#123;</span><br><span class="line">                    <span class="comment">// Add non-main window as interesting since the main app has already been added</span></span><br><span class="line">                    <span class="keyword">if</span> (findMainWindow(<span class="keyword">false</span> <span class="comment">/* includeStartingApp */</span>) != w) &#123;</span><br><span class="line">                        mNumInterestingWindows++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (w.isDrawnLw()) &#123;</span><br><span class="line">                        mNumDrawnWindows++;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_VISIBILITY || DEBUG_ORIENTATION) Slog.v(TAG, <span class="string">&quot;tokenMayBeDrawn: &quot;</span></span><br><span class="line">                                + <span class="keyword">this</span> + <span class="string">&quot; w=&quot;</span> + w + <span class="string">&quot; numInteresting=&quot;</span> + mNumInterestingWindows</span><br><span class="line">                                + <span class="string">&quot; freezingScreen=&quot;</span> + mFreezingScreen</span><br><span class="line">                                + <span class="string">&quot; mAppFreezing=&quot;</span> + w.mAppFreezing);</span><br><span class="line"></span><br><span class="line">                        isInterestingAndDrawn = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (w.isDrawnLw()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getController() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    getController().reportStartingWindowDrawn();</span><br><span class="line">                &#125;</span><br><span class="line">                startingDisplayed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> isInterestingAndDrawn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-8、DisplayContent-prepareSurfaces"><a href="#5-8、DisplayContent-prepareSurfaces" class="headerlink" title="5.8、DisplayContent.prepareSurfaces()"></a>5.8、DisplayContent.prepareSurfaces()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareSurfaces</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">super</span>.prepareSurfaces();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowContainer.java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareSurfaces</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SurfaceControl.mergeToGlobalTransaction(getPendingTransaction());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If a leash has been set when the transaction was committed, then the leash reparent has</span></span><br><span class="line">        <span class="comment">// been committed.</span></span><br><span class="line">        mCommittedReparentToAnimationLeash = mSurfaceAnimator.hasLeash();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mChildren.size(); i++) &#123;</span><br><span class="line">            mChildren.get(i).prepareSurfaces();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowState.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareSurfaces</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Dimmer dimmer = getDimmer();</span><br><span class="line">        mIsDimming = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (dimmer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            applyDims(dimmer);</span><br><span class="line">        &#125;</span><br><span class="line">        updateSurfacePosition();</span><br><span class="line"></span><br><span class="line">        mWinAnimator.prepareSurfaceLocked(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">super</span>.prepareSurfaces();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowStateAnimator.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareSurfaceLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState w = mWin;</span><br><span class="line">        <span class="keyword">if</span> (!hasSurface()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// There is no need to wait for an animation change if our window is gone for layout</span></span><br><span class="line">            <span class="comment">// already as we&#x27;ll never be visible.</span></span><br><span class="line">            <span class="keyword">if</span> (w.getOrientationChanging() &amp;&amp; w.isGoneForLayoutLw()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ORIENTATION) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">&quot;Orientation change skips hidden &quot;</span> + w);</span><br><span class="line">                &#125;</span><br><span class="line">                w.setOrientationChanging(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> displayed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        computeShownFrameLocked();</span><br><span class="line"></span><br><span class="line">        setSurfaceBoundariesLocked(recoveringMemory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mIsWallpaper &amp;&amp; !w.mWallpaperVisible) &#123;</span><br><span class="line">            <span class="comment">// Wallpaper is no longer visible and there is no wp target =&gt; hide it.</span></span><br><span class="line">            hide(<span class="string">&quot;prepareSurfaceLocked&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (w.isParentWindowHidden() || !w.isOnScreen()) &#123;</span><br><span class="line">            hide(<span class="string">&quot;prepareSurfaceLocked&quot;</span>);</span><br><span class="line">            mWallpaperControllerLocked.hideWallpapers(w);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we are waiting for this window to handle an orientation change. If this window is</span></span><br><span class="line">            <span class="comment">// really hidden (gone for layout), there is no point in still waiting for it.</span></span><br><span class="line">            <span class="comment">// Note that this does introduce a potential glitch if the window becomes unhidden</span></span><br><span class="line">            <span class="comment">// before it has drawn for the new orientation.</span></span><br><span class="line">            <span class="keyword">if</span> (w.getOrientationChanging() &amp;&amp; w.isGoneForLayoutLw()) &#123;</span><br><span class="line">                w.setOrientationChanging(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ORIENTATION) Slog.v(TAG,</span><br><span class="line">                        <span class="string">&quot;Orientation change skips hidden &quot;</span> + w);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLastLayer != mAnimLayer</span><br><span class="line">                || mLastAlpha != mShownAlpha</span><br><span class="line">                || mLastDsDx != mDsDx</span><br><span class="line">                || mLastDtDx != mDtDx</span><br><span class="line">                || mLastDsDy != mDsDy</span><br><span class="line">                || mLastDtDy != mDtDy</span><br><span class="line">                || w.mLastHScale != w.mHScale</span><br><span class="line">                || w.mLastVScale != w.mVScale</span><br><span class="line">                || mLastHidden) &#123;</span><br><span class="line">            displayed = <span class="keyword">true</span>;</span><br><span class="line">            mLastAlpha = mShownAlpha;</span><br><span class="line">            mLastLayer = mAnimLayer;</span><br><span class="line">            mLastDsDx = mDsDx;</span><br><span class="line">            mLastDtDx = mDtDx;</span><br><span class="line">            mLastDsDy = mDsDy;</span><br><span class="line">            mLastDtDy = mDtDy;</span><br><span class="line">            w.mLastHScale = w.mHScale;</span><br><span class="line">            w.mLastVScale = w.mVScale;</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> I/WindowManager( <span class="number">1049</span>):   SURFACE controller=Surface(name=com.android.testred/com.android.testred.TestActivity)/@<span class="number">0xb17b0ceal</span>pha=<span class="number">1.0</span> layer=<span class="number">0</span> matrix=[<span class="number">1.0</span>*<span class="number">1.0</span>,<span class="number">0.0</span>*<span class="number">1.0</span>][<span class="number">0.0</span>*<span class="number">1.0</span>,<span class="number">1.0</span>*<span class="number">1.0</span>]: Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (SHOW_TRANSACTIONS) WindowManagerService.logSurface(w,</span><br><span class="line">                    <span class="string">&quot;controller=&quot;</span> + mSurfaceController +</span><br><span class="line">                    <span class="string">&quot;alpha=&quot;</span> + mShownAlpha + <span class="string">&quot; layer=&quot;</span> + mAnimLayer</span><br><span class="line">                    + <span class="string">&quot; matrix=[&quot;</span> + mDsDx + <span class="string">&quot;*&quot;</span> + w.mHScale</span><br><span class="line">                    + <span class="string">&quot;,&quot;</span> + mDtDx + <span class="string">&quot;*&quot;</span> + w.mVScale</span><br><span class="line">                    + <span class="string">&quot;][&quot;</span> + mDtDy + <span class="string">&quot;*&quot;</span> + w.mHScale</span><br><span class="line">                    + <span class="string">&quot;,&quot;</span> + mDsDy + <span class="string">&quot;*&quot;</span> + w.mVScale + <span class="string">&quot;]&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> prepared =</span><br><span class="line">                mSurfaceController.prepareToShowInTransaction(mShownAlpha,</span><br><span class="line">                        mDsDx * w.mHScale * mExtraHScale,</span><br><span class="line">                        mDtDx * w.mVScale * mExtraVScale,</span><br><span class="line">                        mDtDy * w.mHScale * mExtraHScale,</span><br><span class="line">                        mDsDy * w.mVScale * mExtraVScale,</span><br><span class="line">                        recoveringMemory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (prepared &amp;&amp; mDrawState == HAS_DRAWN) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mLastHidden) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (showSurfaceRobustlyLocked()) &#123;</span><br><span class="line">                        markPreservedSurfaceForDestroy();</span><br><span class="line">                        mAnimator.requestRemovalOfReplacedWindows(w);</span><br><span class="line">                        mLastHidden = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">if</span> (mIsWallpaper) &#123;</span><br><span class="line">                            w.dispatchWallpaperVisibility(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// This draw means the difference between unique content and mirroring.</span></span><br><span class="line">                        <span class="comment">// Run another pass through performLayout to set mHasContent in the</span></span><br><span class="line">                        <span class="comment">// LogicalDisplay.</span></span><br><span class="line">                        mAnimator.setPendingLayoutChanges(w.getDisplayId(),</span><br><span class="line">                                FINISH_LAYOUT_REDO_ANIM);</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_LAYOUT_REPEATS) &#123;</span><br><span class="line">                            mService.mWindowPlacerLocked.debugLayoutRepeats(</span><br><span class="line">                                    <span class="string">&quot;showSurfaceRobustlyLocked &quot;</span> + w,</span><br><span class="line">                                    mAnimator.getPendingLayoutChanges(w.getDisplayId()));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        w.setOrientationChanging(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (hasSurface()) &#123;</span><br><span class="line">                w.mToken.hasVisible = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ANIM &amp;&amp; isAnimationSet()) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">&quot;prepareSurface: No changes in animation for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            displayed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (w.getOrientationChanging()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!w.isDrawnLw()) &#123;</span><br><span class="line">                mAnimator.mBulkUpdateParams &amp;= ~SET_ORIENTATION_CHANGE_COMPLETE;</span><br><span class="line">                mAnimator.mLastWindowFreezeSource = w;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ORIENTATION) Slog.v(TAG,</span><br><span class="line">                        <span class="string">&quot;Orientation continue waiting for draw in &quot;</span> + w);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                w.setOrientationChanging(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ORIENTATION) Slog.v(TAG, <span class="string">&quot;Orientation change complete in &quot;</span> + w);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (displayed) &#123;</span><br><span class="line">            w.mToken.hasVisible = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-8-1、WindowStateAnimator-computeShownFrameLocked"><a href="#5-8-1、WindowStateAnimator-computeShownFrameLocked" class="headerlink" title="5.8.1、WindowStateAnimator.computeShownFrameLocked()"></a>5.8.1、WindowStateAnimator.computeShownFrameLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowStateAnimator.java</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">computeShownFrameLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> displayId = mWin.getDisplayId();</span><br><span class="line">        <span class="keyword">final</span> ScreenRotationAnimation screenRotationAnimation =</span><br><span class="line">                mAnimator.getScreenRotationAnimationLocked(displayId);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> screenAnimation =</span><br><span class="line">                screenRotationAnimation != <span class="keyword">null</span> &amp;&amp; screenRotationAnimation.isAnimating();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (screenAnimation) &#123;</span><br><span class="line">            <span class="comment">// cache often used attributes locally</span></span><br><span class="line">            <span class="keyword">final</span> Rect frame = mWin.mFrame;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> tmpFloats[] = mService.mTmpFloats;</span><br><span class="line">            <span class="keyword">final</span> Matrix tmpMatrix = mWin.mTmpMatrix;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Compute the desired transformation.</span></span><br><span class="line">            <span class="keyword">if</span> (screenRotationAnimation.isRotating()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">float</span> w = frame.width();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">float</span> h = frame.height();</span><br><span class="line">                <span class="keyword">if</span> (w&gt;=<span class="number">1</span> &amp;&amp; h&gt;=<span class="number">1</span>) &#123;</span><br><span class="line">                    tmpMatrix.setScale(<span class="number">1</span> + <span class="number">2</span>/w, <span class="number">1</span> + <span class="number">2</span>/h, w/<span class="number">2</span>, h/<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tmpMatrix.reset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tmpMatrix.reset();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            tmpMatrix.postScale(mWin.mGlobalScale, mWin.mGlobalScale);</span><br><span class="line">            ......</span><br><span class="line">         tmpMatrix.postTranslate(mWin.mAttrs.surfaceInsets.left,</span><br><span class="line">                    mWin.mAttrs.surfaceInsets.top);</span><br><span class="line">            ......</span><br><span class="line">            mHaveMatrix = <span class="keyword">true</span>;</span><br><span class="line">            tmpMatrix.getValues(tmpFloats);</span><br><span class="line">            mDsDx = tmpFloats[Matrix.MSCALE_X];</span><br><span class="line">            mDtDx = tmpFloats[Matrix.MSKEW_Y];</span><br><span class="line">            mDtDy = tmpFloats[Matrix.MSKEW_X];</span><br><span class="line">            mDsDy = tmpFloats[Matrix.MSCALE_Y];</span><br><span class="line">            ......</span><br><span class="line">            mShownAlpha = mAlpha;</span><br><span class="line">            <span class="keyword">if</span> (!mService.mLimitedAlphaCompositing</span><br><span class="line">                    || (!PixelFormat.formatHasAlpha(mWin.mAttrs.format)</span><br><span class="line">                    || (mWin.isIdentityMatrix(mDsDx, mDtDx, mDtDy, mDsDy)))) &#123;</span><br><span class="line">                <span class="comment">//Slog.i(TAG_WM, &quot;Applying alpha transform&quot;);</span></span><br><span class="line">                <span class="keyword">if</span> (screenAnimation) &#123;</span><br><span class="line">                    mShownAlpha *= screenRotationAnimation.getEnterTransformation().getAlpha();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//Slog.i(TAG_WM, &quot;Not applying alpha transform&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((DEBUG_ANIM || WindowManagerService.localLOGV)</span><br><span class="line">                    &amp;&amp; (mShownAlpha == <span class="number">1.0</span> || mShownAlpha == <span class="number">0.0</span>)) Slog.v(</span><br><span class="line">                    TAG, <span class="string">&quot;computeShownFrameLocked: Animating &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; mAlpha=&quot;</span> + mAlpha</span><br><span class="line">                    + <span class="string">&quot; screen=&quot;</span> + (screenAnimation ?</span><br><span class="line">                            screenRotationAnimation.getEnterTransformation().getAlpha() : <span class="string">&quot;null&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mIsWallpaper &amp;&amp; mService.mRoot.mWallpaperActionPending) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mWin.isDragResizeChanged()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> V/WindowStateAnimator( <span class="number">1049</span>): computeShownFrameLocked: WindowStateAnimator&#123;<span class="number">4f</span>b81c9 com.android.testred/com.android.testred.TestActivity&#125; not attached, mAlpha=<span class="number">1.0</span></span><br><span class="line">---------------------------------------------------------</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WindowManagerService.localLOGV) Slog.v(</span><br><span class="line">                TAG, <span class="string">&quot;computeShownFrameLocked: &quot;</span> + <span class="keyword">this</span> +</span><br><span class="line">                <span class="string">&quot; not attached, mAlpha=&quot;</span> + mAlpha);</span><br><span class="line"></span><br><span class="line">        mShownAlpha = mAlpha;</span><br><span class="line">        mHaveMatrix = <span class="keyword">false</span>;</span><br><span class="line">        mDsDx = mWin.mGlobalScale;</span><br><span class="line">        mDtDx = <span class="number">0</span>;</span><br><span class="line">        mDtDy = <span class="number">0</span>;</span><br><span class="line">        mDsDy = mWin.mGlobalScale;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-8-2、WindowStateAnimator-setSurfaceBoundariesLocked"><a href="#5-8-2、WindowStateAnimator-setSurfaceBoundariesLocked" class="headerlink" title="5.8.2、WindowStateAnimator.setSurfaceBoundariesLocked()"></a>5.8.2、WindowStateAnimator.setSurfaceBoundariesLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowStateAnimator.java</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">setSurfaceBoundariesLocked</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> WindowState w = mWin;</span><br><span class="line">        <span class="keyword">final</span> LayoutParams attrs = mWin.getAttrs();</span><br><span class="line">        <span class="keyword">final</span> Task task = w.getTask();</span><br><span class="line"></span><br><span class="line">        mTmpSize.set(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        calculateSurfaceBounds(w, attrs);</span><br><span class="line"></span><br><span class="line">        mExtraHScale = (<span class="keyword">float</span>) <span class="number">1.0</span>;</span><br><span class="line">        mExtraVScale = (<span class="keyword">float</span>) <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> wasForceScaled = mForceScaleUntilResize;</span><br><span class="line">        <span class="keyword">boolean</span> wasSeamlesslyRotated = w.mSeamlesslyRotated;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> relayout = !w.mRelayoutCalled || w.mInRelayout;</span><br><span class="line">        <span class="keyword">if</span> (relayout) &#123;</span><br><span class="line">            mSurfaceResized = mSurfaceController.setSizeInTransaction(</span><br><span class="line">                    mTmpSize.width(), mTmpSize.height(), recoveringMemory);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSurfaceResized = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mForceScaleUntilResize = mForceScaleUntilResize &amp;&amp; !mSurfaceResized;</span><br><span class="line">        .......</span><br><span class="line">        mService.markForSeamlessRotation(w, w.mSeamlesslyRotated &amp;&amp; !mSurfaceResized);</span><br><span class="line"></span><br><span class="line">        Rect clipRect = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (calculateCrop(mTmpClipRect)) &#123;</span><br><span class="line">            clipRect = mTmpClipRect;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> surfaceWidth = mSurfaceController.getWidth();</span><br><span class="line">        <span class="keyword">float</span> surfaceHeight = mSurfaceController.getHeight();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Rect insets = attrs.surfaceInsets;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isForceScaled()) &#123;</span><br><span class="line">            <span class="keyword">int</span> hInsets = insets.left + insets.right;</span><br><span class="line">            <span class="keyword">int</span> vInsets = insets.top + insets.bottom;</span><br><span class="line">            <span class="keyword">float</span> surfaceContentWidth = surfaceWidth - hInsets;</span><br><span class="line">            <span class="keyword">float</span> surfaceContentHeight = surfaceHeight - vInsets;</span><br><span class="line">            <span class="keyword">if</span> (!mForceScaleUntilResize) &#123;</span><br><span class="line">                mSurfaceController.forceScaleableInTransaction(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> posX = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> posY = <span class="number">0</span>;</span><br><span class="line">            task.mStack.getDimBounds(mTmpStackBounds);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> allowStretching = <span class="keyword">false</span>;</span><br><span class="line">            task.mStack.getFinalAnimationSourceHintBounds(mTmpSourceBounds);</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (mTmpSourceBounds.isEmpty() &amp;&amp; (mWin.mLastRelayoutContentInsets.width() &gt; <span class="number">0</span></span><br><span class="line">                    || mWin.mLastRelayoutContentInsets.height() &gt; <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; !task.mStack.lastAnimatingBoundsWasToFullscreen()) &#123;</span><br><span class="line">                mTmpSourceBounds.set(task.mStack.mPreAnimationBounds);</span><br><span class="line">                mTmpSourceBounds.inset(mWin.mLastRelayoutContentInsets);</span><br><span class="line">                allowStretching = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">            mTmpStackBounds.intersectUnchecked(w.mParentFrame);</span><br><span class="line">            mTmpSourceBounds.intersectUnchecked(w.mParentFrame);</span><br><span class="line">            mTmpAnimatingBounds.intersectUnchecked(w.mParentFrame);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mTmpSourceBounds.isEmpty()) &#123;</span><br><span class="line">              task.mStack.getFinalAnimationBounds(mTmpAnimatingBounds);</span><br><span class="line">                <span class="keyword">float</span> finalWidth = mTmpAnimatingBounds.width();</span><br><span class="line">                <span class="keyword">float</span> initialWidth = mTmpSourceBounds.width();</span><br><span class="line">                <span class="keyword">float</span> tw = (surfaceContentWidth - mTmpStackBounds.width())</span><br><span class="line">                        / (surfaceContentWidth - mTmpAnimatingBounds.width());</span><br><span class="line">                <span class="keyword">float</span> th = tw;</span><br><span class="line">                mExtraHScale = (initialWidth + tw * (finalWidth - initialWidth)) / initialWidth;</span><br><span class="line">                <span class="keyword">if</span> (allowStretching) &#123;</span><br><span class="line">                    <span class="keyword">float</span> finalHeight = mTmpAnimatingBounds.height();</span><br><span class="line">                    <span class="keyword">float</span> initialHeight = mTmpSourceBounds.height();</span><br><span class="line">                    th = (surfaceContentHeight - mTmpStackBounds.height())</span><br><span class="line">                        / (surfaceContentHeight - mTmpAnimatingBounds.height());</span><br><span class="line">                    mExtraVScale = (initialHeight + tw * (finalHeight - initialHeight))</span><br><span class="line">                            / initialHeight;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mExtraVScale = mExtraHScale;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                .......</span><br><span class="line">                clipRect = mTmpClipRect;</span><br><span class="line">                clipRect.set((<span class="keyword">int</span>)((insets.left + mTmpSourceBounds.left) * tw),</span><br><span class="line">                        (<span class="keyword">int</span>)((insets.top + mTmpSourceBounds.top) * th),</span><br><span class="line">                        insets.left + (<span class="keyword">int</span>)(surfaceWidth</span><br><span class="line">                                - (tw* (surfaceWidth - mTmpSourceBounds.right))),</span><br><span class="line">                        insets.top + (<span class="keyword">int</span>)(surfaceHeight</span><br><span class="line">                                - (th * (surfaceHeight - mTmpSourceBounds.bottom))));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mExtraHScale = mTmpStackBounds.width() / surfaceContentWidth;</span><br><span class="line">                mExtraVScale = mTmpStackBounds.height() / surfaceContentHeight;</span><br><span class="line">                clipRect = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            posX -= (<span class="keyword">int</span>) (attrs.x * (<span class="number">1</span> - mExtraHScale));</span><br><span class="line">            posY -= (<span class="keyword">int</span>) (attrs.y * (<span class="number">1</span> - mExtraVScale));</span><br><span class="line">            posX += insets.left * (<span class="number">1</span> - mExtraHScale);</span><br><span class="line">            posY += insets.top * (<span class="number">1</span> - mExtraVScale);</span><br><span class="line"></span><br><span class="line">            mSurfaceController.setPositionInTransaction((<span class="keyword">float</span>) Math.floor(posX),</span><br><span class="line">                    (<span class="keyword">float</span>) Math.floor(posY), recoveringMemory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPipAnimationStarted == <span class="keyword">false</span>) &#123;</span><br><span class="line">                mForceScaleUntilResize = <span class="keyword">true</span>;</span><br><span class="line">                mPipAnimationStarted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPipAnimationStarted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!w.mSeamlesslyRotated) &#123;</span><br><span class="line">                <span class="comment">// Used to offset the WSA when stack position changes before a resize.</span></span><br><span class="line">                <span class="keyword">int</span> xOffset = mXOffset;</span><br><span class="line">                <span class="keyword">int</span> yOffset = mYOffset;</span><br><span class="line">                <span class="keyword">if</span> (mOffsetPositionForStackResize) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (relayout) &#123;</span><br><span class="line">                      setOffsetPositionForStackResize(<span class="keyword">false</span>);</span><br><span class="line">                        mSurfaceController.deferTransactionUntil(mSurfaceController.getHandle(),</span><br><span class="line">                                mWin.getFrameNumber());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> TaskStack stack = mWin.getStack();</span><br><span class="line">                        mTmpPos.x = <span class="number">0</span>;</span><br><span class="line">                        mTmpPos.y = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            stack.getRelativePosition(mTmpPos);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        xOffset = -mTmpPos.x;</span><br><span class="line">                        yOffset = -mTmpPos.y;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Crop also needs to be extended so the bottom isn&#x27;t cut off when the WSA</span></span><br><span class="line">                        <span class="comment">// position is moved.</span></span><br><span class="line">                        <span class="keyword">if</span> (clipRect != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            clipRect.right += mTmpPos.x;</span><br><span class="line">                            clipRect.bottom += mTmpPos.y;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                mSurfaceController.setPositionInTransaction(xOffset, yOffset, recoveringMemory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">setGeometryAppliesWithResizeInTransaction accomplishes <span class="keyword">this</span> <span class="keyword">for</span> us.</span><br><span class="line">        <span class="keyword">if</span> ((wasForceScaled &amp;&amp; !mForceScaleUntilResize) ||</span><br><span class="line">                (wasSeamlesslyRotated &amp;&amp; !w.mSeamlesslyRotated)) &#123;</span><br><span class="line">            mSurfaceController.setGeometryAppliesWithResizeInTransaction(<span class="keyword">true</span>);</span><br><span class="line">            mSurfaceController.forceScaleableInTransaction(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!w.mSeamlesslyRotated) &#123;</span><br><span class="line">            applyCrop(clipRect, recoveringMemory);</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> I/WindowSurfaceController( <span class="number">1049</span>):   SURFACE MATRIX [<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>]: com.android.testred/com.android.testred.TestActivity</span><br><span class="line">---------------------------------------------------------mSurfaceController.setMatrixInTransaction(mDsDx * w.mHScale * mExtraHScale,</span><br><span class="line">                    mDtDx * w.mVScale * mExtraVScale,</span><br><span class="line">                    mDtDy * w.mHScale * mExtraHScale,</span><br><span class="line">                    mDsDy * w.mVScale * mExtraVScale, recoveringMemory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSurfaceResized) &#123;</span><br><span class="line">            mReportSurfaceResized = <span class="keyword">true</span>;</span><br><span class="line">            mAnimator.setPendingLayoutChanges(w.getDisplayId(),</span><br><span class="line">                    FINISH_LAYOUT_REDO_WALLPAPER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="5-8-2-1、WindowStateAnimator-calculateCrop"><a href="#5-8-2-1、WindowStateAnimator-calculateCrop" class="headerlink" title="5.8.2.1、WindowStateAnimator.calculateCrop()"></a>5.8.2.1、WindowStateAnimator.calculateCrop()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">calculateCrop</span><span class="params">(Rect clipRect)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WindowState w = mWin;</span><br><span class="line">        <span class="keyword">final</span> DisplayContent displayContent = w.getDisplayContent();</span><br><span class="line">        clipRect.setEmpty();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (displayContent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (w.inPinnedWindowingMode()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we&#x27;re animating, the wallpaper should only</span></span><br><span class="line">        <span class="comment">// be updated at the end of the animation.</span></span><br><span class="line">        <span class="keyword">if</span> (w.mAttrs.type == TYPE_WALLPAPER) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> D/WindowStateAnimator( <span class="number">1049</span>): Updating crop win=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; mLastCrop=Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">160</span>, <span class="number">782</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> D/WindowStateAnimator( <span class="number">1049</span>): Applying decor to crop win=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; mDecorFrame=Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">480</span>, <span class="number">782</span>) mSystemDecorRect=Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">160</span>, <span class="number">782</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> D/WindowStateAnimator( <span class="number">1049</span>): win=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; Initial clip rect: Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">160</span>, <span class="number">782</span>) fullscreen=<span class="keyword">true</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> D/WindowStateAnimator( <span class="number">1049</span>): win=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; Clip rect after stack adjustment=Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">160</span>, <span class="number">782</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> D/WindowStateAnimator( <span class="number">1049</span>): </span><br><span class="line">---------------------------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_CROP) Slog.d(TAG,</span><br><span class="line">                <span class="string">&quot;Updating crop win=&quot;</span> + w + <span class="string">&quot; mLastCrop=&quot;</span> + mLastClipRect);</span><br><span class="line"></span><br><span class="line">        w.calculatePolicyCrop(mSystemDecorRect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_CROP) Slog.d(TAG, <span class="string">&quot;Applying decor to crop win=&quot;</span> + w + <span class="string">&quot; mDecorFrame=&quot;</span></span><br><span class="line">                + w.mDecorFrame + <span class="string">&quot; mSystemDecorRect=&quot;</span> + mSystemDecorRect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Task task = w.getTask();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> fullscreen = w.fillsDisplay() || (task != <span class="keyword">null</span> &amp;&amp; task.isFullscreen());</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isFreeformResizing =</span><br><span class="line">                w.isDragResizing() &amp;&amp; w.getResizeMode() == DRAG_RESIZE_MODE_FREEFORM;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We use the clip rect as provided by the tranformation for non-fullscreen windows to</span></span><br><span class="line">        <span class="comment">// avoid premature clipping with the system decor rect.</span></span><br><span class="line">        clipRect.set(mSystemDecorRect);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_CROP) Slog.d(TAG, <span class="string">&quot;win=&quot;</span> + w + <span class="string">&quot; Initial clip rect: &quot;</span> + clipRect</span><br><span class="line">                + <span class="string">&quot; fullscreen=&quot;</span> + fullscreen);</span><br><span class="line"></span><br><span class="line">        w.expandForSurfaceInsets(clipRect);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The clip rect was generated assuming (0,0) as the window origin,</span></span><br><span class="line">        <span class="comment">// so we need to translate to match the actual surface coordinates.</span></span><br><span class="line">        clipRect.offset(w.mAttrs.surfaceInsets.left, w.mAttrs.surfaceInsets.top);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_CROP) Slog.d(TAG,</span><br><span class="line">                <span class="string">&quot;win=&quot;</span> + w + <span class="string">&quot; Clip rect after stack adjustment=&quot;</span> + clipRect);</span><br><span class="line"></span><br><span class="line">        w.transformClipRectFromScreenToSurfaceSpace(clipRect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="5-8-2-2、WindowStateAnimator-applyCrop"><a href="#5-8-2-2、WindowStateAnimator-applyCrop" class="headerlink" title="5.8.2.2、WindowStateAnimator.applyCrop()"></a>5.8.2.2、WindowStateAnimator.applyCrop()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> D/WindowStateAnimator( <span class="number">1049</span>): applyCrop: win=Window&#123;c1255cd u0 com.android.testred/com.android.testred.TestActivity&#125; clipRect=Rect(<span class="number">0</span>, <span class="number">36</span> - <span class="number">160</span>, <span class="number">782</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.124</span> I/WindowSurfaceController( <span class="number">1049</span>):   SURFACE MATRIX [<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>]: com.android.testred/com.android.testred.TestActivity</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyCrop</span><span class="params">(Rect clipRect, <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_WINDOW_CROP) Slog.d(TAG, <span class="string">&quot;applyCrop: win=&quot;</span> + mWin</span><br><span class="line">                + <span class="string">&quot; clipRect=&quot;</span> + clipRect);</span><br><span class="line">        <span class="keyword">if</span> (clipRect != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!clipRect.equals(mLastClipRect)) &#123;</span><br><span class="line">                mLastClipRect.set(clipRect);</span><br><span class="line">                mSurfaceController.setCropInTransaction(clipRect, recoveringMemory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSurfaceController.clearCropInTransaction(recoveringMemory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="5-8-3、mSurfaceController-setPositionInTransaction-……"><a href="#5-8-3、mSurfaceController-setPositionInTransaction-……" class="headerlink" title="5.8.3、mSurfaceController.setPositionInTransaction(……)"></a>5.8.3、mSurfaceController.setPositionInTransaction(……)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowSurfaceController.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPositionInTransaction</span><span class="params">(<span class="keyword">float</span> left, <span class="keyword">float</span> top, <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">        setPosition(<span class="keyword">null</span>, left, top, recoveringMemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPosition</span><span class="params">(SurfaceControl.Transaction t, <span class="keyword">float</span> left, <span class="keyword">float</span> top,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> recoveringMemory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> surfaceMoved = mSurfaceX != left || mSurfaceY != top;</span><br><span class="line">        <span class="keyword">if</span> (surfaceMoved) &#123;</span><br><span class="line">            mSurfaceX = left;</span><br><span class="line">            mSurfaceY = top;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (SHOW_TRANSACTIONS) logSurface(</span><br><span class="line">                        <span class="string">&quot;POS (setPositionInTransaction) @ (&quot;</span> + left + <span class="string">&quot;,&quot;</span> + top + <span class="string">&quot;)&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mSurfaceControl.setPosition(left, top);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    t.setPosition(mSurfaceControl, left, top);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Error positioning surface of &quot;</span> + <span class="keyword">this</span></span><br><span class="line">                        + <span class="string">&quot; pos=(&quot;</span> + left + <span class="string">&quot;,&quot;</span> + top + <span class="string">&quot;)&quot;</span>, e);</span><br><span class="line">                <span class="keyword">if</span> (!recoveringMemory) &#123;</span><br><span class="line">                    mAnimator.reclaimSomeSurfaceMemory(<span class="string">&quot;position&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-9、AppWindowToken-updateAllDrawn"><a href="#5-9、AppWindowToken-updateAllDrawn" class="headerlink" title="5.9、AppWindowToken.updateAllDrawn()"></a>5.9、AppWindowToken.updateAllDrawn()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/AppWindowToken.java</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.125</span> V/AppWindowToken( <span class="number">1049</span>): allDrawn: AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125; interesting=<span class="number">1</span> drawn=<span class="number">1</span></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateAllDrawn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!allDrawn) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> numInteresting = mNumInterestingWindows;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (numInteresting &gt; <span class="number">0</span> &amp;&amp; allDrawnStatesConsidered()</span><br><span class="line">                    &amp;&amp; mNumDrawnWindows &gt;= numInteresting &amp;&amp; !isRelaunching()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG, <span class="string">&quot;allDrawn: &quot;</span> + <span class="keyword">this</span></span><br><span class="line">                        + <span class="string">&quot; interesting=&quot;</span> + numInteresting + <span class="string">&quot; drawn=&quot;</span> + mNumDrawnWindows);</span><br><span class="line">                allDrawn = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mDisplayContent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mDisplayContent.setLayoutNeeded();</span><br><span class="line">                &#125;</span><br><span class="line">                mService.mH.obtainMessage(NOTIFY_ACTIVITY_DRAWN, token).sendToTarget();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">final</span> TaskStack pinnedStack = mDisplayContent.getPinnedStack();</span><br><span class="line">                <span class="keyword">if</span> (pinnedStack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pinnedStack.onAllWindowsDrawn();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="（6）、执行窗口合成显示"><a href="#（6）、执行窗口合成显示" class="headerlink" title="（6）、执行窗口合成显示"></a>（6）、执行窗口合成显示</h5><h5 id="6-1、WindowStateAnimator-showSurfaceRobustlyLocked"><a href="#6-1、WindowStateAnimator-showSurfaceRobustlyLocked" class="headerlink" title="6.1、WindowStateAnimator.showSurfaceRobustlyLocked()"></a>6.1、WindowStateAnimator.showSurfaceRobustlyLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/wm/WindowStateAnimator.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showSurfaceRobustlyLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mWin.getWindowConfiguration().windowsAreScaleable()) &#123;</span><br><span class="line">            mSurfaceController.forceScaleableInTransaction(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> shown = mSurfaceController.showRobustlyInTransaction();</span><br><span class="line">        <span class="keyword">if</span> (!shown)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mPendingDestroySurface != <span class="keyword">null</span> &amp;&amp; mDestroyPreservedSurfaceUponRedraw) &#123;</span><br><span class="line">            mPendingDestroySurface.mSurfaceControl.hide();</span><br><span class="line">            mPendingDestroySurface.reparentChildrenInTransaction(mSurfaceController);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="6-1-1、WindowSurfaceController-showRobustlyInTransaction"><a href="#6-1-1、WindowSurfaceController-showRobustlyInTransaction" class="headerlink" title="6.1.1、WindowSurfaceController.showRobustlyInTransaction()"></a>6.1.1、WindowSurfaceController.showRobustlyInTransaction()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">WindowSurfaceController.java</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.153</span> I/WindowSurfaceController( <span class="number">1049</span>):   <span class="function">SURFACE <span class="title">SHOW</span> <span class="params">(performLayout)</span>: com.android.testred/com.android.testred.TestActivity</span></span><br><span class="line"><span class="function">04-16 13:08:37.153 V/<span class="title">WindowSurfaceController</span><span class="params">( <span class="number">1049</span>)</span>: Showing <span class="title">Surface</span><span class="params">(name=com.android.testred/com.android.testred.TestActivity)</span>/@0xb17b0ce during relayout</span></span><br><span class="line"><span class="function">---------------------------------------------------------</span></span><br><span class="line"><span class="function">    <span class="keyword">boolean</span> <span class="title">showRobustlyInTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (SHOW_TRANSACTIONS) logSurface(</span><br><span class="line">                <span class="string">&quot;SHOW (performLayout)&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG, <span class="string">&quot;Showing &quot;</span> + <span class="keyword">this</span></span><br><span class="line">                + <span class="string">&quot; during relayout&quot;</span>);</span><br><span class="line">        mHiddenForOtherReasons = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> updateVisibility();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateVisibility</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mHiddenForCrop || mHiddenForOtherReasons) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSurfaceShown) &#123;</span><br><span class="line">                hideSurface(mTmpTransaction);</span><br><span class="line">                SurfaceControl.mergeToGlobalTransaction(mTmpTransaction);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSurfaceShown) &#123;</span><br><span class="line">                <span class="keyword">return</span> showSurface();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showSurface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            setShown(<span class="keyword">true</span>);</span><br><span class="line">            mSurfaceControl.show();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Failure showing surface &quot;</span> + mSurfaceControl + <span class="string">&quot; in &quot;</span> + <span class="keyword">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAnimator.reclaimSomeSurfaceMemory(<span class="string">&quot;show&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="6-1-2、SurfaceControl-show"><a href="#6-1-2、SurfaceControl-show" class="headerlink" title="6.1.2、SurfaceControl.show()"></a>6.1.2、SurfaceControl.show()</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/core/java/android/view/SurfaceControl.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        checkNotReleased();</span><br><span class="line">        <span class="keyword">synchronized</span>(SurfaceControl.class) &#123;</span><br><span class="line">            sGlobalTransaction.show(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Transaction <span class="title">show</span><span class="params">(SurfaceControl sc)</span> </span>&#123;</span><br><span class="line">            sc.checkNotReleased();</span><br><span class="line">            nativeSetFlags(mNativeObject, sc.mNativeObject, <span class="number">0</span>, SURFACE_HIDDEN);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="6-2、SurfaceFlinger-合成显示"><a href="#6-2、SurfaceFlinger-合成显示" class="headerlink" title="6.2、SurfaceFlinger 合成显示"></a>6.2、SurfaceFlinger 合成显示</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------</span><br><span class="line">看看Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.161</span> V/SurfaceFlinger(  <span class="number">739</span>): handlePageFlip</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.161</span> V/SurfaceFlinger(  <span class="number">739</span>): preComposition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.161</span> V/SurfaceFlinger(  <span class="number">739</span>): rebuildLayerStacks</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.161</span> V/SurfaceFlinger(  <span class="number">739</span>): computeVisibleRegions</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.161</span> V/SurfaceFlinger(  <span class="number">739</span>): setUpHWComposer</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.162</span> V/HWC2    (  <span class="number">739</span>): Created layer <span class="number">8</span> on display <span class="number">0</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.162</span> V/HWC2    (  <span class="number">739</span>): Created layer <span class="number">9</span> on display <span class="number">0</span></span><br><span class="line">.....</span><br><span class="line">04-16 13:08:37.163 V/BufferLayer(  739): [SurfaceView - com.android.testred/com.android.testred.TestActivity#0] Requesting Device composition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/Layer   (  <span class="number">739</span>): setCompositionType(<span class="number">8</span>, Device, <span class="number">1</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/Layer   (  <span class="number">739</span>):     actually setting</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/BufferLayer(  <span class="number">739</span>): setPerFrameData: dataspace = <span class="number">0</span></span><br><span class="line">04-16 13:08:37.163 V/BufferLayerConsumer(  739): [SurfaceView - com.android.testred/com.android.testred.TestActivity#0] getCurrentHdrMetadata</span><br><span class="line">04-16 13:08:37.163 V/BufferLayer(  739): [com.android.testred/com.android.testred.TestActivity#0] Requesting Device composition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/Layer   (  <span class="number">739</span>): setCompositionType(<span class="number">9</span>, Device, <span class="number">1</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/Layer   (  <span class="number">739</span>):     actually setting</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/BufferLayer(  <span class="number">739</span>): setPerFrameData: dataspace = <span class="number">0</span></span><br><span class="line">04-16 13:08:37.163 V/BufferLayerConsumer(  739): [com.android.testred/com.android.testred.TestActivity#0] getCurrentHdrMetadata</span><br><span class="line">04-16 13:08:37.163 V/BufferLayer(  739): [StatusBar#0] Requesting Device composition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/Layer   (  <span class="number">739</span>): setCompositionType(<span class="number">3</span>, Device, <span class="number">1</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/BufferLayer(  <span class="number">739</span>): setPerFrameData: dataspace = <span class="number">0</span></span><br><span class="line">04-16 13:08:37.163 V/BufferLayerConsumer(  739): [StatusBar#0] getCurrentHdrMetadata</span><br><span class="line">04-16 13:08:37.163 V/BufferLayer(  739): [NavigationBar#0] Requesting Device composition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/Layer   (  <span class="number">739</span>): setCompositionType(<span class="number">4</span>, Device, <span class="number">1</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.163</span> V/BufferLayer(  <span class="number">739</span>): setPerFrameData: dataspace = <span class="number">0</span></span><br><span class="line">04-16 13:08:37.163 V/BufferLayerConsumer(  739): [NavigationBar#0] getCurrentHdrMetadata</span><br><span class="line">......</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/HWComposer(  <span class="number">739</span>): SkipValidate failed, Falling back to SLOW validate/present</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>): doComposition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>): doDisplayComposition</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>): doComposeSurfaces</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>): Rendering client layers</span><br><span class="line">04-16 13:08:37.164 V/SurfaceFlinger(  739): Layer: com.android.systemui.ImageWallpaper#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>):   Composition type: Device</span><br><span class="line">04-16 13:08:37.164 V/SurfaceFlinger(  739): Layer: com.android.launcher3/com.android.launcher3.Launcher#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>):   Composition type: Device</span><br><span class="line">04-16 13:08:37.164 V/SurfaceFlinger(  739): Layer: SurfaceView - com.android.testred/com.android.testred.TestActivity#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>):   Composition type: Device</span><br><span class="line">04-16 13:08:37.164 V/SurfaceFlinger(  739): Layer: com.android.testred/com.android.testred.TestActivity#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>):   Composition type: Device</span><br><span class="line">04-16 13:08:37.164 V/SurfaceFlinger(  739): Layer: StatusBar#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>):   Composition type: Device</span><br><span class="line">04-16 13:08:37.164 V/SurfaceFlinger(  739): Layer: NavigationBar#0</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>):   Composition type: Device</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">37.164</span> V/SurfaceFlinger(  <span class="number">739</span>): postFramebuffer</span><br><span class="line">---------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>关于SurfaceFlinger合成显示之前已经分析过很多次啦，这里就不再分析啦。请参考：{ Android P Graphics System（四）：Native Surface 创建 &amp;&amp; SurfaceFlinger合成流程分析 }<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.com.android.test_red.png" alt="enter image description here"> </p>
<hr>
<h2 id="Vsync-end"><a href="#Vsync-end" class="headerlink" title="/**Vsync end******/"></a>/<strong><strong><strong>**</strong></strong></strong>Vsync end**<strong><strong>****</strong></strong>/</h2><h4 id="（X）、参考文档："><a href="#（X）、参考文档：" class="headerlink" title="（X）、参考文档："></a>（X）、参考文档：</h4><p><a target="_blank" rel="noopener" href="http://charlesvincent.cc/">（1）【Android Display System】</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20190728/">https://zhoujinjian.com/posts/20190728/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.43.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20190801/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00001.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android L Display System源码分析（1）：Display System 精彩世界（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</div></div></a></div><div class="next-post pull-right"><a href="/posts/20190726/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.42.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 9.0 App（&quot;com.android.testgreen&quot;）界面显示流程源码分析（1）：Activity启动流程分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81Window%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">（一）、Window添加过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81ActivityThread-performLaunchActivity"><span class="toc-number">1.1.</span> <span class="toc-text">（1）、ActivityThread.performLaunchActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81Activity-setContentView"><span class="toc-number">1.2.</span> <span class="toc-text">（2）、Activity.setContentView()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1%E3%80%81ViewRootImpl-%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">5.1、ViewRootImpl()构造过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1%E3%80%81IWindowSession%E4%BB%A3%E7%90%86%E8%8E%B7%E5%8F%96%E8%BF%87%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">5.1.1、IWindowSession代理获取过程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-1-1%E3%80%81WindowManagerService-openSession"><span class="toc-number">1.4.1.</span> <span class="toc-text">5.1.1.1、WindowManagerService.openSession()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-1-1-2%E3%80%81new-Session"><span class="toc-number">1.4.2.</span> <span class="toc-text">5.1.1.2、new Session()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2%E3%80%81%E5%88%9B%E5%BB%BAW%E6%9C%AC%E5%9C%B0Binder%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.5.</span> <span class="toc-text">5.1.2、创建W本地Binder对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3%E3%80%81Choreographer%E5%88%9B%E5%BB%BA"><span class="toc-number">1.6.</span> <span class="toc-text">5.1.3、Choreographer创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-1%E3%80%81Native-DisplayEventReceiver%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.7.</span> <span class="toc-text">5.1.3.1、Native DisplayEventReceiver初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-2%E3%80%81createDisplayEventConnection"><span class="toc-number">1.8.</span> <span class="toc-text">5.1.3.2、createDisplayEventConnection</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-3%E3%80%81mEventConnection-gt-stealReceiveChannel-mDataChannel-get"><span class="toc-number">1.9.</span> <span class="toc-text">5.1.3.3、mEventConnection-&gt;stealReceiveChannel(mDataChannel.get())</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-4%E3%80%81%E6%9E%84%E9%80%A0AttachInfo%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.10.</span> <span class="toc-text">5.1.4、构造AttachInfo对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2%E3%80%81%E8%A7%86%E5%9B%BEView%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">1.11.</span> <span class="toc-text">5.2、视图View添加过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1%E3%80%81%E7%AA%97%E5%8F%A3UI%E5%B8%83%E5%B1%80%E8%BF%87%E7%A8%8B-ViewRootImpl-requestLayout"><span class="toc-number">1.12.</span> <span class="toc-text">5.2.1、窗口UI布局过程 ViewRootImpl.requestLayout()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2%E3%80%81%E6%B7%BB%E5%8A%A0%E5%9B%9E%E8%B0%83%E8%BF%87%E7%A8%8B-mChoreographer-postCallback"><span class="toc-number">1.13.</span> <span class="toc-text">5.2.2、添加回调过程 mChoreographer.postCallback()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-3%E3%80%81Vsync%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B-mDisplayEventReceiver-scheduleVsync"><span class="toc-number">1.14.</span> <span class="toc-text">5.2.3、Vsync请求过程 mDisplayEventReceiver.scheduleVsync()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3%E3%80%81mWindowSession-addToDisplay-%E5%90%91WMS%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AA%E7%AA%97%E5%8F%A3%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.15.</span> <span class="toc-text">5.3、mWindowSession.addToDisplay()向WMS服务注册一个窗口对象</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1%E3%80%81WindowManagerService-addWindow"><span class="toc-number">1.15.1.</span> <span class="toc-text">5.3.1、WindowManagerService.addWindow()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-1%E3%80%81WindowState%E5%88%9B%E5%BB%BA"><span class="toc-number">1.15.2.</span> <span class="toc-text">5.3.1.1、WindowState创建</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-2%E3%80%81WindowState-attach"><span class="toc-number">1.15.3.</span> <span class="toc-text">5.3.1.2、WindowState.attach()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-3%E3%80%81mSession-windowAddedLocked-mAttrs-packageName"><span class="toc-number">1.15.4.</span> <span class="toc-text">5.3.1.3、mSession.windowAddedLocked(mAttrs.packageName)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-4%E3%80%81SurfaceSession%E5%BB%BA%E7%AB%8B%E8%BF%87%E7%A8%8B"><span class="toc-number">1.15.5.</span> <span class="toc-text">5.3.1.4、SurfaceSession建立过程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-3-1-5%E3%80%81win-mToken-addWindow-win"><span class="toc-number">1.15.6.</span> <span class="toc-text">5.3.1.5、win.mToken.addWindow(win)</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vsync-start"><span class="toc-number"></span> <span class="toc-text">&#x2F;**Vsync start******&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81Vsync-trigger"><span class="toc-number">1.</span> <span class="toc-text">（二）、Vsync trigger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81Vsync-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">（三）、Vsync 信号处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81%E8%AF%B7%E6%B1%82WMS%E6%9C%8D%E5%8A%A1relayout%E7%AA%97%E5%8F%A3mWindowSession-relayout"><span class="toc-number">2.1.</span> <span class="toc-text">（1）、请求WMS服务relayout窗口mWindowSession.relayout()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81Session-relayout"><span class="toc-number">2.2.</span> <span class="toc-text">1.1、Session.relayout()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2%E3%80%81WindowManagerService-relayoutWindow"><span class="toc-number">2.3.</span> <span class="toc-text">1.2、WindowManagerService.relayoutWindow()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1%E3%80%81WindowSurfacePlacer-performSurfacePlaRelayout-complete-cement-true-force"><span class="toc-number">2.4.</span> <span class="toc-text">1.2.1、WindowSurfacePlacer.performSurfacePlaRelayout complete cement(true &#x2F;* force *&#x2F;)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2%E3%80%81RootWindowContainer-performSurfacePlacement-recoveringMemory"><span class="toc-number">2.5.</span> <span class="toc-text">1.2.2、RootWindowContainer.performSurfacePlacement(recoveringMemory)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2-1%E3%80%81applySurfaceChangesTransaction-recoveringMemory-defaultDw-defaultDh"><span class="toc-number">2.5.1.</span> <span class="toc-text">1.2.2.1、applySurfaceChangesTransaction(recoveringMemory, defaultDw, defaultDh)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2-2%E3%80%81DisplayContent-applySurfaceChangesTransaction-recoveringMemory"><span class="toc-number">2.5.2.</span> <span class="toc-text">1.2.2.2、DisplayContent.applySurfaceChangesTransaction(recoveringMemory)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2-3%E3%80%81DisplayContent-performLayout"><span class="toc-number">2.5.3.</span> <span class="toc-text">1.2.2.3、DisplayContent.performLayout()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2-4%E3%80%81DisplayContent-forAllWindows-mPerformLayout-%E2%80%A6"><span class="toc-number">2.5.4.</span> <span class="toc-text">1.2.2.4、DisplayContent.forAllWindows(mPerformLayout, …)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2-5%E3%80%81mService-mPolicy-PhoneWindowManager-layoutWindowLw-w-null-mDisplayFrames"><span class="toc-number">2.5.5.</span> <span class="toc-text">1.2.2.5、mService.mPolicy[PhoneWindowManager].layoutWindowLw(w, null, mDisplayFrames)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2-5%E3%80%81WindowState-computeFrameLw"><span class="toc-number">2.5.6.</span> <span class="toc-text">1.2.2.5、WindowState.computeFrameLw()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3%E3%80%81surfacePlacer-handleAppTransitionReadyLocked"><span class="toc-number">2.6.</span> <span class="toc-text">1.2.3、surfacePlacer.handleAppTransitionReadyLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81Surface%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">2.7.</span> <span class="toc-text">（2）、Surface创建过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81winAnimator-createSurfaceLocked"><span class="toc-number">2.8.</span> <span class="toc-text">2.1、winAnimator.createSurfaceLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1%E3%80%81new-WindowSurfaceController"><span class="toc-number">2.9.</span> <span class="toc-text">2.1.1、new WindowSurfaceController()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-1%E3%80%81%E5%88%9B%E5%BB%BASurfaceControl-build"><span class="toc-number">2.9.1.</span> <span class="toc-text">2.1.1.1、创建SurfaceControl build()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-2%E3%80%81new-SurfaceControl"><span class="toc-number">2.9.2.</span> <span class="toc-text">2.1.1.2、new SurfaceControl()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-3%E3%80%81Client-gt-createSurface"><span class="toc-number">2.9.3.</span> <span class="toc-text">2.1.1.3、Client-&gt;createSurface()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-4%E3%80%81createBufferLayer"><span class="toc-number">2.9.4.</span> <span class="toc-text">2.1.1.4、createBufferLayer()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-5%E3%80%81DisplayUtils-getInstance-gt-getBufferLayerInstance"><span class="toc-number">2.9.5.</span> <span class="toc-text">2.1.1.5、DisplayUtils::getInstance()-&gt;getBufferLayerInstance()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-6%E3%80%81new-BufferLayer"><span class="toc-number">2.9.6.</span> <span class="toc-text">2.1.1.6、new BufferLayer()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-7%E3%80%81BufferLayer-gt-onFirstRef"><span class="toc-number">2.9.7.</span> <span class="toc-text">2.1.1.7、BufferLayer-&gt;onFirstRef()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-8%E3%80%81BufferQueue-createBufferQueue"><span class="toc-number">2.9.8.</span> <span class="toc-text">2.1.1.8、BufferQueue::createBufferQueue()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-9%E3%80%81new-BufferLayerConsumer"><span class="toc-number">2.9.9.</span> <span class="toc-text">2.1.1.9、new BufferLayerConsumer()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-1-10%E3%80%81ConsumerBase"><span class="toc-number">2.9.10.</span> <span class="toc-text">2.1.1.10、ConsumerBase()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81winAnimator-createSurfaceLocked"><span class="toc-number">2.10.</span> <span class="toc-text">2.2、winAnimator.createSurfaceLocked()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-1%E3%80%81surfaceController-getSurface-outSurface"><span class="toc-number">2.10.1.</span> <span class="toc-text">2.2.1、surfaceController.getSurface(outSurface)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2%E3%80%81outSurface-copyFrom-mSurfaceControl"><span class="toc-number">2.10.2.</span> <span class="toc-text">2.2.2、outSurface.copyFrom(mSurfaceControl)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-3%E3%80%81nativeGetFromSurfaceControl"><span class="toc-number">2.10.3.</span> <span class="toc-text">2.2.3、nativeGetFromSurfaceControl()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4%E3%80%81Nativie-Surface%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">2.10.4.</span> <span class="toc-text">2.2.4、Nativie Surface创建过程</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-5%E3%80%81Surface%E8%B7%A8%E8%BF%9B%E7%A8%8B%E4%BC%A0%E9%80%92%EF%BC%88-WMS-gt-App%EF%BC%89writeToParcel"><span class="toc-number">2.10.5.</span> <span class="toc-text">2.2.5、Surface跨进程传递（ WMS-&gt;App）writeToParcel()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-6%E3%80%81Surface%E8%B7%A8%E8%BF%9B%E7%A8%8B%E4%BC%A0%E9%80%92%EF%BC%88-App-gt-WMS%EF%BC%89readFromParcel"><span class="toc-number">2.10.6.</span> <span class="toc-text">2.2.6、Surface跨进程传递（ App-&gt;WMS）readFromParcel()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81%E7%84%A6%E7%82%B9%E7%AA%97%E5%8F%A3%E6%9B%B4%E6%96%B0updateFocusedWindowLocked"><span class="toc-number">2.11.</span> <span class="toc-text">（3）、焦点窗口更新updateFocusedWindowLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81RootWindowContainer-computeFocusedWindow"><span class="toc-number">2.12.</span> <span class="toc-text">3.1、RootWindowContainer.computeFocusedWindow()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1%E3%80%81DisplayContent-findFocusedWindow"><span class="toc-number">2.12.1.</span> <span class="toc-text">3.1.1、DisplayContent.findFocusedWindow()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2%E3%80%81Visibility%E6%9B%B4%E6%96%B0AppWindowToken-updateReportedVisibilityLocked"><span class="toc-number">2.13.</span> <span class="toc-text">3.2、Visibility更新AppWindowToken.updateReportedVisibilityLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81%E6%89%A7%E8%A1%8C%E7%AA%97%E5%8F%A3%E5%B8%83%E5%B1%80performLayout"><span class="toc-number">2.14.</span> <span class="toc-text">（4）、执行窗口布局performLayout()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1%E3%80%81View-layout-0-0-host-getMeasuredWidth-host-getMeasuredHeight"><span class="toc-number">2.14.1.</span> <span class="toc-text">4.1、View.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight())</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1-1%E3%80%81View-setFrame"><span class="toc-number">2.14.2.</span> <span class="toc-text">4.1.1、View.setFrame</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-1-2%E3%80%81SurfaceView-setFrame"><span class="toc-number">2.14.3.</span> <span class="toc-text">4.1.2、SurfaceView.setFrame</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81%E6%89%A7%E8%A1%8C%E7%AA%97%E5%8F%A3%E7%BB%98%E5%88%B6performDraw"><span class="toc-number">2.15.</span> <span class="toc-text">（5）、执行窗口绘制performDraw()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1%E3%80%81EglHelper-start"><span class="toc-number">2.16.</span> <span class="toc-text">5.1、EglHelper.start()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2%E3%80%81EglHelper-createSurface"><span class="toc-number">2.17.</span> <span class="toc-text">5.2、EglHelper.createSurface()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3%E3%80%81-mEgl-eglMakeCurrent"><span class="toc-number">2.18.</span> <span class="toc-text">5.3、 mEgl.eglMakeCurrent()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4%E3%80%81Renderer-onDrawFrame"><span class="toc-number">2.19.</span> <span class="toc-text">5.4、Renderer.onDrawFrame()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5%E3%80%81finishDrawingRunnable-run"><span class="toc-number">2.20.</span> <span class="toc-text">5.5、finishDrawingRunnable.run()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-6%E3%80%81mEglHelper-swap"><span class="toc-number">2.21.</span> <span class="toc-text">5.6、mEglHelper.swap()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-7%E3%80%81WindowStateAnimator-commitFinishDrawingLocked"><span class="toc-number">2.22.</span> <span class="toc-text">5.7、WindowStateAnimator.commitFinishDrawingLocked()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-7-1%E3%80%81AppWindowToken-updateDrawnWindowStates"><span class="toc-number">2.22.1.</span> <span class="toc-text">5.7.1、AppWindowToken.updateDrawnWindowStates()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8%E3%80%81DisplayContent-prepareSurfaces"><span class="toc-number">2.23.</span> <span class="toc-text">5.8、DisplayContent.prepareSurfaces()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8-1%E3%80%81WindowStateAnimator-computeShownFrameLocked"><span class="toc-number">2.24.</span> <span class="toc-text">5.8.1、WindowStateAnimator.computeShownFrameLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8-2%E3%80%81WindowStateAnimator-setSurfaceBoundariesLocked"><span class="toc-number">2.25.</span> <span class="toc-text">5.8.2、WindowStateAnimator.setSurfaceBoundariesLocked()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-8-2-1%E3%80%81WindowStateAnimator-calculateCrop"><span class="toc-number">2.25.1.</span> <span class="toc-text">5.8.2.1、WindowStateAnimator.calculateCrop()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-8-2-2%E3%80%81WindowStateAnimator-applyCrop"><span class="toc-number">2.25.2.</span> <span class="toc-text">5.8.2.2、WindowStateAnimator.applyCrop()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8-3%E3%80%81mSurfaceController-setPositionInTransaction-%E2%80%A6%E2%80%A6"><span class="toc-number">2.26.</span> <span class="toc-text">5.8.3、mSurfaceController.setPositionInTransaction(……)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-9%E3%80%81AppWindowToken-updateAllDrawn"><span class="toc-number">2.27.</span> <span class="toc-text">5.9、AppWindowToken.updateAllDrawn()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E3%80%81%E6%89%A7%E8%A1%8C%E7%AA%97%E5%8F%A3%E5%90%88%E6%88%90%E6%98%BE%E7%A4%BA"><span class="toc-number">2.28.</span> <span class="toc-text">（6）、执行窗口合成显示</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1%E3%80%81WindowStateAnimator-showSurfaceRobustlyLocked"><span class="toc-number">2.29.</span> <span class="toc-text">6.1、WindowStateAnimator.showSurfaceRobustlyLocked()</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#6-1-1%E3%80%81WindowSurfaceController-showRobustlyInTransaction"><span class="toc-number">2.29.1.</span> <span class="toc-text">6.1.1、WindowSurfaceController.showRobustlyInTransaction()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-1-2%E3%80%81SurfaceControl-show"><span class="toc-number">2.29.2.</span> <span class="toc-text">6.1.2、SurfaceControl.show()</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2%E3%80%81SurfaceFlinger-%E5%90%88%E6%88%90%E6%98%BE%E7%A4%BA"><span class="toc-number">2.30.</span> <span class="toc-text">6.2、SurfaceFlinger 合成显示</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vsync-end"><span class="toc-number"></span> <span class="toc-text">&#x2F;**Vsync end******&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88X%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">（X）、参考文档：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>