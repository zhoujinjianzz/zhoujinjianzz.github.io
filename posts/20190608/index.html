<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android P Graphics System（二）：Qualcomm MDSS - MDP、DSI、FrameBuffer分析 | zhoujinjian</title><meta name="keywords" content="Android,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android P Graphics System（二）：Qualcomm MDSS - MDP、DSI、FrameBuffer分析">
<meta property="og:url" content="https://zhoujinjian.com/posts/20190608/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.37.jpg">
<meta property="article:published_time" content="2019-06-08T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.960Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.37.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20190608/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.37.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android P Graphics System（二）：Qualcomm MDSS - MDP、DSI、FrameBuffer分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-06-08T01:25:00.000Z" title="发表于 2019-06-08 09:25:00">2019-06-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.960Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Graphics/">Graphics</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<p>注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。<br>（==<strong>文章基于 Kernel-3.18</strong>==）&amp;&amp;（==<strong>文章基于 Android 9.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://www.intrinsyc.com/snapdragon-embedded-development-kits/open-q-820-usom-development-kit/">【开发板 Intrinsyc Open-Q™ 820 µSOM Development Kit】</a><br><a target="_blank" rel="noopener" href="https://gitlab.com/zhoujinjianzz/apq8096_la.um.7.5.r1-03100-8x96.0_p_v5.0">【开发板 Android 9.0 &amp;&amp; Linux（Kernel 3.18）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dearsq/article/details/52354593">（1）【[Android5.1][RK3288] LCD Mipi 调试方法及问题汇总】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/dearsq/article/details/77341120">（2）【[Android6.0][RK3399] Mipi LCD 通用移植调试流程】</a><br><a target="_blank" rel="noopener" href="https://github.com/wj123/github/tree/master/android/module/display/liuzl">（3）【MDP分析，DSI分析，FB分析，Display resume suspend分析】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012452964/article/details/74841290">（4）【高通平台LCD之MDP code解析】</a> </p>
<hr>
<p>==源码（部分）==：</p>
<blockquote>
<p>Qualcomm MDSS</p>
</blockquote>
<ul>
<li>G:\android9.0\kernel\msm-3.18\drivers\video\msm\mdss\</li>
</ul>
<hr>
<p>依赖于高通的强大的显示框架，我们只需要加入很少的patch就可以让一块LCD 屏幕亮屏并显示画面，接下里来博主来粗略的分析下。</p>
<p>先看看开发板LCD的patch（TouchScreen部分省略）。</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">From 5b78c501d54013ab4fd687d2d66c0e04de05b1d5 Mon Sep 17 00:00:00 2001</span><br><span class="line">From: Jitendra Lanka &lt;jlanka@xxx.com&gt;</span><br><span class="line">Date: Tue, 17 Jan 2017 12:39:47 -0800</span><br><span class="line">Subject: Support OSD panel &amp; Goodix touchscreen</span><br><span class="line"></span><br><span class="line">Change-Id: I9e648b8957a185e55529562e481b286897ea3dfb</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> .../boot/dts/qcom/apq8096-dragonboard.dtsi    |  71 ++++++++-</span><br><span class="line"> .../qcom/dsi-panel-jd9161-fwvga-video.dtsi    | 144 ++++++++++++++++++</span><br><span class="line"> .../boot/dts/qcom/msm8996-mdss-panels.dtsi    |   8 +</span><br><span class="line"> arch/arm/boot/dts/qcom/msm8996-mdss.dtsi      |   1 +</span><br><span class="line"> arch/arm/boot/dts/qcom/msm8996-pinctrl.dtsi   |  55 +++++++</span><br><span class="line"> arch/arm64/configs/msm-perf_defconfig         |   3 +</span><br><span class="line"> arch/arm64/configs/msm_defconfig              |   3 +</span><br><span class="line"> 7 files changed, 283 insertions(+), 2 deletions(-)</span><br><span class="line"> create mode 100644 arch/arm/boot/dts/qcom/dsi-panel-jd9161-fwvga-video.dtsi</span><br><span class="line"></span><br><span class="line">diff --git a/arch/arm/boot/dts/qcom/apq8096-dragonboard.dtsi b/arch/arm/boot/dts/qcom/apq8096-dragonboard.dtsi</span><br><span class="line">index 1020e3ca2333..836226a48617 100644</span><br><span class="line"><span class="comment">--- a/arch/arm/boot/dts/qcom/apq8096-dragonboard.dtsi</span></span><br><span class="line"><span class="comment">+++ b/arch/arm/boot/dts/qcom/apq8096-dragonboard.dtsi</span></span><br><span class="line"> -334,7 +334,17 @@</span><br><span class="line">     qcom,mdss-dsi-bl-pmic-pwm-frequency = &lt;50&gt;;</span><br><span class="line">     qcom,mdss-dsi-bl-pmic-bank-select = &lt;0&gt;;</span><br><span class="line">     qcom,mdss-dsi-pwm-gpio = &lt;&amp;pm8994_gpios 5 0&gt;;</span><br><span class="line"><span class="deletion">-    qcom,panel-supply-entries = &lt;&amp;dsi_panel_pwr_supply&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,panel-supply-entries = &lt;&amp;dsi_panel_pwr_supply_vdd_no_labibb&gt;;</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&amp;dsi_jd9161_fwvga_vid &#123;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-bl-pmic-control-type = &quot;bl_ctrl_pwm&quot;;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-bl-min-level = &lt;1&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-bl-max-level = &lt;255&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-bl-pmic-pwm-frequency = &lt;50&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-bl-pmic-bank-select = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-pwm-gpio = &lt;&amp;pm8994_gpios 5 0&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,panel-supply-entries = &lt;&amp;dsi_panel_pwr_supply_vdd_no_labibb&gt;;</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> &amp;mdss_mdp &#123;</span><br><span class="line"> -343,7 +353,7 @@</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> &amp;mdss_dsi0 &#123;</span><br><span class="line"><span class="deletion">-    qcom,dsi-pref-prim-pan = &lt;&amp;dsi_hx8379a_fwvga_truly_vid&gt;;</span></span><br><span class="line"><span class="addition">+    qcom,dsi-pref-prim-pan = &lt;&amp;dsi_jd9161_fwvga_vid&gt;;</span></span><br><span class="line">     pinctrl-names = &quot;mdss_default&quot;, &quot;mdss_sleep&quot;;</span><br><span class="line">     pinctrl-0 = &lt;&amp;mdss_dsi_active &amp;mdss_te_active &amp;mdss_disp_bkl_active&gt;;</span><br><span class="line">     pinctrl-1 = &lt;&amp;mdss_dsi_suspend &amp;mdss_te_suspend &amp;mdss_disp_bkl_suspend&gt;;</span><br><span class="line"> -550,6 +560,63 @@</span><br><span class="line">             clocks = &lt;&amp;clock_gcc clk_gcc_blsp2_ahb_clk&gt;,</span><br><span class="line">                  &lt;&amp;clock_gcc clk_gcc_blsp2_qup6_i2c_apps_clk&gt;;</span><br><span class="line">         &#125;;</span><br><span class="line">//......省略</span><br><span class="line">     &#125;;</span><br><span class="line"> </span><br><span class="line">     gpio_keys &#123;</span><br><span class="line">diff --git a/arch/arm/boot/dts/qcom/dsi-panel-jd9161-fwvga-video.dtsi b/arch/arm/boot/dts/qcom/dsi-panel-jd9161-fwvga-video.dtsi</span><br><span class="line">new file mode 100644</span><br><span class="line">index 000000000000..f56e6524e9e5</span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/arch/arm/boot/dts/qcom/dsi-panel-jd9161-fwvga-video.dtsi</span></span><br><span class="line"> -0,0 +1,144 @@</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&amp;mdss_mdp &#123;</span></span><br><span class="line"><span class="addition">+    dsi_jd9161_fwvga_vid: qcom,mdss_dsi_jd9161_fwvga_vid &#123;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-panel-name = &quot;JD9161 fwvga video mode dsi panel&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-panel-type = &quot;dsi_video_mode&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-panel-framerate = &lt;60&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-virtual-channel-id = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-stream = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-panel-width = &lt;480&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-panel-height = &lt;854&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-front-porch = &lt;10&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-back-porch = &lt;10&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-pulse-width = &lt;10&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-sync-skew = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-v-back-porch = &lt;6&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-v-front-porch = &lt;6&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-v-pulse-width = &lt;4&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-left-border = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-right-border = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-v-top-border = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-v-bottom-border = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-bpp = &lt;24&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-color-order = &quot;rgb_swap_rgb&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-underflow-color = &lt;0xff&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-border-color = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-on-command = [</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 04</span></span><br><span class="line"><span class="addition">+                BF 91 61 F2</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 03</span></span><br><span class="line"><span class="addition">+                B3 00 9B</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 03</span></span><br><span class="line"><span class="addition">+                B4 00 9B</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 02</span></span><br><span class="line"><span class="addition">+                C3 04</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 07</span></span><br><span class="line"><span class="addition">+                B8 00 6F 01</span></span><br><span class="line"><span class="addition">+                00 6F 01</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 04</span></span><br><span class="line"><span class="addition">+                BA 34 23 00</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 03</span></span><br><span class="line"><span class="addition">+                C4 30 6A</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 0A</span></span><br><span class="line"><span class="addition">+                C7 00 01 32</span></span><br><span class="line"><span class="addition">+                05 65 2A 12</span></span><br><span class="line"><span class="addition">+                A5 A5</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 27</span></span><br><span class="line"><span class="addition">+                C8 7F 6A 5A</span></span><br><span class="line"><span class="addition">+                4E 49 39 3B</span></span><br><span class="line"><span class="addition">+                23 37 32 2F</span></span><br><span class="line"><span class="addition">+                49 35 3B 31</span></span><br><span class="line"><span class="addition">+                2B 1E 0F 00</span></span><br><span class="line"><span class="addition">+                7F 6A 5A 4E</span></span><br><span class="line"><span class="addition">+                49 39 3B 23</span></span><br><span class="line"><span class="addition">+                37 32 2F 49</span></span><br><span class="line"><span class="addition">+                35 3B 31 2B</span></span><br><span class="line"><span class="addition">+                1E 0F 00</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 11</span></span><br><span class="line"><span class="addition">+                D4 1E 1F 1F</span></span><br><span class="line"><span class="addition">+                1F 06 04 0A</span></span><br><span class="line"><span class="addition">+                08 00 02 1F</span></span><br><span class="line"><span class="addition">+                1F 1F 1F 1F</span></span><br><span class="line"><span class="addition">+                1F</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 11</span></span><br><span class="line"><span class="addition">+                D5 1E 1F 1F</span></span><br><span class="line"><span class="addition">+                1F 07 05 0B</span></span><br><span class="line"><span class="addition">+                09 01 03 1F</span></span><br><span class="line"><span class="addition">+                1F 1F 1F 1F</span></span><br><span class="line"><span class="addition">+                1F</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 11</span></span><br><span class="line"><span class="addition">+                D6 1F 1E 1F</span></span><br><span class="line"><span class="addition">+                1F 07 09 0B</span></span><br><span class="line"><span class="addition">+                05 03 01 1F</span></span><br><span class="line"><span class="addition">+                1F 1F 1F 1F</span></span><br><span class="line"><span class="addition">+                1F</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 11</span></span><br><span class="line"><span class="addition">+                D7 1F 1E 1F</span></span><br><span class="line"><span class="addition">+                1F 06 08 0A</span></span><br><span class="line"><span class="addition">+                04 02 00 1F</span></span><br><span class="line"><span class="addition">+                1F 1F 1F 1F</span></span><br><span class="line"><span class="addition">+                1F</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 15</span></span><br><span class="line"><span class="addition">+                D8 20 00 00</span></span><br><span class="line"><span class="addition">+                30 08 20 01</span></span><br><span class="line"><span class="addition">+                02 00 01 02</span></span><br><span class="line"><span class="addition">+                06 7B 00 00</span></span><br><span class="line"><span class="addition">+                72 0A 0E 49</span></span><br><span class="line"><span class="addition">+                08</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 14</span></span><br><span class="line"><span class="addition">+                D9 00 0A 0A</span></span><br><span class="line"><span class="addition">+                89 00 00 06</span></span><br><span class="line"><span class="addition">+                7B 00 00 00</span></span><br><span class="line"><span class="addition">+                3B 33 1F 00</span></span><br><span class="line"><span class="addition">+                00 00 03 7B</span></span><br><span class="line"><span class="addition">+            05 01 00 00 01 00 01</span></span><br><span class="line"><span class="addition">+                35</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 02</span></span><br><span class="line"><span class="addition">+                BE 01</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 02</span></span><br><span class="line"><span class="addition">+                C1 10</span></span><br><span class="line"><span class="addition">+            39 01 00 00 01 00 0B</span></span><br><span class="line"><span class="addition">+                CC 34 20 38</span></span><br><span class="line"><span class="addition">+                60 11 91 00</span></span><br><span class="line"><span class="addition">+                40 00 00</span></span><br><span class="line"><span class="addition">+            39 01 00 00 00 00 02</span></span><br><span class="line"><span class="addition">+                BE 00</span></span><br><span class="line"><span class="addition">+            05 01 00 00 78 00 01</span></span><br><span class="line"><span class="addition">+                11</span></span><br><span class="line"><span class="addition">+            05 01 00 00 10 00 01</span></span><br><span class="line"><span class="addition">+                29</span></span><br><span class="line"><span class="addition">+            ];</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-off-command = [</span></span><br><span class="line"><span class="addition">+            05 01 00 00 32 00 01</span></span><br><span class="line"><span class="addition">+                28</span></span><br><span class="line"><span class="addition">+            05 01 00 00 78 00 01</span></span><br><span class="line"><span class="addition">+                10</span></span><br><span class="line"><span class="addition">+            ];</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-on-command-state = &quot;dsi_lp_mode&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-off-command-state = &quot;dsi_hs_mode&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-h-sync-pulse = &lt;0&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-traffic-mode = &quot;non_burst_sync_event&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-bllp-eof-power-mode;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-bllp-power-mode;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-lane-0-state;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-lane-1-state;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-panel-timings =</span></span><br><span class="line"><span class="addition">+                                       [66 14 0C 00 34 38 10 18 0E 03 04 00];</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-t-clk-post = &lt;0x04&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-t-clk-pre = &lt;0x1D&gt;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-dma-trigger = &quot;trigger_sw&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-mdp-trigger = &quot;none&quot;;</span></span><br><span class="line"><span class="addition">+        qcom,mdss-dsi-reset-sequence = &lt;1 20&gt;, &lt;0 2&gt;, &lt;1 20&gt;;</span></span><br><span class="line"><span class="addition">+    &#125;;</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line">diff --git a/arch/arm/boot/dts/qcom/msm8996-mdss-panels.dtsi b/arch/arm/boot/dts/qcom/msm8996-mdss-panels.dtsi</span><br><span class="line">index c1ec7ec4c495..7e8e01de0e6f 100644</span><br><span class="line"><span class="comment">--- a/arch/arm/boot/dts/qcom/msm8996-mdss-panels.dtsi</span></span><br><span class="line"><span class="comment">+++ b/arch/arm/boot/dts/qcom/msm8996-mdss-panels.dtsi</span></span><br><span class="line"> -23,6 +23,7 @@</span><br><span class="line"> #include &quot;dsi-panel-sim-dualmipi-cmd.dtsi&quot;</span><br><span class="line"> #include &quot;dsi-panel-nt35597-dsc-wqxga-cmd.dtsi&quot;</span><br><span class="line"> #include &quot;dsi-panel-hx8379a-truly-fwvga-video.dtsi&quot;</span><br><span class="line"><span class="addition">+#include &quot;dsi-panel-jd9161-fwvga-video.dtsi&quot;</span></span><br><span class="line"> #include &quot;dsi-panel-r69007-dualdsi-wqxga-cmd.dtsi&quot;</span><br><span class="line"> #include &quot;dsi-adv7533-1024-600p.dtsi&quot;</span><br><span class="line"> #include &quot;dsi-adv7533-720p.dtsi&quot;</span><br><span class="line"> -259,6 +260,13 @@</span><br><span class="line">         23 20 06 09 05 03 04 a0</span><br><span class="line">         23 2e 06 08 05 03 04 a0];</span><br><span class="line"> &#125;;</span><br><span class="line"><span class="addition">+&amp;dsi_jd9161_fwvga_vid &#123;</span></span><br><span class="line"><span class="addition">+    qcom,mdss-dsi-panel-timings-phy-v2 = [1D 19 04 05 01 03 04 a0</span></span><br><span class="line"><span class="addition">+        1D 19 04 05 01 03 04 a0</span></span><br><span class="line"><span class="addition">+        1D 19 04 05 01 03 04 a0</span></span><br><span class="line"><span class="addition">+        1D 19 04 05 01 03 04 a0</span></span><br><span class="line"><span class="addition">+        1D 1A 03 04 01 03 04 a0];</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line"> &amp;dsi_r69007_wqxga_cmd &#123;</span><br><span class="line">     qcom,mdss-dsi-panel-timings-phy-v2 = [23 1f 07 09 05 03 04 a0</span><br><span class="line">         23 1f 07 09 05 03 04 a0</span><br><span class="line">diff --git a/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi b/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi</span><br><span class="line">index ebddd6d12793..85cd7d9b8b04 100644</span><br><span class="line"><span class="comment">--- a/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi</span></span><br><span class="line"><span class="comment">+++ b/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi</span></span><br><span class="line"><span class="meta">@@ -409,6 +409,7 @@</span></span><br><span class="line"> </span><br><span class="line">             qcom,timing-db-mode;</span><br><span class="line">             oled-vdda-supply = &lt;&amp;pm8994_l19&gt;;</span><br><span class="line"><span class="addition">+            vdd-supply = &lt;&amp;pm8994_l22&gt;;</span></span><br><span class="line">             vddio-supply = &lt;&amp;pm8994_l14&gt;;</span><br><span class="line">             lab-supply = &lt;&amp;lab_regulator&gt;;</span><br><span class="line">             ibb-supply = &lt;&amp;ibb_regulator&gt;;</span><br><span class="line">diff --git a/arch/arm/boot/dts/qcom/msm8996-pinctrl.dtsi b/arch/arm/boot/dts/qcom/msm8996-pinctrl.dtsi</span><br><span class="line">index 4919c2c496d9..123f5ed84c8f 100644</span><br><span class="line"><span class="comment">--- a/arch/arm/boot/dts/qcom/msm8996-pinctrl.dtsi</span></span><br><span class="line"><span class="comment">+++ b/arch/arm/boot/dts/qcom/msm8996-pinctrl.dtsi</span></span><br><span class="line"><span class="meta">@@ -761,6 +761,61 @@</span></span><br><span class="line">             &#125;;</span><br><span class="line">         &#125;;</span><br><span class="line">//......省略</span><br></pre></td></tr></table></figure>


<p>首先来看看打印log：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">/kernel/msm<span class="number">-3.18</span>/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi</span><br><span class="line">&amp;soc &#123;</span><br><span class="line">    mdss_mdp: qcom,mdss_mdp@<span class="number">900000</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;qcom,mdss_mdp&quot;</span>;</span><br><span class="line">......</span><br><span class="line">    mdss_dsi: qcom,mdss_dsi@<span class="number">0</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;qcom,mdss-dsi&quot;</span>;</span><br><span class="line">......</span><br><span class="line">        mdss_dsi0: qcom,mdss_dsi_ctrl0@<span class="number">994000</span> &#123;</span><br><span class="line">            compatible = <span class="string">&quot;qcom,mdss-dsi-ctrl&quot;</span>;</span><br><span class="line">            label = <span class="string">&quot;MDSS DSI CTRL-&gt;0&quot;</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">msm8996:/sys/devices/soc/<span class="number">900000.</span>qcom,mdss_mdp <span class="meta"># ls -l</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,mdss_fb_hdmi</span><br><span class="line">drwxr-xr-x <span class="number">4</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,mdss_fb_primary</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,mdss_fb_wfd</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,smmu_mdp_sec_cb</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,smmu_mdp_unsec_cb</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,smmu_rot_sec_cb</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">900000.</span>qcom,mdss_mdp:qcom,smmu_rot_unsec_cb</span><br><span class="line">-rw-rw-r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> bw_mode_bitmap</span><br><span class="line">-r--r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> caps</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> driver -&gt; ../../../bus/platform/drivers/mdp</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> driver_override</span><br><span class="line">-r--r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> modalias</span><br><span class="line">drwxr-xr-x <span class="number">2</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> power</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> subsystem -&gt; ../../../bus/platform</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> uevent</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">msm8996:/sys/devices/soc/soc:qcom,mdss_dsi@<span class="number">0</span> <span class="meta"># ls -l</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> <span class="number">994000.</span>qcom,mdss_dsi_ctrl0</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root    <span class="number">0</span> <span class="number">2019</span><span class="number">-02</span><span class="number">-23</span> <span class="number">10</span>:<span class="number">38</span> driver -&gt; ../../../bus/platform/drivers/mdss_dsi</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">2019</span><span class="number">-02</span><span class="number">-23</span> <span class="number">10</span>:<span class="number">38</span> driver_override</span><br><span class="line">-r--r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">2019</span><span class="number">-02</span><span class="number">-23</span> <span class="number">10</span>:<span class="number">38</span> modalias</span><br><span class="line">drwxr-xr-x <span class="number">2</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> power</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root    <span class="number">0</span> <span class="number">2019</span><span class="number">-02</span><span class="number">-23</span> <span class="number">10</span>:<span class="number">38</span> subsystem -&gt; ../../../bus/platform</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> uevent</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">msm8996:/sys/devices/soc/<span class="number">900000.</span>qcom,mdss_mdp/<span class="number">900000.</span>qcom,mdss_mdp:qcom,mdss_fb_primary <span class="meta"># ls -l</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> driver -&gt; ../../../../bus/platform/drivers/mdss_fb</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> driver_override</span><br><span class="line">drwxr-xr-x <span class="number">3</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> leds</span><br><span class="line">-r--r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> modalias</span><br><span class="line">drwxr-xr-x <span class="number">2</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> power</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root    <span class="number">0</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> subsystem -&gt; ../../../../bus/platform</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">4096</span> <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">01</span>:<span class="number">12</span> uevent</span><br><span class="line">msm8996:/sys/devices/soc/<span class="number">900000.</span>qcom,mdss_mdp/<span class="number">900000.</span>qcom,mdss_mdp:qcom,mdss_fb_primary #</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">---&gt;&gt;&gt;Logs:</span><br><span class="line"> </span><br><span class="line">mdss_mdp.panel=<span class="number">1</span>:dsi:<span class="number">0</span>:qcom,mdss_dsi_jd9161_fwvga_vid:<span class="number">1</span>:none:cfg:dual_dsi skip_initramfs rootwait ro init=/init root=/dev/sde18</span><br><span class="line"> </span><br><span class="line"><span class="number">1.0</span> mdss_mdp_probe()</span><br><span class="line"> </span><br><span class="line"> [ [    <span class="number">2.183106</span>]  [ mdss_mdp_probe [ : mdss version = <span class="number">0x10070002</span>, bootloader display is on, num <span class="number">1</span>, intf_sel=<span class="number">0x00000100</span></span><br><span class="line"> [ [    <span class="number">2.191112</span>]  [ mdss_smmu_probe [ : iommu v2 domain[<span class="number">0</span>] mapping <span class="keyword">and</span> clk <span class="keyword">register</span> successful!</span><br><span class="line"> [ [    <span class="number">2.191547</span>]  [ mdss_smmu_probe [ : iommu v2 domain[<span class="number">1</span>] mapping <span class="keyword">and</span> clk <span class="keyword">register</span> successful!</span><br><span class="line"> [ [    <span class="number">2.191935</span>]  [ mdss_smmu_probe [ : iommu v2 domain[<span class="number">2</span>] mapping <span class="keyword">and</span> clk <span class="keyword">register</span> successful!</span><br><span class="line"> [ [    <span class="number">2.192318</span>]  [ mdss_smmu_probe [ : iommu v2 domain[<span class="number">3</span>] mapping <span class="keyword">and</span> clk <span class="keyword">register</span> successful!</span><br><span class="line"> </span><br><span class="line"><span class="number">2.1</span> mdss_dsi__probe()</span><br><span class="line">--&gt;mdss_dsi_res_init</span><br><span class="line">----&gt;mdss_dsi_get_dt_vreg_data</span><br><span class="line"> </span><br><span class="line"> [ [    <span class="number">2.194876</span>]  [ mdss_dsi_get_dt_vreg_data [ : error reading ulp load. rc=<span class="number">-22</span></span><br><span class="line"> [ [    <span class="number">2.194903</span>]  [ mdss_dsi_get_dt_vreg_data [ : error reading ulp load. rc=<span class="number">-22</span></span><br><span class="line"> [ [    <span class="number">2.194923</span>]  [ mdss_dsi_get_dt_vreg_data [ : error reading ulp load. rc=<span class="number">-22</span></span><br><span class="line"> [ [    <span class="number">2.197217</span>]  [ mdss_dsi_ctrl_probe [ : DSI Ctrl name = MDSS DSI CTRL-&gt;<span class="number">0</span></span><br><span class="line"> [ [    <span class="number">2.197830</span>]  [ mdss_dsi_find_panel_of_node [ : cmdline:<span class="number">0</span>:qcom,mdss_dsi_jd9161_fwvga_vid:<span class="number">1</span>:none:cfg:dual_dsi panel_name:qcom,mdss_dsi_jd9161_fwvga_vid</span><br><span class="line"> [ [    <span class="number">2.197853</span>]  [ mdss_dsi_panel_init [ : Panel Name = JD9161 fwvga video mode dsi panel</span><br><span class="line"> [ [    <span class="number">2.197953</span>]  [ mdss_dsi_panel_timing_from_dt [ : found <span class="keyword">new</span> timing <span class="string">&quot;qcom,mdss_dsi_jd9161_fwvga_vid&quot;</span> (ffffffc0b5217288)</span><br><span class="line"> [ [    <span class="number">2.197973</span>]  [ mdss_dsi_parse_dcs_cmds [ : failed, key=qcom,mdss-dsi-post-panel-on-command</span><br><span class="line"> [ [    <span class="number">2.197981</span>]  [ mdss_dsi_parse_dcs_cmds [ : failed, key=qcom,mdss-dsi-timing-<span class="keyword">switch</span>-command</span><br><span class="line"> [ [    <span class="number">2.197987</span>]  [ mdss_dsi_panel_get_dsc_cfg_np [ : cannot find dsc config node:</span><br><span class="line"> [ [    <span class="number">2.198059</span>]  [ mdss_dsi_parse_dcs_cmds [ : failed, key=qcom,mdss-dsi-idle-on-command</span><br><span class="line"> [ [    <span class="number">2.198067</span>]  [ mdss_dsi_parse_dcs_cmds [ : failed, key=qcom,mdss-dsi-idle-off-command</span><br><span class="line"> [ [    <span class="number">2.198082</span>]  [ mdss_dsi_parse_panel_features [ : ulps feature disabled</span><br><span class="line"> [ [    <span class="number">2.198090</span>]  [ mdss_dsi_parse_panel_features [ : ulps during suspend feature disabled</span><br><span class="line"> [ [    <span class="number">2.198097</span>]  [ mdss_dsi_parse_dms_config [ : dynamic <span class="keyword">switch</span> feature enabled: <span class="number">0</span></span><br><span class="line"> [ [    <span class="number">2.198112</span>]  [ mdss_dsi_parse_dcs_cmds [ : failed, key=qcom,mdss-dsi-lp-mode-on</span><br><span class="line"> [ [    <span class="number">2.198119</span>]  [ mdss_dsi_parse_dcs_cmds [ : failed, key=qcom,mdss-dsi-lp-mode-off</span><br><span class="line"> [ [    <span class="number">2.198526</span>]  [ mdss_dsi_get_dt_vreg_data [ : error reading ulp load. rc=<span class="number">-22</span></span><br><span class="line"> [ [    <span class="number">2.198544</span>]  [ mdss_dsi_get_dt_vreg_data [ : error reading ulp load. rc=<span class="number">-22</span></span><br><span class="line"> [ [    <span class="number">2.198843</span>]  [ mdss_dsi_parse_ctrl_params:<span class="number">4072</span> Unable to read qcom,display-id, data=<span class="number">0000000000000000</span>,len=<span class="number">20</span></span><br><span class="line"> [ [    2.198977]  [ msm_dss_get_res_byname [ : &#x27;dsi_phy_regulator&#x27; resource not found</span><br><span class="line"> [ [    2.199006]  [ mdss_dsi_retrieve_ctrl_resources+0x170/0x254-&gt;msm_dss_ioremap_byname [ : &#x27;dsi_phy_regulator&#x27; msm_dss_get_res_byname failed</span><br><span class="line"> [ [    <span class="number">2.199013</span>]  [ mdss_dsi_retrieve_ctrl_resources [ : ctrl_base=ffffff800179c000 ctrl_size=<span class="number">400</span> phy_base=ffffff800179e400 phy_size=<span class="number">588</span></span><br><span class="line"> [ [    <span class="number">2.199326</span>]  [ dsi_panel_device_register [ : Continuous splash enabled</span><br><span class="line"> [ [    <span class="number">2.200158</span>]  [ mdss_register_panel [ : adding framebuffer device <span class="number">994000.</span>qcom,mdss_dsi_ctrl0</span><br><span class="line"> </span><br><span class="line"><span class="number">2.2</span> mdss_dsi_ctrl_probe()</span><br><span class="line"> </span><br><span class="line"> [ [    <span class="number">2.201997</span>]  [ mdss_dsi_ctrl_probe [ : Dsi Ctrl-&gt;<span class="number">0</span> initialized, DSI rev:<span class="number">0x10040001</span>, PHY rev:<span class="number">0x2</span></span><br><span class="line"> [ [    <span class="number">2.203915</span>]  [ mdss_dsi_status_init [ : DSI status check interval:<span class="number">5000</span></span><br><span class="line"> [ [    <span class="number">2.205862</span>]  [ hdmi_tx_get_dt_data:<span class="number">4387</span> Unable to read qcom,display-id, data=<span class="number">0000000000000000</span>,len=<span class="number">0</span></span><br><span class="line"> [ [    2.206973]  [ hdmi_tx_init_resource [ : &#x27;core_physical&#x27;: start = 0xffffff80017b4000, len=0x50c</span><br><span class="line"> [ [    2.206987]  [ hdmi_tx_init_resource [ : &#x27;qfprom_physical&#x27;: start = 0xffffff80017b8000, len=0x6158</span><br><span class="line"> [ [    2.207077]  [ hdmi_tx_init_resource [ : &#x27;hdcp_physical&#x27;: start = 0xffffff80017b6000, len=0xfff</span><br><span class="line"> [ [    <span class="number">2.208770</span>]  [ mdss_register_panel [ : adding framebuffer device <span class="number">9</span>a0000.qcom,hdmi_tx</span><br><span class="line"> [ [    <span class="number">2.212112</span>]  [ mdss_register_panel [ : adding framebuffer device soc:qcom,mdss_wb_panel</span><br><span class="line"> </span><br><span class="line"><span class="number">3.0</span> mdss_fb_probe()</span><br><span class="line"> </span><br><span class="line"> [ [    <span class="number">2.214819</span>]  [ mdss_fb_probe [ : fb0: split_mode:<span class="number">0</span> left:<span class="number">0</span> right:<span class="number">0</span></span><br><span class="line"> [ [    <span class="number">2.216288</span>]  [ mdss_fb_register [ : FrameBuffer[<span class="number">0</span>] <span class="number">480</span>x854 registered successfully!</span><br><span class="line"> [ [    <span class="number">2.217832</span>]  [ mdss_fb_probe [ : fb1: split_mode:<span class="number">0</span> left:<span class="number">0</span> right:<span class="number">0</span></span><br><span class="line"> [ [    <span class="number">2.218084</span>]  [ mdss_fb_register [ : FrameBuffer[<span class="number">1</span>] <span class="number">640</span>x480 registered successfully!</span><br><span class="line"> </span><br><span class="line"> [ [    <span class="number">2.270242</span>]  [ mdss_fb_probe [ : fb2: split_mode:<span class="number">0</span> left:<span class="number">0</span> right:<span class="number">0</span></span><br><span class="line"> [ [    <span class="number">2.270614</span>]  [ mdss_fb_register [ : FrameBuffer[<span class="number">2</span>] <span class="number">640</span>x480 registered successfully!</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">msm8996:/ <span class="meta"># ps -A | grep <span class="meta-string">&quot;mdss&quot;</span>                                                </span></span><br><span class="line">root           <span class="number">130</span>     <span class="number">2</span>       <span class="number">0</span>      <span class="number">0</span> dsi_event_thread    <span class="number">0</span> D [mdss_dsi_event]</span><br><span class="line">root           <span class="number">131</span>     <span class="number">2</span>       <span class="number">0</span>      <span class="number">0</span> rescuer_thread      <span class="number">0</span> S [mdss_dsi_dba]</span><br><span class="line">msm8996:/ #</span><br><span class="line">---&gt;&gt;&gt;Power On</span><br><span class="line">msm8996:/ <span class="meta"># ps -A | grep <span class="meta-string">&quot;mdss&quot;</span>                                                </span></span><br><span class="line">root           <span class="number">130</span>     <span class="number">2</span>       <span class="number">0</span>      <span class="number">0</span> dsi_event_thread    <span class="number">0</span> D [mdss_dsi_event]</span><br><span class="line">root           <span class="number">131</span>     <span class="number">2</span>       <span class="number">0</span>      <span class="number">0</span> rescuer_thread      <span class="number">0</span> S [mdss_dsi_dba]</span><br><span class="line">root          <span class="number">4039</span>     <span class="number">2</span>       <span class="number">0</span>      <span class="number">0</span> __mdss_fb_display_thread <span class="number">0</span> D [mdss_fb0]</span><br></pre></td></tr></table></figure>


<h4 id="一-、MDP分析"><a href="#一-、MDP分析" class="headerlink" title="(一)、MDP分析"></a>(一)、MDP分析</h4><p>LCD相关code所在目录：<br>        kernel/drvier/video/msm/mdss/<br>软件驱动主要分为三部分：<br>        MDP 驱动<br>        DSI 控制器驱动<br>        FrameBuffer驱动<br>执行probe 的先后顺序：<br>       <strong>MDP probe →  DSI probe → FB probe</strong></p>
<p>根据设备树的compatible 可知，当检测到同名的，会调用对应的probe()函数。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG2.mdp_probe.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/kernel/msm<span class="number">-3.18</span>/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi</span><br><span class="line">&amp;soc &#123;</span><br><span class="line">    mdss_mdp: qcom,mdss_mdp@<span class="number">900000</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;qcom,mdss_mdp&quot;</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_mdp.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">mdss_mdp_dt_match</span>[] = &#123;</span></span><br><span class="line">    &#123; .compatible = <span class="string">&quot;qcom,mdss_mdp&quot;</span>,&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, mdss_mdp_dt_match);</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_mdp_driver</span> = &#123;</span></span><br><span class="line">    .probe = mdss_mdp_probe,</span><br><span class="line">    .remove = mdss_mdp_remove,</span><br><span class="line">    .suspend = mdss_mdp_suspend,</span><br><span class="line">    .resume = mdss_mdp_resume,</span><br><span class="line">    .shutdown = <span class="literal">NULL</span>,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Driver name must match the device name added in</span></span><br><span class="line"><span class="comment">         * platform.c.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        .name = <span class="string">&quot;mdp&quot;</span>,</span><br><span class="line">        .of_match_table = mdss_mdp_dt_match,</span><br><span class="line">        .pm = &amp;mdss_mdp_pm_ops,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先看看mdss_mdp_probe(struct platform_device *pdev)函数：</p>
<h5 id="1-1、为关键驱动数据结构-struct-mdss-data-type-mdata-分配空间"><a href="#1-1、为关键驱动数据结构-struct-mdss-data-type-mdata-分配空间" class="headerlink" title="1.1、为关键驱动数据结构 struct mdss_data_type *mdata 分配空间"></a>1.1、为关键驱动数据结构 struct mdss_data_type *mdata 分配空间</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_mdp.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> intf_sel = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> split_display = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> num_of_display_on = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    mdata = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*mdata), GFP_KERNEL);</span><br><span class="line">    .......</span><br><span class="line">    <span class="comment">//初始化中断函数</span></span><br><span class="line">    mdss_res-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>获得资源，赋值给mdata结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_mdp.c</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mdss_hw</span> <span class="title">mdss_mdp_hw</span> = &#123;</span></span><br><span class="line">    .hw_ndx = MDSS_HW_MDP,</span><br><span class="line">    .ptr = <span class="literal">NULL</span>,</span><br><span class="line">    .irq_handler = mdss_mdp_isr,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获得资源，赋值给mdata结构体</span></span><br><span class="line">    解释如下项：</span><br><span class="line">   /kernel/msm<span class="number">-3.18</span>/arch/arm/boot/dts/qcom/msm8996-mdss.dtsi</span><br><span class="line">        reg = &lt;<span class="number">0x00900000</span> <span class="number">0x90000</span>&gt;,</span><br><span class="line">              &lt;<span class="number">0x009b0000</span> <span class="number">0x1040</span>&gt;,</span><br><span class="line">              &lt;<span class="number">0x009b8000</span> <span class="number">0x1040</span>&gt;;</span><br><span class="line">        reg-names = <span class="string">&quot;mdp_phys&quot;</span>, <span class="string">&quot;vbif_phys&quot;</span>, <span class="string">&quot;vbif_nrt_phys&quot;</span>;</span><br><span class="line">   <span class="comment">/////////////////////////////////////////////////////////////////////</span></span><br><span class="line">       rc = msm_dss_ioremap_byname(pdev, &amp;mdata-&gt;mdss_io, <span class="string">&quot;mdp_phys&quot;</span>);</span><br><span class="line">    rc = msm_dss_ioremap_byname(pdev, &amp;mdata-&gt;vbif_io, <span class="string">&quot;vbif_phys&quot;</span>);</span><br><span class="line">    rc = msm_dss_ioremap_byname(pdev, &amp;mdata-&gt;vbif_nrt_io, <span class="string">&quot;vbif_nrt_phys&quot;</span>);</span><br><span class="line">    res = platform_get_resource(pdev, IORESOURCE_IRQ, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    mdss_mdp_hw.irq_info = kzalloc(<span class="keyword">sizeof</span>(struct irq_info), GFP_KERNEL); </span><br><span class="line">    mdss_mdp_hw.irq_info-&gt;irq = res-&gt;start; </span><br><span class="line">    mdss_mdp_hw.ptr = mdata; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="1-2、clk和irq设置、ionclient创建，iommu初始化"><a href="#1-2、clk和irq设置、ionclient创建，iommu初始化" class="headerlink" title="1.2、clk和irq设置、ionclient创建，iommu初始化"></a>1.2、clk和irq设置、ionclient创建，iommu初始化</h5><p> 接下来看看mdss_mdp_res_init(mdata)函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_mdp.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> u32 <span class="title">mdss_mdp_res_init</span><span class="params">(struct mdss_data_type *mdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 rc = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">    mdata-&gt;res_init = <span class="literal">true</span>;</span><br><span class="line">    mdata-&gt;clk_ena = <span class="literal">false</span>;</span><br><span class="line">    mdss_mdp_hw.irq_info-&gt;irq_mask = MDSS_MDP_DEFAULT_INTR_MASK;</span><br><span class="line">    mdss_mdp_hw.irq_info-&gt;irq_ena = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//clk和irq设置</span></span><br><span class="line">    rc = mdss_mdp_irq_clk_setup(mdata);</span><br><span class="line">    ......</span><br><span class="line">    mdata-&gt;hist_intr.req = <span class="number">0</span>;</span><br><span class="line">    mdata-&gt;hist_intr.curr = <span class="number">0</span>;</span><br><span class="line">    mdata-&gt;hist_intr.state = <span class="number">0</span>;</span><br><span class="line">    spin_lock_init(&amp;mdata-&gt;hist_intr.lock);</span><br><span class="line">    <span class="comment">//ionclient创建，iommu初始化 </span></span><br><span class="line">    mdata-&gt;iclient = msm_ion_client_create(mdata-&gt;pdev-&gt;name);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line">                解释如下项：</span><br><span class="line">                ----------start---------</span><br><span class="line">                G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\arch\arm\boot\dts\qcom\msm8996-mdss.dtsi</span><br><span class="line">                qcom,max-clk-rate = &lt;<span class="number">412500000</span>&gt;;;</span><br><span class="line">                vdd-supply = &lt;&amp;gdsc_mdss&gt;;</span><br><span class="line">                clock-names = <span class="string">&quot;iface_clk&quot;</span>, <span class="string">&quot;bus_clk&quot;</span>, <span class="string">&quot;core_clk_src&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;core_clk&quot;</span>, <span class="string">&quot;vsync_clk&quot;</span>;</span><br><span class="line">                G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\arch\arm\boot\dts\qcom\msm-gdsc<span class="number">-8996.</span>dtsi</span><br><span class="line">                gdsc_mdss: qcom,gdsc@<span class="number">8</span>c2304 &#123;</span><br><span class="line">                    compatible = <span class="string">&quot;qcom,gdsc&quot;</span>;</span><br><span class="line">                    regulator-name = <span class="string">&quot;gdsc_mdss&quot;</span>;</span><br><span class="line">                    reg = &lt;<span class="number">0x8c2304</span> <span class="number">0x4</span>&gt;;</span><br><span class="line">                    status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_irq_clk_setup</span><span class="params">(struct mdss_data_type *mdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = of_property_read_u32(mdata-&gt;pdev-&gt;dev.of_node,</span><br><span class="line">            <span class="string">&quot;qcom,max-clk-rate&quot;</span>, &amp;mdata-&gt;max_mdp_clk_rate);</span><br><span class="line">    <span class="comment">//注册中断，中断总入口</span></span><br><span class="line">    ret = devm_request_irq(&amp;mdata-&gt;pdev-&gt;dev, mdss_mdp_hw.irq_info-&gt;irq,</span><br><span class="line">                mdss_irq_handler, IRQF_DISABLED, <span class="string">&quot;MDSS&quot;</span>, mdata);</span><br><span class="line"></span><br><span class="line">    disable_irq(mdss_mdp_hw.irq_info-&gt;irq);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;fs = devm_regulator_get(&amp;mdata-&gt;pdev-&gt;dev, <span class="string">&quot;vdd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;venus = devm_regulator_get_optional(&amp;mdata-&gt;pdev-&gt;dev,</span><br><span class="line">        <span class="string">&quot;gdsc-venus&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mdata-&gt;fs_ena = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    mdata-&gt;gdsc_cb.notifier_call = mdss_mdp_gdsc_notifier_call;</span><br><span class="line">    mdata-&gt;gdsc_cb.priority = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">if</span> (regulator_register_notifier(mdata-&gt;fs, &amp;(mdata-&gt;gdsc_cb)))</span><br><span class="line">        pr_warn(<span class="string">&quot;GDSC notification registration failed!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        mdata-&gt;regulator_notif_register = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    mdata-&gt;vdd_cx = devm_regulator_get_optional(&amp;mdata-&gt;pdev-&gt;dev,</span><br><span class="line">                <span class="string">&quot;vdd-cx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;reg_bus_clt = mdss_reg_bus_vote_client_create(<span class="string">&quot;mdp\0&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mdss_mdp_irq_clk_register(mdata, <span class="string">&quot;bus_clk&quot;</span>, MDSS_CLK_AXI) ||</span><br><span class="line">        mdss_mdp_irq_clk_register(mdata, <span class="string">&quot;iface_clk&quot;</span>, MDSS_CLK_AHB) ||</span><br><span class="line">        mdss_mdp_irq_clk_register(mdata, <span class="string">&quot;core_clk&quot;</span>,</span><br><span class="line">                      MDSS_CLK_MDP_CORE))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* lut_clk is not present on all MDSS revisions */</span></span><br><span class="line">    mdss_mdp_irq_clk_register(mdata, <span class="string">&quot;lut_clk&quot;</span>, MDSS_CLK_MDP_LUT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* vsync_clk is optional for non-smart panels */</span></span><br><span class="line">    mdss_mdp_irq_clk_register(mdata, <span class="string">&quot;vsync_clk&quot;</span>, MDSS_CLK_MDP_VSYNC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Setting the default clock rate to the max supported.*/</span></span><br><span class="line">    mdss_mdp_set_clk_rate(mdata-&gt;max_mdp_clk_rate);</span><br><span class="line">    pr_debug(<span class="string">&quot;mdp clk rate=%ld\n&quot;</span>,</span><br><span class="line">        mdss_mdp_get_clk_rate(MDSS_CLK_MDP_CORE, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pm_runtime_set_autosuspend_delay(&amp;pdev-&gt;dev, AUTOSUSPEND_TIMEOUT_MS);</span><br><span class="line"><span class="keyword">if</span> (mdata-&gt;idle_pc_enabled)</span><br><span class="line">    pm_runtime_use_autosuspend(&amp;pdev-&gt;dev);</span><br><span class="line">pm_runtime_set_suspended(&amp;pdev-&gt;dev);</span><br><span class="line">pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_bus_scale_register(mdata);</span><br><span class="line">......</span><br><span class="line">mdss_mdp_footswitch_ctrl_splash(<span class="literal">true</span>);</span><br><span class="line">mdss_hw_rev_init(mdata);</span><br></pre></td></tr></table></figure>

<h5 id="1-3、解释dts为-struct-mdss-data-type-mdata-赋值"><a href="#1-3、解释dts为-struct-mdss-data-type-mdata-赋值" class="headerlink" title="1.3、解释dts为 struct mdss_data_type *mdata 赋值"></a>1.3、解释dts为 struct mdss_data_type *mdata 赋值</h5><h5 id="1-3-1、mdss-mdp-parse-dt-hw-settings-pdev"><a href="#1-3-1、mdss-mdp-parse-dt-hw-settings-pdev" class="headerlink" title="1.3.1、mdss_mdp_parse_dt_hw_settings(pdev)"></a>1.3.1、mdss_mdp_parse_dt_hw_settings(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">解释如下两项： <span class="class"><span class="keyword">struct</span> <span class="title">mdss_hw_settings</span> *<span class="title">hws</span>;</span></span><br><span class="line">----------start---------</span><br><span class="line">qcom,vbif-settings</span><br><span class="line">qcom,vbif-nrt-settings</span><br><span class="line">qcom,mdp-settings</span><br><span class="line">----------end---------</span><br><span class="line">    mdata-&gt;hw_settings = hws</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mdss_mdp_parse_dt_hw_settings(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">    struct mdss_data_type *mdata = platform_get_drvdata(pdev);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_hw_settings</span> *<span class="title">hws</span>;</span></span><br><span class="line">    <span class="keyword">const</span> u32 *vbif_arr, *mdp_arr, *vbif_nrt_arr;</span><br><span class="line">    <span class="keyword">int</span> vbif_len, mdp_len, vbif_nrt_len;</span><br><span class="line"></span><br><span class="line">    vbif_arr = of_get_property(pdev-&gt;dev.of_node, <span class="string">&quot;qcom,vbif-settings&quot;</span>,</span><br><span class="line">            &amp;vbif_len);</span><br><span class="line"></span><br><span class="line">    vbif_len /= <span class="number">2</span> * <span class="keyword">sizeof</span>(u32);</span><br><span class="line"></span><br><span class="line">    vbif_nrt_arr = of_get_property(pdev-&gt;dev.of_node,</span><br><span class="line">                <span class="string">&quot;qcom,vbif-nrt-settings&quot;</span>, &amp;vbif_nrt_len);</span><br><span class="line"></span><br><span class="line">    vbif_nrt_len /= <span class="number">2</span> * <span class="keyword">sizeof</span>(u32);</span><br><span class="line"></span><br><span class="line">    mdp_arr = of_get_property(pdev-&gt;dev.of_node, <span class="string">&quot;qcom,mdp-settings&quot;</span>,</span><br><span class="line">            &amp;mdp_len);</span><br><span class="line"></span><br><span class="line">    mdp_len /= <span class="number">2</span> * <span class="keyword">sizeof</span>(u32);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hws = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*hws) * (vbif_len + mdp_len +</span><br><span class="line">            vbif_nrt_len + <span class="number">1</span>), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    mdss_mdp_parse_dt_regs_array(vbif_arr, &amp;mdata-&gt;vbif_io,</span><br><span class="line">            hws, vbif_len);</span><br><span class="line">    mdss_mdp_parse_dt_regs_array(vbif_nrt_arr, &amp;mdata-&gt;vbif_nrt_io,</span><br><span class="line">            hws, vbif_nrt_len);</span><br><span class="line">    mdss_mdp_parse_dt_regs_array(mdp_arr, &amp;mdata-&gt;mdss_io,</span><br><span class="line">        hws + vbif_len, mdp_len);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;hw_settings = hws;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-3-2、mdss-mdp-parse-dt-pipe-pdev"><a href="#1-3-2、mdss-mdp-parse-dt-pipe-pdev" class="headerlink" title="1.3.2、mdss_mdp_parse_dt_pipe(pdev)"></a>1.3.2、mdss_mdp_parse_dt_pipe(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">        解释如下项:</span><br><span class="line">            ----------start---------</span><br><span class="line">        qcom,mdss-pipe-vig-off = &lt;<span class="number">0x00005000</span> <span class="number">0x00007000</span></span><br><span class="line">                      <span class="number">0x00009000</span> <span class="number">0x0000B000</span>&gt;;</span><br><span class="line">        qcom,mdss-pipe-rgb-off = &lt;<span class="number">0x00015000</span> <span class="number">0x00017000</span></span><br><span class="line">                      <span class="number">0x00019000</span> <span class="number">0x0001B000</span>&gt;;</span><br><span class="line">        qcom,mdss-pipe-dma-off = &lt;<span class="number">0x00025000</span> <span class="number">0x00027000</span>&gt;;</span><br><span class="line">        qcom,mdss-pipe-cursor-off = &lt;<span class="number">0x00035000</span> <span class="number">0x00037000</span>&gt;;</span><br><span class="line"></span><br><span class="line">        qcom,mdss-pipe-vig-xin-id = &lt;<span class="number">0</span> <span class="number">4</span> <span class="number">8</span> <span class="number">12</span>&gt;;</span><br><span class="line">        qcom,mdss-pipe-rgb-xin-id = &lt;<span class="number">1</span> <span class="number">5</span> <span class="number">9</span> <span class="number">13</span>&gt;;</span><br><span class="line">        qcom,mdss-pipe-dma-xin-id = &lt;<span class="number">2</span> <span class="number">10</span>&gt;;</span><br><span class="line">        qcom,mdss-pipe-cursor-xin-id = &lt;<span class="number">7</span> <span class="number">7</span>&gt;;</span><br><span class="line"></span><br><span class="line">            ----------end ---------</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_pipe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    u32 nfids = <span class="number">0</span>, len, nxids = <span class="number">0</span>, npipes = <span class="number">0</span>;</span><br><span class="line">    u32 sw_reset_offset = <span class="number">0</span>;</span><br><span class="line">    u32 data[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line"></span><br><span class="line">    mdata-&gt;has_pixel_ram = !mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                        <span class="string">&quot;qcom,mdss-smp-data&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;nvig_pipes = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-pipe-vig-off&quot;</span>);</span><br><span class="line">    mdata-&gt;nrgb_pipes = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-pipe-rgb-off&quot;</span>);</span><br><span class="line">    mdata-&gt;ndma_pipes = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-pipe-dma-off&quot;</span>);</span><br><span class="line">    mdata-&gt;ncursor_pipes = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-pipe-cursor-off&quot;</span>);</span><br><span class="line"></span><br><span class="line">    npipes = mdata-&gt;nvig_pipes + mdata-&gt;nrgb_pipes + mdata-&gt;ndma_pipes;</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_parse_dt_pipe_helper(pdev, MDSS_MDP_PIPE_TYPE_VIG, <span class="string">&quot;vig&quot;</span>,</span><br><span class="line">            &amp;mdata-&gt;vig_pipes, mdata-&gt;nvig_pipes, <span class="number">0</span>);</span><br><span class="line">    mdata-&gt;nvig_pipes = rc;</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_parse_dt_pipe_helper(pdev, MDSS_MDP_PIPE_TYPE_RGB, <span class="string">&quot;rgb&quot;</span>,</span><br><span class="line">            &amp;mdata-&gt;rgb_pipes, mdata-&gt;nrgb_pipes,</span><br><span class="line">            mdata-&gt;nvig_pipes);</span><br><span class="line">    mdata-&gt;nrgb_pipes = rc;</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_parse_dt_pipe_helper(pdev, MDSS_MDP_PIPE_TYPE_DMA, <span class="string">&quot;dma&quot;</span>,</span><br><span class="line">            &amp;mdata-&gt;dma_pipes, mdata-&gt;ndma_pipes,</span><br><span class="line">            mdata-&gt;nvig_pipes + mdata-&gt;nrgb_pipes);</span><br><span class="line">    mdata-&gt;ndma_pipes = rc;</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_parse_dt_pipe_helper(pdev, MDSS_MDP_PIPE_TYPE_CURSOR,</span><br><span class="line">            <span class="string">&quot;cursor&quot;</span>, &amp;mdata-&gt;cursor_pipes, mdata-&gt;ncursor_pipes,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    mdata-&gt;ncursor_pipes = rc;</span><br><span class="line"></span><br><span class="line">    rc = <span class="number">0</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-3-3、mdss-mdp-parse-dt-mixer-pdev"><a href="#1-3-3、mdss-mdp-parse-dt-mixer-pdev" class="headerlink" title="1.3.3、mdss_mdp_parse_dt_mixer(pdev)"></a>1.3.3、mdss_mdp_parse_dt_mixer(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">            解释如下项：</span><br><span class="line">            ----------start---------</span><br><span class="line">            qcom,mdss-mixer-intf-off</span><br><span class="line">            qcom,mdss-mixer-wb-off</span><br><span class="line">            qcom,mdss-dspp-off</span><br><span class="line">            qcom,mdss-pingpong-off</span><br><span class="line">            ----------end------------</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_mixer</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    u32 nmixers, npingpong;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    u32 *mixer_offsets = <span class="literal">NULL</span>, *dspp_offsets = <span class="literal">NULL</span>,</span><br><span class="line">        *pingpong_offsets = <span class="literal">NULL</span>;</span><br><span class="line">    u32 is_virtual_mixer_req = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line"></span><br><span class="line">    mdata-&gt;nmixers_intf = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-mixer-intf-off&quot;</span>);</span><br><span class="line">    mdata-&gt;nmixers_wb = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-mixer-wb-off&quot;</span>);</span><br><span class="line">    mdata-&gt;ndspp = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-dspp-off&quot;</span>);</span><br><span class="line">    npingpong = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">                <span class="string">&quot;qcom,mdss-pingpong-off&quot;</span>);</span><br><span class="line">    nmixers = mdata-&gt;nmixers_intf + mdata-&gt;nmixers_wb;</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">            <span class="string">&quot;qcom,max-mixer-width&quot;</span>, &amp;mdata-&gt;max_mixer_width);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mixer_offsets = kzalloc(<span class="keyword">sizeof</span>(u32) * nmixers, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    dspp_offsets = kzalloc(<span class="keyword">sizeof</span>(u32) * mdata-&gt;ndspp, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    pingpong_offsets = kzalloc(<span class="keyword">sizeof</span>(u32) * npingpong, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">            rc = mdss_mdp_mixer_addr_setup(mdata, mixer_offsets +</span><br><span class="line">                mdata-&gt;nmixers_intf - mdata-&gt;ndma_pipes,</span><br><span class="line">                <span class="literal">NULL</span>, <span class="literal">NULL</span>, MDSS_MDP_MIXER_TYPE_WRITEBACK,</span><br><span class="line">                mdata-&gt;nmixers_wb);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-4、mdss-mdp-parse-dt-mixer-pdev"><a href="#1-3-4、mdss-mdp-parse-dt-mixer-pdev" class="headerlink" title="1.3.4、mdss_mdp_parse_dt_mixer(pdev)"></a>1.3.4、mdss_mdp_parse_dt_mixer(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_misc</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line">    u32 data, slave_pingpong_off;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *wfd_data;</span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">prop</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(pdev-&gt;dev.of_node, <span class="string">&quot;qcom,mdss-rot-block-size&quot;</span>,</span><br><span class="line">        &amp;data);</span><br><span class="line">    mdata-&gt;rot_block_size = (!rc ? data : <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-default-ot-rd-limit&quot;</span>, &amp;data);</span><br><span class="line">    mdata-&gt;default_ot_rd_limit = (!rc ? data : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-default-ot-wr-limit&quot;</span>, &amp;data);</span><br><span class="line">    mdata-&gt;default_ot_wr_limit = (!rc ? data : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;has_non_scalar_rgb = of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-has-non-scalar-rgb&quot;</span>);</span><br><span class="line">    mdata-&gt;has_bwc = of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">                           <span class="string">&quot;qcom,mdss-has-bwc&quot;</span>);</span><br><span class="line">    mdata-&gt;has_decimation = of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-has-decimation&quot;</span>);</span><br><span class="line">    mdata-&gt;has_no_lut_read = of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-no-lut-read&quot;</span>);</span><br><span class="line">    mdata-&gt;needs_hist_vote = !(of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-no-hist-vote&quot;</span>));</span><br><span class="line">    wfd_data = of_get_property(pdev-&gt;dev.of_node,</span><br><span class="line">                    <span class="string">&quot;qcom,mdss-wfd-mode&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-3-5、mdss-mdp-parse-dt-wb-pdev"><a href="#1-3-5、mdss-mdp-parse-dt-wb-pdev" class="headerlink" title="1.3.5、mdss_mdp_parse_dt_wb(pdev)"></a>1.3.5、mdss_mdp_parse_dt_wb(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_wb</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    u32 *wb_offsets = <span class="literal">NULL</span>;</span><br><span class="line">    u32 num_wb_mixer, nwb_offsets, num_intf_wb = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *wfd_data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span>;</span></span><br><span class="line"></span><br><span class="line">    mdata = platform_get_drvdata(pdev);</span><br><span class="line"></span><br><span class="line">    num_wb_mixer = mdata-&gt;nmixers_wb;</span><br><span class="line"></span><br><span class="line">    wfd_data = of_get_property(pdev-&gt;dev.of_node,</span><br><span class="line">                    <span class="string">&quot;qcom,mdss-wfd-mode&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    nwb_offsets =  mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">            <span class="string">&quot;qcom,mdss-wb-off&quot;</span>);</span><br><span class="line"></span><br><span class="line">    wb_offsets = kzalloc(<span class="keyword">sizeof</span>(u32) * nwb_offsets, GFP_KERNEL);</span><br><span class="line">    rc = mdss_mdp_parse_dt_handler(pdev, <span class="string">&quot;qcom,mdss-wb-off&quot;</span>,</span><br><span class="line">        wb_offsets, nwb_offsets);</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_wb_addr_setup(mdata, num_wb_mixer, num_intf_wb);</span><br><span class="line"></span><br><span class="line">    mdata-&gt;nwb_offsets = nwb_offsets;</span><br><span class="line">    mdata-&gt;wb_offsets = wb_offsets;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-6、mdss-mdp-parse-dt-ctl-pdev"><a href="#1-3-6、mdss-mdp-parse-dt-ctl-pdev" class="headerlink" title="1.3.6、mdss_mdp_parse_dt_ctl(pdev)"></a>1.3.6、mdss_mdp_parse_dt_ctl(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_ctl</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    u32 *ctl_offsets = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line">    mdata-&gt;nctl = mdss_mdp_parse_dt_prop_len(pdev,</span><br><span class="line">            <span class="string">&quot;qcom,mdss-ctl-off&quot;</span>);</span><br><span class="line">    ctl_offsets = kzalloc(<span class="keyword">sizeof</span>(u32) * mdata-&gt;nctl, GFP_KERNEL);</span><br><span class="line">    </span><br><span class="line">    rc = mdss_mdp_parse_dt_handler(pdev, <span class="string">&quot;qcom,mdss-ctl-off&quot;</span>,</span><br><span class="line">        ctl_offsets, mdata-&gt;nctl);</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_ctl_addr_setup(mdata, ctl_offsets, mdata-&gt;nctl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-3-7、mdss-mdp-parse-dt-video-intf-pdev"><a href="#1-3-7、mdss-mdp-parse-dt-video-intf-pdev" class="headerlink" title="1.3.7、mdss_mdp_parse_dt_video_intf(pdev)"></a>1.3.7、mdss_mdp_parse_dt_video_intf(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_video_intf</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line">    u32 count;</span><br><span class="line">    u32 *offsets;</span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    count = mdss_mdp_parse_dt_prop_len(pdev, <span class="string">&quot;qcom,mdss-intf-off&quot;</span>);</span><br><span class="line"></span><br><span class="line">    offsets = kzalloc(<span class="keyword">sizeof</span>(u32) * count, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_parse_dt_handler(pdev, <span class="string">&quot;qcom,mdss-intf-off&quot;</span>,</span><br><span class="line">            offsets, count);</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_video_addr_setup(mdata, offsets, count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-3-8、mdss-mdp-parse-dt-smp-pdev"><a href="#1-3-8、mdss-mdp-parse-dt-smp-pdev" class="headerlink" title="1.3.8、mdss_mdp_parse_dt_smp(pdev)"></a>1.3.8、mdss_mdp_parse_dt_smp(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_parse_dt_smp</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line">    u32 num;</span><br><span class="line">    u32 data[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> rc, len;</span><br><span class="line">    <span class="keyword">const</span> u32 *arr;</span><br><span class="line"></span><br><span class="line">    num = mdss_mdp_parse_dt_prop_len(pdev, <span class="string">&quot;qcom,mdss-smp-data&quot;</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This property is optional for targets with fix pixel ram. Rest</span></span><br><span class="line"><span class="comment">     * must provide no. of smp and size of each block.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    rc = mdss_mdp_parse_dt_handler(pdev, <span class="string">&quot;qcom,mdss-smp-data&quot;</span>, data, num);</span><br><span class="line"></span><br><span class="line">    rc = mdss_mdp_smp_setup(mdata, data[<span class="number">0</span>], data[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-smp-mb-per-pipe&quot;</span>, data);</span><br><span class="line">    mdata-&gt;smp_mb_per_pipe = (!rc ? data[<span class="number">0</span>] : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rc = <span class="number">0</span>;</span><br><span class="line">    arr = of_get_property(pdev-&gt;dev.of_node,</span><br><span class="line">            <span class="string">&quot;qcom,mdss-pipe-rgb-fixed-mmb&quot;</span>, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (arr) &#123;</span><br><span class="line">        rc = mdss_mdp_update_smp_map(pdev, arr, len,</span><br><span class="line">                mdata-&gt;nrgb_pipes, mdata-&gt;rgb_pipes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    arr = of_get_property(pdev-&gt;dev.of_node,</span><br><span class="line">            <span class="string">&quot;qcom,mdss-pipe-vig-fixed-mmb&quot;</span>, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (arr) &#123;</span><br><span class="line">        rc = mdss_mdp_update_smp_map(pdev, arr, len,</span><br><span class="line">                mdata-&gt;nvig_pipes, mdata-&gt;vig_pipes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-9、mdss-mdp-parse-dt-xxx-pdev"><a href="#1-3-9、mdss-mdp-parse-dt-xxx-pdev" class="headerlink" title="1.3.9、mdss_mdp_parse_dt_xxx(pdev)"></a>1.3.9、mdss_mdp_parse_dt_xxx(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rc = mdss_mdp_parse_dt_prefill(pdev);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_parse_dt_ad_cfg(pdev);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_parse_dt_cdm(pdev);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_parse_dt_dsc(pdev);</span><br></pre></td></tr></table></figure>
<h5 id="1-4、创建属性文件、挂接中断处理函数"><a href="#1-4、创建属性文件、挂接中断处理函数" class="headerlink" title="1.4、创建属性文件、挂接中断处理函数"></a>1.4、创建属性文件、挂接中断处理函数</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">rc = mdss_mdp_get_cmdline_config(pdev);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_debug_init(pdev, mdata);<span class="comment">//创建debug</span></span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_scaler_init(mdata, &amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_register_sysfs(mdata);</span><br><span class="line"></span><br><span class="line">rc = mdss_fb_register_mdp_instance(&amp;mdp5);</span><br><span class="line"></span><br><span class="line">rc = mdss_res-&gt;mdss_util-&gt;register_irq(&amp;mdss_mdp_hw);</span><br><span class="line"></span><br><span class="line">rc = mdss_smmu_init(mdata, &amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">mdss_mdp_set_supported_formats(mdata);</span><br><span class="line"></span><br><span class="line">mdss_res-&gt;mdss_util-&gt;mdp_probe_done = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">mdss_hw_init(mdata);</span><br><span class="line"></span><br><span class="line">rc = mdss_mdp_pp_init(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-4-1、mdss-mdp-get-cmdline-config-pdev"><a href="#1-4-1、mdss-mdp-get-cmdline-config-pdev" class="headerlink" title="1.4.1、mdss_mdp_get_cmdline_config(pdev)"></a>1.4.1、mdss_mdp_get_cmdline_config(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_get_cmdline_config</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc, len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> *intf_type;</span><br><span class="line">    <span class="keyword">char</span> *panel_name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_cfg</span> *<span class="title">pan_cfg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_data_type</span> *<span class="title">mdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line"></span><br><span class="line">    mdata-&gt;pan_cfg.arg_cfg[MDSS_MAX_PANEL_LEN] = <span class="number">0</span>;</span><br><span class="line">    pan_cfg = &amp;mdata-&gt;pan_cfg;</span><br><span class="line">    panel_name = &amp;pan_cfg-&gt;arg_cfg[<span class="number">0</span>];</span><br><span class="line">    intf_type = &amp;pan_cfg-&gt;pan_intf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* reads from dt by default */</span></span><br><span class="line">    pan_cfg-&gt;lk_cfg = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    len = <span class="built_in">strlen</span>(mdss_mdp_panel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        rc = mdss_mdp_get_pan_cfg(pan_cfg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//+    qcom,dsi-pref-prim-pan = &lt;&amp;dsi_jd9161_fwvga_vid&gt;;</span></span><br><span class="line">    rc = mdss_mdp_parse_dt_pan_intf(pdev);</span><br><span class="line"></span><br><span class="line">    pan_cfg-&gt;init_done = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-4-2、mdss-mdp-register-sysfs-mdata"><a href="#1-4-2、mdss-mdp-register-sysfs-mdata" class="headerlink" title="1.4.2、mdss_mdp_register_sysfs(mdata)"></a>1.4.2、mdss_mdp_register_sysfs(mdata)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在mdp目录下，创建一个caps属性文件</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_mdp_register_sysfs</span><span class="params">(struct mdss_data_type *mdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = &amp;<span class="title">mdata</span>-&gt;<span class="title">pdev</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    rc = sysfs_create_group(&amp;dev-&gt;kobj, &amp;mdp_fs_attr_group);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-4-3、mdss-fb-register-mdp-instance-amp-mdp5"><a href="#1-4-3、mdss-fb-register-mdp-instance-amp-mdp5" class="headerlink" title="1.4.3、mdss_fb_register_mdp_instance(&amp;mdp5)"></a>1.4.3、mdss_fb_register_mdp_instance(&amp;mdp5)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">## 在mdss_fb_probe()的probe函数中</span><br><span class="line">#<span class="meta">#    mfd-&gt;mdp = *mdp_instance; <span class="comment">//将mdp_instance的所有内容拷贝一份给 mfd-&gt;mdp</span></span></span><br><span class="line">## 所以mfd-&gt;mdp等于mdp5，mdp_instance指向mdp5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msm_mdp_interface</span> <span class="title">mdp5</span> = &#123;</span></span><br><span class="line">    .init_fnc = mdss_mdp_overlay_init,</span><br><span class="line">    .fb_mem_get_iommu_domain = mdss_fb_mem_get_iommu_domain,</span><br><span class="line">    .fb_stride = mdss_mdp_fb_stride,</span><br><span class="line">    .check_dsi_status = mdss_check_dsi_ctrl_status,</span><br><span class="line">    .get_format_params = mdss_mdp_get_format_params,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mdss_fb_register_mdp_instance</span><span class="params">(struct msm_mdp_interface *mdp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mdp_instance = mdp;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-4-4、register-irq-amp-mdss-mdp-hw"><a href="#1-4-4、register-irq-amp-mdss-mdp-hw" class="headerlink" title="1.4.4、register_irq(&amp;mdss_mdp_hw)"></a>1.4.4、register_irq(&amp;mdss_mdp_hw)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rc = mdss_res-&gt;mdss_util-&gt;register_irq(&amp;mdss_mdp_hw);</span><br></pre></td></tr></table></figure>

<h5 id="1-4-5、mdss-smmu-init-mdata-amp-pdev-gt-dev"><a href="#1-4-5、mdss-smmu-init-mdata-amp-pdev-gt-dev" class="headerlink" title="1.4.5、mdss_smmu_init(mdata, &amp;pdev-&gt;dev)"></a>1.4.5、mdss_smmu_init(mdata, &amp;pdev-&gt;dev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mdss_smmu_init</span><span class="params">(struct mdss_data_type *mdata, struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mdss_smmu_device_create(dev);</span><br><span class="line">    mdss_smmu_ops_init(mdata);</span><br><span class="line">    mdata-&gt;mdss_util-&gt;iommu_lock = mdss_iommu_lock;</span><br><span class="line">    mdata-&gt;mdss_util-&gt;iommu_unlock = mdss_iommu_unlock;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于devicetree涉及太多字段，博主也没有完全搞明白每个字段的意义，只搞清楚一小部分，请参考：</p>
<blockquote>
<p>G:\android9.0\kernel\msm-3.18\Documentation\devicetree\bindings\fb\mdss-dsi.txt<br>G:\android9.0\kernel\msm-3.18\Documentation\devicetree\bindings\fb\mdss-mdp.txt<br>G:\android9.0\kernel\msm-3.18\Documentation\devicetree\bindings\fb\mdss-dsi-panel.txt</p>
</blockquote>
<h4 id="二-、DSI分析"><a href="#二-、DSI分析" class="headerlink" title="(二)、DSI分析"></a>(二)、DSI分析</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG2.dsi_probe.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------------</span><br><span class="line">        mdss_dsi0: qcom,mdss_dsi_ctrl0@<span class="number">994000</span> &#123;</span><br><span class="line">            compatible = <span class="string">&quot;qcom,mdss-dsi-ctrl&quot;</span>;</span><br><span class="line">            label = <span class="string">&quot;MDSS DSI CTRL-&gt;0&quot;</span>;</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">mdss_dsi_ctrl_dt_match</span>[] = &#123;</span></span><br><span class="line">    &#123;.compatible = <span class="string">&quot;qcom,mdss-dsi-ctrl&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, mdss_dsi_ctrl_dt_match);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_dsi_ctrl_driver</span> = &#123;</span></span><br><span class="line">    .probe = mdss_dsi_ctrl_probe,</span><br><span class="line">    .remove = mdss_dsi_ctrl_remove,</span><br><span class="line">    .shutdown = <span class="literal">NULL</span>,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;mdss_dsi_ctrl&quot;</span>,</span><br><span class="line">        .of_match_table = mdss_dsi_ctrl_dt_match,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_dsi_ctrl_register_driver</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;mdss_dsi_ctrl_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">mdss_dsi_ctrl_driver_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = mdss_dsi_ctrl_register_driver();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;mdss_dsi_ctrl_register_driver() failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">module_init(mdss_dsi_ctrl_driver_init);</span><br><span class="line"></span><br><span class="line">------------------  mdss-dsi  ------------------</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">mdss_dsi_dt_match</span>[] = &#123;</span></span><br><span class="line">    &#123;.compatible = <span class="string">&quot;qcom,mdss-dsi&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(of, mdss_dsi_dt_match);</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_dsi_driver</span> = &#123;</span></span><br><span class="line">    .probe = mdss_dsi_probe,</span><br><span class="line">    .remove = mdss_dsi_remove,</span><br><span class="line">    .shutdown = <span class="literal">NULL</span>,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;mdss_dsi&quot;</span>,</span><br><span class="line">        .of_match_table = mdss_dsi_dt_match,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_dsi_register_driver</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;mdss_dsi_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">mdss_dsi_driver_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = mdss_dsi_register_driver();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;mdss_dsi_register_driver() failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">module_init(mdss_dsi_driver_init);</span><br></pre></td></tr></table></figure>
<p>再看mdss_dsi_ctrl_probe(struct platform_device *pdev) 函数之前先看看mdss_dsi_probe(struct platform_device *pdev)<br>函数</p>
<h5 id="2-1、mdss-dsi-probe-struct-platform-device-pdev"><a href="#2-1、mdss-dsi-probe-struct-platform-device-pdev" class="headerlink" title="2.1、mdss_dsi_probe(struct platform_device *pdev)"></a>2.1、mdss_dsi_probe(struct platform_device *pdev)</h5><p>为关键驱动数据结构 struct mdss_dsi_ctrl_pdata *ctrl_pdata 分配空间</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_dsi_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_cfg</span> *<span class="title">pan_cfg</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_util_intf</span> *<span class="title">util</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *panel_cfg;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    util = mdss_get_util_intf();</span><br><span class="line"></span><br><span class="line">    pan_cfg = util-&gt;panel_intf_type(MDSS_PANEL_INTF_HDMI);</span><br><span class="line">    </span><br><span class="line">    pan_cfg = util-&gt;panel_intf_type(MDSS_PANEL_INTF_DSI);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_res_init(pdev);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_parse_hw_cfg(pdev, panel_cfg);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_pll_src_cfg(pdev, panel_cfg);</span><br><span class="line"></span><br><span class="line">    of_platform_populate(pdev-&gt;dev.of_node, mdss_dsi_ctrl_dt_match,</span><br><span class="line">                <span class="literal">NULL</span>, &amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_validate_config(pdev);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_config_clk_src(pdev);</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_dsi_res_init</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>, i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dsi_shared_data</span> *<span class="title">sdata</span>;</span></span><br><span class="line"></span><br><span class="line">    mdss_dsi_res = platform_get_drvdata(pdev);</span><br><span class="line">    <span class="keyword">if</span> (!mdss_dsi_res) &#123;</span><br><span class="line">        mdss_dsi_res = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line">                      <span class="keyword">sizeof</span>(struct mdss_dsi_data),</span><br><span class="line">                      GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">        mdss_dsi_res-&gt;shared_data = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line">                <span class="keyword">sizeof</span>(struct dsi_shared_data),</span><br><span class="line">                GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">        sdata = mdss_dsi_res-&gt;shared_data;</span><br><span class="line"></span><br><span class="line">        rc = mdss_dsi_parse_dt_params(pdev, sdata);</span><br><span class="line"></span><br><span class="line">        rc = mdss_dsi_core_clk_init(pdev, sdata);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Parse the regulator information */</span></span><br><span class="line">        <span class="keyword">for</span> (i = DSI_CORE_PM; i &lt; DSI_MAX_PM; i++) &#123;</span><br><span class="line">            rc = mdss_dsi_get_dt_vreg_data(&amp;pdev-&gt;dev,</span><br><span class="line">                pdev-&gt;dev.of_node, &amp;sdata-&gt;power_data[i], i);</span><br><span class="line">            <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">                i--;</span><br><span class="line">                <span class="keyword">for</span> (; i &gt;= DSI_CORE_PM; i--)</span><br><span class="line">                    mdss_dsi_put_dt_vreg_data(&amp;pdev-&gt;dev,</span><br><span class="line">                        &amp;sdata-&gt;power_data[i]);</span><br><span class="line">                <span class="keyword">goto</span> mem_fail;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rc = mdss_dsi_regulator_init(pdev, sdata);</span><br><span class="line"></span><br><span class="line">        rc = mdss_dsi_bus_scale_init(pdev, sdata);</span><br><span class="line"></span><br><span class="line">        mutex_init(&amp;sdata-&gt;phy_reg_lock);</span><br><span class="line">        mutex_init(&amp;sdata-&gt;pm_qos_lock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; DSI_CTRL_MAX; i++) &#123;</span><br><span class="line">            mdss_dsi_res-&gt;ctrl_pdata[i] = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line">                    <span class="keyword">sizeof</span>(struct mdss_dsi_ctrl_pdata),</span><br><span class="line">                    GFP_KERNEL);</span><br><span class="line">                </span><br><span class="line">                rc = -ENOMEM;</span><br><span class="line">                <span class="keyword">goto</span> mem_fail;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mdss_dsi_res-&gt;ctrl_pdata[i]-&gt;shared_data =</span><br><span class="line">                mdss_dsi_res-&gt;shared_data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        platform_set_drvdata(pdev, mdss_dsi_res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdss_dsi_res-&gt;pdev = pdev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mdss_dsi_ctrl_probe(struct platform_device *pdev) 函数</p>
<h5 id="2-2、mdss-dsi-ctrl-probe-struct-platform-device-pdev"><a href="#2-2、mdss-dsi-ctrl-probe-struct-platform-device-pdev" class="headerlink" title="2.2、mdss_dsi_ctrl_probe(struct platform_device *pdev)"></a>2.2、mdss_dsi_ctrl_probe(struct platform_device *pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_dsi_ctrl_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    u32 index;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_dsi_ctrl_pdata</span> *<span class="title">ctrl_pdata</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">pinfo</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">dsi_pan_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ctrl_name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_util_intf</span> *<span class="title">util</span>;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> te_irq_registered;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_cfg</span> *<span class="title">pan_cfg</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//cell-index = &lt;0&gt;;</span></span><br><span class="line">    rc = of_property_read_u32(pdev-&gt;dev.of_node,</span><br><span class="line">                  <span class="string">&quot;cell-index&quot;</span>, &amp;index);</span><br><span class="line"></span><br><span class="line">    ctrl_pdata = mdss_dsi_get_ctrl(index);</span><br><span class="line"></span><br><span class="line">    platform_set_drvdata(pdev, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    util = mdss_get_util_intf();</span><br><span class="line"></span><br><span class="line">    pan_cfg = util-&gt;panel_intf_type(MDSS_PANEL_INTF_SPI);</span><br><span class="line"></span><br><span class="line">    ctrl_pdata-&gt;mdss_util = util;</span><br><span class="line">    atomic_set(&amp;ctrl_pdata-&gt;te_irq_ready, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//label = &quot;MDSS DSI CTRL-&gt;0&quot;;</span></span><br><span class="line">    ctrl_name = of_get_property(pdev-&gt;dev.of_node, <span class="string">&quot;label&quot;</span>, <span class="literal">NULL</span>); </span><br><span class="line">    <span class="comment">//pin init</span></span><br><span class="line">    rc = mdss_dsi_pinctrl_init(pdev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">        ctrl_pdata-&gt;panel_data.panel_info.pdest = DISPLAY_1;</span><br><span class="line">        ctrl_pdata-&gt;ndx = DSI_CTRL_0;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctrl_pdata-&gt;panel_data.panel_info.pdest = DISPLAY_2;</span><br><span class="line">        ctrl_pdata-&gt;ndx = DSI_CTRL_1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mdss_dsi_ctrl_clock_init(pdev, ctrl_pdata)) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dsi_pan_node = mdss_dsi_config_panel(pdev, index);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mdss_dsi_is_hw_config_split(ctrl_pdata-&gt;shared_data) ||</span><br><span class="line">        (mdss_dsi_is_hw_config_split(ctrl_pdata-&gt;shared_data) &amp;&amp;</span><br><span class="line">        (ctrl_pdata-&gt;panel_data.panel_info.pdest == DISPLAY_1))) &#123;</span><br><span class="line">        rc = mdss_panel_parse_bl_settings(dsi_pan_node, ctrl_pdata);</span><br><span class="line">        <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">            ctrl_pdata-&gt;bklt_ctrl = UNKNOWN_CTRL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctrl_pdata-&gt;bklt_ctrl = UNKNOWN_CTRL;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-2-1、mdss-dsi-config-panel"><a href="#2-2-1、mdss-dsi-config-panel" class="headerlink" title="2.2.1、mdss_dsi_config_panel()"></a>2.2.1、mdss_dsi_config_panel()</h5><p>解释panel的dts，为ctrl_pdata-&gt;ctrl_pdata赋值，并挂接如下三个重要的函数<br>    ctrl_pdata-&gt;on = mdss_dsi_panel_on;<br>    ctrl_pdata-&gt;post_panel_on = mdss_dsi_post_panel_on;<br>    ctrl_pdata-&gt;off = mdss_dsi_panel_off;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct device_node *<span class="title">mdss_dsi_config_panel</span><span class="params">(struct platform_device *pdev,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> ndx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_dsi_ctrl_pdata</span> *<span class="title">ctrl_pdata</span> = <span class="title">platform_get_drvdata</span>(<span class="title">pdev</span>);</span></span><br><span class="line">    <span class="keyword">char</span> panel_cfg[MDSS_MAX_PANEL_LEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">dsi_pan_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DSI panels can be different between controllers */</span></span><br><span class="line">    rc = mdss_dsi_get_panel_cfg(panel_cfg, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* find panel device node */</span></span><br><span class="line">    dsi_pan_node = mdss_dsi_find_panel_of_node(pdev, panel_cfg);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_panel_init(dsi_pan_node, ctrl_pdata, ndx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dsi_pan_node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mdss_dsi_panel_init</span><span class="params">(struct device_node *node,</span></span></span><br><span class="line"><span class="function"><span class="params">    struct mdss_dsi_ctrl_pdata *ctrl_pdata,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> ndx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *panel_name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">pinfo</span>;</span></span><br><span class="line"></span><br><span class="line">    pinfo = &amp;ctrl_pdata-&gt;panel_data.panel_info;</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;panel_name[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    panel_name = of_get_property(node, <span class="string">&quot;qcom,mdss-dsi-panel-name&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    rc = mdss_panel_parse_dt(node, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;dynamic_switch_pending = <span class="literal">false</span>;</span><br><span class="line">    pinfo-&gt;is_lpm_mode = <span class="literal">false</span>;</span><br><span class="line">    pinfo-&gt;esd_rdy = <span class="literal">false</span>;</span><br><span class="line">    pinfo-&gt;persist_mode = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ctrl_pdata-&gt;on = mdss_dsi_panel_on;</span><br><span class="line">    ctrl_pdata-&gt;post_panel_on = mdss_dsi_post_panel_on;</span><br><span class="line">    ctrl_pdata-&gt;off = mdss_dsi_panel_off;</span><br><span class="line">    ctrl_pdata-&gt;low_power_config = mdss_dsi_panel_low_power_config;</span><br><span class="line">    ctrl_pdata-&gt;panel_data.set_backlight = mdss_dsi_panel_bl_ctrl;</span><br><span class="line">    ctrl_pdata-&gt;panel_data.apply_display_setting =</span><br><span class="line">            mdss_dsi_panel_apply_display_setting;</span><br><span class="line">    ctrl_pdata-&gt;switch_mode = mdss_dsi_panel_switch_mode;</span><br><span class="line">    ctrl_pdata-&gt;panel_data.get_idle = mdss_dsi_panel_get_idle_mode;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-2-1-1、mdss-panel-parse-dt-node-ctrl-pdata"><a href="#2-2-1-1、mdss-panel-parse-dt-node-ctrl-pdata" class="headerlink" title="2.2.1.1、mdss_panel_parse_dt(node, ctrl_pdata)"></a>2.2.1.1、mdss_panel_parse_dt(node, ctrl_pdata)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_dsi_panel.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_panel_parse_dt</span><span class="params">(struct device_node *np,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct mdss_dsi_ctrl_pdata *ctrl_pdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 tmp;</span><br><span class="line">    u8 lanes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *data;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *pdest;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">pinfo</span> = &amp;(<span class="title">ctrl_pdata</span>-&gt;<span class="title">panel_data</span>.<span class="title">panel_info</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mdss_dsi_is_hw_config_split(ctrl_pdata-&gt;shared_data))</span><br><span class="line">        pinfo-&gt;is_split_display = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-pan-physical-width-dimension&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;physical_width = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-pan-physical-height-dimension&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;physical_height = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-bpp&quot;</span>, &amp;tmp);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;bpp = (!rc ? tmp : <span class="number">24</span>);</span><br><span class="line">    pinfo-&gt;mipi.mode = DSI_VIDEO_MODE;</span><br><span class="line">    data = of_get_property(np, <span class="string">&quot;qcom,mdss-dsi-panel-type&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (data &amp;&amp; !<span class="built_in">strncmp</span>(data, <span class="string">&quot;dsi_cmd_mode&quot;</span>, <span class="number">12</span>))</span><br><span class="line">        pinfo-&gt;mipi.mode = DSI_CMD_MODE;</span><br><span class="line">    pinfo-&gt;mipi.boot_mode = pinfo-&gt;mipi.mode;</span><br><span class="line">    tmp = <span class="number">0</span>;</span><br><span class="line">    data = of_get_property(np, <span class="string">&quot;qcom,mdss-dsi-pixel-packing&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (data &amp;&amp; !<span class="built_in">strcmp</span>(data, <span class="string">&quot;loose&quot;</span>))</span><br><span class="line">        pinfo-&gt;mipi.pixel_packing = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pinfo-&gt;mipi.pixel_packing = <span class="number">0</span>;</span><br><span class="line">    rc = mdss_panel_get_dst_fmt(pinfo-&gt;bpp,</span><br><span class="line">        pinfo-&gt;mipi.mode, pinfo-&gt;mipi.pixel_packing,</span><br><span class="line">        &amp;(pinfo-&gt;mipi.dst_format));</span><br><span class="line"></span><br><span class="line">    pdest = of_get_property(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-panel-destination&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-underflow-color&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;lcdc.underflow_clr = (!rc ? tmp : <span class="number">0xff</span>);</span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-border-color&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;lcdc.border_clr = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line">    data = of_get_property(np, <span class="string">&quot;qcom,mdss-dsi-panel-orientation&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-brightness-max-level&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;brightness_max = (!rc ? tmp : MDSS_MAX_BL_BRIGHTNESS);</span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-bl-min-level&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;bl_min = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-bl-max-level&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;bl_max = (!rc ? tmp : <span class="number">255</span>);</span><br><span class="line">    ctrl_pdata-&gt;bklt_max = pinfo-&gt;bl_max;</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-interleave-mode&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.interleave_mode = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;mipi.vsync_enable = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-te-check-enable&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;sim_panel_mode == SIM_SW_TE_MODE)</span><br><span class="line">        pinfo-&gt;mipi.hw_vsync_mode = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pinfo-&gt;mipi.hw_vsync_mode = of_property_read_bool(np,</span><br><span class="line">            <span class="string">&quot;qcom,mdss-dsi-te-using-te-pin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-h-sync-pulse&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.pulse_mode_hsa_he = (!rc ? tmp : <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;mipi.hfp_power_stop = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-hfp-power-mode&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.hsa_power_stop = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-hsa-power-mode&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.hbp_power_stop = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-hbp-power-mode&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.last_line_interleave_en = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-last-line-interleave&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.bllp_power_stop = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-bllp-power-mode&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.eof_bllp_power_stop = of_property_read_bool(</span><br><span class="line">        np, <span class="string">&quot;qcom,mdss-dsi-bllp-eof-power-mode&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.traffic_mode = DSI_NON_BURST_SYNCH_PULSE;</span><br><span class="line">    data = of_get_property(np, <span class="string">&quot;qcom,mdss-dsi-traffic-mode&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;non_burst_sync_event&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.traffic_mode = DSI_NON_BURST_SYNCH_EVENT;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;burst_mode&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.traffic_mode = DSI_BURST_MODE;</span><br><span class="line">    &#125;</span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-te-dcs-command&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.insert_dcs_cmd =</span><br><span class="line">            (!rc ? tmp : <span class="number">1</span>);</span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-wr-mem-continue&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.wr_mem_continue =</span><br><span class="line">            (!rc ? tmp : <span class="number">0x3c</span>);</span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-wr-mem-start&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.wr_mem_start =</span><br><span class="line">            (!rc ? tmp : <span class="number">0x2c</span>);</span><br><span class="line">    rc = of_property_read_u32(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-te-pin-select&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.te_sel =</span><br><span class="line">            (!rc ? tmp : <span class="number">1</span>);</span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-virtual-channel-id&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.vc = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line">    pinfo-&gt;mipi.rgb_swap = DSI_RGB_SWAP_RGB;</span><br><span class="line">    data = of_get_property(np, <span class="string">&quot;qcom,mdss-dsi-color-order&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;rgb_swap_rbg&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.rgb_swap = DSI_RGB_SWAP_RBG;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;rgb_swap_bgr&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.rgb_swap = DSI_RGB_SWAP_BGR;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;rgb_swap_brg&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.rgb_swap = DSI_RGB_SWAP_BRG;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;rgb_swap_grb&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.rgb_swap = DSI_RGB_SWAP_GRB;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;rgb_swap_gbr&quot;</span>))</span><br><span class="line">            pinfo-&gt;mipi.rgb_swap = DSI_RGB_SWAP_GBR;</span><br><span class="line">    &#125;</span><br><span class="line">    pinfo-&gt;mipi.data_lane0 = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-lane-0-state&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.data_lane1 = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-lane-1-state&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.data_lane2 = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-lane-2-state&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.data_lane3 = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-lane-3-state&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;mipi.data_lane0)</span><br><span class="line">        lanes++;</span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;mipi.data_lane1)</span><br><span class="line">        lanes++;</span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;mipi.data_lane2)</span><br><span class="line">        lanes++;</span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;mipi.data_lane3)</span><br><span class="line">        lanes++;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * needed to set default lanes during</span></span><br><span class="line"><span class="comment">     * resolution switch for bridge chips</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pinfo-&gt;mipi.default_lanes = lanes;</span><br><span class="line"></span><br><span class="line">    rc = mdss_panel_parse_display_timings(np, &amp;ctrl_pdata-&gt;panel_data);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_parse_hdr_settings(np, pinfo);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;mipi.rx_eot_ignore = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-rx-eot-ignore&quot;</span>);</span><br><span class="line">    pinfo-&gt;mipi.tx_eot_append = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-tx-eot-append&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-stream&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.stream = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    data = of_get_property(np, <span class="string">&quot;qcom,mdss-dsi-panel-mode-gpio-state&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;high&quot;</span>))</span><br><span class="line">            pinfo-&gt;mode_gpio_state = MODE_GPIO_HIGH;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(data, <span class="string">&quot;low&quot;</span>))</span><br><span class="line">            pinfo-&gt;mode_gpio_state = MODE_GPIO_LOW;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pinfo-&gt;mode_gpio_state = MODE_GPIO_NOT_VALID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-mdp-transfer-time-us&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mdp_transfer_time_us = (!rc ? tmp : DEFAULT_MDP_TRANSFER_TIME);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;mipi.lp11_init = of_property_read_bool(np,</span><br><span class="line">                    <span class="string">&quot;qcom,mdss-dsi-lp11-init&quot;</span>);</span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-init-delay-us&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.init_delay = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-post-init-delay&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.post_init_delay = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_trigger(np, &amp;(pinfo-&gt;mipi.mdp_trigger),</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-mdp-trigger&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_trigger(np, &amp;(pinfo-&gt;mipi.dma_trigger),</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-dma-trigger&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_reset_seq(np, pinfo-&gt;rst_seq, &amp;(pinfo-&gt;rst_seq_len),</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-reset-sequence&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_dcs_cmds(np, &amp;ctrl_pdata-&gt;off_cmds,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-off-command&quot;</span>, <span class="string">&quot;qcom,mdss-dsi-off-command-state&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_dcs_cmds(np, &amp;ctrl_pdata-&gt;idle_on_cmds,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-idle-on-command&quot;</span>,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-idle-on-command-state&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_dcs_cmds(np, &amp;ctrl_pdata-&gt;idle_off_cmds,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-idle-off-command&quot;</span>,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-idle-off-command-state&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,mdss-dsi-idle-fps&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;mipi.frame_rate_idle = (!rc ? tmp : <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_u32(np, <span class="string">&quot;qcom,adjust-timer-wakeup-ms&quot;</span>, &amp;tmp);</span><br><span class="line">    pinfo-&gt;adjust_timer_delay_ms = (!rc ? tmp : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;mipi.force_clk_lane_hs = of_property_read_bool(np,</span><br><span class="line">        <span class="string">&quot;qcom,mdss-dsi-force-clock-lane-hs&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_parse_panel_features(np, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_panel_horizintal_line_idle(np, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_parse_dfps_config(np, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    rc = mdss_panel_parse_dt_hdmi(np, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">        解释如下项：</span><br><span class="line">----------start---------    </span><br><span class="line"></span><br><span class="line">        qcom,mdss-dsi-panel-width = &lt;<span class="number">480</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-panel-height = &lt;<span class="number">854</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-h-front-porch = &lt;<span class="number">10</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-h-back-porch = &lt;<span class="number">10</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-h-pulse-width = &lt;<span class="number">10</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-h-sync-skew = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-v-back-porch = &lt;<span class="number">6</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-v-front-porch = &lt;<span class="number">6</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-v-pulse-width = &lt;<span class="number">4</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-h-left-border = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-h-right-border = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-v-top-border = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-v-bottom-border = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-bpp = &lt;<span class="number">24</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-color-order = <span class="string">&quot;rgb_swap_rgb&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-underflow-color = &lt;<span class="number">0xff</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-border-color = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-on-command = [</span><br><span class="line">            ......</span><br><span class="line">            ];</span><br><span class="line">        qcom,mdss-dsi-off-command = [</span><br><span class="line">            <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">32</span> <span class="number">00</span> <span class="number">01</span></span><br><span class="line">                <span class="number">28</span></span><br><span class="line">            <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">78</span> <span class="number">00</span> <span class="number">01</span></span><br><span class="line">                <span class="number">10</span></span><br><span class="line">            ];</span><br><span class="line">        qcom,mdss-dsi-on-command-state = <span class="string">&quot;dsi_lp_mode&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-off-command-state = <span class="string">&quot;dsi_hs_mode&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-h-sync-pulse = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-traffic-mode = <span class="string">&quot;non_burst_sync_event&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-bllp-eof-power-mode;</span><br><span class="line">        qcom,mdss-dsi-bllp-power-mode;</span><br><span class="line">        qcom,mdss-dsi-lane<span class="number">-0</span>-state;</span><br><span class="line">        qcom,mdss-dsi-lane<span class="number">-1</span>-state;</span><br><span class="line">        qcom,mdss-dsi-panel-timings =</span><br><span class="line">                                       [<span class="number">66</span> <span class="number">14</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">34</span> <span class="number">38</span> <span class="number">10</span> <span class="number">18</span> <span class="number">0</span>E <span class="number">03</span> <span class="number">04</span> <span class="number">00</span>];</span><br><span class="line">        qcom,mdss-dsi-t-clk-post = &lt;<span class="number">0x04</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-t-clk-pre = &lt;<span class="number">0x1D</span>&gt;;</span><br><span class="line">        qcom,mdss-dsi-dma-trigger = <span class="string">&quot;trigger_sw&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-mdp-trigger = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-reset-sequence = &lt;<span class="number">1</span> <span class="number">20</span>&gt;, &lt;<span class="number">0</span> <span class="number">2</span>&gt;, &lt;<span class="number">1</span> <span class="number">20</span>&gt;;</span><br><span class="line">----------end---------    </span><br></pre></td></tr></table></figure>


<h5 id="2-2-2、dsi-panel-device-register-pdev-dsi-pan-node-ctrl-pdata"><a href="#2-2-2、dsi-panel-device-register-pdev-dsi-pan-node-ctrl-pdata" class="headerlink" title="2.2.2、dsi_panel_device_register(pdev, dsi_pan_node, ctrl_pdata)"></a>2.2.2、dsi_panel_device_register(pdev, dsi_pan_node, ctrl_pdata)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dsi_panel_device_register</span><span class="params">(struct platform_device *ctrl_pdev,</span></span></span><br><span class="line"><span class="function"><span class="params">    struct device_node *pan_node, struct mdss_dsi_ctrl_pdata *ctrl_pdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mipi_panel_info</span> *<span class="title">mipi</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dsi_shared_data</span> *<span class="title">sdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">pinfo</span> = &amp;(<span class="title">ctrl_pdata</span>-&gt;<span class="title">panel_data</span>.<span class="title">panel_info</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line">    u64 clk_rate;</span><br><span class="line"></span><br><span class="line">    mipi  = &amp;(pinfo-&gt;mipi);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_clk_div_config(pinfo, mipi-&gt;frame_rate);</span><br><span class="line"></span><br><span class="line">    ctrl_pdata-&gt;pclk_rate = mipi-&gt;dsi_pclk_rate;</span><br><span class="line">    clk_rate = pinfo-&gt;clk_rate;</span><br><span class="line">    do_div(clk_rate, <span class="number">8U</span>);</span><br><span class="line">    ctrl_pdata-&gt;byte_clk_rate = (u32)clk_rate;</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_get_dt_vreg_data(&amp;ctrl_pdev-&gt;dev, pan_node,</span><br><span class="line">        &amp;ctrl_pdata-&gt;panel_power_data, DSI_PANEL_PM);</span><br><span class="line"></span><br><span class="line">    rc = msm_dss_config_vreg(&amp;ctrl_pdev-&gt;dev,</span><br><span class="line">        ctrl_pdata-&gt;panel_power_data.vreg_config,</span><br><span class="line">        ctrl_pdata-&gt;panel_power_data.num_vreg, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_parse_ctrl_params(ctrl_pdev, pan_node, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;panel_max_fps = mdss_panel_get_framerate(pinfo,</span><br><span class="line">                FPS_RESOLUTION_HZ);</span><br><span class="line">    pinfo-&gt;panel_max_vtotal = mdss_panel_get_vtotal(pinfo);</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_parse_gpio_params(ctrl_pdev, ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mdss_dsi_retrieve_ctrl_resources(ctrl_pdev,</span><br><span class="line">                         pinfo-&gt;pdest,</span><br><span class="line">                         ctrl_pdata)) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctrl_pdata-&gt;panel_data.event_handler = mdss_dsi_event_handler;</span><br><span class="line">    ctrl_pdata-&gt;panel_data.get_fb_node = mdss_dsi_get_fb_node_cb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctrl_pdata-&gt;status_mode == ESD_REG ||</span><br><span class="line">            ctrl_pdata-&gt;status_mode == ESD_REG_NT35596)</span><br><span class="line">        ctrl_pdata-&gt;check_status = mdss_dsi_reg_status_check;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl_pdata-&gt;status_mode == ESD_BTA)</span><br><span class="line">        ctrl_pdata-&gt;check_status = mdss_dsi_bta_status_check;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctrl_pdata-&gt;status_mode == ESD_MAX) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: Using default BTA for ESD check\n&quot;</span>, __func__);</span><br><span class="line">        ctrl_pdata-&gt;check_status = mdss_dsi_bta_status_check;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ctrl_pdata-&gt;bklt_ctrl == BL_PWM)</span><br><span class="line">        mdss_dsi_panel_pwm_cfg(ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    mdss_dsi_ctrl_init(&amp;ctrl_pdev-&gt;dev, ctrl_pdata);</span><br><span class="line">    mdss_dsi_set_prim_panel(ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    ctrl_pdata-&gt;dsi_irq_line = of_property_read_bool(</span><br><span class="line">                ctrl_pdev-&gt;dev.of_node, <span class="string">&quot;qcom,dsi-irq-line&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctrl_pdata-&gt;dsi_irq_line) &#123;</span><br><span class="line">        <span class="comment">/* DSI has it&#x27;s own irq line */</span></span><br><span class="line">        res = platform_get_resource(ctrl_pdev, IORESOURCE_IRQ, <span class="number">0</span>);</span><br><span class="line">        rc = mdss_dsi_irq_init(&amp;ctrl_pdev-&gt;dev, res-&gt;start, ctrl_pdata);</span><br><span class="line">    &#125;</span><br><span class="line">    ctrl_pdata-&gt;ctrl_state = CTRL_STATE_UNKNOWN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If ULPS during suspend is enabled, add an extra vote for the</span></span><br><span class="line"><span class="comment">     * DSI CTRL power module. This keeps the regulator always enabled.</span></span><br><span class="line"><span class="comment">     * This is needed for the DSI PHY to maintain ULPS state during</span></span><br><span class="line"><span class="comment">     * suspend also.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    sdata = ctrl_pdata-&gt;shared_data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;ulps_suspend_enabled) &#123;</span><br><span class="line">        rc = msm_dss_enable_vreg(</span><br><span class="line">            sdata-&gt;power_data[DSI_PHY_PM].vreg_config,</span><br><span class="line">            sdata-&gt;power_data[DSI_PHY_PM].num_vreg, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">            <span class="keyword">return</span> rc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pinfo-&gt;cont_splash_enabled =</span><br><span class="line">        ctrl_pdata-&gt;mdss_util-&gt;panel_intf_status(pinfo-&gt;pdest,</span><br><span class="line">        MDSS_PANEL_INTF_DSI) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    rc = mdss_register_panel(ctrl_pdev, &amp;(ctrl_pdata-&gt;panel_data));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pinfo-&gt;pdest == DISPLAY_1) &#123;</span><br><span class="line">        mdss_debug_register_io(<span class="string">&quot;dsi0_ctrl&quot;</span>, &amp;ctrl_pdata-&gt;ctrl_io, <span class="literal">NULL</span>);</span><br><span class="line">        mdss_debug_register_io(<span class="string">&quot;dsi0_phy&quot;</span>, &amp;ctrl_pdata-&gt;phy_io, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ctrl_pdata-&gt;phy_regulator_io.len)</span><br><span class="line">            mdss_debug_register_io(<span class="string">&quot;dsi0_phy_regulator&quot;</span>,</span><br><span class="line">                &amp;ctrl_pdata-&gt;phy_regulator_io, <span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mdss_debug_register_io(<span class="string">&quot;dsi1_ctrl&quot;</span>, &amp;ctrl_pdata-&gt;ctrl_io, <span class="literal">NULL</span>);</span><br><span class="line">        mdss_debug_register_io(<span class="string">&quot;dsi1_phy&quot;</span>, &amp;ctrl_pdata-&gt;phy_io, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ctrl_pdata-&gt;phy_regulator_io.len)</span><br><span class="line">            mdss_debug_register_io(<span class="string">&quot;dsi1_phy_regulator&quot;</span>,</span><br><span class="line">                &amp;ctrl_pdata-&gt;phy_regulator_io, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-2-1、mdss-register-panel-ctrl-pdev-amp-ctrl-pdata-gt-panel-data"><a href="#2-2-2-1、mdss-register-panel-ctrl-pdev-amp-ctrl-pdata-gt-panel-data" class="headerlink" title="2.2.2.1、mdss_register_panel(ctrl_pdev, &amp;(ctrl_pdata-&gt;panel_data))"></a>2.2.2.1、mdss_register_panel(ctrl_pdev, &amp;(ctrl_pdata-&gt;panel_data))</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mdss_register_panel</span><span class="params">(struct platform_device *pdev,</span></span></span><br><span class="line"><span class="function"><span class="params">    struct mdss_panel_data *pdata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">fb_pdev</span>, *<span class="title">mdss_pdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> master_panel = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pdata-&gt;get_fb_node)</span><br><span class="line">        node = pdata-&gt;get_fb_node(pdev);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mdss_pdev = of_find_device_by_node(node-&gt;parent);</span><br><span class="line"></span><br><span class="line">    pdata-&gt;active = <span class="literal">true</span>;</span><br><span class="line">    fb_pdev = of_find_device_by_node(node); <span class="comment">//mdss_mdp: qcom,mdss_mdp@900000</span></span><br><span class="line">    <span class="keyword">if</span> (fb_pdev) &#123;</span><br><span class="line">        rc = mdss_fb_register_extra_panel(fb_pdev, pdata); <span class="comment">//如果是双屏，这个是第二块屏使用</span></span><br><span class="line">        <span class="keyword">if</span> (rc == <span class="number">0</span>)</span><br><span class="line">            master_panel = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pr_info(<span class="string">&quot;adding framebuffer device %s\n&quot;</span>, dev_name(&amp;pdev-&gt;dev));</span><br><span class="line">        <span class="comment">//注册qcom,mdss_fb_primary设备，设备注册完成后将与驱动的match,match后调用 mdss_fb_probe(),这个将在fb分析</span></span><br><span class="line">        fb_pdev = of_platform_device_create(node, <span class="literal">NULL</span>,</span><br><span class="line">                &amp;mdss_pdev-&gt;dev);</span><br><span class="line">        <span class="keyword">if</span> (fb_pdev)</span><br><span class="line">            fb_pdev-&gt;dev.platform_data = pdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (master_panel &amp;&amp; mdp_instance-&gt;panel_register_done)</span><br><span class="line">        mdp_instance-&gt;panel_register_done(pdata);</span><br><span class="line"></span><br><span class="line">mdss_notfound:</span><br><span class="line">    of_node_put(node);</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="三-、FrameBuffer分析"><a href="#三-、FrameBuffer分析" class="headerlink" title="(三)、FrameBuffer分析"></a>(三)、FrameBuffer分析</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG2.fb_probe.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">=======================================================================================</span><br><span class="line">【 fbmem.c (kernel\drivers\video) 】</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __init  fbmem_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">1.1</span>、在/proc/下创建fb节点</span><br><span class="line">    proc_create(<span class="string">&quot;fb&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;fb_proc_fops);</span><br><span class="line">    <span class="number">1.2</span>、创建字符设备fb</span><br><span class="line">    <span class="comment">//#define FB_MAJOR      29   /* /dev/fb* framebuffers */  android下在/dev/graphics/fb*</span></span><br><span class="line">    register_chrdev(FB_MAJOR,<span class="string">&quot;fb&quot;</span>,&amp;fb_fops) <span class="comment">//file_operations----|</span></span><br><span class="line">    <span class="number">1.3</span>、在/sys/<span class="class"><span class="keyword">class</span>/目录下创建<span class="title">graphics</span>                           |</span></span><br><span class="line"><span class="class">    <span class="title">fb_class</span> = <span class="title">class_create</span>(<span class="title">THIS_MODULE</span>, &quot;<span class="title">graphics</span>&quot;);</span>            |</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;                                                    |</span><br><span class="line">&#125;                                                                |</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">fb_fops</span> = &#123;</span>  &lt;---------------|</span><br><span class="line">    .owner =    THIS_MODULE,</span><br><span class="line">    .read =     fb_read,</span><br><span class="line">    .write =    fb_write,</span><br><span class="line">    .unlocked_ioctl = fb_ioctl,</span><br><span class="line">    .mmap =     fb_mmap,</span><br><span class="line">    .open =     fb_open,</span><br><span class="line">    .release =  fb_release,</span><br><span class="line">    .llseek =   default_llseek,</span><br><span class="line">&#125;;</span><br><span class="line">---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>接下来看看mdss_fb_probe(struct platform_device *pdev) 函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_fb.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">mdss_fb_dt_match</span>[] = &#123;</span></span><br><span class="line">    &#123; .compatible = <span class="string">&quot;qcom,mdss-fb&quot;</span>,&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_COMPAT(<span class="string">&quot;qcom,mdss-fb&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_fb_driver</span> = &#123;</span></span><br><span class="line">    .probe = mdss_fb_probe,</span><br><span class="line">    .remove = mdss_fb_remove,</span><br><span class="line">    .suspend = mdss_fb_suspend,</span><br><span class="line">    .resume = mdss_fb_resume,</span><br><span class="line">    .shutdown = mdss_fb_shutdown,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;mdss_fb&quot;</span>,</span><br><span class="line">        .of_match_table = mdss_fb_dt_match,</span><br><span class="line">        .pm = &amp;mdss_fb_pm_ops,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msm_fb_data_type</span> *<span class="title">mfd</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *data;</span><br><span class="line">    </span><br><span class="line">    pdata = dev_get_platdata(&amp;pdev-&gt;dev);</span><br><span class="line">    <span class="comment">//为关键结构体struct msm_fb_data_type *mfd和 struct fb_info *fbi 分配空间</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * alloc framebuffer info + par data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fbi = framebuffer_alloc(<span class="keyword">sizeof</span>(struct msm_fb_data_type), <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (fbi == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;can&#x27;t allocate framebuffer info data!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//为mfd的部分成员赋初值</span></span><br><span class="line">    </span><br><span class="line">    mfd = (struct msm_fb_data_type *)fbi-&gt;par;</span><br><span class="line">    mfd-&gt;key = MFD_KEY;</span><br><span class="line">    mfd-&gt;fbi = fbi;</span><br><span class="line">    mfd-&gt;panel_info = &amp;pdata-&gt;panel_info;</span><br><span class="line">    mfd-&gt;panel.type = pdata-&gt;panel_info.type;</span><br><span class="line">    mfd-&gt;panel.id = mfd-&gt;index;</span><br><span class="line">    mfd-&gt;fb_page = MDSS_FB_NUM;</span><br><span class="line">    mfd-&gt;index = fbi_list_index;</span><br><span class="line">    mfd-&gt;mdp_fb_page_protection = MDP_FB_PAGE_PROTECTION_WRITECOMBINE;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;ext_ad_ctrl = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (mfd-&gt;panel_info &amp;&amp; mfd-&gt;panel_info-&gt;brightness_max &gt; <span class="number">0</span>)</span><br><span class="line">        MDSS_BRIGHT_TO_BL(mfd-&gt;bl_level, backlight_led.brightness,</span><br><span class="line">        mfd-&gt;panel_info-&gt;bl_max, mfd-&gt;panel_info-&gt;brightness_max);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        mfd-&gt;bl_level = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;bl_scale = <span class="number">1024</span>;</span><br><span class="line">    mfd-&gt;bl_min_lvl = <span class="number">30</span>;</span><br><span class="line">    mfd-&gt;ad_bl_level = <span class="number">0</span>;</span><br><span class="line">    mfd-&gt;fb_imgType = MDP_RGBA_8888;</span><br><span class="line">    mfd-&gt;calib_mode_bl = <span class="number">0</span>;</span><br><span class="line">    mfd-&gt;unset_bl_level = U32_MAX;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;pdev = pdev;</span><br><span class="line">    ......</span><br><span class="line">    mfd-&gt;split_fb_left = mfd-&gt;split_fb_right = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    mdss_fb_set_split_mode(mfd, pdata);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// mdp的接口函数拷贝一份到mfd-&gt;mdp</span></span><br><span class="line">    mfd-&gt;mdp = *mdp_instance;</span><br><span class="line"></span><br><span class="line">    rc = of_property_read_bool(pdev-&gt;dev.of_node,</span><br><span class="line">        <span class="string">&quot;qcom,boot-indication-enabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        led_trigger_register_simple(<span class="string">&quot;boot-indication&quot;</span>,</span><br><span class="line">            &amp;(mfd-&gt;boot_notification_led));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    INIT_LIST_HEAD(&amp;mfd-&gt;file_list);</span><br><span class="line"></span><br><span class="line">    mutex_init(&amp;mfd-&gt;bl_lock);</span><br><span class="line">    mutex_init(&amp;mfd-&gt;mdss_sysfs_lock);</span><br><span class="line">    mutex_init(&amp;mfd-&gt;switch_lock);</span><br><span class="line"></span><br><span class="line">    fbi_list[fbi_list_index++] = fbi;</span><br><span class="line"></span><br><span class="line">    platform_set_drvdata(pdev, mfd);</span><br><span class="line"></span><br><span class="line">    rc = mdss_fb_register(mfd);</span><br><span class="line"></span><br><span class="line">    mdss_fb_create_sysfs(mfd);</span><br><span class="line">    mdss_fb_send_panel_event(mfd, MDSS_EVENT_FB_REGISTERED, fbi);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//mdss_mdp_overlay_init(),初始化mfd-&gt;mdp结构体的成员</span></span><br><span class="line">    <span class="keyword">if</span> (mfd-&gt;mdp.init_fnc) &#123;</span><br><span class="line">        rc = mfd-&gt;mdp.init_fnc(mfd);</span><br><span class="line">        <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">            pr_err(<span class="string">&quot;init_fnc failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> rc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mdss_fb_init_fps_info(mfd);</span><br><span class="line"></span><br><span class="line">    rc = pm_runtime_set_active(mfd-&gt;fbi-&gt;dev);</span><br><span class="line"></span><br><span class="line">    pm_runtime_enable(mfd-&gt;fbi-&gt;dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* android supports only one lcd-backlight/lcd for now */</span></span><br><span class="line">    <span class="keyword">if</span> (!lcd_backlight_registered) &#123;</span><br><span class="line">        backlight_led.brightness = mfd-&gt;panel_info-&gt;brightness_max;</span><br><span class="line">        backlight_led.max_brightness = mfd-&gt;panel_info-&gt;brightness_max;</span><br><span class="line">        <span class="keyword">if</span> (led_classdev_register(&amp;pdev-&gt;dev, &amp;backlight_led))</span><br><span class="line">            pr_err(<span class="string">&quot;led_classdev_register failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            lcd_backlight_registered = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdss_fb_init_panel_modes(mfd, pdata);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="3-1、mdss-fb-register-mfd"><a href="#3-1、mdss-fb-register-mfd" class="headerlink" title="3.1、mdss_fb_register(mfd)"></a>3.1、mdss_fb_register(mfd)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_register</span><span class="params">(struct msm_fb_data_type *mfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -ENODEV;</span><br><span class="line">    <span class="keyword">int</span> bpp;</span><br><span class="line">    <span class="keyword">char</span> panel_name[<span class="number">20</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">panel_info</span> = <span class="title">mfd</span>-&gt;<span class="title">panel_info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span> = <span class="title">mfd</span>-&gt;<span class="title">fbi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> *<span class="title">fix</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> *<span class="title">var</span>;</span></span><br><span class="line">    <span class="keyword">int</span> *id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * fb info initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fix = &amp;fbi-&gt;fix;</span><br><span class="line">    var = &amp;fbi-&gt;var;</span><br><span class="line"></span><br><span class="line">    fix-&gt;type_aux = <span class="number">0</span>;    <span class="comment">/* if type == FB_TYPE_INTERLEAVED_PLANES */</span></span><br><span class="line">    fix-&gt;visual = FB_VISUAL_TRUECOLOR;    <span class="comment">/* True Color */</span></span><br><span class="line">    fix-&gt;ywrapstep = <span class="number">0</span>;    <span class="comment">/* No support */</span></span><br><span class="line">    fix-&gt;mmio_start = <span class="number">0</span>;    <span class="comment">/* No MMIO Address */</span></span><br><span class="line">    fix-&gt;mmio_len = <span class="number">0</span>;    <span class="comment">/* No MMIO Address */</span></span><br><span class="line">    fix-&gt;accel = FB_ACCEL_NONE;<span class="comment">/* FB_ACCEL_MSM needes to be added in fb.h */</span></span><br><span class="line"></span><br><span class="line">    var-&gt;xoffset = <span class="number">0</span>,    <span class="comment">/* Offset from virtual to visible */</span></span><br><span class="line">    var-&gt;yoffset = <span class="number">0</span>,    <span class="comment">/* resolution */</span></span><br><span class="line">    var-&gt;grayscale = <span class="number">0</span>,    <span class="comment">/* No graylevels */</span></span><br><span class="line">    var-&gt;nonstd = <span class="number">0</span>,    <span class="comment">/* standard pixel format */</span></span><br><span class="line">    var-&gt;activate = FB_ACTIVATE_VBL,    <span class="comment">/* activate it at vsync */</span></span><br><span class="line">    var-&gt;height = <span class="number">-1</span>,    <span class="comment">/* height of picture in mm */</span></span><br><span class="line">    var-&gt;width = <span class="number">-1</span>,    <span class="comment">/* width of picture in mm */</span></span><br><span class="line">    var-&gt;accel_flags = <span class="number">0</span>,    <span class="comment">/* acceleration flags */</span></span><br><span class="line">    var-&gt;sync = <span class="number">0</span>,    <span class="comment">/* see FB_SYNC_* */</span></span><br><span class="line">    var-&gt;rotate = <span class="number">0</span>,    <span class="comment">/* angle we rotate counter clockwise */</span></span><br><span class="line">    mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (mfd-&gt;fb_imgType) &#123;</span><br><span class="line">    <span class="keyword">case</span> MDP_RGB_565:</span><br><span class="line">        fix-&gt;type = FB_TYPE_PACKED_PIXELS;</span><br><span class="line">        fix-&gt;xpanstep = <span class="number">1</span>;</span><br><span class="line">        fix-&gt;ypanstep = <span class="number">1</span>;</span><br><span class="line">        var-&gt;vmode = FB_VMODE_NONINTERLACED;</span><br><span class="line">        var-&gt;blue.offset = <span class="number">0</span>;</span><br><span class="line">        var-&gt;green.offset = <span class="number">5</span>;</span><br><span class="line">        var-&gt;red.offset = <span class="number">11</span>;</span><br><span class="line">        var-&gt;blue.length = <span class="number">5</span>;</span><br><span class="line">        var-&gt;green.length = <span class="number">6</span>;</span><br><span class="line">        var-&gt;red.length = <span class="number">5</span>;</span><br><span class="line">        var-&gt;blue.msb_right = <span class="number">0</span>;</span><br><span class="line">        var-&gt;green.msb_right = <span class="number">0</span>;</span><br><span class="line">        var-&gt;red.msb_right = <span class="number">0</span>;</span><br><span class="line">        var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">        var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">        bpp = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        pr_err(<span class="string">&quot;msm_fb_init: fb %d unkown image type!\n&quot;</span>,</span><br><span class="line">                mfd-&gt;index);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdss_panelinfo_to_fb_var(panel_info, var);</span><br><span class="line"></span><br><span class="line">    fix-&gt;type = panel_info-&gt;is_3d_panel;</span><br><span class="line">    <span class="keyword">if</span> (mfd-&gt;mdp.fb_stride)</span><br><span class="line">        fix-&gt;line_length = mfd-&gt;mdp.fb_stride(mfd-&gt;index, var-&gt;xres,</span><br><span class="line">                            bpp);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fix-&gt;line_length = var-&gt;xres * bpp;</span><br><span class="line"></span><br><span class="line">    var-&gt;xres_virtual = var-&gt;xres;</span><br><span class="line">    var-&gt;yres_virtual = panel_info-&gt;yres * mfd-&gt;fb_page;</span><br><span class="line">    var-&gt;bits_per_pixel = bpp * <span class="number">8</span>;    <span class="comment">/* FrameBuffer color depth */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Populate smem length here for uspace to get the</span></span><br><span class="line"><span class="comment">     * Framebuffer size when FBIO_FSCREENINFO ioctl is called.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fix-&gt;smem_len = PAGE_ALIGN(fix-&gt;line_length * var-&gt;yres) * mfd-&gt;fb_page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* id field for fb app  */</span></span><br><span class="line">    id = (<span class="keyword">int</span> *)&amp;mfd-&gt;panel;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(fix-&gt;id, <span class="keyword">sizeof</span>(fix-&gt;id), <span class="string">&quot;mdssfb_%x&quot;</span>, (u32) *id);</span><br><span class="line"></span><br><span class="line">    fbi-&gt;fbops = &amp;mdss_fb_ops;</span><br><span class="line"></span><br><span class="line">|--------------------------------------------------------------|</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> <span class="title">mdss_fb_ops</span> = &#123;</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .fb_open = mdss_fb_open,</span><br><span class="line">    .fb_release = mdss_fb_release,</span><br><span class="line">    .fb_check_var = mdss_fb_check_var,    <span class="comment">/* vinfo check */</span></span><br><span class="line">    .fb_set_par = mdss_fb_set_par,    <span class="comment">/* set the video mode */</span></span><br><span class="line">    .fb_blank = mdss_fb_blank,    <span class="comment">/* blank display */</span></span><br><span class="line">    .fb_pan_display = mdss_fb_pan_display,    <span class="comment">/* pan display */</span></span><br><span class="line">    .fb_ioctl_v2 = mdss_fb_ioctl,    <span class="comment">/* perform fb specific ioctl */</span></span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .fb_compat_ioctl_v2 = mdss_fb_compat_ioctl,</span><br><span class="line">#endif</span><br><span class="line">    .fb_mmap = mdss_fb_mmap,</span><br><span class="line">&#125;;</span><br><span class="line">|-------------------------------------------------------------|</span><br><span class="line"></span><br><span class="line">    fbi-&gt;flags = FBINFO_FLAG_DEFAULT;</span><br><span class="line">    fbi-&gt;pseudo_palette = mdss_fb_pseudo_palette;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;ref_cnt = <span class="number">0</span>;</span><br><span class="line">    mfd-&gt;panel_power_state = MDSS_PANEL_POWER_OFF;</span><br><span class="line">    mfd-&gt;dcm_state = DCM_UNINIT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//为fb设备准备空间</span></span><br><span class="line">    <span class="keyword">if</span> (mdss_fb_alloc_fbmem(mfd))</span><br><span class="line">        pr_warn(<span class="string">&quot;unable to allocate fb memory in fb register\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mfd-&gt;op_enable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    mutex_init(&amp;mfd-&gt;update.lock);</span><br><span class="line">    mutex_init(&amp;mfd-&gt;no_update.lock);</span><br><span class="line">    mutex_init(&amp;mfd-&gt;mdp_sync_pt_data.sync_mutex);</span><br><span class="line">    atomic_set(&amp;mfd-&gt;mdp_sync_pt_data.commit_cnt, <span class="number">0</span>);</span><br><span class="line">    atomic_set(&amp;mfd-&gt;commits_pending, <span class="number">0</span>);</span><br><span class="line">    atomic_set(&amp;mfd-&gt;ioctl_ref_cnt, <span class="number">0</span>);</span><br><span class="line">    atomic_set(&amp;mfd-&gt;kickoff_pending, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    init_timer(&amp;mfd-&gt;no_update.timer);</span><br><span class="line">    mfd-&gt;no_update.timer.function = mdss_fb_no_update_notify_timer_cb;</span><br><span class="line">    mfd-&gt;no_update.timer.data = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mfd;</span><br><span class="line">    mfd-&gt;update.ref_count = <span class="number">0</span>;</span><br><span class="line">    mfd-&gt;no_update.ref_count = <span class="number">0</span>;</span><br><span class="line">    mfd-&gt;update.init_done = <span class="literal">false</span>;</span><br><span class="line">    init_completion(&amp;mfd-&gt;update.comp);</span><br><span class="line">    init_completion(&amp;mfd-&gt;no_update.comp);</span><br><span class="line">    init_completion(&amp;mfd-&gt;power_off_comp);</span><br><span class="line">    init_completion(&amp;mfd-&gt;power_set_comp);</span><br><span class="line">    init_waitqueue_head(&amp;mfd-&gt;commit_wait_q);</span><br><span class="line">    init_waitqueue_head(&amp;mfd-&gt;idle_wait_q);</span><br><span class="line">    init_waitqueue_head(&amp;mfd-&gt;ioctl_q);</span><br><span class="line">    init_waitqueue_head(&amp;mfd-&gt;kickoff_wait_q);</span><br><span class="line"></span><br><span class="line">    ret = fb_alloc_cmap(&amp;fbi-&gt;cmap, <span class="number">256</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (register_framebuffer(fbi) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        fb_dealloc_cmap(&amp;fbi-&gt;cmap);</span><br><span class="line"></span><br><span class="line">        mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(panel_name, ARRAY_SIZE(panel_name), <span class="string">&quot;mdss_panel_fb%d&quot;</span>,</span><br><span class="line">        mfd-&gt;index);</span><br><span class="line">    mdss_panel_debugfs_init(panel_info, panel_name);</span><br><span class="line">    <span class="comment">//log:mdss_fb_register [ : FrameBuffer[1] 640x480 registered successfully!</span></span><br><span class="line">    pr_info(<span class="string">&quot;FrameBuffer[%d] %dx%d registered successfully!\n&quot;</span>, mfd-&gt;index,</span><br><span class="line">                    fbi-&gt;var.xres, fbi-&gt;var.yres);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mdss_fb_register(mfd);  //关键函数<br>        1、为fbi的fix和var成员赋值<br>        2、为fb0分配空间          //mdss_fb_alloc_fbmem(mfd)<br>        3、初始化fbi-&gt;cmap        //fb_alloc_cmap(&amp;fbi-&gt;cmap, 256, 0);<br>        4、register_framebuffer(fbi) //注册fbi，在/sys/class/graphics/目录下创建fb0，并创建相关属性</p>
</blockquote>
<h5 id="3-2、mdss-mdp-overlay-init-struct-msm-fb-data-type-mfd"><a href="#3-2、mdss-mdp-overlay-init-struct-msm-fb-data-type-mfd" class="headerlink" title="3.2、mdss_mdp_overlay_init(struct msm_fb_data_type *mfd)"></a>3.2、mdss_mdp_overlay_init(struct msm_fb_data_type *mfd)</h5><blockquote>
<p>mfd-&gt;mdp的接口函数<br>在mdss_fb_probe()的probe函数中<br>    mfd-&gt;mdp = *mdp_instance; //将mdp_instance的所有内容拷贝一份给 mfd-&gt;mdp<br>所以mfd-&gt;mdp等于mdp5，mdp_instance指向mdp5   </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_mdp.c</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msm_mdp_interface</span> <span class="title">mdp5</span> = &#123;</span></span><br><span class="line">    .init_fnc = mdss_mdp_overlay_init,</span><br><span class="line">    .fb_mem_get_iommu_domain = mdss_fb_mem_get_iommu_domain,</span><br><span class="line">    .fb_stride = mdss_mdp_fb_stride,</span><br><span class="line">    .check_dsi_status = mdss_check_dsi_ctrl_status,</span><br><span class="line">    .get_format_params = mdss_mdp_get_format_params,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\kernel\msm<span class="number">-3.18</span>\drivers\video\msm\mdss\mdss_mdp_overlay.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mdss_mdp_overlay_init</span><span class="params">(struct msm_fb_data_type *mfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = <span class="title">mfd</span>-&gt;<span class="title">fbi</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msm_mdp_interface</span> *<span class="title">mdp5_interface</span> = &amp;<span class="title">mfd</span>-&gt;<span class="title">mdp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_overlay_private</span> *<span class="title">mdp5_data</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">irq_info</span> *<span class="title">mdss_irq</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">    mdp5_data = kzalloc(<span class="keyword">sizeof</span>(struct mdss_overlay_private), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    mdp5_data-&gt;frc_fsm</span><br><span class="line">        = kzalloc(<span class="keyword">sizeof</span>(struct mdss_mdp_frc_fsm), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    mdp5_data-&gt;mdata = dev_get_drvdata(mfd-&gt;pdev-&gt;dev.parent);</span><br><span class="line"></span><br><span class="line">    mdp5_interface-&gt;on_fnc = mdss_mdp_overlay_on;</span><br><span class="line">    mdp5_interface-&gt;off_fnc = mdss_mdp_overlay_off;</span><br><span class="line">    mdp5_interface-&gt;release_fnc = __mdss_mdp_overlay_release_all;</span><br><span class="line">    mdp5_interface-&gt;do_histogram = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (mdp5_data-&gt;mdata-&gt;ncursor_pipes)</span><br><span class="line">        mdp5_interface-&gt;cursor_update = mdss_mdp_hw_cursor_pipe_update;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        mdp5_interface-&gt;cursor_update = mdss_mdp_hw_cursor_update;</span><br><span class="line">    mdp5_interface-&gt;async_position_update =</span><br><span class="line">        mdss_mdp_async_position_update;</span><br><span class="line">    mdp5_interface-&gt;dma_fnc = mdss_mdp_overlay_pan_display;</span><br><span class="line">    mdp5_interface-&gt;ioctl_handler = mdss_mdp_overlay_ioctl_handler;</span><br><span class="line">    mdp5_interface-&gt;kickoff_fnc = mdss_mdp_overlay_kickoff;</span><br><span class="line">    mdp5_interface-&gt;mode_switch = mdss_mode_switch;</span><br><span class="line">    mdp5_interface-&gt;mode_switch_post = mdss_mode_switch_post;</span><br><span class="line">    mdp5_interface-&gt;pre_commit_fnc = mdss_mdp_overlay_precommit;</span><br><span class="line">    mdp5_interface-&gt;splash_init_fnc = mdss_mdp_splash_init;</span><br><span class="line">    mdp5_interface-&gt;configure_panel = mdss_mdp_update_panel_info;</span><br><span class="line">    mdp5_interface-&gt;input_event_handler = mdss_mdp_input_event_handler;</span><br><span class="line">    mdp5_interface-&gt;signal_retire_fence = mdss_mdp_signal_retire_fence;</span><br><span class="line">    mdp5_interface-&gt;is_twm_en = <span class="literal">NULL</span>;</span><br><span class="line">    ......</span><br><span class="line">    rc = mdss_mdp_overlay_fb_parse_dt(mfd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * disable BWC if primary panel is video mode on specific</span></span><br><span class="line"><span class="comment">     * chipsets to workaround HW problem.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (mdss_has_quirk(mdp5_data-&gt;mdata, MDSS_QUIRK_BWCPANIC) &amp;&amp;</span><br><span class="line">        mfd-&gt;panel_info-&gt;type == MIPI_VIDEO_PANEL &amp;&amp; (<span class="number">0</span> == mfd-&gt;index))</span><br><span class="line">        mdp5_data-&gt;mdata-&gt;has_bwc = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;panel_orientation = mfd-&gt;panel_info-&gt;panel_orientation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((mfd-&gt;panel_info-&gt;panel_orientation &amp; MDP_FLIP_LR) &amp;&amp;</span><br><span class="line">        (mfd-&gt;split_mode == MDP_DUAL_LM_DUAL_DISPLAY))</span><br><span class="line">        mdp5_data-&gt;mixer_swap = <span class="literal">true</span>;</span><br><span class="line">     <span class="comment">//在/sys/class/graphics/fb0/创建 vsync_event和ad属性文件</span></span><br><span class="line">    rc = sysfs_create_group(&amp;dev-&gt;kobj, &amp;mdp_overlay_sysfs_group);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    rc = sysfs_create_link_nowarn(&amp;dev-&gt;kobj,</span><br><span class="line">            &amp;mdp5_data-&gt;mdata-&gt;pdev-&gt;dev.kobj, <span class="string">&quot;mdp&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = sysfs_create_link_nowarn(&amp;dev-&gt;kobj,</span><br><span class="line">            &amp;mfd-&gt;pdev-&gt;dev.kobj, <span class="string">&quot;mdss_fb&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="四-、-dev-graphics-fb0—ioctl重要流程分析"><a href="#四-、-dev-graphics-fb0—ioctl重要流程分析" class="headerlink" title="(四)、/dev/graphics/fb0—ioctl重要流程分析"></a>(四)、/dev/graphics/fb0—ioctl重要流程分析</h4><h5 id="4-1、device-fd-open-“-dev-graphics-fb0”-O-RDWR"><a href="#4-1、device-fd-open-“-dev-graphics-fb0”-O-RDWR" class="headerlink" title="4.1、device_fd_ = open( “/dev/graphics/fb0”, O_RDWR)"></a>4.1、device_fd_ = open( “/dev/graphics/fb0”, O_RDWR)</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG2.fb_open.png" alt="Alt text | center"></p>
<h5 id="4-2、ioctl-device-fd-INT-MSMFB-ATOMIC-COMMIT-amp-mdp-disp-commit"><a href="#4-2、ioctl-device-fd-INT-MSMFB-ATOMIC-COMMIT-amp-mdp-disp-commit" class="headerlink" title="4.2、ioctl(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_)"></a>4.2、ioctl(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_)</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG2.fb_MSMFB_ATOMIC_COMMIT.png" alt="Alt text | center"></p>
<h4 id="五-、FrameBufferTest测试app分析"><a href="#五-、FrameBufferTest测试app分析" class="headerlink" title="(五)、FrameBufferTest测试app分析"></a>(五)、FrameBufferTest测试app分析</h4><blockquote>
<p>commit —  ioctl(fd, FBIOPAN_DISPLAY, &amp;info)<br>|——&gt;mdss_fb_ioctl:FBIOPAN_DISPLAY<br>|———–&gt;mdss_fb_pan_display();<br>|—————&gt;mdss_fb_pan_display_ex();<br>唤醒__mdss_fb_display_thread后流程大概一致，就不分析了。</p>
</blockquote>
<h5 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG2.mdp.dsi.fb_probe.png" alt="Alt text | center"></p>
<h4 id="五-、参考资料-特别感谢-："><a href="#五-、参考资料-特别感谢-：" class="headerlink" title="(五)、参考资料(特别感谢)："></a>(五)、参考资料(特别感谢)：</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/dearsq/article/details/52354593">（1）【[Android5.1][RK3288] LCD Mipi 调试方法及问题汇总】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/dearsq/article/details/77341120">（2）【[Android6.0][RK3399] Mipi LCD 通用移植调试流程】</a><br><a target="_blank" rel="noopener" href="https://github.com/wj123/github/tree/master/android/module/display/liuzl">（3）【MDP分析，DSI分析，FB分析，Display resume suspend分析】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012452964/article/details/74841290">（4）【高通平台LCD之MDP code解析】</a> </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20190608/">https://zhoujinjian.com/posts/20190608/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.37.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20190708/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.38.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android P Graphics System（三）：Qualcomm HWC2（Hardware Composer 2.0 ）分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/20190508/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.36.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android P Graphics System（一）：Android Graphics精彩世界</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E3%80%81MDP%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">(一)、MDP分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81%E4%B8%BA%E5%85%B3%E9%94%AE%E9%A9%B1%E5%8A%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-struct-mdss-data-type-mdata-%E5%88%86%E9%85%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">1.1.</span> <span class="toc-text">1.1、为关键驱动数据结构 struct mdss_data_type *mdata 分配空间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2%E3%80%81clk%E5%92%8Cirq%E8%AE%BE%E7%BD%AE%E3%80%81ionclient%E5%88%9B%E5%BB%BA%EF%BC%8Ciommu%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">1.2、clk和irq设置、ionclient创建，iommu初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3%E3%80%81%E8%A7%A3%E9%87%8Adts%E4%B8%BA-struct-mdss-data-type-mdata-%E8%B5%8B%E5%80%BC"><span class="toc-number">1.3.</span> <span class="toc-text">1.3、解释dts为 struct mdss_data_type *mdata 赋值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-1%E3%80%81mdss-mdp-parse-dt-hw-settings-pdev"><span class="toc-number">1.4.</span> <span class="toc-text">1.3.1、mdss_mdp_parse_dt_hw_settings(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-2%E3%80%81mdss-mdp-parse-dt-pipe-pdev"><span class="toc-number">1.5.</span> <span class="toc-text">1.3.2、mdss_mdp_parse_dt_pipe(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-3%E3%80%81mdss-mdp-parse-dt-mixer-pdev"><span class="toc-number">1.6.</span> <span class="toc-text">1.3.3、mdss_mdp_parse_dt_mixer(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-4%E3%80%81mdss-mdp-parse-dt-mixer-pdev"><span class="toc-number">1.7.</span> <span class="toc-text">1.3.4、mdss_mdp_parse_dt_mixer(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-5%E3%80%81mdss-mdp-parse-dt-wb-pdev"><span class="toc-number">1.8.</span> <span class="toc-text">1.3.5、mdss_mdp_parse_dt_wb(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-6%E3%80%81mdss-mdp-parse-dt-ctl-pdev"><span class="toc-number">1.9.</span> <span class="toc-text">1.3.6、mdss_mdp_parse_dt_ctl(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-7%E3%80%81mdss-mdp-parse-dt-video-intf-pdev"><span class="toc-number">1.10.</span> <span class="toc-text">1.3.7、mdss_mdp_parse_dt_video_intf(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-8%E3%80%81mdss-mdp-parse-dt-smp-pdev"><span class="toc-number">1.11.</span> <span class="toc-text">1.3.8、mdss_mdp_parse_dt_smp(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-9%E3%80%81mdss-mdp-parse-dt-xxx-pdev"><span class="toc-number">1.12.</span> <span class="toc-text">1.3.9、mdss_mdp_parse_dt_xxx(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4%E3%80%81%E5%88%9B%E5%BB%BA%E5%B1%9E%E6%80%A7%E6%96%87%E4%BB%B6%E3%80%81%E6%8C%82%E6%8E%A5%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">1.13.</span> <span class="toc-text">1.4、创建属性文件、挂接中断处理函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-1%E3%80%81mdss-mdp-get-cmdline-config-pdev"><span class="toc-number">1.14.</span> <span class="toc-text">1.4.1、mdss_mdp_get_cmdline_config(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-2%E3%80%81mdss-mdp-register-sysfs-mdata"><span class="toc-number">1.15.</span> <span class="toc-text">1.4.2、mdss_mdp_register_sysfs(mdata)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-3%E3%80%81mdss-fb-register-mdp-instance-amp-mdp5"><span class="toc-number">1.16.</span> <span class="toc-text">1.4.3、mdss_fb_register_mdp_instance(&amp;mdp5)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-4%E3%80%81register-irq-amp-mdss-mdp-hw"><span class="toc-number">1.17.</span> <span class="toc-text">1.4.4、register_irq(&amp;mdss_mdp_hw)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-5%E3%80%81mdss-smmu-init-mdata-amp-pdev-gt-dev"><span class="toc-number">1.18.</span> <span class="toc-text">1.4.5、mdss_smmu_init(mdata, &amp;pdev-&gt;dev)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E3%80%81DSI%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">(二)、DSI分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81mdss-dsi-probe-struct-platform-device-pdev"><span class="toc-number">2.1.</span> <span class="toc-text">2.1、mdss_dsi_probe(struct platform_device *pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81mdss-dsi-ctrl-probe-struct-platform-device-pdev"><span class="toc-number">2.2.</span> <span class="toc-text">2.2、mdss_dsi_ctrl_probe(struct platform_device *pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1%E3%80%81mdss-dsi-config-panel"><span class="toc-number">2.3.</span> <span class="toc-text">2.2.1、mdss_dsi_config_panel()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-1%E3%80%81mdss-panel-parse-dt-node-ctrl-pdata"><span class="toc-number">2.4.</span> <span class="toc-text">2.2.1.1、mdss_panel_parse_dt(node, ctrl_pdata)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2%E3%80%81dsi-panel-device-register-pdev-dsi-pan-node-ctrl-pdata"><span class="toc-number">2.5.</span> <span class="toc-text">2.2.2、dsi_panel_device_register(pdev, dsi_pan_node, ctrl_pdata)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-1%E3%80%81mdss-register-panel-ctrl-pdev-amp-ctrl-pdata-gt-panel-data"><span class="toc-number">2.6.</span> <span class="toc-text">2.2.2.1、mdss_register_panel(ctrl_pdev, &amp;(ctrl_pdata-&gt;panel_data))</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-%E3%80%81FrameBuffer%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">(三)、FrameBuffer分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81mdss-fb-register-mfd"><span class="toc-number">3.1.</span> <span class="toc-text">3.1、mdss_fb_register(mfd)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2%E3%80%81mdss-mdp-overlay-init-struct-msm-fb-data-type-mfd"><span class="toc-number">3.2.</span> <span class="toc-text">3.2、mdss_mdp_overlay_init(struct msm_fb_data_type *mfd)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B-%E3%80%81-dev-graphics-fb0%E2%80%94ioctl%E9%87%8D%E8%A6%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">(四)、&#x2F;dev&#x2F;graphics&#x2F;fb0—ioctl重要流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1%E3%80%81device-fd-open-%E2%80%9C-dev-graphics-fb0%E2%80%9D-O-RDWR"><span class="toc-number">4.1.</span> <span class="toc-text">4.1、device_fd_ &#x3D; open( “&#x2F;dev&#x2F;graphics&#x2F;fb0”, O_RDWR)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2%E3%80%81ioctl-device-fd-INT-MSMFB-ATOMIC-COMMIT-amp-mdp-disp-commit"><span class="toc-number">4.2.</span> <span class="toc-text">4.2、ioctl(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-%E3%80%81FrameBufferTest%E6%B5%8B%E8%AF%95app%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">(五)、FrameBufferTest测试app分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93%EF%BC%9A"><span class="toc-number">5.1.</span> <span class="toc-text">小结：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94-%E3%80%81%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2-%EF%BC%9A"><span class="toc-number">6.</span> <span class="toc-text">(五)、参考资料(特别感谢)：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>