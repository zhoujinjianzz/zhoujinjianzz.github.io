<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析 | zhoujinjian</title><meta name="keywords" content="Camera"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析">
<meta property="og:url" content="https://zhoujinjian.com/posts/20220215/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.34.jpg">
<meta property="article:published_time" content="2022-02-14T18:15:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.932Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Camera">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.34.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20220215/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.34.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-14T18:15:00.000Z" title="发表于 2022-02-15 02:15:00">2022-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.932Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Camera/">Camera</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。<br>（==<strong>文章基于 Kernel-4.19</strong>==）&amp;&amp;（==<strong>文章基于 Android 10.0</strong>==）<br> <a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz">【zhoujinjian.com博客原图链接】</a><br> <a target="_blank" rel="noopener" href="https://www.khadas.cn/edge-v">【开发板 Khadas Edge V】</a><br><a target="_blank" rel="noopener" href="https://github.com/khadas/linux/tree/khadas-edge-Qt">【开发板 Khadas Edge V Android 10.0 &amp;&amp; Linux（Kernel 4.19）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p> <a target="_blank" rel="noopener" href="https://deepinout.com/v4l2-tutorials/linux-v4l2-architecture.html">V4L2框架解析</a><br> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43503508/category_10257454.html">camera linux v4l2相关接口</a><br> <a target="_blank" rel="noopener" href="https://patchwork.ozlabs.org/project/devicetree-bindings/cover/1514533978-20408-1-git-send-email-zhengsq@rock-chips.com/">Rockchip ISP1 Driver</a> </p>
<hr>
<p>==源码（部分）==：<br><strong>F:\Khadas_Edge_Android_Q\kernel\include\uapi\linux\</strong><br><strong>F:\Khadas_Edge_Android_Q\kernel\drivers\phy\rockchip\</strong><br><strong>F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\</strong><br><strong>F:\Khadas_Edge_Android_Q\kernel\drivers\media\v4l2-core\</strong><br><strong>F:\Khadas_Edge_Android_Q\kernel\drivers\media\common\videobuf2\</strong></p>
<hr>
<h2 id="（一）、Rockchip-isp1介绍"><a href="#（一）、Rockchip-isp1介绍" class="headerlink" title="（一）、Rockchip-isp1介绍"></a>（一）、Rockchip-isp1介绍</h2><h4 id="1、Overview"><a href="#1、Overview" class="headerlink" title="1、Overview"></a>1、Overview</h4><p>The document below provide basical informations about the rockchip-isp1 driver driver and Image Signal Processing block on Rockchip SoC with examples and details.</p>
<h4 id="2、Hardware"><a href="#2、Hardware" class="headerlink" title="2、Hardware"></a>2、Hardware</h4><p>More detailed information could be found in TRM chapter “Image Signal Processing”, “MIPI D-PHY” , but they are only available under NDA.</p>
<h4 id="3、ISP-Details"><a href="#3、ISP-Details" class="headerlink" title="3、ISP Details"></a>3、ISP Details</h4><p>ISP comprises with:</p>
<ul>
<li>MIPI serial camera interface</li>
<li>Image Signal Processing</li>
<li>Many Image Enhancement Blocks</li>
<li>Crop</li>
<li>Resize</li>
</ul>
<h4 id="4、Block-diagram"><a href="#4、Block-diagram" class="headerlink" title="4、Block diagram"></a>4、Block diagram</h4><p>The completed block diagram can not be pasted from datasheet to here, below diagram is an abstract version:</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/Block.png"></p>
<h4 id="5、MIPI-Details"><a href="#5、MIPI-Details" class="headerlink" title="5、MIPI Details"></a>5、MIPI Details</h4><p>There are three D-PHY instances in rockchip SoC, their connection are shown as following figure:<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/Phy.png"></p>
<h4 id="6、Software"><a href="#6、Software" class="headerlink" title="6、Software"></a>6、Software</h4><h4 id="7、Driver"><a href="#7、Driver" class="headerlink" title="7、Driver"></a>7、Driver</h4><p>rockchip-isp1 is a V4L2 based driver for Image Signal Processing block on Rockchip SoC. Compared to the earlier driver rk-isp10, it use Media Controller framework, which it’s different from plain v4L2. While the plain v4L2 had a view of the device as a plain DMA based image drabber which connects the input data to the host memory, the Media Controller takes into consideration the fact that a typical video device might consist of multiple sub-devices.</p>
<h4 id="8、Media-Controller-Basics"><a href="#8、Media-Controller-Basics" class="headerlink" title="8、Media Controller Basics"></a>8、Media Controller Basics</h4><p>Please read below link carefully, especially if you don’t have use it before.</p>
<p><a target="_blank" rel="noopener" href="https://linuxtv.org/downloads/v4l-dvb-apis/uapi/mediactl/media-controller-intro.html">https://linuxtv.org/downloads/v4l-dvb-apis/uapi/mediactl/media-controller-intro.html</a></p>
<h4 id="9、Block-diagram"><a href="#9、Block-diagram" class="headerlink" title="9、Block diagram"></a>9、Block diagram</h4><h4 id="10、File-view"><a href="#10、File-view" class="headerlink" title="10、File view"></a>10、File view</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/Code.png"></p>
<h4 id="11、V4l2-view"><a href="#11、V4l2-view" class="headerlink" title="11、V4l2 view"></a>11、V4l2 view</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/Rockchip-isp1-v4l2.png"><br>| Name | Type | Description |<br>| — | — | — |<br>| rkisp1_mainpath | v4l2_vdev, capture | Format: YUV, RAW Bayer; Max resolution: 4416*3312; Support: Crop  |<br>| rkisp1_selfpath | v4l2_vdev, capture | Format: YUV, RGB; Max resolution: 1920*1080; Support: Crop |<br>| rkisp1-isp-subdev | v4l2_subdev |  Internal isp blocks; Support: source/sink pad crop. The format on sink pad should be equal to sensor input format, the size should be equal/less than sensor input size. The format on source pad should be equal to vdev output format if output format is raw bayer, otherwise it should be  YUYV2X8. The size should be equal/less than sink pad size.  |<br>| rockchip-sy-mipi-dphy | v4l2_subdev |  MIPI-DPHY Configure  |<br>| rkisp1-statistics | v4l2_vdev, capture |  Provide Image color Statistics information.  |<br>| rkisp1-input-params | v4l2_vdev, output |  Accept params for AWB, BLC…… Image enhancement blcoks  |</p>
<h4 id="12、Sensor-Driver-Requirement"><a href="#12、Sensor-Driver-Requirement" class="headerlink" title="12、Sensor Driver Requirement"></a>12、Sensor Driver Requirement</h4><p>The sensor driver should implement controls in the following table. </p>
<table>
<thead>
<tr>
<th>Controls</th>
<th>Description</th>
<th>R/W</th>
<th>Needed by</th>
</tr>
</thead>
<tbody><tr>
<td>V4L2_CID_VBLANK</td>
<td>Vertical blanking. The idle period after every frame during which no image data is produced. The unit of vertical blanking is a line. Every line has length of the image width plus horizontal blanking at the pixel rate defined by <code>V4L2_CID_PIXEL_RATE</code> control in the same sub-device.</td>
<td>R</td>
<td>Ae</td>
</tr>
<tr>
<td>V4L2_CID_HBLANK</td>
<td>Horizontal blanking. The idle period after every line of image data during which no image data is produced. The unit of horizontal blanking is pixels.</td>
<td>R</td>
<td>Ae</td>
</tr>
<tr>
<td>V4L2_CID_EXPOSURE</td>
<td>Determines the exposure time of the camera sensor. The exposure time is limited by the frame interval. Drivers should interpret the values as 100 µs units, where the value 1 stands for 1/10000th of a second, 10000 for 1 second and 100000 for 10 seconds.</td>
<td>R/W</td>
<td>Ae</td>
</tr>
<tr>
<td>V4L2_CID_ANALOGUE_GAIN</td>
<td>Analogue gain is gain affecting all colour components in the pixel matrix. The gain operation is performed in the analogue domain before A/D conversion.</td>
<td>R/W</td>
<td>Ae</td>
</tr>
<tr>
<td>V4L2_CID_DIGITAL_GAIN</td>
<td>Digital gain is the value by which all colour components are multiplied by. Typically the digital gain applied is the control value divided by e.g. 0x100, meaning that to get no digital gain the control value needs to be 0x100. The no-gain configuration is also typically the default.</td>
<td>R/W</td>
<td>Ae</td>
</tr>
<tr>
<td>V4L2_CID_PIXEL_RATE</td>
<td>Pixel rate in the source pads of the subdev. This control is read-only and its unit is pixels / second.</td>
<td>R</td>
<td>Ae</td>
</tr>
<tr>
<td>V4L2_CID_LINK_FREQ</td>
<td>Data bus frequency. Together with the media bus pixel code, bus type (clock cycles per sample), the data bus frequency defines the pixel rate (<code>V4L2_CID_PIXEL_RATE</code>) in the pixel array (or possibly elsewhere, if the device is not an image sensor). The frame rate can be calculated from the pixel clock, image width and height and horizontal and vertical blanking. While the pixel rate control may be defined elsewhere than in the subdev containing the pixel array, the frame rate cannot be obtained from that information. This is because only on the pixel array it can be assumed that the vertical and horizontal blanking information is exact: no other blanking is allowed in the pixel array. The selection of frame rate is performed by selecting the desired horizontal and vertical blanking. The unit of this control is Hz.</td>
<td>R</td>
<td>mipi-dphy</td>
</tr>
</tbody></table>
<h4 id="13、Devicetree-Bindings"><a href="#13、Devicetree-Bindings" class="headerlink" title="13、Devicetree Bindings"></a>13、Devicetree Bindings</h4><p><a target="_blank" rel="noopener" href="https://github.com/wzyy2/linux/blob/rkisp1/Documentation/devicetree/bindings/media/rockchip-isp1.txt">https://github.com/torvalds/linux/tree/master/Documentation/devicetree/bindings/media/rockchip-isp1.txt</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/wzyy2/linux/blob/rkisp1/Documentation/devicetree/bindings/media/rockchip-mipi-dphy.txt">https://github.com/torvalds/linux/tree/master/Documentation/devicetree/bindings/media/rockchip-mipi-dphy.txt</a></p>
<h4 id="14、Linux"><a href="#14、Linux" class="headerlink" title="14、Linux"></a>14、Linux</h4><h4 id="15、User-applications"><a href="#15、User-applications" class="headerlink" title="15、User applications"></a>15、User applications</h4><p>The v4l-utils tool and applications<br>The v4l-utils tool is a V4L2 development kit maintained by Linuxtv[1] . It provides a set<br>of V4L2 and media framework related tools for configuring V4L2 sub-device properties,<br>testing V4L2 devices, and providing development libraries such as libv4l2.so and so on.<br>This chapter mainly introduces two command-line tools in v4l-utils: media-ctl and v4l2-<br>ctl<br> media-ctl, used to view and configure topology<br> v4l2-ctl, used to configure v4l2 controls, capture frames, set cif, isp, sensor<br>parameters<br>The format code of different versions of v4l-utils will be different, especially mbus-fmt<br>part. The version used in this document is v4l-utils-1.14.1 integrated in Linux SDK. </p>
<h4 id="16、Android"><a href="#16、Android" class="headerlink" title="16、Android"></a>16、Android</h4><h4 id="17、Camera-Hal3"><a href="#17、Camera-Hal3" class="headerlink" title="17、Camera Hal3"></a>17、Camera Hal3</h4><p><a target="_blank" rel="noopener" href="https://source.android.com/devices/camera/camera3?hl=zh-cn">https://source.android.com/devices/camera/camera3</a></p>
<h4 id="18、Topology"><a href="#18、Topology" class="headerlink" title="18、Topology"></a>18、Topology</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">media-ctl --device /dev/media0 --print-topology</span><br><span class="line"></span><br><span class="line">Opening media device /dev/media0</span><br><span class="line">Enumerating entities</span><br><span class="line">Found <span class="number">9</span> entities</span><br><span class="line">Enumerating pads <span class="keyword">and</span> links</span><br><span class="line">Media controller API version <span class="number">0.0</span><span class="number">.111</span></span><br><span class="line"></span><br><span class="line">Media device information</span><br><span class="line">------------------------</span><br><span class="line">driver          rkisp1</span><br><span class="line">model           rkisp1</span><br><span class="line">serial</span><br><span class="line">bus info</span><br><span class="line">hw revision     <span class="number">0x0</span></span><br><span class="line">driver version  <span class="number">0.0</span><span class="number">.111</span></span><br><span class="line"></span><br><span class="line">Device topology</span><br><span class="line">- entity <span class="number">1</span>: rkisp1-isp-subdev (<span class="number">4</span> pads, <span class="number">6</span> links)</span><br><span class="line">            type V4L2 subdev subtype Unknown</span><br><span class="line">            device node name /dev/v4l-subdev0</span><br><span class="line">        pad0: Sink</span><br><span class="line">                [fmt:SBGGR10/<span class="number">4208</span>x3120</span><br><span class="line">                 crop.bounds:(<span class="number">0</span>,<span class="number">0</span>)/<span class="number">4208</span>x3120</span><br><span class="line">                 crop:(<span class="number">0</span>,<span class="number">0</span>)/<span class="number">4208</span>x3120]</span><br><span class="line">                &lt;- <span class="string">&quot;rkisp1_dmapath&quot;</span>:<span class="number">0</span> []</span><br><span class="line">                &lt;- <span class="string">&quot;rockchip-mipi-dphy-rx&quot;</span>:<span class="number">1</span> [ENABLED]</span><br><span class="line">        pad1: Sink</span><br><span class="line">                &lt;- <span class="string">&quot;rkisp1-input-params&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line">        pad2: Source</span><br><span class="line">                [fmt:YUYV2X8/<span class="number">4208</span>x3120</span><br><span class="line">                 crop.bounds:(<span class="number">0</span>,<span class="number">0</span>)/<span class="number">4208</span>x3120</span><br><span class="line">                 crop:(<span class="number">0</span>,<span class="number">0</span>)/<span class="number">4208</span>x3120]</span><br><span class="line">                -&gt; <span class="string">&quot;rkisp1_selfpath&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line">                -&gt; <span class="string">&quot;rkisp1_mainpath&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line">        pad3: Source</span><br><span class="line">                -&gt; <span class="string">&quot;rkisp1-statistics&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">6</span>: rkisp1_mainpath (<span class="number">1</span> pad, <span class="number">1</span> link)</span><br><span class="line">            type Node subtype V4L</span><br><span class="line">            device node name /dev/video0</span><br><span class="line">        pad0: Sink</span><br><span class="line">                &lt;- <span class="string">&quot;rkisp1-isp-subdev&quot;</span>:<span class="number">2</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">10</span>: rkisp1_selfpath (<span class="number">1</span> pad, <span class="number">1</span> link)</span><br><span class="line">             type Node subtype V4L</span><br><span class="line">             device node name /dev/video1</span><br><span class="line">        pad0: Sink</span><br><span class="line">                &lt;- <span class="string">&quot;rkisp1-isp-subdev&quot;</span>:<span class="number">2</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">14</span>: rkisp1_dmapath (<span class="number">1</span> pad, <span class="number">1</span> link)</span><br><span class="line">             type Node subtype V4L</span><br><span class="line">             device node name /dev/video2</span><br><span class="line">        pad0: Source</span><br><span class="line">                -&gt; <span class="string">&quot;rkisp1-isp-subdev&quot;</span>:<span class="number">0</span> []</span><br><span class="line"></span><br><span class="line">- entity <span class="number">20</span>: rkisp1-statistics (<span class="number">1</span> pad, <span class="number">1</span> link)</span><br><span class="line">             type Node subtype V4L</span><br><span class="line">             device node name /dev/video3</span><br><span class="line">        pad0: Sink</span><br><span class="line">                &lt;- <span class="string">&quot;rkisp1-isp-subdev&quot;</span>:<span class="number">3</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">24</span>: rkisp1-input-params (<span class="number">1</span> pad, <span class="number">1</span> link)</span><br><span class="line">             type Node subtype V4L</span><br><span class="line">             device node name /dev/video4</span><br><span class="line">        pad0: Source</span><br><span class="line">                -&gt; <span class="string">&quot;rkisp1-isp-subdev&quot;</span>:<span class="number">1</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">28</span>: rockchip-mipi-dphy-rx (<span class="number">2</span> pads, <span class="number">2</span> links)</span><br><span class="line">             type V4L2 subdev subtype Unknown</span><br><span class="line">             device node name /dev/v4l-subdev1</span><br><span class="line">        pad0: Sink</span><br><span class="line">                [fmt:SBGGR10/<span class="number">4208</span>x3120]</span><br><span class="line">                &lt;- <span class="string">&quot;m00_b_imx214 6-0010&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line">        pad1: Source</span><br><span class="line">                [fmt:SBGGR10/<span class="number">4208</span>x3120]</span><br><span class="line">                -&gt; <span class="string">&quot;rkisp1-isp-subdev&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">31</span>: m00_b_imx214 <span class="number">6</span><span class="number">-0010</span> (<span class="number">1</span> pad, <span class="number">1</span> link)</span><br><span class="line">             type V4L2 subdev subtype Sensor</span><br><span class="line">             device node name /dev/v4l-subdev2</span><br><span class="line">        pad0: Source</span><br><span class="line">                [fmt:SBGGR10/<span class="number">4208</span>x3120]</span><br><span class="line">                -&gt; <span class="string">&quot;rockchip-mipi-dphy-rx&quot;</span>:<span class="number">0</span> [ENABLED]</span><br><span class="line"></span><br><span class="line">- entity <span class="number">35</span>: m00_b_vm149c <span class="number">6</span><span class="number">-000</span>c (<span class="number">0</span> pad, <span class="number">0</span> link)</span><br><span class="line">             type V4L2 subdev subtype Lens</span><br><span class="line">             device node name /dev/v4l-subdev3</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="（二）、Rockchip-isp1-driver分析"><a href="#（二）、Rockchip-isp1-driver分析" class="headerlink" title="（二）、Rockchip-isp1 driver分析"></a>（二）、Rockchip-isp1 driver分析</h2><p>本章主要介绍 RKisp1 的驱动代码结构、dts 配置、debug 方法等。ISP 驱动符合 media controller，v4l2，vb2 框架，与 mipi-dphy，Sensor 相互独立且通过异步注册。</p>
<h3 id="（1）、Camera-软件驱动目录说明"><a href="#（1）、Camera-软件驱动目录说明" class="headerlink" title="（1）、Camera 软件驱动目录说明"></a>（1）、Camera 软件驱动目录说明</h3><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/isp1code_source.png"></p>
<h4 id="1、框架简要说明"><a href="#1、框架简要说明" class="headerlink" title="1、框架简要说明"></a>1、框架简要说明</h4><p>RKISP 驱动主要是依据 v4l2 / media framework 实现硬件的配置、中断处理、控制 buffer轮转，以及控制 subdevice(如 mipi dphy 及 sensor)的上下电等功能。<br>下面的框图描述了 RKISP1 驱动的拓扑结构。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/1624498395236.png"></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>rkisp1_mainpath</td>
<td>v4l2_vdev, capture</td>
<td>Format: YUV, RAW Bayer; Max resolution: 4416*3312; Support: Crop</td>
</tr>
<tr>
<td>rkisp1_selfpath</td>
<td>v4l2_vdev, capture</td>
<td>Format: YUV, RGB; Max resolution: 1920*1080; Support: Crop</td>
</tr>
<tr>
<td>rkisp1-isp-subdev</td>
<td>v4l2_subdev</td>
<td>Internal isp blocks; Support: source/sink pad crop. The format on sink pad should be equal to sensor input format, the size should be equal/less than sensor input size. The format on source pad should be equal to vdev output format if output format is raw bayer, otherwise it should be  YUYV2X8. The size should be equal/less than sink pad size.</td>
</tr>
<tr>
<td>rockchip-sy-mipi-dphy</td>
<td>v4l2_subdev</td>
<td>MIPI-DPHY Configure</td>
</tr>
<tr>
<td>rkisp1-statistics</td>
<td>v4l2_vdev, capture</td>
<td>Provide Image color Statistics information.</td>
</tr>
<tr>
<td>rkisp1-input-params</td>
<td>v4l2_vdev, output</td>
<td>Accept params for AWB, BLC…… Image enhancement blcoks</td>
</tr>
</tbody></table>
<h4 id="2、驱动版本号获取方式"><a href="#2、驱动版本号获取方式" class="headerlink" title="2、驱动版本号获取方式"></a>2、驱动版本号获取方式</h4><p>·从 kernel 启动 log 中获取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rkisp1 ff910000.rkisp1: rkisp1 driver version: v00<span class="number">.01</span><span class="number">.05</span></span><br></pre></td></tr></table></figure>
<p>·由以下命令获取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/<span class="keyword">module</span>/video_rkisp1/parameters/version</span><br></pre></td></tr></table></figure>

<h4 id="3、RKisp1-DTS配置"><a href="#3、RKisp1-DTS配置" class="headerlink" title="3、RKisp1 DTS配置"></a>3、RKisp1 DTS配置</h4><p>RKisp1 的 DTS binding 也有完整的 Document 位于Documentation/devicetree/bindings/media/rockchip-isp1.txt。请首先参考该文档，它会跟驱动保持同步更新。在 RK Linux SDK 发布时， 若芯片支持 ISP，其 dtsi 中已经有定义好 rkisp1<br>节点，如rk3399.dtsi 中的 rkisp1_0，rkisp1_1 节点。下表描述各芯片 ISP 的信息。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/RK3399_rkisp1_0.png"></p>
<p>注意：</p>
<ul>
<li>RK3399.dtsi 中也注册了多个 isp 节点，请注意本章所描述的是 rkisp1_0 及 rkisp1_1</li>
<li>Iommu 需要和 isp 一同 enable 或 disable</li>
<li>如有多个 isp（比如 rk3399），请注意 iommu 节点要选</li>
</ul>
<h5 id="3-1、-RKisp1-DTS的板级配置"><a href="#3-1、-RKisp1-DTS的板级配置" class="headerlink" title="3.1、 RKisp1 DTS的板级配置"></a>3.1、 RKisp1 DTS的板级配置</h5><p>isp、mipi-dphy、sensor 是单独定义的节点， 三者之间通过<br>remote endpoint 相互建立连接。在结构框图上，mipi-dphy 连接了 isp 及 sensor。以下示例是<br>基于 RK3399 edge-v 上的 dts 板级配置，可以参考文件F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399-khadas-edge-android.dts。<br>在该板子上， RK3399 的两个 ISP 都启用了，这里仅举例 rkisp1_0。</p>
<blockquote>
<p>首先， 将 rkisp1_0 节点设置为”okay”状态。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399.dtsi</span><br><span class="line">    rkisp1_0: rkisp1@ff910000 &#123;</span><br><span class="line">        compatible = <span class="string">&quot;rockchip,rk3399-rkisp1&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x0</span> <span class="number">0xff910000</span> <span class="number">0x0</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">        interrupts = &lt;GIC_SPI <span class="number">43</span> IRQ_TYPE_LEVEL_HIGH <span class="number">0</span>&gt;;</span><br><span class="line">        interrupt-names = <span class="string">&quot;isp_irq&quot;</span>;</span><br><span class="line">        clocks = &lt;&amp;cru SCLK_ISP0&gt;,</span><br><span class="line">             &lt;&amp;cru ACLK_ISP0&gt;, &lt;&amp;cru HCLK_ISP0&gt;,</span><br><span class="line">             &lt;&amp;cru ACLK_ISP0_WRAPPER&gt;, &lt;&amp;cru HCLK_ISP0_WRAPPER&gt;;</span><br><span class="line">        clock-names = <span class="string">&quot;clk_isp&quot;</span>,</span><br><span class="line">             <span class="string">&quot;aclk_isp&quot;</span>, <span class="string">&quot;hclk_isp&quot;</span>,</span><br><span class="line">             <span class="string">&quot;aclk_isp_wrap&quot;</span>, <span class="string">&quot;hclk_isp_wrap&quot;</span>;</span><br><span class="line">        devfreq = &lt;&amp;dmc&gt;;</span><br><span class="line">        power-domains = &lt;&amp;power RK3399_PD_ISP0&gt;;</span><br><span class="line">        iommus = &lt;&amp;isp0_mmu&gt;;</span><br><span class="line">        status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399-khadas-edge-android.dts</span><br><span class="line">&amp;rkisp1_0 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    port &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">        <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">        isp0_mipi_in: endpoint@<span class="number">0</span> &#123;</span><br><span class="line">            reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">            remote-endpoint = &lt;&amp;dphy_rx0_out&gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意，</p>
<ul>
<li>其它版本的 isp 驱动的节点状态需要 disabled。否则两套不同的驱动会冲突</li>
<li>Port 节点中定义了该 rkisp1_0 是与 dphy_rx0_out </li>
</ul>
<blockquote>
<p>第二，rkisp1_0 对应的 iommu 也需要是”okay”状态。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;isp0_mmu &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第三，该 sensor 是 mipi 接口，因此需要把 mipi dph也启用。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399-khadas-edge-android.dts</span><br><span class="line">&amp;mipi_dphy_rx0 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ports &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">        <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">        port@<span class="number">0</span> &#123;</span><br><span class="line">            reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">            <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">            <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">            mipi_in_ucam0: endpoint@<span class="number">1</span> &#123;</span><br><span class="line">                reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">                remote-endpoint = &lt;&amp;ucam_out0&gt;;</span><br><span class="line">                data-lanes = &lt;<span class="number">1</span> <span class="number">2</span>&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        port@<span class="number">1</span> &#123;</span><br><span class="line">            reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">            <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">            <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">            dphy_rx0_out: endpoint@<span class="number">0</span> &#123;</span><br><span class="line">                reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                remote-endpoint = &lt;&amp;isp0_mipi_in&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>Dphy 既连接 isp，也连接sensor。因此它有两个endpoint。mipi_in_ucam0是与Sensor<br>相连接，dphy_rx0_out 与 isp 相连接</li>
<li>mipi_in_ucam0 中声明了 data-lanes，指明了 sensor 使用了两个 lane。如果有 4 个<br>lanes，这里就应该定义成&lt;1 2 3 4&gt;。以此类推。</li>
</ul>
<p>最后板级的sensor节点定义好，并且也需要声明port子节点，与mipi dphy的 dphy_rx0_out<br>相连接。</p>
<h4 id="4、rkisp1-plat-probe"><a href="#4、rkisp1-plat-probe" class="headerlink" title="4、rkisp1_plat_probe"></a>4、rkisp1_plat_probe</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\dev.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rkisp1_plat_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">//初始化isp_dev rkisp1_pipeline 函数</span></span><br><span class="line">    isp_dev-&gt;pipe.open = rkisp1_pipeline_open;</span><br><span class="line">    isp_dev-&gt;pipe.close = rkisp1_pipeline_close;</span><br><span class="line">    isp_dev-&gt;pipe.set_stream = rkisp1_pipeline_set_stream;</span><br><span class="line"><span class="comment">//初始化stream</span></span><br><span class="line">    rkisp1_stream_init(isp_dev, RKISP1_STREAM_SP);</span><br><span class="line">    rkisp1_stream_init(isp_dev, RKISP1_STREAM_MP);</span><br><span class="line">    rkisp1_stream_init(isp_dev, RKISP1_STREAM_RAW);</span><br><span class="line"><span class="comment">//media_dev.ops</span></span><br><span class="line">    isp_dev-&gt;media_dev.dev = &amp;pdev-&gt;dev;</span><br><span class="line">    isp_dev-&gt;media_dev.ops = &amp;rkisp1_media_ops;</span><br><span class="line">    v4l2_dev = &amp;isp_dev-&gt;v4l2_dev;</span><br><span class="line">    v4l2_dev-&gt;mdev = &amp;isp_dev-&gt;media_dev;</span><br><span class="line"><span class="comment">//初始化ctrl_handler</span></span><br><span class="line">    strlcpy(v4l2_dev-&gt;name, <span class="string">&quot;rkisp1&quot;</span>, <span class="keyword">sizeof</span>(v4l2_dev-&gt;name));</span><br><span class="line">    v4l2_ctrl_handler_init(&amp;isp_dev-&gt;ctrl_handler, <span class="number">5</span>);</span><br><span class="line">    v4l2_dev-&gt;ctrl_handler = &amp;isp_dev-&gt;ctrl_handler;</span><br><span class="line"><span class="comment">//v4l2_device_register</span></span><br><span class="line">    ret = v4l2_device_register(isp_dev-&gt;dev, &amp;isp_dev-&gt;v4l2_dev);</span><br><span class="line"><span class="comment">//media_device_register,此处会生成/dev/media0</span></span><br><span class="line">    media_device_init(&amp;isp_dev-&gt;media_dev);</span><br><span class="line">    ret = media_device_register(&amp;isp_dev-&gt;media_dev);</span><br><span class="line"><span class="comment">//rkisp1_register_platform_subdevs</span></span><br><span class="line">    <span class="comment">/* create &amp; register platefom subdev (from of_node) */</span></span><br><span class="line">    ret = rkisp1_register_platform_subdevs(isp_dev);    </span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h4 id="4-1、v4l2-device-register"><a href="#4-1、v4l2-device-register" class="headerlink" title="4.1、v4l2_device_register"></a>4.1、v4l2_device_register</h4><p>v4l2的设备注册其实没有注册设备或者设备驱动，只是将v4l2的大结构体与其他设备进行捆绑。如下面是v4l2注册设备的过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\v4l2-core\v4l2-device.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">v4l2_device_register</span><span class="params">(struct device *dev, struct v4l2_device *v4l2_dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (v4l2_dev == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    INIT_LIST_HEAD(&amp;v4l2_dev-&gt;subdevs);</span><br><span class="line">    spin_lock_init(&amp;v4l2_dev-&gt;lock);</span><br><span class="line">    mutex_init(&amp;v4l2_dev-&gt;ioctl_lock);</span><br><span class="line">    v4l2_prio_init(&amp;v4l2_dev-&gt;prio);</span><br><span class="line">    kref_init(&amp;v4l2_dev-&gt;ref);</span><br><span class="line">    <span class="comment">//上面都是做一些初始化工作，</span></span><br><span class="line">    get_device(dev);</span><br><span class="line">    <span class="comment">//下面将当前设备的对象，赋值给v4l2_dev-&gt;dev中，这样的话当前的设备就成了v4l2设备，由于当前设备已经注册过了设备文件，所以后续不需要在重新注册设备文件。</span></span><br><span class="line">    v4l2_dev-&gt;dev = dev;</span><br><span class="line">    <span class="keyword">if</span> (dev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* If dev == NULL, then name must be filled in by the caller */</span></span><br><span class="line">        <span class="keyword">if</span> (WARN_ON(!v4l2_dev-&gt;name[<span class="number">0</span>]))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set name to driver name + device name if it is empty. */</span></span><br><span class="line">    <span class="comment">/* 如果v4l2设备的名字为空，则会将当前设备的名字拷贝为v4l2设备中。*/</span></span><br><span class="line">    <span class="keyword">if</span> (!v4l2_dev-&gt;name[<span class="number">0</span>])</span><br><span class="line">        <span class="built_in">snprintf</span>(v4l2_dev-&gt;name, <span class="keyword">sizeof</span>(v4l2_dev-&gt;name), <span class="string">&quot;%s %s&quot;</span>,</span><br><span class="line">            dev-&gt;driver-&gt;name, dev_name(dev));</span><br><span class="line">    <span class="comment">//下面是非常重要的一步，即将v4l2设备对象，保存到dev设备中，这个dev可以是platform、char、block等设，我们可以使用dev_get_drvdata(dev)获取到v4l2对象。</span></span><br><span class="line">    <span class="keyword">if</span> (!dev_get_drvdata(dev))</span><br><span class="line">        dev_set_drvdata(dev, v4l2_dev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  这里上面代码比较简单，这需要知道此函数功能是将当前设备和v4l2设备捆绑，并保存v4l2设备对象到当前设备的driverdata中。<strong>此函数的作用就是将当前设备驱动和v4l2对象进行捆绑，便于挂接子设备</strong></p>
<h4 id="4-2、video-register-device注册过程"><a href="#4-2、video-register-device注册过程" class="headerlink" title="4.2、video_register_device注册过程"></a>4.2、video_register_device注册过程</h4><h5 id="4-2-1、注册过程"><a href="#4-2-1、注册过程" class="headerlink" title="4.2.1、注册过程"></a>4.2.1、注册过程</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\include\media\v4l2-dev.h</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  video_register_device - register video4linux devices</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @vdev: struct video_device to register</span></span><br><span class="line"><span class="comment"> * @type: type of device to register, as defined by &amp;enum vfl_devnode_type</span></span><br><span class="line"><span class="comment"> * @nr:   which device node number is desired:</span></span><br><span class="line"><span class="comment"> *    (0 == /dev/video0, 1 == /dev/video1, ..., -1 == first free)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Internally, it calls __video_register_device(). Please see its</span></span><br><span class="line"><span class="comment"> * documentation for more details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * .. note::</span></span><br><span class="line"><span class="comment"> *    if video_register_device fails, the release() callback of</span></span><br><span class="line"><span class="comment"> *    &amp;struct video_device structure is *not* called, so the caller</span></span><br><span class="line"><span class="comment"> *    is responsible for freeing any data. Usually that means that</span></span><br><span class="line"><span class="comment"> *    you video_device_release() should be called on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> __must_check <span class="title">video_register_device</span><span class="params">(struct video_device *vdev,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">enum</span> vfl_devnode_type type,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __video_register_device(vdev, type, nr, <span class="number">1</span>, vdev-&gt;fops-&gt;owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面方法又封装了一层，转而调用下面的方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\v4l2-core\v4l2-dev.c</span><br><span class="line"><span class="keyword">int</span> __video_register_device(struct video_device *vdev,</span><br><span class="line">                <span class="keyword">enum</span> vfl_devnode_type type,</span><br><span class="line">                <span class="keyword">int</span> nr, <span class="keyword">int</span> warn_if_nr_in_use,</span><br><span class="line">                struct <span class="keyword">module</span> *owner)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">int</span> minor_offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> minor_cnt = VIDEO_NUM_DEVICES;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name_base;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* A minor value of -1 marks this video device as never</span></span><br><span class="line"><span class="comment">       having been registered */</span></span><br><span class="line">    vdev-&gt;minor = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* the release callback MUST be present */</span></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(!vdev-&gt;release))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">/* the v4l2_dev pointer MUST be present */</span></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(!vdev-&gt;v4l2_dev))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* v4l2_fh support */</span></span><br><span class="line">    spin_lock_init(&amp;vdev-&gt;fh_lock);</span><br><span class="line">    INIT_LIST_HEAD(&amp;vdev-&gt;fh_list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 1: check device type */</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_GRABBER:</span><br><span class="line">        name_base = <span class="string">&quot;video&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_VBI:</span><br><span class="line">        name_base = <span class="string">&quot;vbi&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_RADIO:</span><br><span class="line">        name_base = <span class="string">&quot;radio&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_SUBDEV:</span><br><span class="line">        name_base = <span class="string">&quot;v4l-subdev&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_SDR:</span><br><span class="line">        <span class="comment">/* Use device name &#x27;swradio&#x27; because &#x27;sdr&#x27; was already taken. */</span></span><br><span class="line">        name_base = <span class="string">&quot;swradio&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_TOUCH:</span><br><span class="line">        name_base = <span class="string">&quot;v4l-touch&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        pr_err(<span class="string">&quot;%s called with unknown type: %d\n&quot;</span>,</span><br><span class="line">               __func__, type);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vdev-&gt;vfl_type = type;</span><br><span class="line">    vdev-&gt;cdev = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (vdev-&gt;dev_parent == <span class="literal">NULL</span>)</span><br><span class="line">        vdev-&gt;dev_parent = vdev-&gt;v4l2_dev-&gt;dev;</span><br><span class="line">    <span class="keyword">if</span> (vdev-&gt;ctrl_handler == <span class="literal">NULL</span>)</span><br><span class="line">        vdev-&gt;ctrl_handler = vdev-&gt;v4l2_dev-&gt;ctrl_handler;</span><br><span class="line">    <span class="comment">/* If the prio state pointer is NULL, then use the v4l2_device</span></span><br><span class="line"><span class="comment">       prio state. */</span></span><br><span class="line">    <span class="keyword">if</span> (vdev-&gt;prio == <span class="literal">NULL</span>)</span><br><span class="line">        vdev-&gt;prio = &amp;vdev-&gt;v4l2_dev-&gt;prio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 2: find a free minor, device node number and device index. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VIDEO_FIXED_MINOR_RANGES</span></span><br><span class="line">    <span class="comment">/* Keep the ranges for the first four types for historical</span></span><br><span class="line"><span class="comment">     * reasons.</span></span><br><span class="line"><span class="comment">     * Newer devices (not yet in place) should use the range</span></span><br><span class="line"><span class="comment">     * of 128-191 and just pick the first free minor there</span></span><br><span class="line"><span class="comment">     * (new style). */</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_GRABBER:</span><br><span class="line">        minor_offset = <span class="number">0</span>;</span><br><span class="line">        minor_cnt = <span class="number">64</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_RADIO:</span><br><span class="line">        minor_offset = <span class="number">64</span>;</span><br><span class="line">        minor_cnt = <span class="number">64</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> VFL_TYPE_VBI:</span><br><span class="line">        minor_offset = <span class="number">224</span>;</span><br><span class="line">        minor_cnt = <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        minor_offset = <span class="number">128</span>;</span><br><span class="line">        minor_cnt = <span class="number">64</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pick a device node number */</span></span><br><span class="line">    mutex_lock(&amp;videodev_lock);</span><br><span class="line">    nr = devnode_find(vdev, nr == <span class="number">-1</span> ? <span class="number">0</span> : nr, minor_cnt);</span><br><span class="line">    <span class="keyword">if</span> (nr == minor_cnt)</span><br><span class="line">        nr = devnode_find(vdev, <span class="number">0</span>, minor_cnt);</span><br><span class="line">    <span class="keyword">if</span> (nr == minor_cnt) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;could not get a free device node number\n&quot;</span>);</span><br><span class="line">        mutex_unlock(&amp;videodev_lock);</span><br><span class="line">        <span class="keyword">return</span> -ENFILE;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VIDEO_FIXED_MINOR_RANGES</span></span><br><span class="line">    <span class="comment">/* 1-on-1 mapping of device node number to minor number */</span></span><br><span class="line">    i = nr;<span class="comment">//这里保存下空闲的次设备号</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="comment">/* The device node number and minor numbers are independent, so</span></span><br><span class="line"><span class="comment">       we just find the first free minor number. */</span></span><br><span class="line">    <span class="comment">/* 查找到第一个空闲的minor号,可以理解成是次设备号*/</span>   </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; VIDEO_NUM_DEVICES; i++)</span><br><span class="line">        <span class="keyword">if</span> (video_devices[i] == <span class="literal">NULL</span>)<span class="comment">//所有注册的video_device都会保存到这个数组中</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == VIDEO_NUM_DEVICES) &#123;</span><br><span class="line">        mutex_unlock(&amp;videodev_lock);</span><br><span class="line">        pr_err(<span class="string">&quot;could not get a free minor\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENFILE;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">//minor_offset一般是0，i就是查找到的空闲次设备号，这里总的次设备支持到256个</span></span><br><span class="line">    vdev-&gt;minor = i + minor_offset;</span><br><span class="line"><span class="comment">//这里num会保存到session_id中，唯一表示一个任务。一般情况下nr == minor    </span></span><br><span class="line">    vdev-&gt;num = nr;<span class="comment">//将标准位置为已用。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Should not happen since we thought this minor was free */</span></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(video_devices[vdev-&gt;minor])) &#123;</span><br><span class="line">        mutex_unlock(&amp;videodev_lock);</span><br><span class="line">        pr_err(<span class="string">&quot;video_device not empty!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENFILE;</span><br><span class="line">    &#125;</span><br><span class="line">    devnode_set(vdev);</span><br><span class="line">    <span class="comment">/* 下面这个方法字面意思看起来是获取一个index，但是查看源代码会发现</span></span><br><span class="line"><span class="comment">       “这里会去查找不是直系的设备空闲号”，就是说只有video_device不为空，而且v4l2 parent</span></span><br><span class="line"><span class="comment">       对象相同都会认为是同类，直接跳过相应的index号*/</span>    </span><br><span class="line">    vdev-&gt;index = get_index(vdev);</span><br><span class="line"><span class="comment">/* 下面要重点了，这里根据次设备号将当前video_device保存到video_device[]数组中*/</span>    </span><br><span class="line">    video_devices[vdev-&gt;minor] = vdev;</span><br><span class="line">    mutex_unlock(&amp;videodev_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vdev-&gt;ioctl_ops)</span><br><span class="line">        determine_valid_ioctls(vdev);</span><br><span class="line"><span class="comment">/* 分配字符设备文件*/</span></span><br><span class="line">    <span class="comment">/* Part 3: Initialize the character device */</span></span><br><span class="line">    vdev-&gt;cdev = cdev_alloc();</span><br><span class="line">    <span class="keyword">if</span> (vdev-&gt;cdev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;<span class="comment">//务必留意这个ioctl,后面子设备中的ioctl都是通过这里查找的。</span></span><br><span class="line">    vdev-&gt;cdev-&gt;ops = &amp;v4l2_fops;</span><br><span class="line">    vdev-&gt;cdev-&gt;owner = owner;</span><br><span class="line">    ret = cdev_add(vdev-&gt;cdev, MKDEV(VIDEO_MAJOR, vdev-&gt;minor), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: cdev_add failed\n&quot;</span>, __func__);</span><br><span class="line">        kfree(vdev-&gt;cdev);</span><br><span class="line">        vdev-&gt;cdev = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 4: register the device with sysfs */</span></span><br><span class="line">    vdev-&gt;dev.class = &amp;video_class;<span class="comment">//根目录sys中有对应的属性可操作。</span></span><br><span class="line">    vdev-&gt;dev.devt = MKDEV(VIDEO_MAJOR, vdev-&gt;minor);<span class="comment">//主设备号为81</span></span><br><span class="line">    vdev-&gt;dev.parent = vdev-&gt;dev_parent;<span class="comment">//这里一般是v4l2_device对象</span></span><br><span class="line">    dev_set_name(&amp;vdev-&gt;dev, <span class="string">&quot;%s%d&quot;</span>, name_base, vdev-&gt;num);</span><br><span class="line">    ret = device_register(&amp;vdev-&gt;dev);<span class="comment">//注册该video_device到kernel中。</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: device_register failed\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Register the release callback that will be called when the last</span></span><br><span class="line"><span class="comment">       reference to the device goes away. */</span></span><br><span class="line">    vdev-&gt;dev.release = v4l2_device_release;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nr != <span class="number">-1</span> &amp;&amp; nr != vdev-&gt;num &amp;&amp; warn_if_nr_in_use)</span><br><span class="line">        pr_warn(<span class="string">&quot;%s: requested %s%d, got %s\n&quot;</span>, __func__,</span><br><span class="line">            name_base, nr, video_device_node_name(vdev));</span><br><span class="line"><span class="comment">/* 下面这一步很关键，增加v4l2设备对象引用计数*/</span></span><br><span class="line">    <span class="comment">/* Increase v4l2_device refcount */</span></span><br><span class="line">    v4l2_device_get(vdev-&gt;v4l2_dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 5: Register the entity. */</span></span><br><span class="line">    ret = video_register_media_controller(vdev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 6: Activate this minor. The char device can now be used. */</span></span><br><span class="line">    set_bit(V4L2_FL_REGISTERED, &amp;vdev-&gt;flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    mutex_lock(&amp;videodev_lock);</span><br><span class="line">    <span class="keyword">if</span> (vdev-&gt;cdev)</span><br><span class="line">        cdev_del(vdev-&gt;cdev);</span><br><span class="line">    video_devices[vdev-&gt;minor] = <span class="literal">NULL</span>;</span><br><span class="line">    devnode_clear(vdev);</span><br><span class="line">    mutex_unlock(&amp;videodev_lock);</span><br><span class="line">    <span class="comment">/* Mark this video device as never having been registered. */</span></span><br><span class="line">    vdev-&gt;minor = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  由这里可以发现，创建video_device时，也创建了一个字符设备。并将该设备的parent节点指定为v4l2_device所依附的那个节点。主要需要注意下面几点。<br>  *   1.根据设备类型确定设备名字和次设备数量<br>    由于系统可能包含很多媒体设备，所以v4l2核心将0～255次设备编号划分了区域如下所示：其中VFL_TYPE_GRABBER一般表示提供数据的设备如camera.</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>次设备号区间</th>
<th>设备基名称</th>
</tr>
</thead>
<tbody><tr>
<td>VFL_TYPE_GRABBER</td>
<td>0~63</td>
<td>“video”</td>
</tr>
<tr>
<td>VFL_TYPE_VBI</td>
<td>224～255</td>
<td>“vbi”</td>
</tr>
<tr>
<td>VFL_TYPE_RADIO</td>
<td>64~127</td>
<td>“radio”</td>
</tr>
<tr>
<td>其它(含VFL_TYPE_SUBDEV)</td>
<td>128~223</td>
<td>含“v4l-subdev”</td>
</tr>
</tbody></table>
<ul>
<li>2.确定设备编号，注册字符设备驱动。这里我曾今迷糊了,我以为下面这会注册２个设备到kernel中，后来才发现我错了。这是注册字符设备的一种方式。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ret = cdev_add(vdev-&gt;cdev, MKDEV(VIDEO_MAJOR, vdev-&gt;minor), <span class="number">1</span>);</span><br><span class="line">dev_set_name(&amp;vdev-&gt;dev, <span class="string">&quot;%s%d&quot;</span>, name_base, vdev-&gt;num);</span><br><span class="line">ret = device_register(&amp;vdev-&gt;dev);</span><br></pre></td></tr></table></figure>

<ul>
<li>3.确定设备的入口</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Part 5: Register the entity. */</span></span><br><span class="line">ret = video_register_media_controller(vdev);</span><br></pre></td></tr></table></figure>

<h5 id="4-2-2、video在系统中的位置"><a href="#4-2-2、video在系统中的位置" class="headerlink" title="4.2.2、video在系统中的位置"></a>4.2.2、video在系统中的位置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct v4l2_device ------|                      struct video_device   </span><br><span class="line">    |                    |------------引用----------&gt; |----*v4l2_dev</span><br><span class="line">       |                                                |</span><br><span class="line">    |--&gt;ctrlhandler&lt;------------挂载------------------|----ctrl_handler</span><br><span class="line">    |---&gt;media-&gt;entry-list&lt;------------挂载-----------|-----&gt;entry</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-3、media-device-register-多媒体设备注册"><a href="#4-3、media-device-register-多媒体设备注册" class="headerlink" title="4.3、media_device_register()多媒体设备注册"></a>4.3、media_device_register()多媒体设备注册</h4><p>其实这里又用宏转了一下,THIS_MODULE就是代表当前模块的struct module对象，也就代表当前驱动的实例对象。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\include\media\media-device.h</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> media_device_register(mdev) __media_device_register(mdev, THIS_MODULE)</span></span><br><span class="line">__media_device_register(mdev, THIS_MODULE)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\media-device.c</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * media_device_register - register a media device</span></span><br><span class="line"><span class="comment"> * @mdev:    The media device</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The caller is responsible for initializing the media device before</span></span><br><span class="line"><span class="comment"> * registration. The following fields must be set:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - dev must point to the parent device</span></span><br><span class="line"><span class="comment"> * - model must be filled with the device model name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> __must_check __media_device_register(struct media_device *mdev,</span><br><span class="line">                     struct <span class="keyword">module</span> *owner)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;  <span class="keyword">if</span> (WARN_ON(mdev-&gt;dev == <span class="literal">NULL</span> || mdev-&gt;model[<span class="number">0</span>] == <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    mdev-&gt;entity_id = <span class="number">1</span>;</span><br><span class="line">    INIT_LIST_HEAD(&amp;mdev-&gt;entities);</span><br><span class="line">    spin_lock_init(&amp;mdev-&gt;lock);</span><br><span class="line">    mutex_init(&amp;mdev-&gt;graph_mutex);</span><br><span class="line">    <span class="comment">/*上面同样是一些变量的初始化*/</span></span><br><span class="line">    <span class="comment">/* Register the device node. */</span></span><br><span class="line">    mdev-&gt;devnode.fops = &amp;media_device_fops;</span><br><span class="line">    <span class="comment">/*下面是绑定父设备，同上面的v4l2_devcie绑定的是同一个struct devie对象*/</span></span><br><span class="line">    mdev-&gt;devnode.parent = mdev-&gt;dev;</span><br><span class="line">    mdev-&gt;devnode.release = media_device_release;</span><br><span class="line">    ret = media_devnode_register(&amp;mdev-&gt;devnode, owner);</span><br><span class="line">    <span class="comment">//下面可以发现创建了属性文件，我们可以直接通过属性文件来操作这个文件节点。</span></span><br><span class="line">    <span class="comment">//但是可惜的是，在属性接口中只发现了下面这样的代码，只打印了media_device的描述信息。</span></span><br><span class="line">    <span class="comment">//“sprintf(buf, &quot;%.*s\n&quot;, (int)sizeof(mdev-&gt;model), mdev-&gt;model);”</span></span><br><span class="line">    ret = device_create_file(&amp;mdev-&gt;devnode.dev, &amp;dev_attr_model);</span><br><span class="line">    <span class="comment">//省略一些错误检测</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面初始化了一些media_devnode的设备域。便于后续标准接口的调用。紧接着重量级的操作来了，注释部分写的也很精彩。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\media-devnode.c</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * media_devnode_register - register a media device node</span></span><br><span class="line"><span class="comment"> * @mdev: media device node structure we want to register</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The registration code assigns minor numbers and registers the new device node</span></span><br><span class="line"><span class="comment"> * with the kernel. An error is returned if no free minor number can be found,</span></span><br><span class="line"><span class="comment"> * or if the registration of the device node fails.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Zero is returned on success.</span></span><br><span class="line"><span class="comment"> * * Note that if the media_devnode_register call fails, the release() callback of</span></span><br><span class="line"><span class="comment"> * the media_devnode structure is *not* called, so the caller is responsible for</span></span><br><span class="line"><span class="comment"> * freeing any data.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> __must_check <span class="title">media_devnode_register</span><span class="params">(struct media_devnode *mdev,</span></span></span><br><span class="line"><span class="function"><span class="params">                    struct <span class="keyword">module</span> *owner)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> minor;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 1: Find a free minor number */</span></span><br><span class="line">    mutex_lock(&amp;media_devnode_lock);</span><br><span class="line">    <span class="comment">//获取可用的次设备编号。</span></span><br><span class="line">    minor = find_next_zero_bit(media_devnode_nums, MEDIA_NUM_DEVICES, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (minor == MEDIA_NUM_DEVICES) &#123;</span><br><span class="line">        mutex_unlock(&amp;media_devnode_lock);</span><br><span class="line">        pr_err(<span class="string">&quot;could not get a free minor\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENFILE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_bit(minor, media_devnode_nums);</span><br><span class="line">    mutex_unlock(&amp;media_devnode_lock);</span><br><span class="line">    <span class="comment">//注意下面保存了次设备号，便于后续打开设备节点。 </span></span><br><span class="line">    mdev-&gt;minor = minor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 2: Initialize and register the character device */</span></span><br><span class="line">    cdev_init(&amp;mdev-&gt;cdev, &amp;media_devnode_fops);</span><br><span class="line">    mdev-&gt;cdev.owner = owner;</span><br><span class="line"></span><br><span class="line">    ret = cdev_add(&amp;mdev-&gt;cdev, MKDEV(MAJOR(<span class="keyword">media_dev_t</span>), mdev-&gt;minor), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: cdev_add failed\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 3: Register the media device */</span></span><br><span class="line">    mdev-&gt;dev.bus = &amp;media_bus_type;</span><br><span class="line">    mdev-&gt;dev.devt = MKDEV(MAJOR(<span class="keyword">media_dev_t</span>), mdev-&gt;minor);</span><br><span class="line">    mdev-&gt;dev.release = media_devnode_release;</span><br><span class="line">    <span class="keyword">if</span> (mdev-&gt;parent)</span><br><span class="line">        mdev-&gt;dev.parent = mdev-&gt;parent;</span><br><span class="line">    dev_set_name(&amp;mdev-&gt;dev, <span class="string">&quot;media%d&quot;</span>, mdev-&gt;minor);</span><br><span class="line">    ret = device_register(&amp;mdev-&gt;dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;%s: device_register failed\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Part 4: Activate this minor. The char device can now be used. */</span></span><br><span class="line">    set_bit(MEDIA_FLAG_REGISTERED, &amp;mdev-&gt;flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    cdev_del(&amp;mdev-&gt;cdev);</span><br><span class="line">    clear_bit(mdev-&gt;minor, media_devnode_nums);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面代码注册了一个字符设备驱动，上面代码注释可以发现函数分成4部分功能.</p>
<ul>
<li>part1:这一部分功能就是找一个空闲的次设备号。<br>1.MEDIA_NUM_DEVICES:该宏表示系统最大支持256个子设备.<br>2.media_devnode_nums:该全局变量用来表示所有位号是否已经使用了，这里可以理解成这个变量有256位，每一位都是一个标志。例如：我们得到一个次设备号是5，则该变量的第5位就会被置位。</li>
<li>part2:这里会根据主设备号media_dev_t和次设备号，创建字符设备。并将该字符设备的owner赋值为当前模块，然后添加到字符设备集合中。</li>
<li>part3：注册设备</li>
<li>part4：置标志变量，表示该字符设备可以使用了。<h4 id="4-4、rkisp1-register-platform-subdevs"><a href="#4-4、rkisp1-register-platform-subdevs" class="headerlink" title="4.4、rkisp1_register_platform_subdevs"></a>4.4、rkisp1_register_platform_subdevs</h4></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\dev.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rkisp1_register_platform_subdevs</span><span class="params">(struct rkisp1_device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line">    <span class="comment">//此处注册rkisp1-isp-subdev</span></span><br><span class="line">    ret = rkisp1_register_isp_subdev(dev, &amp;dev-&gt;v4l2_dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    <span class="comment">//此处注册rkisp1_mainpath rkisp1_selfpath</span></span><br><span class="line">    ret = rkisp1_register_stream_vdevs(dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err_unreg_isp_subdev;</span><br><span class="line">    <span class="comment">//此处注册rkisp1_dmapath</span></span><br><span class="line">    ret = rkisp1_register_dmarx_vdev(dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err_unreg_stream_vdev;</span><br><span class="line">    <span class="comment">//此处注册rkisp1-statistics</span></span><br><span class="line">    ret = rkisp1_register_stats_vdev(&amp;dev-&gt;stats_vdev, &amp;dev-&gt;v4l2_dev, dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err_unreg_dmarx_vdev;</span><br><span class="line">    <span class="comment">//此处注册rkisp1-input-params</span></span><br><span class="line">    ret = rkisp1_register_params_vdev(&amp;dev-&gt;params_vdev, &amp;dev-&gt;v4l2_dev,</span><br><span class="line">                      dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err_unreg_stats_vdev;</span><br><span class="line"></span><br><span class="line">    ret = isp_subdev_notifier(dev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        v4l2_err(&amp;dev-&gt;v4l2_dev,</span><br><span class="line">             <span class="string">&quot;Failed to register subdev notifier(%d)\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_unreg_params_vdev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-5、rkisp1-register-stream-vdev"><a href="#4-5、rkisp1-register-stream-vdev" class="headerlink" title="4.5、rkisp1_register_stream_vdev"></a>4.5、rkisp1_register_stream_vdev</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\capture.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rkisp1_register_stream_vdev</span><span class="params">(struct rkisp1_stream *stream)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkisp1_device</span> *<span class="title">dev</span> = <span class="title">stream</span>-&gt;<span class="title">ispdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_device</span> *<span class="title">v4l2_dev</span> = &amp;<span class="title">dev</span>-&gt;<span class="title">v4l2_dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">video_device</span> *<span class="title">vdev</span> = &amp;<span class="title">stream</span>-&gt;<span class="title">vnode</span>.<span class="title">vdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkisp1_vdev_node</span> *<span class="title">node</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *vdev_name;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (stream-&gt;id) &#123;</span><br><span class="line">    <span class="keyword">case</span> RKISP1_STREAM_SP:</span><br><span class="line">        vdev_name = SP_VDEV_NAME;</span><br><span class="line">        <span class="keyword">if</span> (dev-&gt;isp_ver == ISP_V10_1)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RKISP1_STREAM_MP:</span><br><span class="line">        vdev_name = MP_VDEV_NAME;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RKISP1_STREAM_RAW:</span><br><span class="line">        vdev_name = RAW_VDEV_NAME;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    strlcpy(vdev-&gt;name, vdev_name, <span class="keyword">sizeof</span>(vdev-&gt;name));</span><br><span class="line">    node = vdev_to_node(vdev);</span><br><span class="line"></span><br><span class="line">    vdev-&gt;ioctl_ops = &amp;rkisp1_v4l2_ioctl_ops;</span><br><span class="line">    vdev-&gt;release = video_device_release_empty;</span><br><span class="line">    vdev-&gt;fops = &amp;rkisp1_fops;</span><br><span class="line">    vdev-&gt;minor = <span class="number">-1</span>;</span><br><span class="line">    vdev-&gt;v4l2_dev = v4l2_dev;</span><br><span class="line">    vdev-&gt;lock = &amp;dev-&gt;apilock;</span><br><span class="line">    <span class="comment">//初始化device_caps = V4L2_CAP_VIDEO_CAPTURE_MPLANE | V4L2_CAP_STREAMING;</span></span><br><span class="line">    <span class="comment">//打开/dev/video0，可通过ioctl(fd, VIDIOC_QUERYCAP, &amp;cap)查询</span></span><br><span class="line">    vdev-&gt;device_caps = V4L2_CAP_VIDEO_CAPTURE_MPLANE |</span><br><span class="line">                V4L2_CAP_STREAMING;</span><br><span class="line">    video_set_drvdata(vdev, stream);</span><br><span class="line">    vdev-&gt;vfl_dir = VFL_DIR_RX;</span><br><span class="line">    node-&gt;pad.flags = MEDIA_PAD_FL_SINK;</span><br><span class="line"></span><br><span class="line">    rkisp_init_vb2_queue(&amp;node-&gt;buf_queue, stream,</span><br><span class="line">                 V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE);</span><br><span class="line">    vdev-&gt;<span class="built_in">queue</span> = &amp;node-&gt;buf_queue;</span><br><span class="line">    <span class="comment">//根据类型注册/dev/video*</span></span><br><span class="line">rk3399_Android10:/ # grep &#x27;&#x27; /sys/class/video4linux/video*/name</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video0</span>/<span class="title">name</span>:</span>rkisp1_mainpath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video1</span>/<span class="title">name</span>:</span>rkisp1_selfpath</span><br><span class="line"></span><br><span class="line">    ret = video_register_device(vdev, VFL_TYPE_GRABBER, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = media_entity_pads_init(&amp;vdev-&gt;entity, <span class="number">1</span>, &amp;node-&gt;pad);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">unreg:</span><br><span class="line">    video_unregister_device(vdev);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-6、rkisp-init-vb2-queue"><a href="#4-6、rkisp-init-vb2-queue" class="headerlink" title="4.6、rkisp_init_vb2_queue"></a>4.6、rkisp_init_vb2_queue</h4><blockquote>
<p>创建并初始化一个vb2_queue结构体 ，</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\common.h</span><br><span class="line"><span class="comment">/* One structure per video node */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rkisp1_vdev_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vb2_queue</span> <span class="title">buf_queue</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">video_device</span> <span class="title">vdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">media_pad</span> <span class="title">pad</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\capture.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rkisp_init_vb2_queue</span><span class="params">(struct vb2_queue *q,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct rkisp1_stream *stream,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">enum</span> v4l2_buf_type buf_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    q-&gt;type = buf_type;  <span class="comment">// 类型</span></span><br><span class="line">    q-&gt;io_modes = VB2_MMAP | VB2_USERPTR | VB2_DMABUF; <span class="comment">//该队列支持的模式</span></span><br><span class="line">    q-&gt;drv_priv = stream;  <span class="comment">// 自定义模式</span></span><br><span class="line">    q-&gt;ops = &amp;rkisp1_vb2_ops;</span><br><span class="line">    q-&gt;mem_ops = &amp;vb2_dma_contig_memops;</span><br><span class="line">    q-&gt;buf_struct_size = <span class="keyword">sizeof</span>(struct rkisp1_buffer);<span class="comment">// 将vb2_buffer结构体封装到我们自己的buffer中，此为我们自己的buffer的size</span></span><br><span class="line">    q-&gt;min_buffers_needed = CIF_ISP_REQ_BUFS_MIN;</span><br><span class="line">    q-&gt;timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;</span><br><span class="line">    q-&gt;lock = &amp;stream-&gt;ispdev-&gt;apilock;</span><br><span class="line">    q-&gt;dev = stream-&gt;ispdev-&gt;dev;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vb2_queue_init(q);</span><br><span class="line">&#125;</span><br><span class="line">其中rkisp1_vb2_ops 是队列的操作函数，以后的REQBUFS 等请求会调用到此中的函数，其结构如下</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">vb2_ops</span> <span class="title">rkisp1_vb2_ops</span> = &#123;</span></span><br><span class="line">    .queue_setup = rkisp1_queue_setup,<span class="comment">// 必须有，vb2_queue_init中会判断</span></span><br><span class="line">    .buf_queue = rkisp1_buf_queue, <span class="comment">// 必须有，vb2_queue_init中会判断</span></span><br><span class="line">    .wait_prepare = vb2_ops_wait_prepare,</span><br><span class="line">    .wait_finish = vb2_ops_wait_finish,</span><br><span class="line">    .stop_streaming = rkisp1_stop_streaming,</span><br><span class="line">    .start_streaming = rkisp1_start_streaming,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">其中vb2_vmalloc_memops用于有关此队列中mem分配问题，其中的函数一般不需要我们自己写，使用默认</span><br><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\common\videobuf2\videobuf2-dma-contig.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vb2_mem_ops</span> <span class="title">vb2_dma_contig_memops</span> = &#123;</span></span><br><span class="line">    .alloc        = vb2_dc_alloc,</span><br><span class="line">    .put        = vb2_dc_put,</span><br><span class="line">    .get_dmabuf    = vb2_dc_get_dmabuf,</span><br><span class="line">    .cookie        = vb2_dc_cookie,</span><br><span class="line">    .vaddr        = vb2_dc_vaddr,</span><br><span class="line">    .mmap        = vb2_dc_mmap,</span><br><span class="line">    .get_userptr    = vb2_dc_get_userptr,</span><br><span class="line">    .put_userptr    = vb2_dc_put_userptr,</span><br><span class="line">    .prepare    = vb2_dc_prepare,</span><br><span class="line">    .finish        = vb2_dc_finish,</span><br><span class="line">    .map_dmabuf    = vb2_dc_map_dmabuf,</span><br><span class="line">    .unmap_dmabuf    = vb2_dc_unmap_dmabuf,</span><br><span class="line">    .attach_dmabuf    = vb2_dc_attach_dmabuf,</span><br><span class="line">    .detach_dmabuf    = vb2_dc_detach_dmabuf,</span><br><span class="line">    .num_users    = vb2_dc_num_users,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<hr>
<h4 id="4-7、判断驱动-probe-状态"><a href="#4-7、判断驱动-probe-状态" class="headerlink" title="4.7、判断驱动 probe 状态"></a>4.7、判断驱动 probe 状态</h4><p>RKISP1 如果 probe 成功，会有 video 及 media 设备存在于/dev/目录下。系统中可能存在多<br>个/dev/video 设备，通过/sys/ 可以查询到 RKISP1 注册的 video 节点</p>
<p>RKISP1 驱动会注册 4 个设备，分别为 selfpath，mainpath，statistics，input-params。<br>其中前两个是用于帧输出， 后两个是用于 3A 的参数设置与统计。通过查找 video4linux 下的 sys<br>节点，我们得到的RKISP1 信息如下表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rk3399_Android10:/ # grep &#x27;&#x27; /sys/class/video4linux/video*/name</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video0</span>/<span class="title">name</span>:</span>rkisp1_mainpath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video1</span>/<span class="title">name</span>:</span>rkisp1_selfpath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video2</span>/<span class="title">name</span>:</span>rkisp1_dmapath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video3</span>/<span class="title">name</span>:</span>rkisp1-statistics</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video4</span>/<span class="title">name</span>:</span>rkisp1-input-params</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video5</span>/<span class="title">name</span>:</span>rkisp1_mainpath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video6</span>/<span class="title">name</span>:</span>rkisp1_selfpath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video7</span>/<span class="title">name</span>:</span>rkisp1_dmapath</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video8</span>/<span class="title">name</span>:</span>rkisp1-statistics</span><br><span class="line">/sys/<span class="class"><span class="keyword">class</span>/<span class="title">video4linux</span>/<span class="title">video9</span>/<span class="title">name</span>:</span>rkisp1-input-params</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/Android.10.Camera.04/RK3399_dev_video.png"><br>Rkisp1 驱动会注册 4 个/dev/video 设备，编号连续。</p>
<ul>
<li>如 RK3399 平台的两个 isp 同时启用，共会注册 8 个/dev/video 设备。前 4 个属于一个<br>isp，后 4 个属于另外一个 isp。软件上尚无法区分两个 isp</li>
</ul>
<p>用户还可以通过 media-ctl，打印拓扑结构查看 pipeline 是否正常。请参考 media-ctl 及拓扑<br>结构。前面已经打印过Topology。</p>
<h3 id="（2）、mipi-dphy-驱动分析"><a href="#（2）、mipi-dphy-驱动分析" class="headerlink" title="（2）、mipi-dphy 驱动分析"></a>（2）、mipi-dphy 驱动分析</h3><h4 id="1、-mipi-dphy-的板级配置"><a href="#1、-mipi-dphy-的板级配置" class="headerlink" title="1、 mipi-dphy 的板级配置"></a>1、 mipi-dphy 的板级配置</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399.dtsi</span><br><span class="line">        mipi_dphy_rx0: mipi-dphy-rx0 &#123;</span><br><span class="line">            compatible = <span class="string">&quot;rockchip,rk3399-mipi-dphy&quot;</span>;</span><br><span class="line">            clocks = &lt;&amp;cru SCLK_MIPIDPHY_REF&gt;,</span><br><span class="line">                &lt;&amp;cru SCLK_DPHY_RX0_CFG&gt;,</span><br><span class="line">                &lt;&amp;cru PCLK_VIO_GRF&gt;;</span><br><span class="line">            clock-names = <span class="string">&quot;dphy-ref&quot;</span>, <span class="string">&quot;dphy-cfg&quot;</span>, <span class="string">&quot;grf&quot;</span>;</span><br><span class="line">            power-domains = &lt;&amp;power RK3399_PD_VIO&gt;;</span><br><span class="line">            status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399-khadas-edge-android.dts</span><br><span class="line">&amp;mipi_dphy_rx0 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ports &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">        <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">        port@<span class="number">0</span> &#123;</span><br><span class="line">            reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">            <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">            <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">            mipi_in_ucam0: endpoint@<span class="number">1</span> &#123;</span><br><span class="line">                reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">                remote-endpoint = &lt;&amp;ucam_out0&gt;;</span><br><span class="line">                data-lanes = &lt;<span class="number">1</span> <span class="number">2</span>&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        port@<span class="number">1</span> &#123;</span><br><span class="line">            reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">            <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">            <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">            dphy_rx0_out: endpoint@<span class="number">0</span> &#123;</span><br><span class="line">                reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                remote-endpoint = &lt;&amp;isp0_mipi_in&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;rkisp1_0 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    port &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="meta-string">&lt;1&gt;;</span></span></span><br><span class="line">        <span class="meta">#size-cells = <span class="meta-string">&lt;0&gt;;</span></span></span><br><span class="line"></span><br><span class="line">        isp0_mipi_in: endpoint@<span class="number">0</span> &#123;</span><br><span class="line">            reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">            remote-endpoint = &lt;&amp;dphy_rx0_out&gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">    imx214b: imx214b@<span class="number">10</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;sony,imx214&quot;</span>;</span><br><span class="line">        status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">        ......</span><br><span class="line">        lens-focus = &lt;&amp;vm149c&gt;;</span><br><span class="line">        port &#123;</span><br><span class="line">            ucam_out0: endpoint &#123;</span><br><span class="line">                remote-endpoint = &lt;&amp;mipi_in_ucam0&gt;;</span><br><span class="line">                <span class="comment">//remote-endpoint = &lt;&amp;mipi_in_ucam1&gt;;</span></span><br><span class="line">                data-lanes = &lt;<span class="number">1</span> <span class="number">2</span>&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;    </span><br></pre></td></tr></table></figure>
<h4 id="2、-mipi-dphy-驱动"><a href="#2、-mipi-dphy-驱动" class="headerlink" title="2、 mipi-dphy 驱动"></a>2、 mipi-dphy 驱动</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\phy\rockchip\phy-rockchip-mipi-rx.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">rockchip_mipidphy_match_id</span>[] = &#123;</span></span><br><span class="line">    ......</span><br><span class="line">    &#123;</span><br><span class="line">        .compatible = <span class="string">&quot;rockchip,rk3399-mipi-dphy&quot;</span>,</span><br><span class="line">        .data = &amp;rk3399_mipidphy_drv_data,</span><br><span class="line">    &#125;,</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_pad_ops</span> <span class="title">mipidphy_subdev_pad_ops</span> = &#123;</span></span><br><span class="line">    .set_fmt = mipidphy_get_set_fmt,</span><br><span class="line">    .get_fmt = mipidphy_get_set_fmt,</span><br><span class="line">    .get_selection = mipidphy_get_selection,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_core_ops</span> <span class="title">mipidphy_core_ops</span> = &#123;</span></span><br><span class="line">    .s_power = mipidphy_s_power,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_video_ops</span> <span class="title">mipidphy_video_ops</span> = &#123;</span></span><br><span class="line">    .g_frame_interval = mipidphy_g_frame_interval,</span><br><span class="line">    .g_mbus_config = mipidphy_g_mbus_config,</span><br><span class="line">    .s_stream = mipidphy_s_stream,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_ops</span> <span class="title">mipidphy_subdev_ops</span> = &#123;</span></span><br><span class="line">    .core = &amp;mipidphy_core_ops,</span><br><span class="line">    .video = &amp;mipidphy_video_ops,</span><br><span class="line">    .pad = &amp;mipidphy_subdev_pad_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_mipidphy_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = &amp;<span class="title">pdev</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev</span> *<span class="title">sd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mipidphy_priv</span> *<span class="title">priv</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">regmap</span> *<span class="title">grf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> *<span class="title">of_id</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dphy_drv_data</span> *<span class="title">drv_data</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    priv = devm_kzalloc(dev, <span class="keyword">sizeof</span>(*priv), GFP_KERNEL);</span><br><span class="line">    of_id = of_match_device(rockchip_mipidphy_match_id, dev);</span><br><span class="line">    grf = syscon_node_to_regmap(dev-&gt;parent-&gt;of_node);</span><br><span class="line">    priv-&gt;regmap_grf = grf;</span><br><span class="line"></span><br><span class="line">    priv-&gt;phy_index = of_alias_get_id(dev-&gt;of_node, <span class="string">&quot;dphy&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (priv-&gt;phy_index &lt; <span class="number">0</span>)</span><br><span class="line">        priv-&gt;phy_index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    drv_data = of_id-&gt;data;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; drv_data-&gt;num_clks; i++) &#123;</span><br><span class="line">        priv-&gt;clks[i] = devm_clk_get(dev, drv_data-&gt;clks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    priv-&gt;grf_regs = drv_data-&gt;grf_regs;</span><br><span class="line">    priv-&gt;txrx_regs = drv_data-&gt;txrx_regs;</span><br><span class="line">    priv-&gt;csiphy_regs = drv_data-&gt;csiphy_regs;</span><br><span class="line">    priv-&gt;drv_data = drv_data;</span><br><span class="line">    <span class="keyword">if</span> (drv_data-&gt;ctl_type == MIPI_DPHY_CTL_CSI_HOST) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//设置stream_on函数</span></span><br><span class="line">        priv-&gt;stream_on = mipidphy_txrx_stream_on;</span><br><span class="line">        priv-&gt;txrx_base_addr = <span class="literal">NULL</span>;</span><br><span class="line">        res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">        priv-&gt;txrx_base_addr = devm_ioremap_resource(dev, res);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(priv-&gt;txrx_base_addr))</span><br><span class="line">            priv-&gt;stream_on = mipidphy_rx_stream_on;</span><br><span class="line">        priv-&gt;stream_off = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sd = &amp;priv-&gt;sd;</span><br><span class="line">    mutex_init(&amp;priv-&gt;mutex);</span><br><span class="line">    <span class="comment">//设置v4l2_subdev_ops </span></span><br><span class="line">    v4l2_subdev_init(sd, &amp;mipidphy_subdev_ops);</span><br><span class="line">    sd-&gt;flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;</span><br><span class="line">    <span class="built_in">snprintf</span>(sd-&gt;name, <span class="keyword">sizeof</span>(sd-&gt;name), <span class="string">&quot;rockchip-mipi-dphy-rx&quot;</span>);</span><br><span class="line">    sd-&gt;dev = dev;</span><br><span class="line"></span><br><span class="line">    platform_set_drvdata(pdev, &amp;sd-&gt;entity);</span><br><span class="line">    <span class="comment">//media_entity_pads_init</span></span><br><span class="line">    <span class="comment">//v4l2_async_register_subdev</span></span><br><span class="line">    ret = rockchip_mipidphy_media_init(priv);</span><br><span class="line">    pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line">    drv_data-&gt;individual_init(priv);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）、VCM驱动"><a href="#（3）、VCM驱动" class="headerlink" title="（3）、VCM驱动"></a>（3）、VCM驱动</h3><h4 id="1、VCM-设备注册-DTS"><a href="#1、VCM-设备注册-DTS" class="headerlink" title="1、VCM 设备注册(DTS)"></a>1、VCM 设备注册(DTS)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399-khadas-edge-android.dts</span><br><span class="line">&amp;i2c6 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    vm149c: vm149c@<span class="number">0</span>c &#123;<span class="comment">// vcm 驱动设置，支持 AF 时需要有这个设置</span></span><br><span class="line">        compatible = <span class="string">&quot;silicon touch,vm149c&quot;</span>;</span><br><span class="line">        status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x0c</span>&gt;;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-index = &lt;<span class="number">0</span>&gt;;<span class="comment">// 模组编号</span></span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-facing = <span class="string">&quot;back&quot;</span>;<span class="comment">// 模组朝向，有&quot;back&quot;和&quot;front&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    imx214b: imx214b@<span class="number">10</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;sony,imx214&quot;</span>;</span><br><span class="line">        status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x10</span>&gt;;</span><br><span class="line">        clocks = &lt;&amp;cru SCLK_CIF_OUT&gt;;</span><br><span class="line">        clock-names = <span class="string">&quot;xvclk&quot;</span>;</span><br><span class="line">        <span class="comment">/* avdd-supply = &lt;&gt;; */</span></span><br><span class="line">        <span class="comment">/* dvdd-supply = &lt;&gt;; */</span></span><br><span class="line">        <span class="comment">/* dovdd-supply = &lt;&gt;; */</span></span><br><span class="line">        <span class="comment">/* reset-gpios = &lt;&gt;; */</span></span><br><span class="line">        pwdn-gpios = &lt;&amp;gpio2 <span class="number">5</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        reset-gpios = &lt;&amp;gpio2 <span class="number">12</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        pinctrl-names = <span class="string">&quot;rockchip,camera_default&quot;</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = &lt;&amp;cif_clkout&gt;;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-index = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-facing = <span class="string">&quot;back&quot;</span>;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-name = <span class="string">&quot;YG9626-S600Y7-C&quot;</span>;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-lens-name = <span class="string">&quot;LG-50013A7&quot;</span>;</span><br><span class="line">        lens-focus = &lt;&amp;vm149c&gt;;<span class="comment">// vcm 驱动设置，支持 AF 时需要有这个设置</span></span><br><span class="line">        port &#123;</span><br><span class="line">            ucam_out0: endpoint &#123;</span><br><span class="line">                remote-endpoint = &lt;&amp;mipi_in_ucam0&gt;;</span><br><span class="line">                <span class="comment">//remote-endpoint = &lt;&amp;mipi_in_ucam1&gt;;</span></span><br><span class="line">                data-lanes = &lt;<span class="number">1</span> <span class="number">2</span>&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;    </span><br></pre></td></tr></table></figure>
<h4 id="2、VCM-驱动说明"><a href="#2、VCM-驱动说明" class="headerlink" title="2、VCM 驱动说明"></a>2、VCM 驱动说明</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\i2c\vm149c.c</span><br><span class="line"><span class="comment">//vm149c_get_ctrl 和 vm149c_set_ctrl 对下面的 control 进行了支持</span></span><br><span class="line"><span class="comment">//V4L2_CID_FOCUS_ABSOLUTE</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_ctrl_ops</span> <span class="title">vm149c_vcm_ctrl_ops</span> = &#123;</span></span><br><span class="line">    .g_volatile_ctrl = vm149c_get_ctrl,</span><br><span class="line">    .s_ctrl = vm149c_set_ctrl,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//目前使用了如下的私有 ioctl 实现马达移动时间信息的查询。</span></span><br><span class="line"><span class="comment">//RK_VIDIOC_VCM_TIMEINFO</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_core_ops</span> <span class="title">vm149c_core_ops</span> = &#123;</span></span><br><span class="line">    .ioctl = vm149c_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_ioctl32 = vm149c_compat_ioctl32</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_ops</span> <span class="title">vm149c_ops</span> = &#123;</span></span><br><span class="line">    .core = &amp;vm149c_core_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vm149c_probe</span><span class="params">(struct i2c_client *client,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> struct i2c_device_id *id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> = <span class="title">of_node_get</span>(<span class="title">client</span>-&gt;<span class="title">dev</span>.<span class="title">of_node</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm149c_device</span> *<span class="title">vm149c_dev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">int</span> current_distance;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> start_current;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rated_current;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> step_mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev</span> *<span class="title">sd</span>;</span></span><br><span class="line">    <span class="keyword">char</span> facing[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;client-&gt;dev, <span class="string">&quot;probing...\n&quot;</span>);</span><br><span class="line">    dev_info(&amp;client-&gt;dev, <span class="string">&quot;driver version: %02x.%02x.%02x&quot;</span>,</span><br><span class="line">        DRIVER_VERSION &gt;&gt; <span class="number">16</span>,</span><br><span class="line">        (DRIVER_VERSION &amp; <span class="number">0xff00</span>) &gt;&gt; <span class="number">8</span>,</span><br><span class="line">        DRIVER_VERSION &amp; <span class="number">0x00ff</span>);</span><br><span class="line">    ......</span><br><span class="line"><span class="comment">//v4l2_i2c_subdev_init，RK VCM 驱动要求 subdev 拥有自己的设</span></span><br><span class="line"><span class="comment">//备节点供用户态 camera_engine 访问，通过该设备节点实现调焦控制；</span></span><br><span class="line">    </span><br><span class="line">    v4l2_i2c_subdev_init(&amp;vm149c_dev-&gt;sd, client, &amp;vm149c_ops);</span><br><span class="line">    vm149c_dev-&gt;sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;</span><br><span class="line">    vm149c_dev-&gt;sd.internal_ops = &amp;vm149c_int_ops;</span><br><span class="line"></span><br><span class="line">    ret = vm149c_init_controls(vm149c_dev);</span><br><span class="line">    ret = media_entity_pads_init(&amp;vm149c_dev-&gt;sd.entity, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    sd = &amp;vm149c_dev-&gt;sd;</span><br><span class="line">    sd-&gt;entity.function = MEDIA_ENT_F_LENS;</span><br><span class="line">    ......</span><br><span class="line">    <span class="built_in">snprintf</span>(sd-&gt;name, <span class="keyword">sizeof</span>(sd-&gt;name), <span class="string">&quot;m%02d_%s_%s %s&quot;</span>,</span><br><span class="line">         vm149c_dev-&gt;module_index, facing,</span><br><span class="line">         VM149C_NAME, dev_name(sd-&gt;dev));</span><br><span class="line">    ret = v4l2_async_register_subdev(sd);</span><br><span class="line">    ......</span><br><span class="line">    dev_info(&amp;client-&gt;dev, <span class="string">&quot;probing successful\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vm149c_init_controls</span><span class="params">(struct vm149c_device *dev_vcm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_ctrl_handler</span> *<span class="title">hdl</span> = &amp;<span class="title">dev_vcm</span>-&gt;<span class="title">ctrls_vcm</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_ctrl_ops</span> *<span class="title">ops</span> = &amp;<span class="title">vm149c_vcm_ctrl_ops</span>;</span></span><br><span class="line"></span><br><span class="line">    v4l2_ctrl_handler_init(hdl, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    v4l2_ctrl_new_std(hdl, ops, V4L2_CID_FOCUS_ABSOLUTE,</span><br><span class="line">              <span class="number">0</span>, VCMDRV_MAX_LOG, <span class="number">1</span>, VCMDRV_MAX_LOG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hdl-&gt;error)</span><br><span class="line">        dev_err(dev_vcm-&gt;sd.dev, <span class="string">&quot;%s fail error: 0x%x\n&quot;</span>,</span><br><span class="line">            __func__, hdl-&gt;error);</span><br><span class="line">    dev_vcm-&gt;sd.ctrl_handler = hdl;</span><br><span class="line">    <span class="keyword">return</span> hdl-&gt;error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_mipidphy_media_init</span><span class="params">(struct mipidphy_priv *priv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    priv-&gt;pads[MIPI_DPHY_RX_PAD_SOURCE].flags =</span><br><span class="line">        MEDIA_PAD_FL_SOURCE | MEDIA_PAD_FL_MUST_CONNECT;</span><br><span class="line">    priv-&gt;pads[MIPI_DPHY_RX_PAD_SINK].flags =</span><br><span class="line">        MEDIA_PAD_FL_SINK | MEDIA_PAD_FL_MUST_CONNECT;</span><br><span class="line">    priv-&gt;sd.entity.function = MEDIA_ENT_F_VID_IF_BRIDGE;</span><br><span class="line">    ret = media_entity_pads_init(&amp;priv-&gt;sd.entity,</span><br><span class="line">                MIPI_DPHY_RX_PADS_NUM, priv-&gt;pads);</span><br><span class="line">    ......</span><br><span class="line">    ret = v4l2_async_notifier_parse_fwnode_endpoints_by_port(</span><br><span class="line">        priv-&gt;dev, &amp;priv-&gt;notifier,</span><br><span class="line">        <span class="keyword">sizeof</span>(struct sensor_async_subdev), <span class="number">0</span>,</span><br><span class="line">        rockchip_mipidphy_fwnode_parse);</span><br><span class="line">    ......</span><br><span class="line">    priv-&gt;sd.subdev_notifier = &amp;priv-&gt;notifier;</span><br><span class="line">    priv-&gt;notifier.ops = &amp;rockchip_mipidphy_async_ops;</span><br><span class="line">    ret = v4l2_async_subdev_notifier_register(&amp;priv-&gt;sd, &amp;priv-&gt;notifier);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> v4l2_async_register_subdev(&amp;priv-&gt;sd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="（4）、imx214驱动分析"><a href="#（4）、imx214驱动分析" class="headerlink" title="（4）、imx214驱动分析"></a>（4）、imx214驱动分析</h3><p>Camera Sensor 采用 I2C 与主控进行交互，目前 sensor driver 按照 I2C 设备驱动方式实现，sensor driver 同时采用 v4l2 subdev 的方式实现与 host driver 之间的交互。</p>
<p>Sensor 驱动位于 drivers/media/i2c 目录下，注意到本章节所描述的是具有 mediacontroller 属性的 sensor 驱动， 故 drivers/media/i2c/soc_camera 目录下的驱动并不适用。在 Media Controller 结构下， Sensor 一般作为 sub-device 并通过 pad 与 cif、isp 或者mipi phy 链接在一起。本章主要介绍 Sensor 驱动的代码[1]， dts 配置，及如何验证 sensor 驱动的正确性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\arch\arm64\boot\dts\rockchip\rk3399-khadas-edge-android.dts</span><br><span class="line">    imx214b: imx214b@<span class="number">10</span> &#123;</span><br><span class="line">        compatible = <span class="string">&quot;sony,imx214&quot;</span>;</span><br><span class="line">        status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x10</span>&gt;;</span><br><span class="line">        clocks = &lt;&amp;cru SCLK_CIF_OUT&gt;;</span><br><span class="line">        clock-names = <span class="string">&quot;xvclk&quot;</span>;</span><br><span class="line">        <span class="comment">/* avdd-supply = &lt;&gt;; */</span></span><br><span class="line">        <span class="comment">/* dvdd-supply = &lt;&gt;; */</span></span><br><span class="line">        <span class="comment">/* dovdd-supply = &lt;&gt;; */</span></span><br><span class="line">        <span class="comment">/* reset-gpios = &lt;&gt;; */</span></span><br><span class="line">        pwdn-gpios = &lt;&amp;gpio2 <span class="number">5</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        reset-gpios = &lt;&amp;gpio2 <span class="number">12</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        pinctrl-names = <span class="string">&quot;rockchip,camera_default&quot;</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = &lt;&amp;cif_clkout&gt;;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-index = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-facing = <span class="string">&quot;back&quot;</span>;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-name = <span class="string">&quot;YG9626-S600Y7-C&quot;</span>;</span><br><span class="line">        rockchip,camera-<span class="keyword">module</span>-lens-name = <span class="string">&quot;LG-50013A7&quot;</span>;</span><br><span class="line">        lens-focus = &lt;&amp;vm149c&gt;;</span><br><span class="line">        port &#123;</span><br><span class="line">            ucam_out0: endpoint &#123;</span><br><span class="line">                remote-endpoint = &lt;&amp;mipi_in_ucam0&gt;;</span><br><span class="line">                <span class="comment">//remote-endpoint = &lt;&amp;mipi_in_ucam1&gt;;</span></span><br><span class="line">                data-lanes = &lt;<span class="number">1</span> <span class="number">2</span>&gt;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Pinctrl，声明了必要的 pinctrl， 该例子中包括了 reset pin 初始化和 clk iomux</p>
<ul>
<li>Clock，指定名称为 xvclk（驱动会讯取名为 xvclk 的 clock），即 24M 时钟</li>
<li>Vdd supply</li>
<li>Port 子节点，定义了一个 endpoint，声明需要与 mipi_in_wcam 建立连接。同样地 mipi<br>dphy 会引用 ucam_out0</li>
<li>Data-lanes 指定了 imx214 使用两个 lane</li>
</ul>
<p>本章将 Sensor 驱动的开发移植概括为 5 个部分，</p>
<ul>
<li>按照 datasheet 编写上电时序， 主要包括 vdd，reset，powerdown，clk 等。</li>
<li>配置 sensor 的寄存器以输出所需的分辨率、格式。</li>
<li>编写 struct v4l2_subdev_ops 所需要的回调函数，一般包括 set_fmt，get_fmt，imx214_s_stream</li>
<li>增加 v4l2 controller 用来设置如 fps，exposure，gain，test pattern</li>
<li>编写.probe()函数，并添加 media control 及 v4l2 sub device 初始化代码作为良好的习惯，完成驱动编码后，也需要增加相应的 Documentation，可以参考Documentation/devicetree/bindings/media/i2c/。这样板级 dts 可以根据该文档快速配置。在板级 dts 中，引用 Sensor 驱动，一般需要</li>
<li>配置正确的 clk，io mux</li>
<li>根据原理图设置上电时序所需要的 regulator 及 gpio</li>
<li>增加 port 子节点，与 cif 或者 isp 建立连接</li>
</ul>
<p>本章以im214为例，简单分析 Sensor 驱动。</p>
<h4 id="1、上电时序"><a href="#1、上电时序" class="headerlink" title="1、上电时序"></a>1、上电时序</h4><p>不同 Sensor 对上电时序要求不同，例如 OV Camera。可能很大部分的 OV Camera 对时序要求不严格，只要 mclk，vdd，reset 或 powerdown 状态是对的，就能正确进行 I2C 通讯并输出图片。但还是有小部分 Sensor 对上电要求非常严格。在 Sensor 厂家提供的 DataSheet 中，一般会有上电时序图，只需要按顺序配置即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\i2c\imx214.c</span><br><span class="line">static int __imx214_power_on(struct imx214 *imx214)</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line">    u32 delay_us;</span><br><span class="line">    struct device *dev &#x3D; &amp;imx214-&gt;client-&gt;dev;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;imx214-&gt;client-&gt;dev, &quot;%s(%d) enter!\n&quot;, __func__, __LINE__);</span><br><span class="line">    printk(&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); &#x2F;&#x2F;zhoujinjian</span><br><span class="line">......</span><br><span class="line">    ret &#x3D; clk_set_rate(imx214-&gt;xvclk, IMX214_XVCLK_FREQ);</span><br><span class="line">......</span><br><span class="line">    ret &#x3D; clk_prepare_enable(imx214-&gt;xvclk);</span><br><span class="line">......</span><br><span class="line">    ret &#x3D; regulator_bulk_enable(IMX214_NUM_SUPPLIES, imx214-&gt;supplies);</span><br><span class="line">......</span><br><span class="line">    if (!IS_ERR(imx214-&gt;reset_gpio))</span><br><span class="line">        gpiod_set_value_cansleep(imx214-&gt;reset_gpio, 0);</span><br><span class="line"></span><br><span class="line">    usleep_range(500, 1000);</span><br><span class="line">    if (!IS_ERR(imx214-&gt;pwdn_gpio))</span><br><span class="line">        gpiod_set_value_cansleep(imx214-&gt;pwdn_gpio, 1);</span><br><span class="line">    usleep_range(500, 1000);</span><br><span class="line">......</span><br><span class="line">    delay_us &#x3D; imx214_cal_delay(8192);</span><br><span class="line">    usleep_range(delay_us, delay_us * 2);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>imx214 的上电时序简要说明如下，</p>
<ul>
<li>首先提供 xvclk(即 mclk)</li>
<li>紧接着 reset pin 使能</li>
<li>各路的 vdd 上电。这里使用了 regulator_bulk，因为 vdd, vodd, avdd 三者无严格顺序。如果 vdd 之间有严格的要求，需要分开处理，可参考 OV2685 驱动代码</li>
<li>Vdd 上电后， 取消 Sensor Reset，powerdown 状态。Reset, powerdown 可能只需要一个，Sensor 封装不同， 可能有差异</li>
<li>最后按时序要求，需要 8192 个 clk cycle 之后，上电才算完成。<br>注意，虽然不按 datasheet 要求上电许多 Sensor 也能正常工作，但按原厂建议的时序操作，无疑是最可靠的。同样，datasheet 中还会有下电时序(Power Down Sequence)，也同样按要求即可。</li>
</ul>
<p>在.probe()阶段会去尝试读取 chip id，如 imx214的imx214_check_sensor_id()，够正确读取到 chip id，一般就认为上电时序正确，Sensor 能够正常进行 i2c 通信。</p>
<h4 id="2、Sensor-初始化寄存器列表"><a href="#2、Sensor-初始化寄存器列表" class="headerlink" title="2、Sensor 初始化寄存器列表"></a>2、Sensor 初始化寄存器列表</h4><p>在imx214 中，各定义了struct imx214_mode ，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\i2c\imx214.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">imx214_mode</span> <span class="title">supported_modes</span>[] = &#123;</span></span><br><span class="line">    &#123;</span><br><span class="line">        .width = <span class="number">4208</span>,</span><br><span class="line">        .height = <span class="number">3120</span>,</span><br><span class="line">        .max_fps = &#123;</span><br><span class="line">            .numerator = <span class="number">10000</span>,</span><br><span class="line">            .denominator = <span class="number">150000</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .exp_def = <span class="number">0x0c70</span>,</span><br><span class="line">        .hts_def = <span class="number">0x1390</span>,</span><br><span class="line">        .vts_def = <span class="number">0x0c7a</span>,</span><br><span class="line">        .reg_list = imx214_4208x3120_regs,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .width = <span class="number">2104</span>,</span><br><span class="line">        .height = <span class="number">1560</span>,</span><br><span class="line">        .max_fps = &#123;</span><br><span class="line">            .numerator = <span class="number">10000</span>,</span><br><span class="line">            .denominator = <span class="number">300000</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        .exp_def = <span class="number">0x0630</span>,</span><br><span class="line">        .hts_def = <span class="number">0x1390</span>,</span><br><span class="line">        .vts_def = <span class="number">0x0640</span>,</span><br><span class="line">        .reg_list = imx214_2104x1560_regs,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>用来表示 sensor 不同的初始化 mode。Mode 可以包括如分辨率，mbus code，寄存器初始化列表等。寄存器初始化列表，请按厂家提供的直接填入即可。需要注意的是， 列表最后用了 REG_NULL表示结束</p>
<h4 id="3、-V4l2-subdev-ops-回调函数"><a href="#3、-V4l2-subdev-ops-回调函数" class="headerlink" title="3、 V4l2_subdev_ops 回调函数"></a>3、 V4l2_subdev_ops 回调函数</h4><p>V4l2_subdev_ops 回调函数是 Sensor 驱动中逻辑控制的核心。回调函数包括非常多的功能，具体可以查看 kernel 代码 include/media/v4l2-subdev.h。建议 Sensor 驱动至少包括如下回调函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\i2c\imx214.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> <span class="title">imx214_pm_ops</span> = &#123;</span></span><br><span class="line">    SET_RUNTIME_PM_OPS(imx214_runtime_suspend,</span><br><span class="line">        imx214_runtime_resume, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_VIDEO_V4L2_SUBDEV_API</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_internal_ops</span> <span class="title">imx214_internal_ops</span> = &#123;</span></span><br><span class="line">    .open = imx214_open,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_core_ops</span> <span class="title">imx214_core_ops</span> = &#123;</span></span><br><span class="line">    .s_power = imx214_s_power,</span><br><span class="line">    .ioctl = imx214_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_ioctl32 = imx214_compat_ioctl32,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_video_ops</span> <span class="title">imx214_video_ops</span> = &#123;</span></span><br><span class="line">    .s_stream = imx214_s_stream,</span><br><span class="line">    .g_frame_interval = imx214_g_frame_interval,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_pad_ops</span> <span class="title">imx214_pad_ops</span> = &#123;</span></span><br><span class="line">    .enum_mbus_code = imx214_enum_mbus_code,</span><br><span class="line">    .enum_frame_size = imx214_enum_frame_sizes,</span><br><span class="line">    .enum_frame_interval = imx214_enum_frame_interval,</span><br><span class="line">    .get_fmt = imx214_get_fmt,</span><br><span class="line">    .set_fmt = imx214_set_fmt,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_subdev_ops</span> <span class="title">imx214_subdev_ops</span> = &#123;</span></span><br><span class="line">    .core    = &amp;imx214_core_ops,</span><br><span class="line">    .video    = &amp;imx214_video_ops,</span><br><span class="line">    .pad    = &amp;imx214_pad_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>.open，这样上层才可以打开/dev/v4l-subdev?节点。在上层需要单独对 sensor 设置 v4l control 时，.open()是必须实现的</li>
<li>.s_stream，即 set stream，包括 stream on 和 stream off，一般在这里配置寄存器，使其输出图像</li>
<li>.enum_mbus_code，枚举驱动支持的 mbus_code</li>
<li>.enum_frame_size，枚举驱动支持的分辨率</li>
<li>.get_fmt，返回当前 Sensor 选中的 format/size。如果.get_fmt 缺失，media-ctl 工具无法查看 sensor entity 当前配置的 fmt</li>
<li>.set_fmt，设置 Sensor 的 format/size以上回调中， </li>
<li>.s_stream stream_on 会比较复杂些。在 imx214驱动代码中，它包括pm_runtime 使能（即唤醒并上电），配置 control 信息（v4l2 control 可能会在 sensor 下电时配置）即 v4l2_ctrl_handler_setup()，并最终写入寄存器 stream on。</li>
</ul>
<h4 id="4、-V4l2-controller"><a href="#4、-V4l2-controller" class="headerlink" title="4、 V4l2 controller"></a>4、 V4l2 controller</h4><p>对于需要配置 fps，exposure, gain, blanking 的场景，v4l2 controller 部分是必要的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\i2c\imx214.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_ctrl_ops</span> <span class="title">imx214_ctrl_ops</span> = &#123;</span></span><br><span class="line">    .s_ctrl = imx214_set_ctrl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">imx214_initialize_controls</span><span class="params">(struct imx214 *imx214)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">imx214_mode</span> *<span class="title">mode</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_ctrl_handler</span> *<span class="title">handler</span>;</span></span><br><span class="line">    s64 exposure_max, vblank_def;</span><br><span class="line">    u32 h_blank;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    handler = &amp;imx214-&gt;ctrl_handler;</span><br><span class="line">    mode = imx214-&gt;cur_mode;</span><br><span class="line">    ret = v4l2_ctrl_handler_init(handler, <span class="number">8</span>);</span><br><span class="line">    ......</span><br><span class="line">    handler-&gt;lock = &amp;imx214-&gt;mutex;</span><br><span class="line"></span><br><span class="line">    imx214-&gt;link_freq = v4l2_ctrl_new_int_menu(handler, <span class="literal">NULL</span>,</span><br><span class="line">        V4L2_CID_LINK_FREQ, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">        link_freq_menu_items);</span><br><span class="line"></span><br><span class="line">    imx214-&gt;pixel_rate_ctrl = v4l2_ctrl_new_std(handler, <span class="literal">NULL</span>,</span><br><span class="line">        V4L2_CID_PIXEL_RATE, <span class="number">0</span>, IMX214_PIXEL_RATE_FULL_SIZE,</span><br><span class="line">        <span class="number">1</span>, IMX214_PIXEL_RATE_FULL_SIZE);</span><br><span class="line"></span><br><span class="line">    h_blank = mode-&gt;hts_def - mode-&gt;width;</span><br><span class="line">    imx214-&gt;hblank = v4l2_ctrl_new_std(handler, <span class="literal">NULL</span>,</span><br><span class="line">        V4L2_CID_HBLANK, h_blank, h_blank, <span class="number">1</span>, h_blank);</span><br><span class="line">    <span class="keyword">if</span> (imx214-&gt;hblank)</span><br><span class="line">        imx214-&gt;hblank-&gt;flags |= V4L2_CTRL_FLAG_READ_ONLY;</span><br><span class="line"></span><br><span class="line">    vblank_def = mode-&gt;vts_def - mode-&gt;height;</span><br><span class="line">    imx214-&gt;vblank = v4l2_ctrl_new_std(handler, &amp;imx214_ctrl_ops,</span><br><span class="line">        V4L2_CID_VBLANK, vblank_def,</span><br><span class="line">        IMX214_VTS_MAX - mode-&gt;height,</span><br><span class="line">        <span class="number">1</span>, vblank_def);</span><br><span class="line"></span><br><span class="line">    exposure_max = mode-&gt;vts_def - <span class="number">4</span>;</span><br><span class="line">    imx214-&gt;exposure = v4l2_ctrl_new_std(handler, &amp;imx214_ctrl_ops,</span><br><span class="line">        V4L2_CID_EXPOSURE, IMX214_EXPOSURE_MIN,</span><br><span class="line">        exposure_max, IMX214_EXPOSURE_STEP,</span><br><span class="line">        mode-&gt;exp_def);</span><br><span class="line"></span><br><span class="line">    imx214-&gt;anal_gain = v4l2_ctrl_new_std(handler, &amp;imx214_ctrl_ops,</span><br><span class="line">        V4L2_CID_ANALOGUE_GAIN, IMX214_GAIN_MIN,</span><br><span class="line">        IMX214_GAIN_MAX, IMX214_GAIN_STEP,</span><br><span class="line">        IMX214_GAIN_DEFAULT);</span><br><span class="line"></span><br><span class="line">    imx214-&gt;test_pattern = v4l2_ctrl_new_std_menu_items(handler,</span><br><span class="line">        &amp;imx214_ctrl_ops, V4L2_CID_TEST_PATTERN,</span><br><span class="line">        ARRAY_SIZE(imx214_test_pattern_menu) - <span class="number">1</span>,</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, imx214_test_pattern_menu);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler-&gt;error) &#123;</span><br><span class="line">        ret = handler-&gt;error;</span><br><span class="line">        dev_err(&amp;imx214-&gt;client-&gt;dev,</span><br><span class="line">            <span class="string">&quot;Failed to init controls(%d)\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> err_free_handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    imx214-&gt;subdev.ctrl_handler = handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>imx214_initialize_controls()，用来声明支持哪些 control，并设置最大最小值等信息</li>
<li>Struct v4l2_ctrl_ops，包含了 imx214_set_ctrl()回调函数，用以响应上层的设置。</li>
</ul>
<h4 id="5、Probe-函数及注册-media-entity-v4l2-subdev"><a href="#5、Probe-函数及注册-media-entity-v4l2-subdev" class="headerlink" title="5、Probe 函数及注册 media entity, v4l2 subdev"></a>5、Probe 函数及注册 media entity, v4l2 subdev</h4><p>Probe 函数中， 首先对 dts 进行解析，获取 regulator, gpio, clk 等信息用以对 sensor 上下电。其次注册 media entity, v4l2 subdev，及 v4l2 controller 信息。注意到 v4l2 subdev 的注册是异步。如下几个关键的函数调用。</p>
<ul>
<li>v4l2_i2c_subdev_init(), 注册为一个 v4l2 subdev，参数中提供回调函数</li>
<li>imx214_initialize_controls()，初始化 v4l2 controls</li>
<li>media_entity_pads_init()，注册成为一个 media entity，imx214 仅有一个输出，即 SourcePad</li>
<li>v4l2_async_register_subdev()，声明 sensor 需要异步注册。因为 RKISP1 及 CIF 都采用异步注册 </li>
</ul>
<p>随 Linux SDK 发布的，还有一个 rkisp-demo， 位于 F:\Khadas_Edge_Android_Q\hardware\rockchip\camera_engine_rkisp\tests\rkisp_demo\rkisp_demo.cpp。该 demo 极简单<br>地使用了 v4l2 接口配置设备。请直接参考源码即可。</p>
<h2 id="（三）、Camera-Buffer-Flow"><a href="#（三）、Camera-Buffer-Flow" class="headerlink" title="（三）、Camera Buffer Flow"></a>（三）、Camera Buffer Flow</h2><p>当ISP1准备好数据后，就会发生中断调用mi_frame_end 。调用vb2_buffer_done，应用app就可以dqbuf获取camera数据了，<br>并且update_mi更新下一个buffer 的地址给memory interface，如此反复循环。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289285</span>] Hardware name: Khadas,edge (DT)</span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289335</span>] Call trace:</span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289373</span>]  dump_backtrace+<span class="number">0x0</span>/<span class="number">0x178</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289415</span>]  show_stack+<span class="number">0x14</span>/<span class="number">0x20</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289463</span>]  dump_stack+<span class="number">0x94</span>/<span class="number">0xb4</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289508</span>]  vb2_buffer_done+<span class="number">0x25c</span>/<span class="number">0x2c0</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289560</span>]  mi_frame_end+<span class="number">0x118</span>/<span class="number">0x248</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289618</span>]  rkisp1_mi_isr+<span class="number">0xe4</span>/<span class="number">0x118</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289664</span>]  rkisp1_irq_handler+<span class="number">0xa4</span>/<span class="number">0xd8</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289713</span>]  __handle_irq_event_percpu+<span class="number">0x6c</span>/<span class="number">0x2a0</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289766</span>]  handle_irq_event_percpu+<span class="number">0x34</span>/<span class="number">0x88</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289811</span>]  handle_irq_event+<span class="number">0x48</span>/<span class="number">0x78</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289862</span>]  handle_fasteoi_irq+<span class="number">0xac</span>/<span class="number">0x188</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289916</span>]  generic_handle_irq+<span class="number">0x24</span>/<span class="number">0x38</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289957</span>]  __handle_domain_irq+<span class="number">0x5c</span>/<span class="number">0xb8</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.289978</span>]  gic_handle_irq+<span class="number">0xc4</span>/<span class="number">0x178</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290011</span>]  el1_irq+<span class="number">0xe8</span>/<span class="number">0x198</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290064</span>]  __do_softirq+<span class="number">0x9c</span>/<span class="number">0x340</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290111</span>]  irq_exit+<span class="number">0xcc</span>/<span class="number">0xd8</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290165</span>]  __handle_domain_irq+<span class="number">0x60</span>/<span class="number">0xb8</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290204</span>]  gic_handle_irq+<span class="number">0xc4</span>/<span class="number">0x178</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290236</span>]  el1_irq+<span class="number">0xe8</span>/<span class="number">0x198</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290273</span>]  cpuidle_enter_state+<span class="number">0xb4</span>/<span class="number">0x3c8</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290308</span>]  cpuidle_enter+<span class="number">0x18</span>/<span class="number">0x20</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290343</span>]  call_cpuidle+<span class="number">0x18</span>/<span class="number">0x30</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290366</span>]  do_idle+<span class="number">0x214</span>/<span class="number">0x278</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290401</span>]  cpu_startup_entry+<span class="number">0x20</span>/<span class="number">0x28</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290436</span>]  rest_init+<span class="number">0xcc</span>/<span class="number">0xd8</span></span><br><span class="line">[<span class="number">2021</span>/<span class="number">6</span>/<span class="number">17</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">50</span>] [  <span class="number">127.290474</span>]  start_kernel+<span class="number">0x4c0</span>/<span class="number">0x4ec</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\kernel\drivers\media\platform\rockchip\isp1\capture.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mi_frame_end</span><span class="params">(struct rkisp1_stream *stream)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkisp1_device</span> *<span class="title">isp_dev</span> = <span class="title">stream</span>-&gt;<span class="title">ispdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkisp1_isp_subdev</span> *<span class="title">isp_sd</span> = &amp;<span class="title">isp_dev</span>-&gt;<span class="title">isp_sdev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">capture_fmt</span> *<span class="title">isp_fmt</span> = &amp;<span class="title">stream</span>-&gt;<span class="title">out_isp_fmt</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> interlaced = stream-&gt;interlaced;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> lock_flags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stream-&gt;curr_buf &amp;&amp;</span><br><span class="line">        (!interlaced ||</span><br><span class="line">        (stream-&gt;u.sp.field_rec == RKISP_FIELD_ODD &amp;&amp;</span><br><span class="line">        stream-&gt;u.sp.field == RKISP_FIELD_EVEN))) &#123;</span><br><span class="line">        u64 ns = ktime_get_ns();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Dequeue a filled buffer */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; isp_fmt-&gt;mplanes; i++) &#123;</span><br><span class="line">            u32 payload_size =</span><br><span class="line">                stream-&gt;out_fmt.plane_fmt[i].sizeimage;</span><br><span class="line">            vb2_set_plane_payload(</span><br><span class="line">                &amp;stream-&gt;curr_buf-&gt;vb.vb2_buf, i,</span><br><span class="line">                payload_size);</span><br><span class="line">        &#125;</span><br><span class="line">        stream-&gt;curr_buf-&gt;vb.sequence =</span><br><span class="line">                atomic_read(&amp;isp_sd-&gt;frm_sync_seq) - <span class="number">1</span>;</span><br><span class="line">        stream-&gt;curr_buf-&gt;vb.vb2_buf.timestamp = ns;</span><br><span class="line">        vb2_buffer_done(&amp;stream-&gt;curr_buf-&gt;vb.vb2_buf,</span><br><span class="line">                VB2_BUF_STATE_DONE);</span><br><span class="line">        stream-&gt;curr_buf = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!interlaced ||</span><br><span class="line">        (stream-&gt;curr_buf == stream-&gt;next_buf &amp;&amp;</span><br><span class="line">        stream-&gt;u.sp.field == RKISP_FIELD_ODD)) &#123;</span><br><span class="line">        <span class="comment">/* Next frame is writing to it</span></span><br><span class="line"><span class="comment">         * Interlaced: odd field next buffer address</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        stream-&gt;curr_buf = stream-&gt;next_buf;</span><br><span class="line">        stream-&gt;next_buf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set up an empty buffer for the next-next frame */</span></span><br><span class="line">        spin_lock_irqsave(&amp;stream-&gt;vbq_lock, lock_flags);</span><br><span class="line">        <span class="keyword">if</span> (!list_empty(&amp;stream-&gt;buf_queue)) &#123;</span><br><span class="line">            stream-&gt;next_buf =</span><br><span class="line">                list_first_entry(&amp;stream-&gt;buf_queue,</span><br><span class="line">                         struct rkisp1_buffer,</span><br><span class="line">                         <span class="built_in">queue</span>);</span><br><span class="line">            list_del(&amp;stream-&gt;next_buf-&gt;<span class="built_in">queue</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        spin_unlock_irqrestore(&amp;stream-&gt;vbq_lock, lock_flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stream-&gt;u.sp.field_rec == RKISP_FIELD_ODD &amp;&amp;</span><br><span class="line">        stream-&gt;u.sp.field == RKISP_FIELD_EVEN) &#123;</span><br><span class="line">        <span class="comment">/* Interlaced: event field next buffer address */</span></span><br><span class="line">        <span class="keyword">if</span> (stream-&gt;next_buf) &#123;</span><br><span class="line">            stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_Y] +=</span><br><span class="line">                stream-&gt;u.sp.vir_offs;</span><br><span class="line">            stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_CB] +=</span><br><span class="line">                stream-&gt;u.sp.vir_offs;</span><br><span class="line">            stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_CR] +=</span><br><span class="line">                stream-&gt;u.sp.vir_offs;</span><br><span class="line">        &#125;</span><br><span class="line">        stream-&gt;curr_buf = stream-&gt;next_buf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stream-&gt;ops-&gt;update_mi(stream);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interlaced)</span><br><span class="line">        stream-&gt;u.sp.field_rec = stream-&gt;u.sp.field;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Update buffer info to memory interface, it&#x27;s called in interrupt */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update_mi</span><span class="params">(struct rkisp1_stream *stream)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rkisp1_dummy_buffer</span> *<span class="title">dummy_buf</span> = &amp;<span class="title">stream</span>-&gt;<span class="title">dummy_buf</span>;</span></span><br><span class="line">    printk(<span class="string">&quot;zjj.android10.kernel.camera || %s %s %d \n&quot;</span>,</span><br><span class="line">        __FUNCTION__, __FILE__, __LINE__); <span class="comment">//zhoujinjian</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The dummy space allocated by dma_alloc_coherent is used, we can</span></span><br><span class="line"><span class="comment">     * throw data to it if there is no available buffer.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (stream-&gt;next_buf) &#123;</span><br><span class="line">        <span class="comment">//NV12中,U和V就交错排布的。看到内存中的排布很清楚，先开始都是Y，之后的都是U1V1U2V2的交错式排布。</span></span><br><span class="line">        <span class="comment">//https://blog.csdn.net/byhook/article/details/84037338</span></span><br><span class="line">        <span class="comment">//以 4 X 4 图片为例子，占用内存为 4 X 4 X 3 / 2 = 24 个字节,Y存储, mWidth:1280, mHeight:960</span></span><br><span class="line">        printk(<span class="string">&quot;zjj.android10.kernel.camera RKISP1_PLANE_Y : 0x%08lx \n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_Y]);    </span><br><span class="line">        printk(<span class="string">&quot;zjj.android10.kernel.camera RKISP1_PLANE_CB: 0x%08lx \n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_CB]);    </span><br><span class="line">        printk(<span class="string">&quot;zjj.android10.kernel.camera RKISP1_PLANE_CR: 0x%08lx \n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_CR]);    </span><br><span class="line"></span><br><span class="line">        mi_set_y_addr(stream,</span><br><span class="line">            stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_Y]);</span><br><span class="line">        mi_set_cb_addr(stream,</span><br><span class="line">            stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_CB]);</span><br><span class="line">        mi_set_cr_addr(stream,</span><br><span class="line">            stream-&gt;next_buf-&gt;buff_addr[RKISP1_PLANE_CR]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v4l2_dbg(<span class="number">1</span>, rkisp1_debug, &amp;stream-&gt;ispdev-&gt;v4l2_dev,</span><br><span class="line">             <span class="string">&quot;stream %d: to dummy buf\n&quot;</span>, stream-&gt;id);    </span><br><span class="line">        mi_set_y_addr(stream, dummy_buf-&gt;dma_addr);</span><br><span class="line">        mi_set_cb_addr(stream, dummy_buf-&gt;dma_addr);</span><br><span class="line">        mi_set_cr_addr(stream, dummy_buf-&gt;dma_addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mi_set_y_offset(stream, <span class="number">0</span>);</span><br><span class="line">    mi_set_cb_offset(stream, <span class="number">0</span>);</span><br><span class="line">    mi_set_cr_offset(stream, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20220215/">https://zhoujinjian.com/posts/20220215/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Camera/">Camera</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.34.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20220301/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.35.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 10 Camera源码分析5：rkisp_demo分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/20220201/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.33.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20220515/" title="Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.40.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-15</div><div class="title">Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md</div></div></a></div><div><a href="/posts/20220101/" title="Android 10 Camera源码分析1：MIPI CSI2总结基于DPHY2.1(转载)"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.31.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">Android 10 Camera源码分析1：MIPI CSI2总结基于DPHY2.1(转载)</div></div></a></div><div><a href="/posts/20220115/" title="Android 10 Camera源码分析2：V4L2简介"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.32.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">Android 10 Camera源码分析2：V4L2简介</div></div></a></div><div><a href="/posts/20220201/" title="Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.33.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-01</div><div class="title">Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队</div></div></a></div><div><a href="/posts/20220301/" title="Android 10 Camera源码分析5：rkisp_demo分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.35.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-01</div><div class="title">Android 10 Camera源码分析5：rkisp_demo分析</div></div></a></div><div><a href="/posts/20220315/" title="Android 10 Camera源码分析6：Camera HAL3简介 && Camera Provider分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.36.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-15</div><div class="title">Android 10 Camera源码分析6：Camera HAL3简介 && Camera Provider分析</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81Rockchip-isp1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">（一）、Rockchip-isp1介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Overview"><span class="toc-number">1.0.1.</span> <span class="toc-text">1、Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Hardware"><span class="toc-number">1.0.2.</span> <span class="toc-text">2、Hardware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81ISP-Details"><span class="toc-number">1.0.3.</span> <span class="toc-text">3、ISP Details</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81Block-diagram"><span class="toc-number">1.0.4.</span> <span class="toc-text">4、Block diagram</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81MIPI-Details"><span class="toc-number">1.0.5.</span> <span class="toc-text">5、MIPI Details</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81Software"><span class="toc-number">1.0.6.</span> <span class="toc-text">6、Software</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81Driver"><span class="toc-number">1.0.7.</span> <span class="toc-text">7、Driver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E3%80%81Media-Controller-Basics"><span class="toc-number">1.0.8.</span> <span class="toc-text">8、Media Controller Basics</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9%E3%80%81Block-diagram"><span class="toc-number">1.0.9.</span> <span class="toc-text">9、Block diagram</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10%E3%80%81File-view"><span class="toc-number">1.0.10.</span> <span class="toc-text">10、File view</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11%E3%80%81V4l2-view"><span class="toc-number">1.0.11.</span> <span class="toc-text">11、V4l2 view</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12%E3%80%81Sensor-Driver-Requirement"><span class="toc-number">1.0.12.</span> <span class="toc-text">12、Sensor Driver Requirement</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13%E3%80%81Devicetree-Bindings"><span class="toc-number">1.0.13.</span> <span class="toc-text">13、Devicetree Bindings</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#14%E3%80%81Linux"><span class="toc-number">1.0.14.</span> <span class="toc-text">14、Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15%E3%80%81User-applications"><span class="toc-number">1.0.15.</span> <span class="toc-text">15、User applications</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16%E3%80%81Android"><span class="toc-number">1.0.16.</span> <span class="toc-text">16、Android</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17%E3%80%81Camera-Hal3"><span class="toc-number">1.0.17.</span> <span class="toc-text">17、Camera Hal3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#18%E3%80%81Topology"><span class="toc-number">1.0.18.</span> <span class="toc-text">18、Topology</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81Rockchip-isp1-driver%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">（二）、Rockchip-isp1 driver分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81Camera-%E8%BD%AF%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9B%AE%E5%BD%95%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.</span> <span class="toc-text">（1）、Camera 软件驱动目录说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%A1%86%E6%9E%B6%E7%AE%80%E8%A6%81%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.1.</span> <span class="toc-text">1、框架简要说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E9%A9%B1%E5%8A%A8%E7%89%88%E6%9C%AC%E5%8F%B7%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.2.</span> <span class="toc-text">2、驱动版本号获取方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81RKisp1-DTS%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.3.</span> <span class="toc-text">3、RKisp1 DTS配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81-RKisp1-DTS%E7%9A%84%E6%9D%BF%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.3.1.</span> <span class="toc-text">3.1、 RKisp1 DTS的板级配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81rkisp1-plat-probe"><span class="toc-number">2.1.4.</span> <span class="toc-text">4、rkisp1_plat_probe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1%E3%80%81v4l2-device-register"><span class="toc-number">2.1.5.</span> <span class="toc-text">4.1、v4l2_device_register</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2%E3%80%81video-register-device%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.6.</span> <span class="toc-text">4.2、video_register_device注册过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1%E3%80%81%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.6.1.</span> <span class="toc-text">4.2.1、注册过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2%E3%80%81video%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.1.6.2.</span> <span class="toc-text">4.2.2、video在系统中的位置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3%E3%80%81media-device-register-%E5%A4%9A%E5%AA%92%E4%BD%93%E8%AE%BE%E5%A4%87%E6%B3%A8%E5%86%8C"><span class="toc-number">2.1.7.</span> <span class="toc-text">4.3、media_device_register()多媒体设备注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4%E3%80%81rkisp1-register-platform-subdevs"><span class="toc-number">2.1.8.</span> <span class="toc-text">4.4、rkisp1_register_platform_subdevs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5%E3%80%81rkisp1-register-stream-vdev"><span class="toc-number">2.1.9.</span> <span class="toc-text">4.5、rkisp1_register_stream_vdev</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6%E3%80%81rkisp-init-vb2-queue"><span class="toc-number">2.1.10.</span> <span class="toc-text">4.6、rkisp_init_vb2_queue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7%E3%80%81%E5%88%A4%E6%96%AD%E9%A9%B1%E5%8A%A8-probe-%E7%8A%B6%E6%80%81"><span class="toc-number">2.1.11.</span> <span class="toc-text">4.7、判断驱动 probe 状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81mipi-dphy-%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">（2）、mipi-dphy 驱动分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81-mipi-dphy-%E7%9A%84%E6%9D%BF%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.1.</span> <span class="toc-text">1、 mipi-dphy 的板级配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81-mipi-dphy-%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.2.2.</span> <span class="toc-text">2、 mipi-dphy 驱动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81VCM%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.3.</span> <span class="toc-text">（3）、VCM驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81VCM-%E8%AE%BE%E5%A4%87%E6%B3%A8%E5%86%8C-DTS"><span class="toc-number">2.3.1.</span> <span class="toc-text">1、VCM 设备注册(DTS)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81VCM-%E9%A9%B1%E5%8A%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">2.3.2.</span> <span class="toc-text">2、VCM 驱动说明</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81imx214%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="toc-number">2.4.</span> <span class="toc-text">（4）、imx214驱动分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%B8%8A%E7%94%B5%E6%97%B6%E5%BA%8F"><span class="toc-number">2.4.1.</span> <span class="toc-text">1、上电时序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Sensor-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AF%84%E5%AD%98%E5%99%A8%E5%88%97%E8%A1%A8"><span class="toc-number">2.4.2.</span> <span class="toc-text">2、Sensor 初始化寄存器列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81-V4l2-subdev-ops-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.3.</span> <span class="toc-text">3、 V4l2_subdev_ops 回调函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81-V4l2-controller"><span class="toc-number">2.4.4.</span> <span class="toc-text">4、 V4l2 controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81Probe-%E5%87%BD%E6%95%B0%E5%8F%8A%E6%B3%A8%E5%86%8C-media-entity-v4l2-subdev"><span class="toc-number">2.4.5.</span> <span class="toc-text">5、Probe 函数及注册 media entity, v4l2 subdev</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81Camera-Buffer-Flow"><span class="toc-number">3.</span> <span class="toc-text">（三）、Camera Buffer Flow</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>