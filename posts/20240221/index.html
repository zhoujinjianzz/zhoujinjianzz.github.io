<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识 | zhoujinjian</title><meta name="keywords" content="Linux"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">
<meta property="og:url" content="https://zhoujinjian.com/posts/20240221/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg">
<meta property="article:published_time" content="2024-02-20T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.940Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20240221/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.940Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读各位前辈总结的资料 Android 11.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。</p>
<p>（==<strong>文章基于 Kernel-4.19</strong>==）&amp;&amp;（==<strong>文章基于 Android 11.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz">【zhoujinjian.com博客原图链接】</a> </p>
<p><a target="_blank" rel="noopener" href="https://shop.allnetchina.cn/collections/frontpage/products/rock-pi-4-model-b-board-only-2-4-5ghz-wlan-bluetooth-5-0">【开发板 RockPi4bPlusV1.6】</a></p>
<p><a href="">【开发板 RockPi4bPlusV1.6 Android 11.0 &amp;&amp; Linux（Kernel 4.19）源码链接】</a>：（repo init -u <a target="_blank" rel="noopener" href="https://github.com/radxa/manifests.git">https://github.com/radxa/manifests.git</a> -b Android11_Radxa_rk11.1 -m rockchip-r-release.xml）</p>
<p><a target="_blank" rel="noopener" href="https://wiki.radxa.com/Rockpi4/rockpi-android11">【开发板 RockPi4bPlusV1.6 Android 11.0 &amp;&amp; Linux（Kernel 4.19）编译指南】</a></p>
<p>正是由于前人（各位大神）的分析和总结，帮助我节约了大量的时间和精力，特别感谢，由于不喜欢图片水印，去除了水印，敬请谅解！！！</p>
<p>本文转自<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyly/p/17775862.html">Rockchip RK3399 - DRM gem基础知识 </a>，如有侵权，请联系删除。</p>
<hr>
<p>开发板 ：<code>ROCK Pi 4B+</code>开发板<br><code>eMMC</code> ：<code>32GB</code><br><code>LPDDR4</code> ：<code>4GB</code><br>显示屏 ：<code>7</code>英寸<code>HDMI</code>接口显示屏<br><code>u-boot</code> ：<code>2017.09</code><br><code>linux</code> ：<code>4.19</code>  </p>
<hr>
<p><code>GEM</code>主要负责显示<code>buffer</code>的分配和释放，<code>linux</code>内核中使用<code>struct drm_gem_object</code>表示<code>GEM</code>对象，驱动一般需要用私有信息来扩展<code>GEM</code>对象，因此<code>struct drm_gem_object</code>都是嵌入在驱动自定义的<code>GEM</code>结构体内的。<br><code>gem object</code>的创建以及初始化步骤如下：</p>
<ul>
<li>创建一个<code>GEM</code>对象，驱动为自定义<code>GEM</code>对象申请内存；</li>
<li>通过<code>drm_gem_object_init</code>来初始化嵌入在其中的<code>struct drm_gem_object</code>；</li>
<li>通过<code>drm_gem_handle_create</code>创建<code>GEM</code>对象<code>handle</code>；</li>
<li>分配物理<code>buffer</code>；</li>
<li>通过<code>mmap</code>将物理<code>buffer</code>映射到用户空间；这样用户空间就可以直接访问了；</li>
</ul>
<h3 id="一、GEM数据结构"><a href="#一、GEM数据结构" class="headerlink" title="一、GEM数据结构"></a>一、<code>GEM</code>数据结构</h3><h4 id="1-1-struct-drm-gem-object"><a href="#1-1-struct-drm-gem-object" class="headerlink" title="1.1 struct drm_gem_object"></a>1.1 <code>struct drm_gem_object</code></h4><p><code>linux</code>内核中使用<code>struct drm_gem_object</code>表示<code>GEM</code>对象，<code>struct drm_gem_object</code>定义在<code>include/drm/drm_gem.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_gem_object - GEM buffer object</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This structure defines the generic parts for GEM buffer objects, which are</span></span><br><span class="line"><span class="comment"> * mostly around handling mmap and userspace handles.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Buffer objects are often abbreviated to BO.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> &#123;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @refcount:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Reference count of this object</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Please use drm_gem_object_get() to acquire and drm_gem_object_put_locked()</span></span><br><span class="line"><span class="comment">         * or drm_gem_object_put() to release a reference to a GEM</span></span><br><span class="line"><span class="comment">         * buffer object.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">refcount</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @handle_count:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is the GEM file_priv handle count of this object.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Each handle also holds a reference. Note that when the handle_count</span></span><br><span class="line"><span class="comment">         * drops to 0 any global names (e.g. the id in the flink namespace) will</span></span><br><span class="line"><span class="comment">         * be cleared.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Protected by &amp;drm_device.object_name_lock.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">unsigned</span> handle_count;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @dev: DRM dev this object belongs to.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @filp:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * SHMEM file node used as backing storage for swappable buffer objects.</span></span><br><span class="line"><span class="comment">         * GEM also supports driver private objects with driver-specific backing</span></span><br><span class="line"><span class="comment">         * storage (contiguous DMA memory, special reserved blocks). In this</span></span><br><span class="line"><span class="comment">         * case @filp is NULL.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>;</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @vma_node:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Mapping info for this object to support mmap. Drivers are supposed to</span></span><br><span class="line"><span class="comment">         * allocate the mmap offset using drm_gem_create_mmap_offset(). The</span></span><br><span class="line"><span class="comment">         * offset itself can be retrieved using drm_vma_node_offset_addr().</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Memory mapping itself is handled by drm_gem_mmap(), which also checks</span></span><br><span class="line"><span class="comment">         * that userspace is allowed to access the object.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_vma_offset_node</span> <span class="title">vma_node</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @size:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Size of the object, in bytes.  Immutable over the object&#x27;s</span></span><br><span class="line"><span class="comment">         * lifetime.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @name:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Global name for this object, starts at 1. 0 means unnamed.</span></span><br><span class="line"><span class="comment">         * Access is covered by &amp;drm_device.object_name_lock. This is used by</span></span><br><span class="line"><span class="comment">         * the GEM_FLINK and GEM_OPEN ioctls.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> name;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @dma_buf:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * dma-buf associated with this GEM object.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Pointer to the dma-buf associated with this gem object (either</span></span><br><span class="line"><span class="comment">         * through importing or exporting). We break the resulting reference</span></span><br><span class="line"><span class="comment">         * loop when the last gem handle for this object is released.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Protected by &amp;drm_device.object_name_lock.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> *<span class="title">dma_buf</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @import_attach:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * dma-buf attachment backing this object.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Any foreign dma_buf imported as a gem object has this set to the</span></span><br><span class="line"><span class="comment">         * attachment point for the device. This is invariant over the lifetime</span></span><br><span class="line"><span class="comment">         * of a gem object.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The &amp;drm_gem_object_funcs.free callback is responsible for</span></span><br><span class="line"><span class="comment">         * cleaning up the dma_buf attachment and references acquired at import</span></span><br><span class="line"><span class="comment">         * time.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Note that the drm gem/prime core does not depend upon drivers setting</span></span><br><span class="line"><span class="comment">         * this field any more. So for drivers where this doesn&#x27;t make sense</span></span><br><span class="line"><span class="comment">         * (e.g. virtual devices or a displaylink behind an usb bus) they can</span></span><br><span class="line"><span class="comment">         * simply leave it as NULL.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_attachment</span> *<span class="title">import_attach</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @resv:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Pointer to reservation object associated with the this GEM object.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Normally (@resv == &amp;@_resv) except for imported GEM objects.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dma_resv</span> *<span class="title">resv</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @_resv:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * A reservation object for this GEM object.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * This is unused for imported GEM objects.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dma_resv</span> _<span class="title">resv</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @funcs:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Optional GEM object functions. If this is set, it will be used instead of the</span></span><br><span class="line"><span class="comment">         * corresponding &amp;drm_driver GEM callbacks.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * New drivers should use this.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object_funcs</span> *<span class="title">funcs</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @lru_node:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * List node in a &amp;drm_gem_lru.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru_node</span>;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @lru:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The current LRU list that the GEM object is on.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_lru</span> *<span class="title">lru</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中:</p>
<ul>
<li><code>refcount</code>：表示对象引用计数，用于对<code>GEM</code>对象全生命周期的管理；</li>
<li><code>handle_count</code>：表示该对象的句柄计数。每个句柄还持有一个引用，当<code>handle_count</code>降为0时，任何全局名称（例如<code>flink</code>命名空间中的<code>id</code>）都将被清除；</li>
<li><code>dev</code>：该对象所属的<code>DRM</code>设备的指针；</li>
<li><code>filp</code>：用作可互换的缓存对象的后备存储的共享内存文件节点；</li>
<li><code>vma_node</code>：用于支持内存映射的对象的映射信息；</li>
<li><code>size</code>：对象的大小，以字节为单位；</li>
<li><code>name</code>：该对象的全局名称，从1开始。值为0表示无名称；</li>
<li><code>dma_buf</code>：与此<code>GEM</code>对象关联的<code>dma-buf</code>；</li>
<li><code>import_attach</code>：支持此对象的<code>dma-buf</code>附件；</li>
<li><code>resv</code>：与此<code>GEM</code>对象关联的保留对象的指针；</li>
<li><code>_resv</code>：此<code>GEM</code>对象的保留对象；</li>
<li><code>funcs</code>：可选的<code>GEM</code>对象函数。如果设置了此字段，则将使用它而不是对应的<code>drm_driver GEM</code>回调函数；</li>
<li><code>lru_node</code>：在<code>drm_gem_lru</code>中的列表节点；</li>
<li><code>lru</code>：<code>GEM</code>对象当前所在的<code>LRU</code>列表；</li>
</ul>
<h4 id="1-2-struct-drm-gem-object-funcs"><a href="#1-2-struct-drm-gem-object-funcs" class="headerlink" title="1.2 struct drm_gem_object_funcs"></a>1.2 <code>struct drm_gem_object_funcs</code></h4><p><code>struct drm_gem_object_funcs</code>定义了与<code>GEM</code>对象相关的回调函数，用于管理和操作<code>GEM</code>对象；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object_funcs</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(struct drm_gem_object *obj);</span><br><span class="line">    <span class="keyword">int</span> (*open)(struct drm_gem_object *obj, struct drm_file *file);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct drm_gem_object *obj, struct drm_file *file);</span><br><span class="line">    <span class="keyword">void</span> (*print_info)(struct drm_printer *p, <span class="keyword">unsigned</span> <span class="keyword">int</span> indent, <span class="keyword">const</span> struct drm_gem_object *obj);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> *(*<span class="title">export</span>)(<span class="title">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span>, <span class="title">int</span> <span class="title">flags</span>);</span></span><br><span class="line">    <span class="keyword">int</span> (*pin)(struct drm_gem_object *obj);</span><br><span class="line">    <span class="keyword">void</span> (*unpin)(struct drm_gem_object *obj);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *(*<span class="title">get_sg_table</span>)(<span class="title">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span>);</span></span><br><span class="line">    <span class="keyword">int</span> (*vmap)(struct drm_gem_object *obj, struct iosys_map *<span class="built_in">map</span>);</span><br><span class="line">    <span class="keyword">void</span> (*vunmap)(struct drm_gem_object *obj, struct iosys_map *<span class="built_in">map</span>);</span><br><span class="line">    <span class="keyword">int</span> (*mmap)(struct drm_gem_object *obj, struct vm_area_struct *vma);</span><br><span class="line">    <span class="keyword">int</span> (*evict)(struct drm_gem_object *obj);</span><br><span class="line">    <span class="function"><span class="keyword">enum</span> <span class="title">drm_gem_object_status</span> <span class="params">(*status)</span><span class="params">(struct drm_gem_object *obj)</span></span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>free</code>：用于释放<code>GEM</code>对象及其相关资源的操作，必须实现；</li>
<li><code>open</code>：创建<code>GEM handle</code>时（<code>drm_gem_handle_create</code>），回调该函数，可选；</li>
<li><code>close</code>：释放<code>GEM handle</code>时（<code>drm_gem_handle_delete</code>），回调该函数，可选；</li>
<li><code>get_sg_table</code>：用于获取<code>buffer</code>的<code>Scatter-Gather</code>表（<code>SG</code>表）；</li>
<li><code>vmap</code>：为<code>buffer</code>获取一个虚拟地址，会被<code>drm_gem_dmabuf_vmap helper</code>使用，可选；</li>
<li><code>vunmap</code>: 释放由<code>vmap</code>返回的虚拟地址，会被<code>drm_gem_dmabuf_vunmap helper</code>使用，可选；</li>
<li><code>mmap</code>：用于处理对<code>GEM</code>对象的<code>mmap</code>调用，并相应地设置<code>vma</code>（<code>vm_area_struct</code>）结构，可选；<ul>
<li>此回调函数被<code>drm_gem_mmap_obj</code>和<code>drm_gem_prime_mmap</code>两者使用；</li>
<li>当存在<code>mmap</code>时，不会使用<code>vm_ops</code>，而是必须由<code>mmap</code>回调函数设置<code>vma</code>-&gt;<code>vm_ops</code>；</li>
</ul>
</li>
<li><code>vm_ops</code>：与<code>mmap</code>一起使用的虚拟内存区域操作结构体，它包含了对应于虚拟内存区域操作的函数指针；对于<code>GEM</code>对象或其他需要通过<code>mmap</code>系统调用映射到用户空间的内核对象，必须实现适当的<code>vm_ops</code>结构体。</li>
</ul>
<h3 id="二、核心API"><a href="#二、核心API" class="headerlink" title="二、核心API"></a>二、核心<code>API</code></h3><h4 id="2-1-GEM初始化"><a href="#2-1-GEM初始化" class="headerlink" title="2.1 GEM初始化"></a>2.1 <code>GEM</code>初始化</h4><p><code>GEM</code>使用<code>shmem</code>来申请匿名页内存，<code>drm_gem_object_init</code>将会根据传入的<code>size</code>创建一个指定大小的指定大小的<code>shmfs</code>，并将这个<code>shmfs file</code>保存到<code>struct drm_gem_object</code>的<code>filp</code>字段。</p>
<p>当图形硬件使用系统内存，这些内存就会作为对象的主存储直接使用，否则就会作为后备内存。</p>
<p>驱动负责调用<code>shmem_read_mapping_page_gfp</code>做实际物理页面的申请，初始化<code>GEM</code>对象时驱动可以决定申请页面，或者延迟到需要内存时再申请（需要内存时是指：用户态访问内存发生缺页中断，或是驱动需要启动<code>DMA</code>用到这段内存）。</p>
<p>在某些情况下，匿名可分页内存分配并不理想，特别是当硬件要求物理连续的系统内存时，这在嵌入式设备中经常发生。在这种情况下，驱动程序可以通过调用<code>drm_gem_private_object_init</code>来初始化<code>GEM</code>对象，而不是使用<code>drm_gem_object_init</code>，从而创建没有<code>shmfs</code>支持的私有<code>GEM</code>对象。</p>
<p><code>drm_gem_object_init</code>函数定义在<code>drivers/gpu/drm/drm_gem.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_gem_object_init - initialize an allocated shmem-backed GEM object</span></span><br><span class="line"><span class="comment"> * @dev: drm_device the object should be initialized for</span></span><br><span class="line"><span class="comment"> * @obj: drm_gem_object to initialize</span></span><br><span class="line"><span class="comment"> * @size: object size 对象的大小</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Initialize an already allocated GEM object of the specified size with</span></span><br><span class="line"><span class="comment"> * shmfs backing store.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">drm_gem_object_init</span><span class="params">(struct drm_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                        struct drm_gem_object *obj, <span class="keyword">size_t</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>;</span></span><br><span class="line"></span><br><span class="line">        drm_gem_private_object_init(dev, obj, size);</span><br><span class="line"> </span><br><span class="line">        filp = shmem_file_setup(<span class="string">&quot;drm mm object&quot;</span>, size, VM_NORESERVE);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(filp))</span><br><span class="line">                <span class="keyword">return</span> PTR_ERR(filp);</span><br><span class="line"></span><br><span class="line">        obj-&gt;filp = filp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数通过调用 <code>drm_gem_private_object_init</code> 进行对象初始化;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_gem_private_object_init - initialize an allocated private GEM object</span></span><br><span class="line"><span class="comment"> * @dev: drm_device the object should be initialized for</span></span><br><span class="line"><span class="comment"> * @obj: drm_gem_object to initialize</span></span><br><span class="line"><span class="comment"> * @size: object size</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Initialize an already allocated GEM object of the specified size with</span></span><br><span class="line"><span class="comment"> * no GEM provided backing store. Instead the caller is responsible for</span></span><br><span class="line"><span class="comment"> * backing the object and handling it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">drm_gem_private_object_init</span><span class="params">(struct drm_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 struct drm_gem_object *obj, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        BUG_ON((size &amp; (PAGE_SIZE - <span class="number">1</span>)) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化成员</span></span><br><span class="line">        obj-&gt;dev = dev;</span><br><span class="line">        obj-&gt;filp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化对象引用计数为1</span></span><br><span class="line">        kref_init(&amp;obj-&gt;refcount);</span><br><span class="line">        obj-&gt;handle_count = <span class="number">0</span>;</span><br><span class="line">        obj-&gt;size = size;</span><br><span class="line">        dma_resv_init(&amp;obj-&gt;_resv);</span><br><span class="line">        <span class="keyword">if</span> (!obj-&gt;resv)</span><br><span class="line">                obj-&gt;resv = &amp;obj-&gt;_resv;</span><br><span class="line"></span><br><span class="line">        drm_vma_node_reset(&amp;obj-&gt;vma_node);</span><br><span class="line">        INIT_LIST_HEAD(&amp;obj-&gt;lru_node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过调用 <code>shmem_file_setup</code> 创建一个与该 <code>GEM</code>对象关联的<code>shmem</code>文件，并将文件指针赋值给 <code>obj-&gt;filp</code>。</p>
<h4 id="2-2-GEM对象命名"><a href="#2-2-GEM对象命名" class="headerlink" title="2.2 GEM对象命名"></a>2.2 <code>GEM</code>对象命名</h4><p>用户空间与内核之间的通信使用本地句柄（<code>handle</code>）、全局名称或者文件描述符来引用<code>GEM</code>对象，所有这些都是<code>32bit</code>数。</p>
<h5 id="2-2-1-GEM-handle"><a href="#2-2-1-GEM-handle" class="headerlink" title="2.2.1 GEM handle"></a>2.2.1 <code>GEM handle</code></h5><p><code>GEM handle</code>只在特定的<code>DRM</code>文件中有效，应用程序通过驱动程序特定的<code>ioctl</code>获取<code>GEM</code>对象的<code>handle</code>，并可以在其他标准或驱动程序特定的<code>ioctl</code>中使用该<code>handle</code>引用<code>GEM</code>对象，关闭一个<code>DRM</code>文件句柄会释放其中所有的<code>GEM</code>，并解引用相关的<code>GEM</code>对象。</p>
<p>对于<code>GEM handle</code>，函数<code>drm_gem_handle_create</code>用于创建<code>GEM</code>对象的<code>handle</code>，这个函数接收三个参数：</p>
<ul>
<li><code>file_priv</code>：<code>DRM file</code>的私有数据；</li>
<li><code>obj</code>：<code>GEM</code>对象；</li>
<li><code>handlep</code>：将创建的<code>handle</code>返回给调用者的指针<code>handlep</code>；</li>
</ul>
<p><code>drm_gem_handle_create</code>函数定义在<code>drivers/gpu/drm/drm_gem.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_gem_handle_create_tail - internal functions to create a handle</span></span><br><span class="line"><span class="comment"> * @file_priv: drm file-private structure to register the handle for</span></span><br><span class="line"><span class="comment"> * @obj: object to register</span></span><br><span class="line"><span class="comment"> * @handlep: pointer to return the created handle to the caller</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This expects the &amp;drm_device.object_name_lock to be held already and will</span></span><br><span class="line"><span class="comment"> * drop it before returning. Used to avoid races in establishing new handles</span></span><br><span class="line"><span class="comment"> * when importing an object from either an flink name or a dma-buf.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Handles must be release again through drm_gem_handle_delete(). This is done</span></span><br><span class="line"><span class="comment"> * when userspace closes @file_priv for all attached handles, or through the</span></span><br><span class="line"><span class="comment"> * GEM_CLOSE ioctl for individual handles.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">drm_gem_handle_create_tail(struct drm_file *file_priv,</span><br><span class="line">                           struct drm_gem_object *obj,</span><br><span class="line">                           u32 *handlep)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">dev</span> = <span class="title">obj</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">        u32 handle;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        WARN_ON(!mutex_is_locked(&amp;dev-&gt;object_name_lock));</span><br><span class="line">        <span class="keyword">if</span> (obj-&gt;handle_count++ == <span class="number">0</span>)</span><br><span class="line">                drm_gem_object_get(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Get the user-visible handle using idr.  Preload and perform</span></span><br><span class="line"><span class="comment">         * allocation under our spinlock.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        idr_preload(GFP_KERNEL);</span><br><span class="line">        <span class="comment">// 获取自旋锁</span></span><br><span class="line">        spin_lock(&amp;file_priv-&gt;table_lock);   </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于基数树分配一个唯一的id</span></span><br><span class="line">        ret = idr_alloc(&amp;file_priv-&gt;object_idr, obj, <span class="number">1</span>, <span class="number">0</span>, GFP_NOWAIT); </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放自旋锁</span></span><br><span class="line">        spin_unlock(&amp;file_priv-&gt;table_lock);   </span><br><span class="line">        idr_preload_end();</span><br><span class="line"></span><br><span class="line">        mutex_unlock(&amp;dev-&gt;object_name_lock);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> err_unref;</span><br><span class="line"></span><br><span class="line">        handle = ret;</span><br><span class="line"></span><br><span class="line">        ret = drm_vma_node_allow(&amp;obj-&gt;vma_node, file_priv);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">goto</span> err_remove;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (obj-&gt;funcs-&gt;open) &#123;</span><br><span class="line">                <span class="comment">// 回调open函数</span></span><br><span class="line">                ret = obj-&gt;funcs-&gt;open(obj, file_priv);</span><br><span class="line">                <span class="keyword">if</span> (ret)</span><br><span class="line">                        <span class="keyword">goto</span> err_revoke;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *handlep = handle; <span class="comment">// 写回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_revoke:</span><br><span class="line">        drm_vma_node_revoke(&amp;obj-&gt;vma_node, file_priv);</span><br><span class="line">err_remove:</span><br><span class="line">        spin_lock(&amp;file_priv-&gt;table_lock);</span><br><span class="line">        idr_remove(&amp;file_priv-&gt;object_idr, handle);</span><br><span class="line">        spin_unlock(&amp;file_priv-&gt;table_lock);</span><br><span class="line">err_unref:</span><br><span class="line">        drm_gem_object_handle_put_unlocked(obj);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_gem_handle_create - create a gem handle for an object</span></span><br><span class="line"><span class="comment"> * @file_priv: drm file-private structure to register the handle for</span></span><br><span class="line"><span class="comment"> * @obj: object to register</span></span><br><span class="line"><span class="comment"> * @handlep: pointer to return the created handle to the caller</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Create a handle for this object. This adds a handle reference to the object,</span></span><br><span class="line"><span class="comment"> * which includes a regular reference count. Callers will likely want to</span></span><br><span class="line"><span class="comment"> * dereference the object afterwards.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Since this publishes @obj to userspace it must be fully set up by this point,</span></span><br><span class="line"><span class="comment"> * drivers must call this last in their buffer object creation callbacks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">drm_gem_handle_create</span><span class="params">(struct drm_file *file_priv,</span></span></span><br><span class="line"><span class="function"><span class="params">                          struct drm_gem_object *obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                          u32 *handlep)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        mutex_lock(&amp;obj-&gt;dev-&gt;object_name_lock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> drm_gem_handle_create_tail(file_priv, obj, handlep);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以由<code>drm_gem_object_lookup</code>检索与<code>handle</code>关联的<code>GEM</code>对象。</p>
<p>当<code>handle</code>不再需要时，驱动程序使用<code>drm_gem_handle_delete</code>进行删除。释放句柄并不直接销毁或释放<code>GEM</code>对象本身，它只是解除了句柄与<code>GEM</code>对象之间的关联。</p>
<p>为了避免泄漏<code>GEM</code>对象，驱动程序必须确保适当地丢弃自己所拥有的引用（比如在对象创建时获取的初始引用），而不需要特别考虑<code>handle</code>。例如，在实现<code>dumb_create</code>操作时，驱动程序必须在返回<code>handle</code>之前丢弃对<code>GEM</code>对象的初始引用。</p>
<h5 id="2-2-2-GEM名称"><a href="#2-2-2-GEM名称" class="headerlink" title="2.2.2 GEM名称"></a>2.2.2 <code>GEM</code>名称</h5><p><code>GEM</code>名称类似于句柄，但不仅限于<code>DRM</code>文件。它们可以在进程之间传递，用于全局引用<code>GEM</code>对象。应用程序需要通过ioctl的<code>DRM_IOCTL_GEM_FLINK</code>和<code>DRM_IOCTL_GEM_OPEN</code>来将句柄转换为名称，以及将名称转换为句柄。这个转换由<code>DRM core</code>处理，不需要任何驱动程序特定的支持。</p>
<h5 id="2-2-3-文件描述符"><a href="#2-2-3-文件描述符" class="headerlink" title="2.2.3 文件描述符"></a>2.2.3 文件描述符</h5><p><code>GEM</code>也支持通过<code>PRIME dma-buf</code>文件描述符的缓存共享，基于<code>GEM</code>的驱动必须使用提供的辅助函数来实现<code>exoprting</code>和<code>importing</code>。共享文件描述符比可以被猜测的全局名称更安全，因此是首选的缓存共享机制。通过<code>GEM</code>全局名称进行缓存共享仅在传统用户态支持，更进一步的说，<code>PRIME</code>由于其基于<code>dma-buf</code>，还允许跨设备缓存共享。</p>
<h4 id="2-3-GEM对象的生命周期"><a href="#2-3-GEM对象的生命周期" class="headerlink" title="2.3 GEM对象的生命周期"></a>2.3 <code>GEM</code>对象的生命周期</h4><p>所有的<code>GEM</code>对象都由<code>GEM Core</code>进行引用计数管理，在<code>DRM</code>子系统中，可以通过调用函数<code>drm_gem_object_get</code>和<code>drm_gem_object_put</code>来获取和释放对<code>GEM</code>对象的引用。</p>
<p>执行<code>drm_gem_object_get</code>调用者必须持有<code>struct drm_device</code>的<code>struct_mutex</code>锁，而为了方便也提供了<code>drm_gem_object_put_unlocked</code>也可以不持锁操作。</p>
<p>当最后一个对<code>GEM</code>对象的引用释放时，<code>GEM core</code>调用<code>struct drm_gem_object_funcs</code>中的<code>free</code>操作，这一操作对于使能了<code>GEM</code>的驱动来说是必须，并且必须释放<code>GEM</code>对象和所有相关资源。</p>
<p>在<code>struct drm_gem_object_funcs</code>中，<code>void (*free)(struct drm_gem_object *obj)</code>函数指针是用于释放GEM对象及其相关资源的操作。驱动程序需要实现这个函数，并在适当的时候调用<code>drm_gem_object_release</code>释放与<code>GEM</code>对象相关的资源。</p>
<h4 id="2-4-GEM对象内存映射"><a href="#2-4-GEM对象内存映射" class="headerlink" title="2.4 GEM对象内存映射"></a>2.4 <code>GEM</code>对象内存映射</h4><p>在<code>linux kernel</code>驱动中，实现<code>mmap</code>系统调用离不开两个关键步骤：</p>
<ul>
<li>物理内存的分配;</li>
<li>建立物理内存到用户空间的映射关系。</li>
</ul>
<p>这刚好对应了<code>DRM</code>中的<code>dumb_create</code>和<code>mmap</code>操作，先说映射关系，在<code>linux</code>驱动中建立映射关系的方法主要有如下两种：</p>
<ul>
<li>一次性映射：在<code>mmap</code>回调函数中，一次性建立好整块内存的映射关系，通常以<code>remap_pfn_range</code>为代表；</li>
<li><code>Page Fault</code>：在<code>mmap</code>先不建立映射关系，等上层触发缺页异常时，在<code>fault</code>中断处理函数中建立映射关系，缺哪块补哪块，通常以<code>vm_insert_page</code>为代表。</li>
</ul>
<p>想再进一步学习<code>mmap</code>系统调用的相关知识，推荐大家阅读<a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/article/details/107592704">《<code>DRM</code> 驱动<code>mmap</code>详解：（一）预备知识》</a>和<a target="_blank" rel="noopener" href="https://www.cnblogs.com/huxiao-tee/p/4660352.html">《认真分析<code>mmap</code>：是什么 为什么 怎么用》</a>。</p>
<p>在<code>DRM</code>中，<code>GEM</code>更倾向于通过特定于驱动程序的<code>ioctl</code>实现类似读/写的访问<code>buffer</code>，而不是将<code>buffer</code>映射到用户空间。然而，当需要对<code>buffer</code>进行随机访问时（例如执行软件渲染），直接访问对象可能更有效率。</p>
<p>不能直接使用<code>mmap</code>系统调用来映射<code>GEM</code>对象，因为它们没有自己的文件句柄。目前有两种共存的方法将<code>GEM</code>对象映射到用户空间：</p>
<p>(1) 第一种方法使用特定于驱动程序的<code>ioctl</code>来执行映射操作，底层调用<code>do_mmap</code>，这种方法经常被认为不可靠，在新的<code>GEM</code>驱动程序中似乎不被鼓励使用，因此这里不会描述它；</p>
<p>(2) 使用<code>mmap</code>系统调用对<code>DRM</code>文件句柄进行映射；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span></span><br></pre></td></tr></table></figure>

<p><code>DRM</code>通过传递一个虚拟偏移量来标识要映射的<code>GEM</code>对象，该偏移量通过<code>mmap</code>的<code>offset</code>参数传递。在映射之前，<code>GEM</code>对象必须与虚拟偏移量关联起来。为此，驱动程序必须在对象上调用<code>drm_gem_create_mmap_offset</code>。</p>
<p>分配了虚拟偏移量值后，驱动程序必须以特定于驱动程序的方式将该值传递给应用程序，然后可以将其用作<code>mmap</code>的<code>offset</code>参数。</p>
<p><code>GEM</code>核心提供了一个辅助方法<code>drm_gem_mmap</code>来处理对象映射。该方法可以直接设置为<code>mmap</code>文件操作处理程序,它将根据偏移值查找<code>GEM</code>对象，并将<code>VMA</code>操作设置为<code>struct drm_driver gem_vm_ops</code>字段。</p>
<p>请注意：<code>drm_gem_mmap</code>不会将内存映射到用户空间，而是依赖于驱动程序提供的<code>fault handler</code>来逐个映射页面。</p>
<h3 id="三、Rockchip-gem驱动"><a href="#三、Rockchip-gem驱动" class="headerlink" title="三、Rockchip gem驱动"></a>三、<code>Rockchip gem</code>驱动</h3><p>这里我们介绍一下<code>Rochchip DRM</code>驱动中与<code>gem object</code>相关的实现，具体实现文件：</p>
<ul>
<li><code>drivers/gpu/drm/rockchip/rockchip_drm_fb.c</code>；</li>
<li><code>drivers/gpu/drm/rockchip/rockchip_drm_gem.c</code>；</li>
<li><code>drivers/gpu/drm/rockchip/rockchip_drm_gem.h</code>；</li>
<li><code>drivers/gpu/drm/rockchip/rockchip_drm_fb.h</code>；</li>
</ul>
<h4 id="3-1-gem-object创建及初始化"><a href="#3-1-gem-object创建及初始化" class="headerlink" title="3.1 gem object创建及初始化"></a>3.1 <code>gem object</code>创建及初始化</h4><p><code>gem object</code>的创建以及初始化是由<code>rockchip_gem_dumb_create</code>函数完成的，其定义在<code>rockchip_drm_driver</code>中；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_driver</span> <span class="title">rockchip_drm_driver</span> = &#123;</span></span><br><span class="line">        .driver_features        = DRIVER_MODESET | DRIVER_GEM | DRIVER_ATOMIC,</span><br><span class="line">        .dumb_create            = rockchip_gem_dumb_create,</span><br><span class="line">        ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>dumb_create</code>配置为<code>rockchip_gem_dumb_create</code>，该函数用于分配物理内存<code>dumb buffer</code>，函数定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_gem.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * rockchip_gem_dumb_create - (struct drm_driver)-&gt;dumb_create callback</span></span><br><span class="line"><span class="comment"> * function</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This aligns the pitch and size arguments to the minimum required. wrap</span></span><br><span class="line"><span class="comment"> * this into your own function if you need bigger alignment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rockchip_gem_dumb_create</span><span class="params">(struct drm_file *file_priv,</span></span></span><br><span class="line"><span class="function"><span class="params">                             struct drm_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                             struct drm_mode_create_dumb *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_gem_object</span> *<span class="title">rk_obj</span>;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 宽度*每像素位数/8</span></span><br><span class="line">        <span class="keyword">int</span> min_pitch = DIV_ROUND_UP(args-&gt;width * args-&gt;bpp, <span class="number">8</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * align to 64 bytes since Mali requires it.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        args-&gt;pitch = ALIGN(min_pitch, <span class="number">64</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 宽*高*每像素位数/8，即得到总大小（单位字节）</span></span><br><span class="line">        args-&gt;size = args-&gt;pitch * args-&gt;height;  </span><br><span class="line"></span><br><span class="line">        rk_obj = rockchip_gem_create_with_handle(file_priv, dev, args-&gt;size,</span><br><span class="line">                                                 &amp;args-&gt;handle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> PTR_ERR_OR_ZERO(rk_obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要实现函数是<code>rockchip_gem_create_with_handle</code>，定义如下；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * rockchip_gem_create_with_handle - allocate an object with the given</span></span><br><span class="line"><span class="comment"> * size and create a gem handle on it</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * returns a struct rockchip_gem_object* on success or ERR_PTR values</span></span><br><span class="line"><span class="comment"> * on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_gem_object</span> *</span></span><br><span class="line"><span class="class"><span class="title">rockchip_gem_create_with_handle</span>(<span class="title">struct</span> <span class="title">drm_file</span> *<span class="title">file_priv</span>,</span></span><br><span class="line"><span class="class">                                <span class="title">struct</span> <span class="title">drm_device</span> *<span class="title">drm</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>,</span></span><br><span class="line"><span class="class">                                <span class="title">unsigned</span> <span class="title">int</span> *<span class="title">handle</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_gem_object</span> *<span class="title">rk_obj</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span>;</span></span><br><span class="line">        <span class="keyword">bool</span> is_framebuffer;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        is_framebuffer = drm-&gt;fb_helper &amp;&amp; file_priv == drm-&gt;fb_helper-&gt;client.file;</span><br><span class="line"></span><br><span class="line">        rk_obj = rockchip_gem_create_object(drm, size, is_framebuffer);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(rk_obj))</span><br><span class="line">                <span class="keyword">return</span> ERR_CAST(rk_obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取GEM对象</span></span><br><span class="line">        obj = &amp;rk_obj-&gt;base; </span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * allocate a id of idr table where the obj is registered</span></span><br><span class="line"><span class="comment">         * and handle has the id what user can see.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ret = drm_gem_handle_create(file_priv, obj, handle); </span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">goto</span> err_handle_create;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* drop reference from allocate - handle holds it now. */</span></span><br><span class="line">        drm_gem_object_put(obj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rk_obj;</span><br><span class="line"></span><br><span class="line">err_handle_create:</span><br><span class="line">        rockchip_gem_free_object(obj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>函数执行流程如下：</p>
<ul>
<li>调用<code>rockchip_gem_create_object</code>创建并初始化<code>Rockchip</code>驱动自定义的<code>GEM</code>对象<code>struct rockchip_gem_objec</code>；数据结构<code>rockchip_gem_object</code>是<code>Rockchip</code>驱动自定义的<code>GEM</code>对象，内部包含<code>struct drm_gem_object</code>，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_gem.h</code>：</li>
<li>调用<code>drm_gem_handle_create</code>创建<code>GEM</code>对象<code>handle</code>；</li>
<li>调用<code>drm_gem_object_put</code>将<code>GEM</code>对象的引用计数-1；</li>
</ul>
<p><code>rockchip_gem_create_with_handle</code>函数调用栈：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">rockchip_gem_create_with_handle(file_priv, dev, args-&gt;size,&amp;args-&gt;handle)</span><br><span class="line">    <span class="comment">// #1 创建并初始化Rockchip驱动自定义的GEM对象</span></span><br><span class="line">    rk_obj = rockchip_gem_create_object(drm, size, is_framebuffer) </span><br><span class="line">        <span class="comment">// #1.1 创建Rockchip驱动自定义的GEM对象 </span></span><br><span class="line">        rk_obj = rockchip_gem_alloc_object(drm, size)          </span><br><span class="line">            <span class="comment">// GEM对象初始化</span></span><br><span class="line">            drm_gem_object_init(drm, obj, size)       </span><br><span class="line">        <span class="comment">// #1.2 为Rockchip GEM对象分配DMA缓冲区，或者在IOMMU上分配内存</span></span><br><span class="line">         rockchip_gem_alloc_buf(rk_obj, alloc_kmap)    </span><br><span class="line">            rockchip_gem_alloc_dma(rk_obj, alloc_kmap)   </span><br><span class="line">                <span class="comment">// 分配DMA缓冲区。分配的大小为obj-&gt;size字节，属性为rk_obj-&gt;dma_attrs</span></span><br><span class="line">                rk_obj-&gt;kvaddr = dma_alloc_attrs(drm-&gt;dev, obj-&gt;size,</span><br><span class="line">                                         &amp;rk_obj-&gt;dma_addr, GFP_KERNEL,</span><br><span class="line">                                         rk_obj-&gt;dma_attrs);</span><br><span class="line">    <span class="comment">// 获取GEM对象 struct drm_gem_object</span></span><br><span class="line">    obj = &amp;rk_obj-&gt;base;</span><br><span class="line">    <span class="comment">// #2 创建GEM对象handle</span></span><br><span class="line">    drm_gem_handle_create(file_priv, obj, handle)    </span><br><span class="line">    <span class="comment">// 3# 引用计数-1</span></span><br><span class="line">    drm_gem_object_put(obj) </span><br></pre></td></tr></table></figure>

<p><code>rockchip_gem_alloc_dma</code>函数执行后会创建了一块内存放在了<code>rockchip gem object</code>的对象里。</p>
<h5 id="3-1-1-struct-rockchip-gem-object"><a href="#3-1-1-struct-rockchip-gem-object" class="headerlink" title="3.1.1 struct rockchip_gem_object"></a>3.1.1 <code>struct rockchip_gem_object</code></h5><p><code>struct rockchip_gem_object</code>为<code>Rockchip</code>驱动扩展的<code>gem object</code>，定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_gem.h</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rockchip_gem_object</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> <span class="title">base</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> *kvaddr;</span><br><span class="line">        <span class="keyword">dma_addr_t</span> dma_addr;</span><br><span class="line">        <span class="comment">/* Used when IOMMU is disabled */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> dma_attrs;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Used when IOMMU is enabled */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_mm_node</span> <span class="title">mm</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> num_pages;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> **<span class="title">pages</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *<span class="title">sgt</span>;</span></span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>base</code>：这是内核定义的<code>gem object</code>结构；</li>
<li><code>kvaddr</code>：这个字段是一个指向虚拟地址的指针，它可能指向这个<code>GEM</code>对象在用户空间中的虚拟地址；</li>
<li><code>dma_addr</code>：这个字段是设备内存地址，它可能被用于直接内存访问（<code>DMA</code>）操作；</li>
<li><code>dma_attrs</code>：这个字段可能用于存储与<code>DMA</code>操作相关的属性；</li>
<li><code>num_pages</code>：这个字段表示这个<code>GEM</code>对象占用的页面数量；</li>
<li><code>pages</code>：这是一个指向<code>struct page</code>的指针数组，它可能用于存储这个<code>GEM</code>对象占用的所有页面的信息；</li>
<li><code>size</code>：这个字段表示这个<code>GEM</code>对象的大小；</li>
</ul>
<h5 id="3-1-2-rockchip-gem-alloc-object"><a href="#3-1-2-rockchip-gem-alloc-object" class="headerlink" title="3.1.2 rockchip_gem_alloc_object"></a>3.1.2 <code>rockchip_gem_alloc_object</code></h5><p><code>rockchip_gem_alloc_object</code>用于创建<code>Rockchip</code>驱动自定义的<code>GEM</code>对象；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object_funcs</span> <span class="title">rockchip_gem_object_funcs</span> = &#123;</span></span><br><span class="line">         <span class="comment">// 释放GEM对象及其相关资源的操作</span></span><br><span class="line">        .<span class="built_in">free</span> = rockchip_gem_free_object,</span><br><span class="line">        .get_sg_table = rockchip_gem_prime_get_sg_table,</span><br><span class="line">        .vmap = rockchip_gem_prime_vmap,</span><br><span class="line">        .vunmap = rockchip_gem_prime_vunmap,</span><br><span class="line">        .mmap = rockchip_drm_gem_object_mmap,</span><br><span class="line">        .vm_ops = &amp;drm_gem_dma_vm_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_gem_object</span> *</span></span><br><span class="line"><span class="class">        <span class="title">rockchip_gem_alloc_object</span>(<span class="title">struct</span> <span class="title">drm_device</span> *<span class="title">drm</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_gem_object</span> *<span class="title">rk_obj</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span>;</span></span><br><span class="line"></span><br><span class="line">        size = round_up(size, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">        rk_obj = kzalloc(<span class="keyword">sizeof</span>(*rk_obj), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!rk_obj)</span><br><span class="line">                <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">        obj = &amp;rk_obj-&gt;base;</span><br><span class="line"></span><br><span class="line">        obj-&gt;funcs = &amp;rockchip_gem_object_funcs;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化gem object</span></span><br><span class="line">        drm_gem_object_init(drm, obj, size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rk_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程如此：</p>
<ul>
<li>调用<code>kzalloc</code>动态分配<code>Rockchip</code>驱动自定义的<code>GEM</code>对象 <code>struct rockchip_gem_object</code>；</li>
<li>然后设定<code>GEM</code>对象<code>funcs</code>为<code>rockchip_gem_object_funcs</code>；</li>
<li>最后调用<code>drm_gem_object_init</code>初始化<code>GEM</code>对象，创建一个大小为<code>size</code>的<code>shmfs</code>，并将这个<code>shmfs file</code>存放到<code>struct drm_gem_object</code>的<code>filp</code>字段。</li>
</ul>
<h5 id="3-1-3-rockchip-gem-alloc-buf"><a href="#3-1-3-rockchip-gem-alloc-buf" class="headerlink" title="3.1.3 rockchip_gem_alloc_buf"></a>3.1.3 <code>rockchip_gem_alloc_buf</code></h5><p><code>rockchip_gem_alloc_buf</code>函数用于为<code>Rockchip GEM</code>对象分配<code>DMA</code>缓冲区，或者在<code>IOMMU</code>上分配内存；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_gem_alloc_buf</span><span class="params">(struct rockchip_gem_object *rk_obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">bool</span> alloc_kmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span> = &amp;<span class="title">rk_obj</span>-&gt;<span class="title">base</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">drm</span> = <span class="title">obj</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">        <span class="comment">// 获取drm驱动私有数据</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_drm_private</span> *<span class="title">private</span> = <span class="title">drm</span>-&gt;<span class="title">dev_private</span>;</span> </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">private</span>-&gt;domain)</span><br><span class="line">                <span class="comment">// 为Rockchip GEM对象在IOMMU上分配内存</span></span><br><span class="line">                <span class="keyword">return</span> rockchip_gem_alloc_iommu(rk_obj, alloc_kmap);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 为Rockchip GEM对象分配DMA缓冲区</span></span><br><span class="line">                <span class="keyword">return</span> rockchip_gem_alloc_dma(rk_obj, alloc_kmap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于没有初始化<code>private-&gt;domain</code>，因此会执行<code>rockchip_gem_alloc_dma</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_gem_alloc_iommu</span><span class="params">(struct rockchip_gem_object *rk_obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">bool</span> alloc_kmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取页面</span></span><br><span class="line">        ret = rockchip_gem_get_pages(rk_obj);  </span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将GEM对象映射到IOMMU</span></span><br><span class="line">        ret = rockchip_gem_iommu_map(rk_obj); </span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> err_free;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (alloc_kmap) &#123;</span><br><span class="line">                <span class="comment">// 将获取到的页面映射到内核虚拟地址空间中</span></span><br><span class="line">                rk_obj-&gt;kvaddr = vmap(rk_obj-&gt;pages, rk_obj-&gt;num_pages, VM_MAP,</span><br><span class="line">                                      pgprot_writecombine(PAGE_KERNEL));</span><br><span class="line">                <span class="keyword">if</span> (!rk_obj-&gt;kvaddr) &#123;</span><br><span class="line">                        DRM_ERROR(<span class="string">&quot;failed to vmap() buffer\n&quot;</span>);</span><br><span class="line">                        ret = -ENOMEM;</span><br><span class="line">                        <span class="keyword">goto</span> err_unmap;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_unmap:</span><br><span class="line">        <span class="comment">// 解除IOMMU映射</span></span><br><span class="line">        rockchip_gem_iommu_unmap(rk_obj);</span><br><span class="line">err_free:</span><br><span class="line">        <span class="comment">// 释放页面</span></span><br><span class="line">        rockchip_gem_put_pages(rk_obj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_gem_alloc_dma</span><span class="params">(struct rockchip_gem_object *rk_obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">bool</span> alloc_kmap)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span> = &amp;<span class="title">rk_obj</span>-&gt;<span class="title">base</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_device</span> *<span class="title">drm</span> = <span class="title">obj</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line">        rk_obj-&gt;dma_attrs = DMA_ATTR_WRITE_COMBINE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!alloc_kmap)</span><br><span class="line">                rk_obj-&gt;dma_attrs |= DMA_ATTR_NO_KERNEL_MAPPING;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分配DMA缓冲区。分配的大小为obj-&gt;size字节，属性为rk_obj-&gt;dma_attrs</span></span><br><span class="line">        rk_obj-&gt;kvaddr = dma_alloc_attrs(drm-&gt;dev, obj-&gt;size,</span><br><span class="line">                                         &amp;rk_obj-&gt;dma_addr, GFP_KERNEL,</span><br><span class="line">                                         rk_obj-&gt;dma_attrs);</span><br><span class="line">        <span class="keyword">if</span> (!rk_obj-&gt;kvaddr) &#123;</span><br><span class="line">                DRM_ERROR(<span class="string">&quot;failed to allocate %zu byte dma buffer&quot;</span>, obj-&gt;size);</span><br><span class="line">                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-framebuffer创建"><a href="#3-2-framebuffer创建" class="headerlink" title="3.2 framebuffer创建"></a>3.2 <code>framebuffer</code>创建</h4><p>介绍完了<code>gem object</code>的创建和初始化，我们知道<code>drm framebuffer</code>的实现依赖于底层内存管理器比如<code>GEM</code>、<code>TTM</code>。</p>
<p>那么<code>struct drm_frmebuffer</code>是怎么创建的呢？</p>
<p>这里我们需要回顾一下《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyly/p/17686403.html"><code>Rockchip RK3399 - DRM</code>驱动程序</a>》文章中介绍的<code>rockchip_drm_bind</code>函数，在该函数执行中会进行模式配置的初始化，在jams及<code>rockchip_drm_mode_config_init</code>中有如下一行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dev-&gt;mode_config.funcs = &amp;rockchip_drm_mode_config_funcs;</span><br></pre></td></tr></table></figure>

<p><code>drm</code>设备模式设置<code>mode_config</code>的回调函数<code>funcs</code>被设置为<code>rockchip_drm_mode_config_funcs</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_mode_config_funcs</span> <span class="title">rockchip_drm_mode_config_funcs</span> = &#123;</span></span><br><span class="line">        .fb_create = rockchip_fb_create,</span><br><span class="line">        .atomic_check = drm_atomic_helper_check,</span><br><span class="line">        .atomic_commit = drm_atomic_helper_commit,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>fb_create</code> 回调接口用于创建<code>framebuffer object</code>，并绑定<code>GEM</code>对象。</p>
<p><code>rockchip_fb_create</code>定义在<code>drivers/gpu/drm/rockchip/rockchip_drm_fb.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_framebuffer_funcs</span> <span class="title">rockchip_drm_fb_funcs</span> = &#123;</span></span><br><span class="line">        .destroy       = drm_gem_fb_destroy,</span><br><span class="line">        .create_handle = drm_gem_fb_create_handle,</span><br><span class="line">        .dirty         = drm_atomic_helper_dirtyfb,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_framebuffer</span> *</span></span><br><span class="line"><span class="class"><span class="title">rockchip_fb_create</span>(<span class="title">struct</span> <span class="title">drm_device</span> *<span class="title">dev</span>, <span class="title">struct</span> <span class="title">drm_file</span> *<span class="title">file</span>,</span></span><br><span class="line"><span class="class">                   <span class="title">const</span> <span class="title">struct</span> <span class="title">drm_mode_fb_cmd2</span> *<span class="title">mode_cmd</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_afbc_framebuffer</span> *<span class="title">afbc_fb</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_format_info</span> *<span class="title">info</span>;</span></span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取drm格式</span></span><br><span class="line">        info = drm_get_format_info(dev, mode_cmd);</span><br><span class="line">        <span class="keyword">if</span> (!info)</span><br><span class="line">                <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 动态分配内存，指向struct drm_afbc_framebuffer</span></span><br><span class="line">        afbc_fb = kzalloc(<span class="keyword">sizeof</span>(*afbc_fb), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!afbc_fb)</span><br><span class="line">                <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化成员afbc_fb-&gt;base，struct drm_framebuffer类型；同时设置framebuffer的funcs为rockchip_drm_fb_funcs</span></span><br><span class="line">        ret = drm_gem_fb_init_with_funcs(dev, &amp;afbc_fb-&gt;base, file, mode_cmd,</span><br><span class="line">                                         &amp;rockchip_drm_fb_funcs);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                kfree(afbc_fb);</span><br><span class="line">                <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果支持afbc</span></span><br><span class="line">        <span class="keyword">if</span> (drm_is_afbc(mode_cmd-&gt;modifier[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">int</span> ret, i;</span><br><span class="line"></span><br><span class="line">                ret = drm_gem_fb_afbc_init(dev, mode_cmd, afbc_fb);</span><br><span class="line">                <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> **<span class="title">obj</span> = <span class="title">afbc_fb</span>-&gt;<span class="title">base</span>.<span class="title">obj</span>;</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; info-&gt;num_planes; ++i)</span><br><span class="line">                                drm_gem_object_put(obj[i]);</span><br><span class="line"></span><br><span class="line">                        kfree(afbc_fb);</span><br><span class="line">                        <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回framebuffer</span></span><br><span class="line">        <span class="keyword">return</span> &amp;afbc_fb-&gt;base;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-2-1-drm-gem-fb-init-with-funcs"><a href="#3-2-1-drm-gem-fb-init-with-funcs" class="headerlink" title="3.2.1 drm_gem_fb_init_with_funcs"></a>3.2.1 <code>drm_gem_fb_init_with_funcs</code></h5><p><code>drm_gem_fb_init_with_funcs</code>是一个用于实现<code>&amp;drm_mode_config_funcs.fb_create</code>回调函数的辅助函数。它适用于那些初始化<code>framebuffer</code>时同时提供自定义的<code>framebuffer</code>操作集合的驱动程序，<code>drm_gem_fb_init_with_funcs</code>定义在<code>drivers/gpu/drm/drm_gem_framebuffer_helper.c：</code></p>
<p>函数参数说明：</p>
<ul>
<li><code>dev</code>：<code>DRM</code>设备结构体指针。</li>
<li><code>fb</code>：<code>framebuffer</code>对象指针。</li>
<li><code>file</code>：保存了支持<code>framebuffer</code>的<code>GEM</code>句柄的<code>DRM</code>文件指针；</li>
<li><code>mode_cmd</code>：用户空间<code>framebuffer</code>创建请求的元数据；</li>
<li><code>funcs</code>：<code>framebuffer</code>操作结合；</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_gem_fb_init_with_funcs() - Helper function for implementing</span></span><br><span class="line"><span class="comment"> *                                &amp;drm_mode_config_funcs.fb_create</span></span><br><span class="line"><span class="comment"> *                                callback in cases when the driver</span></span><br><span class="line"><span class="comment"> *                                allocates a subclass of</span></span><br><span class="line"><span class="comment"> *                                struct drm_framebuffer</span></span><br><span class="line"><span class="comment"> * @dev: DRM device</span></span><br><span class="line"><span class="comment"> * @fb: framebuffer object</span></span><br><span class="line"><span class="comment"> * @file: DRM file that holds the GEM handle(s) backing the framebuffer</span></span><br><span class="line"><span class="comment"> * @mode_cmd: Metadata from the userspace framebuffer creation request</span></span><br><span class="line"><span class="comment"> * @funcs: vtable to be used for the new framebuffer object</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function can be used to set &amp;drm_framebuffer_funcs for drivers that need</span></span><br><span class="line"><span class="comment"> * custom framebuffer callbacks. Use drm_gem_fb_create() if you don&#x27;t need to</span></span><br><span class="line"><span class="comment"> * change &amp;drm_framebuffer_funcs. The function does buffer size validation.</span></span><br><span class="line"><span class="comment"> * The buffer size validation is for a general case, though, so users should</span></span><br><span class="line"><span class="comment"> * pay attention to the checks being appropriate for them or, at least,</span></span><br><span class="line"><span class="comment"> * non-conflicting.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns:</span></span><br><span class="line"><span class="comment"> * Zero or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">drm_gem_fb_init_with_funcs</span><span class="params">(struct drm_device *dev,</span></span></span><br><span class="line"><span class="function"><span class="params">                               struct drm_framebuffer *fb,</span></span></span><br><span class="line"><span class="function"><span class="params">                               struct drm_file *file,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> struct drm_mode_fb_cmd2 *mode_cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> struct drm_framebuffer_funcs *funcs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_format_info</span> *<span class="title">info</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> *<span class="title">objs</span>[<span class="title">DRM_FORMAT_MAX_PLANES</span>];</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取DRM格式信息</span></span><br><span class="line">        info = drm_get_format_info(dev, mode_cmd);</span><br><span class="line">        <span class="keyword">if</span> (!info) &#123;</span><br><span class="line">                drm_dbg_kms(dev, <span class="string">&quot;Failed to get FB format info\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历每一个color plane</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; info-&gt;num_planes; i++) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">int</span> width = mode_cmd-&gt;width / (i ? info-&gt;hsub : <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">int</span> height = mode_cmd-&gt;height / (i ? info-&gt;vsub : <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">int</span> min_size;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 查找对应color plane的GEM对象</span></span><br><span class="line">                objs[i] = drm_gem_object_lookup(file, mode_cmd-&gt;handles[i]);</span><br><span class="line">                <span class="keyword">if</span> (!objs[i]) &#123;</span><br><span class="line">                        drm_dbg_kms(dev, <span class="string">&quot;Failed to lookup GEM object\n&quot;</span>);</span><br><span class="line">                        ret = -ENOENT;</span><br><span class="line">                        <span class="keyword">goto</span> err_gem_object_put;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                min_size = (height - <span class="number">1</span>) * mode_cmd-&gt;pitches[i]</span><br><span class="line">                         + drm_format_info_min_pitch(info, i, width)</span><br><span class="line">                         + mode_cmd-&gt;offsets[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (objs[i]-&gt;size &lt; min_size) &#123;</span><br><span class="line">                        drm_dbg_kms(dev,</span><br><span class="line">                                    <span class="string">&quot;GEM object size (%zu) smaller than minimum size (%u) for plane %d\n&quot;</span>,</span><br><span class="line">                                    objs[i]-&gt;size, min_size, i);</span><br><span class="line">                        drm_gem_object_put(objs[i]);</span><br><span class="line">                        ret = -EINVAL;</span><br><span class="line">                        <span class="keyword">goto</span> err_gem_object_put;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化framebuffer对象</span></span><br><span class="line">        ret = drm_gem_fb_init(dev, fb, mode_cmd, objs, i, funcs);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">goto</span> err_gem_object_put;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_gem_object_put:</span><br><span class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                --i;</span><br><span class="line">                drm_gem_object_put(objs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数主要流程如下：</p>
<ul>
<li>通过<code>drm_get_format_info</code>函数获取<code>DRM</code>格式信息，如果失败则返回错误；</li>
<li>遍历每个<code>color plane</code>，计算出每个<code>color plane</code>的宽度、高度和最小尺寸；</li>
<li>使用<code>drm_gem_object_lookup</code>函数查找对应<code>color plane</code>的<code>GEM</code>对象，如果失败则返回错误；</li>
<li>对比<code>GEM</code>对象的大小和最小尺寸，如果大小小于最小尺寸则返回错误；</li>
<li>调用<code>drm_gem_fb_init</code>函数初始化<code>framebuffer</code>对象。</li>
</ul>
<h5 id="3-2-2-drm-gem-fb-init"><a href="#3-2-2-drm-gem-fb-init" class="headerlink" title="3.2.2 drm_gem_fb_init"></a>3.2.2 <code>drm_gem_fb_init</code></h5><p><code>drm_gem_fb_init</code>函数用于初始化<code>framebuffer</code>对象，函数定义在<code>drivers/gpu/drm/drm_gem_framebuffer_helper.c</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">drm_gem_fb_init(struct drm_device *dev,</span><br><span class="line">                 struct drm_framebuffer *fb,</span><br><span class="line">                 <span class="keyword">const</span> struct drm_mode_fb_cmd2 *mode_cmd,</span><br><span class="line">                 struct drm_gem_object **obj, <span class="keyword">unsigned</span> <span class="keyword">int</span> num_planes,</span><br><span class="line">                 <span class="keyword">const</span> struct drm_framebuffer_funcs *funcs)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        drm_helper_mode_fill_fb_struct(dev, fb, mode_cmd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_planes; i++)</span><br><span class="line">                fb-&gt;obj[i] = obj[i];</span><br><span class="line"></span><br><span class="line">        ret = drm_framebuffer_init(dev, fb, funcs);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                drm_err(dev, <span class="string">&quot;Failed to init framebuffer: %d\n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>参考文章</strong></p>
<p><strong>[1] <a target="_blank" rel="noopener" href="https://blog.csdn.net/ytfy339784578/article/details/104557569"><code>DRM</code>的<code>GEM</code></a></strong></p>
<p><strong>[2] <a target="_blank" rel="noopener" href="https://blog.csdn.net/hexiaolong2009/article/details/108655052"><code>DRM</code> 驱动<code>mmap</code>详解：（二）<code>CMA Helper</code></a></strong></p>
<p><strong>[3] <a target="_blank" rel="noopener" href="https://docs.kernel.org/gpu/drm-internals.html"><code>linux kernel DRM Internals</code></a></strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20240221/">https://zhoujinjian.com/posts/20240221/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20240222/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</div></div></a></div><div class="next-post pull-right"><a href="/posts/20240220/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.59.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 11 Display System V2（3）：Rockchip RK3399 - DRM framebuffer、plane基础知识</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81GEM%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">一、GEM数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-struct-drm-gem-object"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 struct drm_gem_object</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-struct-drm-gem-object-funcs"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 struct drm_gem_object_funcs</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83API"><span class="toc-number">2.</span> <span class="toc-text">二、核心API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-GEM%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 GEM初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-GEM%E5%AF%B9%E8%B1%A1%E5%91%BD%E5%90%8D"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 GEM对象命名</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-1-GEM-handle"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1 GEM handle</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-GEM%E5%90%8D%E7%A7%B0"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2 GEM名称</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3 文件描述符</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-GEM%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 GEM对象的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-GEM%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 GEM对象内存映射</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81Rockchip-gem%E9%A9%B1%E5%8A%A8"><span class="toc-number">3.</span> <span class="toc-text">三、Rockchip gem驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-gem-object%E5%88%9B%E5%BB%BA%E5%8F%8A%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 gem object创建及初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-struct-rockchip-gem-object"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1 struct rockchip_gem_object</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2-rockchip-gem-alloc-object"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2 rockchip_gem_alloc_object</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3-rockchip-gem-alloc-buf"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.1.3 rockchip_gem_alloc_buf</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-framebuffer%E5%88%9B%E5%BB%BA"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 framebuffer创建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-drm-gem-fb-init-with-funcs"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 drm_gem_fb_init_with_funcs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-drm-gem-fb-init"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 drm_gem_fb_init</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>