<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android P Graphics System（三）：Qualcomm HWC2（Hardware Composer 2.0 ）分析 | zhoujinjian</title><meta name="keywords" content="Android,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android P Graphics System（三）：Qualcomm HWC2（Hardware Composer 2.0 ）分析">
<meta property="og:url" content="https://zhoujinjian.com/posts/20190708/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.38.jpg">
<meta property="article:published_time" content="2019-07-08T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.960Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.38.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20190708/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.38.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android P Graphics System（三）：Qualcomm HWC2（Hardware Composer 2.0 ）分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-07-08T01:25:00.000Z" title="发表于 2019-07-08 09:25:00">2019-07-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.960Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Graphics/">Graphics</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<p>注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。<br>（==<strong>文章基于 Kernel-3.18</strong>==）&amp;&amp;（==<strong>文章基于 Android 9.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://www.intrinsyc.com/snapdragon-embedded-development-kits/open-q-820-usom-development-kit/">【开发板 Intrinsyc Open-Q™ 820 µSOM Development Kit】</a><br><a target="_blank" rel="noopener" href="https://gitlab.com/zhoujinjianzz/apq8096_la.um.7.5.r1-03100-8x96.0_p_v5.0">【开发板 Android 9.0 &amp;&amp; Linux（Kernel 3.18）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/824a9ddf68b9">（1）【Android P 图形显示系统（一）硬件合成HWC2】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yangwen123/article/details/79854267">（2）【AndroidO Treble架构下Hal进程启动及HIDL服务注册过程】</a><br><a target="_blank" rel="noopener" href="http://charlesvincent.cc/2018/09/28/Android%20O%20Treble%20%E6%9E%B6%E6%9E%84%20-%20HIDL%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">（3）【Android O Treble 架构 - HIDL源代码分析】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yangwen123/article/details/79868548">（4）【AndroidO Treble架构下HIDL IComposer服务查询过程】</a></p>
<hr>
<p>==源码（部分）==：</p>
<blockquote>
<p>SurfaceFlinger</p>
</blockquote>
<ul>
<li>frameworks/native/services/surfaceflinger</li>
</ul>
<blockquote>
<p>HWC2</p>
</blockquote>
<ul>
<li>hardware/qcom/display/sdm/libs/hwc2/</li>
</ul>
<hr>
<h4 id="（一）、HWC2介绍"><a href="#（一）、HWC2介绍" class="headerlink" title="（一）、HWC2介绍"></a>（一）、HWC2介绍</h4><h5 id="1-1-0-、HWC2概述"><a href="#1-1-0-、HWC2概述" class="headerlink" title="1.1.0 、HWC2概述"></a>1.1.0 、HWC2概述</h5><p>Android 7.0 包含新版本的 HWC (HWC2)，Android需要自行配置，到Android 8.0，HWC2正式开启，且版本升级为2.1版本。HWC2是 SurfaceFlinger 用来与专门的窗口合成硬件进行通信。SurfaceFlinger 包含使用 3D 图形处理器 (GPU) 执行窗口合成任务的备用路径，但由于以下几个原因，此路径并不理想：</p>
<ul>
<li>通常，GPU 未针对此用例进行过优化，因此能耗可能要大于执行合成所需的能耗。</li>
<li>每次 SurfaceFlinger 使用 GPU 进行合成时，应用都无法使用处理器进行自我渲染，因此应尽可能使用专门的硬件而不是 GPU 进行合成。</li>
</ul>
<p>下面是GPU和HWC两种方式的优劣对比：</p>
<table>
<thead>
<tr>
<th align="center">合成类型</th>
<th align="center">耗电情况</th>
<th align="center">性能情况</th>
<th align="center">Alpha处理</th>
<th align="center">DRM内容处理</th>
<th align="center">其他限制</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Device合成（HWC）</td>
<td align="center">耗电低</td>
<td align="center">性能高</td>
<td align="center">很多Vendor的HWC不支持Alpha的处理和合成</td>
<td align="center">基本都能访问DRM内容</td>
<td align="center">能合成的Surface层数有限，对每种Surface类型处理层数有限</td>
</tr>
<tr>
<td align="center">Client合成（GPU）</td>
<td align="center">耗电高</td>
<td align="center">性能低</td>
<td align="center">能处理每个像素的Alpha及每个Layear的Alpha</td>
<td align="center">早期版本GPU不能访问DRM的内容</td>
<td align="center">目前的处理层数没有限制</td>
</tr>
</tbody></table>
<p>所以，HWC的设计最好遵循一些基本的规则～</p>
<h5 id="1-2-0-、HWC常规准则"><a href="#1-2-0-、HWC常规准则" class="headerlink" title="1.2.0 、HWC常规准则"></a>1.2.0 、HWC常规准则</h5><p>由于 Hardware Composer 抽象层后的物理显示设备硬件可因设备而异，因此很难就具体功能提供建议。一般来说，请遵循以下准则：</p>
<ul>
<li><p>HWC 应至少支持 4 个叠加层（状态栏、系统栏、应用和壁纸/背景）。</p>
</li>
<li><p>层可以大于屏幕，因此 HWC 应能处理大于显示屏的层（例如壁纸）。</p>
</li>
<li><p>应同时支持预乘每像素 Alpha 混合和每平面 Alpha 混合。</p>
</li>
<li><p>HWC 应能处理 GPU、相机和视频解码器生成的相同缓冲区，因此支持以下某些属性很有帮助：</p>
<ul>
<li>RGBA 打包顺序</li>
<li>YUV 格式</li>
<li>Tiling, swizzling和步幅属性</li>
</ul>
</li>
<li><p>为了支持受保护的内容，必须提供受保护视频播放的硬件路径。</p>
</li>
</ul>
<p>Tiling，翻译过来就没有原文的意味了，说白了，就是将image进行切割，切成MxN的小块，最后用的时候，再将这些小块拼接起来，就像铺瓷砖一样。<br>swizzling，比Tiling难理解点，它是一种拌和技术，这是向量的单元可以被任意地重排或重复，见过的hwc代码写的都比较隐蔽，没有见多处理的地方。<br>HWC专注于优化，智能地选择要发送到叠加硬件的 Surface，以最大限度减轻 GPU 的负载。另一种优化是检测屏幕是否正在更新；如果不是，则将合成委托给 OpenGL 而不是 HWC，以节省电量。当屏幕再次更新时，继续将合成分载到 HWC。<br>为常见用例做准备，如：</p>
<ul>
<li>纵向和横向模式下的全屏游戏</li>
<li>带有字幕和播放控件的全屏视频</li>
<li>主屏幕（合成状态栏、系统栏、应用窗口和动态壁纸）</li>
<li>受保护的视频播放</li>
<li>多显示设备支持</li>
</ul>
<h5 id="1-3-0-、HWC2-框架"><a href="#1-3-0-、HWC2-框架" class="headerlink" title="1.3.0 、HWC2 框架"></a>1.3.0 、HWC2 框架</h5><p>从Android 8.0开始的Treble项目，对Android的架构做了重大的调整，让制造商以更低的成本更轻松、更快速地将设备更新到新版 Android 系统。这就对 HAL 层有了很大的调整，利用提供给Vendor的接口，将Vendor的实现和Android上层分离开来。<br>这样的架构让HWC的架构也变的复杂，HWC属于Binderized的HAL类型。Binderized类型的HAL，将上层Androd和底层HAL分别采用两个不用的进程实现，中间采用Binder进行通信，为了和前面的Binder进行区别，这里采用HwBinder。<br>因此，我们可以将HWC再进行划分，可以分为下面这几个部分，如下图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_Pipeline.png" alt="Alt text | center"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_Arc.png" alt="Alt text | center"></p>
<ul>
<li><strong>Client端</strong><br>Client也就是SurfaceFlinger，不过SurfaceFlinger采用前后端的设计，以后和HWC相关的逻辑应该都会放到SurfaceFlinger后端也就是SurfaceFlingerBE中。代码位置：</li>
</ul>
<blockquote>
<p>frameworks/native/services/surfaceflinger</p>
</blockquote>
<ul>
<li><strong>HWC2 Client端</strong><br>这一部分属于SurfaceFlinger进程，其直接通过Binder通信，和HWC2的HAL Server交互。这部分的代码也在SurfaceFlinger进程中，但是采用Hwc2的命名空间。</li>
<li><strong>HWC Server端</strong><br>这一部分还是属于Android的系统，这里将建立一个进程，实现HWC的服务端，Server端再调底层Vendor的具体实现。并且，对于底层合成的实现不同，这里会做一些适配，适配HWC1.x，和FrameBuffer的实现。这部分包含三部分：接口，实现和服务，以动态库的形式存在：</li>
</ul>
<blockquote>
<p>代码位置： hardware/interfaces/graphics/composer/2.1/default<br>动态库：<br><a href="mailto:&#x61;&#x6e;&#x64;&#x72;&#x6f;&#x69;&#100;&#x2e;&#x68;&#97;&#x72;&#x64;&#x77;&#x61;&#x72;&#x65;&#x2e;&#103;&#114;&#x61;&#x70;&#104;&#x69;&#99;&#x73;&#x2e;&#x63;&#111;&#109;&#x70;&#x6f;&#x73;&#101;&#x72;&#x40;&#50;&#46;&#49;&#46;&#x73;&#x6f;">&#x61;&#x6e;&#x64;&#x72;&#x6f;&#x69;&#100;&#x2e;&#x68;&#97;&#x72;&#x64;&#x77;&#x61;&#x72;&#x65;&#x2e;&#103;&#114;&#x61;&#x70;&#104;&#x69;&#99;&#x73;&#x2e;&#x63;&#111;&#109;&#x70;&#x6f;&#x73;&#101;&#x72;&#x40;&#50;&#46;&#49;&#46;&#x73;&#x6f;</a><br><a href="mailto:&#97;&#x6e;&#100;&#x72;&#111;&#105;&#100;&#x2e;&#104;&#97;&#x72;&#100;&#119;&#x61;&#x72;&#x65;&#46;&#x67;&#114;&#x61;&#x70;&#x68;&#105;&#x63;&#x73;&#x2e;&#x63;&#111;&#x6d;&#112;&#111;&#x73;&#x65;&#x72;&#x40;&#50;&#46;&#49;&#x2d;&#105;&#109;&#x70;&#x6c;&#x2e;&#x73;&#111;">&#97;&#x6e;&#100;&#x72;&#111;&#105;&#100;&#x2e;&#104;&#97;&#x72;&#100;&#119;&#x61;&#x72;&#x65;&#46;&#x67;&#114;&#x61;&#x70;&#x68;&#105;&#x63;&#x73;&#x2e;&#x63;&#111;&#x6d;&#112;&#111;&#x73;&#x65;&#x72;&#x40;&#50;&#46;&#49;&#x2d;&#105;&#109;&#x70;&#x6c;&#x2e;&#x73;&#111;</a><br><a href="mailto:&#x61;&#x6e;&#x64;&#114;&#x6f;&#105;&#100;&#x2e;&#104;&#x61;&#x72;&#x64;&#119;&#97;&#x72;&#101;&#x2e;&#103;&#114;&#x61;&#x70;&#x68;&#x69;&#99;&#x73;&#x2e;&#99;&#111;&#109;&#112;&#111;&#115;&#x65;&#114;&#x40;&#50;&#x2e;&#x31;&#x2d;&#115;&#x65;&#114;&#x76;&#105;&#x63;&#101;&#46;&#x73;&#111;">&#x61;&#x6e;&#x64;&#114;&#x6f;&#105;&#100;&#x2e;&#104;&#x61;&#x72;&#x64;&#119;&#97;&#x72;&#101;&#x2e;&#103;&#114;&#x61;&#x70;&#x68;&#x69;&#99;&#x73;&#x2e;&#99;&#111;&#109;&#112;&#111;&#115;&#x65;&#114;&#x40;&#50;&#x2e;&#x31;&#x2d;&#115;&#x65;&#114;&#x76;&#105;&#x63;&#101;&#46;&#x73;&#111;</a></p>
</blockquote>
<ul>
<li><strong>HWC Vendor的实现</strong><br>这部分是HWC的具体实现，这部分的实现由硬件厂商完成。比如高通平台，代码位置一般为：</li>
</ul>
<blockquote>
<p>G:\android9.0\hardware\qcom\display\sdm\libs</p>
<blockquote>
<p>core<br>hwc<br>hwc2<br>utils</p>
</blockquote>
</blockquote>
<p>需要注意的是，HWC必须采用Binderized HAL模式，但是，并没有要求一定要实现HWC2的HAL版本。HWC2的实现需要配置，以Android 9.0为例：</p>
<ul>
<li>添加宏定义 TARGET_USES_HWC2</li>
<li>编译打包HWC2相关的so库</li>
<li>SeLinux相关的权限添加</li>
<li>配置manifest.xml</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> &lt;hal format=<span class="string">&quot;hidl&quot;</span>&gt;</span><br><span class="line">    &lt;name&gt;android.hardware.graphics.composer&lt;/name&gt;</span><br><span class="line">    &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.1</span>&lt;/version&gt;</span><br><span class="line">    &lt;interface&gt;</span><br><span class="line">        &lt;name&gt;IComposer&lt;/name&gt;</span><br><span class="line">        &lt;instance&gt;<span class="keyword">default</span>&lt;/instance&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">&lt;/hal&gt;</span><br></pre></td></tr></table></figure>


<h4 id="（二）、HWC2合成服务-Composer-Service-启动流程"><a href="#（二）、HWC2合成服务-Composer-Service-启动流程" class="headerlink" title="（二）、HWC2合成服务(Composer Service)启动流程"></a>（二）、HWC2合成服务(Composer Service)启动流程</h4><p>Android Framework进程和Hal分离，每个Hal独立运行在自己的进程地址空间，那么这些Hal进程是如何启动的呢？本文以composer hal为例展开分析。</p>
<p>在以下路径有composer hal的rc启动脚本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hardware/interfaces/graphics/composer/<span class="number">2.1</span>/<span class="keyword">default</span>/android.hardware.graphics.composer@<span class="number">2.1</span>-service.rc</span><br><span class="line"></span><br><span class="line">service hwcomposer<span class="number">-2</span><span class="number">-1</span> /vendor/bin/hw/android.hardware.graphics.composer@<span class="number">2.1</span>-service</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">hal</span> <span class="title">animation</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">graphics</span> <span class="title">drmrpc</span></span></span><br><span class="line"><span class="class">    <span class="title">capabilities</span> <span class="title">SYS_NICE</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">surfaceflinger</span></span></span><br></pre></td></tr></table></figure>

<p>编译后，会将该脚本文件copy到vendor/etc/init目录，在开机时，init进程会读取并解析这个脚本，然后启动<a href="mailto:&#x61;&#110;&#x64;&#x72;&#x6f;&#x69;&#100;&#46;&#x68;&#97;&#114;&#100;&#119;&#97;&#x72;&#x65;&#x2e;&#103;&#114;&#x61;&#112;&#104;&#105;&#99;&#115;&#46;&#x63;&#x6f;&#x6d;&#112;&#x6f;&#115;&#x65;&#x72;&#x40;&#x32;&#x2e;&#49;&#x2d;&#115;&#x65;&#x72;&#118;&#x69;&#x63;&#x65;">&#x61;&#110;&#x64;&#x72;&#x6f;&#x69;&#100;&#46;&#x68;&#97;&#114;&#100;&#119;&#97;&#x72;&#x65;&#x2e;&#103;&#114;&#x61;&#112;&#104;&#105;&#99;&#115;&#46;&#x63;&#x6f;&#x6d;&#112;&#x6f;&#115;&#x65;&#x72;&#x40;&#x32;&#x2e;&#49;&#x2d;&#115;&#x65;&#x72;&#118;&#x69;&#x63;&#x65;</a>进程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msm8996:/ $ ps -A | grep <span class="string">&quot;composer&quot;</span></span><br><span class="line">system         <span class="number">345</span>     <span class="number">1</span>   <span class="number">68600</span>   <span class="number">5964</span> <span class="number">0</span>                   <span class="number">0</span> S android.hardware.graphics.composer@<span class="number">2.1</span>-service</span><br></pre></td></tr></table></figure>

<p>该进程的可执行文件是：vendor/bin/hw/android.hardware.graphics.composer@2.1-service，</p>
<p>该可执行文件对应的源码为：hardware/interfaces/graphics/composer/2.1/default/service.cpp</p>
<h5 id="2-1-0-、Composer-Hal启动过程"><a href="#2-1-0-、Composer-Hal启动过程" class="headerlink" title="2.1.0 、Composer Hal启动过程"></a>2.1.0 、Composer Hal启动过程</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">hardware/interfaces/graphics/composer/<span class="number">2.1</span>/<span class="keyword">default</span>/service.cpp</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// the conventional HAL might start binder services</span></span><br><span class="line">    android::ProcessState::initWithDriver(<span class="string">&quot;/dev/vndbinder&quot;</span>);</span><br><span class="line">    android::ProcessState::self()-&gt;setThreadPoolMaxThreadCount(<span class="number">4</span>);</span><br><span class="line">    android::ProcessState::self()-&gt;startThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// same as SF main thread</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_param</span> <span class="title">param</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">    param.sched_priority = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (sched_setscheduler(<span class="number">0</span>, SCHED_FIFO | SCHED_RESET_ON_FORK,</span><br><span class="line">                &amp;param) != <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Couldn&#x27;t set SCHED_FIFO: %d&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ARCH_ARM_32</span></span><br><span class="line">    android::hardware::ProcessState::initWithMmapSize((<span class="keyword">size_t</span>)(<span class="number">32768</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> defaultPassthroughServiceImplementation&lt;IComposer&gt;(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在Treble架构下，存在了3个binder设备，分别是/dev/binder、/dev/vndbinder、/dev/hwbinder，上层需要通过binder库来访问这些binder设备，而/dev/binder和/dev/vndbinder都是由libbinder来访问，因此需要指定打开的binder设备。<br>android::ProcessState::initWithDriver(“/dev/vndbinder”);<br>这句说明composer hal通过vndbinder来通信的，接下来就是设置binder线程个数为4，并启动binder线程池，然后调用<br>defaultPassthroughServiceImplementation<IComposer>(4)<br>完成composer hal的启动。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">system\libhidl\transport\include\hidl\LegacySupport.h</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers passthrough service implementation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">registerPassthroughServiceImplementation</span>(</span></span><br><span class="line"><span class="class">        <span class="title">std</span>:</span>:<span class="built_in">string</span> name = <span class="string">&quot;default&quot;</span>) &#123;</span><br><span class="line">    sp&lt;Interface&gt; service = Interface::getService(name, <span class="literal">true</span> <span class="comment">/* getStub */</span>);<span class="comment">//从当前进程空间中拿到IComposer接口类对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Could not get passthrough implementation for %s/%s.&quot;</span>,</span><br><span class="line">            Interface::descriptor, name.c_str());</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG_FATAL_IF(service-&gt;isRemote(), <span class="string">&quot;Implementation of %s/%s is remote!&quot;</span>,</span><br><span class="line">            Interface::descriptor, name.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> status = service-&gt;registerAsService(name);<span class="comment">//将IComposer注册到hwservicemanager中</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == OK) &#123;</span><br><span class="line">        ALOGI(<span class="string">&quot;Registration complete for %s/%s.&quot;</span>,</span><br><span class="line">            Interface::descriptor, name.c_str());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Could not register service %s/%s (%d).&quot;</span>,</span><br><span class="line">            Interface::descriptor, name.c_str(), status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates default passthrough service implementation. This method never returns.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return value is exit status.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Interface</span>&gt;</span></span><br><span class="line"><span class="class">__<span class="title">attribute__</span>((<span class="title">warn_unused_result</span>))</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">defaultPassthroughServiceImplementation</span>(<span class="title">std</span>:</span>:<span class="built_in">string</span> name,</span><br><span class="line">                                            <span class="keyword">size_t</span> maxThreads = <span class="number">1</span>) &#123;</span><br><span class="line">    configureRpcThreadpool(maxThreads, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">status_t</span> result = registerPassthroughServiceImplementation&lt;Interface&gt;(name);</span><br><span class="line">    ......</span><br><span class="line">    joinRpcThreadpool();</span><br><span class="line">    <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_Composer_registerAsService.png" alt="Alt text | center"></p>
<h5 id="2-2-0-、Hal进程获取IComposer类对象"><a href="#2-2-0-、Hal进程获取IComposer类对象" class="headerlink" title="2.2.0 、Hal进程获取IComposer类对象"></a>2.2.0 、Hal进程获取IComposer类对象</h5><p>在composer hal进程启动时，首先调用IComposer 的getService(“default”,true)来获取IComposer的类对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\hardware\interfaces\graphics\composer\<span class="number">2.1</span></span><br><span class="line">android.hardware.graphics.composer@<span class="number">2.1</span>_genc++\gen\android\hardware\graphics\composer\<span class="number">2.1</span>\ComposerAll.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment">// static</span></span><br><span class="line">::<span class="function">android::sp&lt;IComposer&gt; <span class="title">IComposer::getService</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName, <span class="keyword">const</span> <span class="keyword">bool</span> getStub)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::defaultServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::details::waitForHwService;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::getPassthroughServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::Return;</span><br><span class="line">    <span class="keyword">using</span> ::android::sp;</span><br><span class="line">    <span class="keyword">using</span> Transport = ::android::hidl::manager::V1_0::IServiceManager::Transport;</span><br><span class="line"></span><br><span class="line">    sp&lt;IComposer&gt; iface = <span class="literal">nullptr</span>;</span><br><span class="line">     <span class="comment">//获取hwservicemanager的代理</span></span><br><span class="line">    <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//查询IComposer的Transport</span></span><br><span class="line">    Return&lt;Transport&gt; transportRet = sm-&gt;getTransport(IComposer::descriptor, serviceName);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    Transport transport = transportRet;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfHwbinder = (transport == Transport::HWBINDER);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfPassthru = (transport == Transport::PASSTHROUGH);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_TREBLE__</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* env = <span class="built_in">std</span>::getenv(<span class="string">&quot;TREBLE_TESTING_OVERRIDE&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> trebleTestingOverride =  env &amp;&amp; !<span class="built_in">strcmp</span>(env, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfLegacy = (transport == Transport::EMPTY) &amp;&amp; trebleTestingOverride;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span> <span class="comment">// __ANDROID_TREBLE__ but not __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> trebleTestingOverride = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfLegacy = <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span> <span class="comment">// not __ANDROID_TREBLE__</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* env = <span class="built_in">std</span>::getenv(<span class="string">&quot;TREBLE_TESTING_OVERRIDE&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> trebleTestingOverride =  env &amp;&amp; !<span class="built_in">strcmp</span>(env, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfLegacy = (transport == Transport::EMPTY);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_TREBLE__</span></span></span><br><span class="line">    <span class="comment">//hwbinder方式下获取IComposer对象</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> tries = <span class="number">0</span>; !getStub &amp;&amp; (vintfHwbinder || (vintfLegacy &amp;&amp; tries == <span class="number">0</span>)); tries++) &#123;</span><br><span class="line">        ......</span><br><span class="line">        Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                sm-&gt;get(IComposer::descriptor, serviceName);</span><br><span class="line">        ......</span><br><span class="line">        sp&lt;::android::hidl::base::V1_0::IBase&gt; base = ret;</span><br><span class="line">        ......</span><br><span class="line">        Return&lt;sp&lt;IComposer&gt;&gt; castRet = IComposer::castFrom(base, <span class="literal">true</span> <span class="comment">/* emitError */</span>);</span><br><span class="line">        ......</span><br><span class="line">        iface = castRet;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> iface;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//passthrough方式下获取IComposer对象</span></span><br><span class="line">    <span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = getPassthroughServiceManager();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;get(IComposer::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.isOk()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = IComposer::castFrom(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> BsComposer(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iface;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里通过hwservicemanager获取当前服务的Tranport类型，Treble中定义的Tranport包括passthrough和binderized，每个hidl服务都在/system/manifest.xml或者/vendor/manifest.xml中指定了对应的Tranport类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> &lt;hal format=<span class="string">&quot;hidl&quot;</span>&gt;</span><br><span class="line">    &lt;name&gt;android.hardware.graphics.composer&lt;/name&gt;</span><br><span class="line">    &lt;transport&gt;hwbinder&lt;/transport&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.1</span>&lt;/version&gt;</span><br><span class="line">    &lt;interface&gt;</span><br><span class="line">        &lt;name&gt;IComposer&lt;/name&gt;</span><br><span class="line">        &lt;instance&gt;<span class="keyword">default</span>&lt;/instance&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">&lt;/hal&gt;</span><br></pre></td></tr></table></figure>
<p>manifest.xml文件的读取和解析都是由hwservicemanager来完成的，此时<a href="mailto:&#x61;&#110;&#x64;&#x72;&#x6f;&#105;&#x64;&#x2e;&#104;&#x61;&#114;&#100;&#119;&#97;&#114;&#101;&#46;&#103;&#114;&#x61;&#112;&#x68;&#105;&#x63;&#x73;&#x2e;&#x63;&#111;&#109;&#112;&#111;&#115;&#101;&#x72;&#64;&#x32;&#46;&#x31;&#45;&#x73;&#x65;&#x72;&#118;&#x69;&#x63;&#x65;">&#x61;&#110;&#x64;&#x72;&#x6f;&#105;&#x64;&#x2e;&#104;&#x61;&#114;&#100;&#119;&#97;&#114;&#101;&#46;&#103;&#114;&#x61;&#112;&#x68;&#105;&#x63;&#x73;&#x2e;&#x63;&#111;&#109;&#112;&#111;&#115;&#101;&#x72;&#64;&#x32;&#46;&#x31;&#45;&#x73;&#x65;&#x72;&#118;&#x69;&#x63;&#x65;</a>作为hwservicemanager的client端，通过hwservicemanager的binder代理对象来请求hwservicemanager进程查询IComposer的Transport类型，从上图可以看出IComposer的Transport被定义为hwbinder，因此：</p>
<p>vintfHwbinder=true<br>vintfPassthru=false<br>vintfLegacy=false</p>
<p>hidl服务对象获取方式包括2中：</p>
<ol>
<li>通过查询hwservicemanager来获取；</li>
<li>通过PassthroughServiceManager从本进程地址空间中获取；</li>
</ol>
<p>那如何选择获取方式呢？ 其实就是vintfHwbinder、vintfPassthru、vintfLegacy、getStub这4个变量值来决定hidl服务的获取方式。</p>
<ol>
<li>当getStub为true时，不管hal属于什么传输模式，都采用PassthroughServiceManager获取接口对象；</li>
<li>当getStub为false时，则根据hal传输模式来选择接口获取方式；</li>
</ol>
<blockquote>
<p>   《1》 当hal模式为Hwbinder时，则从hwservicemanager中查询；</p>
<p>   《2》当hal传输模式为Passthru或Legacy时，则采用PassthroughServiceManager来获取；</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_arc.png" alt="Alt text | center"></p>
<p>sp<Interface> service = Interface::getService(name, true /* getStub */)所以getStub=true. 这里通过PassthroughServiceManager来获取IComposer对象。其实所有的Hal 进程都是通过PassthroughServiceManager来得到hidl服务对象的，而作为Hal进程的Client端Framework进程在获取hidl服务对象时，需要通过hal的Transport类型来选择获取方式。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">system\libhidl\transport\ServiceManagement.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;IServiceManager&gt; <span class="title">getPassthroughServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> sp&lt;PassthroughServiceManager&gt; <span class="title">manager</span><span class="params">(<span class="keyword">new</span> PassthroughServiceManager())</span></span>;</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;IServiceManager1_1&gt; <span class="title">getPassthroughServiceManager1_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> sp&lt;PassthroughServiceManager&gt; <span class="title">manager</span><span class="params">(<span class="keyword">new</span> PassthroughServiceManager())</span></span>;</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PassthroughServiceManager</span> :</span> IServiceManager1_1 &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">openLibs</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; fqName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="built_in">std</span>::function&lt;<span class="keyword">bool</span> <span class="comment">/* continue */</span> (<span class="keyword">void</span>* <span class="comment">/* handle */</span>, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; <span class="comment">/* lib */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                 <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; <span class="comment">/* sym */</span>)&gt;&amp; eachLib)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//fqName looks like android.hardware.foo@1.0::IFoo</span></span><br><span class="line">        <span class="keyword">size_t</span> idx = fqName.find(<span class="string">&quot;::&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> packageAndVersion = fqName.substr(<span class="number">0</span>, idx);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> ifaceName = fqName.substr(idx + <span class="built_in">strlen</span>(<span class="string">&quot;::&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> prefix = packageAndVersion + <span class="string">&quot;-impl&quot;</span>;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> sym = <span class="string">&quot;HIDL_FETCH_&quot;</span> + ifaceName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">constexpr</span> <span class="keyword">int</span> dlMode = RTLD_LAZY;</span><br><span class="line">        <span class="keyword">void</span>* handle = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        dlerror(); <span class="comment">// clear</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">string</span> halLibPathVndkSp = android::base::StringPrintf(</span><br><span class="line">            HAL_LIBRARY_PATH_VNDK_SP_FOR_VERSION, details::getVndkVersionStr().c_str());</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; paths = &#123;HAL_LIBRARY_PATH_ODM, HAL_LIBRARY_PATH_VENDOR,</span><br><span class="line">                                          halLibPathVndkSp, HAL_LIBRARY_PATH_SYSTEM&#125;;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path : paths) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; libs = search(path, prefix, <span class="string">&quot;.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;lib : libs) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> fullPath = path + lib;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (path == HAL_LIBRARY_PATH_SYSTEM) &#123;</span><br><span class="line">                    handle = dlopen(fullPath.c_str(), dlMode);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    handle = android_load_sphal_library(fullPath.c_str(), dlMode);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="function">Return&lt;sp&lt;IBase&gt;&gt; <span class="title">get</span><span class="params">(<span class="keyword">const</span> hidl_string&amp; fqName,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> hidl_string&amp; name)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        sp&lt;IBase&gt; ret = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        openLibs(fqName, [&amp;](<span class="keyword">void</span>* handle, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;lib, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;sym) &#123;</span><br><span class="line">            IBase* (*generator)(<span class="keyword">const</span> <span class="keyword">char</span>* name);</span><br><span class="line">            *(<span class="keyword">void</span> **)(&amp;generator) = dlsym(handle, sym.c_str());</span><br><span class="line">            ......</span><br><span class="line">            ret = (*generator)(name.c_str());</span><br><span class="line">            .......</span><br><span class="line">            <span class="comment">// Actual fqname might be a subclass.</span></span><br><span class="line">            <span class="comment">// This assumption is tested in vts_treble_vintf_test</span></span><br><span class="line">            <span class="keyword">using</span> ::android::hardware::details::getDescriptor;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> actualFqName = getDescriptor(ret.get());</span><br><span class="line">            CHECK(actualFqName.size() &gt; <span class="number">0</span>);</span><br><span class="line">            registerReference(actualFqName, name);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里只是简单的创建了一个PassthroughServiceManager对象。PassthroughServiceManager也实现了IServiceManager接口。然后通过PassthroughServiceManager询服务：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_registerReference.png" alt="Alt text | center"></p>
<p>根据传入的fqName=(<a href="mailto:&#97;&#110;&#100;&#114;&#x6f;&#x69;&#x64;&#46;&#104;&#x61;&#x72;&#x64;&#x77;&#97;&#114;&#x65;&#46;&#103;&#114;&#x61;&#x70;&#x68;&#105;&#x63;&#x73;&#46;&#x63;&#111;&#109;&#x70;&#x6f;&#x73;&#x65;&#114;&#64;&#x32;&#46;&#x31;">&#97;&#110;&#100;&#114;&#x6f;&#x69;&#x64;&#46;&#104;&#x61;&#x72;&#x64;&#x77;&#97;&#114;&#x65;&#46;&#103;&#114;&#x61;&#x70;&#x68;&#105;&#x63;&#x73;&#46;&#x63;&#111;&#109;&#x70;&#x6f;&#x73;&#x65;&#114;&#64;&#x32;&#46;&#x31;</a>::IComposer”)获取当前的接口名IComposer，拼接出后面需要查找的函数名HIDL_FETCH_IComposer和库名字<a href="mailto:&#97;&#110;&#x64;&#114;&#x6f;&#105;&#100;&#46;&#104;&#97;&#x72;&#100;&#x77;&#97;&#x72;&#x65;&#x2e;&#x67;&#114;&#97;&#112;&#104;&#105;&#99;&#115;&#x2e;&#x63;&#111;&#x6d;&#112;&#111;&#115;&#101;&#114;&#64;&#x32;&#46;&#49;&#45;&#x69;&#109;&#x70;&#108;&#x2e;&#x73;&#x6f;">&#97;&#110;&#x64;&#114;&#x6f;&#105;&#100;&#46;&#104;&#97;&#x72;&#100;&#x77;&#97;&#x72;&#x65;&#x2e;&#x67;&#114;&#97;&#112;&#104;&#105;&#99;&#115;&#x2e;&#x63;&#111;&#x6d;&#112;&#111;&#115;&#101;&#114;&#64;&#x32;&#46;&#49;&#45;&#x69;&#109;&#x70;&#108;&#x2e;&#x73;&#x6f;</a>,然后查找”/system/lib64/hw/“、”/vendor/lib64/hw/“、”/odm/lib64/hw/“下是否有对应的so库。接着通过dlopen载入/vendor/lib/hw/android.hardware.graphics.composer@2.1-impl.so，然后通过dlsym查找并调用HwcLoader::load()函数，最后调用registerReference(fqName, name)向hwservicemanager注册。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">hardware/interfaces/graphics/composer/<span class="number">2.1</span>/<span class="keyword">default</span>/Android.bp</span><br><span class="line">cc_library_shared &#123;</span><br><span class="line">    name: <span class="string">&quot;android.hardware.graphics.composer@2.1-impl&quot;</span>,</span><br><span class="line">    defaults: [<span class="string">&quot;hidl_defaults&quot;</span>],</span><br><span class="line">    vendor: <span class="literal">true</span>,</span><br><span class="line">    relative_install_path: <span class="string">&quot;hw&quot;</span>,</span><br><span class="line">    srcs: [<span class="string">&quot;passthrough.cpp&quot;</span>],</span><br><span class="line">    header_libs: [</span><br><span class="line">        <span class="string">&quot;android.hardware.graphics.composer@2.1-passthrough&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">&quot;android.hardware.graphics.composer@2.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;android.hardware.graphics.mapper@2.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libbase&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libcutils&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libfmq&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libhardware&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libhidlbase&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libhidltransport&quot;</span>,</span><br><span class="line">        <span class="string">&quot;liblog&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libsync&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libutils&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libhwc2on1adapter&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libhwc2onfbadapter&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    cflags: [</span><br><span class="line">        <span class="string">&quot;-DLOG_TAG=\&quot;ComposerHal\&quot;&quot;</span></span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从上面的编译脚本可知，<a href="mailto:&#97;&#x6e;&#100;&#114;&#111;&#105;&#100;&#46;&#x68;&#x61;&#114;&#x64;&#119;&#97;&#x72;&#101;&#x2e;&#x67;&#114;&#97;&#112;&#x68;&#105;&#x63;&#115;&#x2e;&#x63;&#x6f;&#109;&#x70;&#111;&#x73;&#101;&#x72;&#x40;&#x32;&#46;&#49;&#x2d;&#x69;&#109;&#112;&#x6c;&#46;&#x73;&#x6f;">&#97;&#x6e;&#100;&#114;&#111;&#105;&#100;&#46;&#x68;&#x61;&#114;&#x64;&#119;&#97;&#x72;&#101;&#x2e;&#x67;&#114;&#97;&#112;&#x68;&#105;&#x63;&#115;&#x2e;&#x63;&#x6f;&#109;&#x70;&#111;&#x73;&#101;&#x72;&#x40;&#x32;&#46;&#49;&#x2d;&#x69;&#109;&#112;&#x6c;&#46;&#x73;&#x6f;</a>的源码文件为passthrough.cpp：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">hardware/interfaces/graphics/composer/<span class="number">2.1</span>/<span class="keyword">default</span>/passthrough.cpp</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">IComposer* <span class="title">HIDL_FETCH_IComposer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* <span class="comment">/* name */</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> HwcLoader::load();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">G:\android9<span class="number">.0</span>\hardware\interfaces\graphics\composer\<span class="number">2.1</span>\utils\passthrough\include\composer-passthrough\<span class="number">2.1</span>\HwcLoader.h</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HwcLoader</span> &#123;</span></span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> IComposer* <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span> = loadModule();</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">auto</span> hal = createHalWithAdapter(<span class="keyword">module</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> createComposer(<span class="built_in">std</span>::move(hal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load hwcomposer2 module</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="title">loadModule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>;</span><br><span class="line">        <span class="keyword">int</span> error = hw_get_module(HWC_HARDWARE_MODULE_ID, &amp;<span class="keyword">module</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">module</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a ComposerHal instance</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;hal::ComposerHal&gt; <span class="title">createHal</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> hal = <span class="built_in">std</span>::make_unique&lt;HwcHal&gt;();</span><br><span class="line">        <span class="keyword">return</span> hal-&gt;initWithModule(<span class="keyword">module</span>) ? <span class="built_in">std</span>::move(hal) : <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a ComposerHal instance, insert an adapter if necessary</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;hal::ComposerHal&gt; <span class="title">createHalWithAdapter</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">bool</span> adapted;</span><br><span class="line">        <span class="keyword">hwc2_device_t</span>* device = openDeviceWithAdapter(<span class="keyword">module</span>, &amp;adapted);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">auto</span> hal = <span class="built_in">std</span>::make_unique&lt;HwcHal&gt;();</span><br><span class="line">        <span class="keyword">return</span> hal-&gt;initWithDevice(<span class="built_in">std</span>::move(device), !adapted) ? <span class="built_in">std</span>::move(hal) : <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create an IComposer instance</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> IComposer* <span class="title">createComposer</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;hal::ComposerHal&gt; hal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hal::Composer::create(<span class="built_in">std</span>::move(hal)).release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// open hwcomposer2 device, install an adapter if necessary</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">hwc2_device_t</span>* <span class="title">openDeviceWithAdapter</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">bool</span>* outAdapted)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">module</span>-&gt;id &amp;&amp; <span class="built_in">std</span>::<span class="built_in">string</span>(<span class="keyword">module</span>-&gt;id) == GRALLOC_HARDWARE_MODULE_ID) &#123;</span><br><span class="line">            *outAdapted = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> adaptGrallocModule(<span class="keyword">module</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">hw_device_t</span>* device;</span><br><span class="line">        <span class="keyword">int</span> error = <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>, HWC_HARDWARE_COMPOSER, &amp;device);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> major = (device-&gt;version &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xf</span>;</span><br><span class="line">        <span class="keyword">if</span> (major != <span class="number">2</span>) &#123;</span><br><span class="line">            *outAdapted = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> adaptHwc1Device(<span class="built_in">std</span>::move(<span class="keyword">reinterpret_cast</span>&lt;hwc_composer_device_1*&gt;(device)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *outAdapted = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">hwc2_device_t</span>*&gt;(device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">hwc2_device_t</span>* <span class="title">adaptGrallocModule</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">framebuffer_device_t</span>* device;</span><br><span class="line">        <span class="keyword">int</span> error = framebuffer_open(<span class="keyword">module</span>, &amp;device);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HWC2OnFbAdapter(device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">hwc2_device_t</span>* <span class="title">adaptHwc1Device</span><span class="params">(hwc_composer_device_1* device)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> minor = (device-&gt;common.version &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xf</span>;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HWC2On1Adapter(device);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h5 id="2-3-0-、registerPassthroughClient"><a href="#2-3-0-、registerPassthroughClient" class="headerlink" title="2.3.0 、registerPassthroughClient"></a>2.3.0 、registerPassthroughClient</h5><p>得到IComposer接口对象后，需要注册相关信息到hwservicemanager中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">system\libhidl\transport\ServiceManagement.cpp</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerReference</span><span class="params">(<span class="keyword">const</span> hidl_string &amp;interfaceName, <span class="keyword">const</span> hidl_string &amp;instanceName)</span> </span>&#123;</span><br><span class="line">    sp&lt;IServiceManager1_0&gt; binderizedManager = defaultServiceManager();</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">auto</span> ret = binderizedManager-&gt;registerPassthroughClient(interfaceName, instanceName);</span><br><span class="line">   ......</span><br><span class="line">    LOG(VERBOSE) &lt;&lt; <span class="string">&quot;Successfully registerReference for &quot;</span></span><br><span class="line">                 &lt;&lt; interfaceName &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; instanceName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里通过hwservicemanager的代理对象跨进程调用registerPassthroughClient。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.1</span>\android.hidl.manager@<span class="number">1.1</span>_genc++\gen\android\hidl\manager\<span class="number">1.1</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line">::android::<span class="function">hardware::Return&lt;<span class="keyword">void</span>&gt; <span class="title">BpHwServiceManager::registerPassthroughClient</span><span class="params">(<span class="keyword">const</span> ::android::hardware::hidl_string&amp; fqName, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name)</span></span>&#123;</span><br><span class="line">    ::android::hardware::Return&lt;<span class="keyword">void</span>&gt;  _hidl_out = ::android::hidl::manager::V1_0::BpHwServiceManager::_hidl_registerPassthroughClient(<span class="keyword">this</span>, <span class="keyword">this</span>, fqName, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _hidl_out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">\android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line">::android::hardware::Return&lt;<span class="keyword">void</span>&gt; BpHwServiceManager::_hidl_registerPassthroughClient(::android::hardware::IInterface *_hidl_this, ::android::hardware::details::HidlInstrumentor *_hidl_this_instrumentor, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; fqName, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">bool</span> mEnableInstrumentation = _hidl_this_instrumentor-&gt;isInstrumentationEnabled();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;mInstrumentationCallbacks = _hidl_this_instrumentor-&gt;getInstrumentationCallbacks();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    (<span class="keyword">void</span>) _hidl_this_instrumentor;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line">    atrace_begin(ATRACE_TAG_HAL, <span class="string">&quot;HIDL::IServiceManager::registerPassthroughClient::client&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)&amp;fqName);</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)&amp;name);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::CLIENT_API_ENTRY, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;registerPassthroughClient&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    ::android::hardware::Parcel _hidl_data;</span><br><span class="line">    ::android::hardware::Parcel _hidl_reply;</span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err;</span><br><span class="line">    ::android::hardware::Status _hidl_status;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeInterfaceToken(BpHwServiceManager::descriptor);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_fqName_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;fqName, <span class="keyword">sizeof</span>(fqName), &amp;_hidl_fqName_parent);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            fqName,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_fqName_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;name, <span class="keyword">sizeof</span>(name), &amp;_hidl_name_parent);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            name,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::IInterface::asBinder(_hidl_this)-&gt;transact(<span class="number">8</span> <span class="comment">/* registerPassthroughClient */</span>, _hidl_data, &amp;_hidl_reply);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readFromParcel(&amp;_hidl_status, _hidl_reply);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_hidl_status.isOk()) &#123; <span class="keyword">return</span> _hidl_status; &#125;</span><br><span class="line"></span><br><span class="line">    atrace_end(ATRACE_TAG_HAL);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::CLIENT_API_EXIT, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;registerPassthroughClient&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    _hidl_status.setFromStatusT(_hidl_err);</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::Return&lt;<span class="keyword">void</span>&gt;();</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>这里和普通binder通信相同，先就需要传输的函数参数打包到Parcel对象中，然后调用binder代理对象的transact函数将函数参数，函数调用码发送到Server端进程，这里的_hidl_this其实指向的是BpHwServiceManager，这个是与业务相关的代理对象，通过asBinder函数得到与传输相关的binder代理，那这个binder代理是什么类型呢？ 其实就是BpHwBinder，关于hwservicemanager代理对象的获取，asBinder函数的实现，在后续的章节中进行分析。经过BpHwServiceManager的请求，最终位于hwservicemanager进程中的BnHwServiceManager将接收函数调用请求：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.1</span>\android.hidl.manager@<span class="number">1.1</span>_genc++\gen\android\hidl\manager\<span class="number">1.1</span>\ServiceManagerAll.cpp</span><br><span class="line">::<span class="function">android::<span class="keyword">status_t</span> <span class="title">BnHwServiceManager::onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> _hidl_code,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span></span></span><br><span class="line"><span class="function"><span class="params">    ::android::hardware::Parcel *_hidl_reply,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> _hidl_flags,</span></span></span><br><span class="line"><span class="function"><span class="params">    TransactCallback _hidl_cb)</span> </span>&#123;</span><br><span class="line">::android::<span class="keyword">status_t</span> _hidl_err = ::android::OK;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">switch</span> (_hidl_code) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span> <span class="comment">/* registerPassthroughClient */</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        _hidl_err = ::android::hidl::manager::V1_0::BnHwServiceManager::_hidl_registerPassthroughClient(<span class="keyword">this</span>, _hidl_data, _hidl_reply, _hidl_cb);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ::android::hidl::base::V1_0::BnHwBase::onTransact(</span><br><span class="line">                _hidl_code, _hidl_data, _hidl_reply, _hidl_flags, _hidl_cb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BnHwServiceManager将调用_hidl_registerPassthroughClient来执行Client端的注册。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">\android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line">::android::<span class="keyword">status_t</span> BnHwServiceManager::_hidl_registerPassthroughClient(</span><br><span class="line">        ::android::hidl::base::V1_0::BnHwBase* _hidl_this,</span><br><span class="line">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span><br><span class="line">        ::android::hardware::Parcel *_hidl_reply,</span><br><span class="line">        TransactCallback _hidl_cb) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">bool</span> mEnableInstrumentation = _hidl_this-&gt;isInstrumentationEnabled();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;mInstrumentationCallbacks = _hidl_this-&gt;getInstrumentationCallbacks();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err = ::android::OK;</span><br><span class="line">    <span class="keyword">if</span> (!_hidl_data.enforceInterface(BnHwServiceManager::Pure::descriptor)) &#123;</span><br><span class="line">        _hidl_err = ::android::BAD_TYPE;</span><br><span class="line">        <span class="keyword">return</span> _hidl_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* fqName;</span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_fqName_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*fqName), &amp;_hidl_fqName_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;fqName));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*fqName),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_fqName_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*name), &amp;_hidl_name_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;name));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*name),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    atrace_begin(ATRACE_TAG_HAL, <span class="string">&quot;HIDL::IServiceManager::registerPassthroughClient::server&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)fqName);</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)name);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::SERVER_API_ENTRY, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;registerPassthroughClient&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static_cast</span>&lt;BnHwServiceManager*&gt;(_hidl_this)-&gt;_hidl_mImpl-&gt;registerPassthroughClient(*fqName, *name);</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) _hidl_cb;</span><br><span class="line"></span><br><span class="line">    atrace_end(ATRACE_TAG_HAL);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::SERVER_API_EXIT, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;registerPassthroughClient&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    ::android::hardware::writeToParcel(::android::hardware::Status::ok(), _hidl_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _hidl_err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BnHwServiceManager首先读取BpHwServiceManager发送过来的函数参数，然后将registerPassthroughClient的执行转交个其成员变量的_hidl_mImpl对象，然后将执行结果返回给BpHwServiceManager，那么_hidl_mImpl保存的是什么对象呢？ 其实_hidl_mImpl指向的是ServiceManager对象，这个是在构造BnHwServiceManager对象时传入的，在后续分析hwservicemanager启动过程时，会进行详细分析。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">system\hwservicemanager\ServiceManager.cpp</span><br><span class="line"><span class="function">Return&lt;<span class="keyword">void</span>&gt; <span class="title">ServiceManager::registerPassthroughClient</span><span class="params">(<span class="keyword">const</span> hidl_string &amp;fqName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> hidl_string &amp;name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = IPCThreadState::self()-&gt;getCallingPid();</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    PackageInterfaceMap &amp;ifaceMap = mServiceMap[fqName];</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    HidlService *service = ifaceMap.lookup(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">auto</span> adding = <span class="built_in">std</span>::make_unique&lt;HidlService&gt;(fqName, name);</span><br><span class="line">        adding-&gt;registerPassthroughClient(pid);</span><br><span class="line">        ifaceMap.insertService(<span class="built_in">std</span>::move(adding));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        service-&gt;registerPassthroughClient(pid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Void();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先根据fqName从mServiceMap中查找对应的PackageInterfaceMap，然后根据name从PackageInterfaceMap中查找HidlService，如果找不到对应的HidlService对象，那么就调用std::make_unique<HidlService>(fqName,name)创建一个新的HidlService对象，并ifaceMap.insertService(std::move(adding))添加到PackageInterfaceMap中。如果查找到了HidlService对象，那么仅仅将Client进程的pid保存到HidlService的mPassthroughClients变量中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android/system/hwservicemanager/HidlService.cpp</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HidlService::registerPassthroughClient</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">    mPassthroughClients.insert(pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此registerPassthroughClient在hwservicemanager中插入一个HidlService对象而已，并没有注册对应的IBase对象。getService最后将HwcHal对象返回给registerPassthroughServiceImplementation()函数，然后再次调用registerAsService注册该IBase对象。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_registerPassthroughClient.png" alt="Alt text | center"></p>
<h5 id="2-4-0-、registerAsService注册"><a href="#2-4-0-、registerAsService注册" class="headerlink" title="2.4.0 、registerAsService注册"></a>2.4.0 、registerAsService注册</h5><p>registerAsService用于向hwservicemanager注册IBase对象，由于前面通过PassthroughServiceManager得到的HwcHal继承于IBase，因此可以调用registerAsService函数来注册。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">::<span class="function">android::<span class="keyword">status_t</span> <span class="title">IServiceManager::registerAsService</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName)</span> </span>&#123;</span><br><span class="line">    ::android::hardware::details::onRegistration(<span class="string">&quot;android.hidl.manager@1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::sp&lt;IServiceManager&gt; sm</span><br><span class="line">            = ::android::hardware::defaultServiceManager();</span><br><span class="line">    <span class="keyword">if</span> (sm == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ::android::INVALID_OPERATION;</span><br><span class="line">    &#125;</span><br><span class="line">    ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt; ret = sm-&gt;add(serviceName.c_str(), <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> ret.isOk() &amp;&amp; ret ? ::android::OK : ::android::UNKNOWN_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先执行onRegistration函数，然后调用hwservicemanager的代理对象的add函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">system\libhidl\transport\ServiceManagement.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onRegistration</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; <span class="comment">/* interfaceName */</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; <span class="comment">/* instanceName */</span>)</span> </span>&#123;</span><br><span class="line">    tryShortenProcessName(packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tryShortenProcessName</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;packageName)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> processName = binaryName();</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// e.x. android.hardware.module.foo@1.0 -&gt; foo@1.0</span></span><br><span class="line">    <span class="keyword">size_t</span> lastDot = packageName.rfind(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">size_t</span> secondDot = packageName.rfind(<span class="string">&#x27;.&#x27;</span>, lastDot - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    .....</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> newName = processName.substr(secondDot + <span class="number">1</span>,</span><br><span class="line">            <span class="number">16</span> <span class="comment">/* TASK_COMM_LEN */</span> - <span class="number">1</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rc = pthread_setname_np(pthread_self(), newName.c_str());</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只是简单的修改了当前进程的名称。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line">::android::<span class="function">hardware::Return&lt;<span class="keyword">bool</span>&gt; <span class="title">BpHwServiceManager::add</span><span class="params">(<span class="keyword">const</span> ::android::hardware::hidl_string&amp; name, <span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; service)</span></span>&#123;</span><br><span class="line">    ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt;  _hidl_out = ::android::hidl::manager::V1_0::BpHwServiceManager::_hidl_add(<span class="keyword">this</span>, <span class="keyword">this</span>, name, service);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _hidl_out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">::android::hardware::Return&lt;<span class="keyword">bool</span>&gt; BpHwServiceManager::_hidl_add(::android::hardware::IInterface *_hidl_this, ::android::hardware::details::HidlInstrumentor *_hidl_this_instrumentor, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name, <span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; service) &#123;</span><br><span class="line">    <span class="keyword">bool</span> mEnableInstrumentation = _hidl_this_instrumentor-&gt;isInstrumentationEnabled();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;mInstrumentationCallbacks = _hidl_this_instrumentor-&gt;getInstrumentationCallbacks();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    (<span class="keyword">void</span>) _hidl_this_instrumentor;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    ::android::hardware::Parcel _hidl_data;</span><br><span class="line">    ::android::hardware::Parcel _hidl_reply;</span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err;</span><br><span class="line">    ::android::hardware::Status _hidl_status;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> _hidl_out_success;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeInterfaceToken(BpHwServiceManager::descriptor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;name, <span class="keyword">sizeof</span>(name), &amp;_hidl_name_parent);</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            name,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        _hidl_err = _hidl_data.writeStrongBinder(<span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl_binder = ::android::hardware::toBinder&lt;</span><br><span class="line">                ::android::hidl::base::V1_0::IBase&gt;(service);</span><br><span class="line">        <span class="keyword">if</span> (_hidl_binder.get() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            _hidl_err = _hidl_data.writeStrongBinder(_hidl_binder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _hidl_err = ::android::UNKNOWN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    ::android::hardware::ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    _hidl_err = ::android::hardware::IInterface::asBinder(_hidl_this)-&gt;transact(<span class="number">2</span> <span class="comment">/* add */</span>, _hidl_data, &amp;_hidl_reply);</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readFromParcel(&amp;_hidl_status, _hidl_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_hidl_status.isOk()) &#123; <span class="keyword">return</span> _hidl_status; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_reply.readBool(&amp;_hidl_out_success);</span><br><span class="line"></span><br><span class="line">    _hidl_status.setFromStatusT(_hidl_err);</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt;(_hidl_out_success);</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::Return&lt;<span class="keyword">bool</span>&gt;(_hidl_status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的步骤和前面的registerPassthroughClient基本一致，唯一不同的是，此时需要向Server端hwservicemanager传输一个IBase对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">::android::sp&lt;::android::hardware::IBinder&gt; _hidl_binder = ::android::hardware::toBinder&lt;</span><br><span class="line">        ::android::hidl::base::V1_0::IBase&gt;(service);</span><br><span class="line"><span class="keyword">if</span> (_hidl_binder.get() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    _hidl_err = _hidl_data.writeStrongBinder(_hidl_binder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先通过toBinder函数将IBase对象，其实就是HwcHal对象转换为IBinder对象，然后通过writeStrongBinder将IBinder对象序列化到Parcel中，toBinder函数在后续进行分析，我们这里只需要知道经过toBinder函数后，在Hal进程端会创建一个BnHwComposer本地binder对象，然后通过IPC调用发送给hwservicemanager。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line">::<span class="function">android::<span class="keyword">status_t</span> <span class="title">BnHwServiceManager::onTransact</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> _hidl_code,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span></span></span><br><span class="line"><span class="function"><span class="params">        ::android::hardware::Parcel *_hidl_reply,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">uint32_t</span> _hidl_flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        TransactCallback _hidl_cb)</span> </span>&#123;</span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err = ::android::OK;</span><br><span class="line">    <span class="keyword">switch</span> (_hidl_code) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span> <span class="comment">/* add */</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            _hidl_err = ::android::hidl::manager::V1_0::BnHwServiceManager::_hidl_add(<span class="keyword">this</span>, _hidl_data, _hidl_reply, _hidl_cb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ::android::hidl::base::V1_0::BnHwBase::onTransact(</span><br><span class="line">                    _hidl_code, _hidl_data, _hidl_reply, _hidl_flags, _hidl_cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err == ::android::UNEXPECTED_NULL) &#123;</span><br><span class="line">        _hidl_err = ::android::hardware::writeToParcel(</span><br><span class="line">                ::android::hardware::Status::fromExceptionCode(::android::hardware::Status::EX_NULL_POINTER),</span><br><span class="line">                _hidl_reply);</span><br><span class="line">    &#125;<span class="keyword">return</span> _hidl_err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">::android::<span class="keyword">status_t</span> BnHwServiceManager::_hidl_add(</span><br><span class="line">        ::android::hidl::base::V1_0::BnHwBase* _hidl_this,</span><br><span class="line">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span><br><span class="line">        ::android::hardware::Parcel *_hidl_reply,</span><br><span class="line">        TransactCallback _hidl_cb) &#123;</span><br><span class="line"></span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err = ::android::OK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* name;</span><br><span class="line">    ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt; service;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*name), &amp;_hidl_name_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;name));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*name),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl_service_binder;</span><br><span class="line">        _hidl_err = _hidl_data.readNullableStrongBinder(&amp;_hidl_service_binder);</span><br><span class="line">        <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">        service = ::android::hardware::fromBinder&lt;::android::hidl::base::V1_0::IBase,::android::hidl::base::V1_0::BpHwBase,::android::hidl::base::V1_0::BnHwBase&gt;(_hidl_service_binder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> _hidl_out_success = <span class="keyword">static_cast</span>&lt;BnHwServiceManager*&gt;(_hidl_this)-&gt;_hidl_mImpl-&gt;add(*name, service);</span><br><span class="line"></span><br><span class="line">    ::android::hardware::writeToParcel(::android::hardware::Status::ok(), _hidl_reply);</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_reply-&gt;writeBool(_hidl_out_success);</span><br><span class="line"></span><br><span class="line">    _hidl_cb(*_hidl_reply);</span><br><span class="line">    <span class="keyword">return</span> _hidl_err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>wservicemanager进程通过_hidl_err = _hidl_data.readNullableStrongBinder(&amp;_hidl_service_binder);拿到client进程发送过来的BnHwComposer对象，binder实体到达目的端进程将变为binder代理对象，然后通过fromBinder函数将binder代理对象转换为业务代理对象BpHwBase，这个过程在后续进行详细分析，接下来继续调用_hidl_mImpl的add函数，而我们知道_hidl_mImpl其实就是ServiceManager：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_add.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">android\system\hwservicemanager\ServiceManager.cpp</span><br><span class="line"><span class="function">Return&lt;<span class="keyword">bool</span>&gt; <span class="title">ServiceManager::add</span><span class="params">(<span class="keyword">const</span> hidl_string&amp; name, <span class="keyword">const</span> sp&lt;IBase&gt;&amp; service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> isValidService = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">pid_t</span> pid = IPCThreadState::self()-&gt;getCallingPid();</span><br><span class="line">    <span class="keyword">auto</span> context = mAcl.getContext(pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> ret = service-&gt;interfaceChain([&amp;](<span class="keyword">const</span> <span class="keyword">auto</span> &amp;interfaceChain) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// First, verify you&#x27;re allowed to add() the whole interface hierarchy</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; interfaceChain.size(); i++) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> fqName = interfaceChain[i];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mAcl.canAdd(fqName, context, pid)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; interfaceChain.size(); i++) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> fqName = interfaceChain[i];</span><br><span class="line"></span><br><span class="line">            PackageInterfaceMap &amp;ifaceMap = mServiceMap[fqName];</span><br><span class="line">            HidlService *hidlService = ifaceMap.lookup(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hidlService == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                ifaceMap.insertService(</span><br><span class="line">                    <span class="built_in">std</span>::make_unique&lt;HidlService&gt;(fqName, name, service, pid));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (hidlService-&gt;getService() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    <span class="keyword">auto</span> ret = hidlService-&gt;getService()-&gt;unlinkToDeath(<span class="keyword">this</span>);</span><br><span class="line">                    ret.isOk(); <span class="comment">// ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">                hidlService-&gt;setService(service, pid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ifaceMap.sendPackageRegistrationNotification(fqName, name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> linkRet = service-&gt;linkToDeath(<span class="keyword">this</span>, <span class="number">0</span> <span class="comment">/*cookie*/</span>);</span><br><span class="line">        linkRet.isOk(); <span class="comment">// ignore</span></span><br><span class="line"></span><br><span class="line">        isValidService = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isValidService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-5-0-、IComposer服务注册"><a href="#2-5-0-、IComposer服务注册" class="headerlink" title="2.5.0 、IComposer服务注册"></a>2.5.0 、IComposer服务注册</h5><p>如果服务注册进程有权限向hwservicemanager注册服务，接下来将完成服务添加。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_mServiceMap.png" alt="Alt text | center"><br>每个服务接口对应多个实例，比如<a href="mailto:&#x61;&#x6e;&#x64;&#x72;&#111;&#105;&#100;&#x2e;&#x68;&#x69;&#x64;&#108;&#46;&#109;&#x61;&#x6e;&#97;&#x67;&#x65;&#114;&#x40;&#x31;&#x2e;&#x31;">&#x61;&#x6e;&#x64;&#x72;&#111;&#105;&#100;&#x2e;&#x68;&#x69;&#x64;&#108;&#46;&#109;&#x61;&#x6e;&#97;&#x67;&#x65;&#114;&#x40;&#x31;&#x2e;&#x31;</a>::IServiceManager可以注册多个实例，每个实例名称不同。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_mInstanceMap.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PackageInterfaceMap &amp;ifaceMap = mServiceMap[fqName];</span><br><span class="line">HidlService *hidlService = ifaceMap.lookup(name);</span><br><span class="line"><span class="keyword">const</span> HidlService *ServiceManager::PackageInterfaceMap::lookup(</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;name) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">auto</span> it = mInstanceMap.find(name);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (it == mInstanceMap.end()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;second.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据名称查找HidlService，如果找不到，则新增一个HidlService，如果已经存在，则更新service。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (hidlService == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">&quot;insertService &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot; of &quot;</span> &lt;&lt; fgName ;</span><br><span class="line">    ifaceMap.insertService(</span><br><span class="line">        <span class="built_in">std</span>::make_unique&lt;HidlService&gt;(fqName, name, service, pid));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hidlService-&gt;getService() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">auto</span> ret = hidlService-&gt;getService()-&gt;unlinkToDeath(<span class="keyword">this</span>);</span><br><span class="line">        ret.isOk(); <span class="comment">// ignore</span></span><br><span class="line">    &#125;</span><br><span class="line">    LOG(INFO) &lt;&lt; <span class="string">&quot;setService &quot;</span> &lt;&lt; <span class="string">&quot; of &quot;</span> &lt;&lt; fgName ;</span><br><span class="line">    hidlService-&gt;setService(service, pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_registerSuccess.png" alt="Alt text | center"></p>
<h5 id="2-6-0-、IComposer服务查询"><a href="#2-6-0-、IComposer服务查询" class="headerlink" title="2.6.0 、IComposer服务查询"></a>2.6.0 、IComposer服务查询</h5><p>通过前面的分析我们知道，Hal进程启动时，会向hwservicemanager进程注册hidl服务，那么当Framework Server需要通过hal访问硬件设备时，首先需要查询对应的hidl服务，那么Client进程是如何查询hidl服务的呢？这篇文章将展开分析，这里再次以IComposer为例进行展开。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_BpHwComposer.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">frameworks\native\services\surfaceflinger\DisplayHardware\ComposerHal.cpp</span><br><span class="line"></span><br><span class="line">Composer::Composer(<span class="keyword">bool</span> useVrComposer)</span><br><span class="line">    : mWriter(kWriterInitialSize),</span><br><span class="line">      mIsUsingVrComposer(useVrComposer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mIsUsingVrComposer) &#123;</span><br><span class="line">        mComposer = IComposer::getService(<span class="string">&quot;vr&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mComposer = IComposer::getService(); <span class="comment">// use default name</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mComposer == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">&quot;failed to get hwcomposer service&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mComposer-&gt;createClient(</span><br><span class="line">            [&amp;](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; tmpError, <span class="keyword">const</span> <span class="keyword">auto</span>&amp; tmpClient)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tmpError == Error::NONE) &#123;</span><br><span class="line">                    mClient = tmpClient;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">if</span> (mClient == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">&quot;failed to create composer client&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsUsingVrComposer) &#123;</span><br><span class="line">        sp&lt;IVrComposerClient&gt; vrClient = IVrComposerClient::castFrom(mClient);</span><br><span class="line">        <span class="keyword">if</span> (vrClient == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">&quot;failed to create vr composer client&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里通过IComposer::getService()函数来查询IComposer这个HIDL服务，由于这里没有传递任何参数，因此函数最终会调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\hardware\interfaces\graphics\composer\<span class="number">2.1</span>\android.hardware.graphics.composer@<span class="number">2.1</span>_genc++_headers\gen\android\hardware\graphics\composer\<span class="number">2.1</span></span><br><span class="line">    <span class="keyword">static</span> ::<span class="function">android::sp&lt;IComposer&gt; <span class="title">getService</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName=<span class="string">&quot;default&quot;</span>, <span class="keyword">bool</span> getStub=<span class="literal">false</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>注意，这里的getStub为false，说明加载hidl服务方式是由当前hidl服务的transport类型决定。<br>由于IComposer的transport是hwbinder类型，那么将从hwservicemanager中查询hidl服务。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\hardware\interfaces\graphics\composer\<span class="number">2.1</span>\android.hardware.graphics.composer@<span class="number">2.1</span>_genc++\gen\android\hardware\graphics\composer\<span class="number">2.1</span>\ComposerAll.cpp</span><br><span class="line"><span class="comment">// static</span></span><br><span class="line">::<span class="function">android::sp&lt;IComposer&gt; <span class="title">IComposer::getService</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;serviceName, <span class="keyword">const</span> <span class="keyword">bool</span> getStub)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::defaultServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::details::waitForHwService;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::getPassthroughServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::Return;</span><br><span class="line">    <span class="keyword">using</span> ::android::sp;</span><br><span class="line">    <span class="keyword">using</span> Transport = ::android::hidl::manager::V1_0::IServiceManager::Transport;</span><br><span class="line"></span><br><span class="line">    sp&lt;IComposer&gt; iface = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    .......</span><br><span class="line">    Return&lt;Transport&gt; transportRet = sm-&gt;getTransport(IComposer::descriptor, serviceName);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    Transport transport = transportRet;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfHwbinder = (transport == Transport::HWBINDER);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">bool</span> vintfPassthru = (transport == Transport::PASSTHROUGH);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_TREBLE__</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> tries = <span class="number">0</span>; !getStub &amp;&amp; (vintfHwbinder || (vintfLegacy &amp;&amp; tries == <span class="number">0</span>)); tries++) &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (vintfHwbinder &amp;&amp; tries &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            waitForHwService(IComposer::descriptor, serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                sm-&gt;get(IComposer::descriptor, serviceName);</span><br><span class="line">        ......</span><br><span class="line">        sp&lt;::android::hidl::base::V1_0::IBase&gt; base = ret;</span><br><span class="line">        <span class="keyword">if</span> (base == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tries &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;IComposer: found null hwbinder interface&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Return&lt;sp&lt;IComposer&gt;&gt; castRet = IComposer::castFrom(base, <span class="literal">true</span> <span class="comment">/* emitError */</span>);</span><br><span class="line">        <span class="keyword">if</span> (!castRet.isOk()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (castRet.isDeadObject()) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;IComposer: found dead hwbinder service&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;IComposer: cannot call into hwbinder service: %s; No permission? Check for selinux denials.&quot;</span>, castRet.description().c_str());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        iface = castRet;</span><br><span class="line">        <span class="keyword">if</span> (iface == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            ALOGW(<span class="string">&quot;IComposer: received incompatible service; bug in hwservicemanager?&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> iface;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = getPassthroughServiceManager();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;get(IComposer::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.isOk()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = IComposer::castFrom(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> BsComposer(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里通过sm-&gt;get(IComposer::descriptor, serviceName)查询IComposer这个hidl服务，得到IBase对象后，在通过IComposer::castFrom转换为IComposer对象。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_castFrom.png" alt="Alt text | center"></p>
<p><strong>服务查询</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment">// Methods from IServiceManager follow.</span></span><br><span class="line">::android::<span class="function">hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; <span class="title">BpHwServiceManager::get</span><span class="params">(<span class="keyword">const</span> ::android::hardware::hidl_string&amp; fqName, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name)</span></span>&#123;</span><br><span class="line">    ::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt;  _hidl_out = ::android::hidl::manager::V1_0::BpHwServiceManager::_hidl_get(<span class="keyword">this</span>, <span class="keyword">this</span>, fqName, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _hidl_out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Methods from IServiceManager follow.</span></span><br><span class="line">::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; BpHwServiceManager::_hidl_get(::android::hardware::IInterface *_hidl_this, ::android::hardware::details::HidlInstrumentor *_hidl_this_instrumentor, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; fqName, <span class="keyword">const</span> ::android::hardware::hidl_string&amp; name) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">bool</span> mEnableInstrumentation = _hidl_this_instrumentor-&gt;isInstrumentationEnabled();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;mInstrumentationCallbacks = _hidl_this_instrumentor-&gt;getInstrumentationCallbacks();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    (<span class="keyword">void</span>) _hidl_this_instrumentor;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line">    atrace_begin(ATRACE_TAG_HAL, <span class="string">&quot;HIDL::IServiceManager::get::client&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)&amp;fqName);</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)&amp;name);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::CLIENT_API_ENTRY, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;get&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    ::android::hardware::Parcel _hidl_data;</span><br><span class="line">    ::android::hardware::Parcel _hidl_reply;</span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err;</span><br><span class="line">    ::android::hardware::Status _hidl_status;</span><br><span class="line"></span><br><span class="line">    ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt; _hidl_out_service;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeInterfaceToken(BpHwServiceManager::descriptor);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_fqName_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;fqName, <span class="keyword">sizeof</span>(fqName), &amp;_hidl_fqName_parent);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            fqName,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_fqName_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.writeBuffer(&amp;name, <span class="keyword">sizeof</span>(name), &amp;_hidl_name_parent);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::writeEmbeddedToParcel(</span><br><span class="line">            name,</span><br><span class="line">            &amp;_hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::IInterface::asBinder(_hidl_this)-&gt;transact(<span class="number">1</span> <span class="comment">/* get */</span>, _hidl_data, &amp;_hidl_reply);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readFromParcel(&amp;_hidl_status, _hidl_reply);</span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!_hidl_status.isOk()) &#123; <span class="keyword">return</span> _hidl_status; &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl__hidl_out_service_binder;</span><br><span class="line">        _hidl_err = _hidl_reply.readNullableStrongBinder(&amp;_hidl__hidl_out_service_binder);</span><br><span class="line">        <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">goto</span> _hidl_error; &#125;</span><br><span class="line"></span><br><span class="line">        _hidl_out_service = ::android::hardware::fromBinder&lt;::android::hidl::base::V1_0::IBase,::android::hidl::base::V1_0::BpHwBase,::android::hidl::base::V1_0::BnHwBase&gt;(_hidl__hidl_out_service_binder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    atrace_end(ATRACE_TAG_HAL);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)&amp;_hidl_out_service);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::CLIENT_API_EXIT, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;get&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    _hidl_status.setFromStatusT(_hidl_err);</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt;(_hidl_out_service);</span><br><span class="line"></span><br><span class="line">_hidl_error:</span><br><span class="line">    _hidl_status.setFromStatusT(_hidl_err);</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::Return&lt;::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt;(_hidl_status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个调用过程和hidl服务过程完全一致，就是一个从BpHwServiceManager –&gt; BnHwServiceManager –&gt; ServiceManager的过程。但需要注意，BpHwServiceManager得到BnHwServiceManager返回过来的binder代理后，会通过fromBinder函数进行对象转换：</p>
<p>::android::hardware::fromBinder&lt;::android::hidl::base::V1_0::IBase,::android::hidl::base::V1_0::BpHwBase,::android::hidl::base::V1_0::BnHwBase&gt;(_hidl__hidl_out_service_binder)</p>
<p>hwservicemanager将IComposer的binder代理BpHwBinder发给Framework Server进程，Framework Server进程拿到的依然是IComposer的binder代理BpHwBinder对象，因此在fromBinder函数中将创建BpHwBase对象来封装BpHwBinder。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment">// Methods from IServiceManager follow.</span></span><br><span class="line">::android::<span class="keyword">status_t</span> BnHwServiceManager::_hidl_get(</span><br><span class="line">        ::android::hidl::base::V1_0::BnHwBase* _hidl_this,</span><br><span class="line">        <span class="keyword">const</span> ::android::hardware::Parcel &amp;_hidl_data,</span><br><span class="line">        ::android::hardware::Parcel *_hidl_reply,</span><br><span class="line">        TransactCallback _hidl_cb) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">bool</span> mEnableInstrumentation = _hidl_this-&gt;isInstrumentationEnabled();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;mInstrumentationCallbacks = _hidl_this-&gt;getInstrumentationCallbacks();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    ::android::<span class="keyword">status_t</span> _hidl_err = ::android::OK;</span><br><span class="line">    <span class="keyword">if</span> (!_hidl_data.enforceInterface(BnHwServiceManager::Pure::descriptor)) &#123;</span><br><span class="line">        _hidl_err = ::android::BAD_TYPE;</span><br><span class="line">        <span class="keyword">return</span> _hidl_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* fqName;</span><br><span class="line">    <span class="keyword">const</span> ::android::hardware::hidl_string* name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_fqName_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*fqName), &amp;_hidl_fqName_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;fqName));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*fqName),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_fqName_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> _hidl_name_parent;</span><br><span class="line"></span><br><span class="line">    _hidl_err = _hidl_data.readBuffer(<span class="keyword">sizeof</span>(*name), &amp;_hidl_name_parent,  <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">void</span> **&gt;(&amp;name));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    _hidl_err = ::android::hardware::readEmbeddedFromParcel(</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;::android::hardware::hidl_string &amp;&gt;(*name),</span><br><span class="line">            _hidl_data,</span><br><span class="line">            _hidl_name_parent,</span><br><span class="line">            <span class="number">0</span> <span class="comment">/* parentOffset */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_err != ::android::OK) &#123; <span class="keyword">return</span> _hidl_err; &#125;</span><br><span class="line"></span><br><span class="line">    atrace_begin(ATRACE_TAG_HAL, <span class="string">&quot;HIDL::IServiceManager::get::server&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)fqName);</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)name);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::SERVER_API_ENTRY, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;get&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt; _hidl_out_service = <span class="keyword">static_cast</span>&lt;BnHwServiceManager*&gt;(_hidl_this)-&gt;_hidl_mImpl-&gt;get(*fqName, *name);</span><br><span class="line"></span><br><span class="line">    ::android::hardware::writeToParcel(::android::hardware::Status::ok(), _hidl_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_hidl_out_service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        _hidl_err = _hidl_reply-&gt;writeStrongBinder(<span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ::android::sp&lt;::android::hardware::IBinder&gt; _hidl_binder = ::android::hardware::toBinder&lt;</span><br><span class="line">                ::android::hidl::base::V1_0::IBase&gt;(_hidl_out_service);</span><br><span class="line">        <span class="keyword">if</span> (_hidl_binder.get() != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            _hidl_err = _hidl_reply-&gt;writeStrongBinder(_hidl_binder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _hidl_err = ::android::UNKNOWN_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* _hidl_err ignored! */</span></span><br><span class="line"></span><br><span class="line">    atrace_end(ATRACE_TAG_HAL);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID_DEBUGGABLE__</span></span><br><span class="line">    <span class="keyword">if</span> (UNLIKELY(mEnableInstrumentation)) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">void</span> *&gt; _hidl_args;</span><br><span class="line">        _hidl_args.push_back((<span class="keyword">void</span> *)&amp;_hidl_out_service);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;callback: mInstrumentationCallbacks) &#123;</span><br><span class="line">            callback(InstrumentationEvent::SERVER_API_EXIT, <span class="string">&quot;android.hidl.manager&quot;</span>, <span class="string">&quot;1.0&quot;</span>, <span class="string">&quot;IServiceManager&quot;</span>, <span class="string">&quot;get&quot;</span>, &amp;_hidl_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __ANDROID_DEBUGGABLE__</span></span></span><br><span class="line"></span><br><span class="line">    _hidl_cb(*_hidl_reply);</span><br><span class="line">    <span class="keyword">return</span> _hidl_err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BnHwServiceManager通过ServiceManager对象查询到对应的hidl服务，返回IBase对象后，会调用toBinder函数转换为IBinder类型对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::android::hardware::toBinder&lt; ::android::hidl::base::V1_0::IBase&gt;(_hidl_out_service)</span><br></pre></td></tr></table></figure>

<p>由于在hwservicemanager这边，保存的是IComposer的BpHwBase对象，因此在toBinder函数中将调用IInterface::asBinder来得到BpHwBase的成员变量中的BpHwBinder对象。<br>fromBinder和toBinder函数在之前的文章中已经详细分析了，这里就不再展开。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_hwbinder.png" alt="Alt text | center"></p>
<p>服务查询过程其实就是根据接口包名及服务名称，从hwservicemanager管理的表中查询对应的IBase服务对象，然后在Client进程空间分别创建BpHwBinder和BpHwBase对象。<br><strong>接口转换</strong><br>Framework Server进程通过上述hidl服务查询，得到了BpHwBase对象后，需要将其转换为与业务相关的代理对象，这就是通过：<strong>Return&lt;sp<IComposer>&gt; castRet = IComposer::castFrom(base, true /* emitError */)</strong>;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android\out\soong\.intermediates\system\libhidl\transport\manager\<span class="number">1.0</span>\android.hidl.manager@<span class="number">1.0</span>_genc++\gen\android\hidl\manager\<span class="number">1.0</span>\ServiceManagerAll.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment">// static </span></span><br><span class="line">::android::<span class="function">hardware::Return&lt;::android::sp&lt;IComposer&gt;&gt; <span class="title">IComposer::castFrom</span><span class="params">(<span class="keyword">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; parent, <span class="keyword">bool</span> emitError)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::details::castInterface&lt;IComposer, ::android::hidl::base::V1_0::IBase, BpHwComposer&gt;(</span><br><span class="line">            parent, <span class="string">&quot;android.hardware.graphics.composer@2.1::IComposer&quot;</span>, emitError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">system\libhidl\transport\include\hidl\HidlTransportSupport.h</span><br><span class="line"><span class="comment">// Return nullptr if:</span></span><br><span class="line"><span class="comment">// 1. parent is null</span></span><br><span class="line"><span class="comment">// 2. cast failed because IChild is not a child type of IParent.</span></span><br><span class="line"><span class="comment">// 3. !emitError, calling into parent fails.</span></span><br><span class="line"><span class="comment">// Return an error Return object if:</span></span><br><span class="line"><span class="comment">// 1. emitError, calling into parent fails.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> IChild, <span class="keyword">typename</span> IParent, <span class="keyword">typename</span> BpChild&gt;</span><br><span class="line"><span class="function">Return&lt;sp&lt;IChild&gt;&gt; <span class="title">castInterface</span><span class="params">(sp&lt;IParent&gt; parent, <span class="keyword">const</span> <span class="keyword">char</span>* childIndicator, <span class="keyword">bool</span> emitError)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.get() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// casts always succeed with nullptrs.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Return&lt;<span class="keyword">bool</span>&gt; canCastRet = details::canCastInterface(parent.get(), childIndicator, emitError);</span><br><span class="line">    <span class="keyword">if</span> (!canCastRet.isOk()) &#123;</span><br><span class="line">        <span class="comment">// call fails, propagate the error if emitError</span></span><br><span class="line">        <span class="keyword">return</span> emitError</span><br><span class="line">                ? details::StatusOf&lt;<span class="keyword">bool</span>, sp&lt;IChild&gt;&gt;(canCastRet)</span><br><span class="line">                : Return&lt;sp&lt;IChild&gt;&gt;(sp&lt;IChild&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!canCastRet) &#123;</span><br><span class="line">        <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="literal">nullptr</span>); <span class="comment">// cast failed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO b/32001926 Needs to be fixed for socket mode.</span></span><br><span class="line">    <span class="keyword">if</span> (parent-&gt;isRemote()) &#123;</span><br><span class="line">        <span class="comment">// binderized mode. Got BpChild. grab the remote and wrap it.</span></span><br><span class="line">        <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="keyword">new</span> BpChild(toBinder&lt;IParent&gt;(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Passthrough mode. Got BnChild and BsChild.</span></span><br><span class="line">    <span class="keyword">return</span> sp&lt;IChild&gt;(<span class="keyword">static_cast</span>&lt;IChild *&gt;(parent.get()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个模板函数展开后如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Return&lt;sp&lt;IComposer&gt;&gt; <span class="title">castInterface</span><span class="params">(sp&lt;IBase&gt; parent, <span class="keyword">const</span> <span class="keyword">char</span> *childIndicator, <span class="keyword">bool</span> emitError)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.get() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// casts always succeed with nullptrs.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Return&lt;<span class="keyword">bool</span>&gt; canCastRet = details::canCastInterface(parent.get(), childIndicator, emitError);</span><br><span class="line">    <span class="keyword">if</span> (!canCastRet.isOk()) &#123;</span><br><span class="line">        <span class="comment">// call fails, propagate the error if emitError</span></span><br><span class="line">        <span class="keyword">return</span> emitError</span><br><span class="line">                ? details::StatusOf&lt;<span class="keyword">bool</span>, sp&lt;IComposer&gt;&gt;(canCastRet)</span><br><span class="line">                : Return&lt;sp&lt;IComposer&gt;&gt;(sp&lt;IComposer&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!canCastRet) &#123;</span><br><span class="line">        <span class="keyword">return</span> sp&lt;IComposer&gt;(<span class="literal">nullptr</span>); <span class="comment">// cast failed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO b/32001926 Needs to be fixed for socket mode.</span></span><br><span class="line">    <span class="keyword">if</span> (parent-&gt;isRemote()) &#123;</span><br><span class="line">        <span class="comment">// binderized mode. Got BpChild. grab the remote and wrap it.</span></span><br><span class="line">        <span class="keyword">return</span> sp&lt;IComposer&gt;(<span class="keyword">new</span> BpHwComposer(toBinder&lt;IBase, BpParent&gt;(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Passthrough mode. Got BnChild and BsChild.</span></span><br><span class="line">    <span class="keyword">return</span> sp&lt;IComposer&gt;(<span class="keyword">static_cast</span>&lt;IComposer *&gt;(parent.get()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此最终会创建一个BpHwComposer对象。</p>
<p>new BpHwComposer(toBinder&lt;IBase, BpParent&gt;(parent))<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_HIDL_Get_BpHwComposer.png" alt="Alt text | center"></p>
<h4 id="（三）、SurfaceFlinger-与-HWC2-通信"><a href="#（三）、SurfaceFlinger-与-HWC2-通信" class="headerlink" title="（三）、SurfaceFlinger 与 HWC2 通信"></a>（三）、SurfaceFlinger 与 HWC2 通信</h4><p>我们首先看看Qualcomm HWC2的一些初始化过程堆栈信息，这里不着重分析此过程，主要分析SurfaceFlinger 与 HWC2 通信。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sdm::StrategyImpl::StrategyImpl()                                                                                       /vendor/lib64/libsdmextension.so</span><br><span class="line">sdm::CreateStrategy()                                                                                                   /vendor/lib64/libsdmextension.so</span><br><span class="line">sdm::ExtensionImpl::CreateStrategyExtn()                                                                                /vendor/lib64/libsdmextension.so</span><br><span class="line">sdm::Strategy::Init()                                                                                                   /hardware/qcom/msm8996/sdm/libs/core/strategy.cpp</span><br><span class="line">sdm::CompManager::RegisterDisplay()                                                                                     /hardware/qcom/msm8996/sdm/libs/core/comp_manager.cpp</span><br><span class="line">sdm::DisplayBase::Init()                                                                                                /hardware/qcom/msm8996/sdm/libs/core/display_base.cpp</span><br><span class="line">sdm::DisplayPrimary::Init()                                                                                             /hardware/qcom/msm8996/sdm/libs/core/display_primary.cpp</span><br><span class="line">sdm::CoreImpl::CreateDisplay()                                                                                          /hardware/qcom/msm8996/sdm/libs/core/core_impl.cpp</span><br><span class="line">sdm::HWCDisplay::Init()                                                                                                 /hardware/qcom/msm8996/sdm/libs/hwc2/hwc_display.cpp</span><br><span class="line">sdm::HWCDisplayPrimary::Init()                                                                                          /hardware/qcom/msm8996/sdm/libs/hwc2/hwc_display_primary.cpp</span><br><span class="line">sdm::HWCDisplayPrimary::Create()                                                                                        /hardware/qcom/msm8996/sdm/libs/hwc2/hwc_display_primary.cpp</span><br><span class="line">sdm::HWCSession::Init()                                                                                                 /hardware/qcom/msm8996/sdm/libs/hwc2/hwc_session.cpp:<span class="number">200</span></span><br><span class="line">sdm::HWCSession::Open(<span class="keyword">hw_module_t</span> <span class="keyword">const</span>*, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">hw_device_t</span>**)                                                   /hardware/qcom/msm8996/sdm/libs/hwc2/hwc_session.cpp:<span class="number">259</span></span><br><span class="line">android::hardware::graphics::composer::V2_1::passthrough::HwcLoader::openDeviceWithAdapter(<span class="keyword">hw_module_t</span> <span class="keyword">const</span>*, <span class="keyword">bool</span>*)   /hardware/interfaces/graphics/composer/<span class="number">2.1</span>/utils/passthrough/include/composer-passthrough/<span class="number">2.1</span>/HwcLoader.h</span><br><span class="line">android::hardware::graphics::composer::V2_1::passthrough::HwcLoader::createHalWithAdapter(<span class="keyword">hw_module_t</span> <span class="keyword">const</span>*)           /hardware/interfaces/graphics/composer/<span class="number">2.1</span>/utils/passthrough/include/composer-passthrough/<span class="number">2.1</span>/HwcLoader.h</span><br><span class="line">android::hardware::graphics::composer::V2_1::passthrough::HwcLoader::load()                                             /hardware/interfaces/graphics/composer/<span class="number">2.1</span>/utils/passthrough/include/composer-passthrough/<span class="number">2.1</span>/HwcLoader.h</span><br><span class="line">android::hardware::PassthroughServiceManager::get() <span class="keyword">const</span>                                                               /system/libhidl/transport/ServiceManagement.cpp</span><br><span class="line">android::hardware::PassthroughServiceManager::openLibs()&gt; <span class="keyword">const</span>&amp;)                                                       /system/libhidl/transport/ServiceManagement.cpp</span><br><span class="line">android::hardware::PassthroughServiceManager::get()                                                                     /system/libhidl/transport/ServiceManagement.cpp</span><br><span class="line">android::hardware::details::getRawServiceInternal()                                                                     /system/libhidl/transport/ServiceManagement.cpp</span><br><span class="line">android::sp&lt;android::hardware::graphics::composer::V2_1::IComposer&gt; android::hardware::details::getServiceInternal&lt;a&gt;   /system/libhidl/transport/include/hidl/HidlTransportSupport.h</span><br><span class="line"><span class="keyword">int</span> android::hardware::registerPassthroughServiceImplementation&lt;android::hardware::graphics::composer::V2_1::IComposer&gt; /system/libhidl/transport/include/hidl/LegacySupport.h</span><br><span class="line"><span class="keyword">int</span> android::hardware::defaultPassthroughServiceImplementation&lt;android::hardware::graphics::composer::V2_1::IComposer&gt;()/system/libhidl/transport/include/hidl/LegacySupport.h</span><br><span class="line"><span class="keyword">int</span> android::hardware::defaultPassthroughServiceImplementation&lt;android::hardware::graphics::composer::V2_1::IComposer&gt;()/system/libhidl/transport/include/hidl/LegacySupport.h</span><br><span class="line">main                                                                                                                    /hardware/interfaces/graphics/composer/<span class="number">2.1</span>/<span class="keyword">default</span>/service.cpp</span><br></pre></td></tr></table></figure>

<h5 id="3-1-0-、SurfaceFlinger-与-HWC2-通信框架图"><a href="#3-1-0-、SurfaceFlinger-与-HWC2-通信框架图" class="headerlink" title="3.1.0 、SurfaceFlinger 与 HWC2 通信框架图"></a>3.1.0 、SurfaceFlinger 与 HWC2 通信框架图</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_SurfaceFlinger.png" alt="Alt text | center"></p>
<h5 id="3-1-1-、SurfaceFlinger-合成图层"><a href="#3-1-1-、SurfaceFlinger-合成图层" class="headerlink" title="3.1.1 、SurfaceFlinger 合成图层"></a>3.1.1 、SurfaceFlinger 合成图层</h5><p>通过Log来初略看下SurfaceFlinger合并图层流程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): handlePageFlip</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): preComposition</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): rebuildLayerStacks</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): setUpHWComposer</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): doComposition</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): doDisplayComposition</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.546</span> V/SurfaceFlinger(  <span class="number">355</span>): doComposeSurfaces</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.547</span> V/SurfaceFlinger(  <span class="number">355</span>): Rendering client layers</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.547</span> V/SurfaceFlinger(  <span class="number">355</span>): postFramebuffer</span><br><span class="line"><span class="number">02</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">35</span>:<span class="number">25.548</span> V/SurfaceFlinger(  <span class="number">355</span>): postComposition</span><br></pre></td></tr></table></figure>
<h5 id="3-2-0-、SurfaceFlinger-与-HWC2-通信流程"><a href="#3-2-0-、SurfaceFlinger-与-HWC2-通信流程" class="headerlink" title="3.2.0 、SurfaceFlinger 与 HWC2 通信流程"></a>3.2.0 、SurfaceFlinger 与 HWC2 通信流程</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HW2_present.png" alt="Alt text | center"></p>
<h4 id="（四）、HWC2-处理-HWC-Layers"><a href="#（四）、HWC2-处理-HWC-Layers" class="headerlink" title="（四）、HWC2 处理 HWC Layers"></a>（四）、HWC2 处理 HWC Layers</h4><p>首先根据Log来看下Qualcomm  HWC2工作流程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.084</span> V/SDM     (  <span class="number">486</span>): HWScale::DumpScaleData: Fetch=[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]  Repeat=[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]  roi_width = <span class="number">480</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.084</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.084</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: ******************* Layer[<span class="number">2</span>] Left pipe Input ******************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.084</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: in_w <span class="number">512</span>, in_h <span class="number">864</span>, in_f <span class="number">45</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.084</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: plane_alpha <span class="number">255</span>, zorder <span class="number">2</span>, blending <span class="number">2</span>, horz_deci <span class="number">0</span>, vert_deci <span class="number">0</span>, pipe_id = <span class="number">0x200</span>, mdp_flags <span class="number">0x4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.084</span> V/SDM     (  <span class="number">486</span>): HWDevice::Validate: src_rect [<span class="number">0</span>, <span class="number">0</span>, <span class="number">480</span>, <span class="number">36</span>]</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> V/SDM     (  <span class="number">486</span>): HWDevice::Validate: dst_rect [<span class="number">0</span>, <span class="number">0</span>, <span class="number">480</span>, <span class="number">36</span>]</span><br><span class="line">......</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: ******************* Layer[<span class="number">3</span>] Left pipe Input ******************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: in_w <span class="number">512</span>, in_h <span class="number">48</span>, in_f <span class="number">45</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: plane_alpha <span class="number">255</span>, zorder <span class="number">3</span>, blending <span class="number">2</span>, horz_deci <span class="number">0</span>, vert_deci <span class="number">0</span>, pipe_id = <span class="number">0x20</span>, mdp_flags <span class="number">0x4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> V/SDM     (  <span class="number">486</span>): HWDevice::Validate: src_rect [<span class="number">0</span>, <span class="number">0</span>, <span class="number">480</span>, <span class="number">36</span>]</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> V/SDM     (  <span class="number">486</span>): HWDevice::Validate: dst_rect [<span class="number">0</span>, <span class="number">0</span>, <span class="number">480</span>, <span class="number">36</span>]</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> D/SDM     (  <span class="number">486</span>): HWScale::DumpScaleData: Scale Enable = <span class="number">1</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.085</span> V/SDM     (  <span class="number">486</span>): HWScale::DumpScaleData: Scale Data[<span class="number">0</span>] : Phase=[<span class="number">0</span> <span class="number">200000</span> <span class="number">0</span> <span class="number">200000</span>] Pixel_Ext=[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.086</span> V/SDM     (  <span class="number">486</span>): HWScale::DumpScaleData: Fetch=[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]  Repeat=[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]  roi_width = <span class="number">480</span></span><br><span class="line">......</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.086</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.086</span> D/SDM     (  <span class="number">486</span>): HWDevice::Validate: ioctl_ MSMFB_ATOMIC_COMMIT</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): StrategyImpl::Stop: <span class="number">0x2000</span> SUCCEEDED <span class="keyword">for</span> display = <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> I/SDM     (  <span class="number">486</span>): DisplayBase::Prepare: Exiting Prepare <span class="keyword">for</span> display type : <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> I/SDM     (  <span class="number">486</span>): DisplayBase::Commit: Entering commit <span class="keyword">for</span> display type : <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: *************************** Primary Display Device Commit Input ************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: SDE layer count is <span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: ****************** Layer[<span class="number">0</span>] Left pipe Input *******************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_w <span class="number">512</span>, in_h <span class="number">864</span>, in_f <span class="number">45</span>, horz_deci <span class="number">0</span>, vert_deci <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> V/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_buf_fd <span class="number">22</span>, in_buf_offset <span class="number">0</span>, in_buf_stride <span class="number">512</span>, in_plane_count <span class="number">1</span>, in_fence <span class="number">-1</span>, layer count <span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: ****************** Layer[<span class="number">1</span>] Left pipe Input *******************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_w <span class="number">1280</span>, in_h <span class="number">1024</span>, in_f <span class="number">45</span>, horz_deci <span class="number">0</span>, vert_deci <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> V/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_buf_fd <span class="number">25</span>, in_buf_offset <span class="number">0</span>, in_buf_stride <span class="number">1280</span>, in_plane_count <span class="number">1</span>, in_fence <span class="number">26</span>, layer count <span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: ****************** Layer[<span class="number">2</span>] Left pipe Input *******************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_w <span class="number">512</span>, in_h <span class="number">864</span>, in_f <span class="number">45</span>, horz_deci <span class="number">0</span>, vert_deci <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> V/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_buf_fd <span class="number">32</span>, in_buf_offset <span class="number">0</span>, in_buf_stride <span class="number">512</span>, in_plane_count <span class="number">1</span>, in_fence <span class="number">29</span>, layer count <span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: ****************** Layer[<span class="number">3</span>] Left pipe Input *******************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_w <span class="number">512</span>, in_h <span class="number">48</span>, in_f <span class="number">45</span>, horz_deci <span class="number">0</span>, vert_deci <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> V/SDM     (  <span class="number">486</span>): HWDevice::Commit: in_buf_fd <span class="number">28</span>, in_buf_offset <span class="number">0</span>, in_buf_stride <span class="number">512</span>, in_plane_count <span class="number">1</span>, in_fence <span class="number">34</span>, layer count <span class="number">4</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> D/SDM     (  <span class="number">486</span>): HWDevice::Commit: *************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.087</span> I/SDM     (  <span class="number">486</span>): HWDevice::Commit: ioctl_ MSMFB_ATOMIC_COMMIT</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> I/SDM     (  <span class="number">486</span>): HWDevice::Commit: *************************** Primary Display Device Commit Input ************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> I/SDM     (  <span class="number">486</span>): HWDevice::Commit: retire_fence_fd <span class="number">27</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> I/SDM     (  <span class="number">486</span>): HWDevice::Commit: *******************************************************************</span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> V/SDM     (  <span class="number">486</span>): ResourceImpl::PostCommit: Resource <span class="keyword">for</span> hw_block = <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> V/SDM     (  <span class="number">486</span>): PipeAlloc::PostCommit: Pipe acquired index = <span class="number">6</span>, type = <span class="number">2</span>, pipe_id = <span class="number">20</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> V/SDM     (  <span class="number">486</span>): PipeAlloc::PostCommit: Pipe acquired index = <span class="number">7</span>, type = <span class="number">2</span>, pipe_id = <span class="number">200</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> V/SDM     (  <span class="number">486</span>): PipeAlloc::PostCommit: Pipe acquired index = <span class="number">8</span>, type = <span class="number">3</span>, pipe_id = <span class="number">40</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> V/SDM     (  <span class="number">486</span>): PipeAlloc::PostCommit: Pipe acquired index = <span class="number">9</span>, type = <span class="number">3</span>, pipe_id = <span class="number">80</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> V/SDM     (  <span class="number">486</span>): CompManager::PostCommit: registered display bit mask <span class="number">0x1</span>, configured display bit mask <span class="number">0x1</span>, display type <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> I/SDM     (  <span class="number">486</span>): DisplayBase::Commit: Exiting commit <span class="keyword">for</span> display type : <span class="number">0</span></span><br><span class="line"><span class="number">02</span><span class="number">-22</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">00.088</span> I/SDM     (  <span class="number">486</span>): HWPrimary::SetIdleTimeoutMs: Setting idle timeout to = <span class="number">70</span> ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-1-0-、HWCDisplayPrimary-Validate"><a href="#4-1-0-、HWCDisplayPrimary-Validate" class="headerlink" title="4.1.0 、HWCDisplayPrimary::Validate"></a>4.1.0 、HWCDisplayPrimary::Validate</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">android/hardware/qcom/display/sdm/libs/hwc2/hwc_display_primary.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">HWC2::Error <span class="title">HWCDisplayPrimary::Validate</span><span class="params">(<span class="keyword">uint32_t</span> *out_num_types, <span class="keyword">uint32_t</span> *out_num_requests)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> status = HWC2::Error::None;</span><br><span class="line">  DisplayError error = kErrorNone;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (default_mode_status_ &amp;&amp; !boot_animation_completed_) &#123;</span><br><span class="line">    ProcessBootAnimCompleted();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (display_paused_) &#123;</span><br><span class="line">    MarkLayersForGPUBypass();</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (color_tranform_failed_) &#123;</span><br><span class="line">    <span class="comment">// Must fall back to client composition</span></span><br><span class="line">    MarkLayersForClientComposition();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill in the remaining blanks in the layers and add them to the SDM layerstack</span></span><br><span class="line">  BuildLayerStack();</span><br><span class="line">  <span class="comment">// Checks and replaces layer stack for solid fill</span></span><br><span class="line">  SolidFillPrepare();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> pending_output_dump = dump_frame_count_ &amp;&amp; dump_output_to_file_;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (frame_capture_buffer_queued_ || pending_output_dump) &#123;</span><br><span class="line">    <span class="comment">// RHS values were set in FrameCaptureAsync() called from a binder thread. They are picked up</span></span><br><span class="line">    <span class="comment">// here in a subsequent draw round.</span></span><br><span class="line">    layer_stack_.output_buffer = &amp;output_buffer_;</span><br><span class="line">    layer_stack_.flags.post_processed_output = post_processed_output_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> one_updating_layer = SingleLayerUpdating();</span><br><span class="line">  ToggleCPUHint(one_updating_layer);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> refresh_rate = GetOptimalRefreshRate(one_updating_layer);</span><br><span class="line">  <span class="keyword">if</span> (current_refresh_rate_ != refresh_rate) &#123;</span><br><span class="line">    error = display_intf_-&gt;SetRefreshRate(refresh_rate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (error == kErrorNone) &#123;</span><br><span class="line">    <span class="comment">// On success, set current refresh rate to new refresh rate</span></span><br><span class="line">    current_refresh_rate_ = refresh_rate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle_idle_timeout_) &#123;</span><br><span class="line">    handle_idle_timeout_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (layer_set_.empty()) &#123;</span><br><span class="line">    validated_ = <span class="literal">true</span>;</span><br><span class="line">    flush_ = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  status = PrepareLayerStack(out_num_types, out_num_requests);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-1-1-、HWCDisplay-BuildLayerStack"><a href="#4-1-1-、HWCDisplay-BuildLayerStack" class="headerlink" title="4.1.1 、HWCDisplay::BuildLayerStack()"></a>4.1.1 、HWCDisplay::BuildLayerStack()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">android/hardware/qcom/display/sdm/libs/hwc2/hwc_display.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HWCDisplay::BuildLayerStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  layer_stack_ = LayerStack();</span><br><span class="line">  display_rect_ = LayerRect();</span><br><span class="line">  metadata_refresh_rate_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> working_primaries = ColorPrimaries_BT709_5;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add one layer for fb target</span></span><br><span class="line">  <span class="comment">// TODO(user): Add blit target layers</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> hwc_layer : layer_set_) &#123;</span><br><span class="line">    Layer *layer = hwc_layer-&gt;GetSDMLayer();</span><br><span class="line">    layer-&gt;flags = &#123;&#125;;   <span class="comment">// Reset earlier flags</span></span><br><span class="line">    <span class="keyword">if</span> (hwc_layer-&gt;GetClientRequestedCompositionType() == HWC2::Composition::Client) &#123;</span><br><span class="line">      layer-&gt;flags.skip = <span class="literal">true</span>;</span><br><span class="line">      layer_stack_.flags.client_composited_layer_present = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hwc_layer-&gt;GetClientRequestedCompositionType() == HWC2::Composition::SolidColor) &#123;</span><br><span class="line">      layer-&gt;flags.solid_fill = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hwc_layer-&gt;GetClientRequestedCompositionType() == HWC2::Composition::Sideband) &#123;</span><br><span class="line">      layer-&gt;flags.sideband = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!hwc_layer-&gt;ValidateAndSetCSC()) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE_WIDE_COLOR</span></span><br><span class="line">      layer-&gt;flags.skip = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    working_primaries = WidestPrimaries(working_primaries,</span><br><span class="line">                                        layer-&gt;input_buffer.color_metadata.colorPrimaries);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set default composition as GPU for SDM</span></span><br><span class="line">    layer-&gt;composition = kCompositionGPU;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (swap_interval_zero_) &#123;</span><br><span class="line">      <span class="keyword">if</span> (layer-&gt;input_buffer.acquire_fence_fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(layer-&gt;input_buffer.acquire_fence_fd);</span><br><span class="line">        layer-&gt;input_buffer.acquire_fence_fd = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">private_handle_t</span> *handle =</span><br><span class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">private_handle_t</span> *&gt;(layer-&gt;input_buffer.buffer_id);</span><br><span class="line">    <span class="keyword">if</span> (handle) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_GRALLOC1</span></span><br><span class="line">      <span class="keyword">if</span> (handle-&gt;buffer_type == BUFFER_TYPE_VIDEO) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      <span class="keyword">if</span> (handle-&gt;bufferType == BUFFER_TYPE_VIDEO) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        layer_stack_.flags.video_present = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// TZ Protected Buffer - L1</span></span><br><span class="line">      <span class="keyword">if</span> (handle-&gt;flags &amp; <span class="keyword">private_handle_t</span>::PRIV_FLAGS_SECURE_BUFFER) &#123;</span><br><span class="line">        layer_stack_.flags.secure_present = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Gralloc Usage Protected Buffer - L3 - which needs to be treated as Secure &amp; avoid fallback</span></span><br><span class="line">      <span class="keyword">if</span> (handle-&gt;flags &amp; <span class="keyword">private_handle_t</span>::PRIV_FLAGS_PROTECTED_BUFFER) &#123;</span><br><span class="line">        layer_stack_.flags.secure_present = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;flags.skip) &#123;</span><br><span class="line">      layer_stack_.flags.skip_present = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;flags.sideband) &#123;</span><br><span class="line">      layer_stack_.flags.sideband_present = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hwc_layer-&gt;GetClientRequestedCompositionType() == HWC2::Composition::Cursor) &#123;</span><br><span class="line">      <span class="comment">// Currently we support only one HWCursor &amp; only at top most z-order</span></span><br><span class="line">      <span class="keyword">if</span> ((*layer_set_.rbegin())-&gt;GetId() == hwc_layer-&gt;GetId()) &#123;</span><br><span class="line">        layer-&gt;flags.cursor = <span class="literal">true</span>;</span><br><span class="line">        layer_stack_.flags.cursor_present = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(user): Move to a getter if this is needed at other places</span></span><br><span class="line">    <span class="keyword">hwc_rect_t</span> scaled_display_frame = &#123;INT(layer-&gt;dst_rect.left), INT(layer-&gt;dst_rect.top),</span><br><span class="line">                                       INT(layer-&gt;dst_rect.right), INT(layer-&gt;dst_rect.bottom)&#125;;</span><br><span class="line">    ApplyScanAdjustment(&amp;scaled_display_frame);</span><br><span class="line">    hwc_layer-&gt;SetLayerDisplayFrame(scaled_display_frame);</span><br><span class="line">    ApplyDeInterlaceAdjustment(layer);</span><br><span class="line">    <span class="comment">// SDM requires these details even for solid fill</span></span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;flags.solid_fill) &#123;</span><br><span class="line">      LayerBuffer *layer_buffer = &amp;layer-&gt;input_buffer;</span><br><span class="line">      layer_buffer-&gt;width = UINT32(layer-&gt;dst_rect.right - layer-&gt;dst_rect.left);</span><br><span class="line">      layer_buffer-&gt;height = UINT32(layer-&gt;dst_rect.bottom - layer-&gt;dst_rect.top);</span><br><span class="line">      layer_buffer-&gt;unaligned_width = layer_buffer-&gt;width;</span><br><span class="line">      layer_buffer-&gt;unaligned_height = layer_buffer-&gt;height;</span><br><span class="line">      layer_buffer-&gt;acquire_fence_fd = <span class="number">-1</span>;</span><br><span class="line">      layer_buffer-&gt;release_fence_fd = <span class="number">-1</span>;</span><br><span class="line">      layer-&gt;src_rect.left = <span class="number">0</span>;</span><br><span class="line">      layer-&gt;src_rect.top = <span class="number">0</span>;</span><br><span class="line">      layer-&gt;src_rect.right = layer_buffer-&gt;width;</span><br><span class="line">      layer-&gt;src_rect.bottom = layer_buffer-&gt;height;</span><br><span class="line">      <span class="comment">// if bottom layer has the same color as border color, skip it</span></span><br><span class="line">      <span class="keyword">if</span> (hwc_layer != *layer_set_.begin() || (layer-&gt;solid_fill_color &amp; <span class="number">0xFFFFFF</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        layer-&gt;flags.skip = <span class="literal">true</span>;</span><br><span class="line">        layer_stack_.flags.skip_present = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;frame_rate &gt; metadata_refresh_rate_) &#123;</span><br><span class="line">      metadata_refresh_rate_ = SanitizeRefreshRate(layer-&gt;frame_rate);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      layer-&gt;frame_rate = current_refresh_rate_;</span><br><span class="line">    &#125;</span><br><span class="line">    display_rect_ = Union(display_rect_, layer-&gt;dst_rect);</span><br><span class="line">    geometry_changes_ |= hwc_layer-&gt;GetGeometryChanges();</span><br><span class="line"></span><br><span class="line">    layer-&gt;flags.updating = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (layer_set_.size() &lt;= kMaxLayerCount) &#123;</span><br><span class="line">      layer-&gt;flags.updating = IsLayerUpdating(layer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    layer_stack_.layers.push_back(layer);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>细节暂时不分析，就是循环将layers处理后重新push_back到layer_stack_。</p>
<h5 id="4-1-2-、HWCDisplay-PrepareLayerStack"><a href="#4-1-2-、HWCDisplay-PrepareLayerStack" class="headerlink" title="4.1.2 、HWCDisplay::PrepareLayerStack()"></a>4.1.2 、HWCDisplay::PrepareLayerStack()</h5><p>接着调用了PrepareLayerStack()。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">android/hardware/qcom/display/sdm/libs/hwc2/hwc_display.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">HWC2::Error <span class="title">HWCDisplay::PrepareLayerStack</span><span class="params">(<span class="keyword">uint32_t</span> *out_num_types, <span class="keyword">uint32_t</span> *out_num_requests)</span> </span>&#123;</span><br><span class="line">  layer_changes_.clear();</span><br><span class="line">  layer_requests_.clear();</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">if</span> (!skip_prepare_) &#123;</span><br><span class="line">    DisplayError error = display_intf_-&gt;Prepare(&amp;layer_stack_);</span><br><span class="line">    <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">      <span class="keyword">if</span> (error == kErrorShutDown) &#123;</span><br><span class="line">        shutdown_pending_ = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error != kErrorPermission) &#123;</span><br><span class="line">        DLOGE(<span class="string">&quot;Prepare failed. Error = %d&quot;</span>, error);</span><br><span class="line">        <span class="comment">// To prevent surfaceflinger infinite wait, flush the previous frame during Commit()</span></span><br><span class="line">        <span class="comment">// so that previous buffer and fences are released, and override the error.</span></span><br><span class="line">        flush_ = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> HWC2::Error::BadDisplay;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Skip is not set</span></span><br><span class="line">    MarkLayersForGPUBypass();</span><br><span class="line">    skip_prepare_ = <span class="literal">false</span>;</span><br><span class="line">    DLOGI(<span class="string">&quot;SecureDisplay %s, Skip Prepare/Commit and Flush&quot;</span>,</span><br><span class="line">          secure_display_active_ ? <span class="string">&quot;Starting&quot;</span> : <span class="string">&quot;Stopping&quot;</span>);</span><br><span class="line">    flush_ = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> hwc_layer : layer_set_) &#123;</span><br><span class="line">    Layer *layer = hwc_layer-&gt;GetSDMLayer();</span><br><span class="line">    LayerComposition &amp;composition = layer-&gt;composition;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((composition == kCompositionSDE) || (composition == kCompositionHybrid) ||</span><br><span class="line">        (composition == kCompositionBlit) || (composition == kCompositionSideband)) &#123;</span><br><span class="line">      layer_requests_[hwc_layer-&gt;GetId()] = HWC2::LayerRequest::ClearClientTarget;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HWC2::Composition requested_composition = hwc_layer-&gt;GetClientRequestedCompositionType();</span><br><span class="line">    <span class="comment">// Set SDM composition to HWC2 type in HWCLayer</span></span><br><span class="line">    hwc_layer-&gt;SetComposition(composition);</span><br><span class="line">    HWC2::Composition device_composition  = hwc_layer-&gt;GetDeviceSelectedCompositionType();</span><br><span class="line">    <span class="comment">// Update the changes list only if the requested composition is different from SDM comp type</span></span><br><span class="line">    <span class="comment">// TODO(user): Take Care of other comptypes(BLIT)</span></span><br><span class="line">    <span class="keyword">if</span> (requested_composition != device_composition) &#123;</span><br><span class="line">      layer_changes_[hwc_layer-&gt;GetId()] = device_composition;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *out_num_types = UINT32(layer_changes_.size());</span><br><span class="line">  *out_num_requests = UINT32(layer_requests_.size());</span><br><span class="line">  validated_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (*out_num_types &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> HWC2::Error::HasChanges;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> HWC2::Error::None;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-1-3-、display-intf-gt-Prepare-amp-layer-stack"><a href="#4-1-3-、display-intf-gt-Prepare-amp-layer-stack" class="headerlink" title="4.1.3 、display_intf_-&gt;Prepare(&amp;layer_stack_)"></a>4.1.3 、display_intf_-&gt;Prepare(&amp;layer_stack_)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">\android\hardware\qcom\display\sdm\libs\core\display_base.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">DisplayError <span class="title">DisplayBase::Prepare</span><span class="params">(LayerStack *layer_stack)</span> </span>&#123;</span><br><span class="line">  <span class="function">lock_guard&lt;recursive_mutex&gt; <span class="title">obj</span><span class="params">(recursive_mutex_)</span></span>;</span><br><span class="line">  DisplayError error = kErrorNone;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">  error = BuildLayerStackStats(layer_stack);</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;layer : layer_stack-&gt;layers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (layer-&gt;buffer_map == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      layer-&gt;buffer_map = <span class="built_in">std</span>::make_shared&lt;LayerBufferMap&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  error = HandleHDR(layer_stack);</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">if</span> (color_mgr_ &amp;&amp; color_mgr_-&gt;NeedsPartialUpdateDisable()) &#123;</span><br><span class="line">    DisablePartialUpdateOneFrame();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (partial_update_control_ == <span class="literal">false</span> || disable_pu_one_frame_) &#123;</span><br><span class="line">    comp_manager_-&gt;ControlPartialUpdate(display_comp_ctx_, <span class="literal">false</span> <span class="comment">/* enable */</span>);</span><br><span class="line">    disable_pu_one_frame_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  comp_manager_-&gt;PrePrepare(display_comp_ctx_, &amp;hw_layers_);</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    error = comp_manager_-&gt;Prepare(display_comp_ctx_, &amp;hw_layers_);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    error = hw_intf_-&gt;Validate(&amp;hw_layers_);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (error == kErrorShutDown) &#123;</span><br><span class="line">      comp_manager_-&gt;PostPrepare(display_comp_ctx_, &amp;hw_layers_);</span><br><span class="line">      <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  comp_manager_-&gt;PostPrepare(display_comp_ctx_, &amp;hw_layers_);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-1-4-、hw-intf-gt-Validate-amp-hw-layers"><a href="#4-1-4-、hw-intf-gt-Validate-amp-hw-layers" class="headerlink" title="4.1.4 、hw_intf_-&gt;Validate(&amp;hw_layers_)"></a>4.1.4 、hw_intf_-&gt;Validate(&amp;hw_layers_)</h5><p>调用HWDevice的Validate()，这正是log打印处来的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">\android\hardware\qcom\display\sdm\libs\core\fb\hw_device.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">DisplayError <span class="title">HWDevice::Validate</span><span class="params">(HWLayers *hw_layers)</span> </span>&#123;</span><br><span class="line">  DTRACE_SCOPED();</span><br><span class="line"></span><br><span class="line">  DisplayError error = kErrorNone;</span><br><span class="line"></span><br><span class="line">  HWLayersInfo &amp;hw_layer_info = hw_layers-&gt;info;</span><br><span class="line">  <span class="keyword">uint32_t</span> hw_layer_count = UINT32(hw_layer_info.hw_layers.size());</span><br><span class="line"></span><br><span class="line">  DLOGV_IF(kTagDriverConfig, <span class="string">&quot;************************** %s Validate Input ***********************&quot;</span>,</span><br><span class="line">           device_name_);</span><br><span class="line">  DLOGV_IF(kTagDriverConfig, <span class="string">&quot;SDE layer count is %d&quot;</span>, hw_layer_count);</span><br><span class="line"></span><br><span class="line">  mdp_layer_commit_v1 &amp;mdp_commit = mdp_disp_commit_.commit_v1;</span><br><span class="line">  <span class="keyword">uint32_t</span> &amp;mdp_layer_count = mdp_commit.input_layer_cnt;</span><br><span class="line"></span><br><span class="line">  DLOGI_IF(kTagDriverConfig, <span class="string">&quot;left_roi: x = %d, y = %d, w = %d, h = %d&quot;</span>, mdp_commit.left_roi.x,</span><br><span class="line">    mdp_commit.left_roi.y, mdp_commit.left_roi.w, mdp_commit.left_roi.h);</span><br><span class="line">  DLOGI_IF(kTagDriverConfig, <span class="string">&quot;right_roi: x = %d, y = %d, w = %d, h = %d&quot;</span>, mdp_commit.right_roi.x,</span><br><span class="line">    mdp_commit.right_roi.y, mdp_commit.right_roi.w, mdp_commit.right_roi.h);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; hw_layer_count; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> Layer &amp;layer = hw_layer_info.hw_layers.at(i);</span><br><span class="line">    LayerBuffer input_buffer = layer.input_buffer;</span><br><span class="line">    HWPipeInfo *left_pipe = &amp;hw_layers-&gt;config[i].left_pipe;</span><br><span class="line">    HWPipeInfo *right_pipe = &amp;hw_layers-&gt;config[i].right_pipe;</span><br><span class="line">    HWRotatorSession *hw_rotator_session = &amp;hw_layers-&gt;config[i].hw_rotator_session;</span><br><span class="line">    <span class="keyword">bool</span> is_rotator_used = (hw_rotator_session-&gt;hw_block_count != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">bool</span> is_cursor_pipe_used = (hw_layer_info.use_hw_cursor &amp; layer.flags.cursor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> count = <span class="number">0</span>; count &lt; <span class="number">2</span>; count++) &#123;</span><br><span class="line">      HWPipeInfo *pipe_info = (count == <span class="number">0</span>) ? left_pipe : right_pipe;</span><br><span class="line">      HWRotateInfo *hw_rotate_info = &amp;hw_rotator_session-&gt;hw_rotate_info[count];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hw_rotate_info-&gt;valid) &#123;</span><br><span class="line">        input_buffer = hw_rotator_session-&gt;output_buffer;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (pipe_info-&gt;valid) &#123;</span><br><span class="line">        mdp_input_layer &amp;mdp_layer = mdp_in_layers_[mdp_layer_count];</span><br><span class="line">        mdp_layer_buffer &amp;mdp_buffer = mdp_layer.buffer;</span><br><span class="line"></span><br><span class="line">        mdp_buffer.width = input_buffer.width;</span><br><span class="line">        mdp_buffer.height = input_buffer.height;</span><br><span class="line">        mdp_buffer.comp_ratio.denom = <span class="number">1000</span>;</span><br><span class="line">        mdp_buffer.comp_ratio.numer = UINT32(hw_layers-&gt;config[i].compression * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (layer.flags.solid_fill) &#123;</span><br><span class="line">          mdp_buffer.format = MDP_ARGB_8888;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          error = SetFormat(input_buffer.format, &amp;mdp_buffer.format);</span><br><span class="line">          <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">            <span class="keyword">return</span> error;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mdp_layer.alpha = layer.plane_alpha;</span><br><span class="line">        mdp_layer.z_order = UINT16(pipe_info-&gt;z_order);</span><br><span class="line">        mdp_layer.transp_mask = <span class="number">0xffffffff</span>;</span><br><span class="line">        SetBlending(layer.blending, &amp;mdp_layer.blend_op);</span><br><span class="line">        mdp_layer.pipe_ndx = pipe_info-&gt;pipe_id;</span><br><span class="line">        mdp_layer.horz_deci = pipe_info-&gt;horizontal_decimation;</span><br><span class="line">        mdp_layer.vert_deci = pipe_info-&gt;vertical_decimation;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MDP_COMMIT_RECT_NUM</span></span><br><span class="line">        mdp_layer.rect_num = pipe_info-&gt;rect;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        SetRect(pipe_info-&gt;src_roi, &amp;mdp_layer.src_rect);</span><br><span class="line">        SetRect(pipe_info-&gt;dst_roi, &amp;mdp_layer.dst_rect);</span><br><span class="line">        SetMDPFlags(&amp;layer, is_rotator_used, is_cursor_pipe_used, &amp;mdp_layer.flags);</span><br><span class="line">        SetCSC(layer.input_buffer.color_metadata, &amp;mdp_layer.color_space);</span><br><span class="line">        <span class="keyword">if</span> (pipe_info-&gt;flags &amp; kIGC) &#123;</span><br><span class="line">          SetIGC(&amp;layer.input_buffer, mdp_layer_count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pipe_info-&gt;flags &amp; kMultiRect) &#123;</span><br><span class="line">          mdp_layer.flags |= MDP_LAYER_MULTIRECT_ENABLE;</span><br><span class="line">          <span class="keyword">if</span> (pipe_info-&gt;flags &amp; kMultiRectParallelMode) &#123;</span><br><span class="line">            mdp_layer.flags |= MDP_LAYER_MULTIRECT_PARALLEL_MODE;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mdp_layer.bg_color = layer.solid_fill_color;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// HWScaleData to MDP driver</span></span><br><span class="line">        hw_scale_-&gt;SetHWScaleData(pipe_info-&gt;scale_data, mdp_layer_count, &amp;mdp_commit,</span><br><span class="line">                                  pipe_info-&gt;sub_block_type);</span><br><span class="line">        mdp_layer.scale = hw_scale_-&gt;GetScaleDataRef(mdp_layer_count, pipe_info-&gt;sub_block_type);</span><br><span class="line"></span><br><span class="line">        mdp_layer_count++;</span><br><span class="line"></span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;******************* Layer[%d] %s pipe Input ******************&quot;</span>,</span><br><span class="line">                 i, count ? <span class="string">&quot;Right&quot;</span> : <span class="string">&quot;Left&quot;</span>);</span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;in_w %d, in_h %d, in_f %d&quot;</span>, mdp_buffer.width, mdp_buffer.height,</span><br><span class="line">                 mdp_buffer.format);</span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;plane_alpha %d, zorder %d, blending %d, horz_deci %d, &quot;</span></span><br><span class="line">                 <span class="string">&quot;vert_deci %d, pipe_id = 0x%x, mdp_flags 0x%x&quot;</span>, mdp_layer.alpha, mdp_layer.z_order,</span><br><span class="line">                 mdp_layer.blend_op, mdp_layer.horz_deci, mdp_layer.vert_deci, mdp_layer.pipe_ndx,</span><br><span class="line">                 mdp_layer.flags);</span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;src_rect [%d, %d, %d, %d]&quot;</span>, mdp_layer.src_rect.x,</span><br><span class="line">                 mdp_layer.src_rect.y, mdp_layer.src_rect.w, mdp_layer.src_rect.h);</span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;dst_rect [%d, %d, %d, %d]&quot;</span>, mdp_layer.dst_rect.x,</span><br><span class="line">                 mdp_layer.dst_rect.y, mdp_layer.dst_rect.w, mdp_layer.dst_rect.h);</span><br><span class="line">        hw_scale_-&gt;DumpScaleData(mdp_layer.scale);</span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;*************************************************************&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(user): This block should move to the derived class</span></span><br><span class="line">  <span class="keyword">if</span> (device_type_ == kDeviceVirtual) &#123;</span><br><span class="line">    LayerBuffer *output_buffer = hw_layers-&gt;info.<span class="built_in">stack</span>-&gt;output_buffer;</span><br><span class="line">    mdp_out_layer_.writeback_ndx = hw_resource_.writeback_index;</span><br><span class="line">    mdp_out_layer_.buffer.width = output_buffer-&gt;width;</span><br><span class="line">    mdp_out_layer_.buffer.height = output_buffer-&gt;height;</span><br><span class="line">    <span class="keyword">if</span> (output_buffer-&gt;flags.secure) &#123;</span><br><span class="line">      mdp_out_layer_.flags |= MDP_LAYER_SECURE_SESSION;</span><br><span class="line">    &#125;</span><br><span class="line">    mdp_out_layer_.buffer.comp_ratio.denom = <span class="number">1000</span>;</span><br><span class="line">    mdp_out_layer_.buffer.comp_ratio.numer = UINT32(hw_layers-&gt;output_compression * <span class="number">1000</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OUT_LAYER_COLOR_SPACE</span></span><br><span class="line">    SetCSC(output_buffer-&gt;color_metadata, &amp;mdp_out_layer_.color_space);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    SetFormat(output_buffer-&gt;format, &amp;mdp_out_layer_.buffer.format);</span><br><span class="line"></span><br><span class="line">    DLOGI_IF(kTagDriverConfig, <span class="string">&quot;********************* Output buffer Info ************************&quot;</span>);</span><br><span class="line">    DLOGI_IF(kTagDriverConfig, <span class="string">&quot;out_w %d, out_h %d, out_f %d, wb_id %d&quot;</span>,</span><br><span class="line">             mdp_out_layer_.buffer.width, mdp_out_layer_.buffer.height,</span><br><span class="line">             mdp_out_layer_.buffer.format, mdp_out_layer_.writeback_ndx);</span><br><span class="line">    DLOGI_IF(kTagDriverConfig, <span class="string">&quot;*****************************************************************&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; hw_resource_.hw_dest_scalar_info.count; i++) &#123;</span><br><span class="line">    DestScaleInfoMap::iterator it = hw_layer_info.dest_scale_info_map.find(i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (it == hw_layer_info.dest_scale_info_map.end()) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HWDestScaleInfo *dest_scale_info = it-&gt;second;</span><br><span class="line"></span><br><span class="line">    mdp_destination_scaler_data *dest_scalar_data = &amp;mdp_dest_scalar_data_[index];</span><br><span class="line">    hw_scale_-&gt;SetHWScaleData(dest_scale_info-&gt;scale_data, index, &amp;mdp_commit,</span><br><span class="line">                              kHWDestinationScalar);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dest_scale_info-&gt;scale_update) &#123;</span><br><span class="line">      dest_scalar_data-&gt;flags |= MDP_DESTSCALER_SCALE_UPDATE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dest_scalar_data-&gt;dest_scaler_ndx = i;</span><br><span class="line">    dest_scalar_data-&gt;lm_width = dest_scale_info-&gt;mixer_width;</span><br><span class="line">    dest_scalar_data-&gt;lm_height = dest_scale_info-&gt;mixer_height;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MDP_DESTSCALER_ROI_ENABLE</span></span><br><span class="line">    SetRect(dest_scale_info-&gt;panel_roi, &amp;dest_scalar_data-&gt;panel_roi);</span><br><span class="line">    dest_scalar_data-&gt;flags |= MDP_DESTSCALER_ROI_ENABLE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    dest_scalar_data-&gt;scale = <span class="keyword">reinterpret_cast</span> &lt;<span class="keyword">uint64_t</span>&gt;</span><br><span class="line">      (hw_scale_-&gt;GetScaleDataRef(index, kHWDestinationScalar));</span><br><span class="line"></span><br><span class="line">    index++;</span><br><span class="line"></span><br><span class="line">    DLOGV_IF(kTagDriverConfig, <span class="string">&quot;************************ DestScalar[%d] **************************&quot;</span>,</span><br><span class="line">             dest_scalar_data-&gt;dest_scaler_ndx);</span><br><span class="line">    DLOGV_IF(kTagDriverConfig, <span class="string">&quot;Mixer WxH %dx%d flags %x&quot;</span>, dest_scalar_data-&gt;lm_width,</span><br><span class="line">             dest_scalar_data-&gt;lm_height, dest_scalar_data-&gt;flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MDP_DESTSCALER_ROI_ENABLE</span></span><br><span class="line">    DLOGV_IF(kTagDriverConfig, <span class="string">&quot;Panel ROI [%d, %d, %d, %d]&quot;</span>, dest_scalar_data-&gt;panel_roi.x,</span><br><span class="line">             dest_scalar_data-&gt;panel_roi.y, dest_scalar_data-&gt;panel_roi.w,</span><br><span class="line">             dest_scalar_data-&gt;panel_roi.h);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    DLOGV_IF(kTagDriverConfig, <span class="string">&quot;*****************************************************************&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  mdp_commit.dest_scaler_cnt = UINT32(hw_layer_info.dest_scale_info_map.size());</span><br><span class="line"></span><br><span class="line">  mdp_commit.flags |= MDP_VALIDATE_LAYER;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MDP_COMMIT_RECT_NUM</span></span><br><span class="line">  mdp_commit.flags |= MDP_COMMIT_RECT_NUM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (Sys::ioctl_(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ESHUTDOWN) &#123;</span><br><span class="line">      DLOGI_IF(kTagDriverConfig, <span class="string">&quot;Driver is processing shutdown sequence&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> kErrorShutDown;</span><br><span class="line">    &#125;</span><br><span class="line">    IOCTL_LOGE(MSMFB_ATOMIC_COMMIT, device_type_);</span><br><span class="line">    DumpLayerCommit(mdp_disp_commit_);</span><br><span class="line">    <span class="keyword">return</span> kErrorHardware;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> kErrorNone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="4-2-0-、HWCDisplayPrimary-Present"><a href="#4-2-0-、HWCDisplayPrimary-Present" class="headerlink" title="4.2.0 、HWCDisplayPrimary::Present"></a>4.2.0 、HWCDisplayPrimary::Present</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">android/hardware/qcom/display/sdm/libs/hwc2/hwc_display_primary.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">HWC2::Error <span class="title">HWCDisplayPrimary::Present</span><span class="params">(<span class="keyword">int32_t</span> *out_retire_fence)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> status = HWC2::Error::None;</span><br><span class="line">  <span class="keyword">if</span> (display_paused_) &#123;</span><br><span class="line">    <span class="comment">// TODO(user): From old HWC implementation</span></span><br><span class="line">    <span class="comment">// If we do not handle the frame set retireFenceFd to outbufAcquireFenceFd</span></span><br><span class="line">    <span class="comment">// Revisit this when validating display_paused</span></span><br><span class="line">    DisplayError error = display_intf_-&gt;Flush();</span><br><span class="line">    <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">      DLOGE(<span class="string">&quot;Flush failed. Error = %d&quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    status = HWCDisplay::CommitLayerStack();</span><br><span class="line">    <span class="keyword">if</span> (status == HWC2::Error::None) &#123;</span><br><span class="line">      HandleFrameOutput();</span><br><span class="line">      SolidFillCommit();</span><br><span class="line">      status = HWCDisplay::PostCommitLayerStack(out_retire_fence);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  CloseAcquireFds();</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接着看看HWCDisplay::CommitLayerStack()函数。</p>
<h5 id="4-2-1-、HWCDisplay-CommitLayerStack"><a href="#4-2-1-、HWCDisplay-CommitLayerStack" class="headerlink" title="4.2.1 、HWCDisplay::CommitLayerStack()"></a>4.2.1 、HWCDisplay::CommitLayerStack()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">\android\hardware\qcom\display\sdm\libs\hwc2\hwc_display.cpp</span><br><span class="line"><span class="function">WC2::Error <span class="title">HWCDisplay::CommitLayerStack</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!validated_) &#123;</span><br><span class="line">    DLOGW(<span class="string">&quot;Display is not validated&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> HWC2::Error::NotValidated;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shutdown_pending_ || layer_set_.empty()) &#123;</span><br><span class="line">    <span class="keyword">return</span> HWC2::Error::None;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DumpInputBuffers();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_) &#123;</span><br><span class="line">    DisplayError error = kErrorUndefined;</span><br><span class="line">    error = display_intf_-&gt;Commit(&amp;layer_stack_);</span><br><span class="line">    validated_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error == kErrorNone) &#123;</span><br><span class="line">      <span class="comment">// A commit is successfully submitted, start flushing on failure now onwards.</span></span><br><span class="line">      flush_on_error_ = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (error == kErrorShutDown) &#123;</span><br><span class="line">        shutdown_pending_ = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> HWC2::Error::Unsupported;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error != kErrorPermission) &#123;</span><br><span class="line">        DLOGE(<span class="string">&quot;Commit failed. Error = %d&quot;</span>, error);</span><br><span class="line">        <span class="comment">// To prevent surfaceflinger infinite wait, flush the previous frame during Commit()</span></span><br><span class="line">        <span class="comment">// so that previous buffer and fences are released, and override the error.</span></span><br><span class="line">        flush_ = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> HWC2::Error::None;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接着看看display_intf_-&gt;Commit(&amp;layer_stack_) 函数。</p>
<h5 id="4-2-2-、HWCDisplay-CommitLayerStack"><a href="#4-2-2-、HWCDisplay-CommitLayerStack" class="headerlink" title="4.2.2 、HWCDisplay::CommitLayerStack()"></a>4.2.2 、HWCDisplay::CommitLayerStack()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">\android\hardware\qcom\display\sdm\libs\core\display_base.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">DisplayError <span class="title">DisplayBase::Commit</span><span class="params">(LayerStack *layer_stack)</span> </span>&#123;</span><br><span class="line">  <span class="function">lock_guard&lt;recursive_mutex&gt; <span class="title">obj</span><span class="params">(recursive_mutex_)</span></span>;</span><br><span class="line">  DisplayError error = kErrorNone;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!active_) &#123;</span><br><span class="line">    pending_commit_ = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> kErrorPermission;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!layer_stack) &#123;</span><br><span class="line">    <span class="keyword">return</span> kErrorParameters;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!pending_commit_) &#123;</span><br><span class="line">    DLOGE(<span class="string">&quot;Commit: Corresponding Prepare() is not called for display = %d&quot;</span>, display_type_);</span><br><span class="line">    <span class="keyword">return</span> kErrorUndefined;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pending_commit_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Layer stack attributes has changed, need to Reconfigure, currently in use for Hybrid Comp</span></span><br><span class="line">  <span class="keyword">if</span> (layer_stack-&gt;flags.attributes_changed) &#123;</span><br><span class="line">    error = comp_manager_-&gt;ReConfigure(display_comp_ctx_, &amp;hw_layers_);</span><br><span class="line">    <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">      <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error = hw_intf_-&gt;Validate(&amp;hw_layers_);</span><br><span class="line">    <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  CommitLayerParams(layer_stack);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (comp_manager_-&gt;Commit(display_comp_ctx_, &amp;hw_layers_)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">      <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if feature list cache is dirty and pending.</span></span><br><span class="line">  <span class="comment">// If dirty, need program to hardware blocks.</span></span><br><span class="line">  <span class="keyword">if</span> (color_mgr_)</span><br><span class="line">    error = color_mgr_-&gt;Commit();</span><br><span class="line">  <span class="keyword">if</span> (error != kErrorNone) &#123;  <span class="comment">// won&#x27;t affect this execution path.</span></span><br><span class="line">    DLOGW(<span class="string">&quot;ColorManager::Commit(...) isn&#x27;t working&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error = hw_intf_-&gt;Commit(&amp;hw_layers_);</span><br><span class="line">  <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PostCommitLayerParams(layer_stack);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (partial_update_control_) &#123;</span><br><span class="line">    comp_manager_-&gt;ControlPartialUpdate(display_comp_ctx_, <span class="literal">true</span> <span class="comment">/* enable */</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error = comp_manager_-&gt;PostCommit(display_comp_ctx_, &amp;hw_layers_);</span><br><span class="line">  <span class="keyword">if</span> (error != kErrorNone) &#123;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> kErrorNone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-2-3-、hw-intf-gt-Commit-amp-hw-layers"><a href="#4-2-3-、hw-intf-gt-Commit-amp-hw-layers" class="headerlink" title="4.2.3 、hw_intf_-&gt;Commit(&amp;hw_layers_)"></a>4.2.3 、hw_intf_-&gt;Commit(&amp;hw_layers_)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">\android\hardware\qcom\display\sdm\libs\core\fb\hw_device.cpp</span><br><span class="line"><span class="function">DisplayError <span class="title">HWDevice::Commit</span><span class="params">(HWLayers *hw_layers)</span> </span>&#123;</span><br><span class="line">  DTRACE_SCOPED();</span><br><span class="line"></span><br><span class="line">  HWLayersInfo &amp;hw_layer_info = hw_layers-&gt;info;</span><br><span class="line">  <span class="keyword">uint32_t</span> hw_layer_count = UINT32(hw_layer_info.hw_layers.size());</span><br><span class="line"></span><br><span class="line">  DLOGV_IF(kTagDriverConfig, <span class="string">&quot;*************************** %s Commit Input ************************&quot;</span>,</span><br><span class="line">           device_name_);</span><br><span class="line">  DLOGV_IF(kTagDriverConfig, <span class="string">&quot;SDE layer count is %d&quot;</span>, hw_layer_count);</span><br><span class="line"></span><br><span class="line">  mdp_layer_commit_v1 &amp;mdp_commit = mdp_disp_commit_.commit_v1;</span><br><span class="line">  <span class="keyword">uint32_t</span> mdp_layer_index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; hw_layer_count; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> Layer &amp;layer = hw_layer_info.hw_layers.at(i);</span><br><span class="line">    LayerBuffer *input_buffer = <span class="keyword">const_cast</span>&lt;LayerBuffer *&gt;(&amp;layer.input_buffer);</span><br><span class="line">    HWPipeInfo *left_pipe = &amp;hw_layers-&gt;config[i].left_pipe;</span><br><span class="line">    HWPipeInfo *right_pipe = &amp;hw_layers-&gt;config[i].right_pipe;</span><br><span class="line">    HWRotatorSession *hw_rotator_session = &amp;hw_layers-&gt;config[i].hw_rotator_session;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> count = <span class="number">0</span>; count &lt; <span class="number">2</span>; count++) &#123;</span><br><span class="line">      HWPipeInfo *pipe_info = (count == <span class="number">0</span>) ? left_pipe : right_pipe;</span><br><span class="line">      HWRotateInfo *hw_rotate_info = &amp;hw_rotator_session-&gt;hw_rotate_info[count];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hw_rotate_info-&gt;valid) &#123;</span><br><span class="line">        input_buffer = &amp;hw_rotator_session-&gt;output_buffer;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (pipe_info-&gt;valid) &#123;</span><br><span class="line">        mdp_layer_buffer &amp;mdp_buffer = mdp_in_layers_[mdp_layer_index].buffer;</span><br><span class="line">        mdp_input_layer &amp;mdp_layer = mdp_in_layers_[mdp_layer_index];</span><br><span class="line">        <span class="keyword">if</span> (input_buffer-&gt;planes[<span class="number">0</span>].fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          mdp_buffer.plane_count = <span class="number">1</span>;</span><br><span class="line">          mdp_buffer.planes[<span class="number">0</span>].fd = input_buffer-&gt;planes[<span class="number">0</span>].fd;</span><br><span class="line">          mdp_buffer.planes[<span class="number">0</span>].offset = input_buffer-&gt;planes[<span class="number">0</span>].offset;</span><br><span class="line">          SetStride(device_type_, input_buffer-&gt;format, input_buffer-&gt;planes[<span class="number">0</span>].stride,</span><br><span class="line">                    &amp;mdp_buffer.planes[<span class="number">0</span>].stride);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          mdp_buffer.plane_count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mdp_buffer.fence = input_buffer-&gt;acquire_fence_fd;</span><br><span class="line">        mdp_layer_index++;</span><br><span class="line"></span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;****************** Layer[%d] %s pipe Input *******************&quot;</span>,</span><br><span class="line">                 i, count ? <span class="string">&quot;Right&quot;</span> : <span class="string">&quot;Left&quot;</span>);</span><br><span class="line">        DLOGI_IF(kTagDriverConfig, <span class="string">&quot;in_w %d, in_h %d, in_f %d, horz_deci %d, vert_deci %d&quot;</span>,</span><br><span class="line">                 mdp_buffer.width, mdp_buffer.height, mdp_buffer.format, mdp_layer.horz_deci,</span><br><span class="line">                 mdp_layer.vert_deci);</span><br><span class="line">        DLOGI_IF(kTagDriverConfig, <span class="string">&quot;in_buf_fd %d, in_buf_offset %d, in_buf_stride %d, &quot;</span> \</span><br><span class="line">                 <span class="string">&quot;in_plane_count %d, in_fence %d, layer count %d&quot;</span>, mdp_buffer.planes[<span class="number">0</span>].fd,</span><br><span class="line">                 mdp_buffer.planes[<span class="number">0</span>].offset, mdp_buffer.planes[<span class="number">0</span>].stride, mdp_buffer.plane_count,</span><br><span class="line">                 mdp_buffer.fence, mdp_commit.input_layer_cnt);</span><br><span class="line">        DLOGV_IF(kTagDriverConfig, <span class="string">&quot;*************************************************************&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO(user): Move to derived class</span></span><br><span class="line">  <span class="keyword">if</span> (device_type_ == kDeviceVirtual) &#123;</span><br><span class="line">    LayerBuffer *output_buffer = hw_layers-&gt;info.<span class="built_in">stack</span>-&gt;output_buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (output_buffer-&gt;planes[<span class="number">0</span>].fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      mdp_out_layer_.buffer.planes[<span class="number">0</span>].fd = output_buffer-&gt;planes[<span class="number">0</span>].fd;</span><br><span class="line">      mdp_out_layer_.buffer.planes[<span class="number">0</span>].offset = output_buffer-&gt;planes[<span class="number">0</span>].offset;</span><br><span class="line">      SetStride(device_type_, output_buffer-&gt;format, output_buffer-&gt;planes[<span class="number">0</span>].stride,</span><br><span class="line">                &amp;mdp_out_layer_.buffer.planes[<span class="number">0</span>].stride);</span><br><span class="line">      mdp_out_layer_.buffer.plane_count = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      DLOGE(<span class="string">&quot;Invalid output buffer fd&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> kErrorParameters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdp_out_layer_.buffer.fence = output_buffer-&gt;acquire_fence_fd;</span><br><span class="line"></span><br><span class="line">    DLOGI_IF(kTagDriverConfig, <span class="string">&quot;********************** Output buffer Info ***********************&quot;</span>);</span><br><span class="line">    DLOGI_IF(kTagDriverConfig, <span class="string">&quot;out_fd %d, out_offset %d, out_stride %d, acquire_fence %d&quot;</span>,</span><br><span class="line">             mdp_out_layer_.buffer.planes[<span class="number">0</span>].fd, mdp_out_layer_.buffer.planes[<span class="number">0</span>].offset,</span><br><span class="line">             mdp_out_layer_.buffer.planes[<span class="number">0</span>].stride,  mdp_out_layer_.buffer.fence);</span><br><span class="line">    DLOGI_IF(kTagDriverConfig, <span class="string">&quot;*****************************************************************&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mdp_commit.release_fence = <span class="number">-1</span>;</span><br><span class="line">  mdp_commit.flags &amp;= UINT32(~MDP_VALIDATE_LAYER);</span><br><span class="line">  <span class="keyword">if</span> (synchronous_commit_) &#123;</span><br><span class="line">    mdp_commit.flags |= MDP_COMMIT_WAIT_FOR_FINISH;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (bl_update_commit &amp;&amp; bl_level_update_commit &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MDP_COMMIT_UPDATE_BRIGHTNESS</span></span><br><span class="line">    mdp_commit.bl_level = (<span class="keyword">uint32_t</span>)bl_level_update_commit;</span><br><span class="line">    mdp_commit.flags |= MDP_COMMIT_UPDATE_BRIGHTNESS;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Sys::ioctl_(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ESHUTDOWN) &#123;</span><br><span class="line">      DLOGI_IF(kTagDriverConfig, <span class="string">&quot;Driver is processing shutdown sequence&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> kErrorShutDown;</span><br><span class="line">    &#125;</span><br><span class="line">    IOCTL_LOGE(MSMFB_ATOMIC_COMMIT, device_type_);</span><br><span class="line">    DumpLayerCommit(mdp_disp_commit_);</span><br><span class="line">    synchronous_commit_ = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> kErrorHardware;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  LayerStack *<span class="built_in">stack</span> = hw_layer_info.<span class="built_in">stack</span>;</span><br><span class="line">  <span class="built_in">stack</span>-&gt;retire_fence_fd = mdp_commit.retire_fence;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VIDEO_MODE_DEFER_RETIRE_FENCE</span></span><br><span class="line">  <span class="keyword">if</span> (hw_panel_info_.mode == kModeVideo) &#123;</span><br><span class="line">    <span class="built_in">stack</span>-&gt;retire_fence_fd = stored_retire_fence;</span><br><span class="line">    stored_retire_fence =  mdp_commit.retire_fence;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">// MDP returns only one release fence for the entire layer stack. Duplicate this fence into all</span></span><br><span class="line">  <span class="comment">// layers being composed by MDP.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; hw_layer_count; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> Layer &amp;layer = hw_layer_info.hw_layers.at(i);</span><br><span class="line">    LayerBuffer *input_buffer = <span class="keyword">const_cast</span>&lt;LayerBuffer *&gt;(&amp;layer.input_buffer);</span><br><span class="line">    HWRotatorSession *hw_rotator_session = &amp;hw_layers-&gt;config[i].hw_rotator_session;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hw_rotator_session-&gt;hw_block_count) &#123;</span><br><span class="line">      input_buffer = &amp;hw_rotator_session-&gt;output_buffer;</span><br><span class="line">      input_buffer-&gt;release_fence_fd = Sys::dup_(mdp_commit.release_fence);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    input_buffer-&gt;release_fence_fd = Sys::dup_(mdp_commit.release_fence);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hw_layer_info.sync_handle = Sys::dup_(mdp_commit.release_fence);</span><br><span class="line"></span><br><span class="line">  DLOGI_IF(kTagDriverConfig, <span class="string">&quot;*************************** %s Commit Input ************************&quot;</span>,</span><br><span class="line">           device_name_);</span><br><span class="line">  DLOGI_IF(kTagDriverConfig, <span class="string">&quot;retire_fence_fd %d&quot;</span>, <span class="built_in">stack</span>-&gt;retire_fence_fd);</span><br><span class="line">  DLOGI_IF(kTagDriverConfig, <span class="string">&quot;*******************************************************************&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mdp_commit.release_fence &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    Sys::close_(mdp_commit.release_fence);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (synchronous_commit_) &#123;</span><br><span class="line">    <span class="comment">// A synchronous commit can be requested when changing the display mode so we need to update</span></span><br><span class="line">    <span class="comment">// panel info.</span></span><br><span class="line">    PopulateHWPanelInfo();</span><br><span class="line">    synchronous_commit_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bl_update_commit)</span><br><span class="line">    bl_update_commit = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> kErrorNone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到log跟SDM打印出来的Log一致，说明分析大体无问题。<br>此时已经通过ioctl将图像数据传到Kernel驱动了，也就是上一篇分析的内容。<br><a href="">Android P Graphics System（二）：Qualcomm MDSS - MDP、DSI、FrameBuffer分析</a></p>
<h4 id="（五）、Sys-ioctl-device-fd-INT-MSMFB-ATOMIC-COMMIT-amp-mdp-disp-commit"><a href="#（五）、Sys-ioctl-device-fd-INT-MSMFB-ATOMIC-COMMIT-amp-mdp-disp-commit" class="headerlink" title="（五）、Sys::ioctl_(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_)"></a>（五）、<strong>Sys::ioctl_(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_)</strong></h4><p>Sys::ioctl_是Qualcomm 对原生ioctl做的一层封装，本质就是ioctl。我们来看看device_fd_是啥冬冬，从Init()函数来看。<br>device_fd_就是通过Sys::open_(“/dev/graphics/fb0”, O_RDWR);得到的，是不是比较熟悉，此处就与驱动连接起来了。<br><a href="">Android P Graphics System（一）：Android Graphics精彩世界</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">android\hardware\qcom\display\sdm\libs\core\fb\hw_device.cpp</span><br><span class="line"></span><br><span class="line"><span class="function">DisplayError <span class="title">HWDevice::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Read the fb node index</span></span><br><span class="line">  fb_node_index_ = GetFBNodeIndex(device_type_);</span><br><span class="line">  <span class="keyword">if</span> (fb_node_index_ == <span class="number">-1</span>) &#123;</span><br><span class="line">    DLOGE(<span class="string">&quot;device type = %d should be present&quot;</span>, device_type_);</span><br><span class="line">    <span class="keyword">return</span> kErrorHardware;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *dev_name = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; dev_paths = &#123;<span class="string">&quot;/dev/graphics/fb&quot;</span>, <span class="string">&quot;/dev/fb&quot;</span>&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; dev_paths.size(); i++) &#123;</span><br><span class="line">    dev_paths[i] += to_string(fb_node_index_);</span><br><span class="line">    <span class="keyword">if</span> (Sys::access_(dev_paths[i].c_str(), F_OK) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      dev_name = dev_paths[i].c_str();</span><br><span class="line">      DLOGI(<span class="string">&quot;access(%s) successful&quot;</span>, dev_name);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DLOGI(<span class="string">&quot;access(%s), errno = %d, error = %s&quot;</span>, dev_paths[i].c_str(), errno, strerror(errno));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dev_name) &#123;</span><br><span class="line">    DLOGE(<span class="string">&quot;access() failed for all possible paths&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> kErrorHardware;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Populate Panel Info (Used for Partial Update)</span></span><br><span class="line">  PopulateHWPanelInfo();</span><br><span class="line">  <span class="comment">// Populate HW Capabilities</span></span><br><span class="line">  hw_resource_ = HWResourceInfo();</span><br><span class="line">  hw_info_intf_-&gt;GetHWResourceInfo(&amp;hw_resource_);</span><br><span class="line"></span><br><span class="line">  device_fd_ = Sys::open_(dev_name, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (device_fd_ &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    DLOGE(<span class="string">&quot;open %s failed errno = %d, error = %s&quot;</span>, dev_name, errno, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> kErrorResources;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> HWScale::Create(&amp;hw_scale_, hw_resource_.has_qseed3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="（六）、Hardware-Composer-Sync-Fences"><a href="#（六）、Hardware-Composer-Sync-Fences" class="headerlink" title="（六）、Hardware Composer Sync Fences"></a>（六）、Hardware Composer Sync Fences</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HWC_1.x_sync_fences.png" alt="Alt text | center"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/Android.PG3.HWC_2.x_sync_fences.png" alt="Alt text | center"></p>
<p> Sync Fences暂不分析，以后有时间再做分析。</p>
<h4 id="（七）、参考资料-特别感谢-："><a href="#（七）、参考资料-特别感谢-：" class="headerlink" title="（七）、参考资料(特别感谢)："></a>（七）、参考资料(特别感谢)：</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/824a9ddf68b9">（1）【Android P 图形显示系统（一）硬件合成HWC2】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yangwen123/article/details/79854267">（2）【AndroidO Treble架构下Hal进程启动及HIDL服务注册过程】</a><br><a target="_blank" rel="noopener" href="http://charlesvincent.cc/2018/09/28/Android%20O%20Treble%20%E6%9E%B6%E6%9E%84%20-%20HIDL%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">（3）【Android O Treble 架构 - HIDL源代码分析】</a><br> <a target="_blank" rel="noopener" href="https://blog.csdn.net/yangwen123/article/details/79868548">（4）【AndroidO Treble架构下HIDL IComposer服务查询过程】</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20190708/">https://zhoujinjian.com/posts/20190708/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.38.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20190716/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.39.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android P Graphics System（四）：Native Surface创建 &amp;&amp; SurfaceFlinger合成流程分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/20190608/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.37.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android P Graphics System（二）：Qualcomm MDSS - MDP、DSI、FrameBuffer分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81HWC2%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">（一）、HWC2介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-0-%E3%80%81HWC2%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.0 、HWC2概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-0-%E3%80%81HWC%E5%B8%B8%E8%A7%84%E5%87%86%E5%88%99"><span class="toc-number">1.2.</span> <span class="toc-text">1.2.0 、HWC常规准则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-0-%E3%80%81HWC2-%E6%A1%86%E6%9E%B6"><span class="toc-number">1.3.</span> <span class="toc-text">1.3.0 、HWC2 框架</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81HWC2%E5%90%88%E6%88%90%E6%9C%8D%E5%8A%A1-Composer-Service-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">（二）、HWC2合成服务(Composer Service)启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-0-%E3%80%81Composer-Hal%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.0 、Composer Hal启动过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-0-%E3%80%81Hal%E8%BF%9B%E7%A8%8B%E8%8E%B7%E5%8F%96IComposer%E7%B1%BB%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.0 、Hal进程获取IComposer类对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-0-%E3%80%81registerPassthroughClient"><span class="toc-number">2.3.</span> <span class="toc-text">2.3.0 、registerPassthroughClient</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-0-%E3%80%81registerAsService%E6%B3%A8%E5%86%8C"><span class="toc-number">2.4.</span> <span class="toc-text">2.4.0 、registerAsService注册</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-0-%E3%80%81IComposer%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">2.5.</span> <span class="toc-text">2.5.0 、IComposer服务注册</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-6-0-%E3%80%81IComposer%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.6.</span> <span class="toc-text">2.6.0 、IComposer服务查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81SurfaceFlinger-%E4%B8%8E-HWC2-%E9%80%9A%E4%BF%A1"><span class="toc-number">3.</span> <span class="toc-text">（三）、SurfaceFlinger 与 HWC2 通信</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-0-%E3%80%81SurfaceFlinger-%E4%B8%8E-HWC2-%E9%80%9A%E4%BF%A1%E6%A1%86%E6%9E%B6%E5%9B%BE"><span class="toc-number">3.1.</span> <span class="toc-text">3.1.0 、SurfaceFlinger 与 HWC2 通信框架图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-%E3%80%81SurfaceFlinger-%E5%90%88%E6%88%90%E5%9B%BE%E5%B1%82"><span class="toc-number">3.2.</span> <span class="toc-text">3.1.1 、SurfaceFlinger 合成图层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-0-%E3%80%81SurfaceFlinger-%E4%B8%8E-HWC2-%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">3.2.0 、SurfaceFlinger 与 HWC2 通信流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E3%80%81HWC2-%E5%A4%84%E7%90%86-HWC-Layers"><span class="toc-number">4.</span> <span class="toc-text">（四）、HWC2 处理 HWC Layers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-0-%E3%80%81HWCDisplayPrimary-Validate"><span class="toc-number">5.</span> <span class="toc-text">4.1.0 、HWCDisplayPrimary::Validate</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1-%E3%80%81HWCDisplay-BuildLayerStack"><span class="toc-number">5.1.</span> <span class="toc-text">4.1.1 、HWCDisplay::BuildLayerStack()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2-%E3%80%81HWCDisplay-PrepareLayerStack"><span class="toc-number">5.2.</span> <span class="toc-text">4.1.2 、HWCDisplay::PrepareLayerStack()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3-%E3%80%81display-intf-gt-Prepare-amp-layer-stack"><span class="toc-number">5.3.</span> <span class="toc-text">4.1.3 、display_intf_-&gt;Prepare(&amp;layer_stack_)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-4-%E3%80%81hw-intf-gt-Validate-amp-hw-layers"><span class="toc-number">5.4.</span> <span class="toc-text">4.1.4 、hw_intf_-&gt;Validate(&amp;hw_layers_)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-0-%E3%80%81HWCDisplayPrimary-Present"><span class="toc-number">6.</span> <span class="toc-text">4.2.0 、HWCDisplayPrimary::Present</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-%E3%80%81HWCDisplay-CommitLayerStack"><span class="toc-number">6.1.</span> <span class="toc-text">4.2.1 、HWCDisplay::CommitLayerStack()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-%E3%80%81HWCDisplay-CommitLayerStack"><span class="toc-number">6.2.</span> <span class="toc-text">4.2.2 、HWCDisplay::CommitLayerStack()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-%E3%80%81hw-intf-gt-Commit-amp-hw-layers"><span class="toc-number">6.3.</span> <span class="toc-text">4.2.3 、hw_intf_-&gt;Commit(&amp;hw_layers_)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E3%80%81Sys-ioctl-device-fd-INT-MSMFB-ATOMIC-COMMIT-amp-mdp-disp-commit"><span class="toc-number">7.</span> <span class="toc-text">（五）、Sys::ioctl_(device_fd_, INT(MSMFB_ATOMIC_COMMIT), &amp;mdp_disp_commit_)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%85%AD%EF%BC%89%E3%80%81Hardware-Composer-Sync-Fences"><span class="toc-number">8.</span> <span class="toc-text">（六）、Hardware Composer Sync Fences</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%83%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2-%EF%BC%9A"><span class="toc-number">9.</span> <span class="toc-text">（七）、参考资料(特别感谢)：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>