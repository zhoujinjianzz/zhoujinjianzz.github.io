<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 8.1 Display System源码分析（3）：U-boot Display 显示过程源码分析（RK3399） | zhoujinjian</title><meta name="keywords" content="Android,Linux,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（ ©Android @Linux @Rockchip版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡω">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 8.1 Display System源码分析（3）：U-boot Display 显示过程源码分析（RK3399）">
<meta property="og:url" content="https://zhoujinjian.com/posts/20200619/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（ ©Android @Linux @Rockchip版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡω">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00012.jpg">
<meta property="article:published_time" content="2020-06-19T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.944Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00012.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20200619/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00012.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 8.1 Display System源码分析（3）：U-boot Display 显示过程源码分析（RK3399）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-06-19T01:25:00.000Z" title="发表于 2020-06-19 09:25:00">2020-06-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.944Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Display/">Display</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。<strong>文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕）</strong>，转载请注明出处（ ©Android @Linux @Rockchip版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。<br>（==<strong>文章基于 Kernel-4.4</strong>==）&amp;&amp;（==<strong>文章基于 Android-8.1</strong>==）<br><a target="_blank" rel="noopener" href="http://wiki.t-firefly.com/zh_CN/Firefly-RK3399/compile_android8.1_firmware.html#">【开发板 - Firefly-RK3399 7.85寸1024x768显示屏模组（MIPI接口）】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/kris_fei/article/details/79003925">（1）【[RK3399][Android7.1] Uboot display 加载过程小结】</a> </p>
<p><a target="_blank" rel="noopener" href="https://docs.khadas.com/zh-cn/edge/ConnectLcd.html#3-%EF%BC%88MIPI-HDMI%EF%BC%89%E5%B1%8F%E5%B9%95%E9%85%8D%E7%BD%AE">（2）【Connect to TS050 Touchscreen】</a> </p>
<p><a target="_blank" rel="noopener" href="http://wiki.t-firefly.com/zh_CN/Firefly-RK3399/driver_lcd.html">（3）【Firefly-RK3399 LCD使用】</a> </p>
<p><a target="_blank" rel="noopener" href="https://hceng.cn/2018/07/19/RK3288%E2%80%94%E2%80%94LCD%E8%A3%B8%E6%9C%BA/">（4）【RK3288——LCD裸机】</a> </p>
<hr>
<p>==源码（部分）==</p>
<blockquote>
<p>U-boot</p>
</blockquote>
<ul>
<li>I:\RK3399_Android8.1_MIPI\u-boot\drivers\video*</li>
<li>I:\RK3399_Android8.1_MIPI\u-boot\drivers\video\drm*</li>
<li>I:\RK3399_Android8.1_MIPI\u-boot\arch\arm\lib\board.c</li>
</ul>
<hr>
<p>显示模块主要分 vop, dsi, panel三大模块，另加gpio, 背光的控制，另外还有logo的解析和加载。整个流程基本上就是解析各个模块参数，然后准备，使能各个模块。<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/firefly-rk3399-mipi-dsi-framwork.jpg"></p>
<h4 id="一-、MIPI屏幕配置"><a href="#一-、MIPI屏幕配置" class="headerlink" title="(一)、MIPI屏幕配置"></a>(一)、MIPI屏幕配置</h4><h4 id="（1）、LCD使用"><a href="#（1）、LCD使用" class="headerlink" title="（1）、LCD使用"></a>（1）、LCD使用</h4><p>Firefly-RK3399开发板外置了两个LCD屏接口，一个是EDP，一个是MIPI，接口对应板子上的位置如下图，我们这里是mipi：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/firefly-rk3399-lcd-edp-mipi.jpg"></p>
<h5 id="1-1、Config配置"><a href="#1-1、Config配置" class="headerlink" title="1.1、Config配置"></a>1.1、Config配置</h5><p>以Android8.1配置MIPI屏为例，Firefly-RK3399默认的配置文件kernel/arch/arm64/configs/firefly_defconfig已经把LCD相关的配置设置好了，如果自己做了修改，请注意把以下配置加上：</p>
<blockquote>
<p>CONFIG_LCD_MIPI=y<br>CONFIG_MIPI_DSI=y<br>CONFIG_RK32_MIPI_DSI=y</p>
</blockquote>
<h5 id="1-2、DTS配置"><a href="#1-2、DTS配置" class="headerlink" title="1.2、DTS配置"></a>1.2、DTS配置</h5><p>以rk3399-firefly-mipi.dt为例介绍：MIPI</p>
<h6 id="1-2-1、使能对应显示设备节点"><a href="#1-2-1、使能对应显示设备节点" class="headerlink" title="1.2.1、使能对应显示设备节点"></a>1.2.1、使能对应显示设备节点</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;dsi &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-2、绑定-VOP"><a href="#1-2-2、绑定-VOP" class="headerlink" title="1.2.2、绑定 VOP"></a>1.2.2、绑定 VOP</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;dsi_in_vopl &#123;</span><br><span class="line">    status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;dsi_in_vopb &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;hdmi &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;hdmi_in_vopb &#123;</span><br><span class="line">    status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&amp;hdmi_in_vopl &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;cdn_dp &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    extcon = &lt;&amp;fusb0&gt;;</span><br><span class="line">    phys = &lt;&amp;tcphy0_dp&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;dp_in_vopb &#123;</span><br><span class="line">    status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="1-2-3、开机-logo"><a href="#1-2-3、开机-logo" class="headerlink" title="1.2.3、开机 logo"></a>1.2.3、开机 logo</h6><p>如果 uboot logo 未开启，那 kernel 阶段也无法显示开机 logo，只能等到 android 启动后才能看到显示。在 dts 里面将对应的 route 使能即可打开 uboot logo 支持，比如打开 hdmi 的uboot logo 显示:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;route_hdmi &#123;</span><br><span class="line">    status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">    logo,mode = <span class="string">&quot;center&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&amp;route_dsi &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    logo,mode = <span class="string">&quot;center&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h6 id="1-2-4、绑定-PLL"><a href="#1-2-4、绑定-PLL" class="headerlink" title="1.2.4、绑定 PLL"></a>1.2.4、绑定 PLL</h6><p>rk3399 的 hdmi 所绑定的 vop 时钟需要挂载到 vpll 上，若是双显需将另一个 vop 时钟挂到cpll 这样可以分出任意 dclk 的频率。如当 hdmi 绑定到 vopb 时配置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;vopb &#123;</span><br><span class="line">    assigned-clocks = &lt;&amp;cru DCLK_VOP0_DIV&gt;;</span><br><span class="line">    assigned-clock-parents = &lt;&amp;cru PLL_CPLL&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;vopl &#123;</span><br><span class="line">    assigned-clocks = &lt;&amp;cru DCLK_VOP1_DIV&gt;;</span><br><span class="line">    assigned-clock-parents = &lt;&amp;cru PLL_VPLL&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="1-2-5、打开音频"><a href="#1-2-5、打开音频" class="headerlink" title="1.2.5、打开音频"></a>1.2.5、打开音频</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;hdmi_sound &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="1-2-6、配置Panel-amp-amp-timing"><a href="#1-2-6、配置Panel-amp-amp-timing" class="headerlink" title="1.2.6、配置Panel &amp;&amp; timing"></a>1.2.6、配置Panel &amp;&amp; timing</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;dsi &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    dsi_panel: panel &#123;</span><br><span class="line">        compatible =<span class="string">&quot;simple-panel-dsi&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        <span class="comment">//ddc-i2c-bu</span></span><br><span class="line">        <span class="comment">//power-supply = &lt;&amp;vcc_lcd&gt;;</span></span><br><span class="line">        <span class="comment">//pinctrl-0 = &lt;&amp;lcd_panel_reset &amp;lcd_panel_enable&gt;;</span></span><br><span class="line">        backlight = &lt;&amp;backlight&gt;;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        enable-gpios = &lt;&amp;gpio1 1 GPIO_ACTIVE_HIGH&gt;;</span></span><br><span class="line"><span class="comment">        reset-gpios = &lt;&amp;gpio4 29 GPIO_ACTIVE_HIGH&gt;;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        dsi,flags = &lt;(MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_BURST <span class="comment">/*| MIPI_DSI_MODE_VIDEO_SYNC_PULSE*/</span>)&gt;;</span><br><span class="line">        dsi,format = &lt;MIPI_DSI_FMT_RGB888&gt;;</span><br><span class="line">        bus-format = &lt;MEDIA_BUS_FMT_RGB666_1X18&gt;;</span><br><span class="line">        dsi,lanes = &lt;<span class="number">4</span>&gt;;</span><br><span class="line"></span><br><span class="line">        dsi,channel = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"></span><br><span class="line">        enable-delay-ms = &lt;<span class="number">35</span>&gt;;</span><br><span class="line">        prepare-delay-ms = &lt;<span class="number">6</span>&gt;;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        delay,power = &lt;10&gt;;</span></span><br><span class="line"><span class="comment">        delay,reset = &lt;250&gt;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        delay,unreset = &lt;0&gt;;</span></span><br><span class="line"><span class="comment">        delay,unpower = &lt;0&gt;;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        unprepare-delay-ms = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        disable-delay-ms = &lt;<span class="number">20</span>&gt;;</span><br><span class="line">        </span><br><span class="line">        size,width = &lt;<span class="number">120</span>&gt;;</span><br><span class="line">        size,height = &lt;<span class="number">170</span>&gt;;</span><br><span class="line"></span><br><span class="line">        status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">        panel-init-sequence = [</span><br><span class="line">            <span class="number">05</span> <span class="number">20</span> <span class="number">01</span> <span class="number">29</span></span><br><span class="line">            <span class="number">05</span> <span class="number">96</span> <span class="number">01</span> <span class="number">11</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        panel-<span class="built_in">exit</span>-sequence = [</span><br><span class="line">            <span class="number">05</span> <span class="number">05</span> <span class="number">01</span> <span class="number">28</span></span><br><span class="line">            <span class="number">05</span> <span class="number">78</span> <span class="number">01</span> <span class="number">10</span></span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        power_ctr: power_ctr &#123;</span><br><span class="line">               rockchip,debug = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">               lcd_en: lcd-en &#123;</span><br><span class="line">                       gpios = &lt;&amp;gpio1 <span class="number">1</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">                       pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">                       pinctrl<span class="number">-0</span> = &lt;&amp;lcd_panel_enable&gt;;</span><br><span class="line">                       rockchip,delay = &lt;<span class="number">10</span>&gt;;</span><br><span class="line">               &#125;;</span><br><span class="line">               lcd_rst: lcd-rst &#123;</span><br><span class="line">                       gpios = &lt;&amp;gpio4 <span class="number">29</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">                       pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">                       pinctrl<span class="number">-0</span> = &lt;&amp;lcd_panel_reset&gt;;</span><br><span class="line">                       rockchip,delay = &lt;<span class="number">6</span>&gt;;</span><br><span class="line">               &#125;;</span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line">        disp_timings: display-timings &#123;</span><br><span class="line">                          native-mode = &lt;&amp;timing0&gt;;</span><br><span class="line">                          timing0: timing0 &#123;</span><br><span class="line">                                       clock-frequency = &lt;<span class="number">80000000</span>&gt;;</span><br><span class="line">                                       hactive = &lt;<span class="number">768</span>&gt;;</span><br><span class="line">                                       vactive = &lt;<span class="number">1024</span>&gt;;</span><br><span class="line">                                       hsync-len = &lt;<span class="number">20</span>&gt;;   <span class="comment">//20, 50</span></span><br><span class="line">                                       hback-porch = &lt;<span class="number">130</span>&gt;; <span class="comment">//50, 56</span></span><br><span class="line">                                       hfront-porch = &lt;<span class="number">150</span>&gt;;<span class="comment">//50, 30</span></span><br><span class="line">                                       vsync-len = &lt;<span class="number">40</span>&gt;;</span><br><span class="line">                                       vback-porch = &lt;<span class="number">130</span>&gt;;</span><br><span class="line">                                       vfront-porch = &lt;<span class="number">136</span>&gt;;</span><br><span class="line">                                       hsync-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                                       vsync-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                                       de-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                                       pixelclk-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                                   &#125;;</span><br><span class="line">                      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里定义了LCD的电源控制引脚：</p>
<blockquote>
<p>lcd_en:(GPIO1_A1)GPIO_ACTIVE_HIGH</p>
<p>lcd_en:(GPIO4_D5)GPIO_ACTIVE_HIGH</p>
</blockquote>
<p>都是高电平有效。</p>
<p>Firefly-RK3399硬件文档原理图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/firefly-rk3399-sch-mipi-tx.jpg"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/firefly-rk3399-sch-u1e.jpg"></p>
<p>LCD的时序参数（timing），一般在屏的datasheet都可以找到，时序属性参考下图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/firefly-rk3399-mipi-timing.jpg"></p>
<p>属性说明图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/firefly-rk3399-dts-property.jpg"></p>
<h6 id="1-2-7、MIPI-DPHY"><a href="#1-2-7、MIPI-DPHY" class="headerlink" title="1.2.7、MIPI-DPHY"></a>1.2.7、MIPI-DPHY</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;mipi_dphy &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Note：rk3288/rk3399没有该节点，不需要配置。</p>
<h6 id="1-2-8、Command"><a href="#1-2-8、Command" class="headerlink" title="1.2.8、Command"></a>1.2.8、Command</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">        panel-init-sequence = [</span><br><span class="line">            <span class="number">05</span> <span class="number">20</span> <span class="number">01</span> <span class="number">29</span></span><br><span class="line">            <span class="number">05</span> <span class="number">96</span> <span class="number">01</span> <span class="number">11</span></span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        panel-<span class="built_in">exit</span>-sequence = [</span><br><span class="line">            <span class="number">05</span> <span class="number">05</span> <span class="number">01</span> <span class="number">28</span></span><br><span class="line">            <span class="number">05</span> <span class="number">78</span> <span class="number">01</span> <span class="number">10</span></span><br><span class="line">        ];</span><br></pre></td></tr></table></figure>
<p>说明：前3个字节（16进制），分别代表DataType，Delay，Payload Length。</p>
<p>从第四个字节开始的数据代表长度为Length的实际有效Payload。</p>
<p>panel-init-sequence 一条命令的解析如下：</p>
<p>Data Type：0x05(DCS Long Write)</p>
<p>Delay：0x20(32s)</p>
<p>Payload Length：0x01 (1 Bytes)</p>
<p>Payload：029</p>
<p>panel-init-sequence 后一条命令的解析如下：</p>
<p>Data Type：0x05(DCS Long Write)</p>
<p>Delay：0x96(150s)</p>
<p>Payload Length：0x01 (1 Bytes)</p>
<p>Payload：11</p>
<p>第一个字节代表的命令类型分两大类：DCS 命令和 Generic 命令。DCS 命令是有 mipi 标准协议里面指定的命令，具体可以参考《MIPI Alliance Specification for Display CommandSet.pdf 》。Generic 命令一般应用于厂商自定义的命令。具体使用哪种类型需要参考屏规格书或者咨询屏厂 FAE。如果没有特别指定，建议按 DCS 命令类型配置。DCS 命 令 的 类 型 有 三 种 ： 0x05/0x15/0x39 。 Generic 命 令 的 类 型 分 为 ：0x03/0x13/0x23/0x29。</p>
<h6 id="1-2-9、背光-backlight"><a href="#1-2-9、背光-backlight" class="headerlink" title="1.2.9、背光 backlight"></a>1.2.9、背光 backlight</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\kernel\arch\arm64\boot\dts\rockchip\rk3399-firefly-mipi.dts</span><br><span class="line"></span><br><span class="line">&amp;backlight &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    pwms = &lt;&amp;pwm1 <span class="number">0</span> <span class="number">25000</span> <span class="number">0</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;pwm1 &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;dsi &#123;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    dsi_panel: panel &#123;</span><br><span class="line">        compatible =<span class="string">&quot;simple-panel-dsi&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        backlight = &lt;&amp;backlight&gt;;</span><br></pre></td></tr></table></figure>

<p>pwms属性：配置PWM，MIPI屏使用的pwm输出是pwm1，25000ns是周期(40 KHz)。</p>
<h4 id="二-、U-boot-Display-显示过程分析"><a href="#二-、U-boot-Display-显示过程分析" class="headerlink" title="(二)、U-boot Display 显示过程分析"></a>(二)、U-boot Display 显示过程分析</h4><p>首先看看全部Log：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display board/rockchip/common/rkboot/fastboot.c board_fbt_preboot <span class="number">474</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]normal boot.</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]Rockchip UBOOT DRM driver version: develop-v1<span class="number">.0</span><span class="number">.0</span></span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c init_display_buffer <span class="number">55</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display memory_start = <span class="number">2109734912</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display memory_end = <span class="number">2109734912</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_crtc.c rockchip_get_crtc <span class="number">73</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display compatible namerockchip,rk3399-vop-big  </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_connector.c rockchip_get_connector <span class="number">120</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display compatible namerockchip,rk3399-mipi-dsi  </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c connector_phy_init <span class="number">188</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]failed to find phy node</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c connector_panel_init <span class="number">230</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_panel.c rockchip_get_panel <span class="number">142</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display rockchip_get_panel simple-panel-dsi</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_panel.c rockchip_panel_init <span class="number">161</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_init <span class="number">321</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_parse_dt <span class="number">255</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_parse_cmds <span class="number">77</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_parse_cmds <span class="number">77</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/backlight/pwm_bl.c rk_pwm_bl_config <span class="number">197</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display rk_pwm_bl_config: <span class="number">0</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display board/rockchip/common/rkboot/fastboot.c board_fbt_preboot <span class="number">529</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]read logo on state from dts [<span class="number">1</span>]</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]no fuel gauge found</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c load_bmp_logo <span class="number">952</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display bmp_name logo.bmp </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c display_logo <span class="number">814</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c display_init <span class="number">630</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_mipi_dsi_init <span class="number">1204</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dsi_dual_channel_probe <span class="number">1151</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]Using display timing dts</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display Detailed mode clock <span class="number">80000</span> kHz, flags[a]</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]    H: <span class="number">0768</span> <span class="number">0918</span> <span class="number">0938</span> <span class="number">1068</span></span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]    V: <span class="number">1024</span> <span class="number">1160</span> <span class="number">1200</span> <span class="number">1330</span></span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]bus_format: <span class="number">1009</span></span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]rk lcdc - <span class="number">0</span> dclk <span class="built_in">set</span>: dclk = <span class="number">80000000</span>HZ, pll select = <span class="number">1</span>, div = <span class="number">1</span></span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c display_logo <span class="number">867</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c display_set_plane <span class="number">705</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c display_init <span class="number">630</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c display_enable <span class="number">727</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c connector_panel_power_prepare <span class="number">292</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_mipi_dsi_prepare <span class="number">1358</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_dsi_pre_init <span class="number">1268</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]<span class="keyword">final</span> DSI-Link bandwidth: <span class="number">532</span> Mbps x <span class="number">4</span></span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_dsi_host_init <span class="number">1293</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_init <span class="number">995</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_dpi_config <span class="number">1011</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_video_mode_config <span class="number">940</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_video_packet_config <span class="number">1051</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_video_mode_config <span class="number">940</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_dsi_controller_init <span class="number">1342</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c mipi_dphy_init <span class="number">1318</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_phy_init <span class="number">540</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]failed to wait <span class="keyword">for</span> phy clk lane stop state</span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_set_mode <span class="number">962</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display DSI_COMMAND_MODE </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_panel.c rockchip_panel_prepare <span class="number">187</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_prepare <span class="number">182</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_send_cmds <span class="number">147</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_mipi_dsi_transfer <span class="number">911</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_short_write <span class="number">784</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_mipi_dsi_transfer <span class="number">911</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_short_write <span class="number">784</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c rockchip_dw_mipi_dsi_enable <span class="number">1377</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_set_mode <span class="number">968</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display DSI_VIDEO_MODE </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip-dw-mipi-dsi.c dw_mipi_dsi_video_mode_config <span class="number">940</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_panel.c rockchip_panel_enable <span class="number">213</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_dsi_panel.c rockchip_dsi_panel_enable <span class="number">226</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/backlight/pwm_bl.c rk_pwm_bl_config <span class="number">197</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display rk_pwm_bl_config: <span class="number">-1</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display drivers/video/rockchip_display.c load_bmp_logo <span class="number">952</span> </span><br><span class="line">[<span class="number">09</span>:<span class="number">50</span>:<span class="number">13</span>]zjj.sye.display bmp_name logo_kernel.bmp </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="（2）、U-boot-Display-显示过程流程图"><a href="#（2）、U-boot-Display-显示过程流程图" class="headerlink" title="（2）、U-boot Display 显示过程流程图"></a>（2）、U-boot Display 显示过程流程图</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/zjj.sys.display.8.1.uboot/FireFly-Rk3399-Uboot-Display-Flow.jpg"></p>
<h4 id="（三）、vop-dsi-panel三大模块init分析"><a href="#（三）、vop-dsi-panel三大模块init分析" class="headerlink" title="（三）、vop, dsi, panel三大模块init分析"></a>（三）、vop, dsi, panel三大模块init分析</h4><h4 id="3-1、panel模块init分析"><a href="#3-1、panel模块init分析" class="headerlink" title="3.1、panel模块init分析"></a>3.1、panel模块init分析</h4><h5 id="3-1-1、rockchip-display-init"><a href="#3-1-1、rockchip-display-init" class="headerlink" title="3.1.1、rockchip_display_init()"></a>3.1.1、rockchip_display_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rockchip_display_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *blob = gd-&gt;fdt_blob;</span><br><span class="line">    <span class="keyword">int</span> route, child, phandle, connect, crtc_node, conn_node;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *<span class="title">conn</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> *<span class="title">crtc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">display_state</span> *<span class="title">s</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Rockchip UBOOT DRM driver version: %s\n&quot;</span>, DRIVER_VERSION);</span><br><span class="line"></span><br><span class="line">    route = fdt_path_offset(blob, <span class="string">&quot;/display-subsystem/route&quot;</span>);</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取fb地址</span></span><br><span class="line">    init_display_buffer();</span><br><span class="line"></span><br><span class="line">    fdt_for_each_subnode(blob, child, route) &#123;</span><br><span class="line">        ......</span><br><span class="line">        phandle = fdt_getprop_u32_default_node(blob, child, <span class="number">0</span>,</span><br><span class="line">                               <span class="string">&quot;connect&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//获取connect node.</span></span><br><span class="line">        connect = fdt_node_offset_by_phandle(blob, phandle);</span><br><span class="line">        ......</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//获取对应的crtc_node.</span></span><br><span class="line">        crtc_node = find_crtc_node(blob, connect);</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">      <span class="comment">//根据crtc_node从g_crtc数组中找到具体的元素，这里compatible是&quot;rockchip,rk3399-vop-big&quot;，在rk3399-firefly-mipi.dts中定义</span></span><br><span class="line">        crtc = rockchip_get_crtc(blob, crtc_node);</span><br><span class="line">        ......</span><br><span class="line">      </span><br><span class="line">       <span class="comment">//获取对应的connector node</span></span><br><span class="line">        conn_node = find_connector_node(blob, connect);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">       <span class="comment">//根据connector node从g_connector数组中找到具体的元素，这里compatible是&quot;rockchip,rk3399-mipi&quot;，在rk3399-firefly-mipi.dts中定义</span></span><br><span class="line">        conn = rockchip_get_connector(blob, conn_node);</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//display相关信息都放在struct display_state *s中</span></span><br><span class="line">        s = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*s));</span><br><span class="line">        ......</span><br><span class="line">        <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(*s));</span><br><span class="line"></span><br><span class="line">        INIT_LIST_HEAD(&amp;s-&gt;head);</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//分别获取uboot/kernel中的logo name以及模式</span></span><br><span class="line">        fdt_get_string(blob, child, <span class="string">&quot;logo,uboot&quot;</span>, &amp;s-&gt;ulogo_name);</span><br><span class="line">        fdt_get_string(blob, child, <span class="string">&quot;logo,kernel&quot;</span>, &amp;s-&gt;klogo_name);</span><br><span class="line">        fdt_get_string(blob, child, <span class="string">&quot;logo,mode&quot;</span>, &amp;name);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;fullscreen&quot;</span>))</span><br><span class="line">            s-&gt;logo_mode = ROCKCHIP_DISPLAY_FULLSCREEN;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            s-&gt;logo_mode = ROCKCHIP_DISPLAY_CENTER;</span><br><span class="line">        fdt_get_string(blob, child, <span class="string">&quot;charge_logo,mode&quot;</span>, &amp;name);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;fullscreen&quot;</span>))</span><br><span class="line">            s-&gt;charge_logo_mode = ROCKCHIP_DISPLAY_FULLSCREEN;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            s-&gt;charge_logo_mode = ROCKCHIP_DISPLAY_CENTER;</span><br><span class="line"></span><br><span class="line">        s-&gt;blob = blob;</span><br><span class="line">        s-&gt;conn_state.node = conn_node;</span><br><span class="line">        s-&gt;conn_state.connector = conn;</span><br><span class="line">        s-&gt;conn_state.overscan.left_margin = <span class="number">100</span>;</span><br><span class="line">        s-&gt;conn_state.overscan.right_margin = <span class="number">100</span>;</span><br><span class="line">        s-&gt;conn_state.overscan.top_margin = <span class="number">100</span>;</span><br><span class="line">        s-&gt;conn_state.overscan.bottom_margin = <span class="number">100</span>;</span><br><span class="line">        s-&gt;crtc_state.node = crtc_node;</span><br><span class="line">        s-&gt;crtc_state.crtc = crtc;</span><br><span class="line">        s-&gt;crtc_state.crtc_id = get_crtc_id(blob, connect);</span><br><span class="line">        s-&gt;node = child;</span><br><span class="line">      </span><br><span class="line">       <span class="comment">//无phy node</span></span><br><span class="line">        connector_phy_init(s);</span><br><span class="line">        connector_panel_init(s);</span><br><span class="line">        list_add_tail(&amp;s-&gt;head, &amp;rockchip_display_list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-1-2、rockchip-get-crtc"><a href="#3-1-2、rockchip-get-crtc" class="headerlink" title="3.1.2、rockchip_get_crtc()"></a>3.1.2、rockchip_get_crtc()</h5><p>此函数主要获取crtc(即VOP)寄存器相关信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_crtc.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> *</span></span><br><span class="line"><span class="class"><span class="title">rockchip_get_crtc</span>(<span class="title">const</span> <span class="title">void</span> *<span class="title">blob</span>, <span class="title">int</span> <span class="title">crtc_node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    fdt_get_string(blob, crtc_node, <span class="string">&quot;compatible&quot;</span>, &amp;name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display compatible name%s  \n&quot;</span>, name);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(g_crtc); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, g_crtc[i].compatible))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= ARRAY_SIZE(g_crtc))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;g_crtc[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们这里compatible name是：</p>
<blockquote>
<p>compatible name rockchip,rk3399-vop-big<br>所以具体的寄存器信息是：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_crtc.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> <span class="title">g_crtc</span>[] = &#123;</span></span><br><span class="line">    ......</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        .compatible = <span class="string">&quot;rockchip,rk3399-vop-big&quot;</span>,</span><br><span class="line">        .funcs = &amp;rockchip_vop_funcs,</span><br><span class="line">        .data = &amp;rk3399_vop_big,</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>此处VOP的操作函数是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_vop.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc_funcs</span> <span class="title">rockchip_vop_funcs</span> = &#123;</span></span><br><span class="line">    .init = rockchip_vop_init,</span><br><span class="line">    .set_plane = rockchip_vop_set_plane,</span><br><span class="line">    .prepare = rockchip_vop_prepare,</span><br><span class="line">    .enable = rockchip_vop_enable,</span><br><span class="line">    .disable = rockchip_vop_disable,</span><br><span class="line">    .fixup_dts = rockchip_vop_fixup_dts,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VOP寄存器信息是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_crtc.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> <span class="title">rk3399_vop_big</span> = &#123;</span></span><br><span class="line">    .version = VOP_VERSION(<span class="number">3</span>, <span class="number">5</span>),</span><br><span class="line">    .max_output = &#123;<span class="number">4096</span>, <span class="number">2160</span>&#125;,</span><br><span class="line">    .feature = VOP_FEATURE_OUTPUT_10BIT,</span><br><span class="line">    .ctrl = &amp;rk3288_ctrl_data,</span><br><span class="line">    .win = &amp;rk3288_win01_data,</span><br><span class="line">    .line_flag = &amp;rk3366_vop_line_flag,</span><br><span class="line">    .reg_len = RK3399_DSP_VACT_ST_END_F1 * <span class="number">4</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_ctrl</span> <span class="title">rk3288_ctrl_data</span> = &#123;</span></span><br><span class="line">    .standby = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">22</span>),</span><br><span class="line">    .axi_outstanding_max_num = VOP_REG(RK3288_SYS_CTRL1, <span class="number">0x1f</span>, <span class="number">13</span>),</span><br><span class="line">    .axi_max_outstanding_en = VOP_REG(RK3288_SYS_CTRL1, <span class="number">0x1</span>, <span class="number">12</span>),</span><br><span class="line">    .reg_done_frm = VOP_REG_VER(RK3288_SYS_CTRL1, <span class="number">0x1</span>, <span class="number">24</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">-1</span>),</span><br><span class="line">    .htotal_pw = VOP_REG(RK3288_DSP_HTOTAL_HS_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .hact_st_end = VOP_REG(RK3288_DSP_HACT_ST_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .vtotal_pw = VOP_REG(RK3288_DSP_VTOTAL_VS_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .vact_st_end = VOP_REG(RK3288_DSP_VACT_ST_END, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .vact_st_end_f1 = VOP_REG(RK3288_DSP_VACT_ST_END_F1, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .vs_st_end_f1 = VOP_REG(RK3288_DSP_VS_ST_END_F1, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .hpost_st_end = VOP_REG(RK3288_POST_DSP_HACT_INFO, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .vpost_st_end = VOP_REG(RK3288_POST_DSP_VACT_INFO, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .vpost_st_end_f1 = VOP_REG(RK3288_POST_DSP_VACT_INFO_F1, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .post_scl_factor = VOP_REG(RK3288_POST_SCL_FACTOR_YRGB, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">    .post_scl_ctrl = VOP_REG(RK3288_POST_SCL_CTRL, <span class="number">0x3</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    .dsp_interlace = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">10</span>),</span><br><span class="line">    .auto_gate_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">23</span>),</span><br><span class="line">    .dsp_layer_sel = VOP_REG(RK3288_DSP_CTRL1, <span class="number">0xff</span>, <span class="number">8</span>),</span><br><span class="line">    .post_lb_mode = VOP_REG_VER(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">18</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .global_regdone_en = VOP_REG_VER(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .overlay_mode = VOP_REG_VER(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .core_dclk_div = VOP_REG_VER(RK3399_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">-1</span>),</span><br><span class="line">    .p2i_en = VOP_REG_VER(RK3399_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">-1</span>),</span><br><span class="line">    .dclk_ddr = VOP_REG_VER(RK3399_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">-1</span>),</span><br><span class="line">    .dp_en = VOP_REG(RK3399_SYS_CTRL, <span class="number">0x1</span>, <span class="number">11</span>),</span><br><span class="line">    .rgb_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">12</span>),</span><br><span class="line">    .hdmi_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">13</span>),</span><br><span class="line">    .edp_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">14</span>),</span><br><span class="line">    .mipi_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">15</span>),</span><br><span class="line">    .mipi_dual_channel_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">3</span>),</span><br><span class="line">    .data01_swap = VOP_REG_VER(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">17</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">-1</span>),</span><br><span class="line">    .pin_pol = VOP_REG_VER(RK3288_DSP_CTRL0, <span class="number">0xf</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    .dp_pin_pol = VOP_REG_VER(RK3368_DSP_CTRL1, <span class="number">0xf</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .rgb_pin_pol = VOP_REG_VER(RK3368_DSP_CTRL1, <span class="number">0xf</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .tve_dclk_en = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">24</span>),</span><br><span class="line">    .tve_dclk_pol = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">25</span>),</span><br><span class="line">    .tve_sw_mode = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">26</span>),</span><br><span class="line">    .sw_uv_offset_en  = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">27</span>),</span><br><span class="line">    .sw_genlock   = VOP_REG(RK3288_SYS_CTRL, <span class="number">0x1</span>, <span class="number">28</span>),</span><br><span class="line">    .hdmi_pin_pol = VOP_REG_VER(RK3368_DSP_CTRL1, <span class="number">0xf</span>, <span class="number">20</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .edp_pin_pol = VOP_REG_VER(RK3368_DSP_CTRL1, <span class="number">0xf</span>, <span class="number">24</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .mipi_pin_pol = VOP_REG_VER(RK3368_DSP_CTRL1, <span class="number">0xf</span>, <span class="number">28</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line"></span><br><span class="line">    .dither_down = VOP_REG(RK3288_DSP_CTRL1, <span class="number">0xf</span>, <span class="number">1</span>),</span><br><span class="line">    .dither_up = VOP_REG(RK3288_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">6</span>),</span><br><span class="line"></span><br><span class="line">    .dsp_out_yuv = VOP_REG_VER(RK3399_POST_SCL_CTRL, <span class="number">0x1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">-1</span>),</span><br><span class="line">    .dsp_data_swap = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0x1f</span>, <span class="number">12</span>),</span><br><span class="line">    .dsp_ccir656_avg = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">20</span>),</span><br><span class="line">    .dsp_blank = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0x3</span>, <span class="number">18</span>),</span><br><span class="line">    .dsp_lut_en = VOP_REG(RK3288_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">    .update_gamma_lut = VOP_REG_VER(RK3288_DSP_CTRL1, <span class="number">0x1</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">-1</span>),</span><br><span class="line">    .out_mode = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0xf</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    .bcsh_brightness = VOP_REG(RK3288_BCSH_BCS, <span class="number">0xff</span>, <span class="number">0</span>),</span><br><span class="line">    .bcsh_contrast = VOP_REG(RK3288_BCSH_BCS, <span class="number">0x1ff</span>, <span class="number">8</span>),</span><br><span class="line">    .bcsh_sat_con = VOP_REG(RK3288_BCSH_BCS, <span class="number">0x3ff</span>, <span class="number">20</span>),</span><br><span class="line">    .bcsh_out_mode = VOP_REG(RK3288_BCSH_BCS, <span class="number">0x3</span>, <span class="number">0</span>),</span><br><span class="line">    .bcsh_sin_hue = VOP_REG(RK3288_BCSH_H, <span class="number">0x1ff</span>, <span class="number">0</span>),</span><br><span class="line">    .bcsh_cos_hue = VOP_REG(RK3288_BCSH_H, <span class="number">0x1ff</span>, <span class="number">16</span>),</span><br><span class="line">    .bcsh_r2y_csc_mode = VOP_REG_VER(RK3368_BCSH_CTRL, <span class="number">0x1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">-1</span>),</span><br><span class="line">    .bcsh_r2y_en = VOP_REG_VER(RK3368_BCSH_CTRL, <span class="number">0x1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">-1</span>),</span><br><span class="line">    .bcsh_y2r_csc_mode = VOP_REG_VER(RK3368_BCSH_CTRL, <span class="number">0x3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">-1</span>),</span><br><span class="line">    .bcsh_y2r_en = VOP_REG_VER(RK3368_BCSH_CTRL, <span class="number">0x1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">-1</span>),</span><br><span class="line">    .bcsh_color_bar = VOP_REG(RK3288_BCSH_COLOR_BAR, <span class="number">0xffffff</span>, <span class="number">8</span>),</span><br><span class="line">    .bcsh_en = VOP_REG(RK3288_BCSH_COLOR_BAR, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    .xmirror = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">22</span>),</span><br><span class="line">    .ymirror = VOP_REG(RK3288_DSP_CTRL0, <span class="number">0x1</span>, <span class="number">23</span>),</span><br><span class="line"></span><br><span class="line">    .dsp_background = VOP_REG(RK3288_DSP_BG, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    .cfg_done = VOP_REG(RK3288_REG_CFG_DONE, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">    .win_gate[<span class="number">0</span>] = VOP_REG(RK3288_WIN2_CTRL0, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">    .win_gate[<span class="number">1</span>] = VOP_REG(RK3288_WIN3_CTRL0, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_win</span> <span class="title">rk3288_win01_data</span> = &#123;</span></span><br><span class="line">    .scl = &amp;rk3288_win_full_scl,</span><br><span class="line">    .enable = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">0</span>),</span><br><span class="line">    .format = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x7</span>, <span class="number">1</span>),</span><br><span class="line">    .rb_swap = VOP_REG(RK3288_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">12</span>),</span><br><span class="line">    .ymirror = VOP_REG_VER(RK3368_WIN0_CTRL0, <span class="number">0x1</span>, <span class="number">22</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">-1</span>),</span><br><span class="line">    .act_info = VOP_REG(RK3288_WIN0_ACT_INFO, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .dsp_info = VOP_REG(RK3288_WIN0_DSP_INFO, <span class="number">0x0fff0fff</span>, <span class="number">0</span>),</span><br><span class="line">    .dsp_st = VOP_REG(RK3288_WIN0_DSP_ST, <span class="number">0x1fff1fff</span>, <span class="number">0</span>),</span><br><span class="line">    .yrgb_mst = VOP_REG(RK3288_WIN0_YRGB_MST, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">    .uv_mst = VOP_REG(RK3288_WIN0_CBR_MST, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">    .yrgb_vir = VOP_REG(RK3288_WIN0_VIR, <span class="number">0x3fff</span>, <span class="number">0</span>),</span><br><span class="line">    .uv_vir = VOP_REG(RK3288_WIN0_VIR, <span class="number">0x3fff</span>, <span class="number">16</span>),</span><br><span class="line">    .src_alpha_ctl = VOP_REG(RK3288_WIN0_SRC_ALPHA_CTRL, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">    .dst_alpha_ctl = VOP_REG(RK3288_WIN0_DST_ALPHA_CTRL, <span class="number">0xffffffff</span>, <span class="number">0</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-3、rockchip-get-connector"><a href="#3-1-3、rockchip-get-connector" class="headerlink" title="3.1.3、rockchip_get_connector()"></a>3.1.3、rockchip_get_connector()</h5><blockquote>
<p>compatible name rockchip,rk3399-mipi-dsi  </p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_connector.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *</span></span><br><span class="line"><span class="class"><span class="title">rockchip_get_connector</span>(<span class="title">const</span> <span class="title">void</span> *<span class="title">blob</span>, <span class="title">int</span> <span class="title">connector_node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    fdt_get_string(blob, connector_node, <span class="string">&quot;compatible&quot;</span>, &amp;name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display compatible name%s  \n&quot;</span>, name);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(g_connector); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, g_connector[i].compatible))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= ARRAY_SIZE(g_connector))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;g_connector[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此处DSI的操作函数是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector_funcs</span> <span class="title">rockchip_dw_mipi_dsi_funcs</span> = &#123;</span></span><br><span class="line">    .init = rockchip_dw_mipi_dsi_init,</span><br><span class="line">    .deinit = rockchip_dw_mipi_dsi_deinit,</span><br><span class="line">    .prepare = rockchip_dw_mipi_dsi_prepare,</span><br><span class="line">    .enable = rockchip_dw_mipi_dsi_enable,</span><br><span class="line">    .disable = rockchip_dw_mipi_dsi_disable,</span><br><span class="line">    .transfer = rockchip_dw_mipi_dsi_transfer,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>DSI寄存器信息是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> u32 rk3399_dsi0_grf_reg_fields[MAX_FIELDS] = &#123;</span><br><span class="line">    [DPIUPDATECFG]        = GRF_REG_FIELD(<span class="number">0x6224</span>, <span class="number">15</span>, <span class="number">15</span>),</span><br><span class="line">    [DPISHUTDN]        = GRF_REG_FIELD(<span class="number">0x6224</span>, <span class="number">14</span>, <span class="number">14</span>),</span><br><span class="line">    [DPICOLORM]        = GRF_REG_FIELD(<span class="number">0x6224</span>, <span class="number">13</span>, <span class="number">13</span>),</span><br><span class="line">    [VOPSEL]        = GRF_REG_FIELD(<span class="number">0x6250</span>,  <span class="number">0</span>,  <span class="number">0</span>),</span><br><span class="line">    [TURNREQUEST]        = GRF_REG_FIELD(<span class="number">0x6258</span>, <span class="number">12</span>, <span class="number">15</span>),</span><br><span class="line">    [TURNDISABLE]        = GRF_REG_FIELD(<span class="number">0x6258</span>,  <span class="number">8</span>, <span class="number">11</span>),</span><br><span class="line">    [FORCETXSTOPMODE]    = GRF_REG_FIELD(<span class="number">0x6258</span>,  <span class="number">4</span>,  <span class="number">7</span>),</span><br><span class="line">    [FORCERXMODE]        = GRF_REG_FIELD(<span class="number">0x6258</span>,  <span class="number">0</span>,  <span class="number">3</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> u32 rk3399_dsi1_grf_reg_fields[MAX_FIELDS] = &#123;</span><br><span class="line">    [VOPSEL]        = GRF_REG_FIELD(<span class="number">0x6250</span>,  <span class="number">4</span>,  <span class="number">4</span>),</span><br><span class="line">    [DPIUPDATECFG]        = GRF_REG_FIELD(<span class="number">0x6250</span>,  <span class="number">3</span>,  <span class="number">3</span>),</span><br><span class="line">    [DPISHUTDN]        = GRF_REG_FIELD(<span class="number">0x6250</span>,  <span class="number">2</span>,  <span class="number">2</span>),</span><br><span class="line">    [DPICOLORM]        = GRF_REG_FIELD(<span class="number">0x6250</span>,  <span class="number">1</span>,  <span class="number">1</span>),</span><br><span class="line">    [TURNDISABLE]        = GRF_REG_FIELD(<span class="number">0x625c</span>, <span class="number">12</span>, <span class="number">15</span>),</span><br><span class="line">    [FORCETXSTOPMODE]    = GRF_REG_FIELD(<span class="number">0x625c</span>,  <span class="number">8</span>, <span class="number">11</span>),</span><br><span class="line">    [FORCERXMODE]        = GRF_REG_FIELD(<span class="number">0x625c</span>,  <span class="number">4</span>,  <span class="number">7</span>),</span><br><span class="line">    [ENABLE_N]        = GRF_REG_FIELD(<span class="number">0x625c</span>,  <span class="number">0</span>,  <span class="number">3</span>),</span><br><span class="line">    [MASTERSLAVEZ]        = GRF_REG_FIELD(<span class="number">0x6260</span>,  <span class="number">7</span>,  <span class="number">7</span>),</span><br><span class="line">    [ENABLECLK]        = GRF_REG_FIELD(<span class="number">0x6260</span>,  <span class="number">6</span>,  <span class="number">6</span>),</span><br><span class="line">    [BASEDIR]        = GRF_REG_FIELD(<span class="number">0x6260</span>,  <span class="number">5</span>,  <span class="number">5</span>),</span><br><span class="line">    [TURNREQUEST]        = GRF_REG_FIELD(<span class="number">0x6260</span>,  <span class="number">0</span>,  <span class="number">3</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dw_mipi_dsi_plat_data</span> <span class="title">rk3399_mipi_dsi_drv_data</span> = &#123;</span></span><br><span class="line">    .dsi0_grf_reg_fields = rk3399_dsi0_grf_reg_fields,</span><br><span class="line">    .dsi1_grf_reg_fields = rk3399_dsi1_grf_reg_fields,</span><br><span class="line">    .max_bit_rate_per_lane = <span class="number">1500000000U</span>L,</span><br><span class="line">    .soc_type = RK3399,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-1-4、connector-panel-init"><a href="#3-1-4、connector-panel-init" class="headerlink" title="3.1.4、connector_panel_init()"></a>3.1.4、connector_panel_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">connector_panel_init</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *blob = state-&gt;blob;</span><br><span class="line">    <span class="keyword">int</span> conn_node = conn_state-&gt;node;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_panel</span> *<span class="title">panel</span>;</span></span><br><span class="line">    <span class="keyword">int</span> panel_node, dsp_lut_node;</span><br><span class="line">    <span class="keyword">int</span> ret, len;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    DBG(<span class="string">&quot;zjj.sye.display enter\n&quot;</span>);</span><br><span class="line">    panel_node = get_panel_node(state, conn_node);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fdt_device_is_available(blob, panel_node)) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    panel_state-&gt;node = panel_node;</span><br><span class="line"></span><br><span class="line">    panel = rockchip_get_panel(blob, panel_node);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    connector_pclist_parse_dt(conn_state, blob, panel_node);</span><br><span class="line">    panel_state-&gt;panel = panel;</span><br><span class="line"></span><br><span class="line">    ret = rockchip_panel_init(state);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-1-5、rockchip-get-panel"><a href="#3-1-5、rockchip-get-panel" class="headerlink" title="3.1.5、rockchip_get_panel()"></a>3.1.5、rockchip_get_panel()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_panel.c</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_panel</span> <span class="title">g_panel</span>[] = &#123;</span></span><br><span class="line">      &#123;</span><br><span class="line">        .compatible = <span class="string">&quot;simple-panel-dsi&quot;</span>,</span><br><span class="line">        .funcs = &amp;rockchip_dsi_panel_funcs,</span><br><span class="line">      &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">const</span> struct rockchip_panel *<span class="title">rockchip_get_panel</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *blob, <span class="keyword">int</span> node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> i, ret, index = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        ret = fdt_get_string_index(blob, node, <span class="string">&quot;compatible&quot;</span>, index++, &amp;name);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display rockchip_get_panel %s\n&quot;</span>, name);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(g_panel); i++)</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, g_panel[i].compatible))</span><br><span class="line">                <span class="keyword">return</span> &amp;g_panel[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_dsi_panel.c</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_panel_funcs</span> <span class="title">rockchip_dsi_panel_funcs</span> = &#123;</span></span><br><span class="line">    .init        = rockchip_dsi_panel_init,</span><br><span class="line">    .deinit        = rockchip_dsi_panel_deinit,</span><br><span class="line">    .prepare    = rockchip_dsi_panel_prepare,</span><br><span class="line">    .unprepare    = rockchip_dsi_panel_unprepare,</span><br><span class="line">    .enable        = rockchip_dsi_panel_enable,</span><br><span class="line">    .disable    = rockchip_dsi_panel_disable,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-1-6、rockchip-panel-init"><a href="#3-1-6、rockchip-panel-init" class="headerlink" title="3.1.6、rockchip_panel_init()"></a>3.1.6、rockchip_panel_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_panel.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rockchip_panel_init</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_panel</span> *<span class="title">panel</span> = <span class="title">panel_state</span>-&gt;<span class="title">panel</span>;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="keyword">if</span> (!panel || !panel-&gt;funcs || !panel-&gt;funcs-&gt;init) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s: failed to find panel init funcs\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> panel-&gt;funcs-&gt;init(state);</span><br><span class="line">&#125;</span><br><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_dsi_panel.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dsi_panel_init</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *blob = state-&gt;blob;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="keyword">int</span> node = panel_state-&gt;node;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_dsi_panel</span> *<span class="title">panel</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    panel = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*panel));</span><br><span class="line">    <span class="keyword">if</span> (!panel)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    <span class="built_in">memset</span>(panel, <span class="number">0</span>, <span class="keyword">sizeof</span>(*panel));</span><br><span class="line"></span><br><span class="line">    panel-&gt;blob = blob;</span><br><span class="line">    panel-&gt;node = node;</span><br><span class="line">    panel_state-&gt;<span class="keyword">private</span> = panel;</span><br><span class="line"></span><br><span class="line">    ret = rockchip_dsi_panel_parse_dt(blob, node, panel);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    conn_state-&gt;bus_format = panel-&gt;bus_format;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dsi_panel_parse_dt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *blob, <span class="keyword">int</span> node, struct rockchip_dsi_panel *panel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdt_gpio_state</span> *<span class="title">enable_gpio</span> = &amp;<span class="title">panel</span>-&gt;<span class="title">enable_gpio</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdt_gpio_state</span> *<span class="title">reset_gpio</span> = &amp;<span class="title">panel</span>-&gt;<span class="title">reset_gpio</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *data;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    fdtdec_decode_gpio(blob, node, <span class="string">&quot;enable-gpios&quot;</span>, enable_gpio);</span><br><span class="line">    fdtdec_decode_gpio(blob, node, <span class="string">&quot;reset-gpios&quot;</span>, reset_gpio);</span><br><span class="line"></span><br><span class="line">    panel-&gt;delay_prepare = fdtdec_get_int(blob, node, <span class="string">&quot;prepare-delay-ms&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    panel-&gt;delay_unprepare = fdtdec_get_int(blob, node, <span class="string">&quot;unprepare-delay-ms&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    panel-&gt;delay_enable = fdtdec_get_int(blob, node, <span class="string">&quot;enable-delay-ms&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    panel-&gt;delay_disable = fdtdec_get_int(blob, node, <span class="string">&quot;disable-delay-ms&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    panel-&gt;delay_init = fdtdec_get_int(blob, node, <span class="string">&quot;init-delay-ms&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    panel-&gt;delay_reset = fdtdec_get_int(blob, node, <span class="string">&quot;reset-delay-ms&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    panel-&gt;bus_format = fdtdec_get_int(blob, node, <span class="string">&quot;bus-format&quot;</span>, MEDIA_BUS_FMT_RBG888_1X24);</span><br><span class="line"></span><br><span class="line">    data = fdt_getprop(blob, node, <span class="string">&quot;panel-init-sequence&quot;</span>, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        panel-&gt;on_cmds = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*panel-&gt;on_cmds));</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        ret = rockchip_dsi_panel_parse_cmds(blob, node, data, len,</span><br><span class="line">                            panel-&gt;on_cmds);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = fdt_getprop(blob, node, <span class="string">&quot;panel-exit-sequence&quot;</span>, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        panel-&gt;off_cmds = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*panel-&gt;off_cmds));</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        ret = rockchip_dsi_panel_parse_cmds(blob, node, data, len,</span><br><span class="line">                            panel-&gt;off_cmds);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* keep panel blank on init. */</span></span><br><span class="line">    gpio_direction_output(enable_gpio-&gt;gpio, !!(enable_gpio-&gt;flags &amp; OF_GPIO_ACTIVE_LOW));</span><br><span class="line">    gpio_direction_output(reset_gpio-&gt;gpio, !(reset_gpio-&gt;flags &amp; OF_GPIO_ACTIVE_LOW));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RK_PWM_BL</span></span><br><span class="line">    rk_pwm_bl_config(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-1-7、rk-pwm-bl-config"><a href="#3-1-7、rk-pwm-bl-config" class="headerlink" title="3.1.7、rk_pwm_bl_config()"></a>3.1.7、rk_pwm_bl_config()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_dsi_panel.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rk_pwm_bl_config</span><span class="params">(<span class="keyword">int</span> brightness)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u64 val, div, clk_rate;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> prescale = <span class="number">0</span>, pv, dc;</span><br><span class="line">    u32 on;</span><br><span class="line">    <span class="keyword">int</span> conf = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> duty_ns, period_ns;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display rk_pwm_bl_config: %d \n&quot;</span>,brightness);</span><br><span class="line">    <span class="keyword">if</span> (!bl.node) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_OF_LIBFDT</span></span><br><span class="line">        debug(<span class="string">&quot;rk pwm parse dt start.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!gd-&gt;fdt_blob)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        ret = rk_bl_parse_dt(gd-&gt;fdt_blob);</span><br><span class="line">        debug(<span class="string">&quot;rk pwm parse dt end.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        rk_iomux_config(bl.id + RK_PWM0_IOMUX);</span><br><span class="line">        gpio_direction_output(bl.bl_en.gpio, bl.bl_en.flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bl.status)</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (brightness == <span class="number">0</span>)</span><br><span class="line">        gpio_set_value(bl.bl_en.gpio, !(bl.bl_en.flags));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        gpio_set_value(bl.bl_en.gpio, bl.bl_en.flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (brightness &lt; <span class="number">0</span>)</span><br><span class="line">        brightness = bl.dft_brightness;</span><br><span class="line">    debug(<span class="string">&quot;%s: brightness: %d\n&quot;</span>, __func__, brightness);</span><br><span class="line">    brightness = bl.levels[brightness];</span><br><span class="line">    duty_ns = (brightness * bl.period)/bl.max_brightness;</span><br><span class="line">    period_ns = bl.period;</span><br><span class="line">    on   =  RK_PWM_ENABLE;</span><br><span class="line">    conf = PWM_OUTPUT_LEFT|PWM_LP_DISABLE|PWM_CONTINUMOUS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bl.polarity == PWM_POLARITY_INVERSED)</span><br><span class="line">        conf |= PWM_DUTY_NEGATIVE | PWM_INACTIVE_POSTIVE;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        conf |= PWM_DUTY_POSTIVE | PWM_INACTIVE_NEGATIVE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Find pv, dc and prescale to suit duty_ns and period_ns. This is done</span></span><br><span class="line"><span class="comment">     * according to formulas described below:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * period_ns = 10^9 * (PRESCALE ) * PV / PWM_CLK_RATE</span></span><br><span class="line"><span class="comment">     * duty_ns = 10^9 * (PRESCALE + 1) * DC / PWM_CLK_RATE</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * PV = (PWM_CLK_RATE * period_ns) / (10^9 * (PRESCALE + 1))</span></span><br><span class="line"><span class="comment">     * DC = (PWM_CLK_RATE * duty_ns) / (10^9 * (PRESCALE + 1))</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    clk_rate = get_pclk_pwm(bl.id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        div = <span class="number">1000000000</span>;</span><br><span class="line">        div *= <span class="number">1</span> + prescale;</span><br><span class="line">        val = clk_rate * period_ns;</span><br><span class="line">        pv = div64_u64(val, div);</span><br><span class="line">        val = clk_rate * duty_ns;</span><br><span class="line">        dc = div64_u64(val, div);</span><br><span class="line">        <span class="comment">/* if duty_ns and period_ns are not achievable then return */</span></span><br><span class="line">        <span class="keyword">if</span> (pv &lt; PWMPCR_MIN_PERIOD || dc &lt; PWMDCR_MIN_DUTY)</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * if pv and dc have crossed their upper limit, then increase</span></span><br><span class="line"><span class="comment">         * prescale and recalculate pv and dc.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (pv &gt; PWMPCR_MAX_PERIOD || dc &gt; PWMDCR_MAX_DUTY) &#123;</span><br><span class="line">            <span class="keyword">if</span> (++prescale &gt; PWMCR_MAX_PRESCALE)</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * <span class="doctag">NOTE:</span> the clock to PWM has to be enabled first before writing to the</span></span><br><span class="line"><span class="comment">     * registers.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    conf |= (prescale &lt;&lt; RK_PWM_PRESCALE);</span><br><span class="line">    write_pwm_reg(&amp;bl, PWM_REG_DUTY, dc);</span><br><span class="line">    write_pwm_reg(&amp;bl, PWM_REG_PERIOD, pv);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> RK_VOP_PWM</span></span><br><span class="line">    <span class="keyword">if</span> (bl.id &gt;= RK_VOP0_PWM) &#123;</span><br><span class="line">        write_pwm_reg(&amp;bl, VOP_PWM_REG_CNTR, <span class="number">0</span>);</span><br><span class="line">        write_pwm_reg(&amp;bl, VOP_PWM_REG_CTRL, on|conf);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">    #endif</span><br><span class="line">    &#123;</span><br><span class="line">        write_pwm_reg(&amp;bl, PWM_REG_CNTR, <span class="number">0</span>);</span><br><span class="line">        write_pwm_reg(&amp;bl, PWM_REG_CTRL, on|conf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="3-2、dsi模块init分析"><a href="#3-2、dsi模块init分析" class="headerlink" title="3.2、dsi模块init分析"></a>3.2、dsi模块init分析</h4><h5 id="3-2-1、rockchip-show-logo"><a href="#3-2-1、rockchip-show-logo" class="headerlink" title="3.2.1、rockchip_show_logo()"></a>3.2.1、rockchip_show_logo()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rockchip_show_logo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">display_state</span> *<span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">    list_for_each_entry(s, &amp;rockchip_display_list, head) &#123;</span><br><span class="line">        s-&gt;logo.mode = s-&gt;logo_mode;</span><br><span class="line">        <span class="keyword">if</span> (load_bmp_logo(&amp;s-&gt;logo, s-&gt;ulogo_name))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed to display uboot logo\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            display_logo(s);</span><br><span class="line">        <span class="keyword">if</span> (load_bmp_logo(&amp;s-&gt;logo, s-&gt;klogo_name))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed to display kernel logo\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-2、load-bmp-logo"><a href="#3-2-2、load-bmp-logo" class="headerlink" title="3.2.2、load_bmp_logo()"></a>3.2.2、load_bmp_logo()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">load_bmp_logo</span><span class="params">(struct logo_info *logo, <span class="keyword">const</span> <span class="keyword">char</span> *bmp_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_logo_cache</span> *<span class="title">logo_cache</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bmp_header</span> *<span class="title">header</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *dst = <span class="literal">NULL</span>, *pdst;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display bmp_name %s \n&quot;</span>, bmp_name);</span><br><span class="line"></span><br><span class="line">    logo_cache = find_or_alloc_logo_cache(bmp_name);</span><br><span class="line">    <span class="keyword">if</span> (logo_cache-&gt;logo.mem) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(logo, &amp;logo_cache-&gt;logo, <span class="keyword">sizeof</span>(*logo));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    header = get_bmp_header(bmp_name);</span><br><span class="line"></span><br><span class="line">    logo-&gt;bpp = get_unaligned_le16(&amp;header-&gt;bit_count);</span><br><span class="line">    logo-&gt;width = get_unaligned_le32(&amp;header-&gt;width);</span><br><span class="line">    logo-&gt;height = get_unaligned_le32(&amp;header-&gt;height);</span><br><span class="line">    size = get_unaligned_le32(&amp;header-&gt;file_size);</span><br><span class="line">    <span class="keyword">if</span> (!can_direct_logo(logo-&gt;bpp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (size &gt; CONFIG_RK_BOOT_BUFFER_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line">        pdst = (<span class="keyword">void</span> *)gd-&gt;arch.rk_boot_buf_addr;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pdst = get_display_buffer(size);</span><br><span class="line">        dst = pdst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (load_bmp_content(bmp_name, pdst, size)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!can_direct_logo(logo-&gt;bpp)) &#123;</span><br><span class="line">        <span class="keyword">int</span> dst_size;</span><br><span class="line">        logo-&gt;bpp = (logo-&gt;bpp &lt;= <span class="number">16</span>) ? <span class="number">16</span> : logo-&gt;bpp;</span><br><span class="line">        dst_size = logo-&gt;width * logo-&gt;height * logo-&gt;bpp &gt;&gt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bmpdecoder(pdst, dst, logo-&gt;bpp)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        logo-&gt;offset = <span class="number">0</span>;</span><br><span class="line">        logo-&gt;ymirror = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logo-&gt;offset = get_unaligned_le32(&amp;header-&gt;data_offset);</span><br><span class="line">        logo-&gt;ymirror = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    logo-&gt;mem = (u32)(<span class="keyword">unsigned</span> <span class="keyword">long</span>)dst;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;logo_cache-&gt;logo, logo, <span class="keyword">sizeof</span>(*logo));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-3、display-logo"><a href="#3-2-3、display-logo" class="headerlink" title="3.2.3、display_logo()"></a>3.2.3、display_logo()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">display_logo</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">crtc_state</span> *<span class="title">crtc_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">crtc_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">logo_info</span> *<span class="title">logo</span> = &amp;<span class="title">state</span>-&gt;<span class="title">logo</span>;</span></span><br><span class="line">    <span class="keyword">int</span> hdisplay, vdisplay;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    display_init(state);</span><br><span class="line">    <span class="keyword">if</span> (!state-&gt;is_init)</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (logo-&gt;bpp) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">        crtc_state-&gt;format = ROCKCHIP_FMT_RGB565;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24</span>:</span><br><span class="line">        crtc_state-&gt;format = ROCKCHIP_FMT_RGB888;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line">        crtc_state-&gt;format = ROCKCHIP_FMT_ARGB8888;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t support bmp bits[%d]\n&quot;</span>, logo-&gt;bpp);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    crtc_state-&gt;rb_swap = logo-&gt;bpp != <span class="number">32</span>;</span><br><span class="line">    hdisplay = conn_state-&gt;mode.hdisplay;</span><br><span class="line">    vdisplay = conn_state-&gt;mode.vdisplay;</span><br><span class="line">    crtc_state-&gt;src_w = logo-&gt;width;</span><br><span class="line">    crtc_state-&gt;src_h = logo-&gt;height;</span><br><span class="line">    crtc_state-&gt;src_x = <span class="number">0</span>;</span><br><span class="line">    crtc_state-&gt;src_y = <span class="number">0</span>;</span><br><span class="line">    crtc_state-&gt;ymirror = logo-&gt;ymirror;</span><br><span class="line"></span><br><span class="line">    crtc_state-&gt;dma_addr = logo-&gt;mem + logo-&gt;offset;</span><br><span class="line">    crtc_state-&gt;xvir = ALIGN(crtc_state-&gt;src_w * logo-&gt;bpp, <span class="number">32</span>) &gt;&gt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logo-&gt;mode == ROCKCHIP_DISPLAY_FULLSCREEN) &#123;</span><br><span class="line">        crtc_state-&gt;crtc_x = <span class="number">0</span>;</span><br><span class="line">        crtc_state-&gt;crtc_y = <span class="number">0</span>;</span><br><span class="line">        crtc_state-&gt;crtc_w = hdisplay;</span><br><span class="line">        crtc_state-&gt;crtc_h = vdisplay;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (crtc_state-&gt;src_w &gt;= hdisplay) &#123;</span><br><span class="line">            crtc_state-&gt;crtc_x = <span class="number">0</span>;</span><br><span class="line">            crtc_state-&gt;crtc_w = hdisplay;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            crtc_state-&gt;crtc_x = (hdisplay - crtc_state-&gt;src_w) / <span class="number">2</span>;</span><br><span class="line">            crtc_state-&gt;crtc_w = crtc_state-&gt;src_w;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crtc_state-&gt;src_h &gt;= vdisplay) &#123;</span><br><span class="line">            crtc_state-&gt;crtc_y = <span class="number">0</span>;</span><br><span class="line">            crtc_state-&gt;crtc_h = vdisplay;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            crtc_state-&gt;crtc_y = (vdisplay - crtc_state-&gt;src_h) / <span class="number">2</span>;</span><br><span class="line">            crtc_state-&gt;crtc_h = crtc_state-&gt;src_h;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    display_set_plane(state);</span><br><span class="line">    display_enable(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-4、display-init"><a href="#3-2-4、display-init" class="headerlink" title="3.2.4、display_init()"></a>3.2.4、display_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">display_init</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *<span class="title">conn</span> = <span class="title">state</span>-&gt;<span class="title">conn_state</span>.<span class="title">connector</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector_funcs</span> *<span class="title">conn_funcs</span> = <span class="title">conn</span>-&gt;<span class="title">funcs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> *<span class="title">crtc</span> = <span class="title">state</span>-&gt;<span class="title">crtc_state</span>.<span class="title">crtc</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc_funcs</span> *<span class="title">crtc_funcs</span> = <span class="title">crtc</span>-&gt;<span class="title">funcs</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> *<span class="title">mode</span> = &amp;<span class="title">conn_state</span>-&gt;<span class="title">mode</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state-&gt;is_init)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!conn_funcs || !crtc_funcs) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to find connector or crtc functions\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn_funcs-&gt;init) &#123;</span><br><span class="line">        ret = conn_funcs-&gt;init(state);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn_funcs-&gt;get_timing) &#123;</span><br><span class="line">        ret = conn_funcs-&gt;get_timing(state);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = display_get_timing(state);</span><br><span class="line">    &#125;</span><br><span class="line">    drm_mode_set_crtcinfo(mode, CRTC_INTERLACE_HALVE_V);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crtc_funcs-&gt;init) &#123;</span><br><span class="line">        ret = crtc_funcs-&gt;init(state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    state-&gt;is_init = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-2-5、rockchip-dw-mipi-dsi-init"><a href="#3-2-5、rockchip-dw-mipi-dsi-init" class="headerlink" title="3.2.5、rockchip_dw_mipi_dsi_init()"></a>3.2.5、rockchip_dw_mipi_dsi_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dw_mipi_dsi_init</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *<span class="title">connector</span> = <span class="title">conn_state</span>-&gt;<span class="title">connector</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dw_mipi_dsi_plat_data</span> *<span class="title">pdata</span> = <span class="title">connector</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">    <span class="keyword">int</span> mipi_node = conn_state-&gt;node;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dw_mipi_dsi</span> *<span class="title">dsi</span>;</span></span><br><span class="line">    <span class="keyword">int</span> panel;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    dsi = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*dsi));</span><br><span class="line">    <span class="keyword">if</span> (!dsi)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    <span class="built_in">memset</span>(dsi, <span class="number">0</span>, <span class="keyword">sizeof</span>(*dsi));</span><br><span class="line"></span><br><span class="line">    dsi-&gt;base = (<span class="keyword">void</span> *)fdtdec_get_addr_size_auto_noparent(state-&gt;blob,</span><br><span class="line">                        mipi_node, <span class="string">&quot;reg&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    dsi-&gt;pdata = pdata;</span><br><span class="line">    dsi-&gt;id = id++;</span><br><span class="line">    dsi-&gt;blob = state-&gt;blob;</span><br><span class="line">    dsi-&gt;node = mipi_node;</span><br><span class="line">    conn_state-&gt;<span class="keyword">private</span> = dsi;</span><br><span class="line">    conn_state-&gt;output_mode = ROCKCHIP_OUT_MODE_P888;</span><br><span class="line">    conn_state-&gt;color_space = V4L2_COLORSPACE_DEFAULT;</span><br><span class="line"></span><br><span class="line">    panel = fdt_subnode_offset(state-&gt;blob, mipi_node, <span class="string">&quot;panel&quot;</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    FDT_GET_INT(dsi-&gt;lanes, <span class="string">&quot;dsi,lanes&quot;</span>);</span><br><span class="line">    FDT_GET_INT(dsi-&gt;format, <span class="string">&quot;dsi,format&quot;</span>);</span><br><span class="line">    FDT_GET_INT(dsi-&gt;mode_flags, <span class="string">&quot;dsi,flags&quot;</span>);</span><br><span class="line">    FDT_GET_INT(dsi-&gt;channel, <span class="string">&quot;reg&quot;</span>);</span><br><span class="line">    dsi-&gt;lvds_force_clk = fdtdec_get_int(state-&gt;blob, panel, <span class="string">&quot;dsi,lvds-force-clk&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    ret = rockchip_dsi_dual_channel_probe(dsi);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    conn_state-&gt;type = DRM_MODE_CONNECTOR_DSI;</span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;slave)</span><br><span class="line">        conn_state-&gt;output_type = ROCKCHIP_OUTPUT_DSI_DUAL_CHANNEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-6、display-get-timing"><a href="#3-2-6、display-get-timing" class="headerlink" title="3.2.6、display_get_timing()"></a>3.2.6、display_get_timing()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">display_get_timing</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *<span class="title">conn</span> = <span class="title">state</span>-&gt;<span class="title">conn_state</span>.<span class="title">connector</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector_funcs</span> *<span class="title">conn_funcs</span> = <span class="title">conn</span>-&gt;<span class="title">funcs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> *<span class="title">mode</span> = &amp;<span class="title">conn_state</span>-&gt;<span class="title">mode</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> *<span class="title">m</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *blob = state-&gt;blob;</span><br><span class="line">    <span class="keyword">int</span> conn_node = conn_state-&gt;node;</span><br><span class="line">    <span class="keyword">int</span> panel;</span><br><span class="line"></span><br><span class="line">    panel = get_panel_node(state, conn_node);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!display_get_timing_from_dts(panel, blob, mode)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Using display timing dts\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m = rockchip_get_display_mode_from_panel(state);</span><br><span class="line">    <span class="keyword">if</span> (m) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Using display timing from compatible panel driver\n&quot;</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(mode, m, <span class="keyword">sizeof</span>(*m));</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rockchip_panel_prepare(state);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> -ENODEV;</span><br><span class="line">done:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display Detailed mode clock %u kHz, flags[%x]\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    H: %04d %04d %04d %04d\n&quot;</span></span><br><span class="line">           <span class="string">&quot;    V: %04d %04d %04d %04d\n&quot;</span></span><br><span class="line">           <span class="string">&quot;bus_format: %x\n&quot;</span>,</span><br><span class="line">           mode-&gt;clock, mode-&gt;flags,</span><br><span class="line">           mode-&gt;hdisplay, mode-&gt;hsync_start,</span><br><span class="line">           mode-&gt;hsync_end, mode-&gt;htotal,</span><br><span class="line">           mode-&gt;vdisplay, mode-&gt;vsync_start,</span><br><span class="line">           mode-&gt;vsync_end, mode-&gt;vtotal,</span><br><span class="line">           conn_state-&gt;bus_format);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3、vop模块init分析"><a href="#3-3、vop模块init分析" class="headerlink" title="3.3、vop模块init分析"></a>3.3、vop模块init分析</h4><h5 id="3-3-1、rockchip-vop-init"><a href="#3-3-1、rockchip-vop-init" class="headerlink" title="3.3.1、rockchip_vop_init()"></a>3.3.1、rockchip_vop_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_vop.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_vop_init</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">crtc_state</span> *<span class="title">crtc_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">crtc_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> *<span class="title">mode</span> = &amp;<span class="title">conn_state</span>-&gt;<span class="title">mode</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> *<span class="title">crtc</span> = <span class="title">crtc_state</span>-&gt;<span class="title">crtc</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vop_data</span> *<span class="title">vop_data</span> = <span class="title">crtc</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vop</span> *<span class="title">vop</span>;</span></span><br><span class="line">    u16 hsync_len = mode-&gt;crtc_hsync_end - mode-&gt;crtc_hsync_start;</span><br><span class="line">    u16 hdisplay = mode-&gt;crtc_hdisplay;</span><br><span class="line">    u16 htotal = mode-&gt;crtc_htotal;</span><br><span class="line">    u16 hact_st = mode-&gt;crtc_htotal - mode-&gt;crtc_hsync_start;</span><br><span class="line">    u16 hact_end = hact_st + hdisplay;</span><br><span class="line">    u16 vdisplay = mode-&gt;crtc_vdisplay;</span><br><span class="line">    u16 vtotal = mode-&gt;crtc_vtotal;</span><br><span class="line">    u16 vsync_len = mode-&gt;crtc_vsync_end - mode-&gt;crtc_vsync_start;</span><br><span class="line">    u16 vact_st = mode-&gt;crtc_vtotal - mode-&gt;crtc_vsync_start;</span><br><span class="line">    u16 vact_end = vact_st + vdisplay;</span><br><span class="line">    u32 val, act_end;</span><br><span class="line">    <span class="keyword">int</span> rate;</span><br><span class="line">    <span class="keyword">bool</span> yuv_overlay = <span class="literal">false</span>, post_r2y_en = <span class="literal">false</span>, post_y2r_en = <span class="literal">false</span>;</span><br><span class="line">    u16 post_csc_mode;</span><br><span class="line">    <span class="keyword">int</span> for_ddr_freq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vop = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*vop));</span><br><span class="line">    <span class="keyword">if</span> (!vop)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    <span class="built_in">memset</span>(vop, <span class="number">0</span>, <span class="keyword">sizeof</span>(*vop));</span><br><span class="line"></span><br><span class="line">    crtc_state-&gt;<span class="keyword">private</span> = vop;</span><br><span class="line">    vop-&gt;regs = (<span class="keyword">void</span> *)fdtdec_get_addr_size_auto_noparent(state-&gt;blob,</span><br><span class="line">                    crtc_state-&gt;node, <span class="string">&quot;reg&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    vop-&gt;regsbak = <span class="built_in">malloc</span>(vop_data-&gt;reg_len);</span><br><span class="line">    vop-&gt;win = vop_data-&gt;win;</span><br><span class="line">    vop-&gt;win_offset = vop_data-&gt;win_offset;</span><br><span class="line">    vop-&gt;ctrl = vop_data-&gt;ctrl;</span><br><span class="line">    vop-&gt;line_flag = vop_data-&gt;line_flag;</span><br><span class="line">    vop-&gt;version = vop_data-&gt;version;</span><br><span class="line">    vop-&gt;max_output = vop_data-&gt;max_output;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RKCHIP_RK3399</span></span><br><span class="line">    <span class="comment">/* Set Dclk pll parent */</span></span><br><span class="line">    <span class="keyword">if</span> (conn_state-&gt;type == DRM_MODE_CONNECTOR_HDMIA)</span><br><span class="line">        rkclk_lcdc_dclk_pll_sel(crtc_state-&gt;crtc_id, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        rkclk_lcdc_dclk_pll_sel(crtc_state-&gt;crtc_id, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set aclk hclk and dclk */</span></span><br><span class="line"></span><br><span class="line">    rate = rkclk_lcdc_clk_set(crtc_state-&gt;crtc_id, mode-&gt;crtc_clock * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">if</span> (rate != mode-&gt;clock * <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Warn: vop clk request %dhz, but real clock is %dhz\n&quot;</span>,</span><br><span class="line">               mode-&gt;clock * <span class="number">1000</span>, rate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(vop-&gt;regsbak, vop-&gt;regs, vop_data-&gt;reg_len);</span><br><span class="line"></span><br><span class="line">    rockchip_vop_init_gamma(vop, state);</span><br><span class="line"></span><br><span class="line">    VOP_CTRL_SET(vop, global_regdone_en, <span class="number">1</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, axi_outstanding_max_num, <span class="number">30</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, axi_max_outstanding_en, <span class="number">1</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, reg_done_frm, <span class="number">1</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, win_gate[<span class="number">0</span>], <span class="number">1</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, win_gate[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, win_channel[<span class="number">0</span>], <span class="number">0x12</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, win_channel[<span class="number">1</span>], <span class="number">0x34</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, win_channel[<span class="number">2</span>], <span class="number">0x56</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, dsp_blank, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    val = <span class="number">0x8</span>;</span><br><span class="line">    val |= (mode-&gt;flags &amp; DRM_MODE_FLAG_NHSYNC) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    val |= (mode-&gt;flags &amp; DRM_MODE_FLAG_NVSYNC) ? <span class="number">0</span> : (<span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, pin_pol, val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (conn_state-&gt;type) &#123;</span><br><span class="line">   ......</span><br><span class="line">    <span class="keyword">case</span> DRM_MODE_CONNECTOR_DSI:</span><br><span class="line">        VOP_CTRL_SET(vop, mipi_en, <span class="number">1</span>);</span><br><span class="line">        VOP_CTRL_SET(vop, mipi_pin_pol, val);</span><br><span class="line">        VOP_CTRL_SET(vop, mipi_dual_channel_en,</span><br><span class="line">            !!(conn_state-&gt;output_type &amp; ROCKCHIP_OUTPUT_DSI_DUAL_CHANNEL));</span><br><span class="line">        VOP_CTRL_SET(vop, data01_swap,</span><br><span class="line">            !!(conn_state-&gt;output_type &amp; ROCKCHIP_OUTPUT_DSI_DUAL_LINK));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;unsupport connector_type[%d]\n&quot;</span>, conn_state-&gt;type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn_state-&gt;output_mode == ROCKCHIP_OUT_MODE_AAAA &amp;&amp;</span><br><span class="line">        !(vop_data-&gt;feature &amp; VOP_FEATURE_OUTPUT_10BIT))</span><br><span class="line">        conn_state-&gt;output_mode = ROCKCHIP_OUT_MODE_P888;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (conn_state-&gt;bus_format) &#123;</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_RGB565_1X16:</span><br><span class="line">        val = DITHER_DOWN_EN(<span class="number">1</span>) | DITHER_DOWN_MODE(RGB888_TO_RGB565);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_RGB666_1X18:</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_RGB666_1X24_CPADHI:</span><br><span class="line">        val = DITHER_DOWN_EN(<span class="number">1</span>) | DITHER_DOWN_MODE(RGB888_TO_RGB666);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_YUV8_1X24:</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_UYYVYY8_0_5X24:</span><br><span class="line">        val = DITHER_DOWN_EN(<span class="number">0</span>) | PRE_DITHER_DOWN_EN(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_YUV10_1X30:</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_UYYVYY10_0_5X30:</span><br><span class="line">        val = DITHER_DOWN_EN(<span class="number">0</span>) | PRE_DITHER_DOWN_EN(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MEDIA_BUS_FMT_RGB888_1X24:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        val = DITHER_DOWN_EN(<span class="number">0</span>) | PRE_DITHER_DOWN_EN(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (conn_state-&gt;output_mode == ROCKCHIP_OUT_MODE_AAAA)</span><br><span class="line">        val |= PRE_DITHER_DOWN_EN(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        val |= PRE_DITHER_DOWN_EN(<span class="number">1</span>);</span><br><span class="line">    val |= DITHER_DOWN_MODE_SEL(DITHER_DOWN_ALLEGRO);</span><br><span class="line">    VOP_CTRL_SET(vop, dither_down, val);</span><br><span class="line"></span><br><span class="line">    VOP_CTRL_SET(vop, dclk_ddr,</span><br><span class="line">             conn_state-&gt;output_mode == ROCKCHIP_OUT_MODE_YUV420 ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    VOP_CTRL_SET(vop, hdmi_dclk_out_en,</span><br><span class="line">             conn_state-&gt;output_mode == ROCKCHIP_OUT_MODE_YUV420 ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_uv_swap(conn_state-&gt;bus_format, conn_state-&gt;output_mode))</span><br><span class="line">        VOP_CTRL_SET(vop, dsp_data_swap, DSP_RB_SWAP);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        VOP_CTRL_SET(vop, dsp_data_swap, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    VOP_CTRL_SET(vop, out_mode, conn_state-&gt;output_mode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (VOP_CTRL_SUPPORT(vop, overlay_mode)) &#123;</span><br><span class="line">        yuv_overlay = is_yuv_output(conn_state-&gt;bus_format);</span><br><span class="line">        VOP_CTRL_SET(vop, overlay_mode, yuv_overlay);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * todo: r2y for win csc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    VOP_CTRL_SET(vop, dsp_out_yuv, is_yuv_output(conn_state-&gt;bus_format));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (yuv_overlay) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_yuv_output(conn_state-&gt;bus_format))</span><br><span class="line">            post_y2r_en = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_yuv_output(conn_state-&gt;bus_format))</span><br><span class="line">            post_r2y_en = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    post_csc_mode = to_vop_csc_mode(conn_state-&gt;color_space);</span><br><span class="line">    VOP_CTRL_SET(vop, bcsh_r2y_en, post_r2y_en);</span><br><span class="line">    VOP_CTRL_SET(vop, bcsh_y2r_en, post_y2r_en);</span><br><span class="line">    VOP_CTRL_SET(vop, bcsh_r2y_csc_mode, post_csc_mode);</span><br><span class="line">    VOP_CTRL_SET(vop, bcsh_y2r_csc_mode, post_csc_mode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Background color is 10bit depth if vop version &gt;= 3.5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!is_yuv_output(conn_state-&gt;bus_format))</span><br><span class="line">        val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (VOP_MAJOR(vop-&gt;version) == <span class="number">3</span> &amp;&amp;</span><br><span class="line">         VOP_MINOR(vop-&gt;version) &gt;= <span class="number">5</span>)</span><br><span class="line">        val = <span class="number">0x20010200</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        val = <span class="number">0x801080</span>;</span><br><span class="line">    VOP_CTRL_SET(vop, dsp_background, val);</span><br><span class="line"></span><br><span class="line">    VOP_CTRL_SET(vop, htotal_pw, (htotal &lt;&lt; <span class="number">16</span>) | hsync_len);</span><br><span class="line">    val = hact_st &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    val |= hact_end;</span><br><span class="line">    VOP_CTRL_SET(vop, hact_st_end, val);</span><br><span class="line">    val = vact_st &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    val |= vact_end;</span><br><span class="line">    VOP_CTRL_SET(vop, vact_st_end, val);</span><br><span class="line">    <span class="keyword">if</span> (mode-&gt;flags &amp; DRM_MODE_FLAG_INTERLACE) &#123;</span><br><span class="line">        u16 vact_st_f1 = vtotal + vact_st + <span class="number">1</span>;</span><br><span class="line">        u16 vact_end_f1 = vact_st_f1 + vdisplay;</span><br><span class="line"></span><br><span class="line">        val = vact_st_f1 &lt;&lt; <span class="number">16</span> | vact_end_f1;</span><br><span class="line">        VOP_CTRL_SET(vop, vact_st_end_f1, val);</span><br><span class="line"></span><br><span class="line">        val = vtotal &lt;&lt; <span class="number">16</span> | (vtotal + vsync_len);</span><br><span class="line">        VOP_CTRL_SET(vop, vs_st_end_f1, val);</span><br><span class="line">        VOP_CTRL_SET(vop, dsp_interlace, <span class="number">1</span>);</span><br><span class="line">        VOP_CTRL_SET(vop, p2i_en, <span class="number">1</span>);</span><br><span class="line">        vtotal += vtotal + <span class="number">1</span>;</span><br><span class="line">        act_end = vact_end_f1;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        VOP_CTRL_SET(vop, dsp_interlace, <span class="number">0</span>);</span><br><span class="line">        VOP_CTRL_SET(vop, p2i_en, <span class="number">0</span>);</span><br><span class="line">        act_end = vact_end;</span><br><span class="line">    &#125;</span><br><span class="line">    VOP_CTRL_SET(vop, vtotal_pw, (vtotal &lt;&lt; <span class="number">16</span>) | vsync_len);</span><br><span class="line">    vop_post_config(state, vop);</span><br><span class="line">    VOP_CTRL_SET(vop, core_dclk_div,</span><br><span class="line">             !!(mode-&gt;flags &amp; DRM_MODE_FLAG_DBLCLK));</span><br><span class="line"></span><br><span class="line">    VOP_CTRL_SET(vop, standby, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (VOP_MAJOR(vop-&gt;version) == <span class="number">3</span> &amp;&amp;</span><br><span class="line">        (VOP_MINOR(vop-&gt;version) == <span class="number">2</span> || VOP_MINOR(vop-&gt;version) == <span class="number">8</span>))</span><br><span class="line">        for_ddr_freq = <span class="number">1000</span>;</span><br><span class="line">    VOP_LINE_FLAG_SET(vop, line_flag_num[<span class="number">0</span>], act_end - <span class="number">1</span>);</span><br><span class="line">    VOP_LINE_FLAG_SET(vop, line_flag_num[<span class="number">1</span>],</span><br><span class="line">              act_end - us_to_vertical_line(mode, for_ddr_freq));</span><br><span class="line">    vop_cfg_done(vop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-3-2、display-set-plane"><a href="#3-3-2、display-set-plane" class="headerlink" title="3.3.2、display_set_plane()"></a>3.3.2、display_set_plane()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">display_set_plane</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> *<span class="title">crtc</span> = <span class="title">state</span>-&gt;<span class="title">crtc_state</span>.<span class="title">crtc</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc_funcs</span> *<span class="title">crtc_funcs</span> = <span class="title">crtc</span>-&gt;<span class="title">funcs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="keyword">if</span> (!state-&gt;is_init)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crtc_funcs-&gt;set_plane) &#123;</span><br><span class="line">        ret = crtc_funcs-&gt;set_plane(state);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_vop.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_vop_set_plane</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">crtc_state</span> *<span class="title">crtc_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">crtc_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">drm_display_mode</span> *<span class="title">mode</span> = &amp;<span class="title">conn_state</span>-&gt;<span class="title">mode</span>;</span></span><br><span class="line">    u32 act_info, dsp_info, dsp_st, dsp_stx, dsp_sty;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vop</span> *<span class="title">vop</span> = <span class="title">crtc_state</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">    <span class="keyword">int</span> src_w = crtc_state-&gt;src_w;</span><br><span class="line">    <span class="keyword">int</span> src_h = crtc_state-&gt;src_h;</span><br><span class="line">    <span class="keyword">int</span> crtc_x = crtc_state-&gt;crtc_x;</span><br><span class="line">    <span class="keyword">int</span> crtc_y = crtc_state-&gt;crtc_y;</span><br><span class="line">    <span class="keyword">int</span> crtc_w = crtc_state-&gt;crtc_w;</span><br><span class="line">    <span class="keyword">int</span> crtc_h = crtc_state-&gt;crtc_h;</span><br><span class="line">    <span class="keyword">int</span> xvir = crtc_state-&gt;xvir;</span><br><span class="line"></span><br><span class="line">    act_info = (src_h - <span class="number">1</span>) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    act_info |= (src_w - <span class="number">1</span>) &amp; <span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line">    dsp_info = (crtc_h - <span class="number">1</span>) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    dsp_info |= (crtc_w - <span class="number">1</span>) &amp; <span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line">    dsp_stx = crtc_x + mode-&gt;htotal - mode-&gt;hsync_start;</span><br><span class="line">    dsp_sty = crtc_y + mode-&gt;vtotal - mode-&gt;vsync_start;</span><br><span class="line">    dsp_st = dsp_sty &lt;&lt; <span class="number">16</span> | (dsp_stx &amp; <span class="number">0xffff</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crtc_state-&gt;ymirror)</span><br><span class="line">        crtc_state-&gt;dma_addr += (src_h - <span class="number">1</span>) * xvir * <span class="number">4</span>;</span><br><span class="line">    VOP_WIN_SET(vop, ymirror, crtc_state-&gt;ymirror);</span><br><span class="line">    VOP_WIN_SET(vop, format, crtc_state-&gt;format);</span><br><span class="line">    VOP_WIN_SET(vop, yrgb_vir, xvir);</span><br><span class="line">    VOP_WIN_SET(vop, yrgb_mst, crtc_state-&gt;dma_addr);</span><br><span class="line"></span><br><span class="line">    scl_vop_cal_scl_fac(vop, src_w, src_h, crtc_w, crtc_h,</span><br><span class="line">                crtc_state-&gt;format);</span><br><span class="line"></span><br><span class="line">    VOP_WIN_SET(vop, act_info, act_info);</span><br><span class="line">    VOP_WIN_SET(vop, dsp_info, dsp_info);</span><br><span class="line">    VOP_WIN_SET(vop, dsp_st, dsp_st);</span><br><span class="line">    VOP_WIN_SET(vop, rb_swap, crtc_state-&gt;rb_swap);</span><br><span class="line"></span><br><span class="line">    VOP_WIN_SET(vop, src_alpha_ctl, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    VOP_WIN_SET(vop, enable, <span class="number">1</span>);</span><br><span class="line">    vop_cfg_done(vop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="（四）、vop-dsi-panel三大模块prepare分析"><a href="#（四）、vop-dsi-panel三大模块prepare分析" class="headerlink" title="（四）、vop, dsi, panel三大模块prepare分析"></a>（四）、vop, dsi, panel三大模块prepare分析</h4><h4 id="4-1、vop模块prepare分析"><a href="#4-1、vop模块prepare分析" class="headerlink" title="4.1、vop模块prepare分析"></a>4.1、vop模块prepare分析</h4><h5 id="4-1-1、display-enable"><a href="#4-1-1、display-enable" class="headerlink" title="4.1.1、display_enable()"></a>4.1.1、display_enable()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">display_enable</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *<span class="title">conn</span> = <span class="title">state</span>-&gt;<span class="title">conn_state</span>.<span class="title">connector</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc</span> *<span class="title">crtc</span> = <span class="title">state</span>-&gt;<span class="title">crtc_state</span>.<span class="title">crtc</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector_funcs</span> *<span class="title">conn_funcs</span> = <span class="title">conn</span>-&gt;<span class="title">funcs</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_crtc_funcs</span> *<span class="title">crtc_funcs</span> = <span class="title">crtc</span>-&gt;<span class="title">funcs</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    display_init(state);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="keyword">if</span> (!state-&gt;is_init)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state-&gt;is_enable)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    connector_panel_power_prepare(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crtc_funcs-&gt;prepare) &#123;</span><br><span class="line">        ret = crtc_funcs-&gt;prepare(state);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn_funcs-&gt;prepare) &#123;</span><br><span class="line">        ret = conn_funcs-&gt;prepare(state);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">goto</span> unprepare_crtc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rockchip_panel_prepare(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (crtc_funcs-&gt;enable) &#123;</span><br><span class="line">        ret = crtc_funcs-&gt;enable(state);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">goto</span> unprepare_conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn_funcs-&gt;enable) &#123;</span><br><span class="line">        ret = conn_funcs-&gt;enable(state);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">goto</span> disable_crtc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rockchip_panel_enable(state);</span><br><span class="line"></span><br><span class="line">    state-&gt;is_enable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="4-1-2、connector-panel-power-prepare"><a href="#4-1-2、connector-panel-power-prepare" class="headerlink" title="4.1.2、connector_panel_power_prepare()"></a>4.1.2、connector_panel_power_prepare()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_display.c</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connector_panel_power_prepare</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_panel</span> *<span class="title">panel</span> = <span class="title">panel_state</span>-&gt;<span class="title">panel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_pwrctr</span> *<span class="title">pwrctr</span> = &amp;(<span class="title">conn_state</span>-&gt;<span class="title">pwrctr</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">pclist_head</span> = &amp;(<span class="title">pwrctr</span>-&gt;<span class="title">pclist_head</span>);</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">pos</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_pwrctr_list</span> *<span class="title">pclist</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pwrctr</span> *<span class="title">pc</span>;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="keyword">if</span>(!panel)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (list_empty(pclist_head))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    list_for_each(pos, pclist_head) &#123;</span><br><span class="line">        pclist = list_entry(pos, struct rockchip_pwrctr_list,</span><br><span class="line">                <span class="built_in">list</span>);</span><br><span class="line">        pc = &amp;pclist-&gt;pc;</span><br><span class="line">        <span class="keyword">if</span>(pwrctr-&gt;debug &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;pwrctr: set %s(%d)=%d,delay:%dms\n&quot;</span>,</span><br><span class="line">                    pc-&gt;name, pc-&gt;gpio.gpio, pc-&gt;atv_val, pc-&gt;delay);</span><br><span class="line">        &#125;</span><br><span class="line">        gpio_set_value(pc-&gt;gpio.gpio, pc-&gt;atv_val);</span><br><span class="line">        mdelay(pc-&gt;delay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4-1-3、rockchip-vop-prepare"><a href="#4-1-3、rockchip-vop-prepare" class="headerlink" title="4.1.3、rockchip_vop_prepare()"></a>4.1.3、rockchip_vop_prepare()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_vop.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_vop_prepare</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-2、dsi模块prepare分析"><a href="#4-2、dsi模块prepare分析" class="headerlink" title="4.2、dsi模块prepare分析"></a>4.2、dsi模块prepare分析</h4><h5 id="4-2-1、rockchip-dw-mipi-dsi-prepare"><a href="#4-2-1、rockchip-dw-mipi-dsi-prepare" class="headerlink" title="4.2.1、rockchip_dw_mipi_dsi_prepare()"></a>4.2.1、rockchip_dw_mipi_dsi_prepare()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dw_mipi_dsi_prepare</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">crtc_state</span> *<span class="title">crtc_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">crtc_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_connector</span> *<span class="title">connector</span> = <span class="title">conn_state</span>-&gt;<span class="title">connector</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dw_mipi_dsi_plat_data</span> *<span class="title">pdata</span> = <span class="title">connector</span>-&gt;<span class="title">data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dw_mipi_dsi</span> *<span class="title">dsi</span> = <span class="title">conn_state</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    dw_mipi_dsi_vop_routing(dsi, crtc_state-&gt;crtc_id);</span><br><span class="line"></span><br><span class="line">    rockchip_dw_dsi_pre_init(state, dsi);</span><br><span class="line"></span><br><span class="line">    rockchip_dw_dsi_controller_init(dsi);</span><br><span class="line"></span><br><span class="line">    dsi_write(dsi, DSI_PWR_UP, POWERUP);</span><br><span class="line">    dw_mipi_dsi_wait_for_two_frames(dsi);</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_set_mode(dsi, DSI_COMMAND_MODE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-2-2、dw-mipi-dsi-vop-routing"><a href="#4-2-2、dw-mipi-dsi-vop-routing" class="headerlink" title="4.2.2、dw_mipi_dsi_vop_routing()"></a>4.2.2、dw_mipi_dsi_vop_routing()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dw_mipi_dsi_vop_routing</span><span class="params">(struct dw_mipi_dsi *dsi, <span class="keyword">int</span> vop_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    grf_field_write(dsi, VOPSEL, vop_id);</span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;slave)</span><br><span class="line">        grf_field_write(dsi-&gt;slave, VOPSEL, vop_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="4-2-3、rockchip-dw-dsi-pre-init"><a href="#4-2-3、rockchip-dw-dsi-pre-init" class="headerlink" title="4.2.3、rockchip_dw_dsi_pre_init()"></a>4.2.3、rockchip_dw_dsi_pre_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rockchip_dw_dsi_pre_init</span><span class="params">(struct display_state *state,</span></span></span><br><span class="line"><span class="function"><span class="params">                     struct dw_mipi_dsi *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> bw, rate;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    dsi-&gt;mode = &amp;conn_state-&gt;mode;</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_clk_enable(dsi);</span><br><span class="line"></span><br><span class="line">    rockchip_phy_power_on(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn_state-&gt;phy) &#123;</span><br><span class="line">        bw = rockchip_dsi_calc_bandwidth(dsi);</span><br><span class="line">        rate = rockchip_phy_set_pll(state, bw * USEC_PER_SEC);</span><br><span class="line">        dsi-&gt;lane_mbps = rate / USEC_PER_SEC;</span><br><span class="line">        <span class="comment">//rockchip_phy_power_on(state);</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dw_mipi_dsi_get_lane_bps(dsi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;final DSI-Link bandwidth: %u Mbps x %d\n&quot;</span>,</span><br><span class="line">           dsi-&gt;lane_mbps, dsi-&gt;lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;slave)</span><br><span class="line">        rockchip_dw_dsi_pre_init(state, dsi-&gt;slave);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="4-2-4、rockchip-dw-dsi-controller-init"><a href="#4-2-4、rockchip-dw-dsi-controller-init" class="headerlink" title="4.2.4、rockchip_dw_dsi_controller_init()"></a>4.2.4、rockchip_dw_dsi_controller_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rockchip_dw_dsi_controller_init</span><span class="params">(struct dw_mipi_dsi *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rockchip_dw_dsi_host_init(dsi);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    mdelay(<span class="number">10</span>);</span><br><span class="line">    mipi_dphy_init(dsi);</span><br><span class="line">    dw_mipi_dsi_phy_init(dsi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;slave)</span><br><span class="line">        rockchip_dw_dsi_controller_init(dsi-&gt;slave);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="4-2-5、mipi-dphy-init"><a href="#4-2-5、mipi-dphy-init" class="headerlink" title="4.2.5、mipi_dphy_init()"></a>4.2.5、mipi_dphy_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mipi_dphy_init</span><span class="params">(struct dw_mipi_dsi *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 <span class="built_in">map</span>[] = &#123;<span class="number">0x1</span>, <span class="number">0x3</span>, <span class="number">0x7</span>, <span class="number">0xf</span>&#125;;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="comment">/* Configures DPHY to work as a Master */</span></span><br><span class="line">    grf_field_write(dsi, MASTERSLAVEZ, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Configures lane as TX */</span></span><br><span class="line">    grf_field_write(dsi, BASEDIR, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set all REQUEST inputs to zero */</span></span><br><span class="line">    grf_field_write(dsi, TURNREQUEST, <span class="number">0</span>);</span><br><span class="line">    grf_field_write(dsi, TURNDISABLE, <span class="number">0</span>);</span><br><span class="line">    grf_field_write(dsi, FORCETXSTOPMODE, <span class="number">0</span>);</span><br><span class="line">    grf_field_write(dsi, FORCERXMODE, <span class="number">0</span>);</span><br><span class="line">    udelay(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Enable Data Lane Module */</span></span><br><span class="line">    grf_field_write(dsi, ENABLE_N, <span class="built_in">map</span>[dsi-&gt;lanes - <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Enable Clock Lane Module */</span></span><br><span class="line">    grf_field_write(dsi, ENABLECLK, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="4-2-6、dw-mipi-dsi-phy-init"><a href="#4-2-6、dw-mipi-dsi-phy-init" class="headerlink" title="4.2.6、dw_mipi_dsi_phy_init()"></a>4.2.6、dw_mipi_dsi_phy_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dw_mipi_dsi_phy_init</span><span class="params">(struct dw_mipi_dsi *dsi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret, testdin, vco, val;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    vco = (dsi-&gt;lane_mbps &lt; <span class="number">200</span>) ? <span class="number">0</span> : (dsi-&gt;lane_mbps + <span class="number">100</span>) / <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    testdin = max_mbps_to_testdin(dsi-&gt;lane_mbps);</span><br><span class="line">    <span class="keyword">if</span> (testdin &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get testdin for %dmbps lane clock\n&quot;</span>,</span><br><span class="line">               dsi-&gt;lane_mbps);</span><br><span class="line">        <span class="keyword">return</span> testdin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dsi_write(dsi, DSI_PWR_UP, POWERUP);</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x10</span>, BYPASS_VCO_RANGE |</span><br><span class="line">                     VCO_RANGE_CON_SEL(vco) |</span><br><span class="line">                     VCO_IN_CAP_CON_LOW |</span><br><span class="line">                     REF_BIAS_CUR_SEL);</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x11</span>, CP_CURRENT_3MA);</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x12</span>, CP_PROGRAM_EN | LPF_PROGRAM_EN |</span><br><span class="line">                     LPF_RESISTORS_20_KOHM);</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x44</span>, HSFREQRANGE_SEL(testdin));</span><br><span class="line"></span><br><span class="line">         dw_mipi_dsi_phy_write(dsi, <span class="number">0x19</span>, PLL_LOOP_DIV_EN | PLL_INPUT_DIV_EN);</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x17</span>, INPUT_DIVIDER(dsi-&gt;dphy.input_div));</span><br><span class="line">    val = LOOP_DIV_LOW_SEL(dsi-&gt;dphy.feedback_div) | LOW_PROGRAM_EN;</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x18</span>, val);</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x19</span>, PLL_LOOP_DIV_EN | PLL_INPUT_DIV_EN);</span><br><span class="line">    val = LOOP_DIV_HIGH_SEL(dsi-&gt;dphy.feedback_div) | HIGH_PROGRAM_EN;</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x18</span>, val);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x20</span>, POWER_CONTROL | INTERNAL_REG_CURRENT |</span><br><span class="line">                     BIAS_BLOCK_ON | BANDGAP_ON);</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x21</span>, TER_RESISTOR_LOW | TER_CAL_DONE |</span><br><span class="line">                     SETRD_MAX | TER_RESISTORS_ON);</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x21</span>, TER_RESISTOR_HIGH | LEVEL_SHIFTERS_ON |</span><br><span class="line">                     SETRD_MAX | POWER_MANAGE |</span><br><span class="line">                     TER_RESISTORS_ON);</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x22</span>, LOW_PROGRAM_EN |</span><br><span class="line">                     BIASEXTR_SEL(BIASEXTR_127_7));</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x22</span>, HIGH_PROGRAM_EN |</span><br><span class="line">                     BANDGAP_SEL(BANDGAP_96_10));</span><br><span class="line"></span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x70</span>, TLP_PROGRAM_EN | <span class="number">0xf</span>);</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x71</span>, THS_PRE_PROGRAM_EN | <span class="number">0x2d</span>);</span><br><span class="line">    dw_mipi_dsi_phy_write(dsi, <span class="number">0x72</span>, THS_ZERO_PROGRAM_EN | <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    dsi_write(dsi, DSI_PHY_RSTZ, PHY_ENFORCEPLL | PHY_ENABLECLK |</span><br><span class="line">                     PHY_UNRSTZ | PHY_UNSHUTDOWNZ);</span><br><span class="line"></span><br><span class="line">    ret = readl_poll_timeout(dsi-&gt;base + DSI_PHY_STATUS,</span><br><span class="line">                 val, val &amp; LOCK, <span class="number">1000</span>, PHY_STATUS_TIMEOUT_US);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to wait for phy lock state\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = readl_poll_timeout(dsi-&gt;base + DSI_PHY_STATUS,</span><br><span class="line">                 val, val &amp; STOP_STATE_CLK_LANE, <span class="number">1000</span>,</span><br><span class="line">                 PHY_STATUS_TIMEOUT_US);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to wait for phy clk lane stop state\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="4-2-7、dw-mipi-dsi-set-mode"><a href="#4-2-7、dw-mipi-dsi-set-mode" class="headerlink" title="4.2.7、dw_mipi_dsi_set_mode()"></a>4.2.7、dw_mipi_dsi_set_mode()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dw_mipi_dsi_set_mode</span><span class="params">(struct dw_mipi_dsi *dsi,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">enum</span> dw_mipi_dsi_mode mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mode == DSI_COMMAND_MODE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s \n&quot;</span>, <span class="string">&quot;DSI_COMMAND_MODE&quot;</span>);</span><br><span class="line">        dsi_write(dsi, DSI_PWR_UP, RESET);</span><br><span class="line">        dsi_write(dsi, DSI_MODE_CFG, ENABLE_CMD_MODE);</span><br><span class="line">        dsi_write(dsi, DSI_PWR_UP, POWERUP);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s \n&quot;</span>, <span class="string">&quot;DSI_VIDEO_MODE&quot;</span>);</span><br><span class="line">        dsi_write(dsi, DSI_PWR_UP, RESET);</span><br><span class="line">        dsi_write(dsi, DSI_MODE_CFG, ENABLE_VIDEO_MODE);</span><br><span class="line">        dw_mipi_dsi_video_mode_config(dsi);</span><br><span class="line">        dsi_write(dsi, DSI_PWR_UP, POWERUP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="4-3、panel模块prepare分析"><a href="#4-3、panel模块prepare分析" class="headerlink" title="4.3、panel模块prepare分析"></a>4.3、panel模块prepare分析</h4><h5 id="4-3-1、rockchip-panel-prepare"><a href="#4-3-1、rockchip-panel-prepare" class="headerlink" title="4.3.1、rockchip_panel_prepare()"></a>4.3.1、rockchip_panel_prepare()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_panel.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rockchip_panel_prepare</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_panel</span> *<span class="title">panel</span> = <span class="title">panel_state</span>-&gt;<span class="title">panel</span>;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    <span class="keyword">if</span> (!panel || !panel-&gt;funcs || !panel-&gt;funcs-&gt;prepare) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s: failed to find panel prepare funcs\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> panel-&gt;funcs-&gt;prepare(state);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_dsi_panel.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dsi_panel_prepare</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_dsi_panel</span> *<span class="title">panel</span> = <span class="title">panel_state</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    fdtdec_set_gpio(&amp;panel-&gt;enable_gpio, <span class="number">1</span>);</span><br><span class="line">    msleep(panel-&gt;delay_prepare);</span><br><span class="line"></span><br><span class="line">    fdtdec_set_gpio(&amp;panel-&gt;reset_gpio, <span class="number">1</span>);</span><br><span class="line">    msleep(panel-&gt;delay_reset);</span><br><span class="line">    fdtdec_set_gpio(&amp;panel-&gt;reset_gpio, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    msleep(panel-&gt;delay_init);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (panel-&gt;on_cmds) &#123;</span><br><span class="line">        ret = rockchip_dsi_panel_send_cmds(state, panel-&gt;on_cmds);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed to send on cmds: %d\n&quot;</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="（五）、vop-dsi-panel三大模块enable分析"><a href="#（五）、vop-dsi-panel三大模块enable分析" class="headerlink" title="（五）、vop, dsi, panel三大模块enable分析"></a>（五）、vop, dsi, panel三大模块enable分析</h4><h4 id="5-1、vop模块enable分析"><a href="#5-1、vop模块enable分析" class="headerlink" title="5.1、vop模块enable分析"></a>5.1、vop模块enable分析</h4><h5 id="5-1-1、rockchip-display-init"><a href="#5-1-1、rockchip-display-init" class="headerlink" title="5.1.1、rockchip_display_init()"></a>5.1.1、rockchip_display_init()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_vop.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_vop_enable</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">crtc_state</span> *<span class="title">crtc_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">crtc_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vop</span> *<span class="title">vop</span> = <span class="title">crtc_state</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line"></span><br><span class="line">    VOP_CTRL_SET(vop, standby, <span class="number">0</span>);</span><br><span class="line">    vop_cfg_done(vop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="5-2、dsi模块enable分析"><a href="#5-2、dsi模块enable分析" class="headerlink" title="5.2、dsi模块enable分析"></a>5.2、dsi模块enable分析</h4><h5 id="5-2-1、rockchip-dw-mipi-dsi-enable"><a href="#5-2-1、rockchip-dw-mipi-dsi-enable" class="headerlink" title="5.2.1、rockchip_dw_mipi_dsi_enable()"></a>5.2.1、rockchip_dw_mipi_dsi_enable()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip-dw-mipi-dsi.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dw_mipi_dsi_enable</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">connector_state</span> *<span class="title">conn_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">conn_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dw_mipi_dsi</span> *<span class="title">dsi</span> = <span class="title">conn_state</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    dw_mipi_dsi_set_mode(dsi, DSI_VIDEO_MODE);</span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;slave)</span><br><span class="line">        dw_mipi_dsi_set_mode(dsi-&gt;slave, DSI_VIDEO_MODE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="5-3、panel模块enable分析"><a href="#5-3、panel模块enable分析" class="headerlink" title="5.3、panel模块enable分析"></a>5.3、panel模块enable分析</h4><h5 id="5-3-1、rockchip-dw-mipi-dsi-enable"><a href="#5-3-1、rockchip-dw-mipi-dsi-enable" class="headerlink" title="5.3.1、rockchip_dw_mipi_dsi_enable()"></a>5.3.1、rockchip_dw_mipi_dsi_enable()</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">I:\RK3399_Android8<span class="number">.1</span>_MIPI\u-boot\drivers\video\rockchip_dsi_panel.c</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rockchip_dsi_panel_enable</span><span class="params">(struct display_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">panel_state</span> *<span class="title">panel_state</span> = &amp;<span class="title">state</span>-&gt;<span class="title">panel_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rockchip_dsi_panel</span> *<span class="title">panel</span> = <span class="title">panel_state</span>-&gt;<span class="title">private</span>;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;zjj.sye.display %s %s %d \n&quot;</span>,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">    msleep(panel-&gt;delay_enable);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RK_PWM_BL</span></span><br><span class="line">    rk_pwm_bl_config(<span class="number">-1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="六-、参考资料-特别感谢-："><a href="#六-、参考资料-特别感谢-：" class="headerlink" title="(六)、参考资料(特别感谢)："></a>(六)、参考资料(特别感谢)：</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/kris_fei/article/details/79003925">（1）【[RK3399][Android7.1] Uboot display 加载过程小结】</a> </p>
<p><a target="_blank" rel="noopener" href="https://docs.khadas.com/zh-cn/edge/ConnectLcd.html#3-%EF%BC%88MIPI-HDMI%EF%BC%89%E5%B1%8F%E5%B9%95%E9%85%8D%E7%BD%AE">（2）【Connect to TS050 Touchscreen】</a> </p>
<p><a target="_blank" rel="noopener" href="http://wiki.t-firefly.com/zh_CN/Firefly-RK3399/driver_lcd.html">（3）【Firefly-RK3399 LCD使用】</a> </p>
<p><a target="_blank" rel="noopener" href="https://hceng.cn/2018/07/19/RK3288%E2%80%94%E2%80%94LCD%E8%A3%B8%E6%9C%BA/">（4）【RK3288——LCD裸机】</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20200619/">https://zhoujinjian.com/posts/20200619/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00012.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20200705/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00013.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 8.1 Display System源码分析（4）：DRM/KMS分析（RK3399）</div></div></a></div><div class="next-post pull-right"><a href="/posts/20200608/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00011.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 8.1 Display System源码分析（2）：LCD显示原理（RK3399）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E3%80%81MIPI%E5%B1%8F%E5%B9%95%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">(一)、MIPI屏幕配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81LCD%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">（1）、LCD使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81Config%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">1.1、Config配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2%E3%80%81DTS%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text">1.2、DTS配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-1%E3%80%81%E4%BD%BF%E8%83%BD%E5%AF%B9%E5%BA%94%E6%98%BE%E7%A4%BA%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.2.1、使能对应显示设备节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-2%E3%80%81%E7%BB%91%E5%AE%9A-VOP"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2.2、绑定 VOP</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-3%E3%80%81%E5%BC%80%E6%9C%BA-logo"><span class="toc-number">2.2.3.</span> <span class="toc-text">1.2.3、开机 logo</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-4%E3%80%81%E7%BB%91%E5%AE%9A-PLL"><span class="toc-number">2.2.4.</span> <span class="toc-text">1.2.4、绑定 PLL</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-5%E3%80%81%E6%89%93%E5%BC%80%E9%9F%B3%E9%A2%91"><span class="toc-number">2.2.5.</span> <span class="toc-text">1.2.5、打开音频</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-6%E3%80%81%E9%85%8D%E7%BD%AEPanel-amp-amp-timing"><span class="toc-number">2.2.6.</span> <span class="toc-text">1.2.6、配置Panel &amp;&amp; timing</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-7%E3%80%81MIPI-DPHY"><span class="toc-number">2.2.7.</span> <span class="toc-text">1.2.7、MIPI-DPHY</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-8%E3%80%81Command"><span class="toc-number">2.2.8.</span> <span class="toc-text">1.2.8、Command</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-2-9%E3%80%81%E8%83%8C%E5%85%89-backlight"><span class="toc-number">2.2.9.</span> <span class="toc-text">1.2.9、背光 backlight</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E3%80%81U-boot-Display-%E6%98%BE%E7%A4%BA%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">(二)、U-boot Display 显示过程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81U-boot-Display-%E6%98%BE%E7%A4%BA%E8%BF%87%E7%A8%8B%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">4.</span> <span class="toc-text">（2）、U-boot Display 显示过程流程图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81vop-dsi-panel%E4%B8%89%E5%A4%A7%E6%A8%A1%E5%9D%97init%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">（三）、vop, dsi, panel三大模块init分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1%E3%80%81panel%E6%A8%A1%E5%9D%97init%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">3.1、panel模块init分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1%E3%80%81rockchip-display-init"><span class="toc-number">6.1.</span> <span class="toc-text">3.1.1、rockchip_display_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2%E3%80%81rockchip-get-crtc"><span class="toc-number">6.2.</span> <span class="toc-text">3.1.2、rockchip_get_crtc()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3%E3%80%81rockchip-get-connector"><span class="toc-number">6.3.</span> <span class="toc-text">3.1.3、rockchip_get_connector()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4%E3%80%81connector-panel-init"><span class="toc-number">6.4.</span> <span class="toc-text">3.1.4、connector_panel_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-5%E3%80%81rockchip-get-panel"><span class="toc-number">6.5.</span> <span class="toc-text">3.1.5、rockchip_get_panel()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-6%E3%80%81rockchip-panel-init"><span class="toc-number">6.6.</span> <span class="toc-text">3.1.6、rockchip_panel_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-7%E3%80%81rk-pwm-bl-config"><span class="toc-number">6.7.</span> <span class="toc-text">3.1.7、rk_pwm_bl_config()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81dsi%E6%A8%A1%E5%9D%97init%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">3.2、dsi模块init分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1%E3%80%81rockchip-show-logo"><span class="toc-number">7.1.</span> <span class="toc-text">3.2.1、rockchip_show_logo()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2%E3%80%81load-bmp-logo"><span class="toc-number">7.2.</span> <span class="toc-text">3.2.2、load_bmp_logo()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-3%E3%80%81display-logo"><span class="toc-number">7.3.</span> <span class="toc-text">3.2.3、display_logo()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-4%E3%80%81display-init"><span class="toc-number">7.4.</span> <span class="toc-text">3.2.4、display_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-5%E3%80%81rockchip-dw-mipi-dsi-init"><span class="toc-number">7.5.</span> <span class="toc-text">3.2.5、rockchip_dw_mipi_dsi_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-6%E3%80%81display-get-timing"><span class="toc-number">7.6.</span> <span class="toc-text">3.2.6、display_get_timing()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3%E3%80%81vop%E6%A8%A1%E5%9D%97init%E5%88%86%E6%9E%90"><span class="toc-number">8.</span> <span class="toc-text">3.3、vop模块init分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1%E3%80%81rockchip-vop-init"><span class="toc-number">8.1.</span> <span class="toc-text">3.3.1、rockchip_vop_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-2%E3%80%81display-set-plane"><span class="toc-number">8.2.</span> <span class="toc-text">3.3.2、display_set_plane()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E3%80%81vop-dsi-panel%E4%B8%89%E5%A4%A7%E6%A8%A1%E5%9D%97prepare%E5%88%86%E6%9E%90"><span class="toc-number">9.</span> <span class="toc-text">（四）、vop, dsi, panel三大模块prepare分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1%E3%80%81vop%E6%A8%A1%E5%9D%97prepare%E5%88%86%E6%9E%90"><span class="toc-number">10.</span> <span class="toc-text">4.1、vop模块prepare分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-1%E3%80%81display-enable"><span class="toc-number">10.1.</span> <span class="toc-text">4.1.1、display_enable()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-2%E3%80%81connector-panel-power-prepare"><span class="toc-number">10.2.</span> <span class="toc-text">4.1.2、connector_panel_power_prepare()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-3%E3%80%81rockchip-vop-prepare"><span class="toc-number">10.3.</span> <span class="toc-text">4.1.3、rockchip_vop_prepare()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2%E3%80%81dsi%E6%A8%A1%E5%9D%97prepare%E5%88%86%E6%9E%90"><span class="toc-number">11.</span> <span class="toc-text">4.2、dsi模块prepare分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1%E3%80%81rockchip-dw-mipi-dsi-prepare"><span class="toc-number">11.1.</span> <span class="toc-text">4.2.1、rockchip_dw_mipi_dsi_prepare()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2%E3%80%81dw-mipi-dsi-vop-routing"><span class="toc-number">11.2.</span> <span class="toc-text">4.2.2、dw_mipi_dsi_vop_routing()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3%E3%80%81rockchip-dw-dsi-pre-init"><span class="toc-number">11.3.</span> <span class="toc-text">4.2.3、rockchip_dw_dsi_pre_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-4%E3%80%81rockchip-dw-dsi-controller-init"><span class="toc-number">11.4.</span> <span class="toc-text">4.2.4、rockchip_dw_dsi_controller_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-5%E3%80%81mipi-dphy-init"><span class="toc-number">11.5.</span> <span class="toc-text">4.2.5、mipi_dphy_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-6%E3%80%81dw-mipi-dsi-phy-init"><span class="toc-number">11.6.</span> <span class="toc-text">4.2.6、dw_mipi_dsi_phy_init()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-7%E3%80%81dw-mipi-dsi-set-mode"><span class="toc-number">11.7.</span> <span class="toc-text">4.2.7、dw_mipi_dsi_set_mode()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3%E3%80%81panel%E6%A8%A1%E5%9D%97prepare%E5%88%86%E6%9E%90"><span class="toc-number">12.</span> <span class="toc-text">4.3、panel模块prepare分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-1%E3%80%81rockchip-panel-prepare"><span class="toc-number">12.1.</span> <span class="toc-text">4.3.1、rockchip_panel_prepare()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E3%80%81vop-dsi-panel%E4%B8%89%E5%A4%A7%E6%A8%A1%E5%9D%97enable%E5%88%86%E6%9E%90"><span class="toc-number">13.</span> <span class="toc-text">（五）、vop, dsi, panel三大模块enable分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1%E3%80%81vop%E6%A8%A1%E5%9D%97enable%E5%88%86%E6%9E%90"><span class="toc-number">14.</span> <span class="toc-text">5.1、vop模块enable分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1%E3%80%81rockchip-display-init"><span class="toc-number">14.1.</span> <span class="toc-text">5.1.1、rockchip_display_init()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2%E3%80%81dsi%E6%A8%A1%E5%9D%97enable%E5%88%86%E6%9E%90"><span class="toc-number">15.</span> <span class="toc-text">5.2、dsi模块enable分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1%E3%80%81rockchip-dw-mipi-dsi-enable"><span class="toc-number">15.1.</span> <span class="toc-text">5.2.1、rockchip_dw_mipi_dsi_enable()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3%E3%80%81panel%E6%A8%A1%E5%9D%97enable%E5%88%86%E6%9E%90"><span class="toc-number">16.</span> <span class="toc-text">5.3、panel模块enable分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1%E3%80%81rockchip-dw-mipi-dsi-enable"><span class="toc-number">16.1.</span> <span class="toc-text">5.3.1、rockchip_dw_mipi_dsi_enable()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD-%E3%80%81%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2-%EF%BC%9A"><span class="toc-number">17.</span> <span class="toc-text">(六)、参考资料(特别感谢)：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>