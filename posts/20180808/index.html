<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android N Display System（5）：Android Display System 系统分析之Display Driver Architecture | zhoujinjian</title><meta name="keywords" content="Android,Graphics,Display"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料、Android 7.1.2 &amp;&amp; Linux（kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除，禁止转载（©Qualcomm Technologies, Inc. 版权所有），谢谢。 【特别感">
<meta property="og:type" content="article">
<meta property="og:title" content="Android N Display System（5）：Android Display System 系统分析之Display Driver Architecture">
<meta property="og:url" content="https://zhoujinjian.com/posts/20180808/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料、Android 7.1.2 &amp;&amp; Linux（kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除，禁止转载（©Qualcomm Technologies, Inc. 版权所有），谢谢。 【特别感">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.23.jpg">
<meta property="article:published_time" content="2018-08-08T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.952Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Graphics">
<meta property="article:tag" content="Display">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.23.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20180808/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.23.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android N Display System（5）：Android Display System 系统分析之Display Driver Architecture</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-08-08T01:25:00.000Z" title="发表于 2018-08-08 09:25:00">2018-08-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.952Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Display/">Display</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<p>注：文章都是通过阅读各位前辈总结的资料、Android 7.1.2 &amp;&amp; Linux（kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除，禁止转载（©Qualcomm Technologies, Inc. 版权所有），谢谢。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/eliot_shao/article/details/74926010">【特别感谢 - 高通Android平台-应用空间操作framebuffer dump LCD总结】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012719256/article/details/52096727">【特别感谢 -  linux qcom LCD framwork】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347">【特别感谢 -  msm8610 lcd driver code analysis】</a></p>
<p>Google Pixel、Pixel XL 内核代码（文章基于 Kernel-3.18）：<br> <a target="_blank" rel="noopener" href="https://github.com/matthewdalex/marlin">Kernel source for Pixel and Pixel XL - GitHub</a></p>
<p>AOSP 源码（文章基于 Android 7.1.2）：<br> <a target="_blank" rel="noopener" href="https://testerhome.com/topics/2229"> Android 系统全套源代码分享 (更新到 8.1.0_r1)</a></p>
<p> 🌀🌀：专注于Linux &amp;&amp; Android Multimedia（Camera、Video、Audio、Display）系统分析与研究</p>
<p>【Android Display System 系统分析系列】：<br>【Android Display System（1）：Android 7.1.2 (Android N) Android Graphics 系统 分析】<br>【Android Display System（2）：Android Display System 系统分析之Android EGL &amp;&amp; OpenGL】<br>【Android Display System（3）：Android Display System 系统分析之HardwareRenderer.draw()绘制流程分析】<br>【Android Display System（4）：Android Display System 系统分析之Gralloc &amp;&amp; HWComposer模块分析】<br>【Android Display System（5）：Android Display System 系统分析之Display Driver Architecture】 </p>
<hr>
<p>路径：<br>kernel\msm-3.18\drivers\video\msm\mdss</p>
<p> MDSS driver software block diagram</p>
<ul>
<li>mdss_fb → Top-level IOCTL/native framebufferinterface</li>
<li>mdss_mdp.c → MDP resources(clocks/irq/bus-bw/power)</li>
<li>mdss_mdp_overlay → Overlay/DMA top-levelAPI</li>
<li>mdss_mdp_ctl → Controls the hardware abstraction to club the (LM + DSPP + Ping-pong +<br>interface)</li>
<li>mdss_mdp_pipe → SRC pipe related handling</li>
<li>mdss_mdp_intf_cmd/mdss_mdp_intf_video/mdss_mdp_intf_writeback → MDP panel<br>interface relatedhandling</li>
<li>mdss_mdp_pp → Postprocessing related implementation</li>
<li>mdss_mdp_rotator → Rotator APIs (overlay_set/overlay_playinterface)</li>
<li>mdss_mdp_pp.c → Postprocessing relatedmaterial</li>
</ul>
<hr>
<p><strong>注：</strong>首先说明，由于博主不是kernel开发方向的，可能理解不够透彻，还请看官见谅，主要是为了理解Kernel Display原理。为了加深对显示屏工作原理的理解，首先先看两个操作LCD显示屏的例子<br>绪论（总体架构图）：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-01-Display-Architecture.png" alt="Alt text | center"></p>
<h4 id="（一）、直接操作framebuffer显示图像"><a href="#（一）、直接操作framebuffer显示图像" class="headerlink" title="（一）、直接操作framebuffer显示图像"></a>（一）、直接操作framebuffer显示图像</h4><h5 id="1-1、直接操作framebuffer显示图像"><a href="#1-1、直接操作framebuffer显示图像" class="headerlink" title="1.1、直接操作framebuffer显示图像"></a>1.1、直接操作framebuffer显示图像</h5><h5 id="1-1-1、源代码"><a href="#1-1-1、源代码" class="headerlink" title="1.1.1、源代码"></a>1.1.1、源代码</h5><p><strong>panel_test.c</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fb.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;yellow_face.zif&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> fbfd = <span class="number">0</span>;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">vinfo</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">finfo</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmapinfo</span>;</span>  </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> screensize = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">char</span> *fbp = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> location = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">int</span> b,g,r;  </span><br><span class="line">    <span class="comment">// Open the file for reading and writing  </span></span><br><span class="line">    fbfd = open(<span class="string">&quot;/dev/graphics/fb0&quot;</span>, O_RDWR,<span class="number">0</span>);                    <span class="comment">// 打开Frame Buffer设备  </span></span><br><span class="line">    <span class="keyword">if</span> (fbfd &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Error: cannot open framebuffer device.%x\n&quot;</span>,fbfd);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The framebuffer device was opened successfully.\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Get fixed screen information  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOGET_FSCREENINFO, &amp;finfo)) &#123;            <span class="comment">// 获取设备固有信息  </span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Error reading fixed information.\n&quot;</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">2</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\ntype:0x%x\n&quot;</span>, finfo.type );                            <span class="comment">// FrameBuffer 类型,如0为象素  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;visual:%d\n&quot;</span>, finfo.visual );                        <span class="comment">// 视觉类型：如真彩2，伪彩3   </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;line_length:%d\n&quot;</span>, finfo.line_length );        <span class="comment">// 每行长度  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nsmem_start:0x%lx,smem_len:%u\n&quot;</span>, finfo.smem_start, finfo.smem_len ); <span class="comment">// 映象RAM的参数  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_start:0x%lx ,mmio_len:%u\n&quot;</span>, finfo.mmio_start, finfo.mmio_len );  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">// Get variable screen information  </span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOGET_VSCREENINFO, &amp;vinfo)) &#123;            <span class="comment">// 获取设备可变信息  </span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Error reading variable information.\n&quot;</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">3</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%dx%d, %dbpp,xres_virtual=%d,yres_virtual=%dvinfo.xoffset=%d,vinfo.yoffset=%d\n&quot;</span>, vinfo.xres, vinfo.yres, vinfo.bits_per_pixel,vinfo.xres_virtual,vinfo.yres_virtual,vinfo.xoffset,vinfo.yoffset);  </span><br><span class="line"></span><br><span class="line">    screensize = finfo.line_length * vinfo.yres_virtual;</span><br><span class="line">    <span class="comment">// Map the device to memory 通过mmap系统调用将framebuffer内存映射到用户空间,并返回映射后的起始地址  </span></span><br><span class="line">    fbp = (<span class="keyword">char</span> *)mmap(<span class="number">0</span>, screensize, PROT_READ | PROT_WRITE, MAP_SHARED,fbfd, <span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int</span>)fbp == <span class="number">-1</span>) &#123;  </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Error: failed to map framebuffer device to memory.\n&quot;</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">4</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The framebuffer device was mapped to memory successfully.\n&quot;</span>);  </span><br><span class="line"><span class="comment">/***************exampel 1**********************/</span></span><br><span class="line">    b = <span class="number">10</span>;</span><br><span class="line">    g = <span class="number">100</span>;</span><br><span class="line">    r = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">for</span> ( y = <span class="number">0</span>; y &lt; <span class="number">340</span>; y++ )</span><br><span class="line">        <span class="keyword">for</span> ( x = <span class="number">0</span>; x &lt; <span class="number">420</span>; x++ ) &#123; </span><br><span class="line">      </span><br><span class="line">         location = (x+<span class="number">100</span>) * (vinfo.bits_per_pixel/<span class="number">8</span>) + </span><br><span class="line">             (y+<span class="number">100</span>) * finfo.line_length; </span><br><span class="line">      </span><br><span class="line">         <span class="keyword">if</span> ( vinfo.bits_per_pixel == <span class="number">32</span> ) &#123;        <span class="comment">//          </span></span><br><span class="line">                        *(fbp + location) = b; <span class="comment">// Some blue  </span></span><br><span class="line">                        *(fbp + location + <span class="number">1</span>) = g;             <span class="comment">// A little green  </span></span><br><span class="line">                        *(fbp + location + <span class="number">2</span>) = r;             <span class="comment">// A lot of red  </span></span><br><span class="line">                        *(fbp + location + <span class="number">3</span>) = <span class="number">0</span>;     <span class="comment">// No transparency  </span></span><br><span class="line">         &#125;</span><br><span class="line">      </span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">/*****************exampel 1********************/</span></span><br><span class="line"><span class="comment">/*****************exampel 2********************/</span>        </span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">char</span> *pTemp = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)fbp;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line">    <span class="comment">//起始坐标(x,y),终点坐标(right,bottom)</span></span><br><span class="line">    x = <span class="number">400</span>;</span><br><span class="line">    y = <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">int</span> right = <span class="number">700</span>;<span class="comment">//vinfo.xres;</span></span><br><span class="line">    <span class="keyword">int</span> bottom = <span class="number">1000</span>;<span class="comment">//vinfo.yres;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i=y; i&lt; bottom; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j=x; j&lt;right; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">short</span> data = yellow_face_data[(((i-y)  % <span class="number">128</span>) * <span class="number">128</span>) + ((j-x) %<span class="number">128</span>)];</span><br><span class="line">            pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">2</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0xF800</span>) &gt;&gt; <span class="number">11</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">            pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0x7E0</span>) &gt;&gt; <span class="number">5</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">            pTemp[i*finfo.line_length + (j*<span class="number">4</span>) + <span class="number">0</span>] = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((data &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"><span class="comment">/*****************exampel 2********************/</span>    </span><br><span class="line"><span class="comment">//note：vinfo.xoffset =0 vinfo.yoffset =0 否则FBIOPAN_DISPLAY不成功</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fbfd, FBIOPAN_DISPLAY, &amp;vinfo)) &#123;    </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Error FBIOPAN_DISPLAY information.\n&quot;</span>);  </span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">5</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    munmap(fbp,finfo.smem_len);<span class="comment">//finfo.smem_len == screensize == finfo.line_length * vinfo.yres_virtual </span></span><br><span class="line">    close(fbfd);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Android.mk</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Copyright <span class="number">2006</span><span class="number">-2014</span> The Android Open Source Project</span><br><span class="line"></span><br><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES:= panel_test.c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOCAL_SHARED_LIBRARIES        := $(common_libs) libqdutils libdl liblog libbase libcutils</span><br><span class="line">LOCAL_C_INCLUDES              := $(common_includes) $(kernel_includes)</span><br><span class="line">LOCAL_ADDITIONAL_DEPENDENCIES := $(common_deps) $(kernel_deps)</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE := panel_test</span><br><span class="line"></span><br><span class="line">LOCAL_CFLAGS := -Werror</span><br><span class="line"></span><br><span class="line">include $(BUILD_EXECUTABLE)</span><br><span class="line"></span><br><span class="line">include $(call first-makefiles-under,$(LOCAL_PATH))</span><br></pre></td></tr></table></figure>
<p><strong>yellow_face.zif</strong><br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-yellow_face.zif">yellow_face.zif</a></p>
<h5 id="1-1-2、编译测试"><a href="#1-1-2、编译测试" class="headerlink" title="1.1.2、编译测试"></a>1.1.2、编译测试</h5><p>编译会生成panel_test，然后进行测试。</p>
<blockquote>
<p>注意事项：<br>1、adb shell stop 杀掉surfaceflinger 之后在测试；<br>2、设置背光 echo 255 &gt; /sys/class/leds/lcd-backlight/brightness</p>
</blockquote>
<blockquote>
<p>1、连接adb<br>2、adb push panel_test system/bin<br>3、进入adb shell<br>4、stop<br>5、echo 255 &gt; /sys/class/leds/lcd-backlight/brightness<br>6、system/bin/panel_test</p>
</blockquote>
<h5 id="1-1-3、显示效果"><a href="#1-1-3、显示效果" class="headerlink" title="1.1.3、显示效果"></a>1.1.3、显示效果</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-02-Qcom_FrameBuffer_test_.gif" alt="Alt text | center"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-03-yellow_face_zif_test.jpg" alt="Alt text | center"></p>
<h5 id="1-1-4、视频（加深理解、自☯备☯梯☯子）"><a href="#1-1-4、视频（加深理解、自☯备☯梯☯子）" class="headerlink" title="1.1.4、视频（加深理解、自☯备☯梯☯子）"></a>1.1.4、视频（加深理解、自☯备☯梯☯子）</h5><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=BUPPyR6VasI">Android Frame Buffer and Screen Shots Tutorial</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7n_hDZ6kHjc">Mplayer on Android Through Chroot and Frame Buffer</a></p>
<h5 id="1-1-5、驱动总体概览图"><a href="#1-1-5、驱动总体概览图" class="headerlink" title="1.1.5、驱动总体概览图"></a>1.1.5、驱动总体概览图</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-04-msm8x25-display-overview.png" alt="Alt text | center"></p>
<h4 id="（二）、FrameBuffer驱动程序分析"><a href="#（二）、FrameBuffer驱动程序分析" class="headerlink" title="（二）、FrameBuffer驱动程序分析"></a>（二）、FrameBuffer驱动程序分析</h4><p>FrameBuffer通常作为LCD控制器或者其他显示设备的驱动，FrameBuffer驱动是一个字符设备，设备节点是/dev/fbX（Android 设备为/dev/graphics/fb0），主设备号为29，次设备号递增，用户可以将Framebuffer看成是显示内存的一个映像，将其映射到进程地址空间之后，就可以直接进行读写操作，而写操作可以立即反应在屏幕上。这种操作是抽象的，统一的。用户不必关心物理显存的位置、换页机制等等具体细节。这些都是由Framebuffer设备驱动来完成的。Framebuffer设备为上层应用程序提供系统调用，也为下一层的特定硬件驱动提供接口；那些底层硬件驱动需要用到这儿的接口来向系统内核注册它们自己。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-05-mdss-driver-architecture.png" alt="Alt text | center"></p>
<p>Linux中的PCI设备可以将其控制寄存器映射到物理内存空间，而后，对这些控制寄存器的访问变成了对理内存的访问，因此，这些寄存器又被称为”memio”。一旦被映射到物理内存，Linux的普通进程就可以通过mmap将这些内存I/O映射到进程地址空间，这样就可以直接访问这些寄存器了。</p>
<p>FrameBuffer设备属于字符设备，采用了文件层—驱动层的接口方式，Linux为帧缓冲设备定义了驱动层的接口fb_info结构，在文件层上，用户调用file_operations的函数操作，间接调用fb_info中的fb_ops函数集来操作硬件。</p>
<h5 id="2-1、-Framebuffer数据结构"><a href="#2-1、-Framebuffer数据结构" class="headerlink" title="2.1、 Framebuffer数据结构"></a>2.1、 Framebuffer数据结构</h5><h5 id="2-1-1、-fb-info"><a href="#2-1-1、-fb-info" class="headerlink" title="2.1.1、 fb_info"></a>2.1.1、 fb_info</h5><p>fb_info是Linux为帧缓冲设备定义的驱动层接口。它不仅包含了底层函数，而且还有记录设备状态的数据。每个帧缓冲设备都与一个fb_info结构相对应。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;kernel\include\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span> count;</span><br><span class="line">    <span class="keyword">int</span> node;</span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span>        <span class="comment">/* Lock for open/release/ioctl funcs */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mm_lock</span>;</span>        <span class="comment">/* Lock for fb_mmap and smem_* fields */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span>    <span class="comment">/* Current var */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> <span class="title">fix</span>;</span>    <span class="comment">/* Current fix */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_monspecs</span> <span class="title">monspecs</span>;</span>    <span class="comment">/* Current Monitor specs */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">queue</span>;</span>    <span class="comment">/* Framebuffer event queue */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">pixmap</span>;</span>    <span class="comment">/* Image hardware mapper */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_pixmap</span> <span class="title">sprite</span>;</span>    <span class="comment">/* Cursor hardware mapper */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_cmap</span> <span class="title">cmap</span>;</span>        <span class="comment">/* Current cmap */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">modelist</span>;</span>      <span class="comment">/* mode list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> *<span class="title">mode</span>;</span>    <span class="comment">/* current mode */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span>        <span class="comment">/* current file node */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_DEFERRED_IO</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span> <span class="title">deferred_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_deferred_io</span> *<span class="title">fbdefio</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> *<span class="title">fbops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>        <span class="comment">/* This is the parent */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>        <span class="comment">/* This is this fb device */</span></span><br><span class="line">    <span class="keyword">int</span> class_flag;                    <span class="comment">/* private sysfs flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_TILEBLITTING</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_tile_ops</span> *<span class="title">tileops</span>;</span>    <span class="comment">/* Tile Blitting */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">char</span> __iomem *screen_base;    <span class="comment">/* Virtual address */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> screen_size;    <span class="comment">/* Amount of ioremapped VRAM or 0 */</span> </span><br><span class="line">    <span class="keyword">void</span> *pseudo_palette;        <span class="comment">/* Fake palette of 16 colors */</span> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FBINFO_STATE_RUNNING    0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FBINFO_STATE_SUSPENDED    1</span></span><br><span class="line">    u32 state;            <span class="comment">/* Hardware state i.e suspend */</span></span><br><span class="line">    <span class="keyword">void</span> *fbcon_par;                <span class="comment">/* fbcon use-only private area */</span></span><br><span class="line">    <span class="comment">/* From here on everything is device dependent */</span></span><br><span class="line">    <span class="keyword">void</span> *par;</span><br><span class="line">    <span class="comment">/* we need the PCI or similar aperture base/size not</span></span><br><span class="line"><span class="comment">       smem_start/size as smem_start may just be an object</span></span><br><span class="line"><span class="comment">       allocated inside the aperture so may not actually overlap */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">apertures_struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">aperture</span> &#123;</span></span><br><span class="line">            <span class="keyword">resource_size_t</span> base;</span><br><span class="line">            <span class="keyword">resource_size_t</span> size;</span><br><span class="line">        &#125; ranges[<span class="number">0</span>];</span><br><span class="line">    &#125; *apertures;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> skip_vt_switch; <span class="comment">/* no VT switch on suspend/resume required */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="2-1-2、fb-var-screeninfo"><a href="#2-1-2、fb-var-screeninfo" class="headerlink" title="2.1.2、fb_var_screeninfo"></a>2.1.2、fb_var_screeninfo</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-06-xres-yres.png" alt="Alt text | center"></p>
<p>fb_var_screeninfo：用于记录用户可修改的显示控制器参数，包括屏幕分辨率、每个像素点的比特数等</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\uapi\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> &#123;</span>  </span><br><span class="line">    __u32 xres;         <span class="comment">/* 行可见像素*/</span>  </span><br><span class="line">    __u32 yres;         <span class="comment">/* 列可见像素*/</span>  </span><br><span class="line">    __u32 xres_virtual; <span class="comment">/* 行虚拟像素*/</span>  </span><br><span class="line">    __u32 yres_virtual; <span class="comment">/* 列虚拟像素*/</span>  </span><br><span class="line">    __u32 xoffset;      <span class="comment">/* 水平偏移量*/</span>  </span><br><span class="line">    __u32 yoffset;      <span class="comment">/* 垂直偏移量*/</span>  </span><br><span class="line">    __u32 bits_per_pixel;<span class="comment">/*每个像素所占bit位数*/</span>  </span><br><span class="line">    __u32 grayscale;    <span class="comment">/* 灰色刻度*/</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">red</span>;</span> <span class="comment">/* bitfield in fb mem if true color, */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">green</span>;</span>   <span class="comment">/* else only length is significant */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">blue</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_bitfield</span> <span class="title">transp</span>;</span>  <span class="comment">/* transparency         */</span>    </span><br><span class="line">    __u32 nonstd;           <span class="comment">/* != 0 Non standard pixel format */</span>  </span><br><span class="line">    __u32 activate;         <span class="comment">/* see FB_ACTIVATE_*        */</span>  </span><br><span class="line">    __u32 height;           <span class="comment">/* 图像高度*/</span>  </span><br><span class="line">    __u32 width;            <span class="comment">/* 图像宽度*/</span>  </span><br><span class="line">    __u32 accel_flags;      <span class="comment">/* (OBSOLETE) see fb_info.flags */</span>  </span><br><span class="line">    __u32 pixclock;         <span class="comment">/* pixel clock in ps (pico seconds) */</span>  </span><br><span class="line">    __u32 left_margin;      <span class="comment">/* time from sync to picture    */</span>  </span><br><span class="line">    __u32 right_margin;     <span class="comment">/* time from picture to sync    */</span>  </span><br><span class="line">    __u32 upper_margin;     <span class="comment">/* time from sync to picture    */</span>  </span><br><span class="line">    __u32 lower_margin;  </span><br><span class="line">    __u32 hsync_len;        <span class="comment">/* length of horizontal sync    */</span>  </span><br><span class="line">    __u32 vsync_len;        <span class="comment">/* length of vertical sync  */</span>  </span><br><span class="line">    __u32 sync;         <span class="comment">/* see FB_SYNC_*        */</span>  </span><br><span class="line">    __u32 vmode;            <span class="comment">/* see FB_VMODE_*       */</span>  </span><br><span class="line">    __u32 rotate;           <span class="comment">/* angle we rotate counter clockwise */</span>  </span><br><span class="line">    __u32 reserved[<span class="number">5</span>];      <span class="comment">/* Reserved for future compatibility */</span>  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="2-1-3、fb-fix-screeninfo"><a href="#2-1-3、fb-fix-screeninfo" class="headerlink" title="2.1.3、fb_fix_screeninfo"></a>2.1.3、fb_fix_screeninfo</h5><p>fb_fix_screeninfo：记录了用户不能修改的显示控制器的参数，这些参数是在驱动初始化时设置的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\uapi\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> id[<span class="number">16</span>];            <span class="comment">/* identification string eg &quot;TT Builtin&quot; */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> smem_start;    <span class="comment">/* Start of frame buffer mem */</span></span><br><span class="line">                    <span class="comment">/* (physical address) */</span></span><br><span class="line">    __u32 smem_len;            <span class="comment">/* Length of frame buffer mem */</span></span><br><span class="line">    __u32 type;            <span class="comment">/* see FB_TYPE_*        */</span></span><br><span class="line">    __u32 type_aux;            <span class="comment">/* Interleave for interleaved Planes */</span></span><br><span class="line">    __u32 visual;            <span class="comment">/* see FB_VISUAL_*        */</span> </span><br><span class="line">    __u16 xpanstep;            <span class="comment">/* zero if no hardware panning  */</span></span><br><span class="line">    __u16 ypanstep;            <span class="comment">/* zero if no hardware panning  */</span></span><br><span class="line">    __u16 ywrapstep;        <span class="comment">/* zero if no hardware ywrap    */</span></span><br><span class="line">    __u32 line_length;        <span class="comment">/* length of a line in bytes    */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> mmio_start;    <span class="comment">/* Start of Memory Mapped I/O   */</span></span><br><span class="line">                    <span class="comment">/* (physical address) */</span></span><br><span class="line">    __u32 mmio_len;            <span class="comment">/* Length of Memory Mapped I/O  */</span></span><br><span class="line">    __u32 accel;            <span class="comment">/* Indicate to driver which    */</span></span><br><span class="line">                    <span class="comment">/*  specific chip/card we have    */</span></span><br><span class="line">    __u16 capabilities;        <span class="comment">/* see FB_CAP_*            */</span></span><br><span class="line">    __u16 reserved[<span class="number">2</span>];        <span class="comment">/* Reserved for future compatibility */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>fb_ops是提供给底层设备驱动的一个接口。当我们编写一个FrameBuffer的时候，就要依照Linux FrameBuffer编程的套路，填写fb_ops结构体。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\include\linux\fb.h]</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> &#123;</span></span><br><span class="line">    <span class="comment">/* open/release and usage marking */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_open)(struct fb_info *info, <span class="keyword">int</span> user);</span><br><span class="line">    <span class="keyword">int</span> (*fb_release)(struct fb_info *info, <span class="keyword">int</span> user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* For framebuffers with strange non linear layouts or that do not</span></span><br><span class="line"><span class="comment">     * work with normal memory mapped access</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">ssize_t</span> (*fb_read)(struct fb_info *info, <span class="keyword">char</span> __user *buf,</span><br><span class="line">               <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos);</span><br><span class="line">    <span class="keyword">ssize_t</span> (*fb_write)(struct fb_info *info, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span><br><span class="line">                <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* checks var and eventually tweaks it to something supported,</span></span><br><span class="line"><span class="comment">     * DO NOT MODIFY PAR */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_check_var)(struct fb_var_screeninfo *var, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set the video mode according to info-&gt;var */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_set_par)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set color register */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_setcolreg)(<span class="keyword">unsigned</span> regno, <span class="keyword">unsigned</span> red, <span class="keyword">unsigned</span> green,</span><br><span class="line">                <span class="keyword">unsigned</span> blue, <span class="keyword">unsigned</span> transp, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set color registers in batch */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_setcmap)(struct fb_cmap *cmap, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* blank display */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_blank)(<span class="keyword">int</span> blank, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* pan display */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_pan_display)(struct fb_var_screeninfo *var, struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Draws a rectangle */</span></span><br><span class="line">    <span class="keyword">void</span> (*fb_fillrect) (struct fb_info *info, <span class="keyword">const</span> struct fb_fillrect *rect);</span><br><span class="line">    <span class="comment">/* Copy data from area to another */</span></span><br><span class="line">    <span class="keyword">void</span> (*fb_copyarea) (struct fb_info *info, <span class="keyword">const</span> struct fb_copyarea *region);</span><br><span class="line">    <span class="comment">/* Draws a image to the display */</span></span><br><span class="line">    <span class="keyword">void</span> (*fb_imageblit) (struct fb_info *info, <span class="keyword">const</span> struct fb_image *image);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Draws cursor */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_cursor) (struct fb_info *info, struct fb_cursor *cursor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Rotates the display */</span></span><br><span class="line">    <span class="keyword">void</span> (*fb_rotate)(struct fb_info *info, <span class="keyword">int</span> angle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* wait for blit idle, optional */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_sync)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* perform fb specific ioctl (optional) */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_ioctl)(struct fb_info *info, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* perform fb specific ioctl v2 (optional) - provides file param */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_ioctl_v2)(struct fb_info *info, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">long</span> arg, struct file *file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle 32bit compat ioctl (optional) */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_compat_ioctl)(struct fb_info *info, <span class="keyword">unsigned</span> cmd,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle 32bit compat ioctl (optional) */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_compat_ioctl_v2)(struct fb_info *info, <span class="keyword">unsigned</span> cmd,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">long</span> arg, struct file *file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* perform fb specific mmap */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_mmap)(struct fb_info *info, struct vm_area_struct *vma);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* get capability given var */</span></span><br><span class="line">    <span class="keyword">void</span> (*fb_get_caps)(struct fb_info *info, struct fb_blit_caps *caps,</span><br><span class="line">                struct fb_var_screeninfo *var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* teardown any resources to do with this framebuffer */</span></span><br><span class="line">    <span class="keyword">void</span> (*fb_destroy)(struct fb_info *info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* called at KDB enter and leave time to prepare the console */</span></span><br><span class="line">    <span class="keyword">int</span> (*fb_debug_enter)(struct fb_info *info);</span><br><span class="line">    <span class="keyword">int</span> (*fb_debug_leave)(struct fb_info *info);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="2-2、Framebuffer驱动注册过程"><a href="#2-2、Framebuffer驱动注册过程" class="headerlink" title="2.2、Framebuffer驱动注册过程"></a>2.2、Framebuffer驱动注册过程</h5><p>在系统启动时，内核调用所有注册驱动程序的驱动程序初始化函数。 为了帧缓冲区驱动程序，调用mdss_fb_init。 mdss_fb_init注册mdss_fb_driver。驱动在mdss_fb.c文件中注册。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdss_fb_driver</span> = &#123;</span></span><br><span class="line">    .probe = mdss_fb_probe,</span><br><span class="line">    .remove = mdss_fb_remove,</span><br><span class="line">    .suspend = mdss_fb_suspend,</span><br><span class="line">    .resume = mdss_fb_resume,</span><br><span class="line">    .shutdown = mdss_fb_shutdown,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;mdss_fb&quot;</span>,</span><br><span class="line">        .of_match_table = mdss_fb_dt_match,</span><br><span class="line">        .pm = &amp;mdss_fb_pm_ops,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在调用init之后，内核调用每个平台驱动程序的探测函数。 在调用mdss_fb_probe时，函数执行资源分配并调用mdss_fb_register。 可以有多个帧缓冲区（fb）设备（节点）。 该驱动程序通过调用mdss_fb_register来注册各个fb设备，后者又调用register_framebuffer。 HDMI和主显示器是各个fb设备的例子。 以下操作已注册：</p>
<p>首先看一下mdss_fb_probe()函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msm_fb_data_type</span> *<span class="title">mfd</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_data</span> *<span class="title">pdata</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">    pdata = dev_get_platdata(&amp;pdev-&gt;dev);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * alloc framebuffer info + par data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fbi = framebuffer_alloc(<span class="keyword">sizeof</span>(struct msm_fb_data_type), <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    mfd = (struct msm_fb_data_type *)fbi-&gt;par;</span><br><span class="line">    mfd-&gt;key = MFD_KEY;</span><br><span class="line">    mfd-&gt;fbi = fbi;</span><br><span class="line">    mfd-&gt;panel_info = &amp;pdata-&gt;panel_info;</span><br><span class="line">    mfd-&gt;panel.type = pdata-&gt;panel_info.type;</span><br><span class="line">    mfd-&gt;panel.id = mfd-&gt;index;</span><br><span class="line">    mfd-&gt;fb_page = MDSS_FB_NUM;</span><br><span class="line">    mfd-&gt;index = fbi_list_index;</span><br><span class="line">    mfd-&gt;mdp_fb_page_protection = MDP_FB_PAGE_PROTECTION_WRITECOMBINE;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;ext_ad_ctrl = <span class="number">-1</span>;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    platform_set_drvdata(pdev, mfd);</span><br><span class="line"></span><br><span class="line">    rc = mdss_fb_register(mfd);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先调用framebuffer_alloc()函数返回一个fb_info 结构体，然后调用mdss_fb_register(mfd)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_fb.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdss_fb_register</span><span class="params">(struct msm_fb_data_type *mfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -ENODEV;</span><br><span class="line">    <span class="keyword">int</span> bpp;</span><br><span class="line">    <span class="keyword">char</span> panel_name[<span class="number">20</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_panel_info</span> *<span class="title">panel_info</span> = <span class="title">mfd</span>-&gt;<span class="title">panel_info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fbi</span> = <span class="title">mfd</span>-&gt;<span class="title">fbi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> *<span class="title">fix</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> *<span class="title">var</span>;</span></span><br><span class="line">    <span class="keyword">int</span> *id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * fb info initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fix = &amp;fbi-&gt;fix;</span><br><span class="line">    var = &amp;fbi-&gt;var;</span><br><span class="line"></span><br><span class="line">    fix-&gt;type_aux = <span class="number">0</span>;    <span class="comment">/* if type == FB_TYPE_INTERLEAVED_PLANES */</span></span><br><span class="line">    fix-&gt;visual = FB_VISUAL_TRUECOLOR;    <span class="comment">/* True Color */</span></span><br><span class="line">    fix-&gt;ywrapstep = <span class="number">0</span>;    <span class="comment">/* No support */</span></span><br><span class="line">    fix-&gt;mmio_start = <span class="number">0</span>;    <span class="comment">/* No MMIO Address */</span></span><br><span class="line">    fix-&gt;mmio_len = <span class="number">0</span>;    <span class="comment">/* No MMIO Address */</span></span><br><span class="line">    fix-&gt;accel = FB_ACCEL_NONE;<span class="comment">/* FB_ACCEL_MSM needes to be added in fb.h */</span></span><br><span class="line"></span><br><span class="line">    var-&gt;xoffset = <span class="number">0</span>,    <span class="comment">/* Offset from virtual to visible */</span></span><br><span class="line">    var-&gt;yoffset = <span class="number">0</span>,    <span class="comment">/* resolution */</span></span><br><span class="line">    var-&gt;grayscale = <span class="number">0</span>,    <span class="comment">/* No graylevels */</span></span><br><span class="line">    var-&gt;nonstd = <span class="number">0</span>,    <span class="comment">/* standard pixel format */</span></span><br><span class="line">    var-&gt;activate = FB_ACTIVATE_VBL,    <span class="comment">/* activate it at vsync */</span></span><br><span class="line">    var-&gt;height = <span class="number">-1</span>,    <span class="comment">/* height of picture in mm */</span></span><br><span class="line">    var-&gt;width = <span class="number">-1</span>,    <span class="comment">/* width of picture in mm */</span></span><br><span class="line">    var-&gt;accel_flags = <span class="number">0</span>,    <span class="comment">/* acceleration flags */</span></span><br><span class="line">    var-&gt;sync = <span class="number">0</span>,    <span class="comment">/* see FB_SYNC_* */</span></span><br><span class="line">    var-&gt;rotate = <span class="number">0</span>,    <span class="comment">/* angle we rotate counter clockwise */</span></span><br><span class="line">    mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (mfd-&gt;fb_imgType) &#123;</span><br><span class="line">    <span class="keyword">case</span> MDP_RGB_565:</span><br><span class="line">        ......</span><br><span class="line">        var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">        var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">        bpp = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> MDP_RGB_888:</span><br><span class="line">        ......</span><br><span class="line">        var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">        var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">        bpp = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> MDP_ARGB_8888:</span><br><span class="line">        ......</span><br><span class="line">        var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">        var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line">        bpp = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> MDP_RGBA_8888:</span><br><span class="line">        ......</span><br><span class="line">        var-&gt;transp.offset = <span class="number">24</span>;</span><br><span class="line">        var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line">        bpp = <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> MDP_YCRYCB_H2V1:</span><br><span class="line">        ......</span><br><span class="line">        var-&gt;transp.offset = <span class="number">0</span>;</span><br><span class="line">        var-&gt;transp.length = <span class="number">0</span>;</span><br><span class="line">        bpp = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdss_panelinfo_to_fb_var(panel_info, var);</span><br><span class="line"></span><br><span class="line">    fix-&gt;type = panel_info-&gt;is_3d_panel;</span><br><span class="line">    <span class="keyword">if</span> (mfd-&gt;mdp.fb_stride)</span><br><span class="line">        fix-&gt;line_length = mfd-&gt;mdp.fb_stride(mfd-&gt;index, var-&gt;xres,</span><br><span class="line">                            bpp);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fix-&gt;line_length = var-&gt;xres * bpp;</span><br><span class="line"></span><br><span class="line">    var-&gt;xres_virtual = var-&gt;xres;</span><br><span class="line">    var-&gt;yres_virtual = panel_info-&gt;yres * mfd-&gt;fb_page;</span><br><span class="line">    var-&gt;bits_per_pixel = bpp * <span class="number">8</span>;    <span class="comment">/* FrameBuffer color depth */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Populate smem length here for uspace to get the</span></span><br><span class="line"><span class="comment">     * Framebuffer size when FBIO_FSCREENINFO ioctl is called.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    fix-&gt;smem_len = PAGE_ALIGN(fix-&gt;line_length * var-&gt;yres) * mfd-&gt;fb_page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* id field for fb app  */</span></span><br><span class="line">    id = (<span class="keyword">int</span> *)&amp;mfd-&gt;panel;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(fix-&gt;id, <span class="keyword">sizeof</span>(fix-&gt;id), <span class="string">&quot;mdssfb_%x&quot;</span>, (u32) *id);</span><br><span class="line"></span><br><span class="line">    fbi-&gt;fbops = &amp;mdss_fb_ops;</span><br><span class="line">    fbi-&gt;flags = FBINFO_FLAG_DEFAULT;</span><br><span class="line">    fbi-&gt;pseudo_palette = mdss_fb_pseudo_palette;</span><br><span class="line"></span><br><span class="line">    mfd-&gt;ref_cnt = <span class="number">0</span>;</span><br><span class="line">    mfd-&gt;panel_power_state = MDSS_PANEL_POWER_OFF;</span><br><span class="line">    mfd-&gt;dcm_state = DCM_UNINIT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mdss_fb_alloc_fbmem(mfd))</span><br><span class="line">        pr_warn(<span class="string">&quot;unable to allocate fb memory in fb register\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    ret = fb_alloc_cmap(&amp;fbi-&gt;cmap, <span class="number">256</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        pr_err(<span class="string">&quot;fb_alloc_cmap() failed!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (register_framebuffer(fbi) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        fb_dealloc_cmap(&amp;fbi-&gt;cmap);</span><br><span class="line">        mfd-&gt;op_enable = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(panel_name, ARRAY_SIZE(panel_name), <span class="string">&quot;mdss_panel_fb%d&quot;</span>,</span><br><span class="line">        mfd-&gt;index);</span><br><span class="line">    mdss_panel_debugfs_init(panel_info, panel_name);</span><br><span class="line">    pr_info(<span class="string">&quot;FrameBuffer[%d] %dx%d registered successfully!\n&quot;</span>, mfd-&gt;index,</span><br><span class="line">                    fbi-&gt;var.xres, fbi-&gt;var.yres);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>任何一个特定硬件Framebuffer驱动在初始化时都必须向fbmem.c注册，FrameBuffer模块提供了驱动注册接口函数register_framebuffer：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\fbdev\core\fbmem.c]</span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">register_framebuffer(struct fb_info *fb_info)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;registration_lock);</span><br><span class="line">    ret = do_register_framebuffer(fb_info);</span><br><span class="line">    mutex_unlock(&amp;registration_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数fb_info描述特定硬件的FrameBuffer驱动信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\fbdev\core\fbmem.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_register_framebuffer</span><span class="params">(struct fb_info *fb_info)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> i;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_event</span> <span class="title">event</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> <span class="title">mode</span>;</span>  </span><br><span class="line">    <span class="keyword">if</span> (fb_check_foreignness(fb_info))  </span><br><span class="line">        <span class="keyword">return</span> -ENOSYS;  </span><br><span class="line">    <span class="comment">//根据当前注册的fb_info的apertures属性从FrameBuffer驱动数组registered_fb中查询是否存在冲突  </span></span><br><span class="line">    do_remove_conflicting_framebuffers(fb_info-&gt;apertures, fb_info-&gt;fix.id,  </span><br><span class="line">                     fb_is_primary_device(fb_info));  </span><br><span class="line">    <span class="comment">//判断已注册的驱动是否超过32个FrameBuffer驱动  </span></span><br><span class="line">    <span class="keyword">if</span> (num_registered_fb == FB_MAX)  </span><br><span class="line">        <span class="keyword">return</span> -ENXIO;  </span><br><span class="line">    <span class="comment">//增加已注册的驱动个数  </span></span><br><span class="line">    num_registered_fb++;  </span><br><span class="line">    <span class="comment">//从数组registered_fb中查找空闲元素，用于存储当前注册的fb_info  </span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; FB_MAX; i++)  </span><br><span class="line">        <span class="keyword">if</span> (!registered_fb[i])  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">    <span class="comment">//将当前注册的fb_info在数组registered_fb中的索引位置保存到fb_info-&gt;node  </span></span><br><span class="line">    fb_info-&gt;node = i;  </span><br><span class="line">    <span class="comment">//初始化当前注册的fb_info的成员信息  </span></span><br><span class="line">    atomic_set(&amp;fb_info-&gt;count, <span class="number">1</span>);  </span><br><span class="line">    mutex_init(&amp;fb_info-&gt;lock);  </span><br><span class="line">    mutex_init(&amp;fb_info-&gt;mm_lock);  </span><br><span class="line">    <span class="comment">//在/dev目录下创建一个fbx的设备文件，次设备号就是该fb_info在数组registered_fb中的索引  </span></span><br><span class="line">    fb_info-&gt;dev = device_create(fb_class, fb_info-&gt;device,MKDEV(FB_MAJOR, i), <span class="literal">NULL</span>, <span class="string">&quot;fb%d&quot;</span>, i);  </span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(fb_info-&gt;dev)) &#123;  </span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;Unable to create device for framebuffer %d; errno = %ld\n&quot;</span>, i, PTR_ERR(fb_info-&gt;dev));  </span><br><span class="line">        fb_info-&gt;dev = <span class="literal">NULL</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span>  </span><br><span class="line">        <span class="comment">//初始化fb_info  </span></span><br><span class="line">        fb_init_device(fb_info);  </span><br><span class="line">    <span class="keyword">if</span> (fb_info-&gt;pixmap.addr == <span class="literal">NULL</span>) &#123;  </span><br><span class="line">        fb_info-&gt;pixmap.addr = kmalloc(FBPIXMAPSIZE, GFP_KERNEL);  </span><br><span class="line">        <span class="keyword">if</span> (fb_info-&gt;pixmap.addr) &#123;  </span><br><span class="line">            fb_info-&gt;pixmap.size = FBPIXMAPSIZE;  </span><br><span class="line">            fb_info-&gt;pixmap.buf_align = <span class="number">1</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.scan_align = <span class="number">1</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.access_align = <span class="number">32</span>;  </span><br><span class="line">            fb_info-&gt;pixmap.flags = FB_PIXMAP_DEFAULT;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;     </span><br><span class="line">    fb_info-&gt;pixmap.offset = <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_x)  </span><br><span class="line">        fb_info-&gt;pixmap.blit_x = ~(u32)<span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_y)  </span><br><span class="line">        fb_info-&gt;pixmap.blit_y = ~(u32)<span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;modelist.prev || !fb_info-&gt;modelist.next)  </span><br><span class="line">        INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);  </span><br><span class="line">    fb_var_to_videomode(&amp;mode, &amp;fb_info-&gt;var);  </span><br><span class="line">    fb_add_videomode(&amp;mode, &amp;fb_info-&gt;modelist);  </span><br><span class="line">    <span class="comment">//将特定硬件对应的fb_info注册到registered_fb数组中  </span></span><br><span class="line">    registered_fb[i] = fb_info;  </span><br><span class="line">    event.info = fb_info;  </span><br><span class="line">    <span class="keyword">if</span> (!lock_fb_info(fb_info))  </span><br><span class="line">        <span class="keyword">return</span> -ENODEV;  </span><br><span class="line">    <span class="comment">//使用Linux事件通知机制发送一个FrameBuffer注册事件FB_EVENT_FB_REGISTERED  </span></span><br><span class="line">    fb_notifier_call_chain(FB_EVENT_FB_REGISTERED, &amp;event);  </span><br><span class="line">    unlock_fb_info(fb_info);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>注册过程就是将指定的设备驱动信息fb_info存放到registered_fb数组中。因此在注册具体的fb_info时，首先要构造一个fb_info数据结构，并初始化该数据结构，该结构用于描述一个特定的FrameBuffer驱动。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-07-fb-device-create.jpg" alt="Alt text | center"></p>
<h4 id="（三）、MDP-driver"><a href="#（三）、MDP-driver" class="headerlink" title="（三）、MDP driver"></a>（三）、MDP driver</h4><p>MDP也被注册为平台驱动程序。 mdp3_driver_init执行驱动程序init。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdp3.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">mdp3_driver</span> = &#123;</span></span><br><span class="line">    .probe = mdp3_probe,</span><br><span class="line">    .remove = mdp3_remove,</span><br><span class="line">    .suspend = mdp3_suspend,</span><br><span class="line">    .resume = mdp3_resume,</span><br><span class="line">    .shutdown = <span class="literal">NULL</span>,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;mdp3&quot;</span>,</span><br><span class="line">        .of_match_table = mdp3_dt_match,</span><br><span class="line">        .pm             = &amp;mdp3_pm_ops,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">mdp3_driver_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = platform_driver_register(&amp;mdp3_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;register mdp3 driver failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mdp3_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">msm_mdp_interface</span> <span class="title">mdp3_interface</span> = &#123;</span></span><br><span class="line">    .init_fnc = mdp3_init,</span><br><span class="line">    .fb_mem_get_iommu_domain = mdp3_fb_mem_get_iommu_domain,</span><br><span class="line">    .panel_register_done = mdp3_panel_register_done,</span><br><span class="line">    .fb_stride = mdp3_fb_stride,</span><br><span class="line">    .check_dsi_status = mdp3_check_dsi_ctrl_status,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdp3_intr_cb</span> <span class="title">underrun_cb</span> = &#123;</span></span><br><span class="line">        .cb = mdp3_dma_underrun_intr_handler,</span><br><span class="line">        .data = <span class="literal">NULL</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    pr_debug(<span class="string">&quot;%s: START\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">if</span> (!pdev-&gt;dev.of_node) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;MDP driver only supports device tree probe\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOTSUPP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mdp3_res) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;MDP already initialized\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdp3_res = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(struct mdp3_hw_resource),</span><br><span class="line">                GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (mdp3_res == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    pdev-&gt;id = <span class="number">0</span>;</span><br><span class="line">    mdp3_res-&gt;pdev = pdev;</span><br><span class="line">    mutex_init(&amp;mdp3_res-&gt;res_mutex);</span><br><span class="line">    spin_lock_init(&amp;mdp3_res-&gt;irq_lock);</span><br><span class="line">    platform_set_drvdata(pdev, mdp3_res);</span><br><span class="line">    atomic_set(&amp;mdp3_res-&gt;active_intf_cnt, <span class="number">0</span>);</span><br><span class="line">    mutex_init(&amp;mdp3_res-&gt;reg_bus_lock);</span><br><span class="line">    INIT_LIST_HEAD(&amp;mdp3_res-&gt;reg_bus_clist);</span><br><span class="line"></span><br><span class="line">    mdp3_res-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line">    <span class="keyword">if</span> (mdp3_res-&gt;mdss_util == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to get mdss utility functions\n&quot;</span>);</span><br><span class="line">        rc =  -ENODEV;</span><br><span class="line">        <span class="keyword">goto</span> get_util_fail;</span><br><span class="line">    &#125;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;get_iommu_domain = mdp3_get_iommu_domain;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;iommu_attached = is_mdss_iommu_attached;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;iommu_ctrl = mdp3_iommu_ctrl;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;bus_scale_set_quota = mdp3_bus_scale_set_quota;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;panel_intf_type = mdp3_panel_intf_type;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;dyn_clk_gating_ctrl =</span><br><span class="line">        mdp3_dynamic_clock_gating_ctrl;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;panel_intf_type = mdp3_panel_intf_type;</span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;panel_intf_status = mdp3_panel_get_intf_status;</span><br><span class="line">    rc = mdp3_parse_dt(pdev);</span><br><span class="line">    <span class="keyword">if</span> (rc)</span><br><span class="line">        <span class="keyword">goto</span> probe_done;</span><br><span class="line"></span><br><span class="line">    rc = mdp3_res_init();</span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;unable to initialize mdp3 resources\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> probe_done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdp3_res-&gt;fs_ena = <span class="literal">false</span>;</span><br><span class="line">    mdp3_res-&gt;fs = devm_regulator_get(&amp;pdev-&gt;dev, <span class="string">&quot;vdd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR_OR_NULL(mdp3_res-&gt;fs)) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;unable to get mdss gdsc regulator\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = mdp3_debug_init(pdev);</span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;unable to initialize mdp debugging\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> probe_done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pm_runtime_set_autosuspend_delay(&amp;pdev-&gt;dev, AUTOSUSPEND_TIMEOUT_MS);</span><br><span class="line">    <span class="keyword">if</span> (mdp3_res-&gt;idle_pc_enabled) &#123;</span><br><span class="line">        pr_debug(<span class="string">&quot;%s: Enabling autosuspend\n&quot;</span>, __func__);</span><br><span class="line">        pm_runtime_use_autosuspend(&amp;pdev-&gt;dev);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Enable PM runtime */</span></span><br><span class="line">    pm_runtime_set_suspended(&amp;pdev-&gt;dev);</span><br><span class="line">    pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pm_runtime_enabled(&amp;pdev-&gt;dev)) &#123;</span><br><span class="line">        rc = mdp3_footswitch_ctrl(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">            pr_err(<span class="string">&quot;unable to turn on FS\n&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> probe_done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = mdp3_check_version();</span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;mdp3 check version failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> probe_done;</span><br><span class="line">    &#125;</span><br><span class="line">    rc = mdp3_register_sysfs(pdev);</span><br><span class="line">    <span class="keyword">if</span> (rc)</span><br><span class="line">        pr_err(<span class="string">&quot;unable to register mdp sysfs nodes\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = mdss_fb_register_mdp_instance(&amp;mdp3_interface);</span><br><span class="line">    <span class="keyword">if</span> (rc)</span><br><span class="line">        pr_err(<span class="string">&quot;unable to register mdp instance\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = mdp3_set_intr_callback(MDP3_INTR_LCDC_UNDERFLOW,</span><br><span class="line">                    &amp;underrun_cb);</span><br><span class="line">    <span class="keyword">if</span> (rc)</span><br><span class="line">        pr_err(<span class="string">&quot;unable to configure interrupt callback\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = mdss_smmu_init(mdss_res, &amp;pdev-&gt;dev);</span><br><span class="line">    <span class="keyword">if</span> (rc)</span><br><span class="line">        pr_err(<span class="string">&quot;mdss smmu init failed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mdp3_res-&gt;mdss_util-&gt;mdp_probe_done = <span class="literal">true</span>;</span><br><span class="line">    pr_debug(<span class="string">&quot;%s: END\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内核调用MDP探测函数mdp3_probe。 在探测器上，驱动程序从设备树中获取面板信息，并通过调用mdp3_parse_dt来解析信息。 在mdp3_ctrl_on期间，MDP驱动程序调用mdp3_ctrl_res_req_clk并请求MDP和Vsync时钟。 在mdp3_ctrl_off期间，驱动程序请求关闭MDP和Vsync时钟。</p>
<h4 id="（四）、DSI-controller-driver-（lcd驱动-dsi）"><a href="#（四）、DSI-controller-driver-（lcd驱动-dsi）" class="headerlink" title="（四）、DSI controller driver （lcd驱动 dsi）"></a>（四）、DSI controller driver （lcd驱动 dsi）</h4><p>msm_dsi_v2_driver_init执行驱动程序初始化。 msm_dsi_v2_driver_init调用 msm_dsi_v2_register_driver注册驱动程序。<br>总体时序图：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-08-dsi-host-v2.png" alt="Alt text | center"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\dsi_host_v2.c]</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">msm_dsi_v2_driver</span> = &#123;</span></span><br><span class="line">    .probe = msm_dsi_probe,</span><br><span class="line">    .remove = msm_dsi_remove,</span><br><span class="line">    .shutdown = <span class="literal">NULL</span>,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;msm_dsi_v2&quot;</span>,</span><br><span class="line">        .of_match_table = msm_dsi_v2_dt_match,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_dsi_v2_register_driver</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;msm_dsi_v2_driver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msm_dsi_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dsi_interface</span> <span class="title">intf</span>;</span></span><br><span class="line">    <span class="keyword">char</span> panel_cfg[MDSS_MAX_PANEL_LEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mdss_dsi_ctrl_pdata</span> *<span class="title">ctrl_pdata</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">dsi_pan_node</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> cmd_cfg_cont_splash = <span class="literal">false</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">mdss_dsi_mres</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    pr_debug(<span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line">    rc = msm_dsi_init();</span><br><span class="line"></span><br><span class="line">    pdev-&gt;id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ctrl_pdata = platform_get_drvdata(pdev);</span><br><span class="line">    <span class="keyword">if</span> (!ctrl_pdata) &#123;</span><br><span class="line">        ctrl_pdata = devm_kzalloc(&amp;pdev-&gt;dev,</span><br><span class="line">            <span class="keyword">sizeof</span>(struct mdss_dsi_ctrl_pdata), GFP_KERNEL);</span><br><span class="line">        platform_set_drvdata(pdev, ctrl_pdata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctrl_pdata-&gt;mdss_util = mdss_get_util_intf();</span><br><span class="line">    <span class="keyword">if</span> (mdp3_res-&gt;mdss_util == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to get mdss utility functions\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdss_dsi_mres = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mdss_dsi_mres) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dsi_host_private-&gt;dsi_reg_size = resource_size(mdss_dsi_mres);</span><br><span class="line">        dsi_host_private-&gt;dsi_base = ioremap(mdss_dsi_mres-&gt;start,</span><br><span class="line">                        dsi_host_private-&gt;dsi_reg_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mdss_dsi_mres = platform_get_resource(pdev, IORESOURCE_IRQ, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    rc = of_platform_populate(pdev-&gt;dev.of_node, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;pdev-&gt;dev);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DSI panels can be different between controllers */</span></span><br><span class="line">    rc = dsi_get_panel_cfg(panel_cfg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* find panel device node */</span></span><br><span class="line">    dsi_pan_node = dsi_find_panel_of_node(pdev, panel_cfg);</span><br><span class="line">    </span><br><span class="line">    cmd_cfg_cont_splash = mdp3_panel_get_boot_cfg() ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    rc = mdss_dsi_panel_init(dsi_pan_node, ctrl_pdata, cmd_cfg_cont_splash);</span><br><span class="line">    </span><br><span class="line">    rc = dsi_ctrl_config_init(pdev, ctrl_pdata);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    msm_dsi_parse_lane_swap(pdev-&gt;dev.of_node, &amp;(ctrl_pdata-&gt;dlane_swap));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>;  i &lt; DSI_MAX_PM; i++) &#123;</span><br><span class="line">        rc = msm_dsi_io_init(pdev, &amp;(ctrl_pdata-&gt;power_data[i]));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_debug(<span class="string">&quot;%s: Dsi Ctrl-&gt;0 initialized\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line">    dsi_host_private-&gt;dis_dev = pdev-&gt;dev;</span><br><span class="line">    intf.on = msm_dsi_on;</span><br><span class="line">    intf.off = msm_dsi_off;</span><br><span class="line">    intf.cont_on = msm_dsi_cont_on;</span><br><span class="line">    intf.clk_ctrl = msm_dsi_clk_ctrl;</span><br><span class="line">    intf.op_mode_config = msm_dsi_op_mode_config;</span><br><span class="line">    intf.index = <span class="number">0</span>;</span><br><span class="line">    intf.<span class="keyword">private</span> = <span class="literal">NULL</span>;</span><br><span class="line">    dsi_register_interface(&amp;intf);</span><br><span class="line"></span><br><span class="line">    msm_dsi_debug_init();</span><br><span class="line"></span><br><span class="line">    msm_dsi_ctrl_init(ctrl_pdata);</span><br><span class="line"></span><br><span class="line">    rc = msm_dsi_irq_init(&amp;pdev-&gt;dev, mdss_dsi_mres-&gt;start,</span><br><span class="line">                       ctrl_pdata);</span><br><span class="line">    </span><br><span class="line">    rc = dsi_panel_device_register_v2(pdev, ctrl_pdata);</span><br><span class="line">    </span><br><span class="line">    pr_debug(<span class="string">&quot;%s success\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内核调用msm_dsi_probe。 面板被检测到。 msm_dsi_probe调用mdss_dsi_panel_init函数。 mdss_dsi_panel_init调用mdss_panel_parse_dt来获取面板参数。<br>MDP驱动程序使用该事件与DSI驱动程序进行通信。 DSI驱动程序具有mdss_dsi_event_handler，这是MDP核心事件的回调处理程序。 mdss_panel.h定义了MDP核心事件。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\drivers\video\msm\mdss\mdss_panel.h]</span><br><span class="line"><span class="keyword">enum</span> mdss_intf_events &#123;</span><br><span class="line">    MDSS_EVENT_RESET = <span class="number">1</span>,</span><br><span class="line">    MDSS_EVENT_LINK_READY,</span><br><span class="line">    MDSS_EVENT_UNBLANK,</span><br><span class="line">    MDSS_EVENT_PANEL_ON,</span><br><span class="line">    MDSS_EVENT_POST_PANEL_ON,</span><br><span class="line">    MDSS_EVENT_BLANK,</span><br><span class="line">    MDSS_EVENT_PANEL_OFF,</span><br><span class="line">    MDSS_EVENT_CLOSE,</span><br><span class="line">    MDSS_EVENT_SUSPEND,</span><br><span class="line">    MDSS_EVENT_RESUME,</span><br><span class="line">    MDSS_EVENT_CHECK_PARAMS,</span><br><span class="line">    MDSS_EVENT_CONT_SPLASH_BEGIN,</span><br><span class="line">    MDSS_EVENT_CONT_SPLASH_FINISH,</span><br><span class="line">    MDSS_EVENT_PANEL_UPDATE_FPS,</span><br><span class="line">    MDSS_EVENT_FB_REGISTERED,</span><br><span class="line">    MDSS_EVENT_PANEL_CLK_CTRL,</span><br><span class="line">    MDSS_EVENT_DSI_CMDLIST_KOFF,</span><br><span class="line">    MDSS_EVENT_ENABLE_PARTIAL_ROI,</span><br><span class="line">    MDSS_EVENT_DSC_PPS_SEND,</span><br><span class="line">    MDSS_EVENT_DSI_STREAM_SIZE,</span><br><span class="line">    MDSS_EVENT_DSI_UPDATE_PANEL_DATA,</span><br><span class="line">    MDSS_EVENT_REGISTER_RECOVERY_HANDLER,</span><br><span class="line">    MDSS_EVENT_REGISTER_MDP_CALLBACK,</span><br><span class="line">    MDSS_EVENT_DSI_PANEL_STATUS,</span><br><span class="line">    MDSS_EVENT_DSI_DYNAMIC_SWITCH,</span><br><span class="line">    MDSS_EVENT_DSI_RECONFIG_CMD,</span><br><span class="line">    MDSS_EVENT_DSI_RESET_WRITE_PTR,</span><br><span class="line">    MDSS_EVENT_PANEL_TIMING_SWITCH,</span><br><span class="line">    MDSS_EVENT_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在msm_dsi_on期间，通过调用msm_dsi_clk_enable打开DSI时钟。 在msm_dsi_off期间，通过调用msm_dsi_clk_disable关闭clks。</p>
<h4 id="（五）、-Panel-driver-（面板-dsi）"><a href="#（五）、-Panel-driver-（面板-dsi）" class="headerlink" title="（五）、 Panel driver （面板 dsi）"></a>（五）、 Panel driver （面板 dsi）</h4><p>MDSS : Multimedia Display sub system<br>DSI: Display Serial Interface</p>
<blockquote>
<p>qcom,mdss-dsi-force-clock-lane-hs;          // faulse ：clock每帧回lp11<br>ture: clock不回 qcom,mdss-dsi-hfp-power-mode;               // data 每行回lp11,对应的hfp要修改成300以上</p>
</blockquote>
<p>面板信息位于kernel\arch\arm\boot\dts\中的.dtsi文件中。 这包含所有面板特定的命令，例如on，off和reset（mdss-dsi-on-command，mdss-dsi-off-command，mdss-dsi-reset-sequence），BL控制和其他面板 独立参数。<br>例如：<br>msm8610-mdss.dtsi （文件名通常为 msmxxx-mdss.dtsi 指定了mdss 的 mdp 和 dsi）</p>
<h5 id="5-1、-dtsi文件解析"><a href="#5-1、-dtsi文件解析" class="headerlink" title="5.1、.dtsi文件解析"></a>5.1、.dtsi文件解析</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mdss_mdp: qcom,mdss_mdp@fd900000 &#123;</span><br><span class="line">            compatible = <span class="string">&quot;qcom,mdss_mdp3&quot;</span>;  <span class="comment">// 对应mdss驱动 mdss_mdp.c</span></span><br><span class="line">----------</span><br><span class="line">  mdss_dsi0: qcom,mdss_dsi@fdd00000 &#123;</span><br><span class="line">        compatible = <span class="string">&quot;qcom,msm-dsi-v2&quot;</span>;      <span class="comment">// 对应dsi解析驱动 dsi_host_v2.c</span></span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">  mdss_dsi0: qcom,mdss_dsi_ctrl0@<span class="number">1</span>a94000 &#123;</span><br><span class="line">        compatible = <span class="string">&quot;qcom,mdss-dsi-ctrl&quot;</span>;  <span class="comment">// 对应dsi解析驱动 mdss_dsi.c</span></span><br></pre></td></tr></table></figure>

<p>通过下面函数向 mdss_fb.c 注册了fb_info结构  (包含在mdss_dsi_ctrl_pdata结构中)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">drivers\video\msm\mdss\dsi_host_v2.c （lcd驱动 dsi）</span><br><span class="line">dsi_panel_device_register_v2(struct platform_device *dev,struct mdss_dsi_ctrl_pdata *ctrl_pdata)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">msm_dsi_v2_dt_match</span>[] = &#123;</span></span><br><span class="line">    &#123;.compatible = <span class="string">&quot;qcom,msm-dsi-v2&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">或者 </span><br><span class="line">drivers\video\msm\mdss\mdss_dsi.c</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>msm8610-asus.dts （指定mdp中的哪一个配置）<br>通常在dts文件的 mdss_dsi0 lab里面通过 qcom,dsi-pref-prim-pan 属性 指定使用哪一个lcd配置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;mdss_dsi0 &#123;</span><br><span class="line">        qcom,dsi-pref-prim-pan = &lt;&amp;dsi_fl10802_fwvga_vid&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>dsi-panel-fl10802-fwvga-video.dtsi</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&amp;mdss_mdp &#123;</span><br><span class="line">    dsi_fl10802_fwvga_vid: qcom,mdss_dsi_fl10802_fwvga_video &#123;</span><br><span class="line">        qcom,mdss-dsi-panel-name = <span class="string">&quot;fl10802 fwvga video mode dsi panel&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-drive-ic = <span class="string">&quot;fl10802&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-panel-controller = &lt;&amp;mdss_dsi0&gt;;</span><br><span class="line">        qcom,mdss-dsi-panel-type = <span class="string">&quot;dsi_video_mode&quot;</span>;</span><br><span class="line">        qcom,mdss-dsi-panel-destination = <span class="string">&quot;display_1&quot;</span>;</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>


<h5 id="5-2、mdss-mdp-和-mdss-dsi0-的关系"><a href="#5-2、mdss-mdp-和-mdss-dsi0-的关系" class="headerlink" title="5.2、mdss_mdp 和 mdss_dsi0 的关系"></a>5.2、mdss_mdp 和 mdss_dsi0 的关系</h5><p>mdss_mdp 相当于一个数组，里面定义了很多不同lcd显示屏的配置项包括分辨率等等</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-09-mdss_mdp-mdss_dsi0.jpg" alt="Alt text | center"></p>
<p>面板驱动程序可以根据连接的实际面板数量具有多个节点。<br>mdss_register_panel注册面板驱动程序：<br>msm_dsi_probe→dsi_panel_device_register_v2→mdss_register_panel→<br>of_platform_device_create<br>以下面板控制功能可用并在mdss_dsi_panel_init中初始化：<br>ctrl_pdata→on = mdss_dsi_panel_on;<br>ctrl_pdata→off = mdss_dsi_panel_off;<br>ctrl_pdata→panel_data.set_backlight = mdss_dsi_panel_bl_ctrl;<br>  例如，在mdp3_ctrl.c中，函数mdp3_ctrl_on（）会调用以下DSI处理程序<br>MDSS_EVENT_UNBLANK和MDSS_EVENT_PANEL_ON事件如下所示：<br>rc = panel→event_handler（panel，MDSS_EVENT_UNBLANK，NULL）;<br>rc | =面板→event_handler（面板，MDSS_EVENT_PANEL_ON，NULL）;</p>
<h5 id="5-3、通过内核接口打开和关闭显示器"><a href="#5-3、通过内核接口打开和关闭显示器" class="headerlink" title="5.3、通过内核接口打开和关闭显示器"></a>5.3、通过内核接口打开和关闭显示器</h5><h5 id="5-3-1、启动"><a href="#5-3-1、启动" class="headerlink" title="5.3.1、启动"></a>5.3.1、启动</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-10-display-subsystem-on-bootup.png" alt="Alt text | center"></p>
<p>按照上面的部分所述注册设备后：<br>mdss_fb_open→mdss_fb_blank_sub→pdata→on（面板ON功能）<br>注意：对于命令模式面板，如果面板在启动时已打开，则会跳过该启动序列 以避免关闭/ -on的文物。</p>
<h5 id="5-3-2、暂停-恢复"><a href="#5-3-2、暂停-恢复" class="headerlink" title="5.3.2、暂停/恢复"></a>5.3.2、暂停/恢复</h5><p>挂起/恢复时，调用fb驱动程序挂起/恢复和MDP驱动程序挂起/恢复。 fb驱动程序依次调用面板驱动程序的开/关功能。</p>
<h5 id="5-3-2-1、暂停序列"><a href="#5-3-2-1、暂停序列" class="headerlink" title="5.3.2.1、暂停序列"></a>5.3.2.1、暂停序列</h5><p>![Alt text | center](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-11-suspend">https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-11-suspend</a> sequence.png)</p>
<p>Kernelcall→mdss_fb_release_all→mdss_fb_blank→mdss_fb_blank_sub→mdp3_ctrl_off→<br>mdp3_ctrl_off发送两个事件：</p>
<ol>
<li>MDSS_EVENT_PANEL_OFF - dsi_event_handler接收事件。 当事件发生时<br> 接收到时，调用小组关闭序列。</li>
<li>MDSS_EVENT_BLANK - 该事件由调用的dsi_event_handler处理<br>mdss_dsi_off。</li>
</ol>
<ul>
<li>Kernelcall→mdp3_suspend - 未使用<h5 id="5-3-2-2、恢复序列"><a href="#5-3-2-2、恢复序列" class="headerlink" title="5.3.2.2、恢复序列"></a>5.3.2.2、恢复序列</h5></li>
</ul>
<p>![Alt text | center](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-12-resume">https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-12-resume</a> sequence.png)</p>
<p>Kernelcall→mdss_fb_blank→mdss_fb_blank_sub→mdp3_ctrl_on→<br>mdp3_ctrl_on发送两个事件：</p>
<ol>
<li>MDSS_EVENT_UNBLANK - dsi_event_handler接收事件。 当事件发生时<br>收到，DSI-on被调用。</li>
<li>MDSS_EVENT_PANEL_ON - 事件由dsi_event_handler处理，dsi_event_handler发送<br>面板上的序列。<br>Kernelcall→mdp3_resume - 未使用</li>
</ol>
<h5 id="5-4、图像更新到面板"><a href="#5-4、图像更新到面板" class="headerlink" title="5.4、图像更新到面板"></a>5.4、图像更新到面板</h5><p>![Alt text | center](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-13-flow">https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/display.system/DS05-13-flow</a> for display subsystem commit.png)</p>
<p> 用户必须确保MSMFB_OVERLAY_SET IOCTL在呼叫之前至少被调用一次 到MSMFB_OVERLAY_PLAY IOCLT（例如ioctl(fd, MSMFB_OVERLAY_PLAY, &amp;od)）。MSMFB_OVERLAY_PLAY队列缓冲区 显示在面板上。 用户使用MSMFB_DISPLAY_COMMIT调用fb IOCLT。这会启动一个呼叫<br> mdss_fb_display_commit 并安排工作队列。此工作队列处理程序调用<br> msm_fb_pan_display_ex，然后调用mdp3_ctrl_pan_display。<br> mdss_fb_ioctl→（MSMFB_DISPLAY_COMMIT）→mdss_fb_display_commit→<br> mdss_fb_pan_display_ex→计划工作mdss_fb_commit_wq_handler<br> msm_fb_commit_wq_handler→mdp3_ctrl_display_commit_kickoff→mdp3_dmap_update<br>一次呼叫后，可以有多个对PLAY和COMMIT IOCLT的呼叫 MSMFB_OVERLAY_SET IOCTL。面板更新完成并且设备完成后<br>需要进入挂起或关闭状态，用户可以调用MSMFB_OVERLAY_UNSET。</p>
<p>注意：工作队列架构正在被即将发布的线程取代，<br>这些文件未被捕获。视频和命令模式面板的面板更新略有不同。为了在命令模式面板中，mdp3_dmap_update函数会等待，直到前一个图像更新为止完成使用MDP DMA开始新帧更新</p>
<p>if（dma-&gt; output_config.out_sel == MDP3_DMA_OUTPUT_SEL_DSI_CMD）{<br>cb_type = MDP3_DMA_CALLBACK_TYPE_DMA_DONE;<br>如果（intf-&gt; active）<br>wait_for_completion_killable（DMA-&gt; dma_comp）;</p>
<p>对于视频面板，在DMA触发后，mdp3_dmap_update等待vsync。</p>
<h4 id="（六）、Msm8610-lcd-driver-内核初始化分析"><a href="#（六）、Msm8610-lcd-driver-内核初始化分析" class="headerlink" title="（六）、Msm8610  lcd driver 内核初始化分析"></a>（六）、Msm8610  lcd driver 内核初始化分析</h4><p>请参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347">【msm8610 lcd driver code analysis】</a></p>
<h4 id="（七）、参考资料-特别感谢各位前辈的分析和图示-："><a href="#（七）、参考资料-特别感谢各位前辈的分析和图示-：" class="headerlink" title="（七）、参考资料(特别感谢各位前辈的分析和图示)："></a>（七）、参考资料(特别感谢各位前辈的分析和图示)：</h4><p><strong>(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！累<del>~</del></strong><br><strong>时至今日，终于完整的分析了Android Display System 总体框架流程，不禁感叹计算机世界的博大精深，在这个系列的分析中历练了如何拆解分析一个庞大复杂的模块、学习收获良多，同时也了解了自身知识的欠缺，由于涉及知识较多较广，博主也未能完全吃透，其中分析有误的地方还请各位见谅。所谓路漫漫其修远兮，吾将上下而求索。</strong><br><strong>Todo：专注于Linux &amp;&amp; Android Multimedia（Camera、Video、Audio、Display）系统分析与研究，Multimedia System 任还有许多未解之惑，需恶补Linux内核知识，少年，加油（➽➽➽）</strong></p>
<h4 id="（八）、参考资料-特别感谢各位前辈的分析和图示-："><a href="#（八）、参考资料-特别感谢各位前辈的分析和图示-：" class="headerlink" title="（八）、参考资料(特别感谢各位前辈的分析和图示)："></a>（八）、参考资料(特别感谢各位前辈的分析和图示)：</h4><p><a target="_blank" rel="noopener" href="https://s3.amazonaws.com/connect.linaro.org/bkk16/Presentations/Wednesday/BKK16-315.pdf">Graphics Stack Update</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/eliot_shao/article/details/74926010">高通Android平台-应用空间操作framebuffer dump LCD总结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ic_soc_arm_robin/article/details/12949347">msm8610 lcd driver code analysis</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012719256/article/details/52096727">linux qcom LCD framwork</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weijory/article/details/69391838">Qualcomm平台 display bring up 过程详解</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wlwl0071986/article/details/8247443">高通8x25平台display模块总结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/sfrysh/article/details/7305253">Android 中的 framebuffer</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yangwen123/article/details/12096483">FrameBuffer驱动程序分析</a><br><a target="_blank" rel="noopener" href="http://www.wxtlife.com/2017/06/07/Android-framebuffer/">Android Framebuffer介绍及使用</a><br><a target="_blank" rel="noopener" href="https://www.wolfcstech.com/categories/Android-%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F/">Android 图形系统</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20180808/">https://zhoujinjian.com/posts/20180808/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a><a class="post-meta__tags" href="/tags/Display/">Display</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.23.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20180908/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.13.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Audio System（1）：Linux &amp;&amp; Android Audio 系统框架分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/20180708/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android N Display System（4）：Android Display System 系统分析之Gralloc &amp;&amp; HWComposer模块分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20180408/" title="Android N Display System（1）：Android Display System 系统分析之Android Graphics 系统分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.07.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-04-08</div><div class="title">Android N Display System（1）：Android Display System 系统分析之Android Graphics 系统分析</div></div></a></div><div><a href="/posts/20180508/" title="Android N Display System（2）：Android Display System 系统分析之Android EGL && OpenGL"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.20.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-05-08</div><div class="title">Android N Display System（2）：Android Display System 系统分析之Android EGL && OpenGL</div></div></a></div><div><a href="/posts/20180608/" title="Android N Display System（3）：Android Display System 系统分析之HardwareRenderer.draw()绘制流程分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.21.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-08</div><div class="title">Android N Display System（3）：Android Display System 系统分析之HardwareRenderer.draw()绘制流程分析</div></div></a></div><div><a href="/posts/20180708/" title="Android N Display System（4）：Android Display System 系统分析之Gralloc && HWComposer模块分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-07-08</div><div class="title">Android N Display System（4）：Android Display System 系统分析之Gralloc && HWComposer模块分析</div></div></a></div><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81%E7%9B%B4%E6%8E%A5%E6%93%8D%E4%BD%9Cframebuffer%E6%98%BE%E7%A4%BA%E5%9B%BE%E5%83%8F"><span class="toc-number">1.</span> <span class="toc-text">（一）、直接操作framebuffer显示图像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81%E7%9B%B4%E6%8E%A5%E6%93%8D%E4%BD%9Cframebuffer%E6%98%BE%E7%A4%BA%E5%9B%BE%E5%83%8F"><span class="toc-number">1.1.</span> <span class="toc-text">1.1、直接操作framebuffer显示图像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-1%E3%80%81%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">1.1.1、源代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2%E3%80%81%E7%BC%96%E8%AF%91%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">1.1.2、编译测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3%E3%80%81%E6%98%BE%E7%A4%BA%E6%95%88%E6%9E%9C"><span class="toc-number">1.4.</span> <span class="toc-text">1.1.3、显示效果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-4%E3%80%81%E8%A7%86%E9%A2%91%EF%BC%88%E5%8A%A0%E6%B7%B1%E7%90%86%E8%A7%A3%E3%80%81%E8%87%AA%E2%98%AF%E5%A4%87%E2%98%AF%E6%A2%AF%E2%98%AF%E5%AD%90%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">1.1.4、视频（加深理解、自☯备☯梯☯子）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5%E3%80%81%E9%A9%B1%E5%8A%A8%E6%80%BB%E4%BD%93%E6%A6%82%E8%A7%88%E5%9B%BE"><span class="toc-number">1.6.</span> <span class="toc-text">1.1.5、驱动总体概览图</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81FrameBuffer%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">（二）、FrameBuffer驱动程序分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81-Framebuffer%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">2.1、 Framebuffer数据结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1%E3%80%81-fb-info"><span class="toc-number">2.2.</span> <span class="toc-text">2.1.1、 fb_info</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2%E3%80%81fb-var-screeninfo"><span class="toc-number">2.3.</span> <span class="toc-text">2.1.2、fb_var_screeninfo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3%E3%80%81fb-fix-screeninfo"><span class="toc-number">2.4.</span> <span class="toc-text">2.1.3、fb_fix_screeninfo</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81Framebuffer%E9%A9%B1%E5%8A%A8%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">2.5.</span> <span class="toc-text">2.2、Framebuffer驱动注册过程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81MDP-driver"><span class="toc-number">3.</span> <span class="toc-text">（三）、MDP driver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E3%80%81DSI-controller-driver-%EF%BC%88lcd%E9%A9%B1%E5%8A%A8-dsi%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">（四）、DSI controller driver （lcd驱动 dsi）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E3%80%81-Panel-driver-%EF%BC%88%E9%9D%A2%E6%9D%BF-dsi%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">（五）、 Panel driver （面板 dsi）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1%E3%80%81-dtsi%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">5.1、.dtsi文件解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2%E3%80%81mdss-mdp-%E5%92%8C-mdss-dsi0-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">5.2.</span> <span class="toc-text">5.2、mdss_mdp 和 mdss_dsi0 的关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3%E3%80%81%E9%80%9A%E8%BF%87%E5%86%85%E6%A0%B8%E6%8E%A5%E5%8F%A3%E6%89%93%E5%BC%80%E5%92%8C%E5%85%B3%E9%97%AD%E6%98%BE%E7%A4%BA%E5%99%A8"><span class="toc-number">5.3.</span> <span class="toc-text">5.3、通过内核接口打开和关闭显示器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1%E3%80%81%E5%90%AF%E5%8A%A8"><span class="toc-number">5.4.</span> <span class="toc-text">5.3.1、启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2%E3%80%81%E6%9A%82%E5%81%9C-%E6%81%A2%E5%A4%8D"><span class="toc-number">5.5.</span> <span class="toc-text">5.3.2、暂停&#x2F;恢复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-1%E3%80%81%E6%9A%82%E5%81%9C%E5%BA%8F%E5%88%97"><span class="toc-number">5.6.</span> <span class="toc-text">5.3.2.1、暂停序列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2-2%E3%80%81%E6%81%A2%E5%A4%8D%E5%BA%8F%E5%88%97"><span class="toc-number">5.7.</span> <span class="toc-text">5.3.2.2、恢复序列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4%E3%80%81%E5%9B%BE%E5%83%8F%E6%9B%B4%E6%96%B0%E5%88%B0%E9%9D%A2%E6%9D%BF"><span class="toc-number">5.8.</span> <span class="toc-text">5.4、图像更新到面板</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%85%AD%EF%BC%89%E3%80%81Msm8610-lcd-driver-%E5%86%85%E6%A0%B8%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">（六）、Msm8610  lcd driver 内核初始化分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%83%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2%E5%90%84%E4%BD%8D%E5%89%8D%E8%BE%88%E7%9A%84%E5%88%86%E6%9E%90%E5%92%8C%E5%9B%BE%E7%A4%BA-%EF%BC%9A"><span class="toc-number">7.</span> <span class="toc-text">（七）、参考资料(特别感谢各位前辈的分析和图示)：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%85%AB%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2%E5%90%84%E4%BD%8D%E5%89%8D%E8%BE%88%E7%9A%84%E5%88%86%E6%9E%90%E5%92%8C%E5%9B%BE%E7%A4%BA-%EF%BC%9A"><span class="toc-number">8.</span> <span class="toc-text">（八）、参考资料(特别感谢各位前辈的分析和图示)：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>