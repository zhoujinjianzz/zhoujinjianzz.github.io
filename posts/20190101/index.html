<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera ç³»ç»Ÿ æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ | zhoujinjian</title><meta name="keywords" content="Camera,Android,Linux"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚ ã€ç‰¹åˆ«æ„Ÿ">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera ç³»ç»Ÿ æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ">
<meta property="og:url" content="https://zhoujinjian.com/posts/20190101/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚ ã€ç‰¹åˆ«æ„Ÿ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.18.jpg">
<meta property="article:published_time" content="2019-01-01T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.964Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Camera">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.18.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20190101/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> åª’ä½“</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> ç”µå½±</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> ä¹¦å•</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> ä¸»é¡µ</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> ä¸»é¡µ</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> å¯¼èˆª</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.18.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> åª’ä½“</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> ç”µå½±</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> ä¹¦å•</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> ä¸»é¡µ</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> ä¸»é¡µ</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> å¯¼èˆª</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android Camera Systemï¼ˆ1ï¼‰ï¼šCamera ç³»ç»Ÿ æ¡†æ¶ã€Open()è¿‡ç¨‹åˆ†æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2019-01-01T01:25:00.000Z" title="å‘è¡¨äº 2019-01-01 09:25:00">2019-01-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.964Z" title="æ›´æ–°äº 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Camera/">Camera</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<p>æ³¨ï¼šæ–‡ç« éƒ½æ˜¯é€šè¿‡é˜…è¯»å„ä½å‰è¾ˆæ€»ç»“çš„èµ„æ–™ã€Android 7.1.2 &amp;&amp; Linuxï¼ˆkernel 3.18ï¼‰Qualcommå¹³å°æºç ã€åŠ ä¸Šè‡ªå·±çš„æ€è€ƒåˆ†ææ€»ç»“å‡ºæ¥çš„ï¼Œå…¶ä¸­éš¾å…æœ‰ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚æ–‡ç« ä¸ºä¸ªäººå­¦ä¹ ã€ç ”ç©¶ã€æ¬£èµä¹‹ç”¨ï¼Œå›¾æ–‡å†…å®¹æ•´ç†è‡ªäº’è”ç½‘ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ï¼Œç¦æ­¢è½¬è½½ï¼ˆÂ©Qualcomm Technologies, Inc. ç‰ˆæƒæ‰€æœ‰ï¼‰ï¼Œè°¢è°¢ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/armwind/article/category/6282972">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera fwå­¦ä¹ -Armwindã€‘</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzzaigcnforever/article/category/3066721">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera API2åˆ†æ-Gzzaigcnforeverã€‘</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_16775897/article/category/7112759">ã€ç‰¹åˆ«æ„Ÿè°¢ - Android Camera æµç¨‹å­¦ä¹ è®°å½• Android 7.12-QQ_16775897ã€‘</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/column/details/guming-camera.html">ã€ç‰¹åˆ«æ„Ÿè°¢ - ä¸“æ ï¼šå¤å†¥çš„android6.0ä¸‹çš„Camera API2.0çš„æºç åˆ†æä¹‹æ—…ã€‘</a><br>Google Pixelã€Pixel XL å†…æ ¸ä»£ç ï¼ˆæ–‡ç« åŸºäº Kernel-3.18ï¼‰ï¼š<br> <a target="_blank" rel="noopener" href="https://github.com/matthewdalex/marlin">Kernel source for Pixel and Pixel XL - GitHub</a></p>
<p>AOSP æºç ï¼ˆæ–‡ç« åŸºäº Android 7.1.2ï¼‰ï¼š<br> <a target="_blank" rel="noopener" href="https://testerhome.com/topics/2229"> Android ç³»ç»Ÿå…¨å¥—æºä»£ç åˆ†äº« (æ›´æ–°åˆ° 8.1.0_r1)</a></p>
<p> ğŸŒ€ğŸŒ€ï¼šä¸“æ³¨äºLinux &amp;&amp; Android Multimediaï¼ˆCameraã€Videoã€Audioã€Displayï¼‰ç³»ç»Ÿåˆ†æä¸ç ”ç©¶</p>
<hr>
<p>â˜¯ Applicationï¼š<br>â˜¯ /packages/apps/Camera2/src/com/android/camera/</p>
<p>â˜¯ Frameworkï¼š<br>â˜¯ /frameworks/base/core/java/android/hardware/Camera.java</p>
<p>â˜¯ JNI:<br>â˜¯ /frameworks/base/core/jni/android_hardware_Camera.cpp</p>
<p>â˜¯ Native:<br>â˜¯ Clientï¼š<br>frameworks/av/camera/CameraBase.cpp<br>frameworks/av/camera/Camera.cpp<br>frameworks/av/camera/ICamera.cpp<br>frameworks/av/camera/aidl/android/hardware/ICamera.aidl<br>frameworks/av/camera/aidl/android/hardware/ICameraClient.aidl<br>â˜¯ Serverï¼š<br>frameworks/av/camera/cameraserver/main_cameraserver.cpp<br>frameworks/av/services/camera/libcameraservice/CameraService.cpp<br>frameworks/av/services/camera/libcameraservice/api1/CameraClient.cpp<br>frameworks/av/camera/aidl/android/hardware/ICameraService.aidl</p>
<p>â˜¯ HALï¼š<br>â˜¯ /frameworks/av/services/camera/libcameraservice/device3/<br>â˜¯ /hardware/qcom/camera/QCamera2(é«˜é€šHAL)<br>â˜¯ /vendor/qcom/proprietary/mm-camera(é«˜é€šmm-camera)<br>â˜¯ /vendor/qcom/proprietary/mm-still(é«˜é€šJPEG)</p>
<p>â˜¯ Kernelï¼š<br>â˜¯ /kernel/drivers/media/platform/msm/camera_v2(é«˜é€šV4L2)<br>â˜¯ /kernel/arch/arm/boot/dts/(é«˜é€šdts)</p>
<hr>
<h4 id="ï¼ˆä¸€ï¼‰ã€Android-Camera-System-Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰"><a href="#ï¼ˆä¸€ï¼‰ã€Android-Camera-System-Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰" class="headerlink" title="ï¼ˆä¸€ï¼‰ã€Android Camera System Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰"></a>ï¼ˆä¸€ï¼‰ã€Android Camera System Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰</h4><h5 id="1-1ã€Android-Camera-Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰"><a href="#1-1ã€Android-Camera-Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰" class="headerlink" title="1.1ã€Android Camera Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰"></a>1.1ã€Android Camera Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰</h5><h5 id="1-1-1ã€é¦–å…ˆçœ‹çœ‹Android-å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š"><a href="#1-1-1ã€é¦–å…ˆçœ‹çœ‹Android-å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š" class="headerlink" title="1.1.1ã€é¦–å…ˆçœ‹çœ‹Android å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š"></a>1.1.1ã€é¦–å…ˆçœ‹çœ‹Android å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-01-android_ape_fwk_camera.png" alt="Alt text"></p>
<p><strong>â˜¯åº”ç”¨æ¡†æ¶</strong><br>åº”ç”¨ä»£ç ä½äºåº”ç”¨æ¡†æ¶çº§åˆ«ï¼Œå®ƒåˆ©ç”¨ android.hardware.Camera API æ¥ä¸ç›¸æœºç¡¬ä»¶è¿›è¡Œäº’åŠ¨ã€‚åœ¨å†…éƒ¨ï¼Œæ­¤ä»£ç ä¼šè°ƒç”¨ç›¸åº”çš„ JNI ç²˜åˆç±»ï¼Œä»¥è®¿é—®ä¸è¯¥ç›¸æœºäº’åŠ¨çš„åŸç”Ÿä»£ç ã€‚<br><strong>â˜¯JNI</strong><br>ä¸ android.hardware.Camera å…³è”çš„ JNI ä»£ç ä½äº frameworks/base/core/jni/android_hardware_Camera.cpp ä¸­ã€‚æ­¤ä»£ç ä¼šè°ƒç”¨è¾ƒä½çº§åˆ«çš„åŸç”Ÿä»£ç ä»¥è·å–å¯¹ç‰©ç†ç›¸æœºçš„è®¿é—®æƒé™ï¼Œå¹¶è¿”å›ç”¨äºåœ¨æ¡†æ¶çº§åˆ«åˆ›å»º android.hardware.Camera å¯¹è±¡çš„æ•°æ®ã€‚<br><strong>â˜¯åŸç”Ÿæ¡†æ¶</strong><br>åœ¨ frameworks/av/camera/Camera.cpp ä¸­å®šä¹‰çš„åŸç”Ÿæ¡†æ¶å¯æä¾›ç›¸å½“äº android.hardware.Camera ç±»çš„åŸç”Ÿç±»ã€‚æ­¤ç±»ä¼šè°ƒç”¨ IPC binder ä»£ç†ï¼Œä»¥è·å–å¯¹ç›¸æœºæœåŠ¡çš„è®¿é—®æƒé™ã€‚<br><strong>â˜¯Binder IPC ä»£ç†</strong><br>IPC binder ä»£ç†ç”¨äºä¿ƒè¿›è·¨è¶Šè¿›ç¨‹è¾¹ç•Œçš„é€šä¿¡ã€‚è°ƒç”¨ç›¸æœºæœåŠ¡çš„ frameworks/av/camera ç›®å½•ä¸­æœ‰ 3 ä¸ªç›¸æœº binder ç±»ã€‚ICameraService æ˜¯ç›¸æœºæœåŠ¡çš„æ¥å£ï¼ŒICamera æ˜¯å·²æ‰“å¼€çš„ç‰¹å®šç›¸æœºè®¾å¤‡çš„æ¥å£ï¼ŒICameraClient æ˜¯è¿”å›åº”ç”¨æ¡†æ¶çš„è®¾å¤‡æ¥å£ã€‚<br><strong>â˜¯ç›¸æœºæœåŠ¡</strong><br>ä½äº frameworks/av/services/camera/libcameraservice/CameraService.cpp ä¸‹çš„ç›¸æœºæœåŠ¡æ˜¯ä¸ HAL è¿›è¡Œäº’åŠ¨çš„å®é™…ä»£ç ã€‚<br><strong>â˜¯HAL</strong><br>ç¡¬ä»¶æŠ½è±¡å±‚å®šä¹‰äº†ç”±ç›¸æœºæœåŠ¡è°ƒç”¨ä¸”æ‚¨å¿…é¡»å®ç°ä»¥ç¡®ä¿ç›¸æœºç¡¬ä»¶æ­£å¸¸è¿è¡Œçš„æ ‡å‡†æ¥å£ã€‚<br><strong>â˜¯å†…æ ¸é©±åŠ¨ç¨‹åº</strong><br>ç›¸æœºçš„é©±åŠ¨ç¨‹åºå¯ä¸å®é™…ç›¸æœºç¡¬ä»¶ä»¥åŠæ‚¨çš„ HAL å®ç°è¿›è¡Œäº’åŠ¨ã€‚ç›¸æœºå’Œé©±åŠ¨ç¨‹åºå¿…é¡»æ”¯æŒ YV12 å’Œ NV21 å›¾ç‰‡æ ¼å¼ï¼Œä»¥ä¾¿åœ¨æ˜¾ç¤ºå’Œè§†é¢‘å½•åˆ¶æ—¶æ”¯æŒé¢„è§ˆç›¸æœºå›¾ç‰‡ã€‚</p>
<h5 id="1-1-2ã€Qualcommå¹³å°Camera-æ¶æ„"><a href="#1-1-2ã€Qualcommå¹³å°Camera-æ¶æ„" class="headerlink" title="1.1.2ã€Qualcommå¹³å°Camera æ¶æ„"></a>1.1.2ã€Qualcommå¹³å°Camera æ¶æ„</h5><p>Qualcommå¹³å°Camera æ¶æ„ä¸»è¦åŒºåˆ«åœ¨äºHALå±‚å’ŒKernelå±‚çš„å˜åŒ–ï¼Œæ€»ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š</p>
<h5 id="1-1-2-1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„"><a href="#1-1-2-1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„" class="headerlink" title="1.1.2.1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„"></a>1.1.2.1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-02-Android-Camera-Software-Architecture.png" alt="Alt text"></p>
<h5 id="1-1-2-2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera"><a href="#1-1-2-2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera" class="headerlink" title="1.1.2.2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera"></a>1.1.2.2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-03-HAL-and-mm-camera-interface.png" alt="Alt text"></p>
<h5 id="1-1-2-3ã€Qualcommå¹³å°Cameraçš„Kernel"><a href="#1-1-2-3ã€Qualcommå¹³å°Cameraçš„Kernel" class="headerlink" title="1.1.2.3ã€Qualcommå¹³å°Cameraçš„Kernel"></a>1.1.2.3ã€Qualcommå¹³å°Cameraçš„Kernel</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-04-Camera-Kernel-Architecture.png" alt="Alt text"></p>
<h5 id="1-2ã€Android-Camera-API-2-0-å…¨æ–°çš„HAL-å­ç³»ç»Ÿ"><a href="#1-2ã€Android-Camera-API-2-0-å…¨æ–°çš„HAL-å­ç³»ç»Ÿ" class="headerlink" title="1.2ã€Android Camera API 2.0 å…¨æ–°çš„HAL å­ç³»ç»Ÿ"></a>1.2ã€Android Camera API 2.0 å…¨æ–°çš„HAL å­ç³»ç»Ÿ</h5><p>Android 7.1.2ç°åœ¨ä½¿ç”¨çš„æ˜¯Camera API 2.0 å’Œ Camera Device 3ä»¥åŠ HAL3ã€‚</p>
<h5 id="1-2-1ã€è¯·æ±‚"><a href="#1-2-1ã€è¯·æ±‚" class="headerlink" title="1.2.1ã€è¯·æ±‚"></a>1.2.1ã€è¯·æ±‚</h5><p>åº”ç”¨æ¡†æ¶é’ˆå¯¹æ•è·çš„ç»“æœå‘ç›¸æœºå­ç³»ç»Ÿå‘å‡ºè¯·æ±‚ã€‚ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ç»„ç»“æœã€‚è¯·æ±‚åŒ…å«æœ‰å…³æ•è·å’Œå¤„ç†è¿™äº›ç»“æœçš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚å…¶ä¸­åŒ…æ‹¬åˆ†è¾¨ç‡å’Œåƒç´ æ ¼å¼ï¼›æ‰‹åŠ¨ä¼ æ„Ÿå™¨ã€é•œå¤´å’Œé—ªå…‰ç¯æ§ä»¶ï¼›3A æ“ä½œæ¨¡å¼ï¼›RAW åˆ° YUV å¤„ç†æ§ä»¶ï¼›ä»¥åŠç»Ÿè®¡ä¿¡æ¯çš„ç”Ÿæˆã€‚è¿™æ ·ä¸€æ¥ï¼Œä¾¿å¯æ›´å¥½åœ°æ§åˆ¶ç»“æœçš„è¾“å‡ºå’Œå¤„ç†ã€‚ä¸€æ¬¡å¯å‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œè€Œä¸”æäº¤çš„è¯·æ±‚ä¸ä¼šå‡ºç°é˜»å¡çš„æƒ…å†µã€‚è¯·æ±‚å§‹ç»ˆæŒ‰ç…§æ¥æ”¶çš„é¡ºåºè¿›è¡Œå¤„ç†ã€‚</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-05-camera2api.png.png" alt="Alt text"></p>
<h5 id="1-2-2ã€HAL-å’Œç›¸æœºå­ç³»ç»Ÿ"><a href="#1-2-2ã€HAL-å’Œç›¸æœºå­ç³»ç»Ÿ" class="headerlink" title="1.2.2ã€HAL å’Œç›¸æœºå­ç³»ç»Ÿ"></a>1.2.2ã€HAL å’Œç›¸æœºå­ç³»ç»Ÿ</h5><p>ç›¸æœºå­ç³»ç»ŸåŒ…æ‹¬ç›¸æœºç®¡é“ä¸­ç»„ä»¶çš„å®ç°ï¼Œä¾‹å¦‚ 3A ç®—æ³•å’Œå¤„ç†æ§ä»¶ã€‚ç›¸æœº HAL ä¸ºæ‚¨æä¾›äº†å®ç°æ‚¨ç‰ˆæœ¬çš„è¿™äº›ç»„ä»¶æ‰€éœ€çš„æ¥å£ã€‚ä¸ºäº†ä¿æŒå¤šä¸ªè®¾å¤‡åˆ¶é€ å•†å’Œå›¾åƒä¿¡å·å¤„ç†å™¨ï¼ˆISPï¼Œä¹Ÿç§°ä¸ºç›¸æœºä¼ æ„Ÿå™¨ï¼‰ä¾›åº”å•†ä¹‹é—´çš„è·¨å¹³å°å…¼å®¹æ€§ï¼Œç›¸æœºç®¡é“æ¨¡å‹æ˜¯è™šæ‹Ÿçš„ï¼Œä¸”ä¸ç›´æ¥å¯¹åº”ä»»ä½•çœŸæ­£çš„ ISPã€‚ä¸è¿‡ï¼Œå®ƒä¸çœŸæ­£çš„å¤„ç†ç®¡é“è¶³å¤Ÿç›¸ä¼¼ï¼Œå› æ­¤æ‚¨å¯ä»¥æœ‰æ•ˆåœ°å°†å…¶æ˜ å°„åˆ°ç¡¬ä»¶ã€‚æ­¤å¤–ï¼Œå®ƒè¶³å¤ŸæŠ½è±¡ï¼Œå¯æ”¯æŒå¤šç§ä¸åŒçš„ç®—æ³•å’Œæ“ä½œé¡ºåºï¼Œè€Œä¸ä¼šå½±å“è´¨é‡ã€æ•ˆç‡æˆ–è·¨è®¾å¤‡å…¼å®¹æ€§ã€‚<br>ç›¸æœºç®¡é“è¿˜æ”¯æŒåº”ç”¨æ¡†æ¶å¼€å¯è‡ªåŠ¨å¯¹ç„¦ç­‰åŠŸèƒ½çš„è§¦å‘å™¨ã€‚å®ƒè¿˜ä¼šå°†é€šçŸ¥å‘é€å›åº”ç”¨æ¡†æ¶ï¼Œä»¥é€šçŸ¥åº”ç”¨è‡ªåŠ¨å¯¹ç„¦é”å®šæˆ–é”™è¯¯ç­‰äº‹ä»¶ã€‚</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-06-camera_hal_request_control.png.png" alt="Alt text"></p>
<blockquote>
<p>RAW Bayer è¾“å‡ºåœ¨ ISP å†…éƒ¨ä¸ç»è¿‡ä»»ä½•å¤„ç†ã€‚<br>ç»Ÿè®¡ä¿¡æ¯æ ¹æ®åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®ç”Ÿæˆã€‚<br>å°†åŸå§‹ä¼ æ„Ÿå™¨æ•°æ®è½¬æ¢ä¸º YUV çš„å„ç§å¤„ç†å—æŒ‰ä»»æ„é¡ºåºæ’åˆ—ã€‚<br>å½“æ˜¾ç¤ºå¤šä¸ªåˆ»åº¦å’Œå‰ªè£å•å…ƒæ—¶ï¼Œæ‰€æœ‰çš„ç¼©æ”¾å™¨å•å…ƒå…±äº«è¾“å‡ºåŒºåŸŸæ§ä»¶ï¼ˆæ•°å­—ç¼©æ”¾ï¼‰ã€‚ä¸è¿‡ï¼Œæ¯ä¸ªå•å…ƒéƒ½å¯èƒ½å…·æœ‰ä¸åŒçš„è¾“å‡ºåˆ†è¾¨ç‡å’Œåƒç´ æ ¼å¼ã€‚</p>
</blockquote>
<h5 id="1-2-3ã€HAL-æ“ä½œæ‘˜è¦"><a href="#1-2-3ã€HAL-æ“ä½œæ‘˜è¦" class="headerlink" title="1.2.3ã€HAL æ“ä½œæ‘˜è¦"></a>1.2.3ã€HAL æ“ä½œæ‘˜è¦</h5><p>â˜¯ æ•è·çš„å¼‚æ­¥è¯·æ±‚æ¥è‡ªäºæ¡†æ¶ã€‚<br>â˜¯ HAL è®¾å¤‡å¿…é¡»æŒ‰é¡ºåºå¤„ç†è¯·æ±‚ã€‚å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œå‡äº§ç”Ÿè¾“å‡ºç»“æœå…ƒæ•°æ®ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªè¾“å‡ºå›¾ç‰‡ç¼“å†²åŒºã€‚<br>â˜¯ è¯·æ±‚å’Œç»“æœä»¥åŠåç»­è¯·æ±‚å¼•ç”¨çš„æµéµå®ˆå…ˆè¿›å…ˆå‡ºè§„åˆ™ã€‚<br>â˜¯ æŒ‡å®šè¯·æ±‚çš„æ‰€æœ‰è¾“å‡ºçš„æ—¶é—´æˆ³å¿…é¡»å®Œå…¨ç›¸åŒï¼Œä»¥ä¾¿æ¡†æ¶å¯ä»¥æ ¹æ®éœ€è¦å°†å®ƒä»¬åŒ¹é…åœ¨ä¸€èµ·ã€‚<br>â˜¯ æ‰€æœ‰æ•è·é…ç½®å’ŒçŠ¶æ€ï¼ˆä¸åŒ…æ‹¬ 3A ä¾‹ç¨‹ï¼‰éƒ½åŒ…å«åœ¨è¯·æ±‚å’Œç»“æœä¸­ã€‚</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-07-camera-hal-overview-oo.png.png" alt="Alt text"></p>
<h5 id="1-2-4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº"><a href="#1-2-4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº" class="headerlink" title="1.2.4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº"></a>1.2.4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº</h5><p>1ã€æ¡†æ¶è°ƒç”¨ camera_module_t-&gt;common.open()ï¼Œè€Œè¿™ä¼šè¿”å›ä¸€ä¸ª hardware_device_t ç»“æ„ã€‚<br>2ã€æ¡†æ¶æ£€æŸ¥ hardware_device_t-&gt;version å­—æ®µï¼Œå¹¶ä¸ºè¯¥ç‰ˆæœ¬çš„ç›¸æœºç¡¬ä»¶è®¾å¤‡å®ä¾‹åŒ–ç›¸åº”çš„å¤„ç†ç¨‹åºã€‚å¦‚æœç‰ˆæœ¬æ˜¯ CAMERA_DEVICE_API_VERSION_3_0ï¼Œåˆ™è¯¥è®¾å¤‡ä¼šè½¬å‹ä¸º camera3_device_tã€‚<br>3ã€æ¡†æ¶è°ƒç”¨ camera3_device_t-&gt;ops-&gt;initialize() å¹¶æ˜¾ç¤ºæ¡†æ¶å›è°ƒå‡½æ•°æŒ‡é’ˆã€‚åœ¨è°ƒç”¨ ops ç»“æ„ä¸­çš„ä»»ä½•å…¶ä»–å‡½æ•°ä¹‹å‰ï¼Œè¿™åªä¼šåœ¨ open() ä¹‹åè°ƒç”¨ä¸€æ¬¡ã€‚<br>4ã€æ¡†æ¶è°ƒç”¨ camera3_device_t-&gt;ops-&gt;configure_streams() å¹¶æ˜¾ç¤ºåˆ° HAL è®¾å¤‡çš„è¾“å…¥/è¾“å‡ºæµåˆ—è¡¨ã€‚<br>5ã€æ¡†æ¶ä¸º configure_streams ä¸­åˆ—å‡ºçš„è‡³å°‘ä¸€ä¸ªè¾“å‡ºæµåˆ†é… gralloc ç¼“å†²åŒºå¹¶è°ƒç”¨ camera3_device_t-&gt;ops-&gt;register_stream_buffers()ã€‚ç›¸åŒçš„æµä»…æ³¨å†Œä¸€æ¬¡ã€‚<br>6ã€æ¡†æ¶é€šè¿‡è°ƒç”¨ camera3_device_t-&gt;ops-&gt;construct_default_request_settings() æ¥ä¸ºæŸäº›ä½¿ç”¨æƒ…å½¢è¯·æ±‚é»˜è®¤è®¾ç½®ã€‚è¿™å¯èƒ½ä¼šåœ¨ç¬¬ 3 æ­¥ä¹‹åçš„ä»»ä½•æ—¶é—´å‘ç”Ÿã€‚<br>7ã€æ¡†æ¶é€šè¿‡åŸºäºå…¶ä¸­ä¸€ç»„é»˜è®¤è®¾ç½®çš„è®¾ç½®ä»¥åŠè‡³å°‘ä¸€ä¸ªæ¡†æ¶ä¹‹å‰æ³¨å†Œçš„è¾“å‡ºæµæ¥æ„å»ºç¬¬ä¸€ä¸ªæ•è·è¯·æ±‚å¹¶å°†å…¶å‘é€åˆ° HALã€‚å®ƒé€šè¿‡ camera3_device_t-&gt;ops-&gt;process_capture_request() å‘é€åˆ° HALã€‚HAL å¿…é¡»é˜»æ­¢æ­¤è°ƒç”¨è¿”å›ï¼Œç›´åˆ°å‡†å¤‡å¥½å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚<br>8ã€æ¡†æ¶ç»§ç»­æäº¤è¯·æ±‚ï¼Œå¹¶ä¸”å¯èƒ½ä¼šä¸ºå°šæœªæ³¨å†Œçš„æµè°ƒç”¨ register_stream_buffers()ï¼Œå¹¶è°ƒç”¨ construct_default_request_settings æ¥ä¸ºå…¶ä»–ä½¿ç”¨æƒ…å½¢è·å–é»˜è®¤è®¾ç½®ç¼“å†²åŒºã€‚<br>9ã€å½“è¯·æ±‚æ•è·å¼€å§‹ï¼ˆä¼ æ„Ÿå™¨å¼€å§‹æ›å…‰ä»¥è¿›è¡Œæ•è·ï¼‰æ—¶ï¼ŒHAL ä¼šè°ƒç”¨ camera3_callback_ops_t-&gt;notify() å¹¶æ˜¾ç¤º SHUTTER äº‹ä»¶ï¼ŒåŒ…æ‹¬å¸§å·å’Œå¼€å§‹æ›å…‰çš„æ—¶é—´æˆ³ã€‚æ­¤é€šçŸ¥è°ƒç”¨å¿…é¡»åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å¸§å·çš„ process_capture_result() ä¹‹å‰è¿›è¡Œã€‚<br>10ã€åœ¨æŸä¸ªç®¡é“å»¶è¿Ÿåï¼ŒHAL å¼€å§‹ä½¿ç”¨ camera3_callback_ops_t-&gt;process_capture_result() å°†å®Œæˆçš„æ•è·è¿”å›åˆ°æ¡†æ¶ã€‚è¿™äº›æ•è·æŒ‰ç…§ä¸æäº¤è¯·æ±‚ç›¸åŒçš„é¡ºåºè¿”å›ã€‚ä¸€æ¬¡å¯å‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œå…·ä½“å–å†³äºç›¸æœº HAL è®¾å¤‡çš„ç®¡é“æ·±åº¦ã€‚<br>11ã€ä¸€æ®µæ—¶é—´åï¼Œæ¡†æ¶å¯èƒ½ä¼šåœæ­¢æäº¤æ–°çš„è¯·æ±‚ã€ç­‰å¾…ç°æœ‰æ•è·å®Œæˆï¼ˆæ‰€æœ‰ç¼“å†²åŒºéƒ½å·²å¡«å……ï¼Œæ‰€æœ‰ç»“æœéƒ½å·²è¿”å›ï¼‰ï¼Œç„¶åå†æ¬¡è°ƒç”¨ configure_streams()ã€‚è¿™ä¼šé‡ç½®ç›¸æœºç¡¬ä»¶å’Œç®¡é“ï¼Œä»¥è·å¾—ä¸€ç»„æ–°çš„è¾“å…¥/è¾“å‡ºæµã€‚å¯é‡å¤ä½¿ç”¨å…ˆå‰é…ç½®ä¸­çš„éƒ¨åˆ†æµï¼›å¦‚æœè¿™äº›æµçš„ç¼“å†²åŒºå·²ç»è¿‡ HAL æ³¨å†Œï¼Œåˆ™ä¸ä¼šå†æ¬¡æ³¨å†Œã€‚å¦‚æœè‡³å°‘è¿˜æœ‰ä¸€ä¸ªå·²æ³¨å†Œçš„è¾“å‡ºæµï¼Œåˆ™æ¡†æ¶ä»ç¬¬ 7 æ­¥ç»§ç»­ï¼ˆå¦åˆ™ï¼Œéœ€è¦å…ˆå®Œæˆç¬¬ 5 æ­¥ï¼‰ã€‚<br>12ã€æˆ–è€…ï¼Œæ¡†æ¶å¯èƒ½ä¼šè°ƒç”¨ camera3_device_t-&gt;common-&gt;close() ä»¥ç»“æŸç›¸æœºä¼šè¯ã€‚å½“æ¡†æ¶ä¸­æ²¡æœ‰å…¶ä»–å¤„äºæ´»åŠ¨çŠ¶æ€çš„è°ƒç”¨æ—¶ï¼Œå®ƒå¯èƒ½éšæ—¶ä¼šè¢«è°ƒç”¨ï¼›å°½ç®¡åœ¨æ‰€æœ‰å‘èµ·çš„æ•è·å®Œæˆï¼ˆæ‰€æœ‰ç»“æœéƒ½å·²è¿”å›ï¼Œæ‰€æœ‰ç¼“å†²åŒºéƒ½å·²å¡«å……ï¼‰ä¹‹å‰ï¼Œè°ƒç”¨å¯èƒ½ä¼šé˜»å¡ã€‚åœ¨ close è°ƒç”¨è¿”å›åï¼Œä¸å…è®¸å†ä» HAL å¯¹ camera3_callback_ops_t å‡½æ•°è¿›è¡Œæ›´å¤šè°ƒç”¨ã€‚ä¸€æ—¦è¿›è¡Œ close() è°ƒç”¨ï¼Œè¯¥æ¡†æ¶å¯èƒ½ä¸ä¼šè°ƒç”¨ä»»ä½•å…¶ä»– HAL è®¾å¤‡å‡½æ•°ã€‚<br>13ã€åœ¨å‘ç”Ÿé”™è¯¯æˆ–å…¶ä»–å¼‚æ­¥äº‹ä»¶æ—¶ï¼ŒHAL å¿…é¡»è°ƒç”¨ camera3_callback_ops_t-&gt;notify() å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯/äº‹ä»¶æ¶ˆæ¯ã€‚ä»ä¸¥é‡çš„è®¾å¤‡èŒƒå›´é”™è¯¯é€šçŸ¥è¿”å›åï¼ŒHAL åº”è¡¨ç°ä¸ºåœ¨å…¶ä¸Šè°ƒç”¨äº† close()ã€‚ä½†æ˜¯ï¼ŒHAL å¿…é¡»åœ¨è°ƒç”¨ notify() ä¹‹å‰å–æ¶ˆæˆ–å®Œæˆæ‰€æœ‰å¾…å¤„ç†çš„æ•è·ï¼Œä»¥ä¾¿åœ¨è°ƒç”¨ notify() å¹¶è¿”å›ä¸¥é‡é”™è¯¯æ—¶ï¼Œæ¡†æ¶ä¸ä¼šæ”¶åˆ°æ¥è‡ªè®¾å¤‡çš„æ›´å¤šå›è°ƒã€‚åœ¨ä¸¥é‡çš„é”™è¯¯æ¶ˆæ¯è¿”å› notify() æ–¹æ³•åï¼Œclose() ä¹‹å¤–çš„æ–¹æ³•åº”è¯¥è¿”å› -ENODEV æˆ– NULLã€‚</p>
<h5 id="1-3ã€Android-Graphics-å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»"><a href="#1-3ã€Android-Graphics-å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»" class="headerlink" title="1.3ã€Android Graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»"></a>1.3ã€Android Graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-08-Android-graphics-SurfaceFlinger-BufferQueue.jpg.png" alt="Alt text"></p>
<p>Graphics ç³»ç»Ÿè¯¦ç»†åˆ†æè¯·å‚è€ƒï¼šã€Android 7.1.2 (Android N) Android Graphics ç³»ç»Ÿåˆ†æã€‘()</p>
<h5 id="1-4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨"><a href="#1-4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨" class="headerlink" title="1.4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨"></a>1.4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨</h5><h5 id="1-4-1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ"><a href="#1-4-1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ" class="headerlink" title="1.4.1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ"></a>1.4.1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-09-Android-Camera-class.png" alt="Alt text"></p>
<p>â˜¯ 1ã€ICameraClient: è¿™ä¸»è¦æ˜¯ä¸€äº›æ¶ˆæ¯å‘é€çš„æ¥å£ï¼ŒåŒ…æ‹¬å¸§å¯ç”¨é€šçŸ¥ï¼Œå›è°ƒä¸€äº›ä¿¡æ¯ç»™clientç­‰æ¶ˆæ¯ã€‚ä¸è¿‡è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼ŒBnCameraClientå¯¹è±¡å…¶å®æ˜¯åœ¨clientè¿™ç«¯ï¼Œä¸åœ¨CameraServiceç«¯ã€‚<br>â˜¯ 2ã€ICamera:cameraçš„ä¸€äº›æ ‡å‡†æ“ä½œæ¥å£ï¼Œæ¯”å¦‚startpreviewï¼Œtakepicuture,autofocus,æ‰€æœ‰çš„æ“ä½œåŠ¨ä½œéƒ½æ˜¯ç”¨çš„è¿™ä¸€å¥—æ¥å£ã€‚<br>â˜¯ 3ã€ICameraService: é“¾æ¥CameraæœåŠ¡ï¼ŒCamera device,è·å–Cameraæ•°é‡ï¼ŒCameraç¡¬ä»¶ä¿¡æ¯ï¼Œè§†å‚è§’ï¼Œé•œå¤´ç­‰ä¿¡æ¯ã€‚</p>
<h5 id="1-4-2ã€ICameraClient"><a href="#1-4-2ã€ICameraClient" class="headerlink" title="1.4.2ã€ICameraClient"></a>1.4.2ã€ICameraClient</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-10-ICameraClient.png" alt="Alt text"></p>
<h5 id="1-4-3ã€ICamera"><a href="#1-4-3ã€ICamera" class="headerlink" title="1.4.3ã€ICamera"></a>1.4.3ã€ICamera</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-11-ICamera.png" alt="Alt text"></p>
<h5 id="1-4-4ã€ICameraService"><a href="#1-4-4ã€ICameraService" class="headerlink" title="1.4.4ã€ICameraService"></a>1.4.4ã€ICameraService</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-12-ICameraService.png" alt="Alt text"></p>
<h4 id="ï¼ˆäºŒï¼‰ã€Android-CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ"><a href="#ï¼ˆäºŒï¼‰ã€Android-CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ" class="headerlink" title="ï¼ˆäºŒï¼‰ã€Android CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ"></a>ï¼ˆäºŒï¼‰ã€Android CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ</h4><p>é¦–å…ˆçœ‹ä¸‹æ€»ä½“æ—¶åºå›¾ï¼š</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-13-CameraService_onFirstRef.png" alt="Alt text"></p>
<h5 id="2-1ã€CameraService-åˆå§‹åŒ–è¿‡ç¨‹"><a href="#2-1ã€CameraService-åˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="2.1ã€CameraService åˆå§‹åŒ–è¿‡ç¨‹"></a>2.1ã€CameraService åˆå§‹åŒ–è¿‡ç¨‹</h5><p>Androidå¯åŠ¨çš„æ—¶å€™ä¼šæ”¶é›†ç³»ç»Ÿçš„.rcæ–‡ä»¶ï¼Œå¯åŠ¨å¯¹åº”çš„Native Serviceï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\camera\cameraserver\cameraserver.rc]</span><br><span class="line">service cameraserver /system/bin/cameraserver</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">user</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class">    <span class="title">group</span> <span class="title">audio</span> <span class="title">camera</span> <span class="title">input</span> <span class="title">drmrpc</span></span></span><br><span class="line"><span class="class">    <span class="title">ioprio</span> <span class="title">rt</span> 4</span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">camera</span>-<span class="title">daemon</span>/<span class="title">tasks</span> /<span class="title">dev</span>/<span class="title">stune</span>/<span class="title">top</span>-<span class="title">app</span>/<span class="title">tasks</span></span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\camera\cameraserver\main_cameraserver.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __unused, <span class="keyword">char</span>** argv __unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal(SIGPIPE, SIG_IGN);</span><br><span class="line">    <span class="function">sp&lt;ProcessState&gt; <span class="title">proc</span><span class="params">(ProcessState::self())</span></span>;</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = defaultServiceManager();</span><br><span class="line">    ALOGI(<span class="string">&quot;ServiceManager: %p&quot;</span>, sm.get());</span><br><span class="line">    CameraService::instantiate();</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraServiceç»§æ‰¿è‡ªBinderServiceï¼Œinstantiateä¹Ÿæ˜¯åœ¨BinderServiceä¸­å®šä¹‰çš„ï¼Œæ­¤æ–¹æ³•å°±æ˜¯è°ƒç”¨publishæ–¹æ³•ï¼Œæ‰€ä»¥æ¥çœ‹publishæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\include\binder\BinderService.h]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">status_t</span> <span class="title">publish</span><span class="params">(<span class="keyword">bool</span> allowIsolated = <span class="literal">false</span>)</span> </span>&#123;</span><br><span class="line">    <span class="function">sp&lt;IServiceManager&gt; <span class="title">sm</span><span class="params">(defaultServiceManager())</span></span>;</span><br><span class="line">    <span class="comment">//å°†æœåŠ¡æ·»åŠ åˆ°ServiceManager</span></span><br><span class="line">    <span class="keyword">return</span> sm-&gt;addService(String16(SERVICE::getServiceName()),<span class="keyword">new</span> SERVICE(), allowIsolated);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œå°†ä¼šæŠŠCameraServiceæœåŠ¡åŠ å…¥åˆ°ServiceManagerè¿›è¡Œç®¡ç†ã€‚ CameraServiceçš„æ„é€ æ—¶ï¼Œä¼šè°ƒç”¨CameraServiceçš„onFirstRefæ–¹æ³•ï¼š</p>
<h5 id="2-1-1ã€CameraService-onFirstRef"><a href="#2-1-1ã€CameraService-onFirstRef" class="headerlink" title="2.1.1ã€CameraService::onFirstRef()"></a>2.1.1ã€CameraService::onFirstRef()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CameraService::onFirstRef</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ALOGI(<span class="string">&quot;CameraService process starting&quot;</span>);</span><br><span class="line"></span><br><span class="line">    BnCameraService::onFirstRef();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update battery life tracking if service is restarting</span></span><br><span class="line">    <span class="function">BatteryNotifier&amp; <span class="title">notifier</span><span class="params">(BatteryNotifier::getInstance())</span></span>;</span><br><span class="line">    notifier.noteResetCamera();</span><br><span class="line">    notifier.noteResetFlashlight();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">camera_module_t</span> *rawModule;</span><br><span class="line">    <span class="keyword">int</span> err = hw_get_module(CAMERA_HARDWARE_MODULE_ID,</span><br><span class="line">            (<span class="keyword">const</span> <span class="keyword">hw_module_t</span> **)&amp;rawModule);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    mModule = <span class="keyword">new</span> CameraModule(rawModule);</span><br><span class="line">    err = mModule-&gt;init();</span><br><span class="line">    ......</span><br><span class="line">    mFlashlight = <span class="keyword">new</span> CameraFlashlight(*mModule, *<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">status_t</span> res = mFlashlight-&gt;findFlashUnits();</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mModule-&gt;getModuleApiVersion() &gt;= CAMERA_MODULE_API_VERSION_2_1) &#123;</span><br><span class="line">        mModule-&gt;setCallbacks(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CameraService::pingCameraServiceProxy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šé€šè¿‡HALæ¡†æ¶çš„hw_get_moduleæ¥åˆ›å»ºCameraModuleå¯¹è±¡ï¼Œç„¶åä¼šå¯¹å…¶è¿›è¡Œç›¸åº”çš„åˆå§‹åŒ–ï¼Œå¹¶ä¼šè¿›è¡Œä¸€äº›å‚æ•°çš„è®¾ç½®ï¼Œå¦‚cameraçš„æ•°é‡ï¼Œé—ªå…‰ç¯çš„åˆå§‹åŒ–ï¼Œä»¥åŠå›è°ƒå‡½æ•°çš„è®¾ç½®ç­‰ï¼Œåˆ°è¿™é‡Œï¼ŒCamera2 HALçš„æ¨¡å—å°±åˆå§‹åŒ–ç»“æŸäº†ã€‚</p>
<h5 id="2-1-2ã€Camera-åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹"><a href="#2-1-2ã€Camera-åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹" class="headerlink" title="2.1.2ã€Camera åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹"></a>2.1.2ã€Camera åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹</h5><p>åœ¨æºç ä¸­ä¸çŸ¥å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°ç¬¬äºŒä¸ªå‚æ•°æ˜¯hw_module_t <strong>module,è¿™é‡Œæ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œè€Œæˆ‘ä»¬åˆšæ‰ä¼ çš„æ˜¯camera_module_t</strong>æŒ‡é’ˆã€‚å¤§å®¶å¯ä»¥çœ‹åˆ°camera_module_t ç»“æ„ç¬¬ä¸€ä¸ªåŸŸå°±æ˜¯hw_module_t æ‰€ä»¥è¿™é‡Œå°±ä¸éš¾ç†è§£äº†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">æºç è·¯å¾„ï¼šhardware/libhardware/hardware.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Base path of the hal modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH1 <span class="meta-string">&quot;/system/lib/hw&quot;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HAL_LIBRARY_PATH2 <span class="meta-string">&quot;/vendor/lib/hw&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hw_get_module</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id, <span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> **<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hw_get_module_by_class(id, <span class="literal">NULL</span>, <span class="keyword">module</span>); </span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„idå°±æ˜¯cameraæ¨¡å—çš„idï¼Œæ¯ä¸€ä¸ªhal moduleéƒ½æœ‰å¯¹åº”çš„idï¼Œ</span></span><br><span class="line">    <span class="comment">//åŒºåˆ†ä»–ä»¬å°±é€šè¿‡è¿™ä¸ªidæ¥åŒºåˆ†äº†ã€‚</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hw_get_module_by_class</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *class_id, <span class="keyword">const</span> <span class="keyword">char</span> *inst,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> **<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> *<span class="title">hmi</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="keyword">char</span> prop[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> path[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> name[PATH_MAX];</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* Loop through the configuration variants looking for a module */</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span> ; i&lt;HAL_VARIANT_KEYS_COUNT+<span class="number">1</span> ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; HAL_VARIANT_KEYS_COUNT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (property_get(variant_keys[i], prop, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123; <span class="comment">//å…³é”®å­—æ•°ç»„ï¼Œä¸Šé¢æœ‰å®ä»£ç ã€‚</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">&quot;%s/%s.%s.so&quot;</span>,</span><br><span class="line">                     HAL_LIBRARY_PATH2, name, prop);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">&quot;%s/%s.%s.so&quot;</span>, <span class="comment">//æ‹¼æ¥å®Œæ•´çš„cameraåº“ã€‚</span></span><br><span class="line">                     HAL_LIBRARY_PATH1, name, prop);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">&quot;%s/%s.default.so&quot;</span>,</span><br><span class="line">                     HAL_LIBRARY_PATH2, name);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">&quot;%s/%s.default.so&quot;</span>,</span><br><span class="line">                     HAL_LIBRARY_PATH1, name);</span><br><span class="line">            <span class="keyword">if</span> (access(path, R_OK) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = -ENOENT;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; HAL_VARIANT_KEYS_COUNT+<span class="number">1</span>) &#123;</span><br><span class="line">        status = load(class_id, path, <span class="keyword">module</span>); <span class="comment">//å¦‚æœä¸Šé¢éƒ½è¿›è¡Œå®Œæ¯•ï¼Œèµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜å·²ç»æ‰¾åˆ°åº“äº†ï¼Œè¿™é‡Œå°±å»åŠ è½½ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ ¹æ®idæ¥åŠ è½½halçš„module</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">load</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *id,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> <span class="keyword">char</span> *path,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> **pHmi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">void</span> *handle;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> *<span class="title">hmi</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    handle = dlopen(path, RTLD_NOW); <span class="comment">//åŠ¨æ€åŠ è½½å†…å­˜çš„apiï¼Œè¿™é‡Œçš„path=/system/lib/hw/camera.msm8996.so</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">/* Get the address of the struct hal_module_info. */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sym = HAL_MODULE_INFO_SYM_AS_STR;   <span class="comment">//åˆ«çš„åœ°æ–¹å®šä¹‰#define HAL_MODULE_INFO_SYM_AS_STR  &quot;HMI&quot;</span></span><br><span class="line">    hmi = (struct <span class="keyword">hw_module_t</span> *)dlsym(handle, sym); <span class="comment">//æˆ‘ä»¬åŠ¨æ€é“¾æ¥çš„æ˜¯&quot;HMI&quot;è¿™ä¸ªç¬¦å·ã€‚</span></span><br><span class="line">    ......</span><br><span class="line">    *pHmi = hmi; <span class="comment">//æœ€åå°†è¿™ä¸ªæŒ‡é’ˆï¼Œèµ‹ç»™æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ struct camera_moduleå˜é‡ã€‚è¿™é‡Œæ¨¡å—å°±åŠ è½½è¿›æ¥äº†ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//halä»£ç </span></span><br><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\QCamera2Hal.cpp]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">hw_module_t</span> camera_common = &#123;</span><br><span class="line">    .tag                    = HARDWARE_MODULE_TAG,</span><br><span class="line">    .module_api_version     = CAMERA_MODULE_API_VERSION_2_4,</span><br><span class="line">    .hal_api_version        = HARDWARE_HAL_API_VERSION,</span><br><span class="line">    .id                     = CAMERA_HARDWARE_MODULE_ID,</span><br><span class="line">    .name                   = <span class="string">&quot;QCamera Module&quot;</span>,</span><br><span class="line">    .author                 = <span class="string">&quot;Qualcomm Innovation Center Inc&quot;</span>,</span><br><span class="line">    .methods                = &amp;qcamera::QCamera2Factory::mModuleMethods, <span class="comment">//å®ƒçš„æ–¹æ³•æ•°ç»„é‡Œç»‘å®šäº†openæ¥å£</span></span><br><span class="line">    .dso                    = <span class="literal">NULL</span>,</span><br><span class="line">    .reserved               = &#123;<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">camera_module_t</span> HAL_MODULE_INFO_SYM = &#123;</span><br><span class="line">    .common                 = camera_common,</span><br><span class="line">    .get_number_of_cameras  = qcamera::QCamera2Factory::get_number_of_cameras,</span><br><span class="line">    .get_camera_info        = qcamera::QCamera2Factory::get_camera_info,</span><br><span class="line">    .set_callbacks          = qcamera::QCamera2Factory::set_callbacks,</span><br><span class="line">    .get_vendor_tag_ops     = qcamera::QCamera3VendorTags::get_vendor_tag_ops,</span><br><span class="line">    .open_legacy            = qcamera::QCamera2Factory::open_legacy,</span><br><span class="line">    .set_torch_mode         = qcamera::QCamera2Factory::set_torch_mode,</span><br><span class="line">    .init                   = <span class="literal">NULL</span>,</span><br><span class="line">    .reserved               = &#123;<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span> <span class="title">QCamera2Factory</span>:</span>:mModuleMethods = &#123;</span><br><span class="line">    <span class="comment">//openæ–¹æ³•çš„ç»‘å®š</span></span><br><span class="line">    open: QCamera2Factory::camera_device_open,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Camera HALå±‚çš„openå…¥å£å…¶å®å°±æ˜¯camera_device_openæ–¹æ³•ï¼š</p>
<h5 id="2-1-3ã€å›¾è§£camera-moduleå’Œcamera-device-tå…³ç³»"><a href="#2-1-3ã€å›¾è§£camera-moduleå’Œcamera-device-tå…³ç³»" class="headerlink" title="2.1.3ã€å›¾è§£camera_moduleå’Œcamera_device_tå…³ç³»"></a>2.1.3ã€å›¾è§£camera_moduleå’Œcamera_device_tå…³ç³»</h5><p>camer moduleåœ¨ç³»ç»Ÿä¸­è½¬æŒ‡cameraæ¨¡å—ï¼Œcamera_device_t è½¬æŒ‡æŸä¸€ä¸ªcamera è®¾å¤‡ã€‚åœ¨æµç¨‹ä¸Šï¼Œnative framwork å…ˆåŠ è½½åœ¨halå±‚å®šä¹‰çš„camer_moduleå¯¹è±¡ï¼Œç„¶åé€šè¿‡camera_moduleçš„methods openæ–¹æ³•å¡«å……camera_device_t ç»“æ„ä½“ï¼Œå¹¶æœ€ç»ˆè·å–åˆ°camera opsè¿™ä¸€æ•´ä¸ªcameraæœ€é‡è¦çš„æ“ä½œé›†åˆã€‚ä¸‹å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°struct hw_module_tåœ¨camera_moduleæœ€ä¸Šé¢ è€Œcamera_device_tæœ€å¼€å§‹ä¿å­˜çš„æ˜¯struct hw_device_t. ç”±æ­¤æˆ‘ä»¬å¹³æ—¶åœ¨çœ‹ä»£ç æ—¶ï¼Œè¦æ³¨æ„ä¸€äº›æŒ‡é’ˆè½¬æ¢ã€‚</p>
<p>![Alt text](<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-14-camera_module">https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-14-camera_module</a> camera_device_t.png)</p>
<h4 id="ï¼ˆä¸‰ï¼‰ã€Android-Camera-Openè¿‡ç¨‹"><a href="#ï¼ˆä¸‰ï¼‰ã€Android-Camera-Openè¿‡ç¨‹" class="headerlink" title="ï¼ˆä¸‰ï¼‰ã€Android Camera Openè¿‡ç¨‹"></a>ï¼ˆä¸‰ï¼‰ã€Android Camera Openè¿‡ç¨‹</h4><h5 id="3-1ã€Camera2-HALå±‚Open-è¿‡ç¨‹åˆ†æ"><a href="#3-1ã€Camera2-HALå±‚Open-è¿‡ç¨‹åˆ†æ" class="headerlink" title="3.1ã€Camera2 HALå±‚Open()è¿‡ç¨‹åˆ†æ"></a>3.1ã€Camera2 HALå±‚Open()è¿‡ç¨‹åˆ†æ</h5><p>é«˜é€šçš„Cameraï¼Œå®ƒåœ¨åå°ä¼šæœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹daemonï¼Œdaemonæ˜¯ä»‹äºåº”ç”¨å’Œé©±åŠ¨ä¹‹é—´ç¿»è¯‘ioctlçš„ä¸­é—´å±‚(å§”æ‰˜å¤„ç†)ã€‚æœ¬èŠ‚å°†ä»¥Cameraä¸­çš„openæµç¨‹ä¸ºä¾‹ï¼Œæ¥åˆ†æCamera HALçš„å·¥ä½œè¿‡ç¨‹ï¼Œåœ¨åº”ç”¨å¯¹ç¡¬ä»¶å‘å‡ºopenè¯·æ±‚åï¼Œä¼šé€šè¿‡Camera HALæ¥å‘èµ·openè¯·æ±‚ï¼Œè€ŒCamera HALçš„openå…¥å£åœ¨QCamera2Hal.cppè¿›è¡Œäº†å®šä¹‰ï¼Œå³å‰é¢åˆ†æçš„Camera HALå±‚çš„openå…¥å£å…¶å®å°±æ˜¯camera_device_openæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\QCamera2Factory.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">QCamera2Factory::camera_device_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span> *<span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span> *id,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct <span class="keyword">hw_device_t</span> **hw_device)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> gQCamera2Factory-&gt;cameraDeviceOpen(atoi(id), hw_device);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒè°ƒç”¨äº†cameraDeviceOpenæ–¹æ³•ï¼Œè€Œå…¶ä¸­çš„hw_deviceå°±æ˜¯æœ€åè¦è¿”å›ç»™åº”ç”¨å±‚çš„CameraDeviceImplåœ¨Camera HALå±‚çš„å¯¹è±¡ï¼Œç»§ç»­åˆ†æcameraDeviceOpenæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\QCamera2Factory.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">QCamera2Factory::cameraDeviceOpen</span><span class="params">(<span class="keyword">int</span> camera_id, struct <span class="keyword">hw_device_t</span> **hw_device)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//Camera2é‡‡ç”¨çš„Camera HALç‰ˆæœ¬ä¸ºHAL3.0</span></span><br><span class="line">    <span class="keyword">if</span> ( mHalDescriptors[camera_id].device_version == CAMERA_DEVICE_API_VERSION_3_0 ) &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–QCamera3HardwareInterfaceå¯¹è±¡ï¼Œè¿™é‡Œæ„é€ å‡½æ•°é‡Œå°†ä¼šè¿›è¡Œconfigure_streamsä»¥åŠ</span></span><br><span class="line">        <span class="comment">//process_capture_resultç­‰çš„ç»‘å®š</span></span><br><span class="line">        QCamera3HardwareInterface *hw = <span class="keyword">new</span> QCamera3HardwareInterface(</span><br><span class="line">            mHalDescriptors[camera_id].cameraId, mCallbacks);</span><br><span class="line">        <span class="comment">//é€šè¿‡QCamera3HardwareInterfaceæ¥æ‰“å¼€Camera</span></span><br><span class="line">        rc = hw-&gt;openCamera(hw_device);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mHalDescriptors[camera_id].device_version == CAMERA_DEVICE_API_VERSION_1_0) &#123;</span><br><span class="line">        <span class="comment">//HAL APIä¸º2.0</span></span><br><span class="line">        QCamera2HardwareInterface *hw = <span class="keyword">new</span> QCamera2HardwareInterface((<span class="keyword">uint32_t</span>)camera_id);</span><br><span class="line">        rc = hw-&gt;openCamera(hw_device);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ³•æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼šä¸€ä¸ªæ˜¯QCamera3HardwareInterfaceå¯¹è±¡çš„åˆ›å»ºï¼Œå®ƒæ˜¯ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´è¿›è¡Œäº¤äº’çš„æ¥å£ï¼›å¦ä¸€ä¸ªæ˜¯è°ƒç”¨å®ƒçš„openCameraæ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œä¸‹é¢å°†åˆ†åˆ«è¿›è¡Œåˆ†æã€‚</p>
<h5 id="3-1-1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ"><a href="#3-1-1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ" class="headerlink" title="3.1.1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ"></a>3.1.1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ</h5><p>åœ¨å®ƒçš„æ„é€ å‡½æ•°é‡Œé¢æœ‰ä¸€ä¸ªå…³é”®çš„åˆå§‹åŒ–ï¼Œå³mCameraDevice.ops = &amp;mCameraOpsï¼Œå®ƒä¼šå®šä¹‰Deviceæ“ä½œçš„æ¥å£ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="keyword">camera3_device_ops_t</span> QCamera3HardwareInterface::mCameraOps = &#123;</span><br><span class="line">    initialize:                         QCamera3HardwareInterface::initialize,</span><br><span class="line">    <span class="comment">//é…ç½®æµæ•°æ®çš„ç›¸å…³å¤„ç†</span></span><br><span class="line">    configure_streams:                  QCamera3HardwareInterface::configure_streams,</span><br><span class="line">    register_stream_buffers:            <span class="literal">NULL</span>,</span><br><span class="line">    construct_default_request_settings: </span><br><span class="line">        QCamera3HardwareInterface::construct_default_request_settings,</span><br><span class="line">    <span class="comment">//å¤„ç†ç»“æœçš„æ¥å£</span></span><br><span class="line">    process_capture_request:            </span><br><span class="line">        QCamera3HardwareInterface::process_capture_request,</span><br><span class="line">    get_metadata_vendor_tag_ops:        <span class="literal">NULL</span>,</span><br><span class="line">    dump:                               QCamera3HardwareInterface::dump,</span><br><span class="line">    flush:                              QCamera3HardwareInterface::flush,</span><br><span class="line">    reserved:                           &#123;<span class="number">0</span>&#125;,</span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œä¼šåœ¨configure_streamsä¸­é…ç½®å¥½æµçš„å¤„ç†handleï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">QCamera3HardwareInterface::configure_streams</span><span class="params">(<span class="keyword">const</span> struct camera3_device *device,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">camera3_stream_configuration_t</span> *stream_list)</span></span>&#123;</span><br><span class="line">    <span class="comment">//è·å¾—QCamera3HardwareInterfaceå¯¹è±¡</span></span><br><span class="line">    QCamera3HardwareInterface *hw =<span class="keyword">reinterpret_cast</span>&lt;QCamera3HardwareInterface *&gt;(device-&gt;priv);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è°ƒç”¨å®ƒçš„configureStreamsè¿›è¡Œé…ç½®</span></span><br><span class="line">    <span class="keyword">int</span> rc = hw-&gt;configureStreams(stream_list);</span><br><span class="line">    ..</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­è¿½è¸ªconfigureStreamæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">QCamera3HardwareInterface::configureStreams</span><span class="params">(<span class="keyword">camera3_stream_configuration_t</span> *streamList)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–Cameraç‰ˆæœ¬</span></span><br><span class="line">    al_version = CAM_HAL_V3;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//å¼€å§‹é…ç½®stream</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–ç›¸å…³Channelä¸ºNULL</span></span><br><span class="line">    <span class="keyword">if</span> (mMetadataChannel) &#123;</span><br><span class="line">        <span class="keyword">delete</span> mMetadataChannel;</span><br><span class="line">        mMetadataChannel = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mSupportChannel) &#123;</span><br><span class="line">        <span class="keyword">delete</span> mSupportChannel;</span><br><span class="line">        mSupportChannel = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAnalysisChannel) &#123;</span><br><span class="line">        <span class="keyword">delete</span> mAnalysisChannel;</span><br><span class="line">        mAnalysisChannel = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºMetadata Channelï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    mMetadataChannel = <span class="keyword">new</span> QCamera3MetadataChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">        mCameraHandle-&gt;ops, captureResultCb,&amp;gCamCapability[mCameraId]-&gt;padding_info, </span><br><span class="line">        CAM_QCOM_FEATURE_NONE, <span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">    rc = mMetadataChannel-&gt;initialize(IS_TYPE_NONE);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//å¦‚æœh/w supportå¯ç”¨ï¼Œåˆ™åˆ›å»ºåˆ†æstreamçš„Channel</span></span><br><span class="line">    <span class="keyword">if</span> (gCamCapability[mCameraId]-&gt;hw_analysis_supported) &#123;</span><br><span class="line">        mAnalysisChannel = <span class="keyword">new</span> QCamera3SupportChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">                mCameraHandle-&gt;ops,&amp;gCamCapability[mCameraId]-&gt;padding_info,</span><br><span class="line">                CAM_QCOM_FEATURE_PP_SUPERSET_HAL3,CAM_STREAM_TYPE_ANALYSIS,</span><br><span class="line">                &amp;gCamCapability[mCameraId]-&gt;analysis_recommended_res,<span class="keyword">this</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isRawStreamRequested = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//æ¸…ç©ºstreamé…ç½®ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;mStreamConfigInfo, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">cam_stream_size_info_t</span>));</span><br><span class="line">    <span class="comment">//ä¸ºrequested streamåˆ†é…ç›¸å…³çš„channelå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; streamList-&gt;num_streams; i++) &#123;</span><br><span class="line">        <span class="keyword">camera3_stream_t</span> *newStream = streamList-&gt;streams[i];</span><br><span class="line">        <span class="keyword">uint32_t</span> stream_usage = newStream-&gt;usage;</span><br><span class="line">        mStreamConfigInfo.stream_sizes[mStreamConfigInfo.num_streams].width = (<span class="keyword">int32_t</span>)newStream-</span><br><span class="line">                &gt;width;</span><br><span class="line">        mStreamConfigInfo.stream_sizes[mStreamConfigInfo.num_streams].height = (<span class="keyword">int32_t</span>)newStream-</span><br><span class="line">                &gt;height;</span><br><span class="line">        <span class="keyword">if</span> ((newStream-&gt;stream_type == CAMERA3_STREAM_BIDIRECTIONAL||newStream-&gt;usage &amp; </span><br><span class="line">                GRALLOC_USAGE_HW_CAMERA_ZSL) &amp;&amp;newStream-&gt;format == </span><br><span class="line">                HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED &amp;&amp; jpegStream)&#123;</span><br><span class="line">            mStreamConfigInfo.type[mStreamConfigInfo.num_streams] = CAM_STREAM_TYPE_SNAPSHOT;</span><br><span class="line">            mStreamConfigInfo.postprocess_mask[mStreamConfigInfo.num_streams] = </span><br><span class="line">                CAM_QCOM_FEATURE_NONE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(newStream-&gt;stream_type == CAMERA3_STREAM_INPUT) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (newStream-&gt;format) &#123;</span><br><span class="line">                <span class="comment">//ä¸ºézsl streamsæŸ¥æ‰¾ä»–ä»¬çš„format</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newStream-&gt;priv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¸ºæ–°çš„streamæ„é€ Channel</span></span><br><span class="line">            <span class="keyword">switch</span> (newStream-&gt;stream_type) &#123;<span class="comment">//åˆ†ç±»å‹æ„é€ </span></span><br><span class="line">            <span class="keyword">case</span> CAMERA3_STREAM_INPUT:</span><br><span class="line">                newStream-&gt;usage |= GRALLOC_USAGE_HW_CAMERA_READ;</span><br><span class="line">                newStream-&gt;usage |= GRALLOC_USAGE_HW_CAMERA_WRITE;<span class="comment">//WR for inplace algo&#x27;s</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CAMERA3_STREAM_BIDIRECTIONAL:</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CAMERA3_STREAM_OUTPUT:</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ ¹æ®å‰é¢çš„å¾—åˆ°çš„streamçš„å‚æ•°ç±»å‹ä»¥åŠformatåˆ†åˆ«å¯¹å„ç±»å‹çš„channelè¿›è¡Œæ„é€ </span></span><br><span class="line">            <span class="keyword">if</span> (newStream-&gt;stream_type == CAMERA3_STREAM_OUTPUT ||</span><br><span class="line">                    newStream-&gt;stream_type == CAMERA3_STREAM_BIDIRECTIONAL) &#123;</span><br><span class="line">                QCamera3Channel *channel = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">switch</span> (newStream-&gt;format) &#123;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED:</span><br><span class="line">                    <span class="comment">/* use higher number of buffers for HFR mode */</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//åˆ›å»ºRegular Channel</span></span><br><span class="line">                    channel = <span class="keyword">new</span> QCamera3RegularChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">                        mCameraHandle-&gt;ops, captureResultCb,&amp;gCamCapability[mCameraId]-</span><br><span class="line">                        &gt;padding_info,<span class="keyword">this</span>,newStream,(<span class="keyword">cam_stream_type_t</span>)mStreamConfigInfo.type[</span><br><span class="line">                        mStreamConfigInfo.num_streams],mStreamConfigInfo.postprocess_mask[</span><br><span class="line">                        mStreamConfigInfo.num_streams],mMetadataChannel,numBuffers);</span><br><span class="line">                    ...</span><br><span class="line">                    newStream-&gt;max_buffers = channel-&gt;getNumBuffers();</span><br><span class="line">                    newStream-&gt;priv = channel;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_YCbCr_420_888:</span><br><span class="line">                    <span class="comment">//åˆ›å»ºYWV Channel</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_RAW_OPAQUE:</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_RAW16:</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_RAW10:</span><br><span class="line">                    <span class="comment">//åˆ›å»ºRaw Channel</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HAL_PIXEL_FORMAT_BLOB:</span><br><span class="line">                    <span class="comment">//åˆ›å»ºQCamera3PicChannel</span></span><br><span class="line">                    ...</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStream-&gt;stream_type == CAMERA3_STREAM_INPUT) &#123;</span><br><span class="line">                newStream-&gt;max_buffers = MAX_INFLIGHT_REPROCESS_REQUESTS;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (List&lt;<span class="keyword">stream_info_t</span>*&gt;::iterator it=mStreamInfo.begin();it != mStreamInfo.end(); </span><br><span class="line">                    it++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((*it)-&gt;stream == newStream) &#123;</span><br><span class="line">                    (*it)-&gt;channel = (QCamera3Channel*) newStream-&gt;priv;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newStream-&gt;stream_type != CAMERA3_STREAM_INPUT)</span><br><span class="line">            mStreamConfigInfo.num_streams++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isZsl) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPictureChannel) &#123;</span><br><span class="line">           mPictureChannel-&gt;overrideYuvSize(zslStream-&gt;width, zslStream-&gt;height);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPictureChannel &amp;&amp; m_bIs4KVideo) &#123;</span><br><span class="line">        mPictureChannel-&gt;overrideYuvSize(videoWidth, videoHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RAW DUMP channel</span></span><br><span class="line">    <span class="keyword">if</span> (mEnableRawDump &amp;&amp; isRawStreamRequested == <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="keyword">cam_dimension_t</span> rawDumpSize;</span><br><span class="line">        rawDumpSize = getMaxRawSize(mCameraId);</span><br><span class="line">        mRawDumpChannel = <span class="keyword">new</span> QCamera3RawDumpChannel(mCameraHandle-&gt;camera_handle,</span><br><span class="line">            mCameraHandle-&gt;ops,rawDumpSize,&amp;gCamCapability[mCameraId]-&gt;padding_info,</span><br><span class="line">            <span class="keyword">this</span>, CAM_QCOM_FEATURE_NONE);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³Channelçš„é…ç½®</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* Initialize mPendingRequestInfo and mPendnigBuffersMap */</span></span><br><span class="line">    <span class="keyword">for</span> (List&lt;PendingRequestInfo&gt;::iterator i = mPendingRequestsList.begin();</span><br><span class="line">                i != mPendingRequestsList.end(); i++) &#123;</span><br><span class="line">        clearInputBuffer(i-&gt;input_buffer);</span><br><span class="line">        i = mPendingRequestsList.erase(i);</span><br><span class="line">    &#125;</span><br><span class="line">    mPendingFrameDropList.clear();</span><br><span class="line">    <span class="comment">// Initialize/Reset the pending buffers list</span></span><br><span class="line">    mPendingBuffersMap.num_buffers = <span class="number">0</span>;</span><br><span class="line">    mPendingBuffersMap.mPendingBufferList.clear();</span><br><span class="line">    mPendingReprocessResultList.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ³•å†…å®¹æ¯”è¾ƒå¤šï¼ŒåªæŠ½å–å…¶ä¸­æ ¸å¿ƒçš„ä»£ç è¿›è¡Œè¯´æ˜ï¼Œå®ƒé¦–å…ˆä¼šæ ¹æ®HALçš„ç‰ˆæœ¬æ¥å¯¹streamè¿›è¡Œç›¸åº”çš„é…ç½®åˆå§‹åŒ–ï¼Œç„¶åå†æ ¹æ®streamç±»å‹å¯¹stream_listçš„streamåˆ›å»ºç›¸åº”çš„Channelï¼Œä¸»è¦æœ‰QCamera3MetadataChannelï¼ŒQCamera3SupportChannelç­‰ï¼Œç„¶åå†è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œå…¶ä¸­QCamera3MetadataChannelåœ¨åé¢çš„å¤„ç†capture requestçš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œè¿™é‡Œå°±ä¸åšåˆ†æï¼Œè€ŒCamerametadataåˆ™æ˜¯Javaå±‚å’ŒCameraServiceä¹‹é—´ä¼ é€’çš„å…ƒæ•°æ®ï¼Œè§android6.0æºç åˆ†æä¹‹Camera API2.0ç®€ä»‹ä¸­çš„Camera2æ¶æ„å›¾ï¼Œè‡³æ­¤ï¼ŒQCamera3HardwareInterfaceæ„é€ ç»“æŸï¼Œä¸æœ¬æ–‡ç›¸å…³çš„å°±æ˜¯é…ç½®äº†mCameraDevice.opsã€‚</p>
<h5 id="3-1-2ã€openCamera-åˆ†æ"><a href="#3-1-2ã€openCamera-åˆ†æ" class="headerlink" title="3.1.2ã€openCamera()åˆ†æ"></a>3.1.2ã€openCamera()åˆ†æ</h5><p>æœ¬èŠ‚ä¸»è¦åˆ†æModuleæ˜¯å¦‚ä½•æ‰“å¼€Cameraçš„ï¼ŒopenCameraçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">QCamera3HardwareInterface::openCamera</span><span class="params">(struct <span class="keyword">hw_device_t</span> **hw_device)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mCameraOpened) &#123;<span class="comment">//å¦‚æœCameraå·²ç»è¢«æ‰“å¼€ï¼Œåˆ™æ­¤æ¬¡æ‰“å¼€çš„è®¾å¤‡ä¸ºNULLï¼Œå¹¶ä¸”æ‰“å¼€ç»“æœä¸ºPERMISSION_DENIED</span></span><br><span class="line">        *hw_device = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è°ƒç”¨openCameraæ–¹æ³•æ¥æ‰“å¼€</span></span><br><span class="line">    rc = openCamera();</span><br><span class="line">    <span class="comment">//æ‰“å¼€ç»“æœå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//è·å–æ‰“å¼€æˆåŠŸçš„hw_device_tå¯¹è±¡</span></span><br><span class="line">        *hw_device = &amp;mCameraDevice.common;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        *hw_device = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒè°ƒç”¨äº†openCamera()æ–¹æ³•æ¥æ‰“å¼€Camera:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">QCamera3HardwareInterface::openCamera</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰“å¼€cameraï¼Œè·å–mCameraHandle</span></span><br><span class="line">    mCameraHandle = camera_open((<span class="keyword">uint8_t</span>)mCameraId);</span><br><span class="line">    ...</span><br><span class="line">    mCameraOpened = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//æ³¨å†Œmm-camera-interfaceé‡Œçš„äº‹ä»¶å¤„ç†,å…¶ä¸­camEctHandleä¸ºäº‹ä»¶å¤„ç†Handle</span></span><br><span class="line">    rc = mCameraHandle-&gt;ops-&gt;register_event_notify(mCameraHandle-&gt;camera_handle,camEvtHandle</span><br><span class="line">            ,(<span class="keyword">void</span> *)<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒè°ƒç”¨camera_openæ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œå¹¶ä¸”å‘CameraHandleæ³¨å†Œäº†Camera æ—¶é—´å¤„ç†çš„Handleâ€“camEvtHandleï¼Œé¦–å…ˆåˆ†æcamera_openæ–¹æ³•ï¼Œè¿™é‡Œå°±å°†è¿›å…¥é«˜é€šçš„Cameraçš„å®ç°äº†ï¼Œè€ŒMm_camera_interface.cæ˜¯é«˜é€šæä¾›çš„ç›¸å…³æ“ä½œçš„æ¥å£ï¼Œæ¥ä¸‹æ¥åˆ†æé«˜é€šCameraçš„camera_openæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\vendor\qcom\proprietary\mm-camera\apps\appslib\mm_camera_interface.c]</span><br><span class="line"><span class="function"><span class="keyword">mm_camera_vtbl_t</span> * <span class="title">camera_open</span><span class="params">(<span class="keyword">uint8_t</span> camera_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> rc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">mm_camera_obj_t</span>* cam_obj = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* opened already å¦‚æœå·²ç»æ‰“å¼€*/</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != g_cam_ctrl.cam_obj[camera_idx]) &#123;</span><br><span class="line">        <span class="comment">/* Add reference */</span></span><br><span class="line">        g_cam_ctrl.cam_obj[camera_idx]-&gt;ref_count++;</span><br><span class="line">        pthread_mutex_unlock(&amp;g_intf_lock);</span><br><span class="line">        <span class="keyword">return</span> &amp;g_cam_ctrl.cam_obj[camera_idx]-&gt;vtbl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cam_obj = (<span class="keyword">mm_camera_obj_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">mm_camera_obj_t</span>));</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* initialize camera obj */</span></span><br><span class="line">    <span class="built_in">memset</span>(cam_obj, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">mm_camera_obj_t</span>));</span><br><span class="line">    cam_obj-&gt;ctrl_fd = <span class="number">-1</span>;</span><br><span class="line">    cam_obj-&gt;ds_fd = <span class="number">-1</span>;</span><br><span class="line">    cam_obj-&gt;ref_count++;</span><br><span class="line">    cam_obj-&gt;my_hdl = mm_camera_util_generate_handler(camera_idx);</span><br><span class="line">    cam_obj-&gt;vtbl.camera_handle = cam_obj-&gt;my_hdl; <span class="comment">/* set handler */</span></span><br><span class="line">    <span class="comment">//mm_camera_opsé‡Œç»‘å®šäº†ç›¸å…³çš„æ“ä½œæ¥å£</span></span><br><span class="line">    cam_obj-&gt;vtbl.ops = &amp;mm_camera_ops;</span><br><span class="line">    pthread_mutex_init(&amp;cam_obj-&gt;cam_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_lock(&amp;cam_obj-&gt;cam_lock);</span><br><span class="line">    pthread_mutex_unlock(&amp;g_intf_lock);</span><br><span class="line">    <span class="comment">//è°ƒç”¨mm_camera_openæ–¹æ³•æ¥æ‰“å¼€camera</span></span><br><span class="line">    rc = mm_camera_open(cam_obj);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;g_intf_lock);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//ç»“æœå¤„ç†ï¼Œå¹¶è¿”å›</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ–ä¸€ä¸ªmm_camera_obj_tå¯¹è±¡ï¼Œå…¶ä¸­ï¼Œds_fdä¸ºsocket fdï¼Œè€Œmm_camera_opsåˆ™ç»‘å®šäº†ç›¸å…³çš„æ¥å£ï¼Œæœ€åè°ƒç”¨mm_camera_openæ¥æ‰“å¼€Cameraï¼Œé¦–å…ˆæ¥çœ‹çœ‹mm_camera_opsç»‘å®šäº†å“ªäº›æ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\vendor\qcom\proprietary\mm-camera\apps\appslib\mm_camera_interface.c]</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mm_camera_ops_t</span> mm_camera_ops = &#123;</span><br><span class="line">    .query_capability = mm_camera_intf_query_capability,</span><br><span class="line">    <span class="comment">//æ³¨å†Œäº‹ä»¶é€šçŸ¥çš„æ–¹æ³•</span></span><br><span class="line">    .register_event_notify = mm_camera_intf_register_event_notify,</span><br><span class="line">    .close_camera = mm_camera_intf_close,</span><br><span class="line">    .set_parms = mm_camera_intf_set_parms,</span><br><span class="line">    .get_parms = mm_camera_intf_get_parms,</span><br><span class="line">    .do_auto_focus = mm_camera_intf_do_auto_focus,</span><br><span class="line">    .cancel_auto_focus = mm_camera_intf_cancel_auto_focus,</span><br><span class="line">    .prepare_snapshot = mm_camera_intf_prepare_snapshot,</span><br><span class="line">    .start_zsl_snapshot = mm_camera_intf_start_zsl_snapshot,</span><br><span class="line">    .stop_zsl_snapshot = mm_camera_intf_stop_zsl_snapshot,</span><br><span class="line">    .map_buf = mm_camera_intf_map_buf,</span><br><span class="line">    .unmap_buf = mm_camera_intf_unmap_buf,</span><br><span class="line">    .add_channel = mm_camera_intf_add_channel,</span><br><span class="line">    .delete_channel = mm_camera_intf_del_channel,</span><br><span class="line">    .get_bundle_info = mm_camera_intf_get_bundle_info,</span><br><span class="line">    .add_stream = mm_camera_intf_add_stream,</span><br><span class="line">    .link_stream = mm_camera_intf_link_stream,</span><br><span class="line">    .delete_stream = mm_camera_intf_del_stream,</span><br><span class="line">    <span class="comment">//é…ç½®streamçš„æ–¹æ³•</span></span><br><span class="line">    .config_stream = mm_camera_intf_config_stream,</span><br><span class="line">    .qbuf = mm_camera_intf_qbuf,</span><br><span class="line">    .get_queued_buf_count = mm_camera_intf_get_queued_buf_count,</span><br><span class="line">    .map_stream_buf = mm_camera_intf_map_stream_buf,</span><br><span class="line">    .unmap_stream_buf = mm_camera_intf_unmap_stream_buf,</span><br><span class="line">    .set_stream_parms = mm_camera_intf_set_stream_parms,</span><br><span class="line">    .get_stream_parms = mm_camera_intf_get_stream_parms,</span><br><span class="line">    .start_channel = mm_camera_intf_start_channel,</span><br><span class="line">    .stop_channel = mm_camera_intf_stop_channel,</span><br><span class="line">    .request_super_buf = mm_camera_intf_request_super_buf,</span><br><span class="line">    .cancel_super_buf_request = mm_camera_intf_cancel_super_buf_request,</span><br><span class="line">    .flush_super_buf_queue = mm_camera_intf_flush_super_buf_queue,</span><br><span class="line">    .configure_notify_mode = mm_camera_intf_configure_notify_mode,</span><br><span class="line">    <span class="comment">//å¤„ç†captureçš„æ–¹æ³•</span></span><br><span class="line">    .process_advanced_capture = mm_camera_intf_process_advanced_capture</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åˆ†æmm_camera_openæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/camera/QCamera2/<span class="built_in">stack</span>/mm-camera-interface/src/mm_camera.c]</span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">mm_camera_open</span><span class="params">(<span class="keyword">mm_camera_obj_t</span> *my_obj)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        n_try--;</span><br><span class="line">        <span class="comment">//æ ¹æ®è®¾å¤‡åå­—ï¼Œæ‰“å¼€ç›¸åº”çš„è®¾å¤‡é©±åŠ¨fd</span></span><br><span class="line">        my_obj-&gt;ctrl_fd = open(dev_name, O_RDWR | O_NONBLOCK);</span><br><span class="line">        <span class="keyword">if</span>((my_obj-&gt;ctrl_fd &gt;= <span class="number">0</span>) || (errno != EIO) || (n_try &lt;= <span class="number">0</span> )) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        usleep(sleep_msec * <span class="number">1000U</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span> (n_try &gt; <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰“å¼€domain socket</span></span><br><span class="line">    n_try = MM_CAMERA_DEV_OPEN_TRIES;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        n_try--;</span><br><span class="line">        my_obj-&gt;ds_fd = mm_camera_socket_create(cam_idx, MM_CAMERA_SOCK_TYPE_UDP);</span><br><span class="line">        usleep(sleep_msec * <span class="number">1000U</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (n_try &gt; <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–é”</span></span><br><span class="line">    pthread_mutex_init(&amp;my_obj-&gt;msg_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;my_obj-&gt;cb_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;my_obj-&gt;evt_lock, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;my_obj-&gt;evt_cond, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€å¯çº¿ç¨‹ï¼Œå®ƒçš„çº¿ç¨‹ä½“åœ¨mm_camera_dispatch_app_eventæ–¹æ³•ä¸­</span></span><br><span class="line">    mm_camera_cmd_thread_launch(&amp;my_obj-&gt;evt_thread,</span><br><span class="line">                                mm_camera_dispatch_app_event,</span><br><span class="line">                                (<span class="keyword">void</span> *)my_obj);</span><br><span class="line">    mm_camera_poll_thread_launch(&amp;my_obj-&gt;evt_poll_thread,</span><br><span class="line">                                 MM_CAMERA_POLL_TYPE_EVT);</span><br><span class="line">    mm_camera_evt_sub(my_obj, TRUE);</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒä¼šæ‰“å¼€Cameraçš„è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åå¼€å¯dispatch_app_eventçº¿ç¨‹ï¼Œçº¿ç¨‹æ–¹æ³•ä½“mm_camera_dispatch_app_eventæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/hardware/qcom/camera/QCamera2/<span class="built_in">stack</span>/mm-camera-interface/src/mm_camera.c]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mm_camera_dispatch_app_event</span><span class="params">(<span class="keyword">mm_camera_cmdcb_t</span> *cmd_cb,<span class="keyword">void</span>* user_data)</span></span>&#123;</span><br><span class="line">    mm_camera_cmd_thread_name(<span class="string">&quot;mm_cam_event&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">mm_camera_event_t</span> *event = &amp;cmd_cb-&gt;u.evt;</span><br><span class="line">    <span class="keyword">mm_camera_obj_t</span> * my_obj = (<span class="keyword">mm_camera_obj_t</span> *)user_data;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != my_obj) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;my_obj-&gt;cb_lock);</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MM_CAMERA_EVT_ENTRY_MAX; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(my_obj-&gt;evt.evt[i].evt_cb) &#123;</span><br><span class="line">                <span class="comment">//è°ƒç”¨camEvtHandleæ–¹æ³•</span></span><br><span class="line">                my_obj-&gt;evt.evt[i].evt_cb(</span><br><span class="line">                    my_obj-&gt;my_hdl,</span><br><span class="line">                    event,</span><br><span class="line">                    my_obj-&gt;evt.evt[i].user_data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_mutex_unlock(&amp;my_obj-&gt;cb_lock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åä¼šè°ƒç”¨mm-camera-interfaceä¸­æ³¨å†Œå¥½çš„äº‹ä»¶å¤„ç†evt_cbï¼Œå®ƒå°±æ˜¯åœ¨å‰é¢æ³¨å†Œå¥½çš„camEvtHandleï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QCamera3HardwareInterface::camEvtHandle</span><span class="params">(<span class="keyword">uint32_t</span> <span class="comment">/*camera_handle*/</span>,<span class="keyword">mm_camera_event_t</span> *evt,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">void</span> *user_data)</span></span>&#123;</span><br><span class="line">    <span class="comment">//è·å–QCamera3HardwareInterfaceæ¥å£æŒ‡é’ˆ</span></span><br><span class="line">    QCamera3HardwareInterface *obj = (QCamera3HardwareInterface *)user_data;</span><br><span class="line">    <span class="keyword">if</span> (obj &amp;&amp; evt) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(evt-&gt;server_event_type) &#123;</span><br><span class="line">            <span class="keyword">case</span> CAM_EVENT_TYPE_DAEMON_DIED:</span><br><span class="line">                <span class="keyword">camera3_notify_msg_t</span> notify_msg;</span><br><span class="line">                <span class="built_in">memset</span>(&amp;notify_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">camera3_notify_msg_t</span>));</span><br><span class="line">                notify_msg.type = CAMERA3_MSG_ERROR;</span><br><span class="line">                notify_msg.message.error.error_code = CAMERA3_MSG_ERROR_DEVICE;</span><br><span class="line">                notify_msg.message.error.error_stream = <span class="literal">NULL</span>;</span><br><span class="line">                notify_msg.message.error.frame_number = <span class="number">0</span>;</span><br><span class="line">                obj-&gt;mCallbackOps-&gt;notify(obj-&gt;mCallbackOps, &amp;notify_msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CAM_EVENT_TYPE_DAEMON_PULL_REQ:</span><br><span class="line">                pthread_mutex_lock(&amp;obj-&gt;mMutex);</span><br><span class="line">                obj-&gt;mWokenUpByDaemon = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//å¼€å¯process_capture_request</span></span><br><span class="line">                obj-&gt;unblockRequestIfNecessary();</span><br><span class="line">                pthread_mutex_unlock(&amp;obj-&gt;mMutex);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒä¼šè°ƒç”¨QCamera3HardwareInterfaceçš„unblockRequestIfNecessaryæ¥å‘èµ·ç»“æœå¤„ç†è¯·æ±‚ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\hardware\qcom\camera\QCamera2\HAL3\QCamera3HWI.cpp]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">QCamera3HardwareInterface::unblockRequestIfNecessary</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// Unblock process_capture_request</span></span><br><span class="line">   <span class="comment">//å¼€å¯process_capture_request</span></span><br><span class="line">   pthread_cond_signal(&amp;mRequestCond);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨åˆå§‹åŒ–QCamera3HardwareInterfaceå¯¹è±¡çš„æ—¶å€™ï¼Œå°±ç»‘å®šäº†å¤„ç†Metadataçš„å›è°ƒcaptureResultCbæ–¹æ³•ï¼šå®ƒä¸»è¦æ˜¯å¯¹æ•°æ®æºè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œè€Œå…·ä½“çš„captureè¯·æ±‚çš„ç»“æœå¤„ç†è¿˜æ˜¯ç”±process_capture_requestæ¥è¿›è¡Œå¤„ç†çš„ï¼Œè€Œè¿™é‡Œä¼šè°ƒç”¨æ–¹æ³•unblockRequestIfNecessaryæ¥è§¦å‘process_capture_requestæ–¹æ³•æ‰§è¡Œï¼Œè€Œåœ¨Cameraæ¡†æ¶ä¸­ï¼Œå‘èµ·è¯·æ±‚æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªRequestThreadçº¿ç¨‹ï¼Œåœ¨å®ƒçš„threadLoopæ–¹æ³•ä¸­ï¼Œä¼šä¸åœçš„è°ƒç”¨process_capture_requestæ–¹æ³•æ¥è¿›è¡Œè¯·æ±‚çš„å¤„ç†ï¼Œè€Œå®ƒæœ€åä¼šå›è°ƒCamera3Deviceä¸­çš„processCaptureResultæ–¹æ³•æ¥è¿›è¡Œç»“æœå¤„ç†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Camera3Device::processCaptureResult</span><span class="params">(<span class="keyword">const</span> camera3_capture_result *result)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (mUsePartialResult &amp;&amp; result-&gt;result != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDeviceVersion &gt;= CAMERA_DEVICE_API_VERSION_3_2) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (isPartialResult) &#123;</span><br><span class="line">                    request.partialResult.collectedResult.append(result-&gt;result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">camera_metadata_ro_entry_t</span> partialResultEntry;</span><br><span class="line">                res = find_camera_metadata_ro_entry(result-&gt;result,</span><br><span class="line">                        ANDROID_QUIRKS_PARTIAL_RESULT, &amp;partialResultEntry);</span><br><span class="line">                <span class="keyword">if</span> (res != NAME_NOT_FOUND &amp;&amp;partialResultEntry.count &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        partialResultEntry.data.u8[<span class="number">0</span>] ==ANDROID_QUIRKS_PARTIAL_RESULT_PARTIAL) &#123;</span><br><span class="line">                    isPartialResult = <span class="literal">true</span>;</span><br><span class="line">                    request.partialResult.collectedResult.append(</span><br><span class="line">                        result-&gt;result);</span><br><span class="line">                    request.partialResult.collectedResult.erase(</span><br><span class="line">                        ANDROID_QUIRKS_PARTIAL_RESULT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isPartialResult) &#123;</span><br><span class="line">                <span class="comment">// Fire off a 3A-only result if possible</span></span><br><span class="line">                <span class="keyword">if</span> (!request.partialResult.haveSent3A) &#123;</span><br><span class="line">                    <span class="comment">//å¤„ç†3Aç»“æœ</span></span><br><span class="line">                    request.partialResult.haveSent3A =processPartial3AResult(frameNumber,</span><br><span class="line">                        request.partialResult.collectedResult,request.resultExtras);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾cameraå…ƒæ•°æ®å…¥å£</span></span><br><span class="line">        <span class="keyword">camera_metadata_ro_entry_t</span> entry;</span><br><span class="line">        res = find_camera_metadata_ro_entry(result-&gt;result,</span><br><span class="line">                ANDROID_SENSOR_TIMESTAMP, &amp;entry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shutterTimestamp == <span class="number">0</span>) &#123;</span><br><span class="line">            request.pendingOutputBuffers.appendArray(result-&gt;output_buffers,</span><br><span class="line">                result-&gt;num_output_buffers);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            é‡è¦çš„åˆ†æ<span class="comment">//è¿”å›å¤„ç†çš„outputbuffer</span></span><br><span class="line">            returnOutputBuffers(result-&gt;output_buffers,</span><br><span class="line">                result-&gt;num_output_buffers, shutterTimestamp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result-&gt;result != <span class="literal">NULL</span> &amp;&amp; !isPartialResult) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shutterTimestamp == <span class="number">0</span>) &#123;</span><br><span class="line">                request.pendingMetadata = result-&gt;result;</span><br><span class="line">                request.partialResult.collectedResult = collectedPartialResult;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                CameraMetadata metadata;</span><br><span class="line">                metadata = result-&gt;result;</span><br><span class="line">                <span class="comment">//å‘é€Captureç»“æ„ï¼Œå³è°ƒç”¨é€šçŸ¥å›è°ƒ</span></span><br><span class="line">                sendCaptureResult(metadata, request.resultExtras,</span><br><span class="line">                    collectedPartialResult, frameNumber, hasInputBufferInRequest,</span><br><span class="line">                    request.aeTriggerCancelOverride);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeInFlightRequestIfReadyLocked(idx);</span><br><span class="line">    &#125; <span class="comment">// scope for mInFlightLock</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result-&gt;input_buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasInputBufferInRequest) &#123;</span><br><span class="line">            Camera3Stream *stream =</span><br><span class="line">                Camera3Stream::cast(result-&gt;input_buffer-&gt;stream);</span><br><span class="line">            é‡è¦çš„åˆ†æ<span class="comment">//è¿”å›å¤„ç†çš„inputbuffer</span></span><br><span class="line">            res = stream-&gt;returnInputBuffer(*(result-&gt;input_buffer));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æreturnOutputBuffersæ–¹æ³•ï¼Œinputbufferçš„runturnInputBufferæ–¹æ³•æµç¨‹ç±»ä¼¼ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Camera3Device::returnOutputBuffers</span><span class="params">(<span class="keyword">const</span> <span class="keyword">camera3_stream_buffer_t</span> *outputBuffers, <span class="keyword">size_t</span> </span></span></span><br><span class="line"><span class="function"><span class="params">        numBuffers, <span class="keyword">nsecs_t</span> timestamp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numBuffers; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Camera3Stream *stream = Camera3Stream::cast(outputBuffers[i].stream);</span><br><span class="line">        <span class="keyword">status_t</span> res = stream-&gt;returnBuffer(outputBuffers[i], timestamp);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•é‡Œè°ƒç”¨äº†returnBufferæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3Stream.cpp]</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3Stream::returnBuffer</span><span class="params">(<span class="keyword">const</span> camera3_stream_buffer &amp;buffer,<span class="keyword">nsecs_t</span> timestamp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è¿”å›buffer</span></span><br><span class="line">    <span class="keyword">status_t</span> res = returnBufferLocked(buffer, timestamp);</span><br><span class="line">    <span class="keyword">if</span> (res == OK) &#123;</span><br><span class="line">        fireBufferListenersLocked(buffer, <span class="comment">/*acquired*/</span><span class="literal">false</span>, <span class="comment">/*output*/</span><span class="literal">true</span>);</span><br><span class="line">        mOutputBufferReturnedSignal.signal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†ç»§ç»­çœ‹returnBufferLocked,å®ƒè°ƒç”¨äº†returnAnyBufferLockedæ–¹æ³•ï¼Œè€ŒreturnAnyBufferLockedæ–¹æ³•åˆè°ƒç”¨äº†returnBufferCheckedLockedæ–¹æ³•ï¼Œç°åœ¨åˆ†æreturnBufferCheckedLockedï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/frameworks/av/services/camera/libcameraservice/device3/Camera3OutputStream.cpp]</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3OutputStream::returnBufferCheckedLocked</span><span class="params">(<span class="keyword">const</span> camera3_stream_buffer &amp;buffer,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">nsecs_t</span> timestamp,<span class="keyword">bool</span> output,<span class="comment">/*out*/</span>sp&lt;Fence&gt; *releaseFenceOut)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Fence management - always honor release fence from HAL</span></span><br><span class="line">    sp&lt;Fence&gt; releaseFence = <span class="keyword">new</span> Fence(buffer.release_fence);</span><br><span class="line">    <span class="keyword">int</span> anwReleaseFence = releaseFence-&gt;dup();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer.status == CAMERA3_BUFFER_STATUS_ERROR) &#123;</span><br><span class="line">        <span class="comment">// Cancel buffer</span></span><br><span class="line">        res = currentConsumer-&gt;cancelBuffer(currentConsumer.get(),</span><br><span class="line">                container_of(buffer.buffer, ANativeWindowBuffer, handle),</span><br><span class="line">                anwReleaseFence);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        res = currentConsumer-&gt;queueBuffer(currentConsumer.get(),</span><br><span class="line">                container_of(buffer.buffer, ANativeWindowBuffer, handle),</span><br><span class="line">                anwReleaseFence);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±ä»£ç å¯çŸ¥ï¼Œå¦‚æœBufferæ²¡æœ‰å‡ºç°çŠ¶æ€é”™è¯¯ï¼Œå®ƒä¼šè°ƒç”¨currentConsumerçš„queueBufferæ–¹æ³•ï¼Œè€Œå…·ä½“çš„Consumeråˆ™æ˜¯åœ¨åº”ç”¨å±‚åˆå§‹åŒ–Cameraæ—¶è¿›è¡Œç»‘å®šçš„ï¼Œå…¸å‹çš„Consumeræœ‰SurfaceTextureï¼ŒImageReaderç­‰ï¼Œè€Œåœ¨Nativeå±‚ä¸­ï¼Œå®ƒä¼šè°ƒç”¨BufferQueueProducerçš„queueBufferæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\native\libs\gui\BufferQueueProducer.cpp]</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BufferQueueProducer::queueBuffer</span><span class="params">(<span class="keyword">int</span> slot,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> QueueBufferInput &amp;input, QueueBufferOutput *output)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–Frameå¯ç”¨çš„ç›‘å¬å™¨</span></span><br><span class="line">    sp&lt;IConsumerListener&gt; frameAvailableListener;</span><br><span class="line">    sp&lt;IConsumerListener&gt; frameReplacedListener;</span><br><span class="line">    <span class="keyword">int</span> callbackTicket = <span class="number">0</span>;</span><br><span class="line">    BufferItem item;</span><br><span class="line">    &#123; <span class="comment">// Autolock scope</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="function"><span class="keyword">const</span> sp&lt;GraphicBuffer&gt;&amp; <span class="title">graphicBuffer</span><span class="params">(mSlots[slot].mGraphicBuffer)</span></span>;</span><br><span class="line">        <span class="function">Rect <span class="title">bufferRect</span><span class="params">(graphicBuffer-&gt;getWidth(), graphicBuffer-&gt;getHeight())</span></span>;</span><br><span class="line">        Rect croppedRect;</span><br><span class="line">        crop.intersect(bufferRect, &amp;croppedRect);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//å¦‚æœé˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (mCore-&gt;mQueue.empty()) &#123;</span><br><span class="line">            mCore-&gt;mQueue.push_back(item);</span><br><span class="line">            frameAvailableListener = mCore-&gt;mConsumerListener;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™ï¼Œä¸ä¸ºç©ºï¼Œå¯¹Bufferè¿›è¡Œå¤„ç†ï¼Œå¹¶è·å–FrameAvailableListenerç›‘å¬</span></span><br><span class="line">            BufferQueueCore::Fifo::iterator front(mCore-&gt;mQueue.begin());</span><br><span class="line">            <span class="keyword">if</span> (front-&gt;mIsDroppable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCore-&gt;stillTracking(front)) &#123;</span><br><span class="line">                    mSlots[front-&gt;mSlot].mBufferState = BufferSlot::FREE;</span><br><span class="line">                    mCore-&gt;mFreeBuffers.push_front(front-&gt;mSlot);</span><br><span class="line">                &#125;</span><br><span class="line">                *front = item;</span><br><span class="line">                frameReplacedListener = mCore-&gt;mConsumerListener;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mCore-&gt;mQueue.push_back(item);</span><br><span class="line">                frameAvailableListener = mCore-&gt;mConsumerListener;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCore-&gt;mBufferHasBeenQueued = <span class="literal">true</span>;</span><br><span class="line">        mCore-&gt;mDequeueCondition.broadcast();</span><br><span class="line"></span><br><span class="line">        output-&gt;inflate(mCore-&gt;mDefaultWidth, mCore-&gt;mDefaultHeight,mCore-&gt;mTransformHint,</span><br><span class="line">                <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(mCore-&gt;mQueue.size()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Take a ticket for the callback functions</span></span><br><span class="line">        callbackTicket = mNextCallbackTicket++;</span><br><span class="line"></span><br><span class="line">        mCore-&gt;validateConsistencyLocked();</span><br><span class="line">    &#125; <span class="comment">// Autolock scope</span></span><br><span class="line">    ...</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (frameAvailableListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//å›è°ƒSurfaceTextureä¸­å®šä¹‰å¥½çš„ç›‘å¬IConsumerListenerçš„onFrameAvailableæ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œå¤„ç†</span></span><br><span class="line">            frameAvailableListener-&gt;onFrameAvailable(item);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frameReplacedListener != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            frameReplacedListener-&gt;onFrameReplaced(item);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ++mCurrentCallbackTicket;</span><br><span class="line">        mCallbackCondition.broadcast();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒæœ€åä¼šè°ƒç”¨Consumerçš„å›è°ƒFrameAvailableListenerçš„onFrameAvailableæ–¹æ³•ï¼Œåˆ°è¿™é‡Œï¼Œå°±æ¯”è¾ƒæ¸…æ™°ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å†™Cameraåº”ç”¨ï¼Œä¸ºå…¶åˆå§‹åŒ–Surfaceæ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™FrameAvailableListeneräº†ï¼Œå› ä¸ºåœ¨æ­¤æ–¹æ³•é‡Œé¢ï¼Œä¼šè¿›è¡Œç»“æœçš„å¤„ç†ï¼Œè‡³æ­¤ï¼ŒCamera HALçš„Openæµç¨‹å°±åˆ†æç»“æŸäº†ã€‚ä¸‹é¢ç»™å‡ºæµç¨‹çš„æ—¶åºå›¾ï¼š </p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-15-open_camera.png" alt="Alt text"></p>
<h4 id="ï¼ˆå››ï¼‰ã€Camera-API2-0-åˆå§‹åŒ–æµç¨‹åˆ†æ"><a href="#ï¼ˆå››ï¼‰ã€Camera-API2-0-åˆå§‹åŒ–æµç¨‹åˆ†æ" class="headerlink" title="ï¼ˆå››ï¼‰ã€Camera API2.0 åˆå§‹åŒ–æµç¨‹åˆ†æ"></a>ï¼ˆå››ï¼‰ã€Camera API2.0 åˆå§‹åŒ–æµç¨‹åˆ†æ</h4><h5 id="4-1ã€Camera2-åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open-è¿‡ç¨‹åˆ†æ"><a href="#4-1ã€Camera2-åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open-è¿‡ç¨‹åˆ†æ" class="headerlink" title="4.1ã€Camera2 åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open()è¿‡ç¨‹åˆ†æ"></a>4.1ã€Camera2 åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open()è¿‡ç¨‹åˆ†æ</h5><p>Camera2çš„åˆå§‹åŒ–æµç¨‹ä¸Camera1.0æœ‰æ‰€åŒºåˆ«ï¼Œæœ¬æ–‡å°†å°±Camera2çš„å†…ç½®åº”ç”¨æ¥åˆ†æCamera2.0çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚Camera2.0é¦–å…ˆå¯åŠ¨çš„æ˜¯CameraActivityï¼Œè€Œå®ƒç»§æ‰¿è‡ªQuickActivityï¼Œåœ¨ä»£ç ä¸­ä½ ä¼šå‘ç°æ²¡æœ‰é‡å†™OnCreateç­‰ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œå› ä¸ºæ­¤å¤„é‡‡ç”¨çš„æ˜¯æ¨¡æ¿æ–¹æ³•çš„è®¾è®¡æ¨¡å¼ï¼Œåœ¨QuickActivityä¸­çš„onCreateæ–¹æ³•è°ƒç”¨çš„æ˜¯onCreateTasksç­‰æ–¹æ³•ï¼Œæ‰€ä»¥è¦çœ‹onCreateæ–¹æ³•å°±åªé¡»çœ‹onCreateTasksæ–¹æ³•å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CameraActivity.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTasks</span><span class="params">(Bundle state)</span> </span>&#123;</span><br><span class="line">    Profile profile = mProfiler.create(<span class="string">&quot;CameraActivity.onCreateTasks&quot;</span>)</span><br><span class="line">                            .start();</span><br><span class="line">    ...</span><br><span class="line">    mOnCreateTime = System.currentTimeMillis();</span><br><span class="line">    mAppContext = getApplicationContext();</span><br><span class="line">    mMainHandler = <span class="keyword">new</span> MainHandler(<span class="keyword">this</span>, getMainLooper());</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–OneCameraOpenerå¯¹è±¡</span></span><br><span class="line">        â‘ mOneCameraOpener = OneCameraModule.provideOneCameraOpener(</span><br><span class="line">                mFeatureConfig, mAppContext,mActiveCameraDeviceTracker,</span><br><span class="line">                ResolutionUtil.getDisplayMetrics(<span class="keyword">this</span>));</span><br><span class="line">        mOneCameraManager = OneCameraModule.provideOneCameraManager();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OneCameraException e) &#123;...&#125;</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="comment">//å»ºç«‹æ¨¡å—ä¿¡æ¯</span></span><br><span class="line">    â‘¡ModulesInfo.setupModules(mAppContext, mModuleManager, mFeatureConfig);</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="comment">//è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    â‘¢mCurrentModule.init(<span class="keyword">this</span>, isSecureCamera(), isCaptureIntent());</span><br><span class="line">    â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç æ‰€ç¤ºï¼Œé‡è¦çš„æœ‰ä»¥ä¸Šä¸‰ç‚¹ï¼Œå…ˆçœ‹ç¬¬ä¸€ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/OneCameraModule.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OneCameraOpener <span class="title">provideOneCameraOpener</span><span class="params">(OneCameraFeatureConfig     </span></span></span><br><span class="line"><span class="function"><span class="params">            featureConfig, Context context, ActiveCameraDeviceTracker </span></span></span><br><span class="line"><span class="function"><span class="params">            activeCameraDeviceTracker,DisplayMetrics displayMetrics)</span> </span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> OneCameraException </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºOneCameraOpenerå¯¹è±¡</span></span><br><span class="line">    Optional&lt;OneCameraOpener&gt; manager = Camera2OneCameraOpenerImpl.create(</span><br><span class="line">              featureConfig, context, activeCameraDeviceTracker, displayMetrics);</span><br><span class="line">    <span class="keyword">if</span> (!manager.isPresent()) &#123;</span><br><span class="line">        manager = LegacyOneCameraOpenerImpl.create();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> manager.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒè°ƒç”¨Camera2OneCameraOpenerImplçš„createæ–¹æ³•æ¥è·å¾—ä¸€ä¸ªOneCameraOpenerå¯¹è±¡ï¼Œä»¥ä¾›CameraActivityä¹‹åçš„æ“ä½œä½¿ç”¨ï¼Œç»§ç»­çœ‹createæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/OneCameraModule.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;OneCameraOpener&gt; <span class="title">create</span><span class="params">(OneCameraFeatureConfig </span></span></span><br><span class="line"><span class="function"><span class="params">            featureConfig, Context context, ActiveCameraDeviceTracker </span></span></span><br><span class="line"><span class="function"><span class="params">            activeCameraDeviceTracker, DisplayMetrics displayMetrics)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    CameraManager cameraManager;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cameraManager = AndroidServices.instance().provideCameraManager();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException ex) &#123;...&#125;</span><br><span class="line">    <span class="comment">//æ–°å»ºä¸€ä¸ªCamera2OneCameraOpenerImplå¯¹è±¡</span></span><br><span class="line">    OneCameraOpener oneCameraOpener = <span class="keyword">new</span> Camera2OneCameraOpenerImpl(</span><br><span class="line">                featureConfig, context, cameraManager,</span><br><span class="line">                activeCameraDeviceTracker, displayMetrics);</span><br><span class="line">    <span class="keyword">return</span> Optional.of(oneCameraOpener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œå®ƒé¦–å…ˆè·å–ä¸€ä¸ªcameraMangerå¯¹è±¡ï¼Œç„¶åæ ¹æ®è¿™ä¸ªcameraManagerå¯¹è±¡æ¥æ–°åˆ›å»ºäº†ä¸€ä¸ªCamera2OneCameraOpenerImplå¯¹è±¡ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†è·å–ä¸€ä¸ªOneCameraOpenerå¯¹è±¡ï¼Œå®ƒçš„å®ç°ä¸ºCamera2OneCameraOpenerImplç±»ã€‚<br>ç»§ç»­çœ‹ç¬¬äºŒæ­¥ï¼ŒModulesInfo.setupModules:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/<span class="keyword">module</span>/ModulesInfo.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupModules</span><span class="params">(Context context, ModuleManager moduleManager,</span></span></span><br><span class="line"><span class="function"><span class="params">            OneCameraFeatureConfig config)</span> </span>&#123;</span><br><span class="line">        Resources res = context.getResources();</span><br><span class="line">        <span class="keyword">int</span> photoModuleId = context.getResources().getInteger(</span><br><span class="line">            R.integer.camera_mode_photo);</span><br><span class="line">        <span class="comment">//æ³¨å†ŒPhotoæ¨¡å—</span></span><br><span class="line">        registerPhotoModule(moduleManager, photoModuleId, </span><br><span class="line">            SettingsScopeNamespaces.PHOTO,config.isUsingCaptureModule());</span><br><span class="line">        <span class="comment">//è®¡ç®—ä½ è¿˜Photoæ¨¡å—è®¾ç½®ä¸ºé»˜è®¤çš„æ¨¡å—</span></span><br><span class="line">        moduleManager.setDefaultModuleIndex(photoModuleId);</span><br><span class="line">        <span class="comment">//æ³¨å†ŒVideaæ¨¡å—</span></span><br><span class="line">        registerVideoModule(moduleManager, res.getInteger(</span><br><span class="line">            R.integer.camera_mode_video),SettingsScopeNamespaces.VIDEO);</span><br><span class="line">        <span class="keyword">if</span> (PhotoSphereHelper.hasLightCycleCapture(context)) &#123;<span class="comment">//å¼€å¯é—ªå…‰</span></span><br><span class="line">            <span class="comment">//æ³¨å†Œå¹¿è§’é•œå¤´</span></span><br><span class="line">            registerWideAngleModule(moduleManager, res.getInteger(</span><br><span class="line">                R.integer.camera_mode_panorama),SettingsScopeNamespaces</span><br><span class="line">                .PANORAMA);</span><br><span class="line">            <span class="comment">//æ³¨å†Œå…‰çƒæ¨¡å—</span></span><br><span class="line">            registerPhotoSphereModule(moduleManager,res.getInteger(</span><br><span class="line">                R.integer.camera_mode_photosphere),</span><br><span class="line">                SettingsScopeNamespaces.PANORAMA);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è‹¥éœ€é‡æ–°èšç„¦</span></span><br><span class="line">        <span class="keyword">if</span> (RefocusHelper.hasRefocusCapture(context)) &#123;</span><br><span class="line">            <span class="comment">//æ³¨å†Œé‡èšç„¦æ¨¡å—</span></span><br><span class="line">            registerRefocusModule(moduleManager, res.getInteger(</span><br><span class="line">                R.integer.camera_mode_refocus),</span><br><span class="line">                SettingsScopeNamespaces.REFOCUS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰è‰²åˆ†ç¦»æ¨¡å—</span></span><br><span class="line">        <span class="keyword">if</span> (GcamHelper.hasGcamAsSeparateModule(config)) &#123;</span><br><span class="line">            <span class="comment">//æ³¨å†Œè‰²åˆ†ç¦»æ¨¡å—</span></span><br><span class="line">            registerGcamModule(moduleManager, res.getInteger(</span><br><span class="line">                R.integer.camera_mode_gcam),SettingsScopeNamespaces.PHOTO,</span><br><span class="line">                config.getHdrPlusSupportLevel(OneCamera.Facing.BACK));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> imageCaptureIntentModuleId = res.getInteger(</span><br><span class="line">            R.integer.camera_mode_capture_intent);</span><br><span class="line">        registerCaptureIntentModule(moduleManager, </span><br><span class="line">            imageCaptureIntentModuleId,SettingsScopeNamespaces.PHOTO,</span><br><span class="line">            config.isUsingCaptureModule());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç æ ¹æ®é…ç½®ä¿¡æ¯ï¼Œè¿›è¡Œä¸€ç³»åˆ—æ¨¡å—çš„æ³¨å†Œï¼Œå…¶ä¸­PhotoModuleå’ŒVideoModuleè¢«æ³¨å†Œï¼Œè€Œå…¶ä»–çš„moduleåˆ™æ˜¯æ ¹æ®é…ç½®æ¥è¿›è¡Œçš„ï¼Œå› ä¸ºæ‰“å¼€Cameraåº”ç”¨ï¼Œæ—¢å¯ä»¥æ‹ç…§ç‰‡ä¹Ÿå¯ä»¥æ‹è§†é¢‘ï¼Œæ­¤å¤„ï¼Œåªåˆ†æPhoneModuleçš„æ³¨å†Œï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/<span class="keyword">module</span>/ModulesInfo.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerPhotoModule</span><span class="params">(ModuleManager moduleManager, <span class="keyword">final</span> </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> moduleId, <span class="keyword">final</span> String <span class="keyword">namespace</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> boolean enableCaptureModule)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å‘ModuleManageræ³¨å†ŒPhotoModuleæ¨¡å—</span></span><br><span class="line">        moduleManager.registerModule(<span class="keyword">new</span> ModuleManager.ModuleAgent() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">int</span> getModuleId() &#123;</span><br><span class="line">                <span class="keyword">return</span> moduleId;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> boolean requestAppForCamera() &#123;</span><br><span class="line">                <span class="keyword">return</span> !enableCaptureModule;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> String getScopeNamespace() &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">namespace</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> ModuleController createModule(AppController app, Intent </span><br><span class="line">                    intent) &#123;</span><br><span class="line">                Log.v(TAG, <span class="string">&quot;EnableCaptureModule = &quot;</span> + enableCaptureModule);</span><br><span class="line">                <span class="comment">//åˆ›å»ºModuleController</span></span><br><span class="line">                <span class="keyword">return</span> enableCaptureModule ? <span class="keyword">new</span> CaptureModule(app) </span><br><span class="line">                        : <span class="keyword">new</span> PhotoModule(app);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±ä»£ç å¯çŸ¥ï¼Œå®ƒæœ€ç»ˆæ˜¯ç”±ModuleManageræ¥æ–°å»ºä¸€ä¸ªCaptureModuleå®ä¾‹ï¼Œè€ŒCaptureModuleå…¶å®å®ç°äº†ModuleController ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªCaptureModuleæ¨¡å¼ä¸‹çš„ModuleControllerå¯¹è±¡ï¼Œè€ŒçœŸæ­£çš„CaptureModuleçš„å…·ä½“å®ç°ä¸ºModuleManagerImplã€‚<br>è‡³æ­¤ï¼Œå‰ä¸¤æ­¥å·²ç»è·å¾—äº†OneCameraOpenerä»¥åŠæ–°å»ºäº†ModuleControllerï¼Œå¹¶è¿›è¡Œäº†æ³¨å†Œï¼Œæ¥ä¸‹æ¥åˆ†æç¬¬ä¸‰æ­¥ï¼ŒmCurrentModule.init(this, isSecureCamera(), isCaptureIntent()):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(CameraActivity activity, <span class="keyword">boolean</span> isSecureCamera, <span class="keyword">boolean</span> </span></span></span><br><span class="line"><span class="function"><span class="params">            isCaptureIntent)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        HandlerThread thread = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;CaptureModule.mCameraHandler&quot;</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        mCameraHandler = <span class="keyword">new</span> Handler(thread.getLooper());</span><br><span class="line">        <span class="comment">//è·å–ç¬¬ä¸€æ­¥ä¸­åˆ›å»ºçš„OneCameraOpenerå¯¹è±¡</span></span><br><span class="line">        mOneCameraOpener = mAppController.getCameraOpener();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–å‰é¢åˆ›å»ºçš„OneCameraManagerå¯¹è±¡</span></span><br><span class="line">            mOneCameraManager = OneCameraModule.provideOneCameraManager();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (OneCameraException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Unable to provide a OneCameraManager. &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">       `...</span><br><span class="line">        <span class="comment">//æ–°å»ºCaptureModuleçš„UI</span></span><br><span class="line">        mUI = <span class="keyword">new</span> CaptureModuleUI(activity, mAppController.</span><br><span class="line">                getModuleLayoutRoot(), mUIListener);</span><br><span class="line">        <span class="comment">//è®¾ç½®é¢„è§ˆçŠ¶æ€çš„ç›‘å¬</span></span><br><span class="line">        mAppController.setPreviewStatusListener(mPreviewStatusListener);</span><br><span class="line">        <span class="keyword">synchronized</span> (mSurfaceTextureLock) &#123;</span><br><span class="line">            <span class="comment">//è·å–SurfaceTexture</span></span><br><span class="line">            mPreviewSurfaceTexture = mAppController.getCameraAppUI()</span><br><span class="line">                .getSurfaceTexture();</span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè·å–å‰é¢åˆ›å»ºçš„OneCameraOpenerå¯¹è±¡ä»¥åŠOneCameraManagerå¯¹è±¡ï¼Œç„¶åå†è®¾ç½®é¢„è§ˆçŠ¶æ€ç›‘å¬ï¼Œè¿™é‡Œä¸»è¦åˆ†æé¢„è§ˆçŠ¶æ€çš„ç›‘å¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PreviewStatusListener mPreviewStatusListener = <span class="keyword">new</span> </span><br><span class="line">    PreviewStatusListener() &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureAvailable</span><span class="params">(SurfaceTexture surface, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">            updatePreviewTransform(width, height, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (mSurfaceTextureLock) &#123;</span><br><span class="line">                mPreviewSurfaceTexture = surface;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ‰“å¼€Camera</span></span><br><span class="line">            reopenCamera();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSurfaceTextureDestroyed</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onSurfaceTextureDestroyed&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (mSurfaceTextureLock) &#123;</span><br><span class="line">                mPreviewSurfaceTexture = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å…³é—­Camera</span></span><br><span class="line">            closeCamera();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureSizeChanged</span><span class="params">(SurfaceTexture surface, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//æ›´æ–°é¢„è§ˆå°ºå¯¸</span></span><br><span class="line">            updatePreviewBufferSize();</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œå½“SurfaceTextureçš„çŠ¶æ€å˜æˆå¯ç”¨çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨reopenCamera()æ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œæ‰€ä»¥ç»§ç»­åˆ†æreopenCamera()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reopenCamera</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPaused) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    AsyncTask.THREAD_POOL_EXECUTOR.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            closeCamera();</span><br><span class="line">            <span class="keyword">if</span>(!mAppController.isPaused()) &#123;</span><br><span class="line">                <span class="comment">//å¼€å¯Cameraå¹¶å¼€å§‹é¢„è§ˆ</span></span><br><span class="line">                openCameraAndStartPreview();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒé‡‡ç”¨å¼‚æ­¥ä»»åŠ¡çš„æ–¹æ³•ï¼Œå¼€å¯ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ¥è¿›è¡Œå¯åŠ¨æ“ä½œï¼Œé¦–å…ˆå…³é—­æ‰“å¼€çš„Cameraï¼Œç„¶åå¦‚æœAppControllerä¸å¤„äºæš‚åœçŠ¶æ€ï¼Œåˆ™æ‰“å¼€Cameraå¹¶å¯åŠ¨Previewæ“ä½œï¼Œæ‰€ä»¥ç»§ç»­åˆ†æopenCameraAndStartPreviewæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/CaptureModule.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openCameraAndStartPreview</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mOneCameraOpener == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;no available OneCameraManager, showing error dialog&quot;</span>);</span><br><span class="line">        <span class="comment">//é‡Šæ”¾CameraOpenCloseLocké”</span></span><br><span class="line">        mCameraOpenCloseLock.release();</span><br><span class="line">        mAppController.getFatalErrorHandler().onGenericCameraAccessFailure();</span><br><span class="line">        guard.stop(<span class="string">&quot;No OneCameraManager&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Derive objects necessary for camera creation.</span></span><br><span class="line">    MainThread mainThread = MainThread.create();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾éœ€è¦æ‰“å¼€çš„CameraId</span></span><br><span class="line">    CameraId cameraId = mOneCameraManager.findFirstCameraFacing(</span><br><span class="line">        mCameraFacing);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰“å¼€Camera</span></span><br><span class="line">    mOneCameraOpener.open(cameraId, captureSetting, mCameraHandler,</span><br><span class="line">        mainThread, imageRotationCalculator, mBurstController, </span><br><span class="line">        mSoundPlayer,<span class="keyword">new</span> OpenCallback() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//è¿›è¡Œå¤±è´¥çš„å¤„ç†</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCameraClosed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCameraOpened</span><span class="params">(<span class="meta">@Nonnull</span> <span class="keyword">final</span> OneCamera camera)</span> </span>&#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onCameraOpened: &quot;</span> + camera);</span><br><span class="line">                mCamera = camera;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mAppController.isPaused()) &#123;</span><br><span class="line">                    onFailure();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">                mMainThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//é€šçŸ¥UIï¼ŒCameraçŠ¶æ€å˜åŒ–</span></span><br><span class="line">                        mAppController.getCameraAppUI().onChangeCamera();</span><br><span class="line">                        <span class="comment">//ä½¿èƒ½æ‹ç…§æŒ‰é’®</span></span><br><span class="line">                        mAppController.getButtonManager().enableCameraButton();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//è‡³æ­¤ï¼ŒCameraæ‰“å¼€æˆåŠŸï¼Œå¼€å§‹é¢„è§ˆ                    </span></span><br><span class="line">                camera.startPreview(<span class="keyword">new</span> Surface(getPreviewSurfaceTexture()), </span><br><span class="line">                    <span class="keyword">new</span> CaptureReadyCallback() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSetupFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            ...</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReadyForCapture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                            mCameraOpenCloseLock.release();</span><br><span class="line">                            mMainThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    ...</span><br><span class="line">                                    onPreviewStarted();</span><br><span class="line">                                    ...</span><br><span class="line">                                    onReadyStateChanged(<span class="keyword">true</span>);</span><br><span class="line">                                    <span class="comment">//è®¾ç½®CaptureModuleä¸ºCaptureå‡†å¤‡çš„çŠ¶æ€ç›‘å¬</span></span><br><span class="line">                                    mCamera.setReadyStateChangedListener(</span><br><span class="line">                                        CaptureModule.<span class="keyword">this</span>);</span><br><span class="line">                                        mUI.initializeZoom(mCamera.getMaxZoom());                                 </span><br><span class="line">                                        mCamera.setFocusStateListener(</span><br><span class="line">                                            CaptureModule.<span class="keyword">this</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125; </span><br><span class="line">              &#125;, mAppController.getFatalErrorHandler());</span><br><span class="line">        guard.stop(<span class="string">&quot;mOneCameraOpener.open()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œå®ƒä¸»è¦ä¼šè°ƒç”¨Camera2OneCameraOpenerImplçš„openæ–¹æ³•æ¥æ‰“å¼€Cameraï¼Œå¹¶å®šä¹‰äº†å¼€å¯çš„å›è°ƒå‡½æ•°ï¼Œå¯¹å¼€å¯ç»“æŸåçš„ç»“æœè¿›è¡Œå¤„ç†ï¼Œå¦‚å¤±è´¥åˆ™é‡Šæ”¾mCameraOpenCloseLockï¼Œå¹¶æš‚åœmAppControllerï¼Œå¦‚æœæ‰“å¼€æˆåŠŸï¼Œé€šçŸ¥UIæˆåŠŸï¼Œå¹¶å¼€å¯Cameraçš„Previewï¼Œå¹¶ä¸”å®šä¹‰äº†Previewçš„å„ç§å›è°ƒæ“ä½œï¼Œè¿™é‡Œä¸»è¦åˆ†æOpenè¿‡ç¨‹ï¼Œæ‰€ä»¥ç»§ç»­åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;/packages/apps/Camera2/src/com/android/camera/one/v2/Camera2OneCameraOpenerImpl.java]</span><br><span class="line">Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ...</span></span></span><br><span class="line"><span class="function"><span class="params">    mActiveCameraDeviceTracker.onCameraOpening(cameraKey)</span></span>;</span><br><span class="line">    <span class="comment">//æ‰“å¼€Cameraï¼Œæ­¤å¤„è°ƒç”¨æ¡†æ¶å±‚çš„CameraManagerç±»çš„openCameraï¼Œè¿›å…¥frameworkså±‚</span></span><br><span class="line">    mCameraManager.openCamera(cameraKey.getValue(), </span><br><span class="line">        <span class="keyword">new</span> CameraDevice.StateCallback() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isFirstCallback = <span class="keyword">true</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpened</span><span class="params">(CameraDevice device)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//ç¬¬ä¸€æ¬¡è°ƒç”¨æ­¤å›è°ƒ</span></span><br><span class="line">            <span class="keyword">if</span> (isFirstCallback) &#123;</span><br><span class="line">                isFirstCallback = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    CameraCharacteristics characteristics = mCameraManager</span><br><span class="line">                        .getCameraCharacteristics(device.getId());</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//åˆ›å»ºOneCameraå¯¹è±¡</span></span><br><span class="line">                    OneCamera oneCamera = OneCameraCreator.create(device,</span><br><span class="line">                        characteristics, mFeatureConfig, captureSetting,</span><br><span class="line">                        mDisplayMetrics, mContext, mainThread,</span><br><span class="line">                        imageRotationCalculator, burstController, soundPlayer,</span><br><span class="line">                        fatalErrorHandler);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (oneCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//å¦‚æœoneCameraä¸ä¸ºç©ºï¼Œåˆ™å›è°ƒonCameraOpenedï¼Œåé¢å°†åšåˆ†æ</span></span><br><span class="line">                        openCallback.onCameraOpened(oneCamera);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ...</span><br><span class="line">                        openCallback.onFailure();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CameraAccessException e) &#123;</span><br><span class="line">                    openCallback.onFailure();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (OneCameraAccessException e) &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;Could not create OneCamera&quot;</span>, e);</span><br><span class="line">                    openCallback.onFailure();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, handler);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼ŒCameraçš„åˆå§‹åŒ–æµç¨‹ä¸­åº”ç”¨å±‚çš„åˆ†æå°±å·®ä¸å¤šäº†ï¼Œä¸‹ä¸€æ­¥å°†ä¼šè°ƒç”¨CameraManagerçš„openCameraæ–¹æ³•æ¥è¿›å…¥æ¡†æ¶å±‚ï¼Œå¹¶è¿›è¡ŒCameraçš„åˆå§‹åŒ–ï¼Œä¸‹é¢å°†åº”ç”¨å±‚çš„åˆå§‹åŒ–æ—¶åºå›¾ï¼š </p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-16-camera_open_java.png" alt="Alt text"></p>
<h5 id="4-2ã€Camera2-æ¡†æ¶å±‚ï¼ˆJNI-amp-Nativeï¼‰Open-è¿‡ç¨‹åˆ†æ"><a href="#4-2ã€Camera2-æ¡†æ¶å±‚ï¼ˆJNI-amp-Nativeï¼‰Open-è¿‡ç¨‹åˆ†æ" class="headerlink" title="4.2ã€Camera2 æ¡†æ¶å±‚ï¼ˆJNI &amp; Nativeï¼‰Open()è¿‡ç¨‹åˆ†æ"></a>4.2ã€Camera2 æ¡†æ¶å±‚ï¼ˆJNI &amp; Nativeï¼‰Open()è¿‡ç¨‹åˆ†æ</h5><p>ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå°†ç”±åº”ç”¨å±‚è¿›å…¥åˆ°æ¡†æ¶å±‚å¤„ç†ï¼Œå°†ä¼šè°ƒç”¨CameraManagerçš„openCameraæ–¹æ³•ï¼Œå¹¶ä¸”å®šä¹‰äº†CameraDeviceçš„çŠ¶æ€å›è°ƒå‡½æ•°ï¼Œå…·ä½“çš„å›è°ƒæ“ä½œæ­¤å¤„ä¸åšåˆ†æï¼Œç»§ç»­è·Ÿè¸ªopenCamera()æ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CameraManager.java(frameworks/base/core/java/android/hardware/camera2)</span></span><br><span class="line">@RequiresPermission(android.Manifest.permission.CAMERA)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(@NonNull String cameraId,@NonNull <span class="keyword">final</span> </span></span></span><br><span class="line"><span class="function"><span class="params">        CameraDevice.StateCallback callback, @Nullable Handler handler)</span></span></span><br><span class="line"><span class="function">        throws CameraAccessException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    openCameraDeviceUserAsync(cameraId, callback, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œæ­¤å¤„ä¸Camera1.0æœ‰æ˜æ˜¾ä¸åŒï¼ŒCamera1.0æ˜¯é€šè¿‡ä¸€ä¸ªå¼‚æ­¥çš„çº¿ç¨‹ä»¥åŠJNIæ¥è°ƒç”¨android_hardware_camera.javaé‡Œé¢çš„native_setupæ–¹æ³•æ¥è¿æ¥Cameraï¼Œå…¶ä½¿ç”¨çš„æ˜¯C++çš„Binderæ¥ä¸CameraServiceè¿›è¡Œé€šä¿¡çš„ï¼Œè€Œæ­¤å¤„åˆ™ä¸ä¸€æ ·ï¼Œå®ƒç›´æ¥ä½¿ç”¨çš„æ˜¯Javaå±‚çš„Binderæ¥è¿›è¡Œé€šä¿¡ï¼Œå…ˆçœ‹openCameraDeviceUserAsyncä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CameraManager.java(frameworks/base/core/java/android/hardware/camera2)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> CameraDevice <span class="title">openCameraDeviceUserAsync</span><span class="params">(String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraDevice.StateCallback callback, Handler handler)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line">    CameraCharacteristics characteristics = getCameraCharacteristics(</span><br><span class="line">        cameraId);</span><br><span class="line">    CameraDevice device = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            ICameraDeviceUser cameraUser = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªCameraDeviceå¯¹è±¡</span></span><br><span class="line">            android.hardware.camera2.impl.CameraDeviceImpl deviceImpl =</span><br><span class="line">                <span class="keyword">new</span> android.hardware.camera2.impl.CameraDeviceImpl(cameraId,</span><br><span class="line">                callback, handler, characteristics);</span><br><span class="line">            BinderHolder holder = <span class="keyword">new</span> BinderHolder();</span><br><span class="line">            <span class="comment">//è·å–å›è°ƒ</span></span><br><span class="line">            ICameraDeviceCallbacks callbacks = deviceImpl.getCallbacks();</span><br><span class="line">            <span class="keyword">int</span> id = Integer.parseInt(cameraId);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (supportsCamera2ApiLocked(cameraId)) &#123;</span><br><span class="line">                    <span class="comment">//é€šè¿‡Javaå±‚çš„Binderè·å–CameraService                        </span></span><br><span class="line">                    ICameraService cameraService = CameraManagerGlobal.get()</span><br><span class="line">                        .getCameraService();</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="comment">//é€šè¿‡CameraServiceè¿æ¥Cameraè®¾å¤‡</span></span><br><span class="line">                    cameraService.connectDevice(callbacks, id, mContext</span><br><span class="line">                        .getOpPackageName(), USE_CALLING_UID, holder);</span><br><span class="line">                    <span class="comment">//è·å–è¿æ¥æˆåŠŸçš„CameraUserå¯¹è±¡ï¼Œå®ƒç”¨æ¥ä¸CameraServiceé€šä¿¡</span></span><br><span class="line">                    cameraUser = ICameraDeviceUser.Stub.asInterface(</span><br><span class="line">                        holder.getBinder());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//ä½¿ç”¨é—ç•™çš„API</span></span><br><span class="line">                    cameraUser = CameraDeviceUserShim.connectBinderShim(</span><br><span class="line">                        callbacks, id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CameraRuntimeException e) &#123;</span><br><span class="line">                ...</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//å°†å…¶åŒ…è£…æˆDeviceImplå¯¹è±¡ï¼Œä¾›åº”ç”¨å±‚ä½¿ç”¨</span></span><br><span class="line">            deviceImpl.setRemoteDevice(cameraUser);</span><br><span class="line">            device = deviceImpl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CameraRuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.asChecked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> device;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ–¹æ³•çš„ç›®çš„æ˜¯é€šè¿‡CameraServiceæ¥è¿æ¥å¹¶è·å–CameraDeviceå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨æ¥ä¸Cameraè¿›è¡Œé€šä¿¡æ“ä½œã€‚ä»£ç é¦–å…ˆé€šè¿‡Javaå±‚çš„Binderæœºåˆ¶è·å–CameraServiceï¼Œç„¶åè°ƒç”¨å…¶connectDeviceæ–¹æ³•æ¥è¿æ¥CaneraDeviceï¼Œæœ€åCameraè¿”å›çš„æ˜¯CameraDeviceUserå¯¹è±¡ï¼Œè€Œæ¥ç€å°†å…¶å°è£…æˆJavå±‚CameraDeviceå¯¹è±¡ï¼Œè€Œä¹‹åæ‰€æœ‰ä¸Cameraçš„é€šä¿¡éƒ½é€šè¿‡CameraDeviceçš„æ¥å£æ¥è¿›è¡Œã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹Nativeå±‚ä¸‹çš„CameraDeviceçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\CameraService.cpp]</span><br><span class="line"><span class="comment">//CameraService.cppï¼Œå…¶ä¸­deviceä¸ºè¾“å‡ºå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">CameraService::connectDevice</span><span class="params">(<span class="keyword">const</span> sp&lt;ICameraDeviceCallbacks&gt;&amp; cameraCb,<span class="keyword">int</span> cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String16&amp; clientPackageName,<span class="keyword">int</span> clientUid,<span class="comment">/*out*/</span>sp&lt;ICameraDeviceUser&gt;&amp; device)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> ret = NO_ERROR;</span><br><span class="line">    String8 id = String8::format(<span class="string">&quot;%d&quot;</span>, cameraId);</span><br><span class="line">    sp&lt;CameraDeviceClient&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    ret = connectHelper&lt;ICameraDeviceCallbacks,CameraDeviceClient&gt;(cameraCb, id,</span><br><span class="line">            CAMERA_HAL_API_VERSION_UNSPECIFIED, clientPackageName, clientUid, API_2, <span class="literal">false</span>, <span class="literal">false</span>,</span><br><span class="line">            <span class="comment">/*out*/</span>client);<span class="comment">//clientä¸ºè¾“å‡ºå¯¹è±¡</span></span><br><span class="line">    ...</span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nativeå±‚çš„connectDeviceæ–¹æ³•å°±æ˜¯è°ƒç”¨äº†connectHelperæ–¹æ³•ï¼Œæ‰€ä»¥ç»§ç»­åˆ†æconnectHelperï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\CameraService.h]</span><br><span class="line"><span class="comment">//CameraService.h</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">CALLBACK</span>, <span class="title">class</span> <span class="title">CLIENT</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">status_t</span> <span class="title">CameraService</span>:</span>:connectHelper(<span class="keyword">const</span> sp&lt;CALLBACK&gt;&amp; cameraCb, <span class="keyword">const</span> String8&amp; cameraId,</span><br><span class="line">        <span class="keyword">int</span> halVersion, <span class="keyword">const</span> String16&amp; clientPackageName, <span class="keyword">int</span> clientUid,</span><br><span class="line">        apiLevel effectiveApiLevel, <span class="keyword">bool</span> legacyMode, <span class="keyword">bool</span> shimUpdateOnly,</span><br><span class="line">        <span class="comment">/*out*/</span>sp&lt;CLIENT&gt;&amp; device) &#123;</span><br><span class="line">    <span class="keyword">status_t</span> ret = NO_ERROR;</span><br><span class="line">    <span class="function">String8 <span class="title">clientName8</span><span class="params">(clientPackageName)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> clientPid = getCallingPid();</span><br><span class="line">    ...</span><br><span class="line">    sp&lt;CLIENT&gt; client = <span class="literal">nullptr</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰å¿…è¦ï¼Œç»™FlashLightå…³é—­è®¾å¤‡çš„æœºä¼š</span></span><br><span class="line">        mFlashlight-&gt;prepareDeviceOpen(cameraId);</span><br><span class="line">        <span class="comment">//è·å–CameraId</span></span><br><span class="line">        <span class="keyword">int</span> id = cameraIdToInt(cameraId);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//è·å–Deviceçš„ç‰ˆæœ¬ï¼Œæ­¤å¤„ä¸ºDevice3</span></span><br><span class="line">        <span class="keyword">int</span> deviceVersion = getDeviceVersion(id, <span class="comment">/*out*/</span>&amp;facing);</span><br><span class="line">        sp&lt;BasicClient&gt; tmp = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">//è·å–clientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span>((ret = makeClient(<span class="keyword">this</span>, cameraCb, clientPackageName, cameraId, facing, clientPid,</span><br><span class="line">                clientUid, getpid(), legacyMode, halVersion, deviceVersion, effectiveApiLevel,</span><br><span class="line">                <span class="comment">/*out*/</span>&amp;tmp)) != NO_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        client = <span class="keyword">static_cast</span>&lt;CLIENT*&gt;(tmp.get());</span><br><span class="line">        <span class="comment">//è°ƒç”¨clientçš„åˆå§‹åŒ–å‡½æ•°æ¥åˆå§‹åŒ–æ¨¡å—</span></span><br><span class="line">        <span class="keyword">if</span> ((ret = client-&gt;initialize(mModule)) != OK) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;%s: Could not initialize client from HAL module.&quot;</span>, __FUNCTION__);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp&lt;IBinder&gt; remoteCallback = client-&gt;getRemote();</span><br><span class="line">        <span class="keyword">if</span> (remoteCallback != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            remoteCallback-&gt;linkToDeath(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// lock is destroyed, allow further connect calls</span></span><br><span class="line">    <span class="comment">//å°†clientèµ‹å€¼ç»™è¾“å‡ºDevice</span></span><br><span class="line">    device = client;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraServiceæ ¹æ®Cameraçš„ç›¸å…³å‚æ•°æ¥è·å–ä¸€ä¸ªclientï¼Œå¦‚makeClientæ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨clientçš„initializeæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œé¦–å…ˆçœ‹makeClientï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\CameraService.cpp]</span><br><span class="line"><span class="comment">//CameraService.cppï¼Œå…¶ä¸­deviceä¸ºè¾“å‡ºå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">CameraService::makeClient</span><span class="params">(<span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> sp&lt;IInterface&gt;&amp; cameraCb, <span class="keyword">const</span> String16&amp; packageName, <span class="keyword">const</span> String8&amp; cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> facing, <span class="keyword">int</span> clientPid, <span class="keyword">uid_t</span> clientUid, <span class="keyword">int</span> servicePid, <span class="keyword">bool</span> legacyMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> halVersion, <span class="keyword">int</span> deviceVersion, apiLevel effectiveApiLevel,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">/*out*/</span>sp&lt;BasicClient&gt;* client)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å­—ç¬¦ä¸²çš„CameraIdè½¬æ¢æˆæ•´å½¢</span></span><br><span class="line">    <span class="keyword">int</span> id = cameraIdToInt(cameraId);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (halVersion &lt; <span class="number">0</span> || halVersion == deviceVersion) &#123;<span class="comment">//åˆ¤æ–­Camera HALç‰ˆæœ¬æ˜¯å¦å’ŒDeviceçš„ç‰ˆæœ¬ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">switch</span>(deviceVersion) &#123;</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_1_0:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123;  <span class="comment">// Camera1 API route</span></span><br><span class="line">                sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraClient(cameraService, tmp, packageName, id, facing,</span><br><span class="line">                        clientPid, clientUid, getpid(), legacyMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                ALOGW(<span class="string">&quot;Camera using old HAL version: %d&quot;</span>, deviceVersion);</span><br><span class="line">                <span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_2_0:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_2_1:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_0:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_1:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_2:</span><br><span class="line">          <span class="keyword">case</span> CAMERA_DEVICE_API_VERSION_3_3:</span><br><span class="line">            <span class="keyword">if</span> (effectiveApiLevel == API_1) &#123; <span class="comment">// Camera1 API route</span></span><br><span class="line">                sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> Camera2Client(cameraService, tmp, packageName, id, facing,</span><br><span class="line">                        clientPid, clientUid, servicePid, legacyMode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Camera2 API route</span></span><br><span class="line">                sp&lt;ICameraDeviceCallbacks&gt; tmp =</span><br><span class="line">                        <span class="keyword">static_cast</span>&lt;ICameraDeviceCallbacks*&gt;(cameraCb.get());</span><br><span class="line">                *client = <span class="keyword">new</span> CameraDeviceClient(cameraService, tmp, packageName, id,</span><br><span class="line">                        facing, clientPid, clientUid, servicePid);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// Should not be reachable</span></span><br><span class="line">            ALOGE(<span class="string">&quot;Unknown camera device HAL version: %d&quot;</span>, deviceVersion);</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// A particular HAL version is requested by caller. Create CameraClient</span></span><br><span class="line">        <span class="comment">// based on the requested HAL version.</span></span><br><span class="line">        <span class="keyword">if</span> (deviceVersion &gt; CAMERA_DEVICE_API_VERSION_1_0 &amp;&amp;</span><br><span class="line">            halVersion == CAMERA_DEVICE_API_VERSION_1_0) &#123;</span><br><span class="line">            <span class="comment">// Only support higher HAL version device opened as HAL1.0 device.</span></span><br><span class="line">            sp&lt;ICameraClient&gt; tmp = <span class="keyword">static_cast</span>&lt;ICameraClient*&gt;(cameraCb.get());</span><br><span class="line">            *client = <span class="keyword">new</span> CameraClient(cameraService, tmp, packageName, id, facing,</span><br><span class="line">                    clientPid, clientUid, servicePid, legacyMode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Other combinations (e.g. HAL3.x open as HAL2.x) are not supported yet.</span></span><br><span class="line">            ALOGE(<span class="string">&quot;Invalid camera HAL version %x: HAL %x device can only be&quot;</span></span><br><span class="line">                    <span class="string">&quot; opened as HAL %x device&quot;</span>, halVersion, deviceVersion,</span><br><span class="line">                    CAMERA_DEVICE_API_VERSION_1_0);</span><br><span class="line">            <span class="keyword">return</span> INVALID_OPERATION;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­å°±æ˜¯åˆ›å»ºä¸€ä¸ªClientå¯¹è±¡ï¼Œç”±äºæ­¤å¤„åˆ†æçš„æ˜¯Camera API2.0ï¼Œå…¶HALçš„ç‰ˆæœ¬æ˜¯3.0+ï¼Œè€ŒDeviceçš„ç‰ˆæœ¬åˆ™å…¶Deviceçš„ç‰ˆæœ¬å³ä¸º3.0+ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºä¸€ä¸ªCameraDeviceClientå¯¹è±¡ï¼Œè‡³æ­¤ï¼ŒmakeClientå·²ç»åˆ›å»ºäº†clientå¯¹è±¡ï¼Œå¹¶è¿”å›äº†ï¼Œæ¥ç€çœ‹å®ƒçš„åˆå§‹åŒ–ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp]</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">CameraDeviceClient::initialize</span><span class="params">(CameraModule *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    <span class="keyword">status_t</span> res;</span><br><span class="line">    <span class="comment">//è°ƒç”¨Camera2ClientBaseçš„åˆå§‹åŒ–å‡½æ•°æ¥åˆå§‹åŒ–CameraModuleæ¨¡å—</span></span><br><span class="line">    res = Camera2ClientBase::initialize(<span class="keyword">module</span>);</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String8 threadName;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–FrameProcessor</span></span><br><span class="line">    mFrameProcessor = <span class="keyword">new</span> FrameProcessorBase(mDevice);</span><br><span class="line">    threadName = String8::format(<span class="string">&quot;CDU-%d-FrameProc&quot;</span>, mCameraId);</span><br><span class="line">    mFrameProcessor-&gt;run(threadName.<span class="built_in">string</span>());</span><br><span class="line">    <span class="comment">//å¹¶æ³¨å†Œç›‘å¬ï¼Œç›‘å¬çš„å®ç°å°±åœ¨CameraDeviceClientç±»ä¸­</span></span><br><span class="line">    mFrameProcessor-&gt;registerListener(FRAME_PROCESSOR_LISTENER_MIN_ID,</span><br><span class="line">            FRAME_PROCESSOR_LISTENER_MAX_ID, <span class="comment">/*listener*/</span><span class="keyword">this</span>,<span class="comment">/*sendPartials*/</span><span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒä¼šè°ƒç”¨Camera2ClientBaseçš„initializeæ–¹æ³•æ¥åˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¼šåˆå§‹åŒ–ä¸€ä¸ªFrameProcessoræ¥è¿›è¡Œå¸§å¤„ç†ï¼Œä¸»è¦æ˜¯å›è°ƒæ¯ä¸€å¸§çš„ExtraResultåˆ°åº”ç”¨ä¸­ï¼Œä¹Ÿå°±æ˜¯3Aç›¸å…³çš„æ•°æ®ä¿¡æ¯ã€‚è€ŒCamera1.0ä¸­å„ç§Processoræ¨¡å—ï¼Œå³å°†æ•°æ®æ‰“åŒ…å¤„ç†åå†è¿”å›åˆ°åº”ç”¨çš„æ¨¡å—éƒ½å·²ç»ä¸å­˜åœ¨ï¼Œè€ŒCamera2.0ä¸­å°†ç”±MediaRecorderã€SurfaceViewã€ImageReaderç­‰æ¥ç›´æ¥å¤„ç†ï¼Œæ€»ä½“æ¥è¯´æ•ˆç‡æ›´å¥½ã€‚ç»§ç»­çœ‹initializeï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\common\Camera2ClientBase.cpp]</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line"><span class="keyword">status_t</span> Camera2ClientBase&lt;TClientBase&gt;::initialize(CameraModule *<span class="keyword">module</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è°ƒç”¨Deviceçš„initialieæ–¹æ³•</span></span><br><span class="line">    res = mDevice-&gt;initialize(<span class="keyword">module</span>);</span><br><span class="line">    ...</span><br><span class="line">    res = mDevice-&gt;setNotifyCallback(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å°±æ˜¯è°ƒç”¨äº†Deviceçš„initializeæ–¹æ³•ï¼Œæ­¤å¤„çš„Deviceæ˜¯åœ¨Camera2ClientBaseçš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºçš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\common\Camera2ClientBase.cpp]</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TClientBase&gt;</span><br><span class="line">Camera2ClientBase&lt;TClientBase&gt;::Camera2ClientBase(</span><br><span class="line">        <span class="keyword">const</span> sp&lt;CameraService&gt;&amp; cameraService,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;TCamCallbacks&gt;&amp; remoteCallback,</span><br><span class="line">        <span class="keyword">const</span> String16&amp; clientPackageName,</span><br><span class="line">        <span class="keyword">int</span> cameraId,</span><br><span class="line">        <span class="keyword">int</span> cameraFacing,</span><br><span class="line">        <span class="keyword">int</span> clientPid,</span><br><span class="line">        <span class="keyword">uid_t</span> clientUid,</span><br><span class="line">        <span class="keyword">int</span> servicePid):</span><br><span class="line">        TClientBase(cameraService, remoteCallback, clientPackageName,</span><br><span class="line">                cameraId, cameraFacing, clientPid, clientUid, servicePid),</span><br><span class="line">        mSharedCameraCallbacks(remoteCallback),</span><br><span class="line">        mDeviceVersion(cameraService-&gt;getDeviceVersion(cameraId)),</span><br><span class="line">        mDeviceActive(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGI(<span class="string">&quot;Camera %d: Opened. Client: %s (PID %d, UID %d)&quot;</span>, cameraId,</span><br><span class="line">            String8(clientPackageName).<span class="built_in">string</span>(), clientPid, clientUid);</span><br><span class="line"></span><br><span class="line">    mInitialClientPid = clientPid;</span><br><span class="line">    mDevice = <span class="keyword">new</span> Camera3Device(cameraId);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mDevice == <span class="number">0</span>, <span class="string">&quot;Device should never be NULL here.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›®å‰Camera APIæ˜¯2.0ï¼Œè€ŒDeviceçš„APIå·²ç»æ˜¯3.0+äº†ï¼Œç»§ç»­çœ‹Camera3Deviceçš„æ„é€ æ–¹æ³•ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line">Camera3Device::Camera3Device(<span class="keyword">int</span> id):</span><br><span class="line">        mId(id),</span><br><span class="line">        mIsConstrainedHighSpeedConfiguration(<span class="literal">false</span>),</span><br><span class="line">        mHal3Device(<span class="literal">NULL</span>),</span><br><span class="line">        mStatus(STATUS_UNINITIALIZED),</span><br><span class="line">        mStatusWaiters(<span class="number">0</span>),</span><br><span class="line">        mUsePartialResult(<span class="literal">false</span>),</span><br><span class="line">        mNumPartialResults(<span class="number">1</span>),</span><br><span class="line">        mTimestampOffset(<span class="number">0</span>),</span><br><span class="line">        mNextResultFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mNextReprocessResultFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mNextShutterFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mNextReprocessShutterFrameNumber(<span class="number">0</span>),</span><br><span class="line">        mListener(<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    camera3_callback_ops::notify = &amp;sNotify;</span><br><span class="line">    camera3_callback_ops::process_capture_result = &amp;sProcessCaptureResult;</span><br><span class="line">    ALOGV(<span class="string">&quot;%s: Created device for camera %d&quot;</span>, __FUNCTION__, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜¾ç„¶ï¼Œå®ƒå°†ä¼šåˆ›å»ºä¸€ä¸ªCamera3Deviceå¯¹è±¡ï¼Œæ‰€ä»¥ï¼ŒDeviceçš„initializeå°±æ˜¯è°ƒç”¨äº†Camera3Deviceçš„initializeæ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp]</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3Device::initialize</span><span class="params">(CameraModule *<span class="keyword">module</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">camera3_device_t</span> *device;</span><br><span class="line">    <span class="comment">//æ‰“å¼€Camera HALå±‚çš„Deivce</span></span><br><span class="line">    res = <span class="keyword">module</span>-&gt;open(deviceName.<span class="built_in">string</span>(),</span><br><span class="line">            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">hw_device_t</span>**&gt;(&amp;device));</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº¤å‰æ£€æŸ¥Deviceçš„ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">if</span> (device-&gt;common.version &lt; CAMERA_DEVICE_API_VERSION_3_0) &#123;</span><br><span class="line">        SET_ERR_L(<span class="string">&quot;Could not open camera: &quot;</span></span><br><span class="line">                <span class="string">&quot;Camera device should be at least %x, reports %x instead&quot;</span>,</span><br><span class="line">                CAMERA_DEVICE_API_VERSION_3_0,</span><br><span class="line">                device-&gt;common.version);</span><br><span class="line">        device-&gt;common.close(&amp;device-&gt;common);</span><br><span class="line">        <span class="keyword">return</span> BAD_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è°ƒç”¨å›è°ƒå‡½æ•°æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå³è°ƒç”¨æ‰“å¼€Deviceçš„initializeæ–¹æ³•æ¥è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">    res = device-&gt;ops-&gt;initialize(device, <span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨è¯·æ±‚é˜Ÿåˆ—çº¿ç¨‹</span></span><br><span class="line">    mRequestThread = <span class="keyword">new</span> RequestThread(<span class="keyword">this</span>, mStatusTracker, device, aeLockAvailable);</span><br><span class="line">    res = mRequestThread-&gt;run(String8::format(<span class="string">&quot;C3Dev-%d-ReqQueue&quot;</span>, mId).<span class="built_in">string</span>());</span><br><span class="line">    <span class="keyword">if</span> (res != OK) &#123;</span><br><span class="line">        SET_ERR_L(<span class="string">&quot;Unable to start request queue thread: %s (%d)&quot;</span>,</span><br><span class="line">                strerror(-res), res);</span><br><span class="line">        device-&gt;common.close(&amp;device-&gt;common);</span><br><span class="line">        mRequestThread.clear();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è¿”å›åˆå§‹æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œä¼šä¾èµ–HALæ¡†æ¶æ‰“å¼€å¹¶è·å¾—ç›¸åº”çš„Deviceå¯¹è±¡ï¼Œå…·ä½“çš„æµç¨‹è¯·å‚è€ƒandroid6.0æºç åˆ†æä¹‹Camera2 HALåˆ†æï¼Œç„¶åå†å›è°ƒæ­¤å¯¹è±¡çš„initializeæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åå†å¯åŠ¨RequestThreadç­‰çº¿ç¨‹ï¼Œå¹¶è¿”å›initializeæˆåŠŸã€‚è‡³æ­¤Camera API2.0ä¸‹çš„åˆå§‹åŒ–è¿‡ç¨‹å°±åˆ†æç»“æŸäº†ã€‚æ¡†æ¶å±‚çš„åˆå§‹åŒ–æ—¶åºå›¾å¦‚ä¸‹ï¼š </p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-17-camera_open_native.png" alt="Alt text"></p>
<h5 id="4-2ã€æ€»ç»“"><a href="#4-2ã€æ€»ç»“" class="headerlink" title="4.2ã€æ€»ç»“"></a>4.2ã€æ€»ç»“</h5><p>Open()è¿‡ç¨‹é“è·¯è‰°è¾›ï¼Œä¸»è¦ä¸ºäº†åç»­Cameraæ­£å¸¸å·¥ä½œï¼Œæ·»ç –åŠ ç“¦ï¼Œé“ºè·¯ã€‚ä¸‹é¢æˆ‘ä»¬åˆ—ä¸¾ä¸€ä¸‹ï¼Œä¸»è¦éƒ½å‡†å¤‡äº†ä»€ä¹ˆã€‚<br>1ã€Cameraåº”ç”¨å°†ä¸€äº›Callbackå‡½æ•°ï¼Œæ³¨å†Œåˆ°Camera.javaä¸­ï¼Œä»¥ä½¿åœ¨çº¿ç¨‹å¤„ç†å‡½æ•°ä¸­å¯ä»¥è°ƒç”¨åˆ°ç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚<br>2ã€camera connectæˆåŠŸåï¼Œåˆ›å»ºäº†BpCameraä»£ç†å¯¹è±¡å’ŒBnCameraClientæœ¬åœ°å¯¹è±¡ã€‚<br>3ã€åœ¨JNICameraContextå®ç°CameraListeneræ¥å£ï¼Œå¹¶å°†æ¥å£æ³¨å†Œåˆ°å®¢æˆ·ç«¯cameraæœ¬åœ°å¯¹è±¡ä¸­ï¼Œå¹¶åœ¨BnCameraClientæœ¬åœ°å¯¹è±¡ä¸­å›è°ƒè¿™äº›æ¥å£ã€‚<br>4ã€CameraService connectè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®halç¡¬ä»¶ç‰ˆæœ¬ï¼Œåˆ›å»ºå¯¹åº”çš„CameraClientå¯¹è±¡ã€‚åœ¨åç»­çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œåˆ›å»º6å¤§çº¿ç¨‹ã€‚<br>æœ€åä»¥ä¸€ä¸ªç®€å•çš„å·¥ä½œæµç¨‹å›¾æ¥ç»“æŸåšæ–‡ </p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/camera.system/01-18-Camera_open_overview.png" alt="Alt text"></p>
<h4 id="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š"><a href="#ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™-ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º-ï¼š" class="headerlink" title="ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š"></a>ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</h4><p><a target="_blank" rel="noopener" href="https://source.android.com/devices/camera/">Android Cameraå®˜æ–¹æ–‡æ¡£</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/eternity9255">Android 5.0 Cameraç³»ç»Ÿæºç åˆ†æ-CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/stonedemo/category/1080451.html">Android Camera æµç¨‹å­¦ä¹ è®°å½• - StoneDemo - åšå®¢å›­</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/shell812/article/category/5905525">Android Camera ç³»ç»Ÿæ¶æ„æºç åˆ†æ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hbw1992322/article/details/75259311">Cameraå®‰å“æºç -é«˜é€šmm_cameraæ¶æ„å‰–æ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yanbixing123/article/details/52294305/">5.2 åº”ç”¨ç¨‹åºå’Œé©±åŠ¨ç¨‹åºä¸­bufferçš„ä¼ è¾“æµç¨‹ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ecb1be82e6a8">Camera2 æ•°æ®æµä»frameworkåˆ°Halæºç åˆ†æ - ç®€ä¹¦</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1baad2a5281d">mm-cameraå±‚frameæ•°æ®æµæºç åˆ†æ - ç®€ä¹¦</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yanbixing123/article/month/2016/08/4">v4l2_capture.cåˆ†æâ€”probeå‡½æ•°åˆ†æ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/armwind/article/category/6282972">@@Android Camera fwå­¦ä¹  - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzzaigcnforever/article/category/3066721">@@Android Camera API2åˆ†æ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_16775897/article/category/7112759">@@Android Camera æµç¨‹å­¦ä¹ è®°å½• 7.12- CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yangzhihuiguming/article/details/51382267">@@ä¸“æ ï¼šå¤å†¥çš„android6.0ä¸‹çš„Camera API2.0çš„æºç åˆ†æä¹‹æ—… - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzzaigcnforever/article/details/17751109">linux3.3 v4l2è§†é¢‘é‡‡é›†é©±åŠ¨æ¡†æ¶(vfe, camera i2c driverï¼Œv4l2_subdevç­‰ä¹‹é—´çš„è”ç³») - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzzaigcnforever/article/details/48974523">Android Cameraä»Camera HAL1åˆ°Camera HAL3çš„è¿‡æ¸¡ï¼ˆå·²æ›´æ–°åˆ°Android6.0 HAL3.3ï¼‰ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzzaigcnforever/article/details/48972477">æˆ‘å¿ƒä¾æ—§ä¹‹Android Cameraæ¨¡å—FW/HAL3æ¢å­¦åº - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/armwind/article/details/73709808">Android Camera fwå­¦ä¹ (å››)-recordingæµç¨‹åˆ†æ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/armwind/article/details/52076879">android cameraåŠ¨æ€åº“åŠ è½½è¿‡ç¨‹ - CSDNåšå®¢</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gzzaigcnforever/article/details/49468475">Android Camera API2.0ä¸‹å…¨æ–°çš„Camera FW/HALæ¶æ„ç®€è¿° - CSDNåšå®¢</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20190101/">https://zhoujinjian.com/posts/20190101/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Camera/">Camera</a><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.18.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20190109/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.19.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera ç³»ç»Ÿ startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ</div></div></a></div><div class="next-post pull-right"><a href="/posts/20181108/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.15.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Audio Systemï¼ˆ3ï¼‰ï¼šAndroid audio system(éŸ³é¢‘ç³»ç»Ÿ)åˆ†æ</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/20190109/" title="Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera ç³»ç»Ÿ startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/hexo.themes/bing-wallpaper-2018.04.19.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-01-09</div><div class="title">Android Camera Systemï¼ˆ2ï¼‰ï¼šCamera ç³»ç»Ÿ startPreviewã€takePictureã€Recorderæµç¨‹åˆ†æ</div></div></a></div><div><a href="/posts/20210310/" title="Android 10 Display Systemæºç åˆ†æï¼ˆ1ï¼‰ï¼šLCDæ˜¾ç¤ºåŸç†ï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display Systemæºç åˆ†æï¼ˆ1ï¼‰ï¼šLCDæ˜¾ç¤ºåŸç†ï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display Systemæºç åˆ†æï¼ˆ2ï¼‰ï¼šDisplay System ç²¾å½©ä¸–ç•Œï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display Systemæºç åˆ†æï¼ˆ2ï¼‰ï¼šDisplay System ç²¾å½©ä¸–ç•Œï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display Systemæºç åˆ†æï¼ˆ3ï¼‰ï¼šU-boot Display æ˜¾ç¤ºè¿‡ç¨‹æºç åˆ†æï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display Systemæºç åˆ†æï¼ˆ3ï¼‰ï¼šU-boot Display æ˜¾ç¤ºè¿‡ç¨‹æºç åˆ†æï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display Systemæºç åˆ†æï¼ˆ4ï¼‰ï¼šDRM/KMSåˆ†æï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display Systemæºç åˆ†æï¼ˆ4ï¼‰ï¼šDRM/KMSåˆ†æï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display Systemæºç åˆ†æï¼ˆ5ï¼‰ï¼šModeTeståˆ†æï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display Systemæºç åˆ†æï¼ˆ5ï¼‰ï¼šModeTeståˆ†æï¼ˆAndroid 10.0 && Kernel 4.15ï¼‰</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81Android-Camera-System-Architecture%EF%BC%88Camera%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">ï¼ˆä¸€ï¼‰ã€Android Camera System Architectureï¼ˆCameraç³»ç»Ÿæ¡†æ¶ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81Android-Camera-System%E6%80%BB%E4%BD%93%E6%A1%86%E6%9E%B6%EF%BC%88Qualcomm%E5%B9%B3%E5%8F%B0%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">1.1ã€Android Camera Systemæ€»ä½“æ¡†æ¶ï¼ˆQualcommå¹³å°ï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-1%E3%80%81%E9%A6%96%E5%85%88%E7%9C%8B%E7%9C%8BAndroid-%E5%AE%98%E6%96%B9Camera%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">1.1.1ã€é¦–å…ˆçœ‹çœ‹Android å®˜æ–¹Cameraæ€»ä½“æ¶æ„ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2%E3%80%81Qualcomm%E5%B9%B3%E5%8F%B0Camera-%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">1.1.2ã€Qualcommå¹³å°Camera æ¶æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2-1%E3%80%81Qualcomm%E5%B9%B3%E5%8F%B0Camera%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">1.1.2.1ã€Qualcommå¹³å°Cameraæ€»ä½“æ¶æ„</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2-2%E3%80%81Qualcomm%E5%B9%B3%E5%8F%B0Camera%E7%9A%84HAL%E3%80%81mm-camera"><span class="toc-number">1.5.</span> <span class="toc-text">1.1.2.2ã€Qualcommå¹³å°Cameraçš„HALã€mm-camera</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2-3%E3%80%81Qualcomm%E5%B9%B3%E5%8F%B0Camera%E7%9A%84Kernel"><span class="toc-number">1.6.</span> <span class="toc-text">1.1.2.3ã€Qualcommå¹³å°Cameraçš„Kernel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2%E3%80%81Android-Camera-API-2-0-%E5%85%A8%E6%96%B0%E7%9A%84HAL-%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.7.</span> <span class="toc-text">1.2ã€Android Camera API 2.0 å…¨æ–°çš„HAL å­ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1%E3%80%81%E8%AF%B7%E6%B1%82"><span class="toc-number">1.8.</span> <span class="toc-text">1.2.1ã€è¯·æ±‚</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2%E3%80%81HAL-%E5%92%8C%E7%9B%B8%E6%9C%BA%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.9.</span> <span class="toc-text">1.2.2ã€HAL å’Œç›¸æœºå­ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3%E3%80%81HAL-%E6%93%8D%E4%BD%9C%E6%91%98%E8%A6%81"><span class="toc-number">1.10.</span> <span class="toc-text">1.2.3ã€HAL æ“ä½œæ‘˜è¦</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-4%E3%80%81%E5%90%AF%E5%8A%A8%E5%92%8C%E9%A2%84%E6%9C%9F%E6%93%8D%E4%BD%9C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.11.</span> <span class="toc-text">1.2.4ã€å¯åŠ¨å’Œé¢„æœŸæ“ä½œé¡ºåº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3%E3%80%81Android-Graphics-%E5%AD%A6%E4%B9%A0%EF%BC%8D%E7%94%9F%E4%BA%A7%E8%80%85%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85%E3%80%81BufferQueue%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.12.</span> <span class="toc-text">1.3ã€Android Graphics å­¦ä¹ ï¼ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€BufferQueueä»‹ç»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4%E3%80%81Camera%E7%B1%BB%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%E5%92%8C%E4%BD%9C%E7%94%A8"><span class="toc-number">1.13.</span> <span class="toc-text">1.4ã€Cameraç±»ä¹‹é—´çš„å…³ç³»å’Œä½œç”¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-1%E3%80%81Camera%E7%B1%BB%E5%85%B3%E7%B3%BB%E6%80%BB%E4%BD%93%E6%A6%82%E8%A7%88"><span class="toc-number">1.14.</span> <span class="toc-text">1.4.1ã€Cameraç±»å…³ç³»æ€»ä½“æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-2%E3%80%81ICameraClient"><span class="toc-number">1.15.</span> <span class="toc-text">1.4.2ã€ICameraClient</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-3%E3%80%81ICamera"><span class="toc-number">1.16.</span> <span class="toc-text">1.4.3ã€ICamera</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4-4%E3%80%81ICameraService"><span class="toc-number">1.17.</span> <span class="toc-text">1.4.4ã€ICameraService</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81Android-CameraService%E5%BC%80%E6%9C%BA%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">ï¼ˆäºŒï¼‰ã€Android CameraServiceå¼€æœºåˆå§‹åŒ–åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81CameraService-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1ã€CameraService åˆå§‹åŒ–è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1%E3%80%81CameraService-onFirstRef"><span class="toc-number">2.2.</span> <span class="toc-text">2.1.1ã€CameraService::onFirstRef()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2%E3%80%81Camera-%E5%8A%A8%E6%80%81%E5%BA%93%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">2.1.2ã€Camera åŠ¨æ€åº“åŠ è½½è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3%E3%80%81%E5%9B%BE%E8%A7%A3camera-module%E5%92%8Ccamera-device-t%E5%85%B3%E7%B3%BB"><span class="toc-number">2.4.</span> <span class="toc-text">2.1.3ã€å›¾è§£camera_moduleå’Œcamera_device_tå…³ç³»</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81Android-Camera-Open%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">ï¼ˆä¸‰ï¼‰ã€Android Camera Openè¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81Camera2-HAL%E5%B1%82Open-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">3.1ã€Camera2 HALå±‚Open()è¿‡ç¨‹åˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1%E3%80%81QCamera3HardwareInterface%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">3.1.1ã€QCamera3HardwareInterfaceæ„é€ å‡½æ•°åˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2%E3%80%81openCamera-%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">3.1.2ã€openCamera()åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E3%80%81Camera-API2-0-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">ï¼ˆå››ï¼‰ã€Camera API2.0 åˆå§‹åŒ–æµç¨‹åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1%E3%80%81Camera2-%E5%BA%94%E7%94%A8%E5%B1%82%EF%BC%88Java%E5%B1%82%EF%BC%89Open-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">4.1ã€Camera2 åº”ç”¨å±‚ï¼ˆJavaå±‚ï¼‰Open()è¿‡ç¨‹åˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2%E3%80%81Camera2-%E6%A1%86%E6%9E%B6%E5%B1%82%EF%BC%88JNI-amp-Native%EF%BC%89Open-%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">4.2ã€Camera2 æ¡†æ¶å±‚ï¼ˆJNI &amp; Nativeï¼‰Open()è¿‡ç¨‹åˆ†æ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">4.3.</span> <span class="toc-text">4.2ã€æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%94%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-%E7%89%B9%E5%88%AB%E6%84%9F%E8%B0%A2%E5%90%84%E4%BD%8D%E5%89%8D%E8%BE%88%E7%9A%84%E5%88%86%E6%9E%90%E5%92%8C%E5%9B%BE%E7%A4%BA-%EF%BC%9A"><span class="toc-number">5.</span> <span class="toc-text">ï¼ˆäº”ï¼‰ã€å‚è€ƒèµ„æ–™(ç‰¹åˆ«æ„Ÿè°¢å„ä½å‰è¾ˆçš„åˆ†æå’Œå›¾ç¤º)ï¼š</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2ï¼ˆ8ï¼‰ï¼šRockchip RK3399 - DRM HDMIé©±åŠ¨ç¨‹åº"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2ï¼ˆ8ï¼‰ï¼šRockchip RK3399 - DRM HDMIé©±åŠ¨ç¨‹åº"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2ï¼ˆ8ï¼‰ï¼šRockchip RK3399 - DRM HDMIé©±åŠ¨ç¨‹åº">Android 11 Display System V2ï¼ˆ8ï¼‰ï¼šRockchip RK3399 - DRM HDMIé©±åŠ¨ç¨‹åº</a><time datetime="2024-02-24T16:00:00.000Z" title="å‘è¡¨äº 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2ï¼ˆ7ï¼‰ï¼šRockchip RK3399 - DRM HDMIä»‹ç»"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2ï¼ˆ7ï¼‰ï¼šRockchip RK3399 - DRM HDMIä»‹ç»"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2ï¼ˆ7ï¼‰ï¼šRockchip RK3399 - DRM HDMIä»‹ç»">Android 11 Display System V2ï¼ˆ7ï¼‰ï¼šRockchip RK3399 - DRM HDMIä»‹ç»</a><time datetime="2024-02-23T16:00:00.000Z" title="å‘è¡¨äº 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2ï¼ˆ6ï¼‰ï¼šRockchip RK3399 - DRM encoderã€bridgeã€connectoråŸºç¡€çŸ¥è¯†"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2ï¼ˆ6ï¼‰ï¼šRockchip RK3399 - DRM encoderã€bridgeã€connectoråŸºç¡€çŸ¥è¯†"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2ï¼ˆ6ï¼‰ï¼šRockchip RK3399 - DRM encoderã€bridgeã€connectoråŸºç¡€çŸ¥è¯†">Android 11 Display System V2ï¼ˆ6ï¼‰ï¼šRockchip RK3399 - DRM encoderã€bridgeã€connectoråŸºç¡€çŸ¥è¯†</a><time datetime="2024-02-22T16:00:00.000Z" title="å‘è¡¨äº 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2ï¼ˆ5ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2ï¼ˆ5ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2ï¼ˆ5ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†">Android 11 Display System V2ï¼ˆ5ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†</a><time datetime="2024-02-21T16:00:00.000Z" title="å‘è¡¨äº 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2ï¼ˆ4ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2ï¼ˆ4ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2ï¼ˆ4ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†">Android 11 Display System V2ï¼ˆ4ï¼‰ï¼šRockchip RK3399 - DRM gemåŸºç¡€çŸ¥è¯†</a><time datetime="2024-02-20T16:00:00.000Z" title="å‘è¡¨äº 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>