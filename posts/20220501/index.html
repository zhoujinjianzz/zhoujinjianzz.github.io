<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 10 Camera源码分析9：Camera startPreview流程 | zhoujinjian</title><meta name="keywords" content="Camera"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 10 Camera源码分析9：Camera startPreview流程">
<meta property="og:url" content="https://zhoujinjian.com/posts/20220501/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。 （">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.39.jpg">
<meta property="article:published_time" content="2022-04-30T21:01:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.932Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Camera">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.39.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20220501/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.39.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android 10 Camera源码分析9：Camera startPreview流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-04-30T21:01:00.000Z" title="发表于 2022-05-01 05:01:00">2022-05-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.932Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Camera/">Camera</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读各位前辈总结的资料 Android 10.0 &amp;&amp; Linux（Kernel 4.19）Rockchip平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Rockchip ©Android @Linux 版权所有），谢谢。</p>
<p>（==<strong>文章基于 Kernel-4.19</strong>==）&amp;&amp;（==<strong>文章基于 Android 10.0</strong>==）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhoujinjianzz">【zhoujinjian.com博客原图链接】</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.khadas.cn/edge-v">【开发板 Khadas Edge V】</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/khadas/linux/tree/khadas-edge-Qt">【开发板 Khadas Edge V Android 10.0 &amp;&amp; Linux（Kernel 4.19）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41944449/article/details/102609776">Android camera预览流程</a> </p>
<hr>
<p>==源码（部分）==：</p>
<p><strong>F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\</strong></p>
<p><em>F:\Khadas_Edge_Android_Q\frameworks\base\core\java\android\hardware\camera2\</em></p>
<p>==源码（部分）==：</p>
<hr>
<h2 id="（一）、configure-streams"><a href="#（一）、configure-streams" class="headerlink" title="（一）、configure_streams()"></a>（一）、configure_streams()</h2><h4 id="（1）、Stack-createCaptureSessionInternal"><a href="#（1）、Stack-createCaptureSessionInternal" class="headerlink" title="（1）、Stack::createCaptureSessionInternal()"></a>（1）、Stack::createCaptureSessionInternal()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>: configureStreamsChecked</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.hardware.camera2.impl.CameraDeviceImpl.createCaptureSessionInternal(CameraDeviceImpl.java:<span class="number">667</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.hardware.camera2.impl.CameraDeviceImpl.createCaptureSession(CameraDeviceImpl.java:<span class="number">514</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at com.android.camera.one.v2.camera2proxy.AndroidCameraDeviceProxy.createCaptureSession(AndroidCameraDeviceProxy.java:<span class="number">84</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at com.android.camera.one.v2.initialization.CaptureSessionCreator.createCaptureSession(CaptureSessionCreator.java:<span class="number">58</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at com.android.camera.one.v2.initialization.PreviewStarter.startPreview(PreviewStarter.java:<span class="number">83</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at com.android.camera.one.v2.initialization.GenericOneCameraImpl.startPreview(GenericOneCameraImpl.java:<span class="number">151</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at com.android.camera.CaptureModule$<span class="number">19.</span>onCameraOpened(CaptureModule.java:<span class="number">1564</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at com.android.camera.one.v2.Camera2OneCameraOpenerImpl$<span class="number">1.</span>onOpened(Camera2OneCameraOpenerImpl.java:<span class="number">180</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.hardware.camera2.impl.CameraDeviceImpl$<span class="number">1.</span>run(CameraDeviceImpl.java:<span class="number">146</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.os.Handler.handleCallback(Handler.java:<span class="number">883</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.os.Handler.dispatchMessage(Handler.java:<span class="number">100</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.os.Looper.loop(Looper.java:<span class="number">214</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.619</span>  <span class="number">1727</span>  <span class="number">1771</span> I CameraDevice-JV-<span class="number">0</span>:     at android.os.HandlerThread.run(HandlerThread.java:<span class="number">67</span>)</span><br></pre></td></tr></table></figure>



<h4 id="（2）、CameraDeviceImpl-createCaptureSessionInternal"><a href="#（2）、CameraDeviceImpl-createCaptureSessionInternal" class="headerlink" title="（2）、CameraDeviceImpl.createCaptureSessionInternal()"></a>（2）、CameraDeviceImpl.createCaptureSessionInternal()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java</span><br><span class="line">configureStreamsChecked(InputConfiguration inputConfig,</span><br><span class="line">            List&lt;OutputConfiguration&gt; outputs, <span class="keyword">int</span> operatingMode, CaptureRequest sessionParams)</span><br><span class="line">                    <span class="keyword">throws</span> CameraAccessException &#123;</span><br><span class="line">        ......</span><br><span class="line">        checkInputConfiguration(inputConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mInterfaceLock) &#123;</span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line">            <span class="comment">// Streams to create</span></span><br><span class="line">            HashSet&lt;OutputConfiguration&gt; addSet = <span class="keyword">new</span> HashSet&lt;OutputConfiguration&gt;(outputs);</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                waitUntilIdle();</span><br><span class="line"></span><br><span class="line">                mRemoteDevice.beginConfigure();</span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Add all new streams</span></span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;createStream&quot;</span>, <span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());                </span><br><span class="line">                <span class="keyword">for</span> (OutputConfiguration outConfig : outputs) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (addSet.contains(outConfig)) &#123;</span><br><span class="line">                        <span class="comment">/* 将会在这里创建并配置输出流，该流输出显示，</span></span><br><span class="line"><span class="comment">                         * 注意 outConfig 中有显示 surface</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        <span class="keyword">int</span> streamId = mRemoteDevice.createStream(outConfig);</span><br><span class="line">                        mConfiguredOutputs.put(streamId, outConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* 注意传递进来的方法参数，inputConfig为null，sessionParams为null */</span></span><br><span class="line">                <span class="keyword">if</span> (sessionParams != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mRemoteDevice.endConfigure(operatingMode, sessionParams.getNativeCopy());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">/* 上述只是保存配置，这里才会真正的设置到 HAL */</span></span><br><span class="line">                    mRemoteDevice.endConfigure(operatingMode, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                success = <span class="keyword">true</span>;</span><br><span class="line">            &#125; ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 07-07 11:03:48.621   334   544 V Camera3-Device: Camera 0: Creating new stream 0: 4096 x 3120, format 33, dataspace 146931712 rotation 0 consumer usage 0, isShared 0, physicalCameraId </p>
</blockquote>
<p>我们主要分析 mRemoteDevice.createStream(outConfig) 的操作，在这里，将会通过Binder将相应的配置信息传输到 CameraService 端的CameraDeviceClient。</p>
<h4 id="（3）、CameraDeviceClient-createStream"><a href="#（3）、CameraDeviceClient-createStream" class="headerlink" title="（3）、CameraDeviceClient::createStream()"></a>（3）、CameraDeviceClient::createStream()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">(<span class="meta">@NonNull</span> String cameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@NonNull</span> <span class="keyword">final</span> CameraDevice.StateCallback callback, <span class="meta">@Nullable</span> Handler handler)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CameraAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">        openCameraForUid(cameraId, callback, CameraDeviceImpl.checkAndWrapHandler(handler),</span><br><span class="line">                USE_CALLING_UID);</span><br><span class="line">    &#125;</span><br><span class="line">openCameraForUid-&gt;openCameraDeviceUserAsync</span><br><span class="line">    </span><br><span class="line"> binder::Status CameraDeviceClient::createStream(</span><br><span class="line">        <span class="keyword">const</span> hardware::camera2::params::OutputConfiguration &amp;outputConfiguration,</span><br><span class="line">        <span class="comment">/*out*/</span></span><br><span class="line">        int32_t* newStreamId) &#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line"></span><br><span class="line">    binder::Status res;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">icl</span><span class="params">(mBinderSerializationLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> std::vector&lt;sp&lt;IGraphicBufferProducer&gt;&gt;&amp; bufferProducers =</span><br><span class="line">            outputConfiguration.getGraphicBufferProducers();</span><br><span class="line">    size_t numBufferProducers = bufferProducers.size();</span><br><span class="line">    bool deferredConsumer = outputConfiguration.isDeferred();</span><br><span class="line">    bool isShared = outputConfiguration.isShared();</span><br><span class="line">    String8 physicalCameraId = String8(outputConfiguration.getPhysicalCameraId());</span><br><span class="line">    bool deferredConsumerOnly = deferredConsumer &amp;&amp; numBufferProducers == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    res = checkSurfaceTypeLocked(numBufferProducers, deferredConsumer,</span><br><span class="line">            outputConfiguration.getSurfaceType());</span><br><span class="line"></span><br><span class="line">    res = checkPhysicalCameraIdLocked(physicalCameraId);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;sp&lt;Surface&gt;&gt; surfaces;</span><br><span class="line">    std::vector&lt;sp&lt;IBinder&gt;&gt; binders;</span><br><span class="line">    status_t err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create stream for deferred surface case.</span></span><br><span class="line">    <span class="keyword">if</span> (deferredConsumerOnly) &#123;</span><br><span class="line">        <span class="keyword">return</span> createDeferredSurfaceStreamLocked(outputConfiguration, isShared, newStreamId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    OutputStreamInfo streamInfo;</span><br><span class="line">    bool isStreamInfoValid = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (auto&amp; bufferProducer : bufferProducers) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t create multiple streams for the same target surface</span></span><br><span class="line">        sp&lt;IBinder&gt; binder = IInterface::asBinder(bufferProducer);</span><br><span class="line">        ssize_t index = mStreamMap.indexOfKey(binder);</span><br><span class="line">        <span class="keyword">if</span> (index != NAME_NOT_FOUND) &#123;</span><br><span class="line">            String8 msg = String8::format(<span class="string">&quot;Camera %s: Surface already has a stream created for it &quot;</span></span><br><span class="line">                    <span class="string">&quot;(ID %zd)&quot;</span>, mCameraIdStr.string(), index);</span><br><span class="line">            ALOGW(<span class="string">&quot;%s: %s&quot;</span>, __FUNCTION__, msg.string());</span><br><span class="line">            <span class="keyword">return</span> STATUS_ERROR(CameraService::ERROR_ALREADY_EXISTS, msg.string());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp&lt;Surface&gt; surface;</span><br><span class="line">        res = createSurfaceFromGbp(streamInfo, isStreamInfoValid, surface, bufferProducer,</span><br><span class="line">                physicalCameraId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!res.isOk())</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isStreamInfoValid) &#123;</span><br><span class="line">            isStreamInfoValid = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        binders.push_back(IInterface::asBinder(bufferProducer));</span><br><span class="line">        surfaces.push_back(surface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> streamId = camera3::CAMERA3_STREAM_ID_INVALID;</span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt; surfaceIds;</span><br><span class="line">    bool isDepthCompositeStream = camera3::DepthCompositeStream::isDepthCompositeStream(surfaces[<span class="number">0</span>]);</span><br><span class="line">    bool isHeicCompisiteStream = camera3::HeicCompositeStream::isHeicCompositeStream(surfaces[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (isDepthCompositeStream || isHeicCompisiteStream) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = mDevice-&gt;createStream(surfaces, deferredConsumer, streamInfo.width,</span><br><span class="line">                streamInfo.height, streamInfo.format, streamInfo.dataSpace,</span><br><span class="line">                static_cast&lt;camera3_stream_rotation_t&gt;(outputConfiguration.getRotation()),</span><br><span class="line">                &amp;streamId, physicalCameraId, &amp;surfaceIds, outputConfiguration.getSurfaceSetID(),</span><br><span class="line">                isShared);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">       ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (auto&amp; binder : binders) &#123;</span><br><span class="line">            ALOGV(<span class="string">&quot;%s: mStreamMap add binder %p streamId %d, surfaceId %d&quot;</span>,</span><br><span class="line">                    __FUNCTION__, binder.get(), streamId, i);</span><br><span class="line">            mStreamMap.add(binder, StreamSurfaceId(streamId, surfaceIds[i]));</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mConfiguredOutputs.add(streamId, outputConfiguration);</span><br><span class="line">        mStreamInfoMap[streamId] = streamInfo;</span><br><span class="line"></span><br><span class="line">        ALOGV(<span class="string">&quot;%s: Camera %s: Successfully created a new stream ID %d for output surface&quot;</span></span><br><span class="line">                    <span class="string">&quot; (%d x %d) with format 0x%x.&quot;</span>,</span><br><span class="line">                  __FUNCTION__, mCameraIdStr.string(), streamId, streamInfo.width,</span><br><span class="line">                  streamInfo.height, streamInfo.format);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set transform flags to ensure preview to be rotated correctly.</span></span><br><span class="line">        res = setStreamTransformLocked(streamId);</span><br><span class="line"></span><br><span class="line">        *newStreamId = streamId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">Log:</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.666</span>   <span class="number">334</span>   <span class="number">544</span> V Camera3-Device: Camera <span class="number">0</span>: Created <span class="keyword">new</span> stream</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.666</span>   <span class="number">334</span>   <span class="number">544</span> V CameraDeviceClient: createStream: mStreamMap add binder <span class="number">0xe90162c0</span> streamId <span class="number">0</span>, surfaceId <span class="number">0</span></span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.666</span>   <span class="number">334</span>   <span class="number">544</span> V CameraDeviceClient: createStream: Camera <span class="number">0</span>: Successfully created a <span class="keyword">new</span> stream ID <span class="number">0</span> <span class="function"><span class="keyword">for</span> output <span class="title">surface</span> <span class="params">(<span class="number">4096</span> x <span class="number">3120</span>)</span> with format 0x21.</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">Stack Trace:</span></span><br><span class="line"><span class="function">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                      FILE:LINE</span></span><br><span class="line"><span class="function">  001034a5  android::Camera3Device::<span class="title">createStream</span><span class="params">(std::__1::vector&lt;android::sp&lt;android::Surface&gt;, std::__1::allocator&lt;android::sp&lt;android::Surface&gt; &gt; &gt; <span class="keyword">const</span>&amp;, bool, unsigned <span class="keyword">int</span>, unsigned <span class="keyword">int</span>, <span class="keyword">int</span>, android_dataspace_t, camera3_stream_rotation, <span class="keyword">int</span>*, android::String8 <span class="keyword">const</span>&amp;, std::__1::vector&lt;<span class="keyword">int</span>, std::__1::allocator&lt;<span class="keyword">int</span>&gt; &gt;*, <span class="keyword">int</span>, bool, unsigned <span class="keyword">long</span> <span class="keyword">long</span>)</span>+172  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:1758</span></span><br><span class="line"><span class="function">  000dcbd5  android::CameraDeviceClient::<span class="title">createStream</span><span class="params">(android::hardware::camera2::params::OutputConfiguration <span class="keyword">const</span>&amp;, <span class="keyword">int</span>*)</span>+1300                                                                                                                                                                                                                                          frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:977</span></span><br><span class="line"><span class="function">  000dd4c9  non-virtual thunk to android::CameraDeviceClient::<span class="title">createStream</span><span class="params">(android::hardware::camera2::params::OutputConfiguration <span class="keyword">const</span>&amp;, <span class="keyword">int</span>*)</span>+4                                                                                                                                                                                                                        aeabi_div0.c:?</span></span><br><span class="line"><span class="function">  00028509  android::hardware::camera2::BnCameraDeviceUser::<span class="title">onTransact</span><span class="params">(unsigned <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, unsigned <span class="keyword">int</span>)</span>+720                                                                                                                                                                                                                          out/soong/.intermediates/frameworks/av/camera/libcamera_client/android_arm_armv7-a-neon_cortex-a15_core_shared/gen/aidl/frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.cpp:1025</span></span><br><span class="line"><span class="function">  00032ed1  android::BBinder::<span class="title">transact</span><span class="params">(unsigned <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, unsigned <span class="keyword">int</span>)</span>+72                                                                                                                                                                                                                                                           frameworks/<span class="keyword">native</span>/libs/binder/Binder.cpp:134</span></span><br><span class="line"><span class="function">  0003b117  android::IPCThreadState::<span class="title">executeCommand</span><span class="params">(<span class="keyword">int</span>)</span>+770                                                                                                                                                                                                                                                                                                              frameworks/<span class="keyword">native</span>/libs/binder/IPCThreadState.cpp:1213</span></span><br><span class="line"><span class="function">  0003ad53  android::IPCThreadState::<span class="title">getAndExecuteCommand</span><span class="params">()</span>+98                                                                                                                                                                                                                                                                                                            frameworks/<span class="keyword">native</span>/libs/binder/IPCThreadState.cpp:514</span></span><br><span class="line"><span class="function">  0003b2ef  android::IPCThreadState::<span class="title">joinThreadPool</span><span class="params">(bool)</span>+38                                                                                                                                                                                                                                                                                                              frameworks/<span class="keyword">native</span>/libs/binder/IPCThreadState.cpp:594</span></span><br><span class="line"><span class="function">  00054665  android::PoolThread::<span class="title">threadLoop</span><span class="params">()</span>+12                                                                                                                                                                                                                                                                                                                          frameworks/<span class="keyword">native</span>/libs/binder/ProcessState.cpp:67</span></span><br><span class="line"><span class="function">  0000d8bf  android::Thread::<span class="title">_threadLoop</span><span class="params">(<span class="keyword">void</span>*)</span>+186                                                                                                                                                                                                                                                                                                                       system/core/libutils/Threads.cpp:746</span></span><br><span class="line"><span class="function">  000a6867  <span class="title">__pthread_start</span><span class="params">(<span class="keyword">void</span>*)</span>+20                                                                                                                                                                                                                                                                                                                                     bionic/libc/bionic/pthread_create.cpp:338</span></span><br></pre></td></tr></table></figure>

<p>上面的 mDevice-&gt;createStream() 将会调用到哪里呢？</p>
<p>CameraDeviceClient 类是继承模板类 Camera2ClientBase，看 mDevice 的定义，我们可以知道是 sp<CameraDeviceBase> mDevice，mDevice 的赋值是在模板类Camera2ClientBase 的构造函数中，mDevice = new Camera3Device(cameraId)，通过其构造函数可以知道 mDevice 指向 Camera3Device 实例对象。所以，mDevice-&gt;createStream() 将调用到 Camera3Device::createStream() 函数。</p>
<h4 id="（4）、Camera3Device-createStream"><a href="#（4）、Camera3Device-createStream" class="headerlink" title="（4）、Camera3Device::createStream()"></a>（4）、Camera3Device::createStream()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.<span class="function">cpp                                                                                                        <span class="keyword">status_t</span> <span class="title">Camera3Device::createStream</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;sp&lt;Surface&gt;&gt;&amp; consumers,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">bool</span> hasDeferredConsumer, <span class="keyword">uint32_t</span> width, <span class="keyword">uint32_t</span> height, <span class="keyword">int</span> format,</span></span></span><br><span class="line"><span class="function"><span class="params">        android_dataspace dataSpace, <span class="keyword">camera3_stream_rotation_t</span> rotation, <span class="keyword">int</span> *id,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> String8&amp; physicalCameraId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; *surfaceIds, <span class="keyword">int</span> streamSetId, <span class="keyword">bool</span> isShared, <span class="keyword">uint64_t</span> consumerUsage)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  </span><br><span class="line">    ALOGV(<span class="string">&quot;Camera %s: Creating new stream %d: %d x %d, format %d, dataspace %d rotation %d&quot;</span></span><br><span class="line">            <span class="string">&quot; consumer usage %&quot;</span> PRIu64 <span class="string">&quot;, isShared %d, physicalCameraId %s&quot;</span>, mId.<span class="built_in">string</span>(),</span><br><span class="line">            mNextStreamId, width, height, format, dataSpace, rotation, consumerUsage, isShared,</span><br><span class="line">            physicalCameraId.<span class="built_in">string</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* 创建 Camera3OutputStream 实例对象，注意第二个参数，它是 Surface，</span></span><br><span class="line"><span class="comment">         * 将保存在 Camera3OutputStream 的 mConsumer 成员 */</span></span><br><span class="line">        newStream = <span class="keyword">new</span> Camera3OutputStream(mNextStreamId, consumers[<span class="number">0</span>],</span><br><span class="line">                width, height, format, dataSpace, rotation,</span><br><span class="line">                mTimestampOffset, physicalCameraId, streamSetId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* newStream 实例对象保存到 mOutputStreams */</span></span><br><span class="line">    res = mOutputStreams.add(mNextStreamId, newStream);</span><br><span class="line"></span><br><span class="line">    mNeedConfig = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    ...      </span><br><span class="line">Log：</span><br></pre></td></tr></table></figure>

<p>我们回头看看 CameraDeviceImpl::configureStreamsChecked() 方法，在该方法中，通过 mRemoteDevice 操作影响到 CameraService，在 createStream() 之后，还将会调用 endConfigure() 操作</p>
<h4 id="（5）、CameraDeviceClient-endConfigure"><a href="#（5）、CameraDeviceClient-endConfigure" class="headerlink" title="（5）、CameraDeviceClient::endConfigure()"></a>（5）、CameraDeviceClient::endConfigure()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp</span><br><span class="line"><span class="function">binder::Status <span class="title">CameraDeviceClient::endConfigure</span><span class="params">(<span class="keyword">int</span> operatingMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">const</span> hardware::camera2::impl::CameraMetadataNative&amp; sessionParams)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* 和上述一样，将会调用到 Camera3Device::configureStreams() */</span></span><br><span class="line">    <span class="keyword">status_t</span> err = mDevice-&gt;configureStreams(sessionParams, operatingMode);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（6）、Camera3Device-HalInterface-configureStreams-gt-Stack-Trace"><a href="#（6）、Camera3Device-HalInterface-configureStreams-gt-Stack-Trace" class="headerlink" title="（6）、Camera3Device::HalInterface::configureStreams-&gt;Stack Trace"></a>（6）、Camera3Device::HalInterface::configureStreams-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                       FILE:LINE</span><br><span class="line">  <span class="number">001079b</span>f  android::Camera3Device::HalInterface::configureStreams(camera_metadata <span class="keyword">const</span>*, camera3_stream_configuration*, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;)+<span class="number">1622</span>  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">4341</span></span><br><span class="line">  <span class="number">00102b</span>f9  android::Camera3Device::configureStreamsLocked(<span class="keyword">int</span>, android::CameraMetadata <span class="keyword">const</span>&amp;, <span class="keyword">bool</span>)+<span class="number">836</span>                                                                                                  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">2901</span></span><br><span class="line">  <span class="number">00101</span>c01  android::Camera3Device::filterParamsAndConfigureLocked(android::CameraMetadata <span class="keyword">const</span>&amp;, <span class="keyword">int</span>)+<span class="number">136</span>                                                                                                frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">2054</span></span><br><span class="line">  <span class="number">00104359</span>  android::Camera3Device::configureStreams(android::CameraMetadata <span class="keyword">const</span>&amp;, <span class="keyword">int</span>)+<span class="number">124</span>                                                                                                              aeabi_div0.c:?</span><br><span class="line">  <span class="number">000</span>da883  android::CameraDeviceClient::endConfigure(<span class="keyword">int</span>, android::CameraMetadata <span class="keyword">const</span>&amp;)+<span class="number">310</span>                                                                                                             frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:<span class="number">491</span></span><br><span class="line">  <span class="number">000</span>dac21  non-<span class="keyword">virtual</span> thunk to android::CameraDeviceClient::endConfigure(<span class="keyword">int</span>, android::CameraMetadata <span class="keyword">const</span>&amp;)+<span class="number">4</span>                                                                                          aeabi_div0.c:?</span><br><span class="line">  <span class="number">0002842f</span>  android::hardware::camera2::BnCameraDeviceUser::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">502</span>                                                           out/soong/.intermediates/frameworks/av/camera/libcamera_client/android_arm_armv7-a-neon_cortex-a15_core_shared/gen/aidl/frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.cpp:<span class="number">956</span></span><br><span class="line">  <span class="number">00032</span>ed1  android::BBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">72</span>                                                                                            frameworks/native/libs/binder/Binder.cpp:<span class="number">134</span></span><br><span class="line">  <span class="number">0003b</span>117  android::IPCThreadState::executeCommand(<span class="keyword">int</span>)+<span class="number">770</span>                                                                                                                                               frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">1213</span></span><br><span class="line">  <span class="number">0003</span>ad53  android::IPCThreadState::getAndExecuteCommand()+<span class="number">98</span>                                                                                                                                             frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">514</span></span><br><span class="line">  <span class="number">0003b</span>2ef  android::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">38</span>                                                                                                                                               frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">594</span></span><br><span class="line">  <span class="number">00054665</span>  android::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                           frameworks/native/libs/binder/ProcessState.cpp:<span class="number">67</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                        system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                      bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                              bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>而在 Camera3Device::configureStreams() 中，最终又将是调用到 Camera3Device::configureStreamsLocked() 函数。而在 Camera3Device::configureStreamsLocked() 函数主要进行了以下操作：将 Camera3Device::createStream() 保存到 - - mOutputStreams 中的 stream 添加到 config.streams；<br>通过 mInterface-&gt;configureStreams(sessionBuffer, &amp;config, bufferSizes) 操作到HAL配置流；<br>通知上层，配置完成；</p>
<h4 id="（7）、Camera3Device-HalInterface-configureStreams"><a href="#（7）、Camera3Device-HalInterface-configureStreams" class="headerlink" title="（7）、Camera3Device::HalInterface::configureStreams()"></a>（7）、Camera3Device::HalInterface::configureStreams()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\device3\Camera3Device.cpp</span><br><span class="line">    </span><br><span class="line"><span class="keyword">status_t</span> Camera3Device::HalInterface::configureStreams(<span class="keyword">const</span> <span class="keyword">camera_metadata_t</span> *sessionParams,</span><br><span class="line">        camera3_stream_configuration *config, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint32_t</span>&gt;&amp; bufferSizes) &#123;</span><br><span class="line">    ATRACE_NAME(<span class="string">&quot;CameraHal::configureStreams&quot;</span>);</span><br><span class="line">    ......</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mHidlSession_3_3 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// We do; use v3.3 for the call</span></span><br><span class="line">        </span><br><span class="line">        CallStack <span class="built_in">stack</span>;</span><br><span class="line">        <span class="built_in">stack</span>.update();</span><br><span class="line">        <span class="built_in">stack</span>.<span class="built_in">log</span>(<span class="string">&quot;Camera3Device::configureStreams_3_3&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ALOGV(<span class="string">&quot;%s: v3.3 device found&quot;</span>, __FUNCTION__);</span><br><span class="line">        <span class="keyword">auto</span> err = mHidlSession_3_3-&gt;configureStreams_3_3(requestedConfiguration3_2,</span><br><span class="line">            [&amp;status, &amp;finalConfiguration]</span><br><span class="line">            (common::V1_0::Status s, <span class="keyword">const</span> device::V3_3::HalStreamConfiguration&amp; halConfiguration) &#123;</span><br><span class="line">                finalConfiguration = halConfiguration;</span><br><span class="line">                status = s;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!err.isOk()) &#123;</span><br><span class="line">            ALOGE(<span class="string">&quot;%s: Transaction error: %s&quot;</span>, __FUNCTION__, err.description().c_str());</span><br><span class="line">            <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述的 mInterface 变量是在 Camera3Device::initialize() 时，保存 HalInterface 实例对象的，所以，mInterface-&gt;configureStreams() 将调用到 Camera3Device::HalInterface::configureStreams()。</p>
<p>Camera3Device::HalInterface::configureStreams() 将stream config转换为 HIDL 接口使用的之后，将按照 HAL 版本调用不同的接口函数，下面我们以 HAL 3.3 为例进行跟踪，将调用 mHidlSession_3_3-&gt;configureStreams_3_3()。注：mHidlSession_3_3 是在 HalInterface 构造函数中赋值的，而 mHidlSession_3_3 是 ICameraDeviceSession转换得来的，ICameraDeviceSession 则是Camera3Device::initialize() 中通过 manager-&gt;openSession() 获取的。</p>
<p>在上述的 mHidlSession_3_3-&gt;configureStreams_3_3() 调用，将会调用到 BpHwCameraDeviceSession::configureStreams_3_3() [android/out/soong/.intermediates/hardware/interfaces/camera/device/3.3/android.hardware.camera.device@3.3_genc++/gen/android/hardware/camera/device/3.3/CameraDeviceSessionAll.cpp]，最终调用到 CameraProvider 中的 CameraDeviceSession::configureStreams_3_3()函数。通过HIDL配置流操作进入 CameraProvider。</p>
<h4 id="（8）、Camera3HAL-configure-streams-gt-Stack-Trace"><a href="#（8）、Camera3HAL-configure-streams-gt-Stack-Trace" class="headerlink" title="（8）、Camera3HAL::configure_streams()-&gt;Stack Trace"></a>（8）、Camera3HAL::configure_streams()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace: configure_streams()</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                        FILE:LINE</span><br><span class="line">  <span class="number">0006</span>d35b  android::camera2::Camera3HAL::configure_streams(camera3_stream_configuration*)+<span class="number">162</span>                                                                                                                                                                                                                                                                              hardware/rockchip/camera/AAL/Camera3HAL.cpp:<span class="number">250</span></span><br><span class="line">  <span class="number">0006</span>daa9  android::camera2::hal_dev_configure_streams(camera3_device <span class="keyword">const</span>*, camera3_stream_configuration*)+<span class="number">92</span>                                                                                                                                                                                                                                                            hardware/rockchip/camera/AAL/Camera3HAL.cpp:<span class="number">60</span></span><br><span class="line">  <span class="number">00004711</span>  android::hardware::camera::device::V3_3::implementation::CameraDeviceSession::configureStreams_3_3(android::hardware::camera::device::V3_2::StreamConfiguration <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, android::hardware::camera::device::V3_3::HalStreamConfiguration <span class="keyword">const</span>&amp;)&gt;)+<span class="number">264</span>                                 hardware/interfaces/camera/device/<span class="number">3.3</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">88</span></span><br><span class="line">  <span class="number">00004</span>d03  android::hardware::camera::device::V3_3::implementation::CameraDeviceSession::TrampolineSessionInterface_3_3::configureStreams_3_3(android::hardware::camera::device::V3_2::StreamConfiguration <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, android::hardware::camera::device::V3_3::HalStreamConfiguration <span class="keyword">const</span>&amp;)&gt;)+<span class="number">66</span>  hardware/interfaces/camera/device/<span class="number">3.3</span>/<span class="keyword">default</span>/CameraDeviceSession.h:<span class="number">123</span></span><br><span class="line">  <span class="number">0000b</span>313  android::hardware::camera::device::V3_3::BnHwCameraDeviceSession::_hidl_configureStreams_3_3(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">222</span>                                                                                                     out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.3</span>/android.hardware.camera.device@<span class="number">3.3</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.3</span>/CameraDeviceSessionAll.cpp:<span class="number">414</span></span><br><span class="line">  <span class="number">0000b</span>749  android::hardware::camera::device::V3_3::BnHwCameraDeviceSession::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">640</span>                                                                                                                               out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.3</span>/android.hardware.camera.device@<span class="number">3.3</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.3</span>/CameraDeviceSessionAll.cpp:<span class="number">578</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                                                                                                                      system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                                                                                                                          system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                                                                                                                   system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                                                                                                                      system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  <span class="number">00076f</span>0d  android::hardware::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                                                                                                                  system/libhwbinder/ProcessState.cpp:<span class="number">61</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                                                                                                                         system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                                                                                                                       bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                                                                                                                                                                                               bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="（二）、construct-default-request-settings"><a href="#（二）、construct-default-request-settings" class="headerlink" title="（二）、construct_default_request_settings()"></a>（二）、construct_default_request_settings()</h2><h4 id="（1）、Stack-createCaptureRequest"><a href="#（1）、Stack-createCaptureRequest" class="headerlink" title="（1）、Stack::createCaptureRequest()"></a>（1）、Stack::createCaptureRequest()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.923</span>  <span class="number">1727</span>  <span class="number">1727</span> V CAM_CameraAppUI: onPreviewStarted</span><br><span class="line"></span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>: createDefaultRequest</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at android.hardware.camera2.impl.CameraDeviceImpl.createCaptureRequest(CameraDeviceImpl.java:<span class="number">781</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at com.android.camera.one.v2.camera2proxy.AndroidCameraDeviceProxy.createCaptureRequest(AndroidCameraDeviceProxy.java:<span class="number">90</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at com.android.camera.one.v2.camera2proxy.CameraDeviceRequestBuilderFactory.create(CameraDeviceRequestBuilderFactory.java:<span class="number">38</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at com.android.camera.one.v2.core.RequestTemplate.create(RequestTemplate.java:<span class="number">104</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at com.android.camera.one.v2.core.RequestTemplate.create(RequestTemplate.java:<span class="number">104</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at com.android.camera.one.v2.commands.PreviewCommand.run(PreviewCommand.java:<span class="number">56</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at com.android.camera.one.v2.commands.CameraCommandExecutor$CommandRunnable.run(CameraCommandExecutor.java:<span class="number">52</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">462</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1167</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">641</span>)</span><br><span class="line"><span class="number">07</span><span class="number">-07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">48.924</span>  <span class="number">1727</span>  <span class="number">1826</span> I CameraDevice-JV<span class="number">-0</span>:     at java.lang.Thread.run(Thread.java:<span class="number">919</span>)</span><br></pre></td></tr></table></figure>


<h4 id="（2）、CameraDeviceImpl-createCaptureRequest"><a href="#（2）、CameraDeviceImpl-createCaptureRequest" class="headerlink" title="（2）、CameraDeviceImpl.createCaptureRequest()"></a>（2）、CameraDeviceImpl.createCaptureRequest()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\base\core\java\android\hardware\camera2\impl\CameraDeviceImpl.java</span><br><span class="line">   @Override</span><br><span class="line">    <span class="keyword">public</span> CaptureRequest.<span class="function">Builder <span class="title">createCaptureRequest</span><span class="params">(<span class="keyword">int</span> templateType)</span></span></span><br><span class="line"><span class="function">            throws CameraAccessException </span>&#123;</span><br><span class="line">        synchronized(mInterfaceLock) &#123;</span><br><span class="line">            checkIfCameraClosedOrInError();</span><br><span class="line">    </span><br><span class="line">            CameraMetadataNative templatedRequest = null;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/* 一样的，也是通过 mRemoteDevice 代理操作 CameraDeviceClient，</span></span><br><span class="line"><span class="comment">             * 将调用到 CameraDeviceClient::createDefaultRequest() */</span></span><br><span class="line">            templatedRequest = mRemoteDevice.createDefaultRequest(templateType);</span><br><span class="line">    </span><br><span class="line">            ...</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">return</span> builder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>



<h4 id="（3）、CameraDeviceClient-createDefaultRequest"><a href="#（3）、CameraDeviceClient-createDefaultRequest" class="headerlink" title="（3）、CameraDeviceClient::createDefaultRequest()"></a>（3）、CameraDeviceClient::createDefaultRequest()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp</span><br><span class="line"><span class="function">binder::Status <span class="title">CameraDeviceClient::createDefaultRequest</span><span class="params">(<span class="keyword">int</span> templateId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="comment">/*out*/</span></span></span></span><br><span class="line"><span class="function"><span class="params">        hardware::camera2::impl::CameraMetadataNative* request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    CameraMetadata metadata;</span><br><span class="line">    <span class="keyword">status_t</span> err; </span><br><span class="line">    <span class="comment">/* 与 createStream() 相同，将会调用到 Camera3Device::createDefaultRequest() */</span></span><br><span class="line">    <span class="keyword">if</span> ( (err = mDevice-&gt;createDefaultRequest(templateId, &amp;metadata) ) == OK &amp;&amp;                                                                                                                              </span><br><span class="line">        request != <span class="literal">NULL</span>) &#123;</span><br><span class="line"> </span><br><span class="line">        request-&gt;swap(metadata);</span><br><span class="line">    &#125;</span><br><span class="line">    ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（4）、Camera3Device-createDefaultRequest"><a href="#（4）、Camera3Device-createDefaultRequest" class="headerlink" title="（4）、Camera3Device::createDefaultRequest()"></a>（4）、Camera3Device::createDefaultRequest()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\common\CameraProviderManager.cpp</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3Device::createDefaultRequest</span><span class="params">(<span class="keyword">int</span> templateId,</span></span></span><br><span class="line"><span class="function"><span class="params">        CameraMetadata *request)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">camera_metadata_t</span> *rawRequest;</span><br><span class="line">    <span class="comment">/* 又将通过 mInterface 调用到 CameraProvider*/</span></span><br><span class="line">    <span class="keyword">status_t</span> res = mInterface-&gt;constructDefaultRequestSettings(</span><br><span class="line">            (<span class="keyword">camera3_request_template_t</span>) templateId, &amp;rawRequest);</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">/* 保存这个类型请求的信息 */</span></span><br><span class="line">        set_camera_metadata_vendor_id(rawRequest, mVendorTagId);</span><br><span class="line">        mRequestTemplateCache[templateId].acquire(rawRequest);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（5）、Camera3Device-createDefaultRequest-gt-Stack-Trace"><a href="#（5）、Camera3Device-createDefaultRequest-gt-Stack-Trace" class="headerlink" title="（5）、Camera3Device::createDefaultRequest()-&gt;Stack Trace"></a>（5）、Camera3Device::createDefaultRequest()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                               FILE:LINE</span><br><span class="line">  <span class="number">00104575</span>  android::Camera3Device::createDefaultRequest(<span class="keyword">int</span>, android::CameraMetadata*)+<span class="number">208</span>                                                        frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">2112</span></span><br><span class="line">  <span class="number">000</span>de733  android::CameraDeviceClient::createDefaultRequest(<span class="keyword">int</span>, android::CameraMetadata*)+<span class="number">206</span>                                                   frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:<span class="number">1535</span></span><br><span class="line">  <span class="number">000</span>de8a1  non-<span class="keyword">virtual</span> thunk to android::CameraDeviceClient::createDefaultRequest(<span class="keyword">int</span>, android::CameraMetadata*)+<span class="number">4</span>                                aeabi_div0.c:?</span><br><span class="line">  <span class="number">0002863f</span>  android::hardware::camera2::BnCameraDeviceUser::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">1030</span>  out/soong/.intermediates/frameworks/av/camera/libcamera_client/android_arm_armv7-a-neon_cortex-a15_core_shared/gen/aidl/frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.cpp:<span class="number">1108</span></span><br><span class="line">  <span class="number">00032</span>ed1  android::BBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">72</span>                                    frameworks/native/libs/binder/Binder.cpp:<span class="number">134</span></span><br><span class="line">  <span class="number">0003b</span>117  android::IPCThreadState::executeCommand(<span class="keyword">int</span>)+<span class="number">770</span>                                                                                       frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">1213</span></span><br><span class="line">  <span class="number">0003</span>ad53  android::IPCThreadState::getAndExecuteCommand()+<span class="number">98</span>                                                                                     frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">514</span></span><br><span class="line">  <span class="number">0003b</span>2ef  android::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">38</span>                                                                                       frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">594</span></span><br><span class="line">  <span class="number">00054665</span>  android::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                   frameworks/native/libs/binder/ProcessState.cpp:<span class="number">67</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                              bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                      bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br></pre></td></tr></table></figure>

<h4 id="（6）、Camera3HAL-construct-default-request-settings-gt-Stack-Trace"><a href="#（6）、Camera3HAL-construct-default-request-settings-gt-Stack-Trace" class="headerlink" title="（6）、Camera3HAL::construct_default_request_settings()-&gt;Stack Trace"></a>（6）、Camera3HAL::construct_default_request_settings()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                   FILE:LINE</span><br><span class="line">  <span class="number">0006</span>d665  android::camera2::Camera3HAL::construct_default_request_settings(<span class="keyword">int</span>)+<span class="number">92</span>                                                                                                                                                                                                                                                                   hardware/rockchip/camera/AAL/Camera3HAL.cpp:<span class="number">295</span></span><br><span class="line">  <span class="number">0006</span>dc15  android::camera2::hal_dev_construct_default_request_settings(camera3_device <span class="keyword">const</span>*, <span class="keyword">int</span>)+<span class="number">92</span>                                                                                                                                                                                                                                                hardware/rockchip/camera/AAL/Camera3HAL.cpp:<span class="number">76</span></span><br><span class="line">  <span class="number">00019</span>c27  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::constructDefaultRequestSettingsRaw(<span class="keyword">int</span>, android::hardware::hidl_vec&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;*)+<span class="number">110</span>                                                                                                                                                                     hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">847</span></span><br><span class="line">  <span class="number">00019b</span>67  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::constructDefaultRequestSettings(android::hardware::camera::device::V3_2::RequestTemplate, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, android::hardware::hidl_vec&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; <span class="keyword">const</span>&amp;)&gt;)+<span class="number">50</span>                                  hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">837</span></span><br><span class="line">  <span class="number">000049b</span>f  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::TrampolineSessionInterface_3_2::constructDefaultRequestSettings(android::hardware::camera::device::V3_2::RequestTemplate, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, android::hardware::hidl_vec&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; <span class="keyword">const</span>&amp;)&gt;)+<span class="number">66</span>  hardware/interfaces/camera/device/<span class="number">3.3</span>/<span class="keyword">default</span>/CameraDeviceSession.h:<span class="number">88</span></span><br><span class="line">  <span class="number">0001f</span>431  android::hardware::camera::device::V3_2::BnHwCameraDeviceSession::_hidl_constructDefaultRequestSettings(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">200</span>                                                                     out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceSessionAll.cpp:<span class="number">839</span></span><br><span class="line">  <span class="number">0000b</span>655  android::hardware::camera::device::V3_3::BnHwCameraDeviceSession::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">396</span>                                                                                                          out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.3</span>/android.hardware.camera.device@<span class="number">3.3</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.3</span>/CameraDeviceSessionAll.cpp:<span class="number">501</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                                                                                                 system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                                                                                                     system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                                                                                              system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                                                                                                 system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  v------&gt;  <span class="keyword">int</span> android::hardware::defaultPassthroughServiceImplementation&lt;android::hardware::camera::provider::V2_4::ICameraProvider&gt;(<span class="built_in">std</span>::__1::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::__1::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>)                                                                                                     system/libhidl/transport/include/hidl/LegacySupport.h:<span class="number">85</span></span><br><span class="line">  <span class="number">000010b</span>9  main+<span class="number">116</span>                                                                                                                                                                                                                                                                                                                                   hardware/interfaces/camera/provider/<span class="number">2.4</span>/<span class="keyword">default</span>/service.cpp:<span class="number">49</span></span><br><span class="line">  <span class="number">00059127</span>  __libc_init+<span class="number">66</span>                                                                                                                                                                                                                                                                                                                             bionic/libc/bionic/libc_init_dynamic.cpp:<span class="number">136</span></span><br><span class="line">  <span class="number">0000102f</span>  _start_main+<span class="number">38</span>                                                                                                                                                                                                                                                                                                                             bionic/libc/arch-common/bionic/crtbegin.c:<span class="number">45</span></span><br><span class="line">  <span class="number">00004456</span>  &lt;unknown&gt;                                                                                                                                                                                                                                                                                                                                  &lt;anonymous:ec7ce000&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="（三）、process-capture-request"><a href="#（三）、process-capture-request" class="headerlink" title="（三）、process_capture_request()"></a>（三）、process_capture_request()</h2><h4 id="1-、ICameraDeviceUserWrapper-submitRequestList"><a href="#1-、ICameraDeviceUserWrapper-submitRequestList" class="headerlink" title="(1)、ICameraDeviceUserWrapper.submitRequestList()"></a>(1)、ICameraDeviceUserWrapper.submitRequestList()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper: submitRequestList</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at android.hardware.camera2.impl.ICameraDeviceUserWrapper.submitRequestList(ICameraDeviceUserWrapper.java:<span class="number">88</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at android.hardware.camera2.impl.CameraDeviceImpl.submitCaptureRequest(CameraDeviceImpl.java:<span class="number">1074</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at android.hardware.camera2.impl.CameraDeviceImpl.setRepeatingBurst(CameraDeviceImpl.java:<span class="number">1127</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at android.hardware.camera2.impl.CameraCaptureSessionImpl.setRepeatingBurst(CameraCaptureSessionImpl.java:<span class="number">352</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at com.android.camera.one.v2.camera2proxy.AndroidCameraCaptureSessionProxy.setRepeatingBurst(AndroidCameraCaptureSessionProxy.java:<span class="number">129</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at com.android.camera.one.v2.core.TagDispatchCaptureSession.submitRequest(TagDispatchCaptureSession.java:<span class="number">154</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at com.android.camera.one.v2.core.FrameServerImpl$Session.submitRequest(FrameServerImpl.java:<span class="number">58</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at com.android.camera.one.v2.commands.PreviewCommand.run(PreviewCommand.java:<span class="number">57</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at com.android.camera.one.v2.commands.CameraCommandExecutor$CommandRunnable.run(CameraCommandExecutor.java:<span class="number">52</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:<span class="number">462</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at java.util.concurrent.FutureTask.run(FutureTask.java:<span class="number">266</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1167</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">641</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">07</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">49.003</span>  <span class="number">1727</span>  <span class="number">1826</span> I ICameraDeviceUserWrapper:     at java.lang.Thread.run(Thread.java:<span class="number">919</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-、ICameraDeviceUserWrapper-submitRequestList"><a href="#2-、ICameraDeviceUserWrapper-submitRequestList" class="headerlink" title="(2)、ICameraDeviceUserWrapper.submitRequestList()"></a>(2)、ICameraDeviceUserWrapper.submitRequestList()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\base\core\java\android\hardware\camera2\impl\ICameraDeviceUserWrapper.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ICameraDeviceUserWrapper</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SubmitInfo <span class="title">submitRequest</span><span class="params">(CaptureRequest request, <span class="keyword">boolean</span> streaming)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CameraAccessException  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/* 调用到 CameraService 的 CameraDeviceClient */</span></span><br><span class="line">            <span class="keyword">return</span> mRemoteDevice.submitRequest(request, streaming);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            CameraManager.throwAsPublicException(t);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Unexpected exception&quot;</span>, t);                                                                                                                              </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-、Camera3Device-RequestThread-unpauseForNewRequests-gt-Stack-Trace"><a href="#3-、Camera3Device-RequestThread-unpauseForNewRequests-gt-Stack-Trace" class="headerlink" title="(3)、Camera3Device::RequestThread::unpauseForNewRequests() -&gt;Stack Trace"></a>(3)、Camera3Device::RequestThread::unpauseForNewRequests() -&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 FILE:LINE</span><br><span class="line">  <span class="number">0010</span>c575  android::Camera3Device::RequestThread::unpauseForNewRequests()+<span class="number">64</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">6218</span></span><br><span class="line">  <span class="number">000f</span>ebc3  android::Camera3Device::RequestThread::queueRequestList(android::List&lt;android::sp&lt;android::Camera3Device::CaptureRequest&gt; &gt;&amp;, <span class="keyword">long</span> <span class="keyword">long</span>*)+<span class="number">198</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">4992</span></span><br><span class="line">  <span class="number">000f</span>e8bd  android::Camera3Device::submitRequestsHelper(android::List&lt;android::List&lt;android::CameraDeviceBase::PhysicalCameraSettings&gt; <span class="keyword">const</span>&gt; <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::<span class="built_in">list</span>&lt;<span class="built_in">std</span>::__1::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt;, <span class="built_in">std</span>::__1::hash&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::equal_to&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">pair</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; &gt; &gt; &gt; <span class="keyword">const</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt;, <span class="built_in">std</span>::__1::hash&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::equal_to&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">pair</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; &gt; &gt; &gt; <span class="keyword">const</span>&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">bool</span>, <span class="keyword">long</span> <span class="keyword">long</span>*)+<span class="number">248</span>  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">967</span></span><br><span class="line">  <span class="number">001019</span>d5  android::Camera3Device::captureList(android::List&lt;android::List&lt;android::CameraDeviceBase::PhysicalCameraSettings&gt; <span class="keyword">const</span>&gt; <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::<span class="built_in">list</span>&lt;<span class="built_in">std</span>::__1::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt;, <span class="built_in">std</span>::__1::hash&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::equal_to&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">pair</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; &gt; &gt; &gt; <span class="keyword">const</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt;, <span class="built_in">std</span>::__1::hash&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::equal_to&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">pair</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; &gt; &gt; &gt; <span class="keyword">const</span>&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">long</span> <span class="keyword">long</span>*)+<span class="number">52</span>                  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1523</span></span><br><span class="line">  <span class="number">000</span>d9e69  android::CameraDeviceClient::submitRequestList(<span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;android::hardware::camera2::CaptureRequest, <span class="built_in">std</span>::__1::allocator&lt;android::hardware::camera2::CaptureRequest&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">bool</span>, android::hardware::camera2::utils::SubmitInfo*)+<span class="number">3432</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:<span class="number">405</span></span><br><span class="line">  <span class="number">000</span>da42b  non-<span class="keyword">virtual</span> thunk to android::CameraDeviceClient::submitRequestList(<span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;android::hardware::camera2::CaptureRequest, <span class="built_in">std</span>::__1::allocator&lt;android::hardware::camera2::CaptureRequest&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">bool</span>, android::hardware::camera2::utils::SubmitInfo*)+<span class="number">14</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      aeabi_div0.c:?</span><br><span class="line">  <span class="number">00028385</span>  android::hardware::camera2::BnCameraDeviceUser::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">332</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     out/soong/.intermediates/frameworks/av/camera/libcamera_client/android_arm_armv7-a-neon_cortex-a15_core_shared/gen/aidl/frameworks/av/camera/aidl/android/hardware/camera2/ICameraDeviceUser.cpp:<span class="number">884</span></span><br><span class="line">  <span class="number">00032</span>ed1  android::BBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::Parcel <span class="keyword">const</span>&amp;, android::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">72</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      frameworks/native/libs/binder/Binder.cpp:<span class="number">134</span></span><br><span class="line">  <span class="number">0003b</span>117  android::IPCThreadState::executeCommand(<span class="keyword">int</span>)+<span class="number">770</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">1213</span></span><br><span class="line">  <span class="number">0003</span>ad53  android::IPCThreadState::getAndExecuteCommand()+<span class="number">98</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">514</span></span><br><span class="line">  <span class="number">0003b</span>2ef  android::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">38</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         frameworks/native/libs/binder/IPCThreadState.cpp:<span class="number">594</span></span><br><span class="line">  <span class="number">00054665</span>  android::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     frameworks/native/libs/binder/ProcessState.cpp:<span class="number">67</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>Camera3Device::RequestThread::threadLoop()中waitForNextRequestBatch();在等待请求，mRequestSignal.signal唤醒线程后继续运行。</p>
<h4 id="4-、Camera3Device-HalInterface-processBatchCaptureRequest-gt-Stack-Trace"><a href="#4-、Camera3Device-HalInterface-processBatchCaptureRequest-gt-Stack-Trace" class="headerlink" title="(4)、Camera3Device::HalInterface::processBatchCaptureRequest-&gt;Stack Trace"></a>(4)、Camera3Device::HalInterface::processBatchCaptureRequest-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                            FILE:LINE</span><br><span class="line">  <span class="number">0010b</span>155  android::Camera3Device::HalInterface::processBatchCaptureRequests(<span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;camera3_capture_request*, <span class="built_in">std</span>::__1::allocator&lt;camera3_capture_request*&gt; &gt;&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>*)+<span class="number">1296</span>  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">4685</span></span><br><span class="line">  <span class="number">0010</span>cac9  android::Camera3Device::RequestThread::sendRequestsBatch()+<span class="number">264</span>                                                                                                                      frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">5232</span></span><br><span class="line">  <span class="number">0010</span>db51  android::Camera3Device::RequestThread::threadLoop()+<span class="number">664</span>                                                                                                                             frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">5526</span></span><br><span class="line">  <span class="number">0000</span>d945  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">320</span>                                                                                                                                             system/core/libutils/Threads.cpp:<span class="number">749</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                           bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                   bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-、Camera3HAL-process-capture-request-gt-Stack-Trace"><a href="#5-、Camera3HAL-process-capture-request-gt-Stack-Trace" class="headerlink" title="(5)、Camera3HAL::process_capture_request()-&gt;Stack Trace"></a>(5)、Camera3HAL::process_capture_request()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                                                                                 FILE:LINE</span><br><span class="line">  <span class="number">0006</span>d6f3  android::camera2::Camera3HAL::process_capture_request(camera3_capture_request*)+<span class="number">86</span>                                                                                                                                                                                                                                                                                                                                       hardware/rockchip/camera/AAL/Camera3HAL.cpp:<span class="number">323</span></span><br><span class="line">  <span class="number">0006</span>dd7d  android::camera2::hal_dev_process_capture_request(camera3_device <span class="keyword">const</span>*, camera3_capture_request*)+<span class="number">92</span>                                                                                                                                                                                                                                                                                                                    hardware/rockchip/camera/AAL/Camera3HAL.cpp:<span class="number">93</span></span><br><span class="line">  <span class="number">0001b</span>4bb  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::processOneCaptureRequest(android::hardware::camera::device::V3_2::CaptureRequest <span class="keyword">const</span>&amp;)+<span class="number">1286</span>                                                                                                                                                                                                                                              hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">1258</span></span><br><span class="line">  <span class="number">0001</span>af49  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::processCaptureRequest(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureRequest&gt; <span class="keyword">const</span>&amp;, android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::BufferCache&gt; <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, <span class="keyword">unsigned</span> <span class="keyword">int</span>)&gt;)+<span class="number">52</span>                                  hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">1146</span></span><br><span class="line">  <span class="number">00004</span>aa5  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::TrampolineSessionInterface_3_2::processCaptureRequest(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureRequest&gt; <span class="keyword">const</span>&amp;, android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::BufferCache&gt; <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::camera::common::V1_0::Status, <span class="keyword">unsigned</span> <span class="keyword">int</span>)&gt;)+<span class="number">72</span>  hardware/interfaces/camera/device/<span class="number">3.3</span>/<span class="keyword">default</span>/CameraDeviceSession.h:<span class="number">100</span></span><br><span class="line">  <span class="number">0001f</span>8b5  android::hardware::camera::device::V3_2::BnHwCameraDeviceSession::_hidl_processCaptureRequest(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">348</span>                                                                                                                                                             out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceSessionAll.cpp:<span class="number">1055</span></span><br><span class="line">  <span class="number">0000b</span>699  android::hardware::camera::device::V3_3::BnHwCameraDeviceSession::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">464</span>                                                                                                                                                                                        out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.3</span>/android.hardware.camera.device@<span class="number">3.3</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.3</span>/CameraDeviceSessionAll.cpp:<span class="number">523</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                                                                                                                                                                               system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                                                                                                                                                                                   system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                                                                                                                                                                            system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                                                                                                                                                                               system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  v------&gt;  <span class="keyword">int</span> android::hardware::defaultPassthroughServiceImplementation&lt;android::hardware::camera::provider::V2_4::ICameraProvider&gt;(<span class="built_in">std</span>::__1::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::__1::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>)                                                                                                                                                                                   system/libhidl/transport/include/hidl/LegacySupport.h:<span class="number">85</span></span><br><span class="line">  <span class="number">000010b</span>9  main+<span class="number">116</span>                                                                                                                                                                                                                                                                                                                                                                                                                 hardware/interfaces/camera/provider/<span class="number">2.4</span>/<span class="keyword">default</span>/service.cpp:<span class="number">49</span></span><br><span class="line">  <span class="number">00059127</span>  __libc_init+<span class="number">66</span>                                                                                                                                                                                                                                                                                                                                                                                                           bionic/libc/bionic/libc_init_dynamic.cpp:<span class="number">136</span></span><br><span class="line">  <span class="number">0000102f</span>  _start_main+<span class="number">38</span>                                                                                                                                                                                                                                                                                                                                                                                                           bionic/libc/arch-common/bionic/crtbegin.c:<span class="number">45</span></span><br><span class="line">  <span class="number">00004456</span>  &lt;unknown&gt;                                                                                                                                                                                                                                                                                                                                                                                                                &lt;anonymous:ec7ce000&gt;</span><br></pre></td></tr></table></figure>

<h2 id="四-、processCaptureResult"><a href="#四-、processCaptureResult" class="headerlink" title="(四)、processCaptureResult()"></a>(四)、processCaptureResult()</h2><h4 id="1-、CameraDeviceSession-ResultBatcher-invokeProcessCaptureResultCallback-gt-Stack-Trace"><a href="#1-、CameraDeviceSession-ResultBatcher-invokeProcessCaptureResultCallback-gt-Stack-Trace" class="headerlink" title="(1)、CameraDeviceSession::ResultBatcher::invokeProcessCaptureResultCallback()-&gt;Stack Trace"></a>(1)、CameraDeviceSession::ResultBatcher::invokeProcessCaptureResultCallback()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                         FILE:LINE</span><br><span class="line">  <span class="number">00018b</span>5d  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::ResultBatcher::invokeProcessCaptureResultCallback(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt;&amp;, <span class="keyword">bool</span>)+<span class="number">316</span>  hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">748</span></span><br><span class="line">  <span class="number">000195</span>a5  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::ResultBatcher::processOneCaptureResult(android::hardware::camera::device::V3_2::CaptureResult&amp;)+<span class="number">64</span>                                                 hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">763</span></span><br><span class="line">  <span class="number">00019735</span>  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::ResultBatcher::processCaptureResult(android::hardware::camera::device::V3_2::CaptureResult&amp;)+<span class="number">100</span>                                                   hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">772</span></span><br><span class="line">  <span class="number">00016641</span>  android::hardware::camera::device::V3_2::implementation::CameraDeviceSession::sProcessCaptureResult(camera3_callback_ops <span class="keyword">const</span>*, camera3_capture_result <span class="keyword">const</span>*)+<span class="number">160</span>                                                              hardware/interfaces/camera/device/<span class="number">3.2</span>/<span class="keyword">default</span>/CameraDeviceSession.cpp:<span class="number">1584</span></span><br><span class="line">  <span class="number">000741e9</span>  android::camera2::ResultProcessor::returnPendingBuffers(android::camera2::ResultProcessor::RequestState_t*)+<span class="number">484</span>                                                                                                                  hardware/rockchip/camera/AAL/ResultProcessor.cpp:<span class="number">477</span></span><br><span class="line">  <span class="number">00073</span>d1f  android::camera2::ResultProcessor::handleBufferDone(android::camera2::ResultProcessor::Message&amp;)+<span class="number">326</span>                                                                                                                             hardware/rockchip/camera/AAL/ResultProcessor.cpp:<span class="number">420</span></span><br><span class="line">  <span class="number">0007357b</span>  android::camera2::ResultProcessor::messageThreadLoop()+<span class="number">198</span>                                                                                                                                                                       hardware/rockchip/camera/AAL/ResultProcessor.cpp:<span class="number">159</span></span><br><span class="line">  <span class="number">0008f</span>2e1  android::camera2::MessageThread::threadLoop(<span class="keyword">void</span>*)+<span class="number">8</span>                                                                                                                                                                             hardware/rockchip/camera/common/MessageThread.h:<span class="number">66</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                        bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                                                                bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-、Camera3Device-processCaptureResult-gt-Stack-Trace"><a href="#2-、Camera3Device-processCaptureResult-gt-Stack-Trace" class="headerlink" title="(2)、Camera3Device::processCaptureResult()-&gt;Stack Trace"></a>(2)、Camera3Device::processCaptureResult()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                      FILE:LINE</span><br><span class="line">  <span class="number">00100f</span>15  android::Camera3Device::processCaptureResult(camera3_capture_result <span class="keyword">const</span>*)+<span class="number">84</span>                                                                                                                                                                                frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">3625</span></span><br><span class="line">  <span class="number">001006f</span>5  android::Camera3Device::processOneCaptureResultLocked(android::hardware::camera::device::V3_2::CaptureResult <span class="keyword">const</span>&amp;, android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_4::PhysicalCameraMetadata&gt;)+<span class="number">1064</span>                                       frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1454</span></span><br><span class="line">  <span class="number">001009</span>dd  android::Camera3Device::processCaptureResult(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt; <span class="keyword">const</span>&amp;)+<span class="number">224</span>                                                                                                                  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1278</span></span><br><span class="line">  <span class="number">00100</span>af3  <span class="keyword">virtual</span> thunk to android::Camera3Device::processCaptureResult(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt; <span class="keyword">const</span>&amp;)+<span class="number">10</span>                                                                                                  aeabi_div0.c:?</span><br><span class="line">  <span class="number">00019</span>d15  android::hardware::camera::device::V3_2::BnHwCameraDeviceCallback::_hidl_processCaptureResult(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">212</span>  out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceCallbackAll.cpp:<span class="number">422</span></span><br><span class="line">  <span class="number">0001</span>ef41  android::hardware::camera::device::V3_5::BnHwCameraDeviceCallback::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">288</span>                            out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.5</span>/android.hardware.camera.device@<span class="number">3.5</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.5</span>/CameraDeviceCallbackAll.cpp:<span class="number">679</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                    system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                        system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                 system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                    system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  <span class="number">00076f</span>0d  android::hardware::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                system/libhwbinder/ProcessState.cpp:<span class="number">61</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                       system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                     bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                                                                                             bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="3-、Camera3OutputStream-returnBufferCheckedLocked-gt-Stack-Trace"><a href="#3-、Camera3OutputStream-returnBufferCheckedLocked-gt-Stack-Trace" class="headerlink" title="(3)、Camera3OutputStream::returnBufferCheckedLocked()-&gt;Stack Trace"></a>(3)、Camera3OutputStream::returnBufferCheckedLocked()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                                                                                                                  FILE:LINE</span><br><span class="line">  <span class="number">0011</span>ac87  android::camera3::Camera3OutputStream::returnBufferCheckedLocked(camera3_stream_buffer <span class="keyword">const</span>&amp;, <span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">bool</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, android::sp&lt;android::Fence&gt;*)+<span class="number">50</span>                                                                                                                                                                                                                               frameworks/av/services/camera/libcameraservice/device3/Camera3OutputStream.cpp:<span class="number">219</span></span><br><span class="line">  <span class="number">001184</span>cd  android::camera3::Camera3IOStreamBase::returnAnyBufferLocked(camera3_stream_buffer <span class="keyword">const</span>&amp;, <span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">bool</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;)+<span class="number">124</span>                                                                                                                                                                                                                                                                frameworks/av/services/camera/libcameraservice/device3/Camera3IOStreamBase.cpp:<span class="number">242</span></span><br><span class="line">  <span class="number">0011</span>abfd  android::camera3::Camera3OutputStream::returnBufferLocked(camera3_stream_buffer <span class="keyword">const</span>&amp;, <span class="keyword">long</span> <span class="keyword">long</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;)+<span class="number">60</span>                                                                                                                                                                                                                                                                          frameworks/av/services/camera/libcameraservice/device3/Camera3OutputStream.cpp:<span class="number">196</span></span><br><span class="line">  <span class="number">00117089</span>  android::camera3::Camera3Stream::returnBuffer(camera3_stream_buffer <span class="keyword">const</span>&amp;, <span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">bool</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)+<span class="number">240</span>                                                                                                                                                                                                                                                           frameworks/av/services/camera/libcameraservice/device3/Camera3Stream.cpp:<span class="number">708</span></span><br><span class="line">  <span class="number">000f</span>fcc7  android::Camera3Device::returnOutputBuffers(camera3_stream_buffer <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">bool</span>, <span class="built_in">std</span>::__1::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt;, <span class="built_in">std</span>::__1::hash&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::equal_to&lt;<span class="keyword">int</span>&gt;, <span class="built_in">std</span>::__1::allocator&lt;<span class="built_in">std</span>::__1::<span class="built_in">pair</span>&lt;<span class="keyword">int</span> <span class="keyword">const</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::allocator&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt; &gt; &gt; &gt; &gt; <span class="keyword">const</span>&amp;, android::hardware::camera2::impl::CaptureResultExtras <span class="keyword">const</span>&amp;)+<span class="number">334</span>  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">3185</span></span><br><span class="line">  <span class="number">001013</span>df  android::Camera3Device::processCaptureResult(camera3_capture_result <span class="keyword">const</span>*)+<span class="number">1310</span>                                                                                                                                                                                                                                                                                                                                                                          frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">3772</span></span><br><span class="line">  <span class="number">001006f</span>5  android::Camera3Device::processOneCaptureResultLocked(android::hardware::camera::device::V3_2::CaptureResult <span class="keyword">const</span>&amp;, android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_4::PhysicalCameraMetadata&gt;)+<span class="number">1064</span>                                                                                                                                                                                                                                   frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1454</span></span><br><span class="line">  <span class="number">001009</span>dd  android::Camera3Device::processCaptureResult(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt; <span class="keyword">const</span>&amp;)+<span class="number">224</span>                                                                                                                                                                                                                                                                                                              frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1278</span></span><br><span class="line">  <span class="number">00100</span>af3  <span class="keyword">virtual</span> thunk to android::Camera3Device::processCaptureResult(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt; <span class="keyword">const</span>&amp;)+<span class="number">10</span>                                                                                                                                                                                                                                                                                              aeabi_div0.c:?</span><br><span class="line">  <span class="number">00019</span>d15  android::hardware::camera::device::V3_2::BnHwCameraDeviceCallback::_hidl_processCaptureResult(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">212</span>                                                                                                                                                                                              out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceCallbackAll.cpp:<span class="number">422</span></span><br><span class="line">  <span class="number">0001</span>ef41  android::hardware::camera::device::V3_5::BnHwCameraDeviceCallback::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">288</span>                                                                                                                                                                                                                        out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.5</span>/android.hardware.camera.device@<span class="number">3.5</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.5</span>/CameraDeviceCallbackAll.cpp:<span class="number">679</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                                                                                                                                                                                                                system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                                                                                                                                                                                                                    system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                                                                                                                                                                                                             system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                                                                                                                                                                                                                system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  <span class="number">00076f</span>0d  android::hardware::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                                                                                                                                                                                                            system/libhwbinder/ProcessState.cpp:<span class="number">61</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                                                                                                                                                                                                                   system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                                                                                                                                                                                                                 bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                                                                                                                                                                                                                                                                                         bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-、queueBufferToConsumer"><a href="#4-、queueBufferToConsumer" class="headerlink" title="(4)、queueBufferToConsumer()"></a>(4)、queueBufferToConsumer()</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\device3\Camera3OutputStream.cpp</span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">Camera3OutputStream::queueBufferToConsumer</span><span class="params">(sp&lt;ANativeWindow&gt;&amp; consumer,</span></span></span><br><span class="line"><span class="function"><span class="params">            ANativeWindowBuffer* buffer, <span class="keyword">int</span> anwReleaseFence)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 直接调用 ANativeWindow 对象的 queueBuffer 方法将 buffer 归还回去，</span></span><br><span class="line"><span class="comment">     * ANativeWindow 是 OpenGL 定义的图形接口，在 Android上 的实现就是</span></span><br><span class="line"><span class="comment">     * Surface 和 SurfaceFlinger，一个用于生产 buffer ，一个用于消费 buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> consumer-&gt;queueBuffer(consumer.get(), buffer, anwReleaseFence);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-、Camera3Device-insertResultLocked-gt-Stack-Trace"><a href="#5-、Camera3Device-insertResultLocked-gt-Stack-Trace" class="headerlink" title="(5)、Camera3Device::insertResultLocked()-&gt;Stack Trace"></a>(5)、Camera3Device::insertResultLocked()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                                                                                                                                                                                                                                       FILE:LINE</span><br><span class="line">  <span class="number">00108</span>d31  android::Camera3Device::insertResultLocked(android::CaptureResult*, <span class="keyword">unsigned</span> <span class="keyword">int</span>)+<span class="number">344</span>                                                                                                                                                                                                                                                                          frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">3466</span></span><br><span class="line">  <span class="number">00109699</span>  android::Camera3Device::sendCaptureResult(android::CameraMetadata&amp;, android::hardware::camera2::impl::CaptureResultExtras&amp;, android::CameraMetadata&amp;, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">bool</span>, <span class="keyword">bool</span>, <span class="built_in">std</span>::__1::<span class="built_in">vector</span>&lt;android::hardware::camera2::impl::PhysicalCaptureResultInfo, <span class="built_in">std</span>::__1::allocator&lt;android::hardware::camera2::impl::PhysicalCaptureResultInfo&gt; &gt; <span class="keyword">const</span>&amp;)+<span class="number">1480</span>  frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">3614</span></span><br><span class="line">  <span class="number">00101573</span>  android::Camera3Device::processCaptureResult(camera3_capture_result <span class="keyword">const</span>*)+<span class="number">1714</span>                                                                                                                                                                                                                                                                               frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">3790</span></span><br><span class="line">  <span class="number">001006f</span>5  android::Camera3Device::processOneCaptureResultLocked(android::hardware::camera::device::V3_2::CaptureResult <span class="keyword">const</span>&amp;, android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_4::PhysicalCameraMetadata&gt;)+<span class="number">1064</span>                                                                                                                                        frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1454</span></span><br><span class="line">  <span class="number">001009</span>dd  android::Camera3Device::processCaptureResult(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt; <span class="keyword">const</span>&amp;)+<span class="number">224</span>                                                                                                                                                                                                                   frameworks/av/services/camera/libcameraservice/device3/Camera3Device.cpp:<span class="number">1278</span></span><br><span class="line">  <span class="number">00100</span>af3  <span class="keyword">virtual</span> thunk to android::Camera3Device::processCaptureResult(android::hardware::hidl_vec&lt;android::hardware::camera::device::V3_2::CaptureResult&gt; <span class="keyword">const</span>&amp;)+<span class="number">10</span>                                                                                                                                                                                                   aeabi_div0.c:?</span><br><span class="line">  <span class="number">00019</span>d15  android::hardware::camera::device::V3_2::BnHwCameraDeviceCallback::_hidl_processCaptureResult(android::hidl::base::V1_0::BnHwBase*, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">212</span>                                                                                                   out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.2</span>/android.hardware.camera.device@<span class="number">3.2</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.2</span>/CameraDeviceCallbackAll.cpp:<span class="number">422</span></span><br><span class="line">  <span class="number">0001</span>ef41  android::hardware::camera::device::V3_5::BnHwCameraDeviceCallback::onTransact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">288</span>                                                                                                                             out/soong/.intermediates/hardware/interfaces/camera/device/<span class="number">3.5</span>/android.hardware.camera.device@<span class="number">3.5</span>_genc++/gen/android/hardware/camera/device/<span class="number">3.5</span>/CameraDeviceCallbackAll.cpp:<span class="number">679</span></span><br><span class="line">  <span class="number">000689</span>a1  android::hardware::BHwBinder::transact(<span class="keyword">unsigned</span> <span class="keyword">int</span>, android::hardware::Parcel <span class="keyword">const</span>&amp;, android::hardware::Parcel*, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="built_in">std</span>::__1::function&lt;<span class="keyword">void</span> (android::hardware::Parcel&amp;)&gt;)+<span class="number">52</span>                                                                                                                                                                     system/libhwbinder/Binder.cpp:<span class="number">116</span></span><br><span class="line">  v------&gt;  android::hardware::IPCThreadState::executeCommand(<span class="keyword">int</span>)                                                                                                                                                                                                                                                                                                         system/libhwbinder/IPCThreadState.cpp:<span class="number">1204</span></span><br><span class="line">  <span class="number">0006</span>af8d  android::hardware::IPCThreadState::getAndExecuteCommand()+<span class="number">924</span>                                                                                                                                                                                                                                                                                                  system/libhwbinder/IPCThreadState.cpp:<span class="number">461</span></span><br><span class="line">  <span class="number">0006b</span>e61  android::hardware::IPCThreadState::joinThreadPool(<span class="keyword">bool</span>)+<span class="number">56</span>                                                                                                                                                                                                                                                                                                     system/libhwbinder/IPCThreadState.cpp:<span class="number">561</span></span><br><span class="line">  <span class="number">00076f</span>0d  android::hardware::PoolThread::threadLoop()+<span class="number">12</span>                                                                                                                                                                                                                                                                                                                 system/libhwbinder/ProcessState.cpp:<span class="number">61</span></span><br><span class="line">  <span class="number">0000</span>d8bf  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">186</span>                                                                                                                                                                                                                                                                                                                        system/core/libutils/Threads.cpp:<span class="number">746</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                                                                                                                                                                                                                                      bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                                                                                                                                                                                                                                              bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br></pre></td></tr></table></figure>

<p>在 Camera3Device::insertResultLocked() 中的 mResultSignal 信号到底是发给谁呢？</p>
<p>通过搜索代码可以知道，在 FrameProcessorBase 帧处理线程中将会接收该信号。而帧处理线程是在 CameraDeviceClient 对象的 CameraDeviceClient::initializeImpl() 中启动的（open camera阶段调用到该函数）。</p>
<h4 id="6-、CameraDeviceClient-onResultAvailable-gt-Stack-Trace"><a href="#6-、CameraDeviceClient-onResultAvailable-gt-Stack-Trace" class="headerlink" title="(6)、CameraDeviceClient::onResultAvailable()-&gt;Stack Trace"></a>(6)、CameraDeviceClient::onResultAvailable()-&gt;Stack Trace</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Stack Trace:</span><br><span class="line">  RELADDR   FUNCTION                                                                                                                                  FILE:LINE</span><br><span class="line">  <span class="number">000e0559</span>  android::CameraDeviceClient::onResultAvailable(android::CaptureResult <span class="keyword">const</span>&amp;)+<span class="number">92</span>                                                          frameworks/av/services/camera/libcameraservice/api2/CameraDeviceClient.cpp:<span class="number">2026</span></span><br><span class="line">  <span class="number">000b</span>bc39  android::camera2::FrameProcessorBase::processListeners(android::CaptureResult <span class="keyword">const</span>&amp;, android::sp&lt;android::CameraDeviceBase&gt; <span class="keyword">const</span>&amp;)+<span class="number">464</span>  frameworks/av/services/camera/libcameraservice/common/FrameProcessorBase.cpp:<span class="number">229</span></span><br><span class="line">  <span class="number">000b</span>ba4f  android::camera2::FrameProcessorBase::processSingleFrame(android::CaptureResult&amp;, android::sp&lt;android::CameraDeviceBase&gt; <span class="keyword">const</span>&amp;)+<span class="number">54</span>       frameworks/av/services/camera/libcameraservice/common/FrameProcessorBase.cpp:<span class="number">180</span></span><br><span class="line">  <span class="number">000b</span>b893  android::camera2::FrameProcessorBase::processNewFrames(android::sp&lt;android::CameraDeviceBase&gt; <span class="keyword">const</span>&amp;)+<span class="number">222</span>                                 frameworks/av/services/camera/libcameraservice/common/FrameProcessorBase.cpp:<span class="number">156</span></span><br><span class="line">  <span class="number">000b</span>b75f  android::camera2::FrameProcessorBase::threadLoop()+<span class="number">106</span>                                                                                    frameworks/av/services/camera/libcameraservice/common/FrameProcessorBase.cpp:<span class="number">126</span></span><br><span class="line">  <span class="number">0000</span>d945  android::Thread::_threadLoop(<span class="keyword">void</span>*)+<span class="number">320</span>                                                                                                   system/core/libutils/Threads.cpp:<span class="number">749</span></span><br><span class="line">  <span class="number">000</span>a6867  __pthread_start(<span class="keyword">void</span>*)+<span class="number">20</span>                                                                                                                 bionic/libc/bionic/pthread_create.cpp:<span class="number">338</span></span><br><span class="line">  <span class="number">00060087</span>  __start_thread+<span class="number">30</span>                                                                                                                         bionic/libc/bionic/clone.cpp:<span class="number">53</span></span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      F:\Khadas_Edge_Android_Q\frameworks\av\services\camera\libcameraservice\api2\CameraDeviceClient.cpp</span><br><span class="line">          <span class="comment">/** Device-related methods */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CameraDeviceClient::onResultAvailable</span><span class="params">(<span class="keyword">const</span> CaptureResult&amp; result)</span> </span>&#123;</span><br><span class="line">    ATRACE_CALL();</span><br><span class="line">    ALOGV(<span class="string">&quot;%s&quot;</span>, __FUNCTION__);</span><br><span class="line"></span><br><span class="line">    CallStack <span class="built_in">stack</span>;</span><br><span class="line">    <span class="built_in">stack</span>.update();</span><br><span class="line">    <span class="built_in">stack</span>.<span class="built_in">log</span>(<span class="string">&quot;CameraDeviceClient::onResultAvailable&quot;</span>);</span><br><span class="line">    <span class="comment">/* 这里的 mRemoteCallback 就是在CameraService 创建 CameraDeviceClient</span></span><br><span class="line"><span class="comment">     * 实例时传递进来的 remoteCb，自然就是 Camera APP当中的成员了，它是</span></span><br><span class="line"><span class="comment">     * CameraDeviceImpl 类的内部类CameraDeviceCallbacks对象 */</span></span><br><span class="line">    <span class="comment">// Thread-safe. No lock necessary.</span></span><br><span class="line">    sp&lt;hardware::camera2::ICameraDeviceCallbacks&gt; remoteCb = mRemoteCallback;</span><br><span class="line">    <span class="keyword">if</span> (remoteCb != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        remoteCb-&gt;onResultReceived(result.mMetadata, result.mResultExtras,</span><br><span class="line">                result.mPhysicalMetadatas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mCompositeStreamMap.size(); i++) &#123;</span><br><span class="line">        mCompositeStreamMap.valueAt(i)-&gt;onResultAvailable(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="7-、Stack-CameraDeviceCallbacks-onResultReceived"><a href="#7-、Stack-CameraDeviceCallbacks-onResultReceived" class="headerlink" title="(7)、Stack::CameraDeviceCallbacks.onResultReceived()"></a>(7)、Stack::CameraDeviceCallbacks.onResultReceived()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>-<span class="number">08</span> <span class="number">07</span>:<span class="number">21</span>:<span class="number">08.192</span>  <span class="number">4654</span>  <span class="number">4671</span> I CameraDevice-JV-<span class="number">0</span>: onResultReceived</span><br><span class="line"><span class="number">07</span>-<span class="number">08</span> <span class="number">07</span>:<span class="number">21</span>:<span class="number">08.192</span>  <span class="number">4654</span>  <span class="number">4671</span> I CameraDevice-JV-<span class="number">0</span>: java.lang.RuntimeException: here</span><br><span class="line"><span class="number">07</span>-<span class="number">08</span> <span class="number">07</span>:<span class="number">21</span>:<span class="number">08.192</span>  <span class="number">4654</span>  <span class="number">4671</span> I CameraDevice-JV-<span class="number">0</span>:     at android.hardware.camera2.impl.CameraDeviceImpl$CameraDeviceCallbacks.onResultReceived(CameraDeviceImpl.java:<span class="number">2135</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">08</span> <span class="number">07</span>:<span class="number">21</span>:<span class="number">08.192</span>  <span class="number">4654</span>  <span class="number">4671</span> I CameraDevice-JV-<span class="number">0</span>:     at android.hardware.camera2.ICameraDeviceCallbacks$Stub.onTransact(ICameraDeviceCallbacks.java:<span class="number">180</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">08</span> <span class="number">07</span>:<span class="number">21</span>:<span class="number">08.192</span>  <span class="number">4654</span>  <span class="number">4671</span> I CameraDevice-JV-<span class="number">0</span>:     at android.os.Binder.execTransactInternal(Binder.java:<span class="number">1021</span>)</span><br><span class="line"><span class="number">07</span>-<span class="number">08</span> <span class="number">07</span>:<span class="number">21</span>:<span class="number">08.192</span>  <span class="number">4654</span>  <span class="number">4671</span> I CameraDevice-JV-<span class="number">0</span>:     at android.os.Binder.execTransact(Binder.java:<span class="number">994</span>)</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20220501/">https://zhoujinjian.com/posts/20220501/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Camera/">Camera</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.39.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20220515/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.40.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md</div></div></a></div><div class="next-post pull-right"><a href="/posts/20220415/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.38.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android 10 Camera源码分析8：openCamera流程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20220515/" title="Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.40.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-15</div><div class="title">Android 10 Camera源码分析10：Camera Android架构(基于Q)转载.md</div></div></a></div><div><a href="/posts/20220101/" title="Android 10 Camera源码分析1：MIPI CSI2总结基于DPHY2.1(转载)"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.31.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-01</div><div class="title">Android 10 Camera源码分析1：MIPI CSI2总结基于DPHY2.1(转载)</div></div></a></div><div><a href="/posts/20220115/" title="Android 10 Camera源码分析2：V4L2简介"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.32.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-15</div><div class="title">Android 10 Camera源码分析2：V4L2简介</div></div></a></div><div><a href="/posts/20220201/" title="Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.33.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-01</div><div class="title">Android 10 Camera源码分析3：videobuf2 申请与map、入队与出队</div></div></a></div><div><a href="/posts/20220215/" title="Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.34.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-15</div><div class="title">Android 10 Camera源码分析4：Rockchip ISP1 Driver 分析</div></div></a></div><div><a href="/posts/20220301/" title="Android 10 Camera源码分析5：rkisp_demo分析"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.35.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-01</div><div class="title">Android 10 Camera源码分析5：rkisp_demo分析</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81configure-streams"><span class="toc-number">1.</span> <span class="toc-text">（一）、configure_streams()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81Stack-createCaptureSessionInternal"><span class="toc-number">1.0.1.</span> <span class="toc-text">（1）、Stack::createCaptureSessionInternal()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81CameraDeviceImpl-createCaptureSessionInternal"><span class="toc-number">1.0.2.</span> <span class="toc-text">（2）、CameraDeviceImpl.createCaptureSessionInternal()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81CameraDeviceClient-createStream"><span class="toc-number">1.0.3.</span> <span class="toc-text">（3）、CameraDeviceClient::createStream()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81Camera3Device-createStream"><span class="toc-number">1.0.4.</span> <span class="toc-text">（4）、Camera3Device::createStream()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81CameraDeviceClient-endConfigure"><span class="toc-number">1.0.5.</span> <span class="toc-text">（5）、CameraDeviceClient::endConfigure()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E3%80%81Camera3Device-HalInterface-configureStreams-gt-Stack-Trace"><span class="toc-number">1.0.6.</span> <span class="toc-text">（6）、Camera3Device::HalInterface::configureStreams-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E3%80%81Camera3Device-HalInterface-configureStreams"><span class="toc-number">1.0.7.</span> <span class="toc-text">（7）、Camera3Device::HalInterface::configureStreams()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%888%EF%BC%89%E3%80%81Camera3HAL-configure-streams-gt-Stack-Trace"><span class="toc-number">1.0.8.</span> <span class="toc-text">（8）、Camera3HAL::configure_streams()-&gt;Stack Trace</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81construct-default-request-settings"><span class="toc-number">2.</span> <span class="toc-text">（二）、construct_default_request_settings()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81Stack-createCaptureRequest"><span class="toc-number">2.0.1.</span> <span class="toc-text">（1）、Stack::createCaptureRequest()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81CameraDeviceImpl-createCaptureRequest"><span class="toc-number">2.0.2.</span> <span class="toc-text">（2）、CameraDeviceImpl.createCaptureRequest()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81CameraDeviceClient-createDefaultRequest"><span class="toc-number">2.0.3.</span> <span class="toc-text">（3）、CameraDeviceClient::createDefaultRequest()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81Camera3Device-createDefaultRequest"><span class="toc-number">2.0.4.</span> <span class="toc-text">（4）、Camera3Device::createDefaultRequest()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81Camera3Device-createDefaultRequest-gt-Stack-Trace"><span class="toc-number">2.0.5.</span> <span class="toc-text">（5）、Camera3Device::createDefaultRequest()-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E3%80%81Camera3HAL-construct-default-request-settings-gt-Stack-Trace"><span class="toc-number">2.0.6.</span> <span class="toc-text">（6）、Camera3HAL::construct_default_request_settings()-&gt;Stack Trace</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81process-capture-request"><span class="toc-number">3.</span> <span class="toc-text">（三）、process_capture_request()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E3%80%81ICameraDeviceUserWrapper-submitRequestList"><span class="toc-number">3.0.1.</span> <span class="toc-text">(1)、ICameraDeviceUserWrapper.submitRequestList()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E3%80%81ICameraDeviceUserWrapper-submitRequestList"><span class="toc-number">3.0.2.</span> <span class="toc-text">(2)、ICameraDeviceUserWrapper.submitRequestList()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E3%80%81Camera3Device-RequestThread-unpauseForNewRequests-gt-Stack-Trace"><span class="toc-number">3.0.3.</span> <span class="toc-text">(3)、Camera3Device::RequestThread::unpauseForNewRequests() -&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E3%80%81Camera3Device-HalInterface-processBatchCaptureRequest-gt-Stack-Trace"><span class="toc-number">3.0.4.</span> <span class="toc-text">(4)、Camera3Device::HalInterface::processBatchCaptureRequest-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E3%80%81Camera3HAL-process-capture-request-gt-Stack-Trace"><span class="toc-number">3.0.5.</span> <span class="toc-text">(5)、Camera3HAL::process_capture_request()-&gt;Stack Trace</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E3%80%81processCaptureResult"><span class="toc-number">4.</span> <span class="toc-text">(四)、processCaptureResult()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E3%80%81CameraDeviceSession-ResultBatcher-invokeProcessCaptureResultCallback-gt-Stack-Trace"><span class="toc-number">4.0.1.</span> <span class="toc-text">(1)、CameraDeviceSession::ResultBatcher::invokeProcessCaptureResultCallback()-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E3%80%81Camera3Device-processCaptureResult-gt-Stack-Trace"><span class="toc-number">4.0.2.</span> <span class="toc-text">(2)、Camera3Device::processCaptureResult()-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E3%80%81Camera3OutputStream-returnBufferCheckedLocked-gt-Stack-Trace"><span class="toc-number">4.0.3.</span> <span class="toc-text">(3)、Camera3OutputStream::returnBufferCheckedLocked()-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E3%80%81queueBufferToConsumer"><span class="toc-number">4.0.4.</span> <span class="toc-text">(4)、queueBufferToConsumer()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E3%80%81Camera3Device-insertResultLocked-gt-Stack-Trace"><span class="toc-number">4.0.5.</span> <span class="toc-text">(5)、Camera3Device::insertResultLocked()-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E3%80%81CameraDeviceClient-onResultAvailable-gt-Stack-Trace"><span class="toc-number">4.0.6.</span> <span class="toc-text">(6)、CameraDeviceClient::onResultAvailable()-&gt;Stack Trace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E3%80%81Stack-CameraDeviceCallbacks-onResultReceived"><span class="toc-number">4.0.7.</span> <span class="toc-text">(7)、Stack::CameraDeviceCallbacks.onResultReceived()</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>