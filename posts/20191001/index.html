<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android L Display System源码分析（3）：LCD驱动分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86） | zhoujinjian</title><meta name="keywords" content="Android,Linux,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（ ©Android @Linux 版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。（&#x3D;&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android L Display System源码分析（3）：LCD驱动分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）">
<meta property="og:url" content="https://zhoujinjian.com/posts/20191001/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（ ©Android @Linux 版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。（&#x3D;&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00003.jpg">
<meta property="article:published_time" content="2019-10-01T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.944Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00003.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20191001/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00003.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android L Display System源码分析（3）：LCD驱动分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-10-01T01:25:00.000Z" title="发表于 2019-10-01 09:25:00">2019-10-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.944Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Display/">Display</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>注：文章都是通过阅读 Android  &amp;&amp; Linux 平台源码、各位前辈总结的资料、加上自己的思考分析总结出来的，其中难免有理不对的地方，欢迎大家批评指正。<strong>文章为个人学习、研究、欣赏之用。图文内容、源码整理自互联网，如有侵权，请联系删除（◕‿◕）</strong>，转载请注明出处（ ©Android @Linux 版权所有），谢谢(๑乛◡乛๑) 、（ ͡° ͜ʖ ͡°）、（ಡωಡ）！！！。<br>（==<strong>文章基于 Kernel-3.0.86</strong>==）&amp;&amp;（==<strong>文章基于 Android 5.0.2</strong>==）<br><a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=0.0.0.0.3GsGdQ&id=20131438062">【开发板 - 友善之臂 FriendlyARM Cortex-A9 Tiny4412 ADK Exynos4412 （ Android 5.0.2）HD702高清电容屏 扩展套餐】</a><br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1jJHm74q">【开发板 Android 5.0.2 &amp;&amp; Kernel 3.0.86 源码链接： https://pan.baidu.com/s/1jJHm74q 密码：yfih】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/z961968549/article/details/78821082">（1）【LCD设备驱动框架分析（数据结构）】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Ultraman_hs/article/details/54987874">（2）【framebuffer之s3cfb_probe分析】</a><br><a target="_blank" rel="noopener" href="https://layty.gitee.io/2018/12/03/Linux/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/12-lcd%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/">（3）【LCD驱动框架】</a></p>
<hr>
<p>==源码（部分）==：</p>
<blockquote>
<p>linux-3.0.86（Kernel 层）： FrameBuffer 核心层</p>
</blockquote>
<ul>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\drivers\video\fbmem.c</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\include\linux\fb.h</li>
</ul>
<blockquote>
<p>设备驱动层：</p>
</blockquote>
<ul>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\drivers\video\samsung\s3cfb_main.c</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\drivers\video\samsung\s3cfb_ops.c</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\drivers\video\samsung\s3cfb_fimd6x.c</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\drivers\video\cfbimgblt.c</li>
</ul>
<blockquote>
<p>设备平台相关：</p>
</blockquote>
<ul>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\arch\arm\plat-s5p\include\plat\regs-fb-s5p.h</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\arch\arm\plat-s5p\include\plat\fb-s5p.h</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\arch\arm\mach-exynos\setup-fb-s5p.c</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\arch\arm\mach-exynos\tiny4412-lcds.c</li>
<li>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\arch\arm\mach-exynos\mach-tiny4412.c</li>
</ul>
<hr>
<h4 id="（一）、LCD设备驱动框架图"><a href="#（一）、LCD设备驱动框架图" class="headerlink" title="（一）、LCD设备驱动框架图"></a>（一）、LCD设备驱动框架图</h4><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sysfbmem_s3cfb_main.png" alt="enter image description here"></p>
<ul>
<li>核心层是通用的，不需要任何修改。驱动开发者只需要实现硬件设备驱动层</li>
<li>帧缓冲设备可以看做是一个完整的子系统，主要由核心层的fbmem.c和硬件设备驱动层构成</li>
<li>核心层代码fnmem.c向上提供了完整的字符设备操作接口，也就是实现注册字符设备，提供通用的open,read,write,ioctl,mmap等接口；向下给硬件设备驱动层提供标准的驱动编程接口；</li>
<li>在linux系统中，一个硬件控制器（显卡）抽象为一个fb_info结构，要实现一个LCD驱动就是要实现这个结构，并且使用核心层提供的注册函数注册</li>
<li>fb_info中通过其中的fb_ops结构指针提供了实际硬件操作方法</li>
<li>fb_info中通过其中的fb_var_screeninfo结构和fb_fix_screeninfo结构提供了具体lcd屏基本信息</li>
<li>注册：register_framebuffer</li>
<li>注销：unregister_framebuffer</li>
</ul>
<h5 id="（1）、Framebuffer之fbmem-c概括"><a href="#（1）、Framebuffer之fbmem-c概括" class="headerlink" title="（1）、Framebuffer之fbmem.c概括"></a>（1）、Framebuffer之fbmem.c概括</h5><p>LCD框架的fbmem.c已经帮我们完成了日常驱动程序的工作，如：注册字符设备、分配设备号、创建类等。<br>也有了操作函数fb_fops，但它只是一个框架，在具体执行的时候需要知道硬件具体的一些参数，比如分辨率、数据基地址等信息。<br>因此，我们要利用这一框架，就得构造一个fb_info结构体，完成硬件初始化，设置相关参数等操作，再使用register_framebuffer()将fb_info向上注册。<br>这样，fbmem.c就可以从registered_fb[]这个数组获得fb_info参数，进行相关的硬件操作。<br>比如：应用层app想read()，就会调用fbmem.c的fb_read()，在fb_read里面会先尝试使用xxfb.c提供的read()操作函数，如果没有，再根据fb_info<br>信息得到数据基地址，将基地址开始的数据，返回给应用层，实现读操作。</p>
<h4 id="（二）、platform-device-amp-amp-platform-driver分析"><a href="#（二）、platform-device-amp-amp-platform-driver分析" class="headerlink" title="（二）、platform_device &amp;&amp; platform_driver分析"></a>（二）、platform_device &amp;&amp; platform_driver分析</h4><h5 id="（1）、platform-device分析"><a href="#（1）、platform-device分析" class="headerlink" title="（1）、platform_device分析"></a>（1）、platform_device分析</h5><blockquote>
<p>Log:<br>&lt;4&gt;[    0.180000] zjj.android.display.sys tiny4412_get_lcd() march-tiny4412.c<br>&lt;4&gt;[    0.180000] zjj.android.display.sys s3cfb_set_platdata() march-tiny4412.c </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\arch\arm\mach-exynos\mach-tiny4412.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __init <span class="title">smdk4x12_machine_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd</span> *<span class="title">lcd</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    tiny4412_fb_data.lcd = tiny4412_get_lcd();</span><br><span class="line">    s3cfb_set_platdata(&amp;tiny4412_fb_data);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\arch\arm\mach-exynos\tiny4412-lcds.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd</span> <span class="title">wxga_hd700</span> = &#123;</span></span><br><span class="line">    .width = <span class="number">800</span>,</span><br><span class="line">    .height = <span class="number">1280</span>,</span><br><span class="line">    .p_width = <span class="number">94</span>,</span><br><span class="line">    .p_height = <span class="number">151</span>,</span><br><span class="line">    .bpp = <span class="number">24</span>,</span><br><span class="line">    .freq = <span class="number">60</span>,</span><br><span class="line"></span><br><span class="line">    .timing = &#123;</span><br><span class="line">        .h_fp = <span class="number">20</span>,</span><br><span class="line">        .h_bp = <span class="number">20</span>,</span><br><span class="line">        .h_sw = <span class="number">24</span>,</span><br><span class="line">        .v_fp =  <span class="number">4</span>,</span><br><span class="line">        .v_fpe = <span class="number">1</span>,<span class="comment">//rgb == 0</span></span><br><span class="line">        .v_bp =  <span class="number">4</span>,</span><br><span class="line">        .v_bpe = <span class="number">1</span>,<span class="comment">//rgb == 0</span></span><br><span class="line">        .v_sw =  <span class="number">8</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .polarity = &#123;</span><br><span class="line">        .rise_vclk = <span class="number">1</span>,</span><br><span class="line">        .inv_hsync = <span class="number">0</span>,</span><br><span class="line">        .inv_vsync = <span class="number">0</span>,</span><br><span class="line">        .inv_vden = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd</span> *<span class="title">lcd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ctp;</span><br><span class="line">&#125; tiny4412_lcd_config[] = &#123;</span><br><span class="line">    &#123; <span class="string">&quot;HD700&quot;</span>,    &amp;wxga_hd700, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;HD702&quot;</span>,    &amp;wxga_hd700, CTP_GOODIX  &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;S70&quot;</span>,    &amp;wvga_s70,   <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;S702&quot;</span>,    &amp;wvga_s70,   <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;S70D&quot;</span>,    &amp;wvga_s70d,  <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;W50&quot;</span>,    &amp;wvga_w50,   <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;W101&quot;</span>,    &amp;wsvga_w101, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;X710&quot;</span>,    &amp;wsvga_x710, CTP_ITE7260 &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;A97&quot;</span>,    &amp;xga_a97,    <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;LQ150&quot;</span>,    &amp;xga_lq150,  <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;L80&quot;</span>,    &amp;vga_l80,    <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;HD101&quot;</span>,    &amp;wxga_hd101, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;HD101B&quot;</span>,    &amp;wxga_hd101, CTP_GOODIX  &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;BP101&quot;</span>,    &amp;wxga_bp101, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;HDM&quot;</span>,    &amp;hdmi_def,   <span class="number">0</span> &#125;,    <span class="comment">/* Pls keep it at last */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> lcd_idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tiny4412_setup_lcd</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *delim;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    delim = <span class="built_in">strchr</span>(str, <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (delim)</span><br><span class="line">        *delim++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!strncasecmp(<span class="string">&quot;HDMI&quot;</span>, str, <span class="number">4</span>)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hdmi_config</span> *<span class="title">cfg</span> = &amp;<span class="title">tiny4412_hdmi_config</span>[0];</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd</span> *<span class="title">lcd</span>;</span></span><br><span class="line"></span><br><span class="line">        lcd_idx = ARRAY_SIZE(tiny4412_lcd_config) - <span class="number">1</span>;</span><br><span class="line">        lcd = tiny4412_lcd_config[lcd_idx].lcd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(tiny4412_hdmi_config); i++, cfg++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strcasecmp(cfg-&gt;name, str)) &#123;</span><br><span class="line">                lcd-&gt;width = cfg-&gt;width;</span><br><span class="line">                lcd-&gt;height = cfg-&gt;height;</span><br><span class="line">                <span class="keyword">goto</span> __ret;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(tiny4412_lcd_config); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(tiny4412_lcd_config[i].name, str)) &#123;</span><br><span class="line">            lcd_idx = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">__ret:</span><br><span class="line">    tiny4412_set_ctp(tiny4412_lcd_config[lcd_idx].ctp);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;TINY4412: %s selected\n&quot;</span>, tiny4412_lcd_config[lcd_idx].name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">early_param(<span class="string">&quot;lcd&quot;</span>, tiny4412_setup_lcd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">struct s3cfb_lcd *<span class="title">tiny4412_get_lcd</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> tiny4412_lcd_config[lcd_idx].lcd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据打印Log，可以知道刚开机选择了LCD HD702</p>
<blockquote>
<p>Log:<br>&lt;4&gt;[    0.000000] Machine: TINY4412<br>&lt;4&gt;[    0.000000] TINY4412: HD702 selected</p>
</blockquote>
<p>通过s3cfb_set_platdata这个函数来单独设置platdata。因为内核中实现了多个LCD设备的platdata，用户可通过相应的宏定义来选择设置。它在启动时通过smdk4x12_machine_init()函数加载，保证platdata在内核启动时就已经设置好。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\arch\arm\plat-s5p\dev-fimd-s5p.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __init <span class="title">s3cfb_set_platdata</span><span class="params">(struct s3c_platform_fb *pd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3c_platform_fb</span> *<span class="title">npd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pd)</span><br><span class="line">        pd = &amp;default_fb_data;</span><br><span class="line"></span><br><span class="line">    npd = kmemdup(pd, <span class="keyword">sizeof</span>(struct s3c_platform_fb), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!npd)</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;%s: no memory for platform data\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; npd-&gt;nr_wins; i++)</span><br><span class="line">            npd-&gt;nr_buffers[i] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FB_S5P_NR_BUFFERS)</span></span><br><span class="line">        npd-&gt;nr_buffers[npd-&gt;default_win] = CONFIG_FB_S5P_NR_BUFFERS;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        npd-&gt;nr_buffers[npd-&gt;default_win] = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        s3cfb_get_clk_name(npd-&gt;clk_name);</span><br><span class="line">        npd-&gt;set_display_path = s3cfb_set_display_path;</span><br><span class="line">        npd-&gt;cfg_gpio = s3cfb_cfg_gpio;</span><br><span class="line">        npd-&gt;backlight_on = s3cfb_backlight_on;</span><br><span class="line">        npd-&gt;backlight_off = s3cfb_backlight_off;</span><br><span class="line">        npd-&gt;lcd_on = s3cfb_lcd_on;</span><br><span class="line">        npd-&gt;lcd_off = s3cfb_lcd_off;</span><br><span class="line">        npd-&gt;clk_on = s3cfb_clk_on;</span><br><span class="line">        npd-&gt;clk_off = s3cfb_clk_off;</span><br><span class="line"></span><br><span class="line">        s3c_device_fb.dev.platform_data = npd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>s3c_device_fb的设备信息如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\arch\arm\plat-s5p\dev-fimd-s5p.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> <span class="title">s3cfb_resource</span>[] = &#123;</span></span><br><span class="line">    [<span class="number">0</span>] = &#123;</span><br><span class="line">        .start    = S5P_PA_FIMD0,</span><br><span class="line">        .end    = S5P_PA_FIMD0 + SZ_32K - <span class="number">1</span>,</span><br><span class="line">        .flags    = IORESOURCE_MEM,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">1</span>] = &#123;</span><br><span class="line">        .start    = IRQ_FIMD0_VSYNC,</span><br><span class="line">        .end    = IRQ_FIMD0_VSYNC,</span><br><span class="line">        .flags    = IORESOURCE_IRQ,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">2</span>] = &#123;</span><br><span class="line">        .start    = IRQ_FIMD0_FIFO,</span><br><span class="line">        .end    = IRQ_FIMD0_FIFO,</span><br><span class="line">        .flags    = IORESOURCE_IRQ,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> u64 fb_dma_mask = <span class="number">0xffffffff</span>UL;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> <span class="title">s3c_device_fb</span> = &#123;</span></span><br><span class="line">    .name        = <span class="string">&quot;s3cfb&quot;</span>,</span><br><span class="line">#<span class="keyword">if</span> defined(CONFIG_ARCH_EXYNOS4)</span><br><span class="line">    .id        = <span class="number">0</span>,</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    .id        = <span class="number">-1</span>,</span><br><span class="line">#endif</span><br><span class="line">    .num_resources    = ARRAY_SIZE(s3cfb_resource),</span><br><span class="line">    .resource    = s3cfb_resource,</span><br><span class="line">    .dev        = &#123;</span><br><span class="line">        .dma_mask        = &amp;fb_dma_mask,</span><br><span class="line">        .coherent_dma_mask    = <span class="number">0xffffffff</span>UL</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_main.c    </span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">s3cfb_driver</span> = &#123;</span></span><br><span class="line">    .probe        = s3cfb_probe,</span><br><span class="line">    .remove        = s3cfb_remove,</span><br><span class="line">#ifndef CONFIG_HAS_EARLYSUSPEND</span><br><span class="line">    .suspend    = s3cfb_suspend,</span><br><span class="line">    .resume        = s3cfb_resume,</span><br><span class="line">#endif</span><br><span class="line">    .driver        = &#123;</span><br><span class="line">        .name    = S3CFB_NAME,<span class="comment">//s3cfb</span></span><br><span class="line">        .owner    = THIS_MODULE,</span><br><span class="line">#ifdef CONFIG_EXYNOS_DEV_PD</span><br><span class="line">        .pm    = &amp;s3cfb_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="（2）、platform-driver分析"><a href="#（2）、platform-driver分析" class="headerlink" title="（2）、platform_driver分析"></a>（2）、platform_driver分析</h5><blockquote>
<p>tiny4412-lcds.c ：设备参数相关文件<br>s3cfb_fimd6x.c：具体平台硬件相关文件<br>s3cfb_ops.c：fb操作集合<br>s3cfb_main.c ：驱动框架 </p>
</blockquote>
<p>s3cfb_main.c中的s3cfb_probe设备探测，是驱动注册的主要函数 </p>
<h5 id="2-1、s3cfb驱动注册"><a href="#2-1、s3cfb驱动注册" class="headerlink" title="2.1、s3cfb驱动注册"></a>2.1、s3cfb驱动注册</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_main.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">s3cfb_driver</span> = &#123;</span></span><br><span class="line">    .probe        = s3cfb_probe,</span><br><span class="line">    .remove        = s3cfb_remove,</span><br><span class="line">#ifndef CONFIG_HAS_EARLYSUSPEND</span><br><span class="line">    .suspend    = s3cfb_suspend,</span><br><span class="line">    .resume        = s3cfb_resume,</span><br><span class="line">#endif</span><br><span class="line">    .driver        = &#123;</span><br><span class="line">        .name    = S3CFB_NAME,</span><br><span class="line">        .owner    = THIS_MODULE,</span><br><span class="line">#ifdef CONFIG_EXYNOS_DEV_PD</span><br><span class="line">        .pm    = &amp;s3cfb_pm_ops,</span><br><span class="line">#endif</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_ops</span> <span class="title">s3cfb_ops</span> = &#123;</span></span><br><span class="line">    .owner        = THIS_MODULE,</span><br><span class="line">    .fb_open    = s3cfb_open,</span><br><span class="line">    .fb_release    = s3cfb_release,</span><br><span class="line">    .fb_check_var    = s3cfb_check_var,</span><br><span class="line">    .fb_set_par    = s3cfb_set_par,</span><br><span class="line">    .fb_setcolreg    = s3cfb_setcolreg,</span><br><span class="line">    .fb_blank    = s3cfb_blank,</span><br><span class="line">    .fb_pan_display    = s3cfb_pan_display,</span><br><span class="line">    .fb_fillrect    = cfb_fillrect,</span><br><span class="line">    .fb_copyarea    = cfb_copyarea,</span><br><span class="line">    .fb_imageblit    = cfb_imageblit,</span><br><span class="line">    .fb_cursor    = s3cfb_cursor,</span><br><span class="line">    .fb_ioctl    = s3cfb_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3cfb_register</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;s3cfb_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3cfb_unregister</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    platform_driver_unregister(&amp;s3cfb_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(s3cfb_register);</span><br><span class="line">module_exit(s3cfb_unregister);</span><br></pre></td></tr></table></figure>
<h4 id="（三）、s3cfb-probe函数分析"><a href="#（三）、s3cfb-probe函数分析" class="headerlink" title="（三）、s3cfb_probe函数分析"></a>（三）、s3cfb_probe函数分析</h4><p>先通过Log整体看看流程：</p>
<blockquote>
<p>Log：<br>    Line 215: &lt;4&gt;[    0.180000] zjj.android.display.sys tiny4412_get_lcd() march-tiny4412.c<br>    Line 217: &lt;4&gt;[    0.180000] zjj.android.display.sys s3cfb_set_platdata() march-tiny4412.c<br>    Line 389: &lt;4&gt;[    0.432365] zjj.android.display.sys cfg_gpio() s3cfb_probe s3cfb_main.c<br>    Line 391: &lt;6&gt;[    0.432476] s3cfb s3cfb.0: src_clk=800000000, vclk=67184640, div=12(11), rate=72727272<br>    Line 393: &lt;6&gt;[    0.432488] s3cfb s3cfb.0: fimd sclk rate 66666666, clkdiv 0xfffffb<br>    Line 395: &lt;4&gt;[    0.432576] zjj.android.display.sys s3cfb_init_global() s3cfb_probe s3cfb_main.c<br>    Line 397: &lt;4&gt;[    0.432583] zjj.android.display.sys s3cfb_set_output s3cfb_fimd6x.c<br>    Line 399: &lt;4&gt;[    0.432589] zjj.android.display.sys s3cfb_set_output s3cfb_fimd6x.c S3C_VIDCON0 = 0<br>    Line 401: &lt;4&gt;[    0.432595] zjj.android.display.sys s3cfb_set_output s3cfb_fimd6x.c S3C_VIDCON2 = 0<br>    Line 403: &lt;4&gt;[    0.432600] zjj.android.display.sys s3cfb_set_display_mode s3cfb_fimd6x.c<br>    Line 405: &lt;4&gt;[    0.432606] zjj.android.display.sys s3cfb_set_display_mode s3cfb_fimd6x.c S3C_VIDCON0 = 0<br>    Line 407: &lt;4&gt;[    0.432611] zjj.android.display.sys s3cfb_set_polarity s3cfb_fimd6x.c<br>    Line 409: &lt;4&gt;[    0.432617] zjj.android.display.sys s3cfb_set_polarity s3cfb_fimd6x.c S3C_VIDCON1 = 680<br>    Line 411: &lt;4&gt;[    0.432622] zjj.android.display.sys s3cfb_set_timing s3cfb_fimd6x.c<br>    Line 413: &lt;4&gt;[    0.432627] zjj.android.display.sys s3cfb_set_timing s3cfb_fimd6x.c  S3C_VIDTCON0 = 30307<br>    Line 415: &lt;4&gt;[    0.432634] zjj.android.display.sys s3cfb_set_timing s3cfb_fimd6x.c  S3C_VIDTCON1 = 131317<br>    Line 417: &lt;4&gt;[    0.432639] zjj.android.display.sys s3cfb_set_lcd_size s3cfb_fimd6x.c  S3C_VIDTCON2 = 27fb1f<br>    Line 419: &lt;4&gt;[    0.432645] zjj.android.display.sys s3cfb_alloc_framebuffer() s3cfb_probe s3cfb_main.c<br>    Line 421: &lt;4&gt;[    0.432651] zjj.android.display.sys s3cfb_alloc_framebuffer() s3cfb_ops.c<br>    Line 423: &lt;6&gt;[    0.432860] s3cfb s3cfb.0: [fb0] win2: dma: 0x60ad8000, cpu: 0xe4879000, size: 0x00bb8000<br>    Line 425: &lt;4&gt;[    0.448361] zjj.android.display.sys s3cfb_register_framebuffer() s3cfb_probe s3cfb_main.c<br>    Line 425: &lt;4&gt;[    0.448361] zjj.android.display.sys s3cfb_register_framebuffer() s3cfb_probe s3cfb_main.c<br>    Line 427: &lt;4&gt;[    0.448606] zjj.android.display.sys s3cfb_draw_logo() s3cfb_ops.c<br>    Line 439: &lt;4&gt;[    0.449600] zjj.android.display.sys s3cfb_set_clock() s3cfb_probe s3cfb_main.c<br>    Line 441: &lt;4&gt;[    0.449607] zjj.android.display.sys s3cfb_set_clock s3cfb_fimd6x.c<br>    Line 443: &lt;6&gt;[    0.449616] s3cfb s3cfb.0: FIMD src sclk = 66666666<br>    Line 445: &lt;4&gt;[    0.449622] zjj.android.display.sys s3cfb_set_clock s3cfb_fimd6x.c S3C_VIDCON0 = 20<br>    Line 447: &lt;6&gt;[    0.449629] s3cfb s3cfb.0: parent clock: 66666666, vclk: 67186000, vclk div: 1<br>    Line 449: &lt;4&gt;[    0.449635] zjj.android.display.sys s3cfb_enable_window() s3cfb_probe s3cfb_main.c<br>    Line 451: &lt;4&gt;[    0.449641] zjj.android.display.sys s3cfb_window_on s3cfb_fimd6x.c<br>    Line 453: &lt;6&gt;[    0.449647] s3cfb s3cfb.0: [win2] turn on<br>    Line 455: &lt;4&gt;[    0.449651] zjj.android.display.sys s3cfb_update_power_state() s3cfb_probe s3cfb_main.c<br>    Line 457: &lt;4&gt;[    0.449657] zjj.android.display.sys s3cfb_display_on s3cfb_fimd6x.c<br>    Line 459: &lt;4&gt;[    0.449662] zjj.android.display.sys s3cfb_set_display_on s3cfb_fimd6x.c S3C_VIDCON0 = 23<br>    Line 461: &lt;6&gt;[    0.449668] s3cfb s3cfb.0: global display is on<br>    Line 463: &lt;6&gt;[    0.449741] s3cfb s3cfb.0: registered successfully<br>    Line 465: &lt;6&gt;[    0.450044] s3cfb_extdsp s3cfb_extdsp.0: registered successfully<br>    Line 1959: &lt;4&gt;[    9.365483] zjj.android.display.sys s3cfb_open() s3cfb_ops.c<br>    Line 1961: &lt;4&gt;[    9.365606] zjj.android.display.sys s3cfb_open() s3cfb_ops.c<br>    Line 1979: &lt;4&gt;[    9.555995] zjj.android.display.sys s3cfb_open() s3cfb_ops.c</p>
</blockquote>
<p>s3cfb_probe()函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_main.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3cfb_probe</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3c_platform_fb</span> *<span class="title">pdata</span> = <span class="title">NULL</span>;</span> <span class="comment">/*LCD的platdata，LCD屏配置信息结构体*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_global</span> *<span class="title">fbdev</span>[2];</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EXYNOS_DEV_PD</span></span><br><span class="line">    <span class="comment">/* to use the runtime PM helper functions */</span></span><br><span class="line">    pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line">    <span class="comment">/* enable the power domain */</span></span><br><span class="line">    pm_runtime_get_sync(&amp;pdev-&gt;dev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    fbfimd = kzalloc(<span class="keyword">sizeof</span>(struct s3cfb_fimd_desc), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FIMD_MAX == <span class="number">2</span>)</span><br><span class="line">        fbfimd-&gt;dual = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fbfimd-&gt;dual = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; FIMD_MAX; i++) &#123;</span><br><span class="line">        <span class="comment">/* global structure */</span></span><br><span class="line">        fbfimd-&gt;fbdev[i] = kzalloc(<span class="keyword">sizeof</span>(struct s3cfb_global), GFP_KERNEL);</span><br><span class="line">        fbdev[i] = fbfimd-&gt;fbdev[i];</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        fbdev[i]-&gt;dev = &amp;pdev-&gt;dev;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_MACH_SMDK4X12) || defined(CONFIG_FB_S5P_AMS369FG06)</span></span><br><span class="line">        s3cfb_set_lcd_info(fbdev[i]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*获取LCD配置信息*/</span></span><br><span class="line">        <span class="comment">/* platform_data*/</span></span><br><span class="line">        pdata = to_fb_plat(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pdata-&gt;lcd)</span><br><span class="line">            fbdev[i]-&gt;lcd = (struct s3cfb_lcd *)pdata-&gt;lcd;</span><br><span class="line">        <span class="comment">/*配置GPIO端口*/</span></span><br><span class="line">        <span class="keyword">if</span> (pdata-&gt;cfg_gpio)</span><br><span class="line">            pdata-&gt;cfg_gpio(pdev);</span><br><span class="line">        <span class="comment">/*设置时钟参数*/</span></span><br><span class="line">        <span class="keyword">if</span> (pdata-&gt;clk_on)</span><br><span class="line">            pdata-&gt;clk_on(pdev, &amp;fbdev[i]-&gt;clock);</span><br><span class="line">        <span class="comment">/*获取LCD平台设备所使用的IO端口资源，注意这个IORESOURCE_MEM标志和LCD平台设备定义中的一致*/</span></span><br><span class="line">        <span class="comment">/* io memory */</span></span><br><span class="line">        res = platform_get_resource(pdev, IORESOURCE_MEM, i);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">/*申请LCD IO端口所占用的IO空间(注意理解IO空间和内存空间的区别),request_mem_region定义在ioport.h中*/</span></span><br><span class="line">        res = request_mem_region(res-&gt;start,</span><br><span class="line">                    res-&gt;end - res-&gt;start + <span class="number">1</span>, pdev-&gt;name);</span><br><span class="line">        ......</span><br><span class="line">         <span class="comment">/*将LCD的IO端口占用的这段IO空间映射到内存的虚拟地址，ioremap定义在io.h中</span></span><br><span class="line"><span class="comment">         * 注意：IO空间要映射后才能使用，以后对虚拟地址的操作就是对IO空间的操作*/</span></span><br><span class="line">        fbdev[i]-&gt;regs = ioremap(res-&gt;start, res-&gt;end - res-&gt;start + <span class="number">1</span>);</span><br><span class="line">        fbdev[i]-&gt;regs_org = fbdev[i]-&gt;regs;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        spin_lock_init(&amp;fbdev[i]-&gt;vsync_slock);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FB_S5P_VSYNC_THREAD)</span></span><br><span class="line">        INIT_LIST_HEAD(&amp;fbdev[i]-&gt;update_regs_list);</span><br><span class="line">        mutex_init(&amp;fbdev[i]-&gt;update_regs_list_lock);</span><br><span class="line">        init_kthread_worker(&amp;fbdev[i]-&gt;update_regs_worker);</span><br><span class="line"></span><br><span class="line">        fbdev[i]-&gt;update_regs_thread = kthread_run(kthread_worker_fn,</span><br><span class="line">                &amp;fbdev[i]-&gt;update_regs_worker, <span class="string">&quot;s3c-fb&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">        init_kthread_work(&amp;fbdev[i]-&gt;update_regs_work, s3c_fb_update_regs_handler);</span><br><span class="line">        fbdev[i]-&gt;timeline = sw_sync_timeline_create(<span class="string">&quot;s3c-fb&quot;</span>);</span><br><span class="line">        fbdev[i]-&gt;timeline_max = <span class="number">1</span>;</span><br><span class="line">        fbdev[i]-&gt;support_fence = FENCE_SUPPORT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* irq */</span></span><br><span class="line">        fbdev[i]-&gt;irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (request_irq(fbdev[i]-&gt;irq, s3cfb_irq_frame, IRQF_SHARED,</span><br><span class="line">                pdev-&gt;name, fbdev[i])) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_TRACE_UNDERRUN</span></span><br><span class="line">        <span class="keyword">if</span> (request_irq(platform_get_irq(pdev, <span class="number">1</span>), s3cfb_irq_fifo,</span><br><span class="line">                IRQF_DISABLED, pdev-&gt;name, fbdev[i])) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s3cfb_set_fifo_interrupt(fbdev[i], <span class="number">1</span>);</span><br><span class="line">        dev_info(fbdev[i]-&gt;dev, <span class="string">&quot;fifo underrun trace\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_MDNIE</span></span><br><span class="line">        <span class="comment">/*  only FIMD0 is supported */</span></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            mdnie_setup();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">/* hw setting */</span></span><br><span class="line">        s3cfb_init_global(fbdev[i]);</span><br><span class="line"></span><br><span class="line">        fbdev[i]-&gt;system_state = POWER_ON;</span><br><span class="line">        mutex_init(&amp;fbdev[i]-&gt;output_lock);</span><br><span class="line"></span><br><span class="line">        spin_lock_init(&amp;fbdev[i]-&gt;slock);</span><br><span class="line">        <span class="comment">/*为framebuffer分配空间，进行内存映射，填充fb_info*/</span></span><br><span class="line">        <span class="comment">/* alloc fb_info */</span></span><br><span class="line">        <span class="keyword">if</span> (s3cfb_alloc_framebuffer(fbdev[i], i)) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*注册fb设备到系统中*/</span></span><br><span class="line">        <span class="comment">/* register fb_info */</span></span><br><span class="line">        <span class="keyword">if</span> (s3cfb_register_framebuffer(fbdev[i])) &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* enable display */</span></span><br><span class="line">        s3cfb_set_clock(fbdev[i]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*  only FIMD0 is supported */</span></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pdata-&gt;set_display_path)</span><br><span class="line">                pdata-&gt;set_display_path();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_MDNIE</span></span><br><span class="line">            s3cfb_set_dualrgb(fbdev[i], S3C_DUALRGB_MDNIE);</span><br><span class="line">            mdnie_display_on();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*设置时钟使能window*/</span></span><br><span class="line">        s3cfb_enable_window(fbdev[<span class="number">0</span>], pdata-&gt;default_win);</span><br><span class="line"></span><br><span class="line">        s3cfb_update_power_state(fbdev[i], pdata-&gt;default_win,</span><br><span class="line">                    FB_BLANK_UNBLANK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Set alpha value width to 8-bit */</span></span><br><span class="line">        s3cfb_set_alpha_value_width(fbdev[i], i);</span><br><span class="line">        <span class="comment">/*使能display*/</span></span><br><span class="line">        s3cfb_display_on(fbdev[i]);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_CPU_EXYNOS4212) || defined(CONFIG_CPU_EXYNOS4412)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BUSFREQ_OPP</span></span><br><span class="line">        <span class="comment">/* To lock bus frequency in OPP mode */</span></span><br><span class="line">        fbdev[i]-&gt;bus_dev = dev_get(<span class="string">&quot;exynos-busfreq&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAS_WAKELOCK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAS_EARLYSUSPEND</span></span><br><span class="line">        fbdev[i]-&gt;early_suspend.suspend = s3cfb_early_suspend;</span><br><span class="line">        fbdev[i]-&gt;early_suspend.resume = s3cfb_late_resume;</span><br><span class="line">        fbdev[i]-&gt;early_suspend.level = EARLY_SUSPEND_LEVEL_DISABLE_FB;</span><br><span class="line"></span><br><span class="line">        register_early_suspend(&amp;fbdev[i]-&gt;early_suspend);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FB_S5P_VSYNC_THREAD)</span></span><br><span class="line">        init_waitqueue_head(&amp;fbdev[i]-&gt;vsync_info.wait);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Create vsync thread */</span></span><br><span class="line">        mutex_init(&amp;fbdev[i]-&gt;vsync_info.irq_lock);</span><br><span class="line"></span><br><span class="line">        fbdev[i]-&gt;vsync_info.thread = kthread_run(</span><br><span class="line">                        s3cfb_wait_for_vsync_thread,</span><br><span class="line">                        fbdev[i], <span class="string">&quot;s3c-fb-vsync&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (fbdev[i]-&gt;vsync_info.thread == ERR_PTR(-ENOMEM)) &#123;</span><br><span class="line">            dev_err(fbdev[i]-&gt;dev, <span class="string">&quot;failed to run vsync thread\n&quot;</span>);</span><br><span class="line">            fbdev[i]-&gt;vsync_info.thread = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">/*对设备文件系统的支持，创建fb设备文件*/</span></span><br><span class="line">        ret = device_create_file(fbdev[i]-&gt;dev, &amp;dev_attr_fimd_dump);</span><br><span class="line"></span><br><span class="line">        ret = device_create_file(fbdev[i]-&gt;dev, &amp;dev_attr_ielcd_dump);</span><br><span class="line"></span><br><span class="line">        ret = device_create_file(fbdev[i]-&gt;dev, &amp;dev_attr_orient);</span><br><span class="line"></span><br><span class="line">        ret = device_create_file(fbdev[i]-&gt;fb[pdata-&gt;default_win]-&gt;dev,</span><br><span class="line">                    &amp;dev_attr_vsync_event);</span><br><span class="line"></span><br><span class="line">        ret = device_create_file(fbdev[i]-&gt;fb[pdata-&gt;default_win]-&gt;dev,</span><br><span class="line">                    &amp;dev_attr_vpost_event);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_GD2EVF</span></span><br><span class="line">        ret = device_create_file(fbdev[i]-&gt;dev, &amp;dev_attr_lcd_switch);</span><br><span class="line">        ......</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        fbdev[i]-&gt;ielcd_regs = ioremap(EXYNOS4_PA_LCD_LITE0, SZ_1K);</span><br><span class="line">        fbdev[i]-&gt;dsim_regs = ioremap(S5P_PA_DSIM0, SZ_1K);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_LCD_INIT</span></span><br><span class="line">    <span class="comment">/* panel control */</span></span><br><span class="line">    <span class="keyword">if</span> (pdata-&gt;backlight_on)</span><br><span class="line">        pdata-&gt;backlight_on(pdev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pdata-&gt;lcd_on)</span><br><span class="line">        pdata-&gt;lcd_on(pdev);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ret = device_create_file(&amp;(pdev-&gt;dev), &amp;dev_attr_win_power);</span><br><span class="line">    .......</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DISPLAY_BOOT_PROGRESS</span></span><br><span class="line">    <span class="keyword">if</span> (!(readl(S5P_INFORM2)))</span><br><span class="line">        s3cfb_start_progress(fbdev[<span class="number">0</span>]-&gt;fb[pdata-&gt;default_win]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE_BUSFREQ_LOCK</span></span><br><span class="line">    atomic_set(&amp;fbdev[<span class="number">0</span>]-&gt;busfreq_lock_cnt, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    dev_info(fbdev[<span class="number">0</span>]-&gt;dev, <span class="string">&quot;registered successfully\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="（1）、pdata-gt-cfg-gpio-pdev"><a href="#（1）、pdata-gt-cfg-gpio-pdev" class="headerlink" title="（1）、pdata-&gt;cfg_gpio(pdev)"></a>（1）、pdata-&gt;cfg_gpio(pdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\arch\arm\plat-s5p\include\plat\fb-s5p.h</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s3c_platform_fb</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span>        hw_ver;</span><br><span class="line">    <span class="keyword">char</span>        clk_name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">int</span>        nr_wins;</span><br><span class="line">    <span class="keyword">int</span>        nr_buffers[<span class="number">5</span>];</span><br><span class="line">    <span class="keyword">int</span>        default_win;</span><br><span class="line">    <span class="keyword">int</span>        swap;</span><br><span class="line">    <span class="keyword">void</span>        *lcd;</span><br><span class="line">    <span class="keyword">void</span>        (*set_display_path)(<span class="keyword">void</span>);</span><br><span class="line">    <span class="keyword">void</span>        (*cfg_gpio)(struct platform_device *dev);</span><br><span class="line">    <span class="keyword">int</span>        (*backlight_on)(struct platform_device *dev);</span><br><span class="line">    <span class="keyword">int</span>        (*backlight_off)(struct platform_device *dev);</span><br><span class="line">    <span class="keyword">int</span>        (*lcd_on)(struct platform_device *dev);</span><br><span class="line">    <span class="keyword">int</span>        (*lcd_off)(struct platform_device *dev);</span><br><span class="line">    <span class="keyword">int</span>        (*clk_on)(struct platform_device *pdev, struct clk **s3cfb_clk);</span><br><span class="line">    <span class="keyword">int</span>        (*clk_off)(struct platform_device *pdev, struct clk **clk);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\arch\arm\mach-exynos\setup-fb-s5p.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_FB_S5P_TINY4412)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">s3cfb_cfg_gpio</span><span class="params">(struct platform_device *pdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s3cfb_gpio_setup_24bpp(EXYNOS4_GPF0(<span class="number">0</span>), <span class="number">8</span>, S3C_GPIO_SFN(<span class="number">2</span>), S5P_GPIO_DRVSTR_LV3);</span><br><span class="line">    s3cfb_gpio_setup_24bpp(EXYNOS4_GPF1(<span class="number">0</span>), <span class="number">8</span>, S3C_GPIO_SFN(<span class="number">2</span>), S5P_GPIO_DRVSTR_LV3);</span><br><span class="line">    s3cfb_gpio_setup_24bpp(EXYNOS4_GPF2(<span class="number">0</span>), <span class="number">8</span>, S3C_GPIO_SFN(<span class="number">2</span>), S5P_GPIO_DRVSTR_LV3);</span><br><span class="line">    s3cfb_gpio_setup_24bpp(EXYNOS4_GPF3(<span class="number">0</span>), <span class="number">4</span>, S3C_GPIO_SFN(<span class="number">2</span>), S5P_GPIO_DRVSTR_LV3);</span><br><span class="line"></span><br><span class="line">    s5p_gpio_set_drvstr(EXYNOS4_GPF0(<span class="number">0</span>), S5P_GPIO_DRVSTR_LV2);</span><br><span class="line">    s5p_gpio_set_drvstr(EXYNOS4_GPF0(<span class="number">1</span>), S5P_GPIO_DRVSTR_LV2);</span><br><span class="line">    s5p_gpio_set_drvstr(EXYNOS4_GPF0(<span class="number">2</span>), S5P_GPIO_DRVSTR_LV2);</span><br><span class="line">    s5p_gpio_set_drvstr(EXYNOS4_GPF0(<span class="number">3</span>), S5P_GPIO_DRVSTR_LV2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（2）、pdata-gt-clk-on-pdev-amp-fbdev-i-gt-clock"><a href="#（2）、pdata-gt-clk-on-pdev-amp-fbdev-i-gt-clock" class="headerlink" title="（2）、pdata-&gt;clk_on(pdev, &amp;fbdev[i]-&gt;clock)"></a>（2）、pdata-&gt;clk_on(pdev, &amp;fbdev[i]-&gt;clock)</h5><blockquote>
<p>Log：<br>&lt;6&gt;[    0.432476] s3cfb s3cfb.0: src_clk=800000000, vclk=67184640, div=12(11), rate=72727272</p>
</blockquote>
<blockquote>
<p>&lt;6&gt;[    0.432488] s3cfb s3cfb.0: fimd sclk rate 66666666, clkdiv 0xfffffb</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">static unsigned int get_clk_rate(struct platform_device *pdev, struct clk *sclk)</span><br><span class="line">&#123;</span><br><span class="line">    struct s3c_platform_fb *pdata &#x3D; pdev-&gt;dev.platform_data;</span><br><span class="line">    struct s3cfb_lcd *lcd &#x3D; (struct s3cfb_lcd *)pdata-&gt;lcd;</span><br><span class="line">    struct s3cfb_lcd_timing *timing &#x3D; &amp;lcd-&gt;timing;</span><br><span class="line">    u32 src_clk, vclk, div, rate;</span><br><span class="line">    u32 vclk_limit, div_limit, fimd_div;</span><br><span class="line"></span><br><span class="line">    src_clk &#x3D; clk_get_rate(sclk);</span><br><span class="line"></span><br><span class="line">    vclk &#x3D; (lcd-&gt;freq *</span><br><span class="line">        (timing-&gt;h_bp + timing-&gt;h_fp + timing-&gt;h_sw + lcd-&gt;width) *</span><br><span class="line">        (timing-&gt;v_bp + timing-&gt;v_fp + timing-&gt;v_sw + lcd-&gt;height));</span><br><span class="line"></span><br><span class="line">    if (!vclk)</span><br><span class="line">        vclk &#x3D; src_clk;</span><br><span class="line"></span><br><span class="line">    div &#x3D; DIV_ROUND_CLOSEST(src_clk, vclk);</span><br><span class="line"></span><br><span class="line">    if (lcd-&gt;freq_limit) &#123;</span><br><span class="line">        vclk_limit &#x3D; (lcd-&gt;freq_limit *</span><br><span class="line">            (timing-&gt;h_bp + timing-&gt;h_fp + timing-&gt;h_sw + lcd-&gt;width) *</span><br><span class="line">            (timing-&gt;v_bp + timing-&gt;v_fp + timing-&gt;v_sw + lcd-&gt;height));</span><br><span class="line"></span><br><span class="line">        div_limit &#x3D; DIV_ROUND_CLOSEST(src_clk, vclk_limit);</span><br><span class="line"></span><br><span class="line">        fimd_div &#x3D; gcd(div, div_limit);</span><br><span class="line"></span><br><span class="line">        if (div&#x2F;fimd_div &lt;&#x3D; 16)</span><br><span class="line">            div &#x2F;&#x3D; fimd_div;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!div) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, &quot;div(%d) should be non-zero\n&quot;, div);</span><br><span class="line">        div &#x3D; 1;</span><br><span class="line">    &#125; else if (div &gt; 16) &#123;</span><br><span class="line">        for (fimd_div &#x3D; 2; fimd_div &lt;&#x3D; div; fimd_div++) &#123;</span><br><span class="line">            if ((div%fimd_div &#x3D;&#x3D; 0) &amp;&amp; (div&#x2F;fimd_div &lt;&#x3D; 16))</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        div &#x2F;&#x3D; fimd_div;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    div &#x3D; (div &gt; 16) ? 16 : div;</span><br><span class="line">    rate &#x3D; src_clk &#x2F; div;</span><br><span class="line"></span><br><span class="line">    if ((src_clk % rate) &amp;&amp; (div !&#x3D; 1)) &#123;</span><br><span class="line">        div--;</span><br><span class="line">        rate &#x3D; src_clk &#x2F; div;</span><br><span class="line">        if (!(src_clk % rate))</span><br><span class="line">            rate--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, &quot;src_clk&#x3D;%d, vclk&#x3D;%d, div&#x3D;%d(%d), rate&#x3D;%d\n&quot;,</span><br><span class="line">        src_clk, vclk, DIV_ROUND_CLOSEST(src_clk, vclk), div, rate);</span><br><span class="line"></span><br><span class="line">    return rate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int s3cfb_clk_on(struct platform_device *pdev, struct clk **s3cfb_clk)</span><br><span class="line">&#123;</span><br><span class="line">    struct clk *sclk &#x3D; NULL;</span><br><span class="line">    struct clk *mout_mpll &#x3D; NULL;</span><br><span class="line">    struct clk *lcd_clk &#x3D; NULL;</span><br><span class="line">    struct clksrc_clk *src_clk &#x3D; NULL;</span><br><span class="line">    struct s3c_platform_fb *pdata &#x3D; pdev-&gt;dev.platform_data;</span><br><span class="line">    struct s3cfb_lcd *lcd &#x3D; (struct s3cfb_lcd *)pdata-&gt;lcd;</span><br><span class="line"></span><br><span class="line">    u32 rate &#x3D; 0, clkdiv &#x3D; 0;</span><br><span class="line">    int ret &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    lcd_clk &#x3D; clk_get(&amp;pdev-&gt;dev, &quot;lcd&quot;);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    ret &#x3D; clk_enable(lcd_clk);</span><br><span class="line">    ......</span><br><span class="line">    clk_put(lcd_clk);</span><br><span class="line"></span><br><span class="line">    sclk &#x3D; clk_get(&amp;pdev-&gt;dev, &quot;sclk_fimd&quot;);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    if (soc_is_exynos4210())</span><br><span class="line">        mout_mpll &#x3D; clk_get(&amp;pdev-&gt;dev, &quot;mout_mpll&quot;);</span><br><span class="line">    else</span><br><span class="line">        mout_mpll &#x3D; clk_get(&amp;pdev-&gt;dev, &quot;mout_mpll_user&quot;);</span><br><span class="line">    ......</span><br><span class="line">    ret &#x3D; clk_set_parent(sclk, mout_mpll);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    if (!lcd-&gt;vclk) &#123;</span><br><span class="line">        rate &#x3D; get_clk_rate(pdev, mout_mpll);</span><br><span class="line">        if (!rate)</span><br><span class="line">            rate &#x3D; 800 * MHZ;    &#x2F;* MOUT PLL *&#x2F;</span><br><span class="line">        lcd-&gt;vclk &#x3D; rate;</span><br><span class="line">    &#125; else</span><br><span class="line">        rate &#x3D; lcd-&gt;vclk;</span><br><span class="line"></span><br><span class="line">    ret &#x3D; clk_set_rate(sclk, rate);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    dev_dbg(&amp;pdev-&gt;dev, &quot;set fimd sclk rate to %d\n&quot;, rate);</span><br><span class="line"></span><br><span class="line">    clk_put(mout_mpll);</span><br><span class="line"></span><br><span class="line">    ret &#x3D; clk_enable(sclk);</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    *s3cfb_clk &#x3D; sclk;</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_FB_S5P_MIPI_DSIM</span><br><span class="line">    s3cfb_mipi_clk_enable(1);</span><br><span class="line">#endif</span><br><span class="line">#ifdef CONFIG_FB_S5P_MDNIE</span><br><span class="line">    s3cfb_mdnie_clk_on(rate);</span><br><span class="line">#ifdef CONFIG_FB_MDNIE_PWM</span><br><span class="line">    s3cfb_mdnie_pwm_clk_on();</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    src_clk &#x3D; container_of(sclk, struct clksrc_clk, clk);</span><br><span class="line">    clkdiv &#x3D; __raw_readl(src_clk-&gt;reg_div.reg);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, &quot;fimd sclk rate %ld, clkdiv 0x%x\n&quot;,</span><br><span class="line">        clk_get_rate(sclk), clkdiv);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="（3）、s3cfb-init-global-fbdev-i"><a href="#（3）、s3cfb-init-global-fbdev-i" class="headerlink" title="（3）、s3cfb_init_global(fbdev[i])"></a>（3）、s3cfb_init_global(fbdev[i])</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_ops.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_init_global</span><span class="params">(struct s3cfb_global *fbdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fbdev-&gt;output = OUTPUT_RGB;</span><br><span class="line">    fbdev-&gt;rgb_mode = MODE_RGB_P;</span><br><span class="line"></span><br><span class="line">    fbdev-&gt;wq_count = <span class="number">0</span>;</span><br><span class="line">    init_waitqueue_head(&amp;fbdev-&gt;wq);</span><br><span class="line">    mutex_init(&amp;fbdev-&gt;lock);</span><br><span class="line"></span><br><span class="line">    s3cfb_set_output(fbdev);</span><br><span class="line">    s3cfb_set_display_mode(fbdev);</span><br><span class="line">    s3cfb_set_polarity(fbdev);</span><br><span class="line">    s3cfb_set_timing(fbdev);</span><br><span class="line">    s3cfb_set_lcd_size(fbdev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-1、s3cfb-set-output"><a href="#3-1、s3cfb-set-output" class="headerlink" title="3.1、s3cfb_set_output()"></a>3.1、s3cfb_set_output()</h5><blockquote>
<pre><code>fbdev-&gt;output = OUTPUT_RGB;// OUTPUT_RGB == 0
fbdev-&gt;rgb_mode = MODE_RGB_P;// MODE_RGB_P == 0
Line 399: &lt;4&gt;[    0.432589] zjj.android.display.sys s3cfb_set_output s3cfb_fimd6x.c S3C_VIDCON0 = 0
Line 401: &lt;4&gt;[    0.432595] zjj.android.display.sys s3cfb_set_output s3cfb_fimd6x.c S3C_VIDCON2 = 0</code></pre>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_fimd6x.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_set_output</span><span class="params">(struct s3cfb_global *ctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 cfg;</span><br><span class="line"></span><br><span class="line">    cfg = readl(ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line">    cfg &amp;= ~S3C_VIDCON0_VIDOUT_MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_RGB)</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_RGB;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_ITU)</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_ITU;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_I80LDI0) &#123;</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_I80LDI0;</span><br><span class="line">        cfg |= S3C_VIDCON0_DSI_ENABLE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_I80LDI1)</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_I80LDI1;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_WB_RGB)</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_WB_RGB;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_WB_I80LDI0)</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_WB_I80LDI0;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_WB_I80LDI1)</span><br><span class="line">        cfg |= S3C_VIDCON0_VIDOUT_WB_I80LDI1;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        dev_err(ctrl-&gt;dev, <span class="string">&quot;invalid output type: %d\n&quot;</span>, ctrl-&gt;output);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line"></span><br><span class="line">    cfg = readl(ctrl-&gt;regs + S3C_VIDCON2);</span><br><span class="line">    cfg &amp;= ~(S3C_VIDCON2_WB_MASK | S3C_VIDCON2_TVFORMATSEL_MASK | \</span><br><span class="line">                    S3C_VIDCON2_TVFORMATSEL_YUV_MASK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_RGB)</span><br><span class="line">        cfg |= S3C_VIDCON2_WB_DISABLE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_ITU)</span><br><span class="line">        cfg |= S3C_VIDCON2_WB_DISABLE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_I80LDI0)</span><br><span class="line">        cfg |= S3C_VIDCON2_WB_DISABLE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_I80LDI1)</span><br><span class="line">        cfg |= S3C_VIDCON2_WB_DISABLE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_WB_RGB)</span><br><span class="line">        cfg |= (S3C_VIDCON2_WB_ENABLE | S3C_VIDCON2_TVFORMATSEL_SW | \</span><br><span class="line">                    S3C_VIDCON2_TVFORMATSEL_YUV444);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_WB_I80LDI0)</span><br><span class="line">        cfg |= (S3C_VIDCON2_WB_ENABLE | S3C_VIDCON2_TVFORMATSEL_SW | \</span><br><span class="line">                    S3C_VIDCON2_TVFORMATSEL_YUV444);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_WB_I80LDI1)</span><br><span class="line">        cfg |= (S3C_VIDCON2_WB_ENABLE | S3C_VIDCON2_TVFORMATSEL_SW | \</span><br><span class="line">                    S3C_VIDCON2_TVFORMATSEL_YUV444);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        dev_err(ctrl-&gt;dev, <span class="string">&quot;invalid output type: %d\n&quot;</span>, ctrl-&gt;output);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FB_RGBA_ORDER)</span></span><br><span class="line">    <span class="comment">/* Change format to BGR order */</span></span><br><span class="line">    cfg &amp;= ~(<span class="number">0x3F0000</span>);</span><br><span class="line">    cfg |= <span class="number">0x240000</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDCON2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctrl-&gt;output == OUTPUT_I80LDI0) &#123;</span><br><span class="line">        cfg = readl(ctrl-&gt;regs + S3C_I80IFCONA0);</span><br><span class="line">        cfg |= ((<span class="number">1</span>&lt;&lt;<span class="number">0</span>)|(<span class="number">1</span>&lt;&lt;<span class="number">8</span>));</span><br><span class="line">        writel(cfg, ctrl-&gt;regs + S3C_I80IFCONA0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2、s3cfb-set-display-mode"><a href="#3-2、s3cfb-set-display-mode" class="headerlink" title="3.2、s3cfb_set_display_mode()"></a>3.2、s3cfb_set_display_mode()</h5><blockquote>
<pre><code>Line 403: &lt;4&gt;[    0.432600] zjj.android.display.sys s3cfb_set_display_mode s3cfb_fimd6x.c </code></pre>
</blockquote>
<pre><code>Line 405: &lt;4&gt;[    0.432606] zjj.android.display.sys s3cfb_set_display_mode s3cfb_fimd6x.c S3C_VIDCON0 = 0</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_fimd6x.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_set_display_mode</span><span class="params">(struct s3cfb_global *ctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u32 cfg;</span><br><span class="line"></span><br><span class="line">    cfg = readl(ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line">    cfg &amp;= ~S3C_VIDCON0_PNRMODE_MASK;</span><br><span class="line">    cfg |= (ctrl-&gt;rgb_mode &lt;&lt; S3C_VIDCON0_PNRMODE_SHIFT);</span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-3、s3cfb-set-polarity-fbdev"><a href="#3-3、s3cfb-set-polarity-fbdev" class="headerlink" title="3.3、s3cfb_set_polarity(fbdev)"></a>3.3、s3cfb_set_polarity(fbdev)</h5><blockquote>
<pre><code>Line 407: &lt;4&gt;[    0.432611] zjj.android.display.sys s3cfb_set_polarity s3cfb_fimd6x.c </code></pre>
<p>   Line 409: &lt;4&gt;[    0.432617] zjj.android.display.sys s3cfb_set_polarity s3cfb_fimd6x.c S3C_VIDCON1 = 680 //二进制：1101.0000000<br>G:\Android-5.0.2\linux-3.0.86-20170221\linux-3.0.86\arch\arm\plat-s5p\include\plat\regs-fb-s5p.h<br>   #define S3C_VIDCON1_FIXVCLK_VCLK_RUN_VDEN_DIS    (3 &lt;&lt; 9)<br>   #define S3C_VIDCON1_IVCLK_RISING_EDGE        (1 &lt;&lt; 7)<br>   1&lt;&lt;7 || 11&lt;&lt;9 == 1101.0000000 </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_set_polarity</span><span class="params">(struct s3cfb_global *ctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd_polarity</span> *<span class="title">pol</span>;</span></span><br><span class="line">    u32 cfg;</span><br><span class="line"></span><br><span class="line">    pol = &amp;ctrl-&gt;lcd-&gt;polarity;</span><br><span class="line">    cfg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set VCLK hold scheme */</span></span><br><span class="line">    cfg &amp;= S3C_VIDCON1_FIXVCLK_MASK;</span><br><span class="line">    cfg |= S3C_VIDCON1_FIXVCLK_VCLK_RUN_VDEN_DIS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pol-&gt;rise_vclk)</span><br><span class="line">        cfg |= S3C_VIDCON1_IVCLK_RISING_EDGE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pol-&gt;inv_hsync)</span><br><span class="line">        cfg |= S3C_VIDCON1_IHSYNC_INVERT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pol-&gt;inv_vsync)</span><br><span class="line">        cfg |= S3C_VIDCON1_IVSYNC_INVERT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pol-&gt;inv_vden)</span><br><span class="line">        cfg |= S3C_VIDCON1_IVDEN_INVERT;</span><br><span class="line"></span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDCON1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-4、s3cfb-set-timing-fbdev"><a href="#3-4、s3cfb-set-timing-fbdev" class="headerlink" title="3.4、s3cfb_set_timing(fbdev)"></a>3.4、s3cfb_set_timing(fbdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_set_timing</span><span class="params">(struct s3cfb_global *ctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd_timing</span> *<span class="title">time</span>;</span></span><br><span class="line">    u32 cfg;</span><br><span class="line"></span><br><span class="line">    time = &amp;ctrl-&gt;lcd-&gt;timing;</span><br><span class="line">    cfg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cfg |= S3C_VIDTCON0_VBPDE(time-&gt;v_bpe - <span class="number">1</span>);</span><br><span class="line">    cfg |= S3C_VIDTCON0_VBPD(time-&gt;v_bp - <span class="number">1</span>);</span><br><span class="line">    cfg |= S3C_VIDTCON0_VFPD(time-&gt;v_fp - <span class="number">1</span>);</span><br><span class="line">    cfg |= S3C_VIDTCON0_VSPW(time-&gt;v_sw - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDTCON0);</span><br><span class="line"></span><br><span class="line">    cfg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cfg |= S3C_VIDTCON1_VFPDE(time-&gt;v_fpe - <span class="number">1</span>);</span><br><span class="line">    cfg |= S3C_VIDTCON1_HBPD(time-&gt;h_bp - <span class="number">1</span>);</span><br><span class="line">    cfg |= S3C_VIDTCON1_HFPD(time-&gt;h_fp - <span class="number">1</span>);</span><br><span class="line">    cfg |= S3C_VIDTCON1_HSPW(time-&gt;h_sw - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDTCON1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* s3cfb configs for supported LCD */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd</span> <span class="title">wxga_hd700</span> = &#123;</span></span><br><span class="line">    .width = <span class="number">800</span>,</span><br><span class="line">    .height = <span class="number">1280</span>,</span><br><span class="line">    .p_width = <span class="number">94</span>,</span><br><span class="line">    .p_height = <span class="number">151</span>,</span><br><span class="line">    .bpp = <span class="number">24</span>,</span><br><span class="line">    .freq = <span class="number">60</span>,</span><br><span class="line"></span><br><span class="line">    .timing = &#123;</span><br><span class="line">        .h_fp = <span class="number">20</span>,</span><br><span class="line">        .h_bp = <span class="number">20</span>,</span><br><span class="line">        .h_sw = <span class="number">24</span>,</span><br><span class="line">        .v_fp =  <span class="number">4</span>,</span><br><span class="line">        .v_fpe = <span class="number">1</span>,</span><br><span class="line">        .v_bp =  <span class="number">4</span>,</span><br><span class="line">        .v_bpe = <span class="number">1</span>,</span><br><span class="line">        .v_sw =  <span class="number">8</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    .polarity = &#123;</span><br><span class="line">        .rise_vclk = <span class="number">1</span>,</span><br><span class="line">        .inv_hsync = <span class="number">0</span>,</span><br><span class="line">        .inv_vsync = <span class="number">0</span>,</span><br><span class="line">        .inv_vden = <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Line <span class="number">411</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.432622</span>] zjj.android.display.sys s3cfb_set_timing s3cfb_fimd6x.c </span><br><span class="line">    Line <span class="number">413</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.432627</span>] zjj.android.display.sys s3cfb_set_timing s3cfb_fimd6x.c  S3C_VIDTCON0 = <span class="number">30307</span> <span class="comment">//11000000,1100000111</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    cfg |= S3C_VIDTCON0_VBPDE(time-&gt;v_bpe - <span class="number">1</span>); <span class="comment">// 0  0 &lt;&lt; 24</span></span><br><span class="line">    cfg |= S3C_VIDTCON0_VBPD(time-&gt;v_bp - <span class="number">1</span>); <span class="comment">// 3   11 &lt;&lt; 16 </span></span><br><span class="line">    cfg |= S3C_VIDTCON0_VFPD(time-&gt;v_fp - <span class="number">1</span>); <span class="comment">// 3   11&lt;&lt;8</span></span><br><span class="line">    cfg |= S3C_VIDTCON0_VSPW(time-&gt;v_sw - <span class="number">1</span>); <span class="comment">// 7   111</span></span><br><span class="line">    </span><br><span class="line">    Line <span class="number">413</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.432544</span>] zjj.android.display.sys s3cfb_set_timing s3cfb_fimd6x.c  S3C_VIDTCON0 = <span class="number">30307</span> <span class="comment">//100110001001100010111</span></span><br><span class="line">    cfg |= S3C_VIDTCON1_VFPDE(time-&gt;v_fpe - <span class="number">1</span>); <span class="comment">// 0  0 &lt;&lt; 24</span></span><br><span class="line">    cfg |= S3C_VIDTCON1_HBPD(time-&gt;h_bp - <span class="number">1</span>); <span class="comment">// 19  10011 &lt;&lt;16</span></span><br><span class="line">    cfg |= S3C_VIDTCON1_HFPD(time-&gt;h_fp - <span class="number">1</span>); <span class="comment">// 19  10011 &lt;&lt;8</span></span><br><span class="line">    cfg |= S3C_VIDTCON1_HSPW(time-&gt;h_sw - <span class="number">1</span>); <span class="comment">// 23  10111 &lt;&lt;0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">////////////</span></span><br><span class="line">    <span class="comment">/* VIDTCON0 */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON0_VBPDE(x)            (((x) &amp; 0xff) &lt;&lt; 24)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON0_VBPD(x)            (((x) &amp; 0xff) &lt;&lt; 16)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON0_VFPD(x)            (((x) &amp; 0xff) &lt;&lt; 8)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON0_VSPW(x)            (((x) &amp; 0xff) &lt;&lt; 0)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* VIDTCON1 */</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON1_VFPDE(x)            (((x) &amp; 0xff) &lt;&lt; 24)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON1_HBPD(x)            (((x) &amp; 0xff) &lt;&lt; 16)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON1_HFPD(x)            (((x) &amp; 0xff) &lt;&lt; 8)</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> S3C_VIDTCON1_HSPW(x)            (((x) &amp; 0xff) &lt;&lt; 0)</span></span><br></pre></td></tr></table></figure>

<h5 id="3-5、s3cfb-set-lcd-size-fbdev"><a href="#3-5、s3cfb-set-lcd-size-fbdev" class="headerlink" title="3.5、s3cfb_set_lcd_size(fbdev)"></a>3.5、s3cfb_set_lcd_size(fbdev)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Line <span class="number">417</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.432639</span>] zjj.android.display.sys s3cfb_set_lcd_size s3cfb_fimd6x.c  S3C_VIDTCON2 = <span class="number">27f</span>b1f  <span class="comment">//二进制： 1001111111101100011111</span></span><br><span class="line"></span><br><span class="line">#define S3C_VIDTCON2_LINEVAL(x)            (((x) &amp; <span class="number">0x7ff</span>) &lt;&lt; <span class="number">11</span>)</span><br><span class="line">#define S3C_VIDTCON2_HOZVAL(x)            (((x) &amp; <span class="number">0x7ff</span>) &lt;&lt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">1279</span>+<span class="number">1</span>=<span class="number">1280</span>  HOZVAL [<span class="number">10</span>:<span class="number">0</span>]  <span class="number">10011111111</span></span><br><span class="line"><span class="number">799</span>+<span class="number">1</span>=<span class="number">800</span>    LINEVAL [<span class="number">21</span>:<span class="number">11</span>] <span class="number">01100011111</span></span><br><span class="line">NOTE: HOZVAL = (Horizontal display size) – <span class="number">1</span> <span class="keyword">and</span> LINEVAL = (Vertical display size) – <span class="number">1</span></span><br></pre></td></tr></table></figure>


<h5 id="（4）、s3cfb-alloc-framebuffer-fbdev-i-i"><a href="#（4）、s3cfb-alloc-framebuffer-fbdev-i-i" class="headerlink" title="（4）、s3cfb_alloc_framebuffer(fbdev[i], i)"></a>（4）、s3cfb_alloc_framebuffer(fbdev[i], i)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_ops.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_alloc_framebuffer</span><span class="params">(struct s3cfb_global *fbdev, <span class="keyword">int</span> fimd_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3c_platform_fb</span> *<span class="title">pdata</span> = <span class="title">to_fb_plat</span>(<span class="title">fbdev</span>-&gt;<span class="title">dev</span>);</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">/* 分配 fb_info */</span></span><br><span class="line">    fbdev-&gt;fb = kmalloc(pdata-&gt;nr_wins *</span><br><span class="line">                <span class="keyword">sizeof</span>(struct fb_info *), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pdata-&gt;nr_wins; i++) &#123;</span><br><span class="line">        fbdev-&gt;fb[i] = framebuffer_alloc(<span class="keyword">sizeof</span>(struct s3cfb_window),</span><br><span class="line">                        fbdev-&gt;dev);</span><br><span class="line">        ......</span><br><span class="line">         <span class="comment">/* 初始化 fb_info */</span></span><br><span class="line">        ret = s3cfb_init_fbinfo(fbdev, i);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == pdata-&gt;default_win) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s3cfb_map_default_video_memory(fbdev,</span><br><span class="line">                        fbdev-&gt;fb[i], fimd_id)) &#123;</span><br><span class="line">                ......</span><br><span class="line">                ret = -ENOMEM;</span><br><span class="line">                <span class="keyword">goto</span> err_alloc_fb;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;(fbdev-&gt;initial_fix), &amp;(fbdev-&gt;fb[i]-&gt;fix), <span class="keyword">sizeof</span>(struct fb_fix_screeninfo));</span><br><span class="line">                <span class="built_in">memcpy</span>(&amp;(fbdev-&gt;initial_var), &amp;(fbdev-&gt;fb[i]-&gt;var), <span class="keyword">sizeof</span>(struct fb_var_screeninfo));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sec_getlog_supply_fbinfo((<span class="keyword">void</span> *)fbdev-&gt;fb[i]-&gt;fix.smem_start,</span><br><span class="line">                     fbdev-&gt;fb[i]-&gt;var.xres,</span><br><span class="line">                     fbdev-&gt;fb[i]-&gt;var.yres,</span><br><span class="line">                     fbdev-&gt;fb[i]-&gt;var.bits_per_pixel, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4-1、framebuffer-alloc"><a href="#4-1、framebuffer-alloc" class="headerlink" title="4.1、framebuffer_alloc()"></a>4.1、framebuffer_alloc()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\fbsysfs.c</span><br><span class="line"><span class="function">struct fb_info *<span class="title">framebuffer_alloc</span><span class="params">(<span class="keyword">size_t</span> size, struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTES_PER_LONG (BITS_PER_LONG/8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PADDING (BYTES_PER_LONG - (sizeof(struct fb_info) % BYTES_PER_LONG))</span></span><br><span class="line">    <span class="keyword">int</span> fb_info_size = <span class="keyword">sizeof</span>(struct fb_info);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">info</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size)</span><br><span class="line">        fb_info_size += PADDING;</span><br><span class="line"></span><br><span class="line">    p = kzalloc(fb_info_size + size, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    info = (struct fb_info *) p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size)</span><br><span class="line">        info-&gt;par = p + fb_info_size;</span><br><span class="line"></span><br><span class="line">    info-&gt;device = dev;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_BACKLIGHT</span></span><br><span class="line">    mutex_init(&amp;info-&gt;bl_curve_mutex);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> PADDING</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> BYTES_PER_LONG</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(framebuffer_alloc);</span><br></pre></td></tr></table></figure>

<h5 id="4-2、s3cfb-init-fbinfo"><a href="#4-2、s3cfb-init-fbinfo" class="headerlink" title="4.2、s3cfb_init_fbinfo()"></a>4.2、s3cfb_init_fbinfo()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_init_fbinfo</span><span class="params">(struct s3cfb_global *fbdev, <span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_info</span> *<span class="title">fb</span> = <span class="title">fbdev</span>-&gt;<span class="title">fb</span>[<span class="title">id</span>];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> *<span class="title">fix</span> = &amp;<span class="title">fb</span>-&gt;<span class="title">fix</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> *<span class="title">var</span> = &amp;<span class="title">fb</span>-&gt;<span class="title">var</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_window</span> *<span class="title">win</span> = <span class="title">fb</span>-&gt;<span class="title">par</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_alpha</span> *<span class="title">alpha</span> = &amp;<span class="title">win</span>-&gt;<span class="title">alpha</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd</span> *<span class="title">lcd</span> = <span class="title">fbdev</span>-&gt;<span class="title">lcd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd_timing</span> *<span class="title">timing</span> = &amp;<span class="title">lcd</span>-&gt;<span class="title">timing</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(win, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct s3cfb_window));</span><br><span class="line">    platform_set_drvdata(to_platform_device(fbdev-&gt;dev), fb);</span><br><span class="line">    <span class="built_in">strcpy</span>(fix-&gt;id, S3CFB_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* fimd specific */</span></span><br><span class="line">    win-&gt;id = id;</span><br><span class="line">    win-&gt;path = DATA_PATH_DMA;</span><br><span class="line">    win-&gt;dma_burst = <span class="number">16</span>;</span><br><span class="line">    s3cfb_update_power_state(fbdev, win-&gt;id, FB_BLANK_POWERDOWN);</span><br><span class="line">    alpha-&gt;mode = PLANE_BLENDING;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* fbinfo */</span></span><br><span class="line">    fb-&gt;fbops = &amp;s3cfb_ops;</span><br><span class="line">    fb-&gt;flags = FBINFO_FLAG_DEFAULT;</span><br><span class="line">    fb-&gt;pseudo_palette = &amp;win-&gt;pseudo_pal;</span><br><span class="line">    <span class="comment">/* 设置 fix 固定的参数 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (CONFIG_FB_S5P_NR_BUFFERS != 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_CPU_EXYNOS4210)</span></span><br><span class="line">    fix-&gt;xpanstep = <span class="number">1</span>; <span class="comment">/*  xpanstep can be 1 if bits_per_pixel is 32 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    fix-&gt;xpanstep = <span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    fix-&gt;ypanstep = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    fix-&gt;xpanstep = <span class="number">0</span>;</span><br><span class="line">    fix-&gt;ypanstep = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    fix-&gt;type = FB_TYPE_PACKED_PIXELS;</span><br><span class="line">    fix-&gt;accel = FB_ACCEL_NONE;</span><br><span class="line">    fix-&gt;visual = FB_VISUAL_TRUECOLOR;</span><br><span class="line">     <span class="comment">/* 设置 var 可变的参数 */</span></span><br><span class="line">    var-&gt;xres = lcd-&gt;width;</span><br><span class="line">    var-&gt;yres = lcd-&gt;height;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FB_S5P_VIRTUAL)</span></span><br><span class="line">    var-&gt;xres_virtual = CONFIG_FB_S5P_X_VRES;</span><br><span class="line">    var-&gt;yres_virtual = CONFIG_FB_S5P_Y_VRES * CONFIG_FB_S5P_NR_BUFFERS;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    var-&gt;xres_virtual = var-&gt;xres;</span><br><span class="line">    var-&gt;yres_virtual = var-&gt;yres * CONFIG_FB_S5P_NR_BUFFERS;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    var-&gt;bits_per_pixel = <span class="number">32</span>;</span><br><span class="line">    var-&gt;xoffset = <span class="number">0</span>;</span><br><span class="line">    var-&gt;yoffset = <span class="number">0</span>;</span><br><span class="line">    var-&gt;width = lcd-&gt;p_width;</span><br><span class="line">    var-&gt;height = lcd-&gt;p_height;</span><br><span class="line">    var-&gt;transp.length = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    fix-&gt;line_length = var-&gt;xres_virtual * var-&gt;bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    fix-&gt;smem_len = fix-&gt;line_length * var-&gt;yres_virtual;</span><br><span class="line"></span><br><span class="line">    var-&gt;nonstd = <span class="number">0</span>;</span><br><span class="line">    var-&gt;activate = FB_ACTIVATE_NOW;</span><br><span class="line">    var-&gt;vmode = FB_VMODE_NONINTERLACED;</span><br><span class="line">    var-&gt;hsync_len = timing-&gt;h_sw;</span><br><span class="line">    var-&gt;vsync_len = timing-&gt;v_sw;</span><br><span class="line">    var-&gt;left_margin = timing-&gt;h_bp;</span><br><span class="line">    var-&gt;right_margin = timing-&gt;h_fp;</span><br><span class="line">    var-&gt;upper_margin = timing-&gt;v_bp;</span><br><span class="line">    var-&gt;lower_margin = timing-&gt;v_fp;</span><br><span class="line">    var-&gt;pixclock = (lcd-&gt;freq *</span><br><span class="line">        (var-&gt;left_margin + var-&gt;right_margin</span><br><span class="line">        + var-&gt;hsync_len + var-&gt;xres) *</span><br><span class="line">        (var-&gt;upper_margin + var-&gt;lower_margin</span><br><span class="line">        + var-&gt;vsync_len + var-&gt;yres));</span><br><span class="line">    var-&gt;pixclock = KHZ2PICOS(var-&gt;pixclock/<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    s3cfb_set_bitfield(var);</span><br><span class="line">    s3cfb_set_alpha_info(var, win);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3、s3cfb-map-default-video-memory"><a href="#4-3、s3cfb-map-default-video-memory" class="headerlink" title="4.3、s3cfb_map_default_video_memory()"></a>4.3、s3cfb_map_default_video_memory()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_map_default_video_memory</span><span class="params">(struct s3cfb_global *fbdev,</span></span></span><br><span class="line"><span class="function"><span class="params">                    struct fb_info *fb, <span class="keyword">int</span> fimd_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_fix_screeninfo</span> *<span class="title">fix</span> = &amp;<span class="title">fb</span>-&gt;<span class="title">fix</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_window</span> *<span class="title">win</span> = <span class="title">fb</span>-&gt;<span class="title">par</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cma_info</span> <span class="title">mem_info</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (win-&gt;owner == DMA_MEM_OTHER)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">    err = cma_info(&amp;mem_info, fbdev-&gt;dev, CMA_REGION_FIMD);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    fix-&gt;smem_start = (<span class="keyword">dma_addr_t</span>)cma_alloc</span><br><span class="line">        (fbdev-&gt;dev, <span class="string">&quot;fimd&quot;</span>, (<span class="keyword">size_t</span>)PAGE_ALIGN(fix-&gt;smem_len), <span class="number">0</span>);</span><br><span class="line">    fb-&gt;screen_base = cma_get_virt(fix-&gt;smem_start, PAGE_ALIGN(fix-&gt;smem_len), <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_S5P_MEM_BOOTMEM)</span></span><br><span class="line">    fix-&gt;smem_start = s5p_get_media_memory_bank(S5P_MDEV_FIMD, <span class="number">1</span>);</span><br><span class="line">    fix-&gt;smem_len = s5p_get_media_memsize_bank(S5P_MDEV_FIMD, <span class="number">1</span>);</span><br><span class="line">    fb-&gt;screen_base = ioremap_wc(fix-&gt;smem_start, fix-&gt;smem_len);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    fb-&gt;screen_base = dma_alloc_writecombine(fbdev-&gt;dev,</span><br><span class="line">                        PAGE_ALIGN(fix-&gt;smem_len),</span><br><span class="line">                        (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)</span><br><span class="line">                        &amp;fix-&gt;smem_start, GFP_KERNEL);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fb-&gt;screen_base)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dev_info(fbdev-&gt;dev, <span class="string">&quot;[fb%d] win%d: dma: 0x%08x, cpu: 0x%08x, &quot;</span></span><br><span class="line">            <span class="string">&quot;size: 0x%08x\n&quot;</span>, fb-&gt;node, win-&gt;id,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)fix-&gt;smem_start,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">int</span>)fb-&gt;screen_base, fix-&gt;smem_len);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_SPLASH_SCREEN</span></span><br><span class="line">    <span class="keyword">if</span> (bootloaderfb)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="built_in">memset</span>(fb-&gt;screen_base, <span class="number">0</span>, fix-&gt;smem_len);</span><br><span class="line">    win-&gt;owner = DMA_MEM_FIMD;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_SYSMMU</span></span><br><span class="line">    fbdev-&gt;sysmmu.default_fb_addr = fix-&gt;smem_start;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="（5）、s3cfb-register-framebuffer-fbdev-i"><a href="#（5）、s3cfb-register-framebuffer-fbdev-i" class="headerlink" title="（5）、s3cfb_register_framebuffer(fbdev[i])"></a>（5）、s3cfb_register_framebuffer(fbdev[i])</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_main.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_register_framebuffer</span><span class="params">(struct s3cfb_global *fbdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3c_platform_fb</span> *<span class="title">pdata</span> = <span class="title">to_fb_plat</span>(<span class="title">fbdev</span>-&gt;<span class="title">dev</span>);</span></span><br><span class="line">    <span class="keyword">int</span> ret, i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* on registering framebuffer, framebuffer of default window is registered at first. */</span></span><br><span class="line">    <span class="keyword">for</span> (i = pdata-&gt;default_win; i &lt; pdata-&gt;nr_wins + pdata-&gt;default_win; i++) &#123;</span><br><span class="line">        j = i % pdata-&gt;nr_wins;</span><br><span class="line">        ret = register_framebuffer(fbdev-&gt;fb[j]);</span><br><span class="line">        ......</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_FRAMEBUFFER_CONSOLE</span></span><br><span class="line">        <span class="keyword">if</span> (j == pdata-&gt;default_win) &#123;</span><br><span class="line">            s3cfb_check_var_window(fbdev, &amp;fbdev-&gt;fb[j]-&gt;var,</span><br><span class="line">                    fbdev-&gt;fb[j]);</span><br><span class="line">            ret = s3cfb_set_par_window(fbdev, fbdev-&gt;fb[j]);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">                BUG();</span><br><span class="line">            s3cfb_draw_logo(fbdev-&gt;fb[j]);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\fbmem.c</span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">register_framebuffer(struct fb_info *fb_info)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;registration_lock);</span><br><span class="line">    ret = do_register_framebuffer(fb_info);</span><br><span class="line">    mutex_unlock(&amp;registration_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_register_framebuffer</span><span class="params">(struct fb_info *fb_info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_videomode</span> <span class="title">mode</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fb_check_foreignness(fb_info))</span><br><span class="line">        <span class="keyword">return</span> -ENOSYS;</span><br><span class="line"></span><br><span class="line">    do_remove_conflicting_framebuffers(fb_info-&gt;apertures, fb_info-&gt;fix.id,</span><br><span class="line">                     fb_is_primary_device(fb_info));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_registered_fb == FB_MAX)</span><br><span class="line">        <span class="keyword">return</span> -ENXIO;</span><br><span class="line"></span><br><span class="line">    num_registered_fb++;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; FB_MAX; i++)</span><br><span class="line">        <span class="keyword">if</span> (!registered_fb[i])</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    fb_info-&gt;node = i;</span><br><span class="line">    atomic_set(&amp;fb_info-&gt;count, <span class="number">1</span>);</span><br><span class="line">    mutex_init(&amp;fb_info-&gt;lock);</span><br><span class="line">    mutex_init(&amp;fb_info-&gt;mm_lock);</span><br><span class="line"></span><br><span class="line">    fb_info-&gt;dev = device_create(fb_class, fb_info-&gt;device,</span><br><span class="line">                     MKDEV(FB_MAJOR, i), <span class="literal">NULL</span>, <span class="string">&quot;fb%d&quot;</span>, i);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(fb_info-&gt;dev)) &#123;</span><br><span class="line">        <span class="comment">/* Not fatal */</span></span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;Unable to create device for framebuffer %d; errno = %ld\n&quot;</span>, i, PTR_ERR(fb_info-&gt;dev));</span><br><span class="line">        fb_info-&gt;dev = <span class="literal">NULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        fb_init_device(fb_info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fb_info-&gt;pixmap.addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fb_info-&gt;pixmap.addr = kmalloc(FBPIXMAPSIZE, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (fb_info-&gt;pixmap.addr) &#123;</span><br><span class="line">            fb_info-&gt;pixmap.size = FBPIXMAPSIZE;</span><br><span class="line">            fb_info-&gt;pixmap.buf_align = <span class="number">1</span>;</span><br><span class="line">            fb_info-&gt;pixmap.scan_align = <span class="number">1</span>;</span><br><span class="line">            fb_info-&gt;pixmap.access_align = <span class="number">32</span>;</span><br><span class="line">            fb_info-&gt;pixmap.flags = FB_PIXMAP_DEFAULT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">    fb_info-&gt;pixmap.offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_x)</span><br><span class="line">        fb_info-&gt;pixmap.blit_x = ~(u32)<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;pixmap.blit_y)</span><br><span class="line">        fb_info-&gt;pixmap.blit_y = ~(u32)<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fb_info-&gt;modelist.prev || !fb_info-&gt;modelist.next)</span><br><span class="line">        INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);</span><br><span class="line"></span><br><span class="line">    fb_var_to_videomode(&amp;mode, &amp;fb_info-&gt;var);</span><br><span class="line">    fb_add_videomode(&amp;mode, &amp;fb_info-&gt;modelist);</span><br><span class="line">    registered_fb[i] = fb_info; <span class="comment">//加入到registered_fb[]数组中</span></span><br><span class="line"></span><br><span class="line">    event.info = fb_info;</span><br><span class="line">    <span class="keyword">if</span> (!lock_fb_info(fb_info))</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    console_lock();</span><br><span class="line">    fb_notifier_call_chain(FB_EVENT_FB_REGISTERED, &amp;event);</span><br><span class="line">    console_unlock();</span><br><span class="line">    unlock_fb_info(fb_info);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="（6）、s3cfb-set-clock-fbdev-i"><a href="#（6）、s3cfb-set-clock-fbdev-i" class="headerlink" title="（6）、s3cfb_set_clock(fbdev[i])"></a>（6）、s3cfb_set_clock(fbdev[i])</h5><blockquote>
<pre><code>Line 439: &lt;4&gt;[    0.449600] zjj.android.display.sys s3cfb_set_clock() s3cfb_probe s3cfb_main.c
Line 441: &lt;4&gt;[    0.449607] zjj.android.display.sys s3cfb_set_clock s3cfb_fimd6x.c 
Line 443: &lt;6&gt;[    0.449616] s3cfb s3cfb.0: FIMD src sclk = 66666666
Line 445: &lt;4&gt;[    0.449622] zjj.android.display.sys s3cfb_set_clock s3cfb_fimd6x.c S3C_VIDCON0 = 20 //1000.00 </code></pre>
<p>S3C_VIDCON0_CLKVAL_F(x)            (((x) &amp; 0xff) &lt;&lt; 6)<br>ENVID_F 0<br>ENVID   0</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_fimd6x.c</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_set_clock</span><span class="params">(struct s3cfb_global *ctrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3c_platform_fb</span> *<span class="title">pdata</span> = <span class="title">to_fb_plat</span>(<span class="title">ctrl</span>-&gt;<span class="title">dev</span>);</span></span><br><span class="line">    u32 cfg, maxclk, src_clk, vclk, div;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_GD2EVF</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_lcd_timing</span> *<span class="title">timing</span> = &amp;<span class="title">ctrl</span>-&gt;<span class="title">lcd</span>-&gt;<span class="title">timing</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* spec is under 100MHz */</span></span><br><span class="line">    maxclk = <span class="number">100</span> * <span class="number">1000000</span>;</span><br><span class="line"></span><br><span class="line">    cfg = readl(ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pdata-&gt;hw_ver == <span class="number">0x70</span>) &#123;</span><br><span class="line">        cfg &amp;= ~(S3C_VIDCON0_CLKVALUP_MASK |</span><br><span class="line">            S3C_VIDCON0_VCLKEN_MASK);</span><br><span class="line">        cfg |= (S3C_VIDCON0_CLKVALUP_ALWAYS |</span><br><span class="line">            S3C_VIDCON0_VCLKEN_FREERUN);</span><br><span class="line"></span><br><span class="line">        src_clk = clk_get_rate(ctrl-&gt;clock);</span><br><span class="line">        dev_dbg(ctrl-&gt;dev, <span class="string">&quot;FIMD src sclk = %d\n&quot;</span>, src_clk);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cfg &amp;= ~(S3C_VIDCON0_CLKSEL_MASK |</span><br><span class="line">            S3C_VIDCON0_CLKVALUP_MASK |</span><br><span class="line">            S3C_VIDCON0_VCLKEN_MASK |</span><br><span class="line">            S3C_VIDCON0_CLKDIR_MASK);</span><br><span class="line">        cfg |= (S3C_VIDCON0_CLKVALUP_ALWAYS |</span><br><span class="line">            S3C_VIDCON0_VCLKEN_NORMAL |</span><br><span class="line">            S3C_VIDCON0_CLKDIR_DIVIDED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(pdata-&gt;clk_name, <span class="string">&quot;sclk_fimd&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            cfg |= S3C_VIDCON0_CLKSEL_SCLK;</span><br><span class="line">            src_clk = clk_get_rate(ctrl-&gt;clock);</span><br><span class="line">            dev_dbg(ctrl-&gt;dev, <span class="string">&quot;FIMD src sclk = %d\n&quot;</span>, src_clk);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cfg |= S3C_VIDCON0_CLKSEL_HCLK;</span><br><span class="line">            src_clk = ctrl-&gt;clock-&gt;parent-&gt;rate;</span><br><span class="line">            dev_dbg(ctrl-&gt;dev, <span class="string">&quot;FIMD src hclk = %d\n&quot;</span>, src_clk);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FB_S5P_GD2EVF</span></span><br><span class="line">    vclk = (ctrl-&gt;lcd-&gt;freq *</span><br><span class="line">        (timing-&gt;h_bp + timing-&gt;h_fp + timing-&gt;h_sw + ctrl-&gt;lcd-&gt;width) *</span><br><span class="line">        (timing-&gt;v_bp + timing-&gt;v_fp + timing-&gt;v_sw + ctrl-&gt;lcd-&gt;height));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    vclk = PICOS2KHZ(ctrl-&gt;fb[pdata-&gt;default_win]-&gt;var.pixclock) * <span class="number">1000</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vclk &gt; maxclk) &#123;</span><br><span class="line">        dev_info(ctrl-&gt;dev, <span class="string">&quot;vclk(%d) should be smaller than %d\n&quot;</span>,</span><br><span class="line">            vclk, maxclk);</span><br><span class="line">        <span class="comment">/* vclk = maxclk; */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    div = DIV_ROUND_CLOSEST(src_clk, vclk);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((src_clk/div) &gt; maxclk)</span><br><span class="line">        dev_info(ctrl-&gt;dev, <span class="string">&quot;vclk(%d) should be smaller than %d Hz\n&quot;</span>,</span><br><span class="line">            src_clk/div, maxclk);</span><br><span class="line"></span><br><span class="line">    cfg &amp;= ~S3C_VIDCON0_CLKVAL_F(<span class="number">0xff</span>);</span><br><span class="line">    cfg |= S3C_VIDCON0_CLKVAL_F(div - <span class="number">1</span>);</span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line"></span><br><span class="line">    dev_info(ctrl-&gt;dev, <span class="string">&quot;parent clock: %d, vclk: %d, vclk div: %d\n&quot;</span>,</span><br><span class="line">            src_clk, vclk, div);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="（7）、s3cfb-enable-window-fbdev-0-pdata-gt-default-win"><a href="#（7）、s3cfb-enable-window-fbdev-0-pdata-gt-default-win" class="headerlink" title="（7）、s3cfb_enable_window(fbdev[0], pdata-&gt;default_win)"></a>（7）、s3cfb_enable_window(fbdev[0], pdata-&gt;default_win)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    Line 449: &lt;4&gt;[    0.449635] zjj.android.display.sys s3cfb_enable_window() s3cfb_probe s3cfb_main.c</span><br><span class="line">    Line <span class="number">451</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.449641</span>] zjj.android.display.sys s3cfb_window_on s3cfb_fimd6x.c</span><br><span class="line">    Line <span class="number">453</span>: &lt;<span class="number">6</span>&gt;[    <span class="number">0.449647</span>] s3cfb s3cfb<span class="number">.0</span>: [win2] turn on</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_ops.c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">s3cfb_enable_window</span><span class="params">(struct s3cfb_global *fbdev, <span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3cfb_window</span> *<span class="title">win</span> = <span class="title">fbdev</span>-&gt;<span class="title">fb</span>[<span class="title">id</span>]-&gt;<span class="title">par</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE_BUSFREQ_LOCK</span></span><br><span class="line">    <span class="keyword">int</span> enabled_win = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_CPU_EXYNOS4212) || defined(CONFIG_CPU_EXYNOS4412)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BUSFREQ_OPP</span></span><br><span class="line">    <span class="keyword">if</span> (CONFIG_FB_S5P_DEFAULT_WINDOW == <span class="number">3</span> &amp;&amp;</span><br><span class="line">        id == CONFIG_FB_S5P_DEFAULT_WINDOW<span class="number">-1</span>)</span><br><span class="line">        dev_lock(fbdev-&gt;bus_dev, fbdev-&gt;dev, <span class="number">267160</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (id != CONFIG_FB_S5P_DEFAULT_WINDOW) &#123;</span><br><span class="line">        <span class="keyword">if</span> (id == CONFIG_FB_S5P_DEFAULT_WINDOW<span class="number">-1</span>)</span><br><span class="line">            dev_lock(fbdev-&gt;bus_dev, fbdev-&gt;dev, <span class="number">267160</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">3</span>)</span><br><span class="line">            dev_lock(fbdev-&gt;bus_dev, fbdev-&gt;dev, <span class="number">267160</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            dev_lock(fbdev-&gt;bus_dev, fbdev-&gt;dev, <span class="number">133133</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!win-&gt;enabled)</span><br><span class="line">        atomic_inc(&amp;fbdev-&gt;enabled_win);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE_BUSFREQ_LOCK</span></span><br><span class="line">    enabled_win = atomic_read(&amp;fbdev-&gt;enabled_win);</span><br><span class="line">    <span class="keyword">if</span> (enabled_win &gt;= <span class="number">2</span>)</span><br><span class="line">        s3cfb_busfreq_lock(fbdev, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s3cfb_window_on(fbdev, id)) &#123;</span><br><span class="line">        win-&gt;enabled = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        win-&gt;enabled = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="（8）、s3cfb-display-on-fbdev-i"><a href="#（8）、s3cfb-display-on-fbdev-i" class="headerlink" title="（8）、s3cfb_display_on(fbdev[i])"></a>（8）、s3cfb_display_on(fbdev[i])</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    Line <span class="number">457</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.449657</span>] zjj.android.display.sys s3cfb_display_on s3cfb_fimd6x.c</span><br><span class="line">    Line <span class="number">459</span>: &lt;<span class="number">4</span>&gt;[    <span class="number">0.449662</span>] zjj.android.display.sys s3cfb_set_display_on s3cfb_fimd6x.c S3C_VIDCON0 = <span class="number">23</span> <span class="comment">//1000.11 </span></span><br><span class="line">    ENVID_F <span class="number">1</span></span><br><span class="line">    ENVID   <span class="number">1</span></span><br><span class="line">   </span><br><span class="line">    Line <span class="number">461</span>: &lt;<span class="number">6</span>&gt;[    <span class="number">0.449668</span>] s3cfb s3cfb<span class="number">.0</span>: global display is on</span><br><span class="line">    Line <span class="number">463</span>: &lt;<span class="number">6</span>&gt;[    <span class="number">0.449741</span>] s3cfb s3cfb<span class="number">.0</span>: registered successfully</span><br><span class="line"></span><br><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_ops.c</span><br><span class="line"><span class="keyword">int</span> s3cfb_display_on(struct s3cfb_global *ctrl)</span><br><span class="line">&#123;</span><br><span class="line">    u32 cfg;</span><br><span class="line"></span><br><span class="line">    cfg = readl(ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line">    cfg |= (S3C_VIDCON0_ENVID_ENABLE | S3C_VIDCON0_ENVID_F_ENABLE);</span><br><span class="line">    writel(cfg, ctrl-&gt;regs + S3C_VIDCON0);</span><br><span class="line"></span><br><span class="line">    dev_dbg(ctrl-&gt;dev, <span class="string">&quot;global display is on\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后开启背光，LCD就开始显示画面了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">G:\Android<span class="number">-5.0</span><span class="number">.2</span>\linux<span class="number">-3.0</span><span class="number">.86</span><span class="number">-20170221</span>\linux<span class="number">-3.0</span><span class="number">.86</span>\drivers\video\samsung\s3cfb_main.c</span><br><span class="line"></span><br><span class="line"><span class="comment">/* panel control */</span></span><br><span class="line"><span class="keyword">if</span> (pdata-&gt;backlight_on)</span><br><span class="line">    pdata-&gt;backlight_on(pdev);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pdata-&gt;lcd_on)</span><br><span class="line">    pdata-&gt;lcd_on(pdev);</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.s3cfb_probe.png" alt="enter image description here"></p>
<h4 id="（四）、参考文档："><a href="#（四）、参考文档：" class="headerlink" title="（四）、参考文档："></a>（四）、参考文档：</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/z961968549/article/details/78821082">（1）【LCD设备驱动框架分析（数据结构）】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Ultraman_hs/article/details/54987874">（2）【framebuffer之s3cfb_probe分析】</a><br><a target="_blank" rel="noopener" href="https://layty.gitee.io/2018/12/03/Linux/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/12-lcd%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/">（3）【LCD驱动框架】</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20191001/">https://zhoujinjian.com/posts/20191001/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00003.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20191101/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00004.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android L Display System源码分析（4）：Android Graphics 系统分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</div></div></a></div><div class="next-post pull-right"><a href="/posts/20190901/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00002.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android L Display System源码分析（2）：LCD显示原理（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%81LCD%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%9B%BE"><span class="toc-number">1.</span> <span class="toc-text">（一）、LCD设备驱动框架图</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81Framebuffer%E4%B9%8Bfbmem-c%E6%A6%82%E6%8B%AC"><span class="toc-number">1.1.</span> <span class="toc-text">（1）、Framebuffer之fbmem.c概括</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E3%80%81platform-device-amp-amp-platform-driver%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">（二）、platform_device &amp;&amp; platform_driver分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81platform-device%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">（1）、platform_device分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81platform-driver%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">（2）、platform_driver分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81s3cfb%E9%A9%B1%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="toc-number">2.3.</span> <span class="toc-text">2.1、s3cfb驱动注册</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E3%80%81s3cfb-probe%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">（三）、s3cfb_probe函数分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E3%80%81pdata-gt-cfg-gpio-pdev"><span class="toc-number">3.1.</span> <span class="toc-text">（1）、pdata-&gt;cfg_gpio(pdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E3%80%81pdata-gt-clk-on-pdev-amp-fbdev-i-gt-clock"><span class="toc-number">3.2.</span> <span class="toc-text">（2）、pdata-&gt;clk_on(pdev, &amp;fbdev[i]-&gt;clock)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E3%80%81s3cfb-init-global-fbdev-i"><span class="toc-number">3.3.</span> <span class="toc-text">（3）、s3cfb_init_global(fbdev[i])</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81s3cfb-set-output"><span class="toc-number">3.4.</span> <span class="toc-text">3.1、s3cfb_set_output()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2%E3%80%81s3cfb-set-display-mode"><span class="toc-number">3.5.</span> <span class="toc-text">3.2、s3cfb_set_display_mode()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3%E3%80%81s3cfb-set-polarity-fbdev"><span class="toc-number">3.6.</span> <span class="toc-text">3.3、s3cfb_set_polarity(fbdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4%E3%80%81s3cfb-set-timing-fbdev"><span class="toc-number">3.7.</span> <span class="toc-text">3.4、s3cfb_set_timing(fbdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5%E3%80%81s3cfb-set-lcd-size-fbdev"><span class="toc-number">3.8.</span> <span class="toc-text">3.5、s3cfb_set_lcd_size(fbdev)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E3%80%81s3cfb-alloc-framebuffer-fbdev-i-i"><span class="toc-number">3.9.</span> <span class="toc-text">（4）、s3cfb_alloc_framebuffer(fbdev[i], i)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1%E3%80%81framebuffer-alloc"><span class="toc-number">3.10.</span> <span class="toc-text">4.1、framebuffer_alloc()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2%E3%80%81s3cfb-init-fbinfo"><span class="toc-number">3.11.</span> <span class="toc-text">4.2、s3cfb_init_fbinfo()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3%E3%80%81s3cfb-map-default-video-memory"><span class="toc-number">3.12.</span> <span class="toc-text">4.3、s3cfb_map_default_video_memory()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E3%80%81s3cfb-register-framebuffer-fbdev-i"><span class="toc-number">3.13.</span> <span class="toc-text">（5）、s3cfb_register_framebuffer(fbdev[i])</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E3%80%81s3cfb-set-clock-fbdev-i"><span class="toc-number">3.14.</span> <span class="toc-text">（6）、s3cfb_set_clock(fbdev[i])</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%887%EF%BC%89%E3%80%81s3cfb-enable-window-fbdev-0-pdata-gt-default-win"><span class="toc-number">3.15.</span> <span class="toc-text">（7）、s3cfb_enable_window(fbdev[0], pdata-&gt;default_win)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%888%EF%BC%89%E3%80%81s3cfb-display-on-fbdev-i"><span class="toc-number">3.16.</span> <span class="toc-text">（8）、s3cfb_display_on(fbdev[i])</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="toc-number">4.</span> <span class="toc-text">（四）、参考文档：</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>