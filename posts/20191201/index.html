<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android L Display System源码分析（5）：App 界面显示流程源码分析 之 Activity启动流程分析（Android 9.0 &amp;&amp; Kernel 3.18） | zhoujinjian</title><meta name="keywords" content="Android,Linux,Graphics"><meta name="author" content="zhoujinjian"><meta name="copyright" content="zhoujinjian"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:type" content="article">
<meta property="og:title" content="Android L Display System源码分析（5）：App 界面显示流程源码分析 之 Activity启动流程分析（Android 9.0 &amp;&amp; Kernel 3.18）">
<meta property="og:url" content="https://zhoujinjian.com/posts/20191201/index.html">
<meta property="og:site_name" content="zhoujinjian">
<meta property="og:description" content="注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。（&#x3D;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00005.jpg">
<meta property="article:published_time" content="2019-12-01T01:25:00.000Z">
<meta property="article:modified_time" content="2024-04-14T13:01:32.948Z">
<meta property="article:author" content="zhoujinjian">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Graphics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00005.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhoujinjian.com/posts/20191201/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-14 21:01:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/css/flink.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00005.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zhoujinjian</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/home/"><i class="fa-fw fa fa-cloud-sun-rain"></i><span> 主页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/navigation/"><i class="fa-fw fab fa-safari"></i><span> 导航</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Android L Display System源码分析（5）：App 界面显示流程源码分析 之 Activity启动流程分析（Android 9.0 &amp;&amp; Kernel 3.18）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-12-01T01:25:00.000Z" title="发表于 2019-12-01 09:25:00">2019-12-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-14T13:01:32.948Z" title="更新于 2024-04-14 21:01:32">2024-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Display/">Display</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<p>注：文章都是通过阅读各位前辈总结的资料 Android 9.0 &amp;&amp; Linux（Kernel 3.18）Qualcomm平台源码、加上自己的思考分析总结出来的，其中难免有理解不对的地方，欢迎大家批评指正。文章为个人学习、研究、欣赏之用，图文内容整理自互联网，如有侵权，请联系删除（◕‿◕），转载请注明出处（©Qualcomm ©Android @Linux 版权所有），谢谢。<br>（==<strong>文章基于 Kernel-3.18</strong>==）&amp;&amp;（==<strong>文章基于 Android 9.0</strong>==）<br><a target="_blank" rel="noopener" href="https://www.intrinsyc.com/snapdragon-embedded-development-kits/open-q-820-usom-development-kit/">【开发板 Intrinsyc Open-Q™ 820 µSOM Development Kit】</a><br><a target="_blank" rel="noopener" href="https://gitlab.com/zhoujinjianzz/apq8096_la.um.7.5.r1-03100-8x96.0_p_v5.0">【开发板 Android 9.0 &amp;&amp; Linux（Kernel 3.18）源码链接】</a></p>
<p>正是由于前人的分析和总结，帮助我节约了大量的时间和精力，特别感谢！！！</p>
<p><a target="_blank" rel="noopener" href="http://charlesvincent.cc/">（1）【Android Display System】</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/50e4b48ed15c">（2）【Android 9.0 activity启动源码分析】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/lj19851227/article/details/82562115">（3）【Android 9.0 Activity启动流程源码分析】</a><br><a target="_blank" rel="noopener" href="https://gitlab.com/zhoujinjianzz/apq8096_la.um.7.5.r1-03100-8x96.0_p_v5.0/commit/714c0071b4bc786d00e7a6bcd08face6a28d6c0c">（4）【Android App(“com.android.testgreen”)源码】</a></p>
<hr>
<p>==源码（部分）==：<br><strong>packages/apps/testViewportGreen &amp;&amp; testViewportBlue &amp;&amp; testViewportRed/</strong><br><strong>frameworks/base/core/java/android/app/</strong><br><strong>frameworks/base/services/core/java/com/android/server/wm/</strong><br><strong>frameworks/base/services/core/java/com/android/server/am/</strong><br><strong>frameworks/base/services/core/java/com/android/server/policy/</strong><br><strong>frameworks/native/services/surfaceflinger/</strong><br><strong>frameworks/native/libs/gui/</strong><br><strong>frameworks/native/libs/ui/</strong></p>
<hr>
<h4 id="App（”com-android-testred”）分析准备工作"><a href="#App（”com-android-testred”）分析准备工作" class="headerlink" title="App（”com.android.testred”）分析准备工作"></a>App（”com.android.testred”）分析准备工作</h4><p>分析学习Android源码，最好有编译源码环境并有开发板。</p>
<h5 id="①、App运行效果图"><a href="#①、App运行效果图" class="headerlink" title="①、App运行效果图"></a>①、App运行效果图</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.test_red.png" alt="enter image description here"> </p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.test_green.png" alt="enter image description here"></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.test_blue.png" alt="enter image description here"></p>
<p>以上时三个App运行效果图，我们这里分析App（”com.android.testred”），流程学习最好的办法就是打开Debug开关跟着log分析。</p>
<h5 id="②、打开Debug开关，抓取Log"><a href="#②、打开Debug开关，抓取Log" class="headerlink" title="②、打开Debug开关，抓取Log"></a>②、打开Debug开关，抓取Log</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/frameworks/base/core/java/android/view/View.java b/frameworks/base/core/java/android/view/View.java</span><br><span class="line">index <span class="number">991</span>ba74..<span class="number">14</span>adf45 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/base/core/java/android/view/View.java</span><br><span class="line">+++ b/frameworks/base/core/java/android/view/View.java</span><br><span class="line"> -<span class="number">777</span>,<span class="number">10</span> +<span class="number">777</span>,<span class="number">10</span> @@ <span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"> <span class="meta">@UiThread</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">implements</span> <span class="title">Drawable</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span></span><br><span class="line"><span class="class">         <span class="title">AccessibilityEventSource</span> </span>&#123;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DBG = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DBG = <span class="keyword">true</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">-    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> DEBUG_DRAW = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> DEBUG_DRAW = <span class="keyword">true</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * The logging tag used by this class with android.util.Log.</span></span><br><span class="line"><span class="comment">diff --git a/frameworks/base/core/java/android/view/ViewGroup.java b/frameworks/base/core/java/android/view/ViewGroup.java</span></span><br><span class="line"><span class="comment">index baa38bb..ed31ff8 100644</span></span><br><span class="line"><span class="comment">--- a/frameworks/base/core/java/android/view/ViewGroup.java</span></span><br><span class="line"><span class="comment">+++ b/frameworks/base/core/java/android/view/ViewGroup.java</span></span><br><span class="line"><span class="comment">@ -120,7 +120,7 @@ import java.util.function.Predicate;</span></span><br><span class="line"><span class="comment"> public abstract class ViewGroup extends View implements ViewParent, ViewManager &#123;</span></span><br><span class="line"><span class="comment">     private static final String TAG = &quot;ViewGroup&quot;;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">-    private static final boolean DBG = false;</span></span><br><span class="line"><span class="comment">+    private static final boolean DBG = true;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     /**</span></span><br><span class="line"><span class="comment">      * Views which have been hidden or removed which need to be animated on</span></span><br><span class="line"><span class="comment">diff --git a/frameworks/base/core/java/android/view/ViewRootImpl.java b/frameworks/base/core/java/android/view/ViewRootImpl.java</span></span><br><span class="line"><span class="comment">index e7bda30..f3b4b31 100644</span></span><br><span class="line"><span class="comment">--- a/frameworks/base/core/java/android/view/ViewRootImpl.java</span></span><br><span class="line"><span class="comment">+++ b/frameworks/base/core/java/android/view/ViewRootImpl.java</span></span><br><span class="line"><span class="comment">@@ -133,19 +133,19 @@ import java.util.concurrent.CountDownLatch;</span></span><br><span class="line"><span class="comment"> public final class ViewRootImpl implements ViewParent,</span></span><br><span class="line"><span class="comment">         View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks &#123;</span></span><br><span class="line"><span class="comment">     private static final String TAG = &quot;ViewRootImpl&quot;;</span></span><br><span class="line"><span class="comment">-    private static final boolean DBG = false;</span></span><br><span class="line"><span class="comment">-    private static final boolean LOCAL_LOGV = false;</span></span><br><span class="line"><span class="comment">+    private static final boolean DBG = true;</span></span><br><span class="line"><span class="comment">+    private static final boolean LOCAL_LOGV = true;</span></span><br><span class="line"><span class="comment">     /** <span class="doctag">@noinspection</span> PointlessBooleanExpression*/</span></span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DRAW = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DIALOG = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT_RESIZE = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ORIENTATION = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TRACKBALL = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_IMF = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_CONFIGURATION = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_FPS = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT_STAGES = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DRAW = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DIALOG = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT_RESIZE = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ORIENTATION = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TRACKBALL = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_IMF = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_CONFIGURATION = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_FPS = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT_STAGES = <span class="keyword">true</span> || LOCAL_LOGV;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_KEEP_SCREEN_ON = <span class="keyword">false</span> || LOCAL_LOGV;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">diff --git a/frameworks/base/services/core/java/com/android/server/am/ActivityManagerDebugConfig.java b/frameworks/base/services/core/java/com/android/server/am/ActivityManagerDebugConfig.java</span></span><br><span class="line"><span class="comment">index 0a7d3fd..6846966 100644</span></span><br><span class="line"><span class="comment">--- a/frameworks/base/services/core/java/com/android/server/am/ActivityManagerDebugConfig.java</span></span><br><span class="line"><span class="comment">+++ b/frameworks/base/services/core/java/com/android/server/am/ActivityManagerDebugConfig.java</span></span><br><span class="line"><span class="comment">@@ -28,18 +28,18 @@ class ActivityManagerDebugConfig &#123;</span></span><br><span class="line"><span class="comment">     // to figure-out the origin of a log message while debugging the activity manager a little</span></span><br><span class="line"><span class="comment">     // painful. By setting this constant to true, log messages from the activity manager package</span></span><br><span class="line"><span class="comment">     // will be tagged with their class names instead fot the generic tag.</span></span><br><span class="line"><span class="comment">-    static final boolean TAG_WITH_CLASS_NAME = false;</span></span><br><span class="line"><span class="comment">+    static final boolean TAG_WITH_CLASS_NAME = true;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     // While debugging it is sometimes useful to have the category name of the log appended to the</span></span><br><span class="line"><span class="comment">     // base log tag to make sifting through logs with the same base tag easier. By setting this</span></span><br><span class="line"><span class="comment">     // constant to true, the category name of the log point will be appended to the log tag.</span></span><br><span class="line"><span class="comment">-    static final boolean APPEND_CATEGORY_NAME = false;</span></span><br><span class="line"><span class="comment">+    static final boolean APPEND_CATEGORY_NAME = true;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     // Default log tag for the activity manager package.</span></span><br><span class="line"><span class="comment">     static final String TAG_AM = &quot;ActivityManager&quot;;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     // Enable all debug log categories.</span></span><br><span class="line"><span class="comment">-    static final boolean DEBUG_ALL = false;</span></span><br><span class="line"><span class="comment">+    static final boolean DEBUG_ALL = true;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">     // Enable all debug log categories for activities.</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_ALL_ACTIVITIES = DEBUG_ALL || false;</span></span><br><span class="line"><span class="comment">@@ -56,7 +56,7 @@ class ActivityManagerDebugConfig &#123;</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_CLEANUP = DEBUG_ALL || false;</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_CONFIGURATION = DEBUG_ALL || false;</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_CONTAINERS = DEBUG_ALL_ACTIVITIES || false;</span></span><br><span class="line"><span class="comment">-    static final boolean DEBUG_FOCUS = false;</span></span><br><span class="line"><span class="comment">+    static final boolean DEBUG_FOCUS = true;</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_IDLE = DEBUG_ALL_ACTIVITIES || false;</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_IMMERSIVE = DEBUG_ALL || false;</span></span><br><span class="line"><span class="comment">     static final boolean DEBUG_LOCKTASK = DEBUG_ALL || false;</span></span><br><span class="line"><span class="comment">diff --git a/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java b/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span></span><br><span class="line"><span class="comment">index 04a25ea..18a9226 100644</span></span><br><span class="line"><span class="comment">--- a/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span></span><br><span class="line"><span class="comment">+++ b/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span></span><br><span class="line"><span class="comment">@@ -2733,10 +2733,10 @@ public class ActivityManagerService extends IActivityManager.Stub</span></span><br><span class="line"><span class="comment">                             pid = proc.pid;</span></span><br><span class="line"><span class="comment">                         &#125; else &#123;</span></span><br><span class="line"><span class="comment">                             ProcessList.abortNextPssTime(proc.procStateMemTracker);</span></span><br><span class="line"><span class="comment">-                            if (DEBUG_PSS) Slog.d(TAG_PSS, &quot;Skipped pss collection of &quot; + pid +</span></span><br><span class="line"><span class="comment">-                                    &quot;: still need &quot; +</span></span><br><span class="line"><span class="comment">-                                    (lastPssTime+ProcessList.PSS_SAFE_TIME_FROM_STATE_CHANGE-now) +</span></span><br><span class="line"><span class="comment">-                                    &quot;ms until safe&quot;);</span></span><br><span class="line"><span class="comment">+                            //if (DEBUG_PSS) Slog.d(TAG_PSS, &quot;Skipped pss collection of &quot; + pid +</span></span><br><span class="line"><span class="comment">+                            //        &quot;: still need &quot; +</span></span><br><span class="line"><span class="comment">+                            //        (lastPssTime+ProcessList.PSS_SAFE_TIME_FROM_STATE_CHANGE-now) +</span></span><br><span class="line"><span class="comment">+                            //        &quot;ms until safe&quot;);</span></span><br><span class="line"><span class="comment">                             proc = null;</span></span><br><span class="line"><span class="comment">                             pid = 0;</span></span><br><span class="line"><span class="comment">                         &#125;</span></span><br><span class="line"><span class="comment">diff --git a/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java b/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</span></span><br><span class="line"><span class="comment">index 7f6d6c9..153eb94 100644</span></span><br><span class="line"><span class="comment">--- a/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</span></span><br><span class="line"><span class="comment">+++ b/frameworks/base/services/core/java/com/android/server/policy/PhoneWindowManager.java</span></span><br><span class="line"><span class="comment">@@ -306,11 +306,11 @@ import java.util.List;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneWindowManager</span> <span class="keyword">implements</span> <span class="title">WindowManagerPolicy</span> </span>&#123;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;WindowManager&quot;</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> localLOGV = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> localLOGV = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT = <span class="keyword">false</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_KEYGUARD = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_SPLASH_SCREEN = <span class="keyword">false</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WAKEUP = <span class="keyword">false</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_SPLASH_SCREENS = <span class="keyword">true</span>;</span><br><span class="line">diff --git a/frameworks/base/services/core/java/com/android/server/wm/WindowManagerDebugConfig.java b/frameworks/base/services/core/java/com/android/server/wm/WindowManagerDebugConfig.java</span><br><span class="line">index c366e4d..<span class="number">8</span>bfb9f1 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/base/services/core/java/com/android/server/wm/WindowManagerDebugConfig.java</span><br><span class="line">+++ b/frameworks/base/services/core/java/com/android/server/wm/WindowManagerDebugConfig.java</span><br><span class="line">@@ -<span class="number">28</span>,<span class="number">53</span> +<span class="number">28</span>,<span class="number">53</span> @@ <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerDebugConfig</span> </span>&#123;</span><br><span class="line">     <span class="comment">// to figure-out the origin of a log message while debugging the window manager a little</span></span><br><span class="line">     <span class="comment">// painful. By setting this constant to true, log messages from the window manager package</span></span><br><span class="line">     <span class="comment">// will be tagged with their class names instead fot the generic tag.</span></span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> TAG_WITH_CLASS_NAME = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> TAG_WITH_CLASS_NAME = <span class="keyword">true</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">// Default log tag for the window manager package.</span></span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> String TAG_WM = <span class="string">&quot;WindowManager&quot;</span>;</span><br><span class="line"> </span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_RESIZE = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ADD_REMOVE = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_FOCUS = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_RESIZE = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ADD_REMOVE = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_FOCUS = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_FOCUS_LIGHT = DEBUG_FOCUS || <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ANIM = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_KEYGUARD = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYERS = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT_METHOD = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_VISIBILITY = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WINDOW_MOVEMENT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TOKEN_MOVEMENT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ORIENTATION = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_APP_ORIENTATION = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_CONFIGURATION = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_APP_TRANSITIONS = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_STARTING_WINDOW_VERBOSE = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ANIM = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_KEYGUARD = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYERS = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_INPUT_METHOD = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_VISIBILITY = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WINDOW_MOVEMENT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TOKEN_MOVEMENT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ORIENTATION = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_APP_ORIENTATION = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_CONFIGURATION = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_APP_TRANSITIONS = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_STARTING_WINDOW_VERBOSE = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_STARTING_WINDOW = DEBUG_STARTING_WINDOW_VERBOSE || <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WALLPAPER = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WALLPAPER_LIGHT = <span class="keyword">false</span> || DEBUG_WALLPAPER;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DRAG = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_SCREEN_ON = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_SCREENSHOT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_BOOT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT_REPEATS = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WINDOW_TRACE = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TASK_MOVEMENT = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TASK_POSITIONING = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_STACK = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DISPLAY = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_POWER = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DIM_LAYER = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_SURFACE_ALLOC = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_TRANSACTIONS = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_VERBOSE_TRANSACTIONS = <span class="keyword">false</span> &amp;&amp; SHOW_TRANSACTIONS;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_LIGHT_TRANSACTIONS = <span class="keyword">false</span> || SHOW_TRANSACTIONS;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_STACK_CRAWLS = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WINDOW_CROP = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_UNKNOWN_APP_VISIBILITY = <span class="keyword">false</span>;</span><br><span class="line">-    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_RECENTS_ANIMATIONS = <span class="keyword">false</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WALLPAPER = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WALLPAPER_LIGHT = <span class="keyword">true</span> || DEBUG_WALLPAPER;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DRAG = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_SCREEN_ON = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_SCREENSHOT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_BOOT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LAYOUT_REPEATS = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WINDOW_TRACE = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TASK_MOVEMENT = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_TASK_POSITIONING = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_STACK = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DISPLAY = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_POWER = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_DIM_LAYER = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_SURFACE_ALLOC = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_TRANSACTIONS = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_VERBOSE_TRANSACTIONS = <span class="keyword">true</span> &amp;&amp; SHOW_TRANSACTIONS;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_LIGHT_TRANSACTIONS = <span class="keyword">true</span> || SHOW_TRANSACTIONS;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SHOW_STACK_CRAWLS = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_WINDOW_CROP = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_UNKNOWN_APP_VISIBILITY = <span class="keyword">true</span>;</span><br><span class="line">+    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_RECENTS_ANIMATIONS = <span class="keyword">true</span>;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_REMOTE_ANIMATIONS = DEBUG_APP_TRANSITIONS || <span class="keyword">false</span>;</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">final</span> String TAG_KEEP_SCREEN_ON = <span class="string">&quot;DebugKeepScreenOn&quot;</span>;</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/BufferItemConsumer.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/BufferItemConsumer.cpp</span><br><span class="line">index <span class="number">89</span>bc0c4..<span class="number">7405</span>b7f <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/BufferItemConsumer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/BufferItemConsumer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #define LOG_TAG &quot;BufferItemConsumer&quot;</span><br><span class="line"> <span class="comment">//#define ATRACE_TAG ATRACE_TAG_GRAPHICS</span></span><br><span class="line"> #include &lt;utils/Log.h&gt;</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueue.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueue.cpp</span><br><span class="line">index a8da134..<span class="number">70695d</span>0 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueue.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueue.cpp</span><br><span class="line">@@ -<span class="number">16</span>,<span class="number">7</span> +<span class="number">16</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;BufferQueue&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #ifndef NO_BUFFERHUB</span><br><span class="line"> #include &lt;gui/BufferHubConsumer.h&gt;</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueConsumer.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueConsumer.cpp</span><br><span class="line">index d70e142..fe08603 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueConsumer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueConsumer.cpp</span><br><span class="line">@@ -<span class="number">20</span>,<span class="number">7</span> +<span class="number">20</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;BufferQueueConsumer&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #if DEBUG_ONLY_CODE</span><br><span class="line"> #define VALIDATE_CONSISTENCY() do &#123; mCore-&gt;validateConsistencyLocked(); &#125; while (0)</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueCore.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueCore.cpp</span><br><span class="line">index bb703da..<span class="number">20</span>a4c72 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueCore.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueCore.cpp</span><br><span class="line">@@ -<span class="number">16</span>,<span class="number">7</span> +<span class="number">16</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;BufferQueueCore&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #define EGL_EGLEXT_PROTOTYPES</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueProducer.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueProducer.cpp</span><br><span class="line">index c8021e4..<span class="number">73917f</span>2 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueProducer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/BufferQueueProducer.cpp</span><br><span class="line">@@ -<span class="number">18</span>,<span class="number">7</span> +<span class="number">18</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;BufferQueueProducer&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #if DEBUG_ONLY_CODE</span><br><span class="line"> #define VALIDATE_CONSISTENCY() do &#123; mCore-&gt;validateConsistencyLocked(); &#125; while (0)</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/ConsumerBase.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/ConsumerBase.cpp</span><br><span class="line">index f9e292e..d14c55c <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/ConsumerBase.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/ConsumerBase.cpp</span><br><span class="line">@@ -<span class="number">18</span>,<span class="number">7</span> +<span class="number">18</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;ConsumerBase&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #define EGL_EGLEXT_PROTOTYPES</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/CpuConsumer.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/CpuConsumer.cpp</span><br><span class="line">index <span class="number">8</span>edf604..<span class="number">8</span>a3a4c7 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/CpuConsumer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/CpuConsumer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #define LOG_TAG &quot;CpuConsumer&quot;</span><br><span class="line"> <span class="comment">//#define ATRACE_TAG ATRACE_TAG_GRAPHICS</span></span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/GLConsumer.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/GLConsumer.cpp</span><br><span class="line">index <span class="number">885</span>efec..df894ab <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/GLConsumer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/GLConsumer.cpp</span><br><span class="line">@@ -<span class="number">16</span>,<span class="number">7</span> +<span class="number">16</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;GLConsumer&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #define GL_GLEXT_PROTOTYPES</span><br><span class="line"> #define EGL_EGLEXT_PROTOTYPES</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/gui/Surface.cpp b/frameworks/<span class="keyword">native</span>/libs/gui/Surface.cpp</span><br><span class="line">index <span class="number">339</span>bd0f..<span class="number">40</span>c18d3 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/gui/Surface.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/gui/Surface.cpp</span><br><span class="line">@@ -<span class="number">16</span>,<span class="number">7</span> +<span class="number">16</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;Surface&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #include &lt;gui/Surface.h&gt;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/ui/Fence.cpp b/frameworks/<span class="keyword">native</span>/libs/ui/Fence.cpp</span><br><span class="line">index d6ee80d..<span class="number">9912</span>ab2 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/ui/Fence.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/ui/Fence.cpp</span><br><span class="line">@@ -<span class="number">18</span>,<span class="number">7</span> +<span class="number">18</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;Fence&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// We would eliminate the non-conforming zero-length array, but we can&#x27;t since</span></span><br><span class="line"> <span class="comment">// this is effectively included from the Linux kernel</span></span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/libs/ui/GraphicBufferMapper.cpp b/frameworks/<span class="keyword">native</span>/libs/ui/GraphicBufferMapper.cpp</span><br><span class="line">index <span class="number">2d</span>8e582..c1e1043 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/libs/ui/GraphicBufferMapper.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/libs/ui/GraphicBufferMapper.cpp</span><br><span class="line">@@ -<span class="number">16</span>,<span class="number">7</span> +<span class="number">16</span>,<span class="number">7</span> @@</span><br><span class="line"> </span><br><span class="line"> #define LOG_TAG &quot;GraphicBufferMapper&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #include &lt;ui/GraphicBufferMapper.h&gt;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayer.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayer.cpp</span><br><span class="line">index <span class="number">4d</span>3e6cc..<span class="number">56</span>c608e <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;BufferLayer&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayerConsumer.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayerConsumer.cpp</span><br><span class="line">index <span class="number">87333d</span>0..<span class="number">4</span>ebf24e <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayerConsumer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/BufferLayerConsumer.cpp</span><br><span class="line">@@ -<span class="number">17</span>,<span class="number">7</span> +<span class="number">17</span>,<span class="number">7</span> @@</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;BufferLayerConsumer&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #include &quot;BufferLayerConsumer.h&quot;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ColorLayer.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ColorLayer.cpp</span><br><span class="line">index <span class="number">1</span>a9021a..e95e89d <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ColorLayer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ColorLayer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;ColorLayer&quot;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ContainerLayer.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ContainerLayer.cpp</span><br><span class="line">index f259d93..ae8cc67 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ContainerLayer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/ContainerLayer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;ContainerLayer&quot;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DispSync.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DispSync.cpp</span><br><span class="line">index <span class="number">7</span>acbd11..a98268c <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DispSync.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DispSync.cpp</span><br><span class="line">@@ -<span class="number">15</span>,<span class="number">7</span> +<span class="number">15</span>,<span class="number">7</span> @@</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// This is needed for stdint.h to define INT64_MAX in C++</span></span><br><span class="line"> #define __STDC_LIMIT_MACROS</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayDevice.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayDevice.cpp</span><br><span class="line">index <span class="number">4801</span>ba0..ed303d8 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayDevice.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayDevice.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;DisplayDevice&quot;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp</span><br><span class="line">index daabd3d..<span class="number">4</span>efb1e6 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp</span><br><span class="line">@@ -<span class="number">15</span>,<span class="number">7</span> +<span class="number">15</span>,<span class="number">7</span> @@</span><br><span class="line">  ** limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;FramebufferSurface&quot;</span><br><span class="line"> </span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWC2.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWC2.cpp</span><br><span class="line">index <span class="number">067257</span>c..<span class="number">06d</span>48c9 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWC2.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWC2.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;HWC2&quot;</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWComposer.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWComposer.cpp</span><br><span class="line">index <span class="number">89777d</span>0..<span class="number">60f</span>661a <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWComposer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/HWComposer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> </span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;HWComposer&quot;</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp</span><br><span class="line">index ff1482c..<span class="number">25826</span>c3 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #include &quot;VirtualDisplaySurface.h&quot;</span><br><span class="line"> </span><br><span class="line"> #include &lt;inttypes.h&gt;</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/Layer.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/Layer.cpp</span><br><span class="line">index <span class="number">07</span>ba345..<span class="number">2651d</span>34 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/Layer.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/Layer.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;Layer&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/RenderEngine/GLES20RenderEngine.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/RenderEngine/GLES20RenderEngine.cpp</span><br><span class="line">index <span class="number">004</span>8000..c1829c2 <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/RenderEngine/GLES20RenderEngine.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/RenderEngine/GLES20RenderEngine.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">//#define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #undef LOG_TAG</span><br><span class="line"> #define LOG_TAG &quot;RenderEngine&quot;</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line">diff --git a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/SurfaceFlinger.cpp b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/SurfaceFlinger.cpp</span><br><span class="line">index de7ff36..f2ba5cc <span class="number">100644</span></span><br><span class="line">--- a/frameworks/<span class="keyword">native</span>/services/surfaceflinger/SurfaceFlinger.cpp</span><br><span class="line">+++ b/frameworks/<span class="keyword">native</span>/services/surfaceflinger/SurfaceFlinger.cpp</span><br><span class="line">@@ -<span class="number">14</span>,<span class="number">7</span> +<span class="number">14</span>,<span class="number">7</span> @@</span><br><span class="line">  * limitations under the License.</span><br><span class="line">  */</span><br><span class="line"> </span><br><span class="line">-<span class="comment">// #define LOG_NDEBUG 0</span></span><br><span class="line">+#define LOG_NDEBUG 0</span><br><span class="line"> #define ATRACE_TAG ATRACE_TAG_GRAPHICS</span><br><span class="line"> </span><br><span class="line"> #include &lt;stdint.h&gt;</span><br><span class="line">@@ -<span class="number">2167</span>,<span class="number">6</span> +<span class="number">2167</span>,<span class="number">7</span> @@ <span class="keyword">void</span> SurfaceFlinger::postFramebuffer()</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">const</span> auto hwcId = displayDevice-&gt;getHwcDisplayId();</span><br><span class="line">         <span class="keyword">if</span> (hwcId &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">+            <span class="comment">//if didn&#x27;t call,the screen will black no pixel</span></span><br><span class="line">             getBE().mHwc-&gt;presentAndGetReleaseFences(hwcId);</span><br><span class="line">         &#125;</span><br><span class="line">         displayDevice-&gt;onSwapBuffersCompleted();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="③完整Log"><a href="#③完整Log" class="headerlink" title="③完整Log"></a>③完整Log</h5><p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/others/mainsystem-ams-wms-red-startActivity.log">mainsystem-ams-wms-red-startActivity.log</a></p>
<h4 id="一、Activity概述"><a href="#一、Activity概述" class="headerlink" title="一、Activity概述"></a>一、Activity概述</h4><p>基于Android 9.0的源码剖析， 分析Android Activity启动流程：</p>
<hr>
<h5 id="1-1、Activity的管理机制"><a href="#1-1、Activity的管理机制" class="headerlink" title="1.1、Activity的管理机制"></a>1.1、Activity的管理机制</h5><p>Android的管理主要是通过Activity栈来进行的。当一个Activity启动时，系统根据其配置或调用的方式，将Activity压入一个特定的栈中，系统处 于运行（Running or Resumed）状态。当按Back键或触发finish()方法时，Activity会从栈中被压出，进而被销毁，当有新的Activity压入栈时， 如果原Activity仍然可见，则原Activity的状态将转变为暂停（Paused）状态，如果原Activity完全被遮挡，那么其状态将转变为 停止（Stopped）。</p>
<h6 id="1-1-1、Task和Stack"><a href="#1-1-1、Task和Stack" class="headerlink" title="1.1.1、Task和Stack"></a>1.1.1、Task和Stack</h6><p>Android系统中的每一个Activity都位于一个Task中。一个Task可以包含多个Activity，同一个Activity也可能有多个实例。 在AndroidManifest.xml中，我们可以通过android:launchMode来控制Activity在Task中的实例。</p>
<h6 id="1-1-2、启动模式的作用"><a href="#1-1-2、启动模式的作用" class="headerlink" title="1.1.2、启动模式的作用"></a>1.1.2、启动模式的作用</h6><p>Activity启动模式就是属于Activity配置属性之一，叫它具有四种启动模式，分别是：1.standard ，2.singleTop，3.singleTask，4.singleInstance，一般如果不显示声明，默认为standard模式。launchMode 在多个Activity跳转的过程中扮演着重要的角色，它可以决定是否生成新的Activity实例，是否重用已存在的Activity实例，是否和其他 Activity实例公用一个task里。</p>
<h6 id="1-1-3、启动模式的作用"><a href="#1-1-3、启动模式的作用" class="headerlink" title="1.1.3、启动模式的作用"></a>1.1.3、启动模式的作用</h6><p><strong>模式说明</strong></p>
<ul>
<li>standard模式：这是系统默认的启动模式，这种模式就是创建一个Activity压入Task容器栈中，当当前Activity激活，并处在和用户交互时，此Activity弹出栈顶，当finish()时候，在任务栈中销毁该实例。</li>
<li>singleTop模式：这种模式首先会判断要激活的Activity是否在栈顶，如果在则不重新创建新的实例，复用当前的实例，如果不在栈顶，则在任务栈中创建实例。条件是是否在栈顶，而不是是否在栈中。</li>
<li>singleTask模式： 这种模式启 动的目标Activity实例如果已经存在task容器栈中，不管当前实例处于栈的任何位置，是栈顶也好，栈底也好，还是处于栈中间，只要目标 Activity实例处于task容器栈中，都可以重用该Activity实例对象，然后，把处于该Activity实例对象上面全部Activity实 例清除掉，并且，task容器栈中永远只有唯一实例对象，不会存在两个相同的实例对象。所以，如果你想你的应用不管怎么启动目标Activity，都只有 唯一一个实例对象，就使用这种启动模式。</li>
<li>singleInstance模式：当该模式Activity实例在任务栈中创建后，只要该实例还在任务栈中，即只要激活的是该类型的Activity，都会通过调用实例的newInstance()方法重用该Activity，此时使用的都是同一个Activity实例，它都会处于任务栈的栈顶。此模式一般用于加载较慢的，比较耗性能且不需要每次都重新创建的Activity。</li>
</ul>
<h6 id="1-1-4、ActivityStack-amp-TaskRecord-amp-ActivityRecord-关系"><a href="#1-1-4、ActivityStack-amp-TaskRecord-amp-ActivityRecord-关系" class="headerlink" title="1.1.4、ActivityStack &amp; TaskRecord &amp; ActivityRecord 关系"></a>1.1.4、ActivityStack &amp; TaskRecord &amp; ActivityRecord 关系</h6><p>Back栈管理了当你在Activity上点击Back键，当前Activity销毁后应该跳转到哪一个Activity的逻辑。</p>
<p>其实在ActivityManagerService与WindowManagerService内部管理中，在Task之外，还有一层容器，这个容器应用开发者和用户可能都不会感觉到或者用到，但它却非常重要，那就是ActivityStack。 下文中，我们将看到，Android系统中的多窗口管理，就是建立在Stack的数据结构上的。 一个ActivityStack中包含了多个TaskRecord，一个TaskRecord中包含了多个ActivityRecord，下图描述了它们的关系：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.ActivityStack_TaskRecord_ActivityRecord.png" alt="enter image description here"></p>
<p>另外还有一点需要注意的是，ActivityManagerService和WindowManagerService中的Task和Stack结构是一一对应的，对应关系对于如下：</p>
<blockquote>
<p>ActivityStack &lt;–&gt; TaskStack<br> TaskRecord   &lt;–&gt; Task</p>
</blockquote>
<p>即，ActivityManagerService中的每一个ActivityStack或者TaskRecord在WindowManagerService中都有对应的TaskStack和Task，这两类对象都有唯一的id（id是int类型），它们通过id进行关联。</p>
<h5 id="1-2、ActivityManagerService相关类简介"><a href="#1-2、ActivityManagerService相关类简介" class="headerlink" title="1.2、ActivityManagerService相关类简介"></a>1.2、ActivityManagerService相关类简介</h5><ul>
<li><p>Instrumentation<br>用于实现应用程序测试代码的基类。当在打开仪器的情况下运行时，这个类将在任何应用程序代码之前为您实例化，允许您监视系统与应用程序的所有交互。可以通过AndroidManifest.xml的标签描述该类的实现。</p>
</li>
<li><p>ActivityManager<br>该类提供与Activity、Service和Process相关的信息以及交互方法， 可以被看作是ActivityManagerService的辅助类。</p>
</li>
<li><p>ActivityManagerService<br>Android中最核心的服务，主要负责系统中四大组件的启动、切换、调度及应用程序的管理和调度等工作。</p>
</li>
<li><p>ActivityThread<br>管理应用程序进程中主线程的执行，根据Activity管理者的请求调度和执行activities、broadcasts及其相关的操作。</p>
</li>
<li><p>ActivityStack<br>负责单个Activity栈的状态和管理。</p>
</li>
<li><p>ActivityStackSupervisor<br>负责所有Activity栈的管理。内部管理了mHomeStack、mFocusedStack和mLastFocusedStack三个Activity栈。其中，mHomeStack管理的是Launcher相关的Activity栈；mFocusedStack管理的是当前显示在前台Activity的Activity栈；mLastFocusedStack管理的是上一次显示在前台Activity的Activity栈。</p>
</li>
<li><p>ClientLifecycleManager<br>用来管理多个客户端生命周期执行请求的管理类。</p>
</li>
<li><p>Activity<br>用来管理客户端视图、点击、输入等功能的抽象，具有完整的生命周期</p>
</li>
<li><p>ViewRootImpl<br>APP进程与system_server进程进行视图相关通信的桥梁，同时也管理着APP进程视图方面操作的主要逻辑</p>
</li>
<li><p>ActivityRecord<br>Activity的信息记录在ActivityRecord对象, 并通过通过成员变量task指向TaskRecord</p>
</li>
</ul>
<blockquote>
<p>ProcessRecord app //跑在哪个进程<br>TaskRecord task //跑在哪个task<br>ActivityInfo info // Activity信息<br>ActivityState state //Activity状态<br>ApplicationInfo appInfo //跑在哪个app<br>ComponentName realActivity //组件名<br>String packageName //包名<br>String processName //进程名<br>int launchMode //启动模式<br>int userId // 该Activity运行在哪个用户id</p>
</blockquote>
<ul>
<li>ActivityState：</li>
</ul>
<blockquote>
<p>INITIALIZING<br>RESUMED：已恢复<br>PAUSING<br>PAUSED：已暂停<br>STOPPING<br>STOPPED：已停止<br>FINISHING<br>DESTROYING<br>DESTROYED：已销毁</p>
</blockquote>
<ul>
<li>TaskRecord<br>Task的信息记录在TaskRecord对象.</li>
</ul>
<blockquote>
<p>ActivityStack stack; //当前所属的stack<br>ArrayList<ActivityRecord> mActivities;; // 当前task的所有Activity列表<br>int taskId<br>String affinity； 是指root activity的affinity，即该Task中第一个Activity;<br>int mCallingUid;<br>String mCallingPackage； //调用者的包名</p>
</blockquote>
<ul>
<li>ActivityStack</li>
</ul>
<blockquote>
<p>ArrayList<TaskRecord> mTaskHistory //保存所有的Task列表<br>final int mStackId;<br>int mDisplayId;<br>ActivityRecord mPausingActivity //正在pause<br>ActivityRecord mLastPausedActivity<br>ActivityRecord mResumedActivity //已经resumed<br>ActivityRecord mLastStartedActivity</p>
</blockquote>
<p>所有前台stack的mResumedActivity的state == RESUMED, 则表示allResumedActivitiesComplete, 此时mLastFocusedStack = mFocusedStack;</p>
<ul>
<li>ActivityStackSupervisor</li>
</ul>
<blockquote>
<p>ActivityStack mHomeStack //桌面的stack<br>ActivityStack mFocusedStack //当前聚焦stack<br>ActivityStack mLastFocusedStack //正在切换<br>SparseArray mActivityDisplays //displayId为key<br>SparseArray mActivityContainers // mStackId为key</p>
</blockquote>
<h5 id="1-3、相关类重要成员变量"><a href="#1-3、相关类重要成员变量" class="headerlink" title="1.3、相关类重要成员变量"></a>1.3、相关类重要成员变量</h5><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.ams_class_member.png" alt="enter image description here"></p>
<h5 id="1-4、小结："><a href="#1-4、小结：" class="headerlink" title="1.4、小结："></a>1.4、小结：</h5><p>总体概览图：<br><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.startActivity_fork_new_process.png" alt="enter image description here"></p>
<p>1、点击桌面App图标，Launcher进程采用Binder IPC向system_server进程发起startActivity请求；<br>2、system_server进程接收到请求后，向zygote进程发送创建进程的请求；<br>3、Zygote进程fork出新的子进程，即App进程；<br>4、App进程，通过Binder IPC向sytem_server进程发起attachApplication请求；<br>5、system_server进程在收到请求后，进行一系列准备工作后，再通过binder IPC向App进程发送scheduleLaunchActivity请求；<br>6、App进程的binder线程（ApplicationThread）在收到请求后，通过handler向主线程发送LAUNCH_ACTIVITY消息；<br>7、主线程在收到Message后，通过发射机制创建目标Activity，并回调Activity.onCreate()等方法。</p>
<h4 id="二、APP请求启动Activity"><a href="#二、APP请求启动Activity" class="headerlink" title="二、APP请求启动Activity"></a>二、APP请求启动Activity</h4><h5 id="2-1、Activity-startActivity"><a href="#2-1、Activity-startActivity" class="headerlink" title="2.1、Activity.startActivity()"></a>2.1、Activity.startActivity()</h5><p>从Launcher启动应用的时候，经过调用会执行Activity中的startActivity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Activity.java]</span><br><span class="line">......</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">[-&gt; Activity.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, <span class="meta">@Nullable</span> Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">            <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-2、Activity-startActivityForResult"><a href="#2-2、Activity-startActivityForResult" class="headerlink" title="2.2、Activity.startActivityForResult()"></a>2.2、Activity.startActivityForResult()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Activity.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String who, Intent intent, <span class="keyword">int</span> requestCode, <span class="meta">@Nullable</span> Bundle options)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, who,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, who, requestCode,</span><br><span class="line">                ar.getResultCode(), ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-3、Instrumentation-execStartActivity"><a href="#2-3、Instrumentation-execStartActivity" class="headerlink" title="2.3、Instrumentation.execStartActivity()"></a>2.3、Instrumentation.execStartActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; Instrumentation.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">        android.util.SeempLog.record_str(<span class="number">377</span>, intent.toString());</span><br><span class="line">        IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            intent.migrateExtraStreamToClipData();</span><br><span class="line">            intent.prepareToLeaveProcess(who);</span><br><span class="line">            <span class="keyword">int</span> result = ActivityManager.getService()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>关于 ActivityManager.getService()返回的是? </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityManagerNative.java]</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> IActivityManagerSingleton.get();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接返回的是gDefault.get()，那么gDefault又是什么呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;IActivityManagerSingleton.java]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">        <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">                <span class="keyword">final</span> IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br><span class="line">                <span class="keyword">return</span> am;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Android <span class="number">9.0</span>已改变没有直接提供Java源码，而是.class文件打包为classes-header.jar和classes.jar。</span><br><span class="line">android\out\target\common\obj\JAVA_LIBRARIES\framework_intermediates\</span><br><span class="line">classes-header.jar</span><br><span class="line">classes.jar解压：</span><br><span class="line">classes/android/app/</span><br><span class="line">    IActivityManager.class</span><br><span class="line">    IActivityManager$Stub.class</span><br><span class="line">    IActivityManager$Stub$Proxy.class</span><br><span class="line"></span><br><span class="line">[解压后在线反编译](http:<span class="comment">//www.javadecompilers.com/)</span></span><br><span class="line">or</span><br><span class="line">[解压后在线反编译](http:<span class="comment">//javare.cn/)</span></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">IActivityManager$Stub.java</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         IInterface iin = obj.queryLocalInterface(<span class="string">&quot;android.app.IActivityManager&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> (IActivityManager)(iin != <span class="keyword">null</span> &amp;&amp; iin <span class="keyword">instanceof</span> IActivityManager?(IActivityManager)iin:<span class="keyword">new</span> Proxy(obj));</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  IActivityManager$Stub$Proxy.java</span><br><span class="line"></span><br><span class="line">  IActivityManager$Stub$Proxy(IBinder remote)</span><br><span class="line">  &#123;</span><br><span class="line">    mRemote = remote;</span><br><span class="line">  &#125;</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后直接返回一个android.app.IActivityManager.Stub.Proxy对象，<br>此处startActivity()的共有10个参数, 下面说说每个参数传递AMP.startActivity()每一项的对应值。</p>
<p>好吧，最后直接返回一个对象，而继承与IActivityManager，到了这里就引出了我们android系统中很重要的一个概念：Binder机制。我们知道应用进程与SystemServer进程属于两个不同的进程，进程之间需要通讯，android系统采取了自身设计的Binder机制，这里的和ActivityManagerNative都是继承与IActivityManager的而SystemServer进程中的ActivityManagerService对象则继承与ActivityManagerNative。简单的表示： </p>
<blockquote>
<p>IActivityManager.aidl -&gt; Binder机制 -&gt; ActivityManagerService</p>
</blockquote>
<p>这样，IActivityManager.Stub.Proxy与相当于一个Binder的客户端而ActivityManagerService相当于Binder的服务端，这样当IActivityManager.Stub.Proxy调用接口方法的时候底层通过Binder driver就会将请求数据与请求传递给server端，并在server端执行具体的接口逻辑。</p>
<p>好了，说了这么多我们知道这里的IActivityManager.Stub.Proxy是ActivityManagerService在应用进程的一个client就好了，通过它就可以滴啊用ActivityManagerService的方法了。</p>
<h5 id="2-4、IActivityManager-Stub-Proxy-startActivity"><a href="#2-4、IActivityManager-Stub-Proxy-startActivity" class="headerlink" title="2.4、IActivityManager.Stub.Proxy.startActivity()"></a>2.4、IActivityManager.Stub.Proxy.startActivity()</h5><p>ActivityManager.getService()方法会返回一个对象，那么我们看一下对象的startActivity方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">IActivityManager.Stub.Proxy.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> flags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel _data = Parcel.obtain();</span><br><span class="line">    Parcel _reply = Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      _data.writeInterfaceToken(<span class="string">&quot;android.app.IActivityManager&quot;</span>);</span><br><span class="line">      _data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">      _data.writeString(callingPackage);</span><br><span class="line">      <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        intent.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      _data.writeString(resolvedType);</span><br><span class="line">      _data.writeStrongBinder(resultTo);</span><br><span class="line">      _data.writeString(resultWho);</span><br><span class="line">      _data.writeInt(requestCode);</span><br><span class="line">      _data.writeInt(flags);</span><br><span class="line">      <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        profilerInfo.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        options.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      mRemote.transact(<span class="number">6</span>, _data, _reply, <span class="number">0</span>);</span><br><span class="line">      _reply.readException();</span><br><span class="line">      _result = _reply.readInt();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> _result;</span><br><span class="line">      _reply.recycle();</span><br><span class="line">      _data.recycle(); &#125;</span><br><span class="line">    <span class="keyword">int</span> _result;</span><br><span class="line">    <span class="keyword">return</span> _result;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h5 id="2-5、IActivityManager-Stub-onTransact"><a href="#2-5、IActivityManager-Stub-onTransact" class="headerlink" title="2.5、IActivityManager.Stub.onTransact()"></a>2.5、IActivityManager.Stub.onTransact()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">IActivityManager.Stub.java</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">      String descriptor = <span class="string">&quot;android.app.IActivityManager&quot;</span>;</span><br><span class="line">      ComponentName _arg0;</span><br><span class="line">      <span class="keyword">boolean</span> _result;</span><br><span class="line">      ......</span><br><span class="line">      <span class="keyword">switch</span>(code) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.onTransact$startActivity$(data, reply);</span><br><span class="line">         </span><br></pre></td></tr></table></figure>

<p>这里就涉及到了具体的Binder数据传输机制了，我们不做过多的分析，知道通过数据传输之后就会调用SystemServer进程的ActivityManagerService的startActivity就好了。</p>
<p>以上其实都是发生在应用进程中，下面开始调用的ActivityManagerService的执行时发生在SystemServer进程。</p>
<h4 id="三、-ActivityManagerService接收启动Activity的请求"><a href="#三、-ActivityManagerService接收启动Activity的请求" class="headerlink" title="三、 ActivityManagerService接收启动Activity的请求"></a>三、 ActivityManagerService接收启动Activity的请求</h4><h5 id="3-1、ActivityManagerService-startActivity"><a href="#3-1、ActivityManagerService-startActivity" class="headerlink" title="3.1、ActivityManagerService.startActivity()"></a>3.1、ActivityManagerService.startActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityManagerService.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">                resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">                UserHandle.getCallingUserId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">                resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">                UserHandle.getCallingUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> validateIncomingUser)</span> </span>&#123;</span><br><span class="line">        enforceNotIsolatedCaller(<span class="string">&quot;startActivity&quot;</span>);</span><br><span class="line"></span><br><span class="line">        userId = mActivityStartController.checkTargetUser(userId, validateIncomingUser,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="string">&quot;startActivityAsUser&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">        <span class="keyword">return</span> mActivityStartController.obtainStarter(intent, <span class="string">&quot;startActivityAsUser&quot;</span>)</span><br><span class="line">                .setCaller(caller)</span><br><span class="line">                .setCallingPackage(callingPackage)</span><br><span class="line">                .setResolvedType(resolvedType)</span><br><span class="line">                .setResultTo(resultTo)</span><br><span class="line">                .setResultWho(resultWho)</span><br><span class="line">                .setRequestCode(requestCode)</span><br><span class="line">                .setStartFlags(startFlags)</span><br><span class="line">                .setProfilerInfo(profilerInfo)</span><br><span class="line">                .setActivityOptions(bOptions)</span><br><span class="line">                .setMayWait(userId)</span><br><span class="line">                .execute();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-2、ActivityStarter-execute"><a href="#3-2、ActivityStarter-execute" class="headerlink" title="3.2、ActivityStarter.execute()"></a>3.2、ActivityStarter.execute()</h5><p>这个方法是基于初始的参数来启动activity,可以看到有两种启动activity的代码块,startActivityMayWait最终会调用startActivity所以:我们来看startActivityMayWait源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Starts an activity based on the request parameters provided earlier.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The starter result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRequest.mayWait) &#123;</span><br><span class="line">                <span class="keyword">return</span> startActivityMayWait(mRequest.caller, mRequest.callingUid,</span><br><span class="line">                        mRequest.callingPackage, mRequest.intent, mRequest.resolvedType,</span><br><span class="line">                        mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                        mRequest.resultWho, mRequest.requestCode, mRequest.startFlags,</span><br><span class="line">                        mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig,</span><br><span class="line">                        mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId,</span><br><span class="line">                        mRequest.inTask, mRequest.reason,</span><br><span class="line">                        mRequest.allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> startActivity(mRequest.caller, mRequest.intent, mRequest.ephemeralIntent,</span><br><span class="line">                        mRequest.resolvedType, mRequest.activityInfo, mRequest.resolveInfo,</span><br><span class="line">                        mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                        mRequest.resultWho, mRequest.requestCode, mRequest.callingPid,</span><br><span class="line">                        mRequest.callingUid, mRequest.callingPackage, mRequest.realCallingPid,</span><br><span class="line">                        mRequest.realCallingUid, mRequest.startFlags, mRequest.activityOptions,</span><br><span class="line">                        mRequest.ignoreTargetSecurity, mRequest.componentSpecified,</span><br><span class="line">                        mRequest.outActivity, mRequest.inTask, mRequest.reason,</span><br><span class="line">                        mRequest.allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            onExecutionComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration globalConfig, SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId, TaskRecord inTask, String reason,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup)</span> </span>&#123;</span><br><span class="line">        .......</span><br><span class="line">        ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId,</span><br><span class="line">                <span class="number">0</span> <span class="comment">/* matchFlags */</span>,</span><br><span class="line">                        computeResolveFilterUid(</span><br><span class="line">                                callingUid, realCallingUid, mRequest.filterCallingUid));</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Collect information about the target of the Intent.</span></span><br><span class="line">        ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = mSupervisor.mFocusedStack;</span><br><span class="line">            stack.mConfigWillChange = globalConfig != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; mService.getGlobalConfiguration().diff(globalConfig) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</span><br><span class="line">                    <span class="string">&quot;Starting activity when config will change = &quot;</span> + stack.mConfigWillChange);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (aInfo.applicationInfo.privateFlags</span><br><span class="line">                            &amp; ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    mService.mHasHeavyWeightFeature) &#123;</span><br><span class="line">                <span class="comment">// This may be a heavy-weight process!  Check to see if we already</span></span><br><span class="line">                <span class="comment">// have another, different heavy-weight process running.</span></span><br><span class="line">                <span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</span><br><span class="line">                    ......</span><br><span class="line">                        Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">                        ......</span><br><span class="line">                        newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT,</span><br><span class="line">                                <span class="keyword">new</span> IntentSender(target));</span><br><span class="line">                        ......</span><br><span class="line">                        newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP,</span><br><span class="line">                                aInfo.packageName);</span><br><span class="line">                        newIntent.setFlags(intent.getFlags());</span><br><span class="line">                        newIntent.setClassName(<span class="string">&quot;android&quot;</span>,</span><br><span class="line">                                HeavyWeightSwitcherActivity.class.getName());</span><br><span class="line">                        intent = newIntent;</span><br><span class="line">                        resolvedType = <span class="keyword">null</span>;</span><br><span class="line">                        caller = <span class="keyword">null</span>;</span><br><span class="line">                        callingUid = Binder.getCallingUid();</span><br><span class="line">                        callingPid = Binder.getCallingPid();</span><br><span class="line">                        componentSpecified = <span class="keyword">true</span>;</span><br><span class="line">                        rInfo = mSupervisor.resolveIntent(intent, <span class="keyword">null</span> <span class="comment">/*resolvedType*/</span>, userId,</span><br><span class="line">                                <span class="number">0</span> <span class="comment">/* matchFlags */</span>, computeResolveFilterUid(</span><br><span class="line">                                        callingUid, realCallingUid, mRequest.filterCallingUid));</span><br><span class="line">                        aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            aInfo = mService.getActivityInfoForUser(aInfo, userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> res = startActivity(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo,</span><br><span class="line">                    voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options,</span><br><span class="line">                    ignoreTargetSecurity, componentSpecified, outRecord, inTask, reason,</span><br><span class="line">                    allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.782</span> I/ActivityMetricsLogger( <span class="number">1049</span>): notifyActivityLaunched resultCode=<span class="number">0</span> launchedActivity=ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; processRunning=<span class="keyword">false</span> processSwitch=<span class="keyword">true</span></span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line">            mSupervisor.getActivityMetricsLogger().notifyActivityLaunched(res, outRecord[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h5 id="3-3、ActivityStarter-startActivity"><a href="#3-3、ActivityStarter-startActivity" class="headerlink" title="3.3、ActivityStarter.startActivity()"></a>3.3、ActivityStarter.startActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity, TaskRecord inTask, String reason,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(reason)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Need to specify a reason.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mLastStartReason = reason;</span><br><span class="line">        mLastStartActivityTimeMs = System.currentTimeMillis();</span><br><span class="line">        mLastStartActivityRecord[<span class="number">0</span>] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line">                callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line">                inTask, allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// mLastStartActivityRecord[0] is set in the call to startActivity above.</span></span><br><span class="line">            outActivity[<span class="number">0</span>] = mLastStartActivityRecord[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getExternalResult(mLastStartActivityResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">                IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">                ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = START_CANCELED;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">            result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                    startFlags, doResume, options, inTask, outActivity);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = mStartActivity.getStack();</span><br><span class="line">            <span class="keyword">if</span> (!ActivityManager.isStartResultSuccessful(result) &amp;&amp; stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stack.finishActivityLocked(mStartActivity, RESULT_CANCELED,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/* intentResultData */</span>, <span class="string">&quot;startActivity&quot;</span>, <span class="keyword">true</span> <span class="comment">/* oomAdj */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mService.mWindowManager.continueSurfaceLayout();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        postStartActivityProcessing(r, result, mTargetStack);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            SafeActivityOptions options,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord inTask, <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">        <span class="comment">// Pull the optional Ephemeral Installer-only bundle out of the options early.</span></span><br><span class="line">        <span class="keyword">final</span> Bundle verificationBundle</span><br><span class="line">                = options != <span class="keyword">null</span> ? options.popAppVerificationBundle() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        ProcessRecord callerApp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            callerApp = mService.getRecordForAppLocked(caller);</span><br><span class="line">            <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                callingPid = callerApp.pid;</span><br><span class="line">                callingUid = callerApp.info.uid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Unable to find app for caller &quot;</span> + caller</span><br><span class="line">                        + <span class="string">&quot; (pid=&quot;</span> + callingPid + <span class="string">&quot;) when starting: &quot;</span></span><br><span class="line">                        + intent.toString());</span><br><span class="line">                err = ActivityManager.START_PERMISSION_DENIED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> &amp;&amp; aInfo.applicationInfo != <span class="keyword">null</span></span><br><span class="line">                ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;START u&quot;</span> + userId + <span class="string">&quot; &#123;&quot;</span> + intent.toShortString(<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>)</span><br><span class="line">                    + <span class="string">&quot;&#125; from uid &quot;</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">        ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</span><br><span class="line">                    <span class="string">&quot;Will send result to &quot;</span> + resultTo + <span class="string">&quot; &quot;</span> + sourceRecord);</span><br><span class="line">            <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class="line">                    resultRecord = sourceRecord;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Transfer the result target from the source activity to the new</span></span><br><span class="line">            <span class="comment">// one being started, including any failures.</span></span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                SafeActivityOptions.abort(options);</span><br><span class="line">                <span class="keyword">return</span> ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;</span><br><span class="line">            &#125;</span><br><span class="line">            resultRecord = sourceRecord.resultTo;</span><br><span class="line">            <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span> &amp;&amp; !resultRecord.isInStackLocked()) &#123;</span><br><span class="line">                resultRecord = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            resultWho = sourceRecord.resultWho;</span><br><span class="line">            requestCode = sourceRecord.requestCode;</span><br><span class="line">            sourceRecord.resultTo = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resultRecord.removeResultsLocked(sourceRecord, resultWho, requestCode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sourceRecord.launchedFromUid == callingUid) &#123;</span><br><span class="line">                callingPackage = sourceRecord.launchedFromPackage;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.getStack();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho,</span><br><span class="line">                requestCode, callingPid, callingUid, callingPackage, ignoreTargetSecurity,</span><br><span class="line">                inTask != <span class="keyword">null</span>, callerApp, resultRecord, resultStack);</span><br><span class="line">        abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</span><br><span class="line">                callingPid, resolvedType, aInfo.applicationInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Merge the two options bundles, while realCallerOptions takes precedence.</span></span><br><span class="line">        ActivityOptions checkedOptions = options != <span class="keyword">null</span></span><br><span class="line">                ? options.getOptions(intent, aInfo, callerApp, mSupervisor)</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (allowPendingRemoteAnimationRegistryLookup) &#123;</span><br><span class="line">            checkedOptions = mService.getActivityStartController()</span><br><span class="line">                    .getPendingRemoteAnimationRegistry()</span><br><span class="line">                    .overrideOptionsIfNeeded(callingPackage, checkedOptions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// The Intent we give to the watcher has the extra data</span></span><br><span class="line">                <span class="comment">// stripped off, since it can contain private information.</span></span><br><span class="line">                Intent watchIntent = intent.cloneFilter();</span><br><span class="line">                abort |= !mService.mController.activityStarting(watchIntent,</span><br><span class="line">                        aInfo.applicationInfo.packageName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                mService.mController = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mInterceptor.setStates(userId, realCallingPid, realCallingUid, startFlags, callingPackage);</span><br><span class="line">        ........</span><br><span class="line">        <span class="comment">// If permissions need a review before any of the app components can run, we</span></span><br><span class="line">        <span class="comment">// launch the review activity and pass a pending intent to start the activity</span></span><br><span class="line">        <span class="comment">// we are to launching now after the review is completed.</span></span><br><span class="line">        <span class="keyword">if</span> (mService.mPermissionReviewRequired &amp;&amp; aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mService.getPackageManagerInternalLocked().isPermissionsReviewRequired(</span><br><span class="line">                    aInfo.packageName, userId)) &#123;</span><br><span class="line">                IIntentSender target = mService.getIntentSenderLocked(</span><br><span class="line">                        ActivityManager.INTENT_SENDER_ACTIVITY, callingPackage,</span><br><span class="line">                        callingUid, userId, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">new</span> Intent[]&#123;intent&#125;,</span><br><span class="line">                        <span class="keyword">new</span> String[]&#123;resolvedType&#125;, PendingIntent.FLAG_CANCEL_CURRENT</span><br><span class="line">                                | PendingIntent.FLAG_ONE_SHOT, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> flags = intent.getFlags();</span><br><span class="line">                Intent newIntent = <span class="keyword">new</span> Intent(Intent.ACTION_REVIEW_PERMISSIONS);</span><br><span class="line">                newIntent.setFlags(flags</span><br><span class="line">                        | Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS);</span><br><span class="line">                newIntent.putExtra(Intent.EXTRA_PACKAGE_NAME, aInfo.packageName);</span><br><span class="line">                newIntent.putExtra(Intent.EXTRA_INTENT, <span class="keyword">new</span> IntentSender(target));</span><br><span class="line">                <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    newIntent.putExtra(Intent.EXTRA_RESULT_NEEDED, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                intent = newIntent;</span><br><span class="line"></span><br><span class="line">                resolvedType = <span class="keyword">null</span>;</span><br><span class="line">                callingUid = realCallingUid;</span><br><span class="line">                callingPid = realCallingPid;</span><br><span class="line"></span><br><span class="line">                rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId, <span class="number">0</span>,</span><br><span class="line">                        computeResolveFilterUid(</span><br><span class="line">                                callingUid, realCallingUid, mRequest.filterCallingUid));</span><br><span class="line">                aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/*profilerInfo*/</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PERMISSIONS_REVIEW) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">&quot;START u&quot;</span> + userId + <span class="string">&quot; &#123;&quot;</span> + intent.toShortString(<span class="keyword">true</span>, <span class="keyword">true</span>,</span><br><span class="line">                            <span class="keyword">true</span>, <span class="keyword">false</span>) + <span class="string">&quot;&#125; from uid &quot;</span> + callingUid + <span class="string">&quot; on display &quot;</span></span><br><span class="line">                            + (mSupervisor.mFocusedStack == <span class="keyword">null</span></span><br><span class="line">                            ? DEFAULT_DISPLAY : mSupervisor.mFocusedStack.mDisplayId));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (rInfo != <span class="keyword">null</span> &amp;&amp; rInfo.auxiliaryInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent = createLaunchIntent(rInfo.auxiliaryInfo, ephemeralIntent,</span><br><span class="line">                    callingPackage, verificationBundle, resolvedType, userId);</span><br><span class="line">            resolvedType = <span class="keyword">null</span>;</span><br><span class="line">            callingUid = realCallingUid;</span><br><span class="line">            callingPid = realCallingPid;</span><br><span class="line"></span><br><span class="line">            aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, <span class="keyword">null</span> <span class="comment">/*profilerInfo*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建ActivityRecord</span></span><br><span class="line">        ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingPid, callingUid,</span><br><span class="line">                callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(),</span><br><span class="line">                resultRecord, resultWho, requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>,</span><br><span class="line">                mSupervisor, checkedOptions, sourceRecord);</span><br><span class="line">        <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outActivity[<span class="number">0</span>] = r;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack = mSupervisor.mFocusedStack;</span><br><span class="line">        ......</span><br><span class="line">        mController.doPendingActivityLaunches(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/* doResume */</span>, checkedOptions, inTask, outActivity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-4、ActivityStarter-startActivityUnchecked"><a href="#3-4、ActivityStarter-startActivityUnchecked" class="headerlink" title="3.4、ActivityStarter.startActivityUnchecked()"></a>3.4、ActivityStarter.startActivityUnchecked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">final</span> TaskRecord taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != <span class="keyword">null</span>)</span><br><span class="line">                ? mSourceRecord.getTask() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Should this be considered a new task?</span></span><br><span class="line">        <span class="keyword">int</span> result = START_SUCCESS;</span><br><span class="line">        <span class="keyword">if</span> (mStartActivity.resultTo == <span class="keyword">null</span> &amp;&amp; mInTask == <span class="keyword">null</span> &amp;&amp; !mAddingToTask</span><br><span class="line">                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">            newTask = <span class="keyword">true</span>;</span><br><span class="line">            String packageName= mService.mContext.getPackageName();</span><br><span class="line">            <span class="keyword">if</span> (mPerf != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mPerf.perfHint(BoostFramework.VENDOR_HINT_FIRST_LAUNCH_BOOST,</span><br><span class="line">                                        packageName, -<span class="number">1</span>, BoostFramework.Launch.BOOST_V1);</span><br><span class="line">            &#125;</span><br><span class="line">            result = setTaskFromReuseOrCreateNewTask(taskToAffiliate, topStack);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = setTaskFromSourceRecord();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = setTaskFromInTask();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This not being started from an existing activity, and not part of a new task...</span></span><br><span class="line">            <span class="comment">// just put it in the top task, though these days this case should never happen.</span></span><br><span class="line">            setTaskToCurrentTopOrCreateNewTask();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result != START_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,</span><br><span class="line">                mOptions);</span><br><span class="line">        <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord topTaskActivity =</span><br><span class="line">                    mStartActivity.getTask().topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                    || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                    &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">                mTargetStack.ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">                mService.mWindowManager.executeAppTransition();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</span><br><span class="line">                    mTargetStack.moveToFront(<span class="string">&quot;startActivityUnchecked&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class="line">                        mOptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mStartActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSupervisor.mRecentTasks.add(mStartActivity.getTask());</span><br><span class="line">        &#125;</span><br><span class="line">        mSupervisor.updateUserStackLocked(mStartActivity.userId, mTargetStack);</span><br><span class="line"></span><br><span class="line">        mSupervisor.handleNonResizableTaskIfNeeded(mStartActivity.getTask(), preferredWindowingMode,</span><br><span class="line">                preferredLaunchDisplayId, mTargetStack);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-4-1、ActivityStarter-setTaskFromReuseOrCreateNewTask-创建新的Task-AMS端"><a href="#3-4-1、ActivityStarter-setTaskFromReuseOrCreateNewTask-创建新的Task-AMS端" class="headerlink" title="3.4.1、ActivityStarter.setTaskFromReuseOrCreateNewTask()-创建新的Task[AMS端]"></a>3.4.1、ActivityStarter.setTaskFromReuseOrCreateNewTask()-创建新的Task[AMS端]</h5><p>在此情况下Activity启动Flag为FLAG_ACTIVITY_NEW_TASK</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStarter.java]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setTaskFromReuseOrCreateNewTask</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord taskToAffiliate, ActivityStack topStack)</span> </span>&#123;</span><br><span class="line">        mTargetStack = computeStackFocus(mStartActivity, <span class="keyword">true</span>, mLaunchFlags, mOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do no move the target stack to front yet, as we might bail if</span></span><br><span class="line">        <span class="comment">// isLockTaskModeViolation fails below.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> TaskRecord task = mTargetStack.createTaskRecord(</span><br><span class="line">                    mSupervisor.getNextTaskIdForUserLocked(mStartActivity.userId),</span><br><span class="line">                    mNewTaskInfo != <span class="keyword">null</span> ? mNewTaskInfo : mStartActivity.info,</span><br><span class="line">                    mNewTaskIntent != <span class="keyword">null</span> ? mNewTaskIntent : mIntent, mVoiceSession,</span><br><span class="line">                    mVoiceInteractor, !mLaunchTaskBehind <span class="comment">/* toTop */</span>, mStartActivity, mSourceRecord,</span><br><span class="line">                    mOptions);</span><br><span class="line">            addOrReparentStartingActivity(task, <span class="string">&quot;setTaskFromReuseOrCreateNewTask - mReuseTask&quot;</span>);</span><br><span class="line">            updateBounds(mStartActivity.getTask(), mLaunchParams.mBounds);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_TASKS) Slog.v(TAG_TASKS, <span class="string">&quot;Starting new activity &quot;</span> + mStartActivity</span><br><span class="line">                    + <span class="string">&quot; in new task &quot;</span> + mStartActivity.getTask());</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">此处对应Log：</span><br><span class="line"></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.757</span> D/WindowManager( <span class="number">1049</span>): positionTask: task=&#123;stackId=<span class="number">1</span> tasks=[&#123;taskId=<span class="number">5</span> appTokens=[] mdr=<span class="keyword">false</span>&#125;]&#125; position=<span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">04-16 13:08:36.758 V/ActivityStackSupervisor_Tasks( 1049): Starting new activity ActivityRecord&#123;65cc87a u0 com.android.testred/.TestActivity t5&#125; in new task TaskRecord&#123;d697e21 #5 A=com.android.testred U=0 StackId=1 sz=1&#125;</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addOrReparentStartingActivity(mReuseTask, <span class="string">&quot;setTaskFromReuseOrCreateNewTask&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (taskToAffiliate != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mStartActivity.setTaskToAffiliateWith(taskToAffiliate);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mService.getLockTaskController().isLockTaskModeViolation(mStartActivity.getTask())) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;Attempted Lock Task Mode violation mStartActivity=&quot;</span> + mStartActivity);</span><br><span class="line">            <span class="keyword">return</span> START_RETURN_LOCK_TASK_MODE_VIOLATION;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">            mTargetStack.moveToFront(<span class="string">&quot;reuseOrNewTask&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="3-4-1-1、TaskRecord创建createTaskRecord"><a href="#3-4-1-1、TaskRecord创建createTaskRecord" class="headerlink" title="3.4.1.1、TaskRecord创建createTaskRecord()"></a>3.4.1.1、TaskRecord创建createTaskRecord()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityStack.java]</span><br><span class="line">    <span class="function">TaskRecord <span class="title">createTaskRecord</span><span class="params">(<span class="keyword">int</span> taskId, ActivityInfo info, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> toTop, ActivityRecord activity, ActivityRecord source,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建TaskRecord</span></span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = TaskRecord.create(</span><br><span class="line">                mService, taskId, info, intent, voiceSession, voiceInteractor);</span><br><span class="line">        <span class="comment">// add the task to stack first, mTaskPositioner might need the stack association</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将TaskRecord加入到ActivityStack中</span></span><br><span class="line">        addTask(task, toTop, <span class="string">&quot;createTaskRecord&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplayId != INVALID_DISPLAY ? mDisplayId : DEFAULT_DISPLAY;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isLockscreenShown = mService.mStackSupervisor.getKeyguardController()</span><br><span class="line">                .isKeyguardOrAodShowing(displayId);</span><br><span class="line">        <span class="keyword">if</span> (!mStackSupervisor.getLaunchParamsController()</span><br><span class="line">                .layoutTask(task, info.windowLayout, activity, source, options)</span><br><span class="line">                &amp;&amp; !matchParentBounds() &amp;&amp; task.isResizeable() &amp;&amp; !isLockscreenShown) &#123;</span><br><span class="line">            task.updateOverrideConfiguration(getOverrideBounds());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建WindowContainer</span></span><br><span class="line">        task.createWindowContainer(toTop, (info.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> task;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="3-4-1-1-1、TaskRecord-create"><a href="#3-4-1-1-1、TaskRecord-create" class="headerlink" title="3.4.1.1.1、TaskRecord.create()"></a>3.4.1.1.1、TaskRecord.create()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; TaskRecord.java]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> TaskRecord <span class="title">create</span><span class="params">(ActivityManagerService service, <span class="keyword">int</span> taskId, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, IVoiceInteractionSession voiceSession,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getTaskRecordFactory().create(</span><br><span class="line">                service, taskId, info, intent, voiceSession, voiceInteractor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskRecordFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">TaskRecord <span class="title">create</span><span class="params">(ActivityManagerService service, <span class="keyword">int</span> taskId, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                Intent intent, IVoiceInteractionSession voiceSession,</span></span></span><br><span class="line"><span class="function"><span class="params">                IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TaskRecord(</span><br><span class="line">                    service, taskId, info, intent, voiceSession, voiceInteractor);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Don&#x27;t use constructor directly. Use &#123;<span class="doctag">@link</span> #create(ActivityManagerService, int, ActivityInfo,</span></span><br><span class="line"><span class="comment">     * Intent, TaskDescription)&#125; instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TaskRecord(ActivityManagerService service, <span class="keyword">int</span> _taskId, ActivityInfo info, Intent _intent,</span><br><span class="line">            IVoiceInteractionSession _voiceSession, IVoiceInteractor _voiceInteractor) &#123;</span><br><span class="line">        mService = service;</span><br><span class="line">        userId = UserHandle.getUserId(info.applicationInfo.uid);</span><br><span class="line">        taskId = _taskId;</span><br><span class="line">        lastActiveTime = SystemClock.elapsedRealtime();</span><br><span class="line">        mAffiliatedTaskId = _taskId;</span><br><span class="line">        voiceSession = _voiceSession;</span><br><span class="line">        voiceInteractor = _voiceInteractor;</span><br><span class="line">        isAvailable = <span class="keyword">true</span>;</span><br><span class="line">        mActivities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        mCallingUid = info.applicationInfo.uid;</span><br><span class="line">        mCallingPackage = info.packageName;</span><br><span class="line">        setIntent(_intent, info);</span><br><span class="line">        setMinDimensions(info);</span><br><span class="line">        touchActiveTime();</span><br><span class="line">        mService.mTaskChangeNotificationController.notifyTaskCreated(_taskId, realActivity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="3-4-1-1-2、将TaskRecord加入到ActivityStack中"><a href="#3-4-1-1-2、将TaskRecord加入到ActivityStack中" class="headerlink" title="3.4.1.1.2、将TaskRecord加入到ActivityStack中"></a>3.4.1.1.2、将TaskRecord加入到ActivityStack中</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; TaskRecord.java]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(<span class="keyword">final</span> TaskRecord task, <span class="keyword">final</span> <span class="keyword">boolean</span> toTop, String reason)</span> </span>&#123;</span><br><span class="line">        addTask(task, toTop ? MAX_VALUE : <span class="number">0</span>, <span class="keyword">true</span> <span class="comment">/* schedulePictureInPictureModeChange */</span>, reason);</span><br><span class="line">        <span class="keyword">if</span> (toTop) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> figure-out a way to remove this call.</span></span><br><span class="line">            mWindowContainerController.positionChildAtTop(task.getWindowContainerController(),</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* includingParents */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(<span class="keyword">final</span> TaskRecord task, <span class="keyword">int</span> position, <span class="keyword">boolean</span> schedulePictureInPictureModeChange,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Is this remove really needed? Need to look into the call path for the other addTask</span></span><br><span class="line">        mTaskHistory.remove(task);</span><br><span class="line">        position = getAdjustedPositionForTask(task, position, <span class="keyword">null</span> <span class="comment">/* starting */</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> toTop = position &gt;= mTaskHistory.size();</span><br><span class="line">        <span class="keyword">final</span> ActivityStack prevStack = preAddTask(task, reason, toTop);</span><br><span class="line">        <span class="comment">//将TaskRecord加入到mTaskHistory中</span></span><br><span class="line">        mTaskHistory.add(position, task);</span><br><span class="line">        <span class="comment">//设置对应的setStack</span></span><br><span class="line">        task.setStack(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        updateTaskMovement(task, toTop);</span><br><span class="line"></span><br><span class="line">        postAddTask(task, prevStack, schedulePictureInPictureModeChange);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="3-4-1-1-3、TaskRecord-createWindowContainer"><a href="#3-4-1-1-3、TaskRecord-createWindowContainer" class="headerlink" title="3.4.1.1.3、TaskRecord.createWindowContainer()"></a>3.4.1.1.3、TaskRecord.createWindowContainer()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; TaskRecord.java]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createWindowContainer</span><span class="params">(<span class="keyword">boolean</span> onTop, <span class="keyword">boolean</span> showForAllUsers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mWindowContainerController != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Window container=&quot;</span> + mWindowContainerController</span><br><span class="line">                    + <span class="string">&quot; already created for task=&quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Rect bounds = updateOverrideConfigurationFromLaunchBounds();</span><br><span class="line">        setWindowContainerController(<span class="keyword">new</span> TaskWindowContainerController(taskId, <span class="keyword">this</span>,</span><br><span class="line">                getStack().getWindowContainerController(), userId, bounds,</span><br><span class="line">                mResizeMode, mSupportsPictureInPicture, onTop,</span><br><span class="line">                showForAllUsers, lastTaskDescription));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskWindowContainerController</span><span class="params">(<span class="keyword">int</span> taskId, TaskWindowContainerListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">            StackWindowController stackController, <span class="keyword">int</span> userId, Rect bounds, <span class="keyword">int</span> resizeMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> supportsPictureInPicture, <span class="keyword">boolean</span> toTop, <span class="keyword">boolean</span> showForAllUsers,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskDescription taskDescription)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(taskId, listener, stackController, userId, bounds, resizeMode,</span><br><span class="line">                supportsPictureInPicture, toTop, showForAllUsers, taskDescription,</span><br><span class="line">                WindowManagerService.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line">[-&gt; TaskWindowContainerController.java]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskWindowContainerController</span><span class="params">(<span class="keyword">int</span> taskId, TaskWindowContainerListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">            StackWindowController stackController, <span class="keyword">int</span> userId, Rect bounds, <span class="keyword">int</span> resizeMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> supportsPictureInPicture, <span class="keyword">boolean</span> toTop, <span class="keyword">boolean</span> showForAllUsers,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskDescription taskDescription, WindowManagerService service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(listener, service);</span><br><span class="line">        mTaskId = taskId;</span><br><span class="line">        mHandler = <span class="keyword">new</span> H(<span class="keyword">new</span> WeakReference&lt;&gt;(<span class="keyword">this</span>), service.mH.getLooper());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STACK) Slog.i(TAG_WM, <span class="string">&quot;TaskWindowContainerController: taskId=&quot;</span> + taskId</span><br><span class="line">                    + <span class="string">&quot; stack=&quot;</span> + stackController + <span class="string">&quot; bounds=&quot;</span> + bounds);</span><br><span class="line">            <span class="comment">//TaskStack，对应ActivityStack</span></span><br><span class="line">            <span class="keyword">final</span> TaskStack stack = stackController.mContainer;</span><br><span class="line">            <span class="keyword">if</span> (stack == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;TaskWindowContainerController: invalid stack=&quot;</span></span><br><span class="line">                        + stackController);</span><br><span class="line">            &#125;</span><br><span class="line">            EventLog.writeEvent(WM_TASK_CREATED, taskId, stack.mStackId);</span><br><span class="line">            <span class="comment">//根据AMS端的taskId创建WMS端的Task，对应AMS的TaskRecord</span></span><br><span class="line">            <span class="keyword">final</span> Task task = createTask(taskId, stack, userId, resizeMode,</span><br><span class="line">                    supportsPictureInPicture, taskDescription);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> position = toTop ? POSITION_TOP : POSITION_BOTTOM;</span><br><span class="line">            <span class="comment">// We only want to move the parents to the parents if we are creating this task at the</span></span><br><span class="line">            <span class="comment">// top of its stack.</span></span><br><span class="line">            stack.addTask(task, position, showForAllUsers, toTop <span class="comment">/* moveParents */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3-4-1-1-4、TaskWindowContainerController-createTask-WMS端的Task"><a href="#3-4-1-1-4、TaskWindowContainerController-createTask-WMS端的Task" class="headerlink" title="3.4.1.1.4、TaskWindowContainerController.createTask()[WMS端的Task]"></a>3.4.1.1.4、TaskWindowContainerController.createTask()[WMS端的Task]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; TaskWindowContainerController.java]</span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function">Task <span class="title">createTask</span><span class="params">(<span class="keyword">int</span> taskId, TaskStack stack, <span class="keyword">int</span> userId, <span class="keyword">int</span> resizeMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> supportsPictureInPicture, TaskDescription taskDescription)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Task(taskId, stack, userId, mService, resizeMode, supportsPictureInPicture,</span><br><span class="line">                taskDescription, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">[-&gt; G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\Task.java]</span><br><span class="line">    Task(<span class="keyword">int</span> taskId, TaskStack stack, <span class="keyword">int</span> userId, WindowManagerService service, <span class="keyword">int</span> resizeMode,</span><br><span class="line">            <span class="keyword">boolean</span> supportsPictureInPicture, TaskDescription taskDescription,</span><br><span class="line">            TaskWindowContainerController controller) &#123;</span><br><span class="line">        <span class="keyword">super</span>(service);</span><br><span class="line">        mTaskId = taskId;</span><br><span class="line">        mStack = stack;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mResizeMode = resizeMode;</span><br><span class="line">        mSupportsPictureInPicture = supportsPictureInPicture;</span><br><span class="line">        setController(controller);</span><br><span class="line">        setBounds(getOverrideBounds());</span><br><span class="line">        mTaskDescription = taskDescription;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tasks have no set orientation value (including SCREEN_ORIENTATION_UNSPECIFIED).</span></span><br><span class="line">        setOrientation(SCREEN_ORIENTATION_UNSET);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-4-1-1-5、将Task-WMS-加入到TaskStack"><a href="#3-4-1-1-5、将Task-WMS-加入到TaskStack" class="headerlink" title="3.4.1.1.5、将Task[WMS]加入到TaskStack"></a>3.4.1.1.5、将Task[WMS]加入到TaskStack</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\TaskStack.java]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(Task task, <span class="keyword">int</span> position, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">boolean</span> moveParents)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> TaskStack currentStack = task.mStack;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> We pass stack to task&#x27;s constructor, but we still need to call this method.</span></span><br><span class="line">        <span class="comment">// This doesn&#x27;t make sense, mStack will already be set equal to &quot;this&quot; at this point.</span></span><br><span class="line">        <span class="keyword">if</span> (currentStack != <span class="keyword">null</span> &amp;&amp; currentStack.mStackId != mStackId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Trying to add taskId=&quot;</span> + task.mTaskId</span><br><span class="line">                    + <span class="string">&quot; to stackId=&quot;</span> + mStackId</span><br><span class="line">                    + <span class="string">&quot;, but it is already attached to stackId=&quot;</span> + task.mStack.mStackId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add child task.</span></span><br><span class="line">        task.mStack = <span class="keyword">this</span>;</span><br><span class="line">        addChild(task, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Move child to a proper position, as some restriction for position might apply.</span></span><br><span class="line">        positionChildAt(position, task, moveParents <span class="comment">/* includingParents */</span>, showForAllUsers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">positionChildAt</span><span class="params">(<span class="keyword">int</span> position, Task child, <span class="keyword">boolean</span> includingParents)</span> </span>&#123;</span><br><span class="line">        positionChildAt(position, child, includingParents, child.showForAllUsers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">positionChildAt</span><span class="params">(<span class="keyword">int</span> position, Task child, <span class="keyword">boolean</span> includingParents,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> showForAllUsers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> targetPosition = findPositionForTask(child, position, showForAllUsers,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* addingNew */</span>);</span><br><span class="line">        <span class="keyword">super</span>.positionChildAt(targetPosition, child, includingParents);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Log positioning.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_TASK_MOVEMENT)</span><br><span class="line">            Slog.d(TAG_WM, <span class="string">&quot;positionTask: task=&quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; position=&quot;</span> + position);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> toTop = targetPosition == mChildren.size() - <span class="number">1</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        EventLog.writeEvent(EventLogTags.WM_TASK_MOVED, child.mTaskId, toTop, targetPosition);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2、ActivityStack-startActivityLocked"><a href="#3-4-2、ActivityStack-startActivityLocked" class="headerlink" title="3.4.2、ActivityStack.startActivityLocked()"></a>3.4.2、ActivityStack.startActivityLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityStack.java]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, ActivityRecord focusedTopActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> keepCurTransition, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">        TaskRecord rTask = r.getTask();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</span><br><span class="line">        <span class="comment">// mLaunchTaskBehind tasks get placed at the back of the task stack.</span></span><br><span class="line">        <span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</span><br><span class="line">            insertTaskAtTop(rTask, r);</span><br><span class="line">        &#125;</span><br><span class="line">        TaskRecord task = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!newTask) &#123;</span><br><span class="line">            <span class="comment">// If starting in an existing task, find where that is...</span></span><br><span class="line">            <span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">                task = mTaskHistory.get(taskNdx);</span><br><span class="line">                <span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// All activities in task are finishing.</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (task == rTask) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!startIt) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">&quot;Adding activity &quot;</span> + r + <span class="string">&quot; to task &quot;</span></span><br><span class="line">                                + task, <span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());</span><br><span class="line">                        r.createWindowContainer();</span><br><span class="line">                        ActivityOptions.abort(options);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    startIt = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskRecord activityTask = r.getTask();</span><br><span class="line">        <span class="keyword">if</span> (task == activityTask &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</span><br><span class="line">            mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_USER_LEAVING) Slog.v(TAG_USER_LEAVING,</span><br><span class="line">                    <span class="string">&quot;startActivity() behind front, mUserLeaving=false&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        task = activityTask;</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">此处对应Log：</span><br><span class="line">04-16 13:08:36.765 I/ActivityStack( 1049): Adding activity ActivityRecord&#123;65cc87a u0 com.android.testred/.TestActivity t5&#125; to stack to task TaskRecord&#123;d697e21 #5 A=com.android.testred U=0 StackId=1 sz=1&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>): java.lang.RuntimeException: here</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStack.startActivityLocked(ActivityStack.java:<span class="number">2963</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStarter.startActivityUnchecked(ActivityStarter.java:<span class="number">1448</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStarter.startActivity(ActivityStarter.java:<span class="number">1204</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStarter.startActivity(ActivityStarter.java:<span class="number">872</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStarter.startActivity(ActivityStarter.java:<span class="number">548</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStarter.startActivityMayWait(ActivityStarter.java:<span class="number">1103</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityStarter.execute(ActivityStarter.java:<span class="number">490</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityManagerService.startActivityAsUser(ActivityManagerService.java:<span class="number">5182</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityManagerService.startActivityAsUser(ActivityManagerService.java:<span class="number">5156</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityManagerShellCommand.runStartActivity(ActivityManagerShellCommand.java:<span class="number">479</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityManagerShellCommand.onCommand(ActivityManagerShellCommand.java:<span class="number">161</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at android.os.ShellCommand.exec(ShellCommand.java:<span class="number">103</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityManagerService.onShellCommand(ActivityManagerService.java:<span class="number">16147</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at android.os.Binder.shellCommand(Binder.java:<span class="number">634</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at android.os.Binder.onTransact(Binder.java:<span class="number">532</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at android.app.IActivityManager$Stub.onTransact(IActivityManager.java:<span class="number">3592</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at com.android.server.am.ActivityManagerService.onTransact(ActivityManagerService.java:<span class="number">3340</span>)</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> I/ActivityStack( <span class="number">1049</span>):     at android.os.Binder.execTransact(Binder.java:<span class="number">731</span>)</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">        <span class="comment">// Slot the activity into the history stack and proceed</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ADD_REMOVE) Slog.i(TAG, <span class="string">&quot;Adding activity &quot;</span> + r + <span class="string">&quot; to stack to task &quot;</span> + task,</span><br><span class="line">                <span class="keyword">new</span> RuntimeException(<span class="string">&quot;here&quot;</span>).fillInStackTrace());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.getWindowContainerController() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.createWindowContainer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将TaskRecord设置为front task</span></span><br><span class="line">        task.setFrontOfTask();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mActivityTrigger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mActivityTrigger.activityStartTrigger(r.intent, r.info, r.appInfo, r.fullscreen);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mActivityPluginDelegate != <span class="keyword">null</span> &amp;&amp; getWindowingMode() != WINDOWING_MODE_UNDEFINED) &#123;</span><br><span class="line">            mActivityPluginDelegate.activityInvokeNotification</span><br><span class="line">                (r.appInfo.packageName, getWindowingMode() == WINDOWING_MODE_FULLSCREEN);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isActivityTypeHome() || numActivities() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_TRANSITION) Slog.v(TAG_TRANSITION,</span><br><span class="line">                    <span class="string">&quot;Prepare open transition: starting &quot;</span> + r);</span><br><span class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</span><br><span class="line">                mWindowManager.prepareAppTransition(TRANSIT_NONE, keepCurTransition);</span><br><span class="line">                mStackSupervisor.mNoAnimActivities.add(r);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> transit = TRANSIT_ACTIVITY_OPEN;</span><br><span class="line">                <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">                        transit = TRANSIT_TASK_OPEN_BEHIND;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (canEnterPipOnTaskSwitch(focusedTopActivity,</span><br><span class="line">                                <span class="keyword">null</span> <span class="comment">/* toFrontTask */</span>, r, options)) &#123;</span><br><span class="line">                            focusedTopActivity.supportsEnterPipOnTaskSwitch = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        transit = TRANSIT_TASK_OPEN;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//准备App启动变换</span></span><br><span class="line">                mWindowManager.prepareAppTransition(transit, keepCurTransition);</span><br><span class="line">                mStackSupervisor.mNoAnimActivities.remove(r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (newTask) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    resetTaskIfNeededLocked(r, r);</span><br><span class="line">                    doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; options.getAnimationType()</span><br><span class="line">                    == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</span><br><span class="line">                doShow = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</span><br><span class="line">                r.setVisibility(<span class="keyword">true</span>);</span><br><span class="line">                ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</span><br><span class="line">                TaskRecord prevTask = r.getTask();</span><br><span class="line">                ActivityRecord prev = prevTask.topRunningActivityWithStartingWindowLocked();</span><br><span class="line">                <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (prev.getTask() != prevTask) &#123;</span><br><span class="line">                        prev = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</span><br><span class="line">                        prev = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 显示启动窗口</span></span><br><span class="line">                r.showStartingWindow(prev, newTask, isTaskSwitch(r, focusedTopActivity));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ActivityOptions.abort(options);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">    Line <span class="number">1046</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.768</span> V/ActivityStack_Transition( <span class="number">1049</span>): Prepare open transition: starting ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;</span><br><span class="line">    Line <span class="number">1051</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.768</span> V/WindowManager( <span class="number">1049</span>): setAppStartingWindow: token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125; pkg=com.android.testred transferFrom=<span class="keyword">null</span> newTask=<span class="keyword">true</span> taskSwitch=<span class="keyword">true</span> processRunning=<span class="keyword">false</span> allowTaskSnapshot=<span class="keyword">true</span></span><br><span class="line">    Line <span class="number">1051</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.768</span> V/WindowManager( <span class="number">1049</span>): setAppStartingWindow: token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125; pkg=com.android.testred transferFrom=<span class="keyword">null</span> newTask=<span class="keyword">true</span> taskSwitch=<span class="keyword">true</span> processRunning=<span class="keyword">false</span> allowTaskSnapshot=<span class="keyword">true</span></span><br><span class="line">    Line <span class="number">1054</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> V/ActivityStack_Switch( <span class="number">1049</span>): Resuming ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;</span><br><span class="line">    Line <span class="number">1055</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> D/ActivityTrigger( <span class="number">1049</span>): activityResumeTrigger: Activity is not Triggerred in full screen ApplicationInfo&#123;<span class="number">2</span>bedb5d com.android.testred&#125;</span><br><span class="line">---------------------------------------------------</span><br></pre></td></tr></table></figure>


<p>分段来看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (r.getWindowContainerController() == <span class="keyword">null</span>) &#123;</span><br><span class="line">    r.createWindowContainer();</span><br><span class="line">&#125;</span><br><span class="line">task.setFrontOfTask();</span><br></pre></td></tr></table></figure>

<h5 id="3-4-2-1、ActivityRecord-createWindowContainer"><a href="#3-4-2-1、ActivityRecord-createWindowContainer" class="headerlink" title="3.4.2.1、ActivityRecord.createWindowContainer()"></a>3.4.2.1、ActivityRecord.createWindowContainer()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityRecord.java</span><br><span class="line">    <span class="keyword">final</span> IApplicationToken.Stub appToken; <span class="comment">// window manager token</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createWindowContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        inHistory = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskWindowContainerController taskController = task.getWindowContainerController();</span><br><span class="line">        ......</span><br><span class="line">        mWindowContainerController = <span class="keyword">new</span> AppWindowContainerController(taskController, appToken,</span><br><span class="line">                <span class="keyword">this</span>, Integer.MAX_VALUE <span class="comment">/* add on top */</span>, info.screenOrientation, fullscreen,</span><br><span class="line">                (info.flags &amp; FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, info.configChanges,</span><br><span class="line">                task.voiceSession != <span class="keyword">null</span>, mLaunchTaskBehind, isAlwaysFocusable(),</span><br><span class="line">                appInfo.targetSdkVersion, mRotationAnimationHint,</span><br><span class="line">                ActivityManagerService.getInputDispatchingTimeoutLocked(<span class="keyword">this</span>) * <span class="number">1000000L</span>);</span><br><span class="line">        <span class="comment">//将当前ActivityRecord加入到TaskRecord的顶部</span></span><br><span class="line">        task.addActivityToTop(<span class="keyword">this</span>);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\AppWindowContainerController.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppWindowContainerController</span><span class="params">(TaskWindowContainerController taskController,</span></span></span><br><span class="line"><span class="function"><span class="params">            IApplicationToken token, AppWindowContainerListener listener, <span class="keyword">int</span> index,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestedOrientation, <span class="keyword">boolean</span> fullscreen, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> voiceInteraction, <span class="keyword">boolean</span> launchTaskBehind, <span class="keyword">boolean</span> alwaysFocusable,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> targetSdkVersion, <span class="keyword">int</span> rotationAnimationHint, <span class="keyword">long</span> inputDispatchingTimeoutNanos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(taskController, token, listener, index, requestedOrientation, fullscreen,</span><br><span class="line">                showForAllUsers,</span><br><span class="line">                configChanges, voiceInteraction, launchTaskBehind, alwaysFocusable,</span><br><span class="line">                targetSdkVersion, rotationAnimationHint, inputDispatchingTimeoutNanos,</span><br><span class="line">                WindowManagerService.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppWindowContainerController</span><span class="params">(TaskWindowContainerController taskController,</span></span></span><br><span class="line"><span class="function"><span class="params">            IApplicationToken token, AppWindowContainerListener listener, <span class="keyword">int</span> index,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> requestedOrientation, <span class="keyword">boolean</span> fullscreen, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> voiceInteraction, <span class="keyword">boolean</span> launchTaskBehind, <span class="keyword">boolean</span> alwaysFocusable,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> targetSdkVersion, <span class="keyword">int</span> rotationAnimationHint, <span class="keyword">long</span> inputDispatchingTimeoutNanos,</span></span></span><br><span class="line"><span class="function"><span class="params">            WindowManagerService service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(listener, service);</span><br><span class="line">        mHandler = <span class="keyword">new</span> H(service.mH.getLooper());</span><br><span class="line">        mToken = token;</span><br><span class="line">        <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">            AppWindowToken atoken = mRoot.getAppWindowToken(mToken.asBinder());</span><br><span class="line">            <span class="keyword">if</span> (atoken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> Should this throw an exception instead?</span></span><br><span class="line">                Slog.w(TAG_WM, <span class="string">&quot;Attempted to add existing app token: &quot;</span> + mToken);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Task task = taskController.mContainer;</span><br><span class="line">            <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;AppWindowContainerController: invalid &quot;</span></span><br><span class="line">                        + <span class="string">&quot; controller=&quot;</span> + taskController);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            atoken = createAppWindow(mService, token, voiceInteraction, task.getDisplayContent(),</span><br><span class="line">                    inputDispatchingTimeoutNanos, fullscreen, showForAllUsers, targetSdkVersion,</span><br><span class="line">                    requestedOrientation, rotationAnimationHint, configChanges, launchTaskBehind,</span><br><span class="line">                    alwaysFocusable, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.765</span> V/WindowManager( <span class="number">1049</span>): addAppToken: AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125; controller=&#123;TaskWindowContainerController taskId=<span class="number">5</span>&#125; at <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_TOKEN_MOVEMENT || DEBUG_ADD_REMOVE) Slog.v(TAG_WM, <span class="string">&quot;addAppToken: &quot;</span> + atoken</span><br><span class="line">                    + <span class="string">&quot; controller=&quot;</span> + taskController + <span class="string">&quot; at &quot;</span> + index);</span><br><span class="line">            task.addChild(atoken, index);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function">AppWindowToken <span class="title">createAppWindow</span><span class="params">(WindowManagerService service, IApplicationToken token,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> voiceInteraction, DisplayContent dc, <span class="keyword">long</span> inputDispatchingTimeoutNanos,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> fullscreen, <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">int</span> targetSdk, <span class="keyword">int</span> orientation,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> rotationAnimationHint, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> launchTaskBehind,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> alwaysFocusable, AppWindowContainerController controller)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppWindowToken(service, token, voiceInteraction, dc,</span><br><span class="line">                inputDispatchingTimeoutNanos, fullscreen, showForAllUsers, targetSdk, orientation,</span><br><span class="line">                rotationAnimationHint, configChanges, launchTaskBehind, alwaysFocusable,</span><br><span class="line">                controller);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[-&gt; G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\wm\AppWindowToken.java]</span><br><span class="line">    <span class="comment">// Non-null only for application tokens.</span></span><br><span class="line">    <span class="keyword">final</span> IApplicationToken appToken;</span><br><span class="line">    </span><br><span class="line">    AppWindowToken(WindowManagerService service, IApplicationToken token, <span class="keyword">boolean</span> voiceInteraction,</span><br><span class="line">            DisplayContent dc, <span class="keyword">long</span> inputDispatchingTimeoutNanos, <span class="keyword">boolean</span> fullscreen,</span><br><span class="line">            <span class="keyword">boolean</span> showForAllUsers, <span class="keyword">int</span> targetSdk, <span class="keyword">int</span> orientation, <span class="keyword">int</span> rotationAnimationHint,</span><br><span class="line">            <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> launchTaskBehind, <span class="keyword">boolean</span> alwaysFocusable,</span><br><span class="line">            AppWindowContainerController controller) &#123;</span><br><span class="line">        <span class="keyword">this</span>(service, token, voiceInteraction, dc, fullscreen);</span><br><span class="line">        setController(controller);</span><br><span class="line">        mInputDispatchingTimeoutNanos = inputDispatchingTimeoutNanos;</span><br><span class="line">        mShowForAllUsers = showForAllUsers;</span><br><span class="line">        mTargetSdk = targetSdk;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">        layoutConfigChanges = (configChanges &amp; (CONFIG_SCREEN_SIZE | CONFIG_ORIENTATION)) != <span class="number">0</span>;</span><br><span class="line">        mLaunchTaskBehind = launchTaskBehind;</span><br><span class="line">        mAlwaysFocusable = alwaysFocusable;</span><br><span class="line">        mRotationAnimationHint = rotationAnimationHint;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Application tokens start out hidden.</span></span><br><span class="line">        setHidden(<span class="keyword">true</span>);</span><br><span class="line">        hiddenRequested = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要创建了一个AppWindowToken。</p>
<p>接下来继续看下ActivityStarter.startActivityUnchecked()中的ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</p>
<h5 id="3-5、ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#3-5、ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="3.5、ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()"></a>3.5、ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStackSupervisor.java]</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!readyToResume()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> || !r.isState(RESUMED)) &#123;</span><br><span class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.isState(RESUMED)) &#123;</span><br><span class="line">        <span class="comment">// Kick off any lingering app transitions form the MoveTaskToFront operation.</span></span><br><span class="line">        mFocusedStack.executeAppTransition(targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-6、ActivityStack-resumeTopActivityUncheckedLocked"><a href="#3-6、ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="3.6、ActivityStack.resumeTopActivityUncheckedLocked()"></a>3.6、ActivityStack.resumeTopActivityUncheckedLocked()</h5><p> inResumeTopActivity用于保证每次只有一个Activity执行resumeTopActivityLocked()操作.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityStack.java]</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;mService&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t even start recursing.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Protect against recursion.</span></span><br><span class="line">            mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line">            result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// When resuming the top activity, it may be necessary to pause the top activity (for</span></span><br><span class="line">            <span class="comment">// example, returning to the lock screen. We suppress the normal pause logic in</span></span><br><span class="line">            <span class="comment">// &#123;@link #resumeTopActivityUncheckedLocked&#125;, since the top activity is resumed at the</span></span><br><span class="line">            <span class="comment">// end. We call the &#123;@link ActivityStackSupervisor#checkReadyForSleepLocked&#125; again here</span></span><br><span class="line">            <span class="comment">// to ensure any necessary pause logic occurs. In the case where the Activity will be</span></span><br><span class="line">            <span class="comment">// shown regardless of the lock screen, the call to</span></span><br><span class="line">            <span class="comment">// &#123;@link ActivityStackSupervisor#checkReadyForSleepLocked&#125; is skipped.</span></span><br><span class="line">            <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">true</span> <span class="comment">/* focusableOnly */</span>);</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="keyword">null</span> || !next.canTurnScreenOn()) &#123;</span><br><span class="line">                checkReadyForSleep();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-7、ActivityStack-resumeTopActivityInnerLocked"><a href="#3-7、ActivityStack-resumeTopActivityInnerLocked" class="headerlink" title="3.7、ActivityStack.resumeTopActivityInnerLocked()"></a>3.7、ActivityStack.resumeTopActivityInnerLocked()</h5><p>说明：启动一个新Activity时，如果界面还存在其它的Activity，那么必须先zan其它的Activity。<br>因此，除了第一个启动的Home界面对应的Activity外，其它的Activity均需要进行此操作，当系统启动第一个Activity，即Home时，mResumedActivity的值才会为null。<br>经过一系列处理逻辑之后最终调用了startPausingLocked方法，这个方法作用就是让系统中栈中的Activity执行onPause方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStack.java]</span><br><span class="line">   <span class="meta">@GuardedBy(&quot;mService&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Find the next top-most activity to resume in this stack that is not finishing and is</span></span><br><span class="line">        <span class="comment">// focusable. If it is not focusable, we will fall into the case below to resume the</span></span><br><span class="line">        <span class="comment">// top activity in the next focusable task.</span></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">true</span> <span class="comment">/* focusableOnly */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> hasRunningActivity = next != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The activity may be waiting for stop, but that is no longer</span></span><br><span class="line">        <span class="comment">// appropriate for it.</span></span><br><span class="line">        mStackSupervisor.mStoppingActivities.remove(next);</span><br><span class="line">        mStackSupervisor.mGoingToSleepActivities.remove(next);</span><br><span class="line">        next.sleeping = <span class="keyword">false</span>;</span><br><span class="line">        mStackSupervisor.mActivitiesWaitingForVisibleActivity.remove(next);</span><br><span class="line">        next.launching = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH, <span class="string">&quot;Resuming &quot;</span> + next);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mActivityTrigger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mActivityTrigger.activityResumeTrigger(next.intent, next.info, next.appInfo,</span><br><span class="line">                    next.fullscreen);</span><br><span class="line">        &#125;</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> V/ActivityStack_Switch( <span class="number">1049</span>): Resuming ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> D/ActivityTrigger( <span class="number">1049</span>): activityResumeTrigger: Activity is not Triggerred in full screen ApplicationInfo&#123;<span class="number">2</span>bedb5d com.android.testred&#125;</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> lastResumedCanPip = <span class="keyword">false</span>;</span><br><span class="line">        ActivityRecord lastResumed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">final</span> ActivityStack lastFocusedStack = mStackSupervisor.getLastStack();</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> resumeWhilePausing = (next.info.flags &amp; FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; !lastResumedCanPip;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, next, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES,</span><br><span class="line">                    <span class="string">&quot;resumeTopActivityLocked: Pausing &quot;</span> + mResumedActivity);</span><br><span class="line">            pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, next, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        ActivityStack lastStack = mStackSupervisor.getLastStack();</span><br><span class="line">        <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH, <span class="string">&quot;Resume running: &quot;</span> + next</span><br><span class="line">                    + <span class="string">&quot; stopped=&quot;</span> + next.stopped + <span class="string">&quot; visible=&quot;</span> + next.visible);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the previous activity is translucent, force a visibility update of</span></span><br><span class="line">            <span class="comment">// the next activity, so that it&#x27;s added to WM&#x27;s opening app list, and</span></span><br><span class="line">            <span class="comment">// transition animation can be set up properly.</span></span><br><span class="line">            <span class="comment">// For example, pressing Home button with a translucent activity in focus.</span></span><br><span class="line">            <span class="comment">// Launcher is already visible in this case. If we don&#x27;t add it to opening</span></span><br><span class="line">            <span class="comment">// apps, maybeUpdateTransitToWallpaper() will fail to identify this as a</span></span><br><span class="line">            <span class="comment">// TRANSIT_WALLPAPER_OPEN animation, and run some funny animation.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> lastActivityTranslucent = lastStack != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (lastStack.inMultiWindowMode()</span><br><span class="line">                    || (lastStack.mLastPausedActivity != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; !lastStack.mLastPausedActivity.fullscreen));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The contained logic must be synchronized, since we are both changing the visibility</span></span><br><span class="line">            <span class="comment">// and updating the &#123;@link Configuration&#125;. &#123;@link ActivityRecord#setVisibility&#125; will</span></span><br><span class="line">            <span class="comment">// ultimately cause the client code to schedule a layout. Since layouts retrieve the</span></span><br><span class="line">            <span class="comment">// current &#123;@link Configuration&#125;, we must ensure that the below code updates it before</span></span><br><span class="line">            <span class="comment">// the layout can occur.</span></span><br><span class="line">            <span class="keyword">synchronized</span>(mWindowManager.getWindowManagerLock()) &#123;</span><br><span class="line">                <span class="comment">// This activity is now becoming visible.</span></span><br><span class="line">                <span class="keyword">if</span> (!next.visible || next.stopped || lastActivityTranslucent) &#123;</span><br><span class="line">                    next.setVisibility(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">                next.startLaunchTickingLocked();</span><br><span class="line"></span><br><span class="line">                ActivityRecord lastResumedActivity =</span><br><span class="line">                        lastStack == <span class="keyword">null</span> ? <span class="keyword">null</span> :lastStack.mResumedActivity;</span><br><span class="line">                <span class="keyword">final</span> ActivityState lastState = next.getState();</span><br><span class="line"></span><br><span class="line">                mService.updateCpuStats();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;Moving to RESUMED: &quot;</span> + next</span><br><span class="line">                        + <span class="string">&quot; (in existing)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                next.setState(RESUMED, <span class="string">&quot;resumeTopActivityInnerLocked&quot;</span>);</span><br><span class="line"></span><br><span class="line">                mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">                updateLRUListLocked(next);</span><br><span class="line">                mService.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Have the window manager re-evaluate the orientation of</span></span><br><span class="line">                <span class="comment">// the screen based on the new activity order.</span></span><br><span class="line">                <span class="keyword">boolean</span> notUpdated = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mStackSupervisor.isFocusedStack(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                    <span class="comment">// We have special rotation behavior when here is some active activity that</span></span><br><span class="line">                    <span class="comment">// requests specific orientation or Keyguard is locked. Make sure all activity</span></span><br><span class="line">                    <span class="comment">// visibilities are set correctly as well as the transition is updated if needed</span></span><br><span class="line">                    <span class="comment">// to get the correct rotation behavior. Otherwise the following call to update</span></span><br><span class="line">                    <span class="comment">// the orientation may cause incorrect configurations delivered to client as a</span></span><br><span class="line">                    <span class="comment">// result of invisible window resize.</span></span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Remove this once visibilities are set correctly immediately when</span></span><br><span class="line">                    <span class="comment">// starting an activity.</span></span><br><span class="line">                    notUpdated = !mStackSupervisor.ensureVisibilityAndConfig(next, mDisplayId,</span><br><span class="line">                            <span class="keyword">true</span> <span class="comment">/* markFrozenIfConfigChanged */</span>, <span class="keyword">false</span> <span class="comment">/* deferResume */</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (notUpdated) &#123;</span><br><span class="line">                    <span class="comment">// The configuration update wasn&#x27;t able to keep the existing</span></span><br><span class="line">                    <span class="comment">// instance of the activity, and instead started a new one.</span></span><br><span class="line">                    <span class="comment">// We should be all done, but let&#x27;s just make sure our activity</span></span><br><span class="line">                    <span class="comment">// is still at the top and schedule another run if something</span></span><br><span class="line">                    <span class="comment">// weird happened.</span></span><br><span class="line">                    ActivityRecord nextNext = topRunningActivityLocked();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_STATES) Slog.i(TAG_STATES,</span><br><span class="line">                            <span class="string">&quot;Activity config changed during resume: &quot;</span> + next</span><br><span class="line">                                    + <span class="string">&quot;, new next: &quot;</span> + nextNext);</span><br><span class="line">                    <span class="keyword">if</span> (nextNext != next) &#123;</span><br><span class="line">                        <span class="comment">// Do over!</span></span><br><span class="line">                        mStackSupervisor.scheduleResumeTopActivities();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!next.visible || next.stopped) &#123;</span><br><span class="line">                        next.setVisibility(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    next.completeResumeLocked();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> ClientTransaction transaction = ClientTransaction.obtain(next.app.thread,</span><br><span class="line">                            next.appToken);</span><br><span class="line">                    <span class="comment">// Deliver all pending results.</span></span><br><span class="line">                    ArrayList&lt;ResultInfo&gt; a = next.results;</span><br><span class="line">                    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> N = a.size();</span><br><span class="line">                        <span class="keyword">if</span> (!next.finishing &amp;&amp; N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</span><br><span class="line">                                    <span class="string">&quot;Delivering results to &quot;</span> + next + <span class="string">&quot;: &quot;</span> + a);</span><br><span class="line">                            transaction.addCallback(ActivityResultItem.obtain(a));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (next.newIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        transaction.addCallback(NewIntentItem.obtain(next.newIntents,</span><br><span class="line">                                <span class="keyword">false</span> <span class="comment">/* andPause */</span>));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Well the app will no longer be stopped.</span></span><br><span class="line">                    <span class="comment">// Clear app token stopped state in window manager if needed.</span></span><br><span class="line">                    next.notifyAppResumed(next.stopped);</span><br><span class="line"></span><br><span class="line">                    EventLog.writeEvent(EventLogTags.AM_RESUME_ACTIVITY, next.userId,</span><br><span class="line">                            System.identityHashCode(next), next.getTask().taskId,</span><br><span class="line">                            next.shortComponentName);</span><br><span class="line"></span><br><span class="line">                    next.sleeping = <span class="keyword">false</span>;</span><br><span class="line">                    mService.getAppWarningsLocked().onResumeActivity(next);</span><br><span class="line">                    mService.showAskCompatModeDialogLocked(next);</span><br><span class="line">                    next.app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">                    next.app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">                    next.clearOptionsLocked();</span><br><span class="line">                    transaction.setLifecycleStateRequest(</span><br><span class="line">                            ResumeActivityItem.obtain(next.app.repProcState,</span><br><span class="line">                                    mService.isNextTransitionForward()));</span><br><span class="line">                    mService.getLifecycleManager().scheduleTransaction(transaction);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">&quot;resumeTopActivityLocked: Resumed &quot;</span></span><br><span class="line">                            + next);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// Whoops, need to restart this activity!</span></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;Resume failed; resetting state to &quot;</span></span><br><span class="line">                            + lastState + <span class="string">&quot;: &quot;</span> + next);</span><br><span class="line">                    next.setState(lastState, <span class="string">&quot;resumeTopActivityInnerLocked&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// lastResumedActivity being non-null implies there is a lastStack present.</span></span><br><span class="line">                    <span class="keyword">if</span> (lastResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        lastResumedActivity.setState(RESUMED, <span class="string">&quot;resumeTopActivityInnerLocked&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Slog.i(TAG, <span class="string">&quot;Restarting because process died: &quot;</span> + next);</span><br><span class="line">                    <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">                        next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span>  <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; lastStack != <span class="keyword">null</span></span><br><span class="line">                            &amp;&amp; getDisplay() != <span class="keyword">null</span> &amp;&amp; lastStack.isTopStackOnDisplay()) &#123;</span><br><span class="line">                        next.showStartingWindow(<span class="keyword">null</span> <span class="comment">/* prev */</span>, <span class="keyword">false</span> <span class="comment">/* newTask */</span>,</span><br><span class="line">                                <span class="keyword">false</span> <span class="comment">/* taskSwitch */</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// From this point on, if something goes wrong there is no way</span></span><br><span class="line">            <span class="comment">// to recover the activity.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                next.completeResumeLocked();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// If any exception gets thrown, toss away this</span></span><br><span class="line">                <span class="comment">// activity and try the next one.</span></span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Exception thrown during resume of &quot;</span> + next, e);</span><br><span class="line">                requestFinishActivityLocked(next.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                        <span class="string">&quot;resume-exception&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Whoops, need to restart this activity!</span></span><br><span class="line">            <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">                next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</span><br><span class="line">                    next.showStartingWindow(<span class="keyword">null</span> <span class="comment">/* prev */</span>, <span class="keyword">false</span> <span class="comment">/* newTask */</span>,</span><br><span class="line">                            <span class="keyword">false</span> <span class="comment">/* taskSwich */</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH, <span class="string">&quot;Restarting: &quot;</span> + next);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">&quot;resumeTopActivityLocked: Restarting &quot;</span> + next);</span><br><span class="line">            mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="四、执行栈顶Activity的onPause方法"><a href="#四、执行栈顶Activity的onPause方法" class="headerlink" title="四、执行栈顶Activity的onPause方法"></a>四、执行栈顶Activity的onPause方法</h4><h5 id="4-1、mStackSupervisor-pauseBackStacks-userLeaving-next-false"><a href="#4-1、mStackSupervisor-pauseBackStacks-userLeaving-next-false" class="headerlink" title="4.1、mStackSupervisor.pauseBackStacks(userLeaving, next, false)"></a>4.1、mStackSupervisor.pauseBackStacks(userLeaving, next, false)</h5><p>首先将Launcher 的ActivityStack 暂停。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityStackSupervisor.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">pauseBackStacks</span><span class="params">(<span class="keyword">boolean</span> userLeaving, ActivityRecord resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> someActivityPaused = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityDisplay display = mActivityDisplays.valueAt(displayNdx);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = display.getChildCount() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityStack stack = display.getChildAt(stackNdx);</span><br><span class="line">                <span class="keyword">if</span> (!isFocusedStack(stack) &amp;&amp; stack.getResumedActivity() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">&quot;pauseBackStacks: stack=&quot;</span> + stack +</span><br><span class="line">                            <span class="string">&quot; mResumedActivity=&quot;</span> + stack.getResumedActivity());</span><br><span class="line">                    someActivityPaused |= stack.startPausingLocked(userLeaving, <span class="keyword">false</span>, resuming,</span><br><span class="line">                            dontWait);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> someActivityPaused;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> D/ActivityStackSupervisor_States( <span class="number">1049</span>): pauseBackStacks: stack=ActivityStack&#123;<span class="number">6d</span>b92ec stackId=<span class="number">0</span> type=home mode=fullscreen visible=<span class="keyword">true</span> translucent=<span class="keyword">false</span>, <span class="number">1</span> tasks&#125; mResumedActivity=ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h5 id="4-2、ActivityStack-startPausingLocked"><a href="#4-2、ActivityStack-startPausingLocked" class="headerlink" title="4.2、ActivityStack.startPausingLocked()"></a>4.2、ActivityStack.startPausingLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityStack.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord resuming, <span class="keyword">boolean</span> pauseImmediately)</span> </span>&#123;</span><br><span class="line">        .......</span><br><span class="line">        ActivityRecord prev = mResumedActivity;</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;Moving to PAUSING: &quot;</span> + prev);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">&quot;Start pausing: &quot;</span> + prev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mActivityTrigger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mActivityTrigger.activityPauseTrigger(prev.intent, prev.info, prev.appInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       .......</span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> D/ActivityStackSupervisor_States( <span class="number">1049</span>): pauseBackStacks: stack=ActivityStack&#123;<span class="number">6d</span>b92ec stackId=<span class="number">0</span> type=home mode=fullscreen visible=<span class="keyword">true</span> translucent=<span class="keyword">false</span>, <span class="number">1</span> tasks&#125; mResumedActivity=ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125;</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">        mResumedActivity = <span class="keyword">null</span>;</span><br><span class="line">        mPausingActivity = prev;</span><br><span class="line">        mLastPausedActivity = prev;</span><br><span class="line">        mLastNoHistoryActivity = (prev.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_HISTORY) != <span class="number">0</span></span><br><span class="line">                || (prev.info.flags &amp; ActivityInfo.FLAG_NO_HISTORY) != <span class="number">0</span> ? prev : <span class="keyword">null</span>;</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.769</span> V/ActivityRecord_States( <span class="number">1049</span>): State movement: ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125; from:RESUMED to:PAUSING reason:startPausingLocked</span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line">        prev.setState(PAUSING, <span class="string">&quot;startPausingLocked&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        prev.getTask().touchActiveTime();</span><br><span class="line">        clearLaunchTime(prev);</span><br><span class="line"></span><br><span class="line">        mStackSupervisor.getLaunchTimeTracker().stopFullyDrawnTraceIfNeeded(getWindowingMode());</span><br><span class="line"></span><br><span class="line">        mService.updateCpuStats();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.770</span> V/ActivityStack_Pause( <span class="number">1049</span>): Enqueueing pending pause: ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125;</span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">&quot;Enqueueing pending pause: &quot;</span> + prev);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                EventLogTags.writeAmPauseActivity(prev.userId, System.identityHashCode(prev),</span><br><span class="line">                        prev.shortComponentName, <span class="string">&quot;userLeaving=&quot;</span> + userLeaving);</span><br><span class="line">                mService.updateUsageStats(prev, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken,</span><br><span class="line">                        PauseActivityItem.obtain(prev.finishing, userLeaving,</span><br><span class="line">                                prev.configChangeFlags, pauseImmediately));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Ignore exception, if process died other code will cleanup.</span></span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Exception thrown during pause&quot;</span>, e);</span><br><span class="line">                mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">                mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">                mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">            mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">            mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we are not going to sleep, we want to ensure the device is</span></span><br><span class="line">        <span class="comment">// awake until the next activity is started.</span></span><br><span class="line">        <span class="keyword">if</span> (!uiSleeping &amp;&amp; !mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line">            mStackSupervisor.acquireLaunchWakelock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Have the window manager pause its key dispatching until the new</span></span><br><span class="line">            <span class="comment">// activity has started.  If we&#x27;re pausing the activity just because</span></span><br><span class="line">            <span class="comment">// the screen is being turned off and the UI is sleeping, don&#x27;t interrupt</span></span><br><span class="line">            <span class="comment">// key dispatch; the same activity will pick it up again on wakeup.</span></span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.770</span> V/WindowManager( <span class="number">1049</span>): Pausing WindowToken AppWindowToken&#123;<span class="number">483</span>acfb token=Token&#123;f984e8a ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125;&#125;&#125;</span><br><span class="line"> prev.pauseKeyDispatchingLocked();</span><br><span class="line">--------------------------------------------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (!uiSleeping) &#123;</span><br><span class="line">                prev.pauseKeyDispatchingLocked();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_PAUSE) &#123;</span><br><span class="line">                 Slog.v(TAG_PAUSE, <span class="string">&quot;Key dispatch not paused for screen off&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pauseImmediately) &#123;</span><br><span class="line">                <span class="comment">// If the caller said they don&#x27;t want to wait for the pause, then complete</span></span><br><span class="line">                <span class="comment">// the pause now.</span></span><br><span class="line">                <span class="comment">//完成Pause</span></span><br><span class="line">                completePauseLocked(<span class="keyword">false</span>, resuming);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                schedulePauseTimeout(prev);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This activity failed to schedule the</span></span><br><span class="line">            <span class="comment">// pause, so just treat it as being paused now.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">&quot;Activity not running, resuming next.&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (resuming == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看下ActivityRecord的setState 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityRecord.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setState</span><span class="params">(ActivityState state, String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES, <span class="string">&quot;State movement: &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; from:&quot;</span> + getState()</span><br><span class="line">                        + <span class="string">&quot; to:&quot;</span> + state + <span class="string">&quot; reason:&quot;</span> + reason);</span><br><span class="line">        ......</span><br><span class="line">        mState = state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskRecord parent = getTask();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            parent.onActivityStateChanged(<span class="keyword">this</span>, state, reason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The WindowManager interprets the app stopping signal as</span></span><br><span class="line">        <span class="comment">// an indication that the Surface will eventually be destroyed.</span></span><br><span class="line">        <span class="comment">// This however isn&#x27;t necessarily true if we are going to sleep.</span></span><br><span class="line">        <span class="keyword">if</span> (state == STOPPING &amp;&amp; !isSleeping()) &#123;</span><br><span class="line">            mWindowContainerController.notifyAppStopping();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>接着看下mService.updateUsageStats(prev, false);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.770</span> D/ActivityManagerService_Switch( <span class="number">1049</span>): updateUsageStats: comp=ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125;res=<span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUsageStats</span><span class="params">(ActivityRecord component, <span class="keyword">boolean</span> resumed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH) Slog.d(TAG_SWITCH,</span><br><span class="line">                <span class="string">&quot;updateUsageStats: comp=&quot;</span> + component + <span class="string">&quot;res=&quot;</span> + resumed);</span><br><span class="line">        <span class="keyword">final</span> BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">        StatsLog.write(StatsLog.ACTIVITY_FOREGROUND_STATE_CHANGED,</span><br><span class="line">            component.app.uid, component.realActivity.getPackageName(),</span><br><span class="line">            component.realActivity.getShortClassName(), resumed ?</span><br><span class="line">                        StatsLog.ACTIVITY_FOREGROUND_STATE_CHANGED__STATE__FOREGROUND :</span><br><span class="line">                        StatsLog.ACTIVITY_FOREGROUND_STATE_CHANGED__STATE__BACKGROUND);</span><br><span class="line">        <span class="keyword">if</span> (resumed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                        UsageEvents.Event.MOVE_TO_FOREGROUND);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                stats.noteActivityResumedLocked(component.app.uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                        UsageEvents.Event.MOVE_TO_BACKGROUND);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                stats.noteActivityPausedLocked(component.app.uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-3、scheduleTransaction-prev-app-thread-prev-appToken-PauseActivityItem-obtain-……"><a href="#4-3、scheduleTransaction-prev-app-thread-prev-appToken-PauseActivityItem-obtain-……" class="headerlink" title="4.3、scheduleTransaction(prev.app.thread, prev.appToken,PauseActivityItem.obtain(……));"></a>4.3、scheduleTransaction(prev.app.thread, prev.appToken,PauseActivityItem.obtain(……));</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/frameworks/base/services/core/java/com/android/server/am/ClientLifecycleManager.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(<span class="meta">@NonNull</span> IApplicationThread client, <span class="meta">@NonNull</span> IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@NonNull</span> ClientTransactionItem callback)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ClientTransaction clientTransaction = transactionWithCallback(client, activityToken,</span><br><span class="line">                callback);</span><br><span class="line">        scheduleTransaction(clientTransaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> IApplicationThread client = transaction.getClient();</span><br><span class="line">        transaction.schedule();</span><br><span class="line">        <span class="keyword">if</span> (!(client <span class="keyword">instanceof</span> Binder)) &#123;</span><br><span class="line">            <span class="comment">// If client is not an instance of Binder - it&#x27;s a remote call and at this point it is</span></span><br><span class="line">            <span class="comment">// safe to recycle the object. All objects used for local calls will be recycled after</span></span><br><span class="line">            <span class="comment">// the transaction is executed on client in ActivityThread.</span></span><br><span class="line">            transaction.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\servertransaction\ClientTransaction.java</span><br><span class="line">        <span class="comment">/** Target client. */</span></span><br><span class="line">    <span class="keyword">private</span> IApplicationThread mClient;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        mClient.scheduleTransaction(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>那么这个mClient是什么呢,根据code可以看到private IApplicationThread mClient;其实mClient就是右上一步  clientTransaction.addCallback(arg…);传入的IApplication的实例,前面也说过,这个IApplication实例是一个binder对象,用于System_service与app端进行交互;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="title">extends</span> <span class="title">IApplicationThread</span>.<span class="title">Stub</span> &#123;</span></span><br><span class="line">        ......</span><br><span class="line">        @Override</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> throws RemoteException </span>&#123;</span><br><span class="line">            ActivityThread.<span class="keyword">this</span>.scheduleTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AMS–通过ApplicationThread:scheduleTransaction回调至app,注意ApplicationThread 就是一个binder<br>到此为止AMS的回调完成回到app的进程中;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Android <span class="number">9.0</span>已改变没有直接提供Java源码，而是.class文件打包为classes-header.jar和classes.jar。</span><br><span class="line">android\out\target\common\obj\JAVA_LIBRARIES\framework_intermediates\</span><br><span class="line">classes-header.jar</span><br><span class="line">classes.jar解压：</span><br><span class="line">classes/android/app/</span><br><span class="line">    IApplicationThread.class</span><br><span class="line">    IApplicationThread$Stub.class</span><br><span class="line">    IApplicationThread$Stub$Proxy.class</span><br><span class="line">    </span><br><span class="line">解压后在线反编译http:<span class="comment">//www.javadecompilers.com/</span></span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">IApplicationThread.class</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">package android.app;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> abstract interface IApplicationThread</span><br><span class="line">  extends IInterface</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> abstract <span class="keyword">void</span> <span class="title">scheduleReceiver</span><span class="params">(Intent paramIntent, ActivityInfo paramActivityInfo, CompatibilityInfo paramCompatibilityInfo, <span class="keyword">int</span> paramInt1, String paramString, Bundle paramBundle, boolean paramBoolean, <span class="keyword">int</span> paramInt2, <span class="keyword">int</span> paramInt3)</span></span></span><br><span class="line"><span class="function">    throws RemoteException</span>;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> abstract <span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction paramClientTransaction)</span></span></span><br><span class="line"><span class="function">    throws RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">IApplicationThread$Stub.class</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">package android.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Parcel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> abstract <span class="class"><span class="keyword">class</span> <span class="title">IApplicationThread</span>$<span class="title">Stub</span> <span class="title">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span></span></span><br><span class="line"><span class="class">  <span class="title">implements</span> <span class="title">IApplicationThread</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DESCRIPTOR = <span class="string">&quot;android.app.IApplicationThread&quot;</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleReceiver = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleCreateService = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleStopService = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_bindApplication = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_runIsolatedEntryPoint = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleExit = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleServiceArgs = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_updateTimeZone = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_processInBackground = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleBindService = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleUnbindService = <span class="number">11</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_dumpService = <span class="number">12</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> IApplicationThread$Stub() &#123; attachInterface(<span class="keyword">this</span>, <span class="string">&quot;android.app.IApplicationThread&quot;</span>); &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleRegisteredReceiver = <span class="number">13</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleLowMemory = <span class="number">14</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleSleeping = <span class="number">15</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_profilerControl = <span class="number">16</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IApplicationThread <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == null) &#123;</span><br><span class="line">      <span class="keyword">return</span> null;</span><br><span class="line">    &#125;</span><br><span class="line">    android.os.IInterface iin = obj.queryLocalInterface(<span class="string">&quot;android.app.IApplicationThread&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iin != null) &amp;&amp; ((iin instanceof IApplicationThread))) &#123;</span><br><span class="line">      <span class="keyword">return</span> (IApplicationThread)iin;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IApplicationThread.Stub.Proxy(obj); &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_setSchedulingGroup = <span class="number">17</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleCreateBackupAgent = <span class="number">18</span>;</span><br><span class="line">  </span><br><span class="line">  public boolean onTransact(int code, Parcel data, Parcel reply, int flags) throws android.os.RemoteException &#123; String descriptor = &quot;android.app.IApplicationThread&quot;;</span><br><span class="line">    <span class="keyword">switch</span> (code)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="number">1598968902</span>: </span><br><span class="line">      reply.writeString(descriptor);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">case</span> <span class="number">51</span>: </span><br><span class="line">      data.enforceInterface(descriptor);</span><br><span class="line">      android.app.servertransaction.ClientTransaction _arg0;</span><br><span class="line">      android.app.servertransaction.ClientTransaction _arg0; <span class="keyword">if</span> (<span class="number">0</span> != data.readInt()) &#123;</span><br><span class="line">        _arg0 = (android.app.servertransaction.ClientTransaction)android.app.servertransaction.ClientTransaction.CREATOR.createFromParcel(data);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _arg0 = null;</span><br><span class="line">      &#125;</span><br><span class="line">      scheduleTransaction(_arg0);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> super.onTransact(code, data, reply, flags);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_scheduleTransaction = <span class="number">51</span>;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">IApplicationThread$Stub$Proxy.class</span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">package android.app;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IApplicationThread</span>$<span class="title">Stub</span>$<span class="title">Proxy</span></span></span><br><span class="line"><span class="class">  <span class="title">implements</span> <span class="title">IApplicationThread</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">private</span> IBinder mRemote;</span><br><span class="line">  </span><br><span class="line">  IApplicationThread$Stub$Proxy(IBinder remote)</span><br><span class="line">  &#123;</span><br><span class="line">    mRemote = remote;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mRemote;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;android.app.IApplicationThread&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> throws RemoteException </span>&#123;</span><br><span class="line">    Parcel _data = Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      _data.writeInterfaceToken(<span class="string">&quot;android.app.IApplicationThread&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (transaction != null) &#123;</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        transaction.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        _data.writeInt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      mRemote.transact(<span class="number">51</span>, _data, null, <span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">      _data.recycle(); &#125; finally &#123; _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续看ActivityThread.this.scheduleTransaction(transaction);源码:</p>
<p>注意一下,这里由于ActivityThread中没有重写scheduleTransaction,所以会走到ActivityThread的父类ClientTransactionHandler的scheduleTransaction</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\android\app\ClientTransactionHandler.java</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        transaction.preExecute(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 通过handler 发消息通知ActivityThread</span></span><br><span class="line">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//ActivityThread</span></span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj)</span> </span>&#123;</span><br><span class="line">        sendMessage(what, obj, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>scheduleTransaction然后走到ActivityThread的sendMessage,进而会掉到ActivityThread的H类</p>
<p>H类源码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\android\app\ActivityThread.java</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="title">extends</span> <span class="title">Handler</span> &#123;</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">&quot;&gt;&gt;&gt; handling: &quot;</span> + codeToString(msg.what));</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> BIND_APPLICATION:</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;bindApplication&quot;</span>);</span><br><span class="line">                    AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">                    handleBindApplication(data);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> EXIT_APPLICATION:</span><br><span class="line">                    <span class="keyword">if</span> (mInitialApplication != null) &#123;</span><br><span class="line">                        mInitialApplication.onTerminate();</span><br><span class="line">                    &#125;</span><br><span class="line">                    Looper.myLooper().quit();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">case</span> EXECUTE_TRANSACTION:</span><br><span class="line">                    <span class="keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class="line">                    mTransactionExecutor.execute(transaction);</span><br><span class="line">                    <span class="keyword">if</span> (isSystem()) &#123;</span><br><span class="line">                        <span class="comment">// Client transactions inside system process are recycled on the client side</span></span><br><span class="line">                        <span class="comment">// instead of ClientLifecycleManager to avoid being cleared before this</span></span><br><span class="line">                        <span class="comment">// message is handled.</span></span><br><span class="line">                        transaction.recycle();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RELAUNCH_ACTIVITY:</span><br><span class="line">                    handleRelaunchActivityLocally((IBinder) msg.obj);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Object obj = msg.obj;</span><br><span class="line">            <span class="keyword">if</span> (obj instanceof SomeArgs) &#123;</span><br><span class="line">                ((SomeArgs) obj).recycle();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">&quot;&lt;&lt;&lt; done: &quot;</span> + codeToString(msg.what));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>毫无疑问,四大组件的生命周期控制的AMS回调入口的实现逻辑就在这里了,ok,我们继续回到activity的创建逻辑线,继续分析;<br>代码太多,所以从上面摘出一部分分析;</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> EXECUTE_TRANSACTION:</span><br><span class="line">                    <span class="keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;</span><br><span class="line">                    mTransactionExecutor.execute(transaction);</span><br><span class="line">                    <span class="keyword">if</span> (isSystem()) &#123;</span><br><span class="line">                        <span class="comment">// Client transactions inside system process are recycled on the client side</span></span><br><span class="line">                        <span class="comment">// instead of ClientLifecycleManager to avoid being cleared before this</span></span><br><span class="line">                        <span class="comment">// message is handled.</span></span><br><span class="line">                        transaction.recycle();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>mTransactionExecutor.execute(transaction)源码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\android\app\servertransaction\TransactionExecutor.java</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> IBinder token = transaction.getActivityToken();</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;Start resolving transaction for client: &quot;</span> + mTransactionHandler + <span class="string">&quot;, token: &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">        executeCallbacks(transaction);</span><br><span class="line"></span><br><span class="line">        executeLifecycleState(transaction);</span><br><span class="line">        mPendingActions.clear();</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;End resolving transaction&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Transition to the final state if requested by the transaction. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeLifecycleState</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem = transaction.getLifecycleStateRequest();</span><br><span class="line">        <span class="keyword">if</span> (lifecycleItem == null) &#123;</span><br><span class="line">            <span class="comment">// No lifecycle request, return early.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;Resolving lifecycle state: &quot;</span> + lifecycleItem);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> IBinder token = transaction.getActivityToken();</span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = mTransactionHandler.getActivityClient(token);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r == null) &#123;</span><br><span class="line">            <span class="comment">// Ignore requests for non-existent client records for now.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Cycle to the state right before the final requested state.</span></span><br><span class="line">        cycleToPath(r, lifecycleItem.getTargetState(), <span class="literal">true</span> <span class="comment">/* excludeLastState */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Execute the final transition with proper parameters.</span></span><br><span class="line">        lifecycleItem.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>execute(ClientTransaction transaction)中调用 executeLifecycleState(ClientTransaction transaction),然后调用lifecycleItem.execute(mTransactionHandler, token, mPendingActions);<br>这个PauseActivityItem是在System_service时候,传入的,下面摘入一段前面的代码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken,</span><br><span class="line">        PauseActivityItem.obtain(prev.finishing, userLeaving,</span><br><span class="line">                prev.configChangeFlags, pauseImmediately));</span><br></pre></td></tr></table></figure>

<p>这里的clientTransaction.addCallback(PauseActivityItem.obtain(arg…))就是我们目前用到的lifecycleItem,也就是说 这个lifecycleItem就是PauseActivityItem</p>
<p>继续看lifecycleItem.execute(mTransactionHandler, token, mPendingActions);源码:</p>
<h5 id="4-4、PauseActivityItem-execute"><a href="#4-4、PauseActivityItem-execute" class="headerlink" title="4.4、PauseActivityItem.execute()"></a>4.4、PauseActivityItem.execute()</h5><p>G:\android9.0\frameworks\base\core\java\android\app\servertransaction\TransactionExecutor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\app\servertransaction\PauseActivityItem.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityPause&quot;</span>);</span><br><span class="line">        client.handlePauseActivity(token, mFinished, mUserLeaving, mConfigChanges, pendingActions,</span><br><span class="line">                <span class="string">&quot;PAUSE_ACTIVITY_ITEM&quot;</span>);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4-5、-ActivityThread-handleMessage-mH"><a href="#4-5、-ActivityThread-handleMessage-mH" class="headerlink" title="4.5、[ActivityThread.handleMessage() : mH]"></a>4.5、[ActivityThread.handleMessage() : mH]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java : mH]</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">     ......</span><br><span class="line">     <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</span><br><span class="line">         Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityPause&quot;</span>);</span><br><span class="line">         SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">         handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</span><br><span class="line">                 (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</span><br><span class="line">                 (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">         maybeSnapshot();</span><br><span class="line">         Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">     &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>可以发现其调用了handlePauseActivity方法：</p>
<h5 id="4-6、ActivityThread-handlePauseActivity"><a href="#4-6、ActivityThread-handlePauseActivity" class="headerlink" title="4.6、ActivityThread.handlePauseActivity()"></a>4.6、ActivityThread.handlePauseActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;ActivityThread.java]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    ......</span><br><span class="line">        performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">&quot;handlePauseActivity&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Tell the activity manager we have paused.</span></span><br><span class="line">        <span class="keyword">if</span> (!dontReport) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在方法体内部通过调用performPauseActivity方法来实现对栈顶Activity的onPause生命周期方法的回调，可以具体看一下他的实现：</p>
<h5 id="4-7、ActivityThread-performPauseActivity"><a href="#4-7、ActivityThread-performPauseActivity" class="headerlink" title="4.7、ActivityThread.performPauseActivity()"></a>4.7、ActivityThread.performPauseActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   [-&gt;ActivityThread.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> Bundle <span class="title">performPauseActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> saveState, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    performPauseActivityIfNeeded(r, reason);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performPauseActivityIfNeeded</span><span class="params">(ActivityClientRecord r, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        r.activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">        mInstrumentation.callActivityOnPause(r.activity);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样回到了mInstrumentation的callActivityOnPuase方法：</p>
<h5 id="4-8、Instrumentation-callActivityOnPuase"><a href="#4-8、Instrumentation-callActivityOnPuase" class="headerlink" title="4.8、Instrumentation.callActivityOnPuase()"></a>4.8、Instrumentation.callActivityOnPuase()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;Instrumentation.java]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnPause</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.performPause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原来最终回调到了Activity的performPause方法：</p>
<h5 id="4-9、Activity-performPause"><a href="#4-9、Activity-performPause" class="headerlink" title="4.9、Activity.performPause()"></a>4.9、Activity.performPause()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[-&gt;Activity.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDoReportFullyDrawn = <span class="keyword">false</span>;</span><br><span class="line">    mFragments.dispatchPause();</span><br><span class="line">    mCalled = <span class="keyword">false</span>;</span><br><span class="line">    onPause();</span><br><span class="line">    mResumed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mCalled &amp;&amp; getApplicationInfo().targetSdkVersion</span><br><span class="line">            &gt;= android.os.Build.VERSION_CODES.GINGERBREAD) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                <span class="string">&quot;Activity &quot;</span> + mComponent.toShortString() +</span><br><span class="line">                <span class="string">&quot; did not call through to super.onPause()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mResumed = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>终于，太不容易了，回调到了Activity的onPause方法，哈哈，Activity生命周期中的第一个生命周期方法终于被我们找到了。。。也就是说我们在启动一个Activity的时候最先被执行的是栈顶的Activity的onPause方法。</p>
<blockquote>
<p>ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()<br>–&gt; ActivityStack.resumeTopActivityUncheckedLocked()<br>–&gt; ActivityStack.resumeTopActivityInnerLocked()<br>–&gt; ActivityStackSupervisor.startSpecificActivityLocked()<br>继续分析resumeTopActivityInnerLocked</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityStack.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Whoops, need to restart this activity!</span></span><br><span class="line">            <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">                next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</span><br><span class="line">                    next.showStartingWindow(<span class="keyword">null</span> <span class="comment">/* prev */</span>, <span class="keyword">false</span> <span class="comment">/* newTask */</span>,</span><br><span class="line">                            <span class="keyword">false</span> <span class="comment">/* taskSwich */</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH, <span class="string">&quot;Restarting: &quot;</span> + next);</span><br><span class="line">            &#125;</span><br><span class="line">-----------------------------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.787</span> D/ActivityStack_States( <span class="number">1049</span>): resumeTopActivityLocked: Restarting ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;</span><br><span class="line">-----------------------------------------------------------------------</span><br><span class="line">         <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">&quot;resumeTopActivityLocked: Restarting &quot;</span> + next);</span><br><span class="line">            mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于第一Activity的 ProcessRecord app 肯定为null，所以会走else分支;我们看一下startSpecificActivityLocked的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityStackSupervisor.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Is this activity&#x27;s application already running?</span></span><br><span class="line">        ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">                r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        getLaunchTimeTracker().setLaunchTime(r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                        || !<span class="string">&quot;android&quot;</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                    <span class="comment">// Don&#x27;t add this if it is a platform component that is marked</span></span><br><span class="line">                    <span class="comment">// to run in multiple processes, because this is actually</span></span><br><span class="line">                    <span class="comment">// part of the framework so doesn&#x27;t make sense to track as a</span></span><br><span class="line">                    <span class="comment">// separate apk in the process.</span></span><br><span class="line">                    app.addPackage(r.info.packageName, r.info.applicationInfo.longVersionCode,</span><br><span class="line">                            mService.mProcessStats);</span><br><span class="line">                &#125;</span><br><span class="line">                realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Exception when starting activity &quot;</span></span><br><span class="line">                        + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">            <span class="comment">// restart the application.</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;activity&quot;</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以发现在这个方法中，首先会判断一下需要启动的Activity所需要的应用进程是否已经启动，若启动的话，则直接调用realStartAtivityLocked方法，否则调用startProcessLocked方法，用于启动应用进程。 </p>
<h4 id="五、-App（”com-android-testred”）进程启动过程"><a href="#五、-App（”com-android-testred”）进程启动过程" class="headerlink" title="五、 App（”com.android.testred”）进程启动过程"></a>五、 App（”com.android.testred”）进程启动过程</h4><p>接下来分析一下应用进程的启动过程，上面分析到ActivityStackSupervisor.startSpecificActivityLocked方法，在这个方法中会去根据进程和线程是否存在判断App是否已经启动，如果已经启动，就会调用realStartActivityLocked方法继续处理。如果没有启动则调用ActivityManagerService.startProcessLocked方法创建新的进程处理。<br><strong>准备知识</strong><br>本文要介绍的是进程的创建，先简单说说进程与线程的区别。</p>
<ul>
<li><p>进程：每个App在启动前必须先创建一个进程，该进程是由Zygote fork出来的，进程具有独立的资源空间，用于承载App上运行的各种Activity/Service等组件。进程对于上层应用来说是完全透明的，这也是google有意为之，让App程序都是运行在Android Runtime。大多数情况一个App就运行在一个进程中，除非在AndroidManifest.xml中配置Android:process属性，或通过native代码fork进程。</p>
</li>
<li><p>线程：线程对应用开发者来说非常熟悉，比如每次new Thread().start()都会创建一个新的线程，该线程并没有自己独立的地址空间，而是与其所在进程之间资源共享。从Linux角度来说进程与线程都是一个task_struct结构体，除了是否共享资源外，并没有其他本质的区别。</p>
</li>
</ul>
<p>在接下来的文章，会涉及到system_server进程和Zygote进程，下面简要这两个进程：</p>
<p>system_server进程：是用于管理整个Java framework层，包含ActivityManager，PowerManager等各种系统服务;<br>Zygote进程：是Android系统的首个Java进程，Zygote是所有Java进程的父进程，包括 system_server进程以及所有的App进程都是Zygote的子进程，注意这里说的是子进程，而非子线程。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/zjj.display.sys.Process.start.png" alt="enter image description here"></p>
<p>图解：</p>
<ul>
<li>App发起进程：当从桌面启动应用，则发起进程便是Launcher所在进程；当从某App内启动远程进程，则发送进程便是该App所在进程。发起进程先通过binder发送消息给system_server进程；<br>system_server进程：调用Process.start()方法，通过socket向zygote进程发送创建新进程的请求；</li>
<li>zygote进程：在执行ZygoteInit.main()后ZygoteServer便进入runSelectLoop()循环体内，当有客户端连接时便会执行ZygoteConnection.processOneCommand()方法，再经过层层调用后fork出新的应用进程；</li>
<li>新进程：执行handleChildProc方法，最后调用ActivityThread.main()方法。<br>接下来，依次从system_server进程发起请求到Zygote创建进程，再到新进程的运行这3大块展开讲解进程创建是一个怎样的过程。<h5 id="5-1、system-server发起请求"><a href="#5-1、system-server发起请求" class="headerlink" title="5.1、system_server发起请求"></a>5.1、system_server发起请求</h5><h5 id="5-1-1、-ActivityManagerService-startProcessLocked"><a href="#5-1-1、-ActivityManagerService-startProcessLocked" class="headerlink" title="5.1.1、 ActivityManagerService.startProcessLocked()"></a>5.1.1、 ActivityManagerService.startProcessLocked()</h5></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName,</span></span></span><br><span class="line"><span class="function"><span class="params">            ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,</span><br><span class="line">                hostingName, allowWhileBooting, isolated, <span class="number">0</span> <span class="comment">/* isolatedUid */</span>, keepIfLarge,</span><br><span class="line">                <span class="keyword">null</span> <span class="comment">/* ABI override */</span>, <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>,</span><br><span class="line">                <span class="keyword">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</span></span></span><br><span class="line"><span class="function"><span class="params">            String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</span><br><span class="line">        ProcessRecord app;</span><br><span class="line">        <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">            app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;startProcess: after getProcessRecord&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">&quot;Clearing bad process: &quot;</span> + info.uid</span><br><span class="line">                        + <span class="string">&quot;/&quot;</span> + info.processName);</span><br><span class="line">                mAppErrors.resetProcessCrashTimeLocked(info);</span><br><span class="line">                <span class="keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                    EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</span><br><span class="line">                            UserHandle.getUserId(info.uid), info.uid,</span><br><span class="line">                            info.processName);</span><br><span class="line">                    mAppErrors.clearBadProcessLocked(info);</span><br><span class="line">                    <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        app.bad = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If this is an isolated process, it can&#x27;t re-use an existing process.</span></span><br><span class="line">            app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We don&#x27;t have to do anything more if:</span></span><br><span class="line">        <span class="comment">// (1) There is an existing application record; and</span></span><br><span class="line">        <span class="comment">// (2) The caller doesn&#x27;t think it is dead, OR there is no thread</span></span><br><span class="line">        <span class="comment">//     object attached to it so we know it couldn&#x27;t have crashed; and</span></span><br><span class="line">        <span class="comment">// (3) There is a pid assigned to it, so it is either starting or</span></span><br><span class="line">        <span class="comment">//     already running.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, <span class="string">&quot;startProcess: name=&quot;</span> + processName</span><br><span class="line">                + <span class="string">&quot; app=&quot;</span> + app + <span class="string">&quot; knownToBeDead=&quot;</span> + knownToBeDead</span><br><span class="line">                + <span class="string">&quot; thread=&quot;</span> + (app != <span class="keyword">null</span> ? app.thread : <span class="keyword">null</span>)</span><br><span class="line">                + <span class="string">&quot; pid=&quot;</span> + (app != <span class="keyword">null</span> ? app.pid : -<span class="number">1</span>));</span><br><span class="line">        .......</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">    Line <span class="number">1222</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.788</span> V/ActivityManagerService( <span class="number">1049</span>): Clearing bad process: <span class="number">10088</span>/com.android.testred</span><br><span class="line">    Line <span class="number">1223</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.788</span> V/ActivityManagerService_Processes( <span class="number">1049</span>): startProcess: name=com.android.testred app=<span class="keyword">null</span> knownToBeDead=<span class="keyword">true</span> thread=<span class="keyword">null</span> pid=-<span class="number">1</span></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">        String hostingNameStr = hostingName != <span class="keyword">null</span></span><br><span class="line">                ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;startProcess: creating new process record&quot;</span>);</span><br><span class="line">            app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</span><br><span class="line">            ......</span><br><span class="line">            app.crashHandler = crashHandler;</span><br><span class="line">            app.isolatedEntryPoint = entryPoint;</span><br><span class="line">            app.isolatedEntryPointArgs = entryPointArgs;</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;startProcess: done creating new process record&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If this is a new package in the process, add the package to the list</span></span><br><span class="line">            app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;startProcess: added package to existing proc&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> success = startProcessLocked(app, hostingType, hostingNameStr, abiOverride);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> success ? app : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-2、-ActivityManagerService-newProcessRecordLocked"><a href="#5-1-2、-ActivityManagerService-newProcessRecordLocked" class="headerlink" title="5.1.2、 ActivityManagerService.newProcessRecordLocked()"></a>5.1.2、 ActivityManagerService.newProcessRecordLocked()</h5><p>创建ProcessRecord</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">newProcessRecordLocked(ApplicationInfo info, String customProcess,</span><br><span class="line">            <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid) &#123;</span><br><span class="line">        String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</span><br><span class="line">        BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid);</span><br><span class="line">        <span class="keyword">int</span> uid = info.uid;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(<span class="keyword">this</span>, stats, info, proc, uid);</span><br><span class="line">        ......</span><br><span class="line">        addProcessNameLocked(r);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-3、-ActivityManagerService-startProcessLocked"><a href="#5-1-3、-ActivityManagerService-startProcessLocked" class="headerlink" title="5.1.3、 ActivityManagerService.startProcessLocked()"></a>5.1.3、 ActivityManagerService.startProcessLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the process.  It will either succeed and return a result containing</span></span><br><span class="line">            <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></span><br><span class="line">            <span class="keyword">final</span> String entryPoint = <span class="string">&quot;android.app.ActivityThread&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> startProcessLocked(hostingType, hostingNameStr, entryPoint, app, uid, gids,</span><br><span class="line">                    runtimeFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith,</span><br><span class="line">                    startTime);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startProcessLocked</span><span class="params">(String hostingType, String hostingNameStr, String entryPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProcessRecord app, <span class="keyword">int</span> uid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">            String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> startTime)</span> </span>&#123;</span><br><span class="line">        app.pendingStart = <span class="keyword">true</span>;</span><br><span class="line">        app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">        app.removed = <span class="keyword">false</span>;</span><br><span class="line">        app.killed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> startSeq = app.startSeq = ++mProcStartSeqCounter;</span><br><span class="line">        app.setStartParams(uid, hostingType, hostingNameStr, seInfo, startTime);</span><br><span class="line">        <span class="keyword">if</span> (mConstants.FLAG_PROCESS_START_ASYNC) &#123;</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">    Line <span class="number">1225</span>: <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.788</span> I/ActivityManagerService_Processes( <span class="number">1049</span>): Posting procStart msg <span class="keyword">for</span> <span class="number">0</span>:com.android.testred/u0a88</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.i(TAG_PROCESSES,</span><br><span class="line">                    <span class="string">&quot;Posting procStart msg for &quot;</span> + app.toShortString());</span><br><span class="line">            mProcStartHandler.post(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    .......</span><br><span class="line">                    <span class="keyword">final</span> ProcessStartResult startResult = startProcess(app.hostingType, entryPoint,</span><br><span class="line">                            app, app.startUid, gids, runtimeFlags, mountExternal, app.seInfo,</span><br><span class="line">                            requiredAbi, instructionSet, invokeWith, app.startTime);</span><br><span class="line">                    <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">                        handleProcessStartedLocked(app, startResult, startSeq);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">                        Slog.e(TAG, <span class="string">&quot;Failure starting process &quot;</span> + app.processName, e);</span><br><span class="line">                        mPendingStarts.remove(startSeq);</span><br><span class="line">                        app.pendingStart = <span class="keyword">false</span>;</span><br><span class="line">                        forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid),</span><br><span class="line">                                <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                                UserHandle.getUserId(app.userId), <span class="string">&quot;start failure&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> ProcessStartResult startResult = startProcess(hostingType, entryPoint, app,</span><br><span class="line">                        uid, gids, runtimeFlags, mountExternal, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                        invokeWith, startTime);</span><br><span class="line">                handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,</span><br><span class="line">                        startSeq, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">&quot;Failure starting process &quot;</span> + app.processName, e);</span><br><span class="line">                app.pendingStart = <span class="keyword">false</span>;</span><br><span class="line">                forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid),</span><br><span class="line">                        <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                        UserHandle.getUserId(app.userId), <span class="string">&quot;start failure&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> app.pid &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-4、-ActivityManagerService-startProcess"><a href="#5-1-4、-ActivityManagerService-startProcess" class="headerlink" title="5.1.4、 ActivityManagerService.startProcess()"></a>5.1.4、 ActivityManagerService.startProcess()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\services\core\java\com\android\server\am\ActivityManagerService.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ProcessStartResult <span class="title">startProcess</span><span class="params">(String hostingType, String entryPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProcessRecord app, <span class="keyword">int</span> uid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">            String seInfo, String requiredAbi, String instructionSet, String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> startTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;Start proc: &quot;</span> +</span><br><span class="line">                    app.processName);</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;startProcess: asking zygote to start proc&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> ProcessStartResult startResult;</span><br><span class="line">            <span class="keyword">if</span> (hostingType.equals(<span class="string">&quot;webview_service&quot;</span>)) &#123;</span><br><span class="line">                startResult = startWebView(entryPoint,</span><br><span class="line">                        app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                        app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                        app.info.dataDir, <span class="keyword">null</span>,</span><br><span class="line">                        <span class="keyword">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                startResult = Process.start(entryPoint,</span><br><span class="line">                        app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                        app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                        app.info.dataDir, invokeWith,</span><br><span class="line">                        <span class="keyword">new</span> String[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPerfServiceStartHint == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPerfServiceStartHint = <span class="keyword">new</span> BoostFramework();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPerfServiceStartHint != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPerfServiceStartHint.perfHint(BoostFramework.VENDOR_HINT_FIRST_LAUNCH_BOOST, app.processName, -<span class="number">1</span>, BoostFramework.Launch.TYPE_SERVICE_START);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">&quot;startProcess: returned from zygote!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> startResult;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-5、Process-start"><a href="#5-1-5、Process-start" class="headerlink" title="5.1.5、Process.start()"></a>5.1.5、Process.start()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\os\Process.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> zygoteProcess.start(processClass, niceName, uid, gid, gids,</span><br><span class="line">                    runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                    abi, instructionSet, appDataDir, invokeWith, zygoteArgs);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-6、zygoteProcess-start"><a href="#5-1-6、zygoteProcess-start" class="headerlink" title="5.1.6、zygoteProcess.start()"></a>5.1.6、zygoteProcess.start()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\os\ZygoteProcess.java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Process.<span class="function">ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  String[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">                    runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                    abi, instructionSet, appDataDir, invokeWith, <span class="keyword">false</span> <span class="comment">/* startChildZygote */</span>,</span><br><span class="line">                    zygoteArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">            Log.e(LOG_TAG,</span><br><span class="line">                    <span class="string">&quot;Starting VM process through Zygote failed&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Starting VM process through Zygote failed&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Process.<span class="function">ProcessStartResult <span class="title">startViaZygote</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">final</span> String niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">boolean</span> startChildZygote,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      String[] extraArgs)</span></span></span><br><span class="line"><span class="function">                                                      <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --runtime-args, --setuid=, --setgid=,</span></span><br><span class="line">        <span class="comment">// and --setgroups= must go first</span></span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--runtime-args&quot;</span>);</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--setuid=&quot;</span> + uid);</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--setgid=&quot;</span> + gid);</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--runtime-flags=&quot;</span> + runtimeFlags);</span><br><span class="line">        <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--mount-external-default&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--mount-external-read&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--mount-external-write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        argsForZygote.add(<span class="string">&quot;--target-sdk-version=&quot;</span> + targetSdkVersion);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// --setgroups is a comma-separated list</span></span><br><span class="line">        <span class="keyword">if</span> (gids != <span class="keyword">null</span> &amp;&amp; gids.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            sb.append(<span class="string">&quot;--setgroups=&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> sz = gids.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">                    sb.append(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                sb.append(gids[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            argsForZygote.add(sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--nice-name=&quot;</span> + niceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (seInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--seinfo=&quot;</span> + seInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instructionSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--instruction-set=&quot;</span> + instructionSet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (appDataDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--app-data-dir=&quot;</span> + appDataDir);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--invoke-with&quot;</span>);</span><br><span class="line">            argsForZygote.add(invokeWith);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (startChildZygote) &#123;</span><br><span class="line">            argsForZygote.add(<span class="string">&quot;--start-child-zygote&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        argsForZygote.add(processClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (extraArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String arg : extraArgs) &#123;</span><br><span class="line">                argsForZygote.add(arg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span>(mLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>该过程主要工作是生成argsForZygote数组，该数组保存了进程的uid、gid、groups、target-sdk、nice-name等一系列的参数。</p>
<h5 id="5-1-7、zygoteProcess-openZygoteSocketIfNeeded"><a href="#5-1-7、zygoteProcess-openZygoteSocketIfNeeded" class="headerlink" title="5.1.7、zygoteProcess.openZygoteSocketIfNeeded()"></a>5.1.7、zygoteProcess.openZygoteSocketIfNeeded()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\os\ZygoteProcess.java</span><br><span class="line">    <span class="meta">@GuardedBy(&quot;mLock&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ZygoteState <span class="title">openZygoteSocketIfNeeded</span><span class="params">(String abi)</span> <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">        Preconditions.checkState(Thread.holdsLock(mLock), <span class="string">&quot;ZygoteProcess lock not held&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (primaryZygoteState == <span class="keyword">null</span> || primaryZygoteState.isClosed()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//向主zygote发起connect()操作</span></span><br><span class="line">                primaryZygoteState = ZygoteState.connect(mSocket);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">&quot;Error connecting to primary zygote&quot;</span>, ioe);</span><br><span class="line">            &#125;</span><br><span class="line">            maybeSetApiBlacklistExemptions(primaryZygoteState, <span class="keyword">false</span>);</span><br><span class="line">            maybeSetHiddenApiAccessLogSampleRate(primaryZygoteState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class="line">            <span class="keyword">return</span> primaryZygoteState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The primary zygote didn&#x27;t match. Try the secondary.</span></span><br><span class="line">        <span class="keyword">if</span> (secondaryZygoteState == <span class="keyword">null</span> || secondaryZygoteState.isClosed()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//当主zygote没能匹配成功，则采用第二个zygote，发起connect()操作</span></span><br><span class="line">                secondaryZygoteState = ZygoteState.connect(mSecondarySocket);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">&quot;Error connecting to secondary zygote&quot;</span>, ioe);</span><br><span class="line">            &#125;</span><br><span class="line">            maybeSetApiBlacklistExemptions(secondaryZygoteState, <span class="keyword">false</span>);</span><br><span class="line">            maybeSetHiddenApiAccessLogSampleRate(secondaryZygoteState);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class="line">            <span class="keyword">return</span> secondaryZygoteState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">&quot;Unsupported zygote ABI: &quot;</span> + abi);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>openZygoteSocketIfNeeded(abi)方法是根据当前的abi来选择与zygote还是zygote64来进行通信。</p>
<p>既然system_server进程的zygoteSendArgsAndGetResult()方法通过socket向Zygote进程发送消息，这是便会唤醒Zygote进程，来响应socket客户端的请求（即system_server端），接下来的操作便是在Zygote来创建进程</p>
<h5 id="5-1-8、zygoteSendArgsAndGetResult"><a href="#5-1-8、zygoteSendArgsAndGetResult" class="headerlink" title="5.1.8、zygoteSendArgsAndGetResult"></a>5.1.8、zygoteSendArgsAndGetResult</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\android\os\ZygoteProcess.java</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">( ZygoteState zygoteState, ArrayList&lt;String&gt; args)</span> <span class="keyword">throws</span> ZygoteStartFailedEx </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> BufferedWriter writer = zygoteState.writer;</span><br><span class="line">        <span class="keyword">final</span> DataInputStream inputStream = zygoteState.inputStream;</span><br><span class="line"></span><br><span class="line">        writer.write(Integer.toString(args.size()));</span><br><span class="line">        writer.newLine();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sz = args.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</span><br><span class="line">            String arg = args.get(i);</span><br><span class="line">            <span class="keyword">if</span> (arg.indexOf(<span class="string">&#x27;\n&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(</span><br><span class="line">                        <span class="string">&quot;embedded newlines not allowed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            writer.write(arg);</span><br><span class="line">            writer.newLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.flush();</span><br><span class="line"></span><br><span class="line">        ProcessStartResult result = <span class="keyword">new</span> ProcessStartResult();</span><br><span class="line">        <span class="comment">//等待socket服务端（即zygote）返回新创建的进程pid;</span></span><br><span class="line">        <span class="comment">//对于等待时长问题，Google正在考虑此处是否应该有一个timeout，但目前是没有的。</span></span><br><span class="line">        result.pid = inputStream.readInt();</span><br><span class="line">        <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        result.usingWrapper = inputStream.readBoolean();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        zygoteState.close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的主要功能是通过socket通道向Zygote进程发送一个参数列表，然后进入阻塞等待状态，直到远端的socket服务端发送回来新创建的进程pid才返回。</p>
<h5 id="5-2、Zygote创建进程"><a href="#5-2、Zygote创建进程" class="headerlink" title="5.2、Zygote创建进程"></a>5.2、Zygote创建进程</h5><p>简单来说就是Zygote进程是由由init进程而创建的，进程启动之后调用ZygoteInit.main()方法，经过创建socket管道，预加载资源后，便进程runSelectLoop()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\os\ZygoteInit.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">        ZygoteServer zygoteServer = <span class="keyword">new</span> ZygoteServer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mark zygote start. This ensures that thread creation will throw</span></span><br><span class="line">        <span class="comment">// an error.</span></span><br><span class="line">        ZygoteHooks.startZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zygote goes into its own process group.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failed to setpgid(0,0)&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Runnable caller;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Report Zygote start time to tron unless it is a runtime restart</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;1&quot;</span>.equals(SystemProperties.get(<span class="string">&quot;sys.boot_completed&quot;</span>))) &#123;</span><br><span class="line">                MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">&quot;boot_zygote_init&quot;</span>,</span><br><span class="line">                        (<span class="keyword">int</span>) SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String bootTimeTag = Process.is64Bit() ? <span class="string">&quot;Zygote64Timing&quot;</span> : <span class="string">&quot;Zygote32Timing&quot;</span>;</span><br><span class="line">            TimingsTraceLog bootTimingsTraceLog = <span class="keyword">new</span> TimingsTraceLog(bootTimeTag,</span><br><span class="line">                    Trace.TRACE_TAG_DALVIK);</span><br><span class="line">            bootTimingsTraceLog.traceBegin(<span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">            RuntimeInit.enableDdms();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">            String socketName = <span class="string">&quot;zygote&quot;</span>;</span><br><span class="line">            String abiList = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> enableLazyPreload = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;--enable-lazy-preload&quot;</span>.equals(argv[i])) &#123;</span><br><span class="line">                    enableLazyPreload = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</span><br><span class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</span><br><span class="line">                    socketName = argv[i].substring(SOCKET_NAME_ARG.length());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unknown command line argument: &quot;</span> + argv[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (abiList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No ABI list supplied.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            zygoteServer.registerServerSocketFromEnv(socketName);</span><br><span class="line">            <span class="comment">// In some configurations, we avoid preloading resources and classes eagerly.</span></span><br><span class="line">            <span class="comment">// In such cases, we will preload things prior to our first fork.</span></span><br><span class="line">            <span class="keyword">if</span> (!enableLazyPreload) &#123;</span><br><span class="line">                preload(bootTimingsTraceLog);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Zygote.resetNicePriority();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            gcAndFinalize();</span><br><span class="line">            Zygote.nativeSecurityInit();</span><br><span class="line">            Zygote.nativeUnmountStorageOnInit();</span><br><span class="line"></span><br><span class="line">            ZygoteHooks.stopZygoteNoThreadCreation();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">                Runnable r = forkSystemServer(abiList, socketName, zygoteServer);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// &#123;@code r == null&#125; in the parent (zygote) process, and &#123;@code r != null&#125; in the</span></span><br><span class="line">                <span class="comment">// child (system_server) process.</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The select loop returns early in the child process after a fork and</span></span><br><span class="line">            <span class="comment">// loops forever in the zygote.</span></span><br><span class="line">            caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            zygoteServer.closeServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">        <span class="comment">// command.</span></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            caller.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\os\ZygoteServer.java</span><br><span class="line"></span><br><span class="line">    <span class="function">Runnable <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">        ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line"></span><br><span class="line">        fds.add(mServerSocket.getFileDescriptor());</span><br><span class="line">        peers.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">                pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">                pollFds[i].fd = fds.get(i);</span><br><span class="line">                pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Os.poll(pollFds, -<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;poll failed&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                    ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(newPeer);</span><br><span class="line">                    fds.add(newPeer.getFileDesciptor());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ZygoteConnection connection = peers.get(i);</span><br><span class="line">                        <span class="keyword">final</span> Runnable command = connection.processOneCommand(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (mIsForkChild) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (command == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;command == null&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> command;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (command != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;command != null&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (connection.isClosedByPeer()) &#123;</span><br><span class="line">                                connection.closeSocket();</span><br><span class="line">                                peers.remove(i);</span><br><span class="line">                                fds.remove(i);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mIsForkChild) &#123;</span><br><span class="line">                            ZygoteConnection conn = peers.remove(i);</span><br><span class="line">                            conn.closeSocket();</span><br><span class="line"></span><br><span class="line">                            fds.remove(i);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            Log.e(TAG, <span class="string">&quot;Caught post-fork exception in child process.&quot;</span>, e);</span><br><span class="line">                            <span class="keyword">throw</span> e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        mIsForkChild = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="5-2-1、acceptCommandPeer"><a href="#5-2-1、acceptCommandPeer" class="headerlink" title="5.2.1、acceptCommandPeer()"></a>5.2.1、acceptCommandPeer()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\os\ZygoteServer.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ZygoteConnection <span class="title">acceptCommandPeer</span><span class="params">(String abiList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createNewConnection(mServerSocket.accept(), abiList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;IOException during accept()&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ZygoteConnection <span class="title">createNewConnection</span><span class="params">(LocalSocket socket, String abiList)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ZygoteConnection(socket, abiList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接收客户端发送过来的connect()操作，Zygote作为服务端执行accept()操作。 再后面客户端调用write()写数据，Zygote进程调用read()读数据。</p>
<p>没有连接请求时会进入休眠状态，当有创建新进程的连接请求时，唤醒Zygote进程，创建Socket通道ZygoteConnection，然后执行ZygoteConnection的processOneCommand()方法。</p>
<h5 id="5-2-2、processOneCommand"><a href="#5-2-2、processOneCommand" class="headerlink" title="5.2.2、processOneCommand()"></a>5.2.2、processOneCommand()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\os\ZygoteConnection.java</span><br><span class="line">    <span class="function">Runnable <span class="title">processOneCommand</span><span class="params">(ZygoteServer zygoteServer)</span> </span>&#123;</span><br><span class="line">        String args[];</span><br><span class="line">        Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">        FileDescriptor[] descriptors;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            args = readArgumentList();</span><br><span class="line">            descriptors = mSocket.getAncillaryFileDescriptors();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;IOException on command socket&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// readArgumentList returns null only when it has reached EOF with no available</span></span><br><span class="line">        <span class="comment">// data to read. This will only happen when the remote socket has disconnected.</span></span><br><span class="line">        <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">            isEof = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pid = -<span class="number">1</span>;</span><br><span class="line">        FileDescriptor childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">        FileDescriptor serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        parsedArgs = <span class="keyword">new</span> Arguments(args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.abiListQuery) &#123;</span><br><span class="line">            handleAbiListQuery();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.preloadDefault) &#123;</span><br><span class="line">            handlePreload();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.preloadPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handlePreloadPackage(parsedArgs.preloadPackage, parsedArgs.preloadPackageLibs,</span><br><span class="line">                    parsedArgs.preloadPackageLibFileName, parsedArgs.preloadPackageCacheKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.apiBlacklistExemptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handleApiBlacklistExemptions(parsedArgs.apiBlacklistExemptions);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.hiddenApiAccessLogSampleRate != -<span class="number">1</span>) &#123;</span><br><span class="line">            handleHiddenApiAccessLogSampleRate(parsedArgs.hiddenApiAccessLogSampleRate);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.permittedCapabilities != <span class="number">0</span> || parsedArgs.effectiveCapabilities != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteSecurityException(<span class="string">&quot;Client may not specify capabilities: &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;permitted=0x&quot;</span> + Long.toHexString(parsedArgs.permittedCapabilities) +</span><br><span class="line">                    <span class="string">&quot;, effective=0x&quot;</span> + Long.toHexString(parsedArgs.effectiveCapabilities));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        applyUidSecurityPolicy(parsedArgs, peer);</span><br><span class="line">        applyInvokeWithSecurityPolicy(parsedArgs, peer);</span><br><span class="line"></span><br><span class="line">        applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[][] rlimits = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.rlimits != <span class="keyword">null</span>) &#123;</span><br><span class="line">            rlimits = parsedArgs.rlimits.toArray(intArray2d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] fdsToIgnore = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);</span><br><span class="line">                childPipeFd = pipeFds[<span class="number">1</span>];</span><br><span class="line">                serverPipeFd = pipeFds[<span class="number">0</span>];</span><br><span class="line">                Os.fcntlInt(childPipeFd, F_SETFD, <span class="number">0</span>);</span><br><span class="line">                fdsToIgnore = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;childPipeFd.getInt$(), serverPipeFd.getInt$()&#125;;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException errnoEx) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unable to set up pipe for invoke-with&quot;</span>, errnoEx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * In order to avoid leaking descriptors to the Zygote child,</span></span><br><span class="line"><span class="comment">         * the native code must close the two Zygote socket descriptors</span></span><br><span class="line"><span class="comment">         * in the child process before it switches from Zygote-root to</span></span><br><span class="line"><span class="comment">         * the UID and privileges of the application being launched.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * In order to avoid &quot;bad file descriptor&quot; errors when the</span></span><br><span class="line"><span class="comment">         * two LocalSocket objects are closed, the Posix file</span></span><br><span class="line"><span class="comment">         * descriptors are released via a dup2() call which closes</span></span><br><span class="line"><span class="comment">         * the socket and substitutes an open descriptor to /dev/null.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> [] fdsToClose = &#123; -<span class="number">1</span>, -<span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">        FileDescriptor fd = mSocket.getFileDescriptor();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fdsToClose[<span class="number">0</span>] = fd.getInt$();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fd = zygoteServer.getServerSocketFileDescriptor();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fdsToClose[<span class="number">1</span>] = fd.getInt$();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">                parsedArgs.runtimeFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">                parsedArgs.niceName, fdsToClose, fdsToIgnore, parsedArgs.startChildZygote,</span><br><span class="line">                parsedArgs.instructionSet, parsedArgs.appDataDir);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// in child</span></span><br><span class="line">                zygoteServer.setForkChild();</span><br><span class="line"></span><br><span class="line">                zygoteServer.closeServerSocket();</span><br><span class="line">                IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">                serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> handleChildProc(parsedArgs, descriptors, childPipeFd,</span><br><span class="line">                        parsedArgs.startChildZygote);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span></span><br><span class="line">                <span class="comment">// handleParentProc.</span></span><br><span class="line">                IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">                childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">                handleParentProc(pid, descriptors, serverPipeFd);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">            IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-2-3、forkAndSpecialize"><a href="#5-2-3、forkAndSpecialize" class="headerlink" title="5.2.3、forkAndSpecialize()"></a>5.2.3、forkAndSpecialize()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\os\Zygote.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkAndSpecialize</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span>[][] rlimits, <span class="keyword">int</span> mountExternal, String seInfo, String niceName, <span class="keyword">int</span>[] fdsToClose,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span>[] fdsToIgnore, <span class="keyword">boolean</span> startChildZygote, String instructionSet, String appDataDir)</span> </span>&#123;</span><br><span class="line">        VM_HOOKS.preFork();</span><br><span class="line">        <span class="comment">// Resets nice priority for zygote process.</span></span><br><span class="line">        resetNicePriority();</span><br><span class="line">        <span class="keyword">int</span> pid = nativeForkAndSpecialize(</span><br><span class="line">                  uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,</span><br><span class="line">                  fdsToIgnore, startChildZygote, instructionSet, appDataDir);</span><br><span class="line">        <span class="comment">// Enable tracing as soon as possible for the child process.</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            Trace.setTracingEnabled(<span class="keyword">true</span>, runtimeFlags);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note that this event ends at the end of handleChildProc,</span></span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;PostFork&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        VM_HOOKS.postForkCommon();</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VM_HOOKS是Zygote对象的静态成员变量：VM_HOOKS = new ZygoteHooks();</p>
<h5 id="5-2-4、nativeForkAndSpecialize"><a href="#5-2-4、nativeForkAndSpecialize" class="headerlink" title="5.2.4、nativeForkAndSpecialize"></a>5.2.4、nativeForkAndSpecialize</h5><p>nativeForkAndSpecialize()通过JNI最终调用调用如下方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\com_android_internal_os_Zygote.cpp</span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JNIEnv* env, jclass, jint uid, jint gid, jintArray gids,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint runtime_flags, jobjectArray rlimits,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint mount_external, jstring se_info, jstring se_name,</span></span></span><br><span class="line"><span class="function"><span class="params">        jintArray fdsToClose, jintArray fdsToIgnore, jboolean is_child_zygote,</span></span></span><br><span class="line"><span class="function"><span class="params">        jstring instructionSet, jstring appDataDir)</span> </span>&#123;</span><br><span class="line">    jlong capabilities = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grant CAP_WAKE_ALARM to the Bluetooth process.</span></span><br><span class="line">    <span class="comment">// Additionally, allow bluetooth to open packet sockets so it can start the DHCP client.</span></span><br><span class="line">    <span class="comment">// Grant CAP_SYS_NICE to allow Bluetooth to set RT priority for</span></span><br><span class="line">    <span class="comment">// audio-related threads.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> consider making such functionality an RPC to netd.</span></span><br><span class="line">    <span class="keyword">if</span> (multiuser_get_app_id(uid) == AID_BLUETOOTH) &#123;</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_WAKE_ALARM);</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_NET_RAW);</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_NET_BIND_SERVICE);</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_SYS_NICE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grant CAP_BLOCK_SUSPEND to processes that belong to GID &quot;wakelock&quot;</span></span><br><span class="line">    <span class="keyword">bool</span> gid_wakelock_found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (gid == AID_WAKELOCK) &#123;</span><br><span class="line">      gid_wakelock_found = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gids != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      jsize gids_num = env-&gt;GetArrayLength(gids);</span><br><span class="line">      <span class="function">ScopedIntArrayRO <span class="title">ar</span><span class="params">(env, gids)</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (ar.get() == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RuntimeAbort(env, __LINE__, <span class="string">&quot;Bad gids array&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gids_num; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ar[i] == AID_WAKELOCK) &#123;</span><br><span class="line">          gid_wakelock_found = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (gid_wakelock_found) &#123;</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_BLOCK_SUSPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If forking a child zygote process, that zygote will need to be able to change</span></span><br><span class="line">    <span class="comment">// the UID and GID of processes it forks, as well as drop those capabilities.</span></span><br><span class="line">    <span class="keyword">if</span> (is_child_zygote) &#123;</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_SETUID);</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_SETGID);</span><br><span class="line">      capabilities |= (<span class="number">1L</span>L &lt;&lt; CAP_SETPCAP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Containers run without some capabilities, so drop any caps that are not</span></span><br><span class="line">    <span class="comment">// available.</span></span><br><span class="line">    capabilities &amp;= GetEffectiveCapabilityMask(env);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ForkAndSpecializeCommon(env, uid, gid, gids, runtime_flags,</span><br><span class="line">            rlimits, capabilities, capabilities, mount_external, se_info,</span><br><span class="line">            se_name, <span class="literal">false</span>, fdsToClose, fdsToIgnore, is_child_zygote == JNI_TRUE,</span><br><span class="line">            instructionSet, appDataDir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-2-5、ForkAndSpecializeCommon"><a href="#5-2-5、ForkAndSpecializeCommon" class="headerlink" title="5.2.5、ForkAndSpecializeCommon"></a>5.2.5、ForkAndSpecializeCommon</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\com_android_internal_os_Zygote.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">pid_t</span> <span class="title">ForkAndSpecializeCommon</span><span class="params">(JNIEnv* env, <span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid, jintArray javaGids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jint runtime_flags, jobjectArray javaRlimits,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jlong permittedCapabilities, jlong effectiveCapabilities,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jint mount_external,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jstring java_se_info, jstring java_se_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">bool</span> is_system_server, jintArray fdsToClose,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jintArray fdsToIgnore, <span class="keyword">bool</span> is_child_zygote,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     jstring instructionSet, jstring dataDir)</span> </span>&#123;</span><br><span class="line">  SetSignalHandlers();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">sigset_t</span> sigchld;</span><br><span class="line">  sigemptyset(&amp;sigchld);</span><br><span class="line">  sigaddset(&amp;sigchld, SIGCHLD);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> fail_fn = [env, java_se_name, is_system_server](<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; msg)</span><br><span class="line">      __attribute__ ((noreturn)) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* se_name_c_str = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ScopedUtfChars&gt; se_name;</span><br><span class="line">    <span class="keyword">if</span> (java_se_name != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      se_name.reset(<span class="keyword">new</span> ScopedUtfChars(env, java_se_name));</span><br><span class="line">      se_name_c_str = se_name-&gt;c_str();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (se_name_c_str == <span class="literal">nullptr</span> &amp;&amp; is_system_server) &#123;</span><br><span class="line">      se_name_c_str = <span class="string">&quot;system_server&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; error_msg = (se_name_c_str == <span class="literal">nullptr</span>)</span><br><span class="line">        ? msg</span><br><span class="line">        : StringPrintf(<span class="string">&quot;(%s) %s&quot;</span>, se_name_c_str, msg.c_str());</span><br><span class="line">    env-&gt;FatalError(error_msg.c_str());</span><br><span class="line">    __builtin_unreachable();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Temporarily block SIGCHLD during forks. The SIGCHLD handler might</span></span><br><span class="line">  <span class="comment">// log, which would result in the logging FDs we close being reopened.</span></span><br><span class="line">  <span class="comment">// This would cause failures because the FDs are not whitelisted.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Note that the zygote process is single threaded at this point.</span></span><br><span class="line">  <span class="keyword">if</span> (sigprocmask(SIG_BLOCK, &amp;sigchld, <span class="literal">nullptr</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">    fail_fn(CREATE_ERROR(<span class="string">&quot;sigprocmask(SIG_SETMASK, &#123; SIGCHLD &#125;) failed: %s&quot;</span>, strerror(errno)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Close any logging related FDs before we start evaluating the list of</span></span><br><span class="line">  <span class="comment">// file descriptors.</span></span><br><span class="line">  __android_log_close();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> error_msg;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If this is the first fork for this zygote, create the open FD table.</span></span><br><span class="line">  <span class="comment">// If it isn&#x27;t, we just need to check whether the list of open files has</span></span><br><span class="line">  <span class="comment">// changed (and it shouldn&#x27;t in the normal case).</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; fds_to_ignore;</span><br><span class="line">  <span class="keyword">if</span> (!FillFileDescriptorVector(env, fdsToIgnore, &amp;fds_to_ignore, &amp;error_msg)) &#123;</span><br><span class="line">    fail_fn(error_msg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (gOpenFdTable == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    gOpenFdTable = FileDescriptorTable::Create(fds_to_ignore, &amp;error_msg);</span><br><span class="line">    <span class="keyword">if</span> (gOpenFdTable == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!gOpenFdTable-&gt;Restat(fds_to_ignore, &amp;error_msg)) &#123;</span><br><span class="line">    fail_fn(error_msg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    PreApplicationInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up any descriptors which must be closed immediately</span></span><br><span class="line">    <span class="keyword">if</span> (!DetachDescriptors(env, fdsToClose, &amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-open all remaining open file descriptors so that they aren&#x27;t shared</span></span><br><span class="line">    <span class="comment">// with the zygote across a fork.</span></span><br><span class="line">    <span class="keyword">if</span> (!gOpenFdTable-&gt;ReopenOrDetach(&amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sigprocmask(SIG_UNBLOCK, &amp;sigchld, <span class="literal">nullptr</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">      fail_fn(CREATE_ERROR(<span class="string">&quot;sigprocmask(SIG_SETMASK, &#123; SIGCHLD &#125;) failed: %s&quot;</span>, strerror(errno)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep capabilities across UID change, unless we&#x27;re staying root.</span></span><br><span class="line">    <span class="keyword">if</span> (uid != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!EnableKeepCapabilities(&amp;error_msg)) &#123;</span><br><span class="line">        fail_fn(error_msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SetInheritable(permittedCapabilities, &amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!DropCapabilitiesBoundingSet(&amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> use_native_bridge = !is_system_server &amp;&amp; (instructionSet != <span class="literal">NULL</span>)</span><br><span class="line">        &amp;&amp; android::NativeBridgeAvailable();</span><br><span class="line">    <span class="keyword">if</span> (use_native_bridge) &#123;</span><br><span class="line">      <span class="function">ScopedUtfChars <span class="title">isa_string</span><span class="params">(env, instructionSet)</span></span>;</span><br><span class="line">      use_native_bridge = android::NeedsNativeBridge(isa_string.c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (use_native_bridge &amp;&amp; dataDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="comment">// dataDir should never be null if we need to use a native bridge.</span></span><br><span class="line">      <span class="comment">// In general, dataDir will never be null for normal applications. It can only happen in</span></span><br><span class="line">      <span class="comment">// special cases (for isolated processes which are not associated with any app). These are</span></span><br><span class="line">      <span class="comment">// launched by the framework and should not be emulated anyway.</span></span><br><span class="line">      use_native_bridge = <span class="literal">false</span>;</span><br><span class="line">      ALOGW(<span class="string">&quot;Native bridge will not be used because dataDir == NULL.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!MountEmulatedStorage(uid, mount_external, use_native_bridge, &amp;error_msg)) &#123;</span><br><span class="line">      ALOGW(<span class="string">&quot;Failed to mount emulated storage: %s (%s)&quot;</span>, error_msg.c_str(), strerror(errno));</span><br><span class="line">      <span class="keyword">if</span> (errno == ENOTCONN || errno == EROFS) &#123;</span><br><span class="line">        <span class="comment">// When device is actively encrypting, we get ENOTCONN here</span></span><br><span class="line">        <span class="comment">// since FUSE was mounted before the framework restarted.</span></span><br><span class="line">        <span class="comment">// When encrypted device is booting, we get EROFS since</span></span><br><span class="line">        <span class="comment">// FUSE hasn&#x27;t been created yet by init.</span></span><br><span class="line">        <span class="comment">// In either case, continue without external storage.</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fail_fn(error_msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this zygote isn&#x27;t root, it won&#x27;t be able to create a process group,</span></span><br><span class="line">    <span class="comment">// since the directory is owned by root.</span></span><br><span class="line">    <span class="keyword">if</span> (!is_system_server &amp;&amp; getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> rc = createProcessGroup(uid, getpid());</span><br><span class="line">        <span class="keyword">if</span> (rc != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rc == -EROFS) &#123;</span><br><span class="line">                ALOGW(<span class="string">&quot;createProcessGroup failed, kernel missing CONFIG_CGROUP_CPUACCT?&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ALOGE(<span class="string">&quot;createProcessGroup(%d, %d) failed: %s&quot;</span>, uid, pid, strerror(-rc));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> error_msg;</span><br><span class="line">    <span class="keyword">if</span> (!SetGids(env, javaGids, &amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SetRLimits(env, javaRlimits, &amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (use_native_bridge) &#123;</span><br><span class="line">      <span class="function">ScopedUtfChars <span class="title">isa_string</span><span class="params">(env, instructionSet)</span></span>;</span><br><span class="line">      <span class="function">ScopedUtfChars <span class="title">data_dir</span><span class="params">(env, dataDir)</span></span>;</span><br><span class="line">      android::PreInitializeNativeBridge(data_dir.c_str(), isa_string.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rc = setresgid(gid, gid, gid);</span><br><span class="line">    <span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line">      fail_fn(CREATE_ERROR(<span class="string">&quot;setresgid(%d) failed: %s&quot;</span>, gid, strerror(errno)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Must be called when the new process still has CAP_SYS_ADMIN, in this case, before changing</span></span><br><span class="line">    <span class="comment">// uid from 0, which clears capabilities.  The other alternative is to call</span></span><br><span class="line">    <span class="comment">// prctl(PR_SET_NO_NEW_PRIVS, 1) afterward, but that breaks SELinux domain transition (see</span></span><br><span class="line">    <span class="comment">// b/71859146).  As the result, privileged syscalls used below still need to be accessible in</span></span><br><span class="line">    <span class="comment">// app process.</span></span><br><span class="line">    SetUpSeccompFilter(uid);</span><br><span class="line"></span><br><span class="line">    rc = setresuid(uid, uid, uid);</span><br><span class="line">    <span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line">      fail_fn(CREATE_ERROR(<span class="string">&quot;setresuid(%d) failed: %s&quot;</span>, uid, strerror(errno)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NeedsNoRandomizeWorkaround()) &#123;</span><br><span class="line">        <span class="comment">// Work around ARM kernel ASLR lossage (http://b/5817320).</span></span><br><span class="line">        <span class="keyword">int</span> old_personality = personality(<span class="number">0xffffffff</span>);</span><br><span class="line">        <span class="keyword">int</span> new_personality = personality(old_personality | ADDR_NO_RANDOMIZE);</span><br><span class="line">        <span class="keyword">if</span> (new_personality == <span class="number">-1</span>) &#123;</span><br><span class="line">            ALOGW(<span class="string">&quot;personality(%d) failed: %s&quot;</span>, new_personality, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SetCapabilities(permittedCapabilities, effectiveCapabilities, permittedCapabilities,</span><br><span class="line">                         &amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!SetSchedulerPolicy(&amp;error_msg)) &#123;</span><br><span class="line">      fail_fn(error_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* se_info_c_str = <span class="literal">NULL</span>;</span><br><span class="line">    ScopedUtfChars* se_info = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (java_se_info != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        se_info = <span class="keyword">new</span> ScopedUtfChars(env, java_se_info);</span><br><span class="line">        se_info_c_str = se_info-&gt;c_str();</span><br><span class="line">        <span class="keyword">if</span> (se_info_c_str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">          fail_fn(<span class="string">&quot;se_info_c_str == NULL&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* se_name_c_str = <span class="literal">NULL</span>;</span><br><span class="line">    ScopedUtfChars* se_name = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (java_se_name != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        se_name = <span class="keyword">new</span> ScopedUtfChars(env, java_se_name);</span><br><span class="line">        se_name_c_str = se_name-&gt;c_str();</span><br><span class="line">        <span class="keyword">if</span> (se_name_c_str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">          fail_fn(<span class="string">&quot;se_name_c_str == NULL&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rc = selinux_android_setcontext(uid, is_system_server, se_info_c_str, se_name_c_str);</span><br><span class="line">    <span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line">      fail_fn(CREATE_ERROR(<span class="string">&quot;selinux_android_setcontext(%d, %d, \&quot;%s\&quot;, \&quot;%s\&quot;) failed&quot;</span>, uid,</span><br><span class="line">            is_system_server, se_info_c_str, se_name_c_str));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make it easier to debug audit logs by setting the main thread&#x27;s name to the</span></span><br><span class="line">    <span class="comment">// nice name rather than &quot;app_process&quot;.</span></span><br><span class="line">    <span class="keyword">if</span> (se_name_c_str == <span class="literal">NULL</span> &amp;&amp; is_system_server) &#123;</span><br><span class="line">      se_name_c_str = <span class="string">&quot;system_server&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (se_name_c_str != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      SetThreadName(se_name_c_str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> se_info;</span><br><span class="line">    <span class="keyword">delete</span> se_name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unset the SIGCHLD handler, but keep ignoring SIGHUP (rationale in SetSignalHandlers).</span></span><br><span class="line">    UnsetChldSignalHandler();</span><br><span class="line"></span><br><span class="line">    env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, runtime_flags,</span><br><span class="line">                              is_system_server, is_child_zygote, instructionSet);</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;ExceptionCheck()) &#123;</span><br><span class="line">      fail_fn(<span class="string">&quot;Error calling post fork hooks.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// the parent process</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// We blocked SIGCHLD prior to a fork, we unblock it here.</span></span><br><span class="line">    <span class="keyword">if</span> (sigprocmask(SIG_UNBLOCK, &amp;sigchld, <span class="literal">nullptr</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">      fail_fn(CREATE_ERROR(<span class="string">&quot;sigprocmask(SIG_SETMASK, &#123; SIGCHLD &#125;) failed: %s&quot;</span>, strerror(errno)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-3、新进程运行"><a href="#5-3、新进程运行" class="headerlink" title="5.3、新进程运行"></a>5.3、新进程运行</h5><h5 id="5-3-1、handleChildProc"><a href="#5-3-1、handleChildProc" class="headerlink" title="5.3.1、handleChildProc()"></a>5.3.1、handleChildProc()</h5><p>processOneCommand()过程中调用forkAndSpecialize()创建完新进程后，返回值pid=0(即运行在子进程)继续开始执行handleChildProc()方法。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\com\android\internal\os\ZygoteConnection.java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Runnable <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs, FileDescriptor[] descriptors,</span></span></span><br><span class="line"><span class="function"><span class="params">            FileDescriptor pipeFd, boolean isZygote)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * By the time we get here, the native code has closed the two actual Zygote</span></span><br><span class="line"><span class="comment">         * socket connections, and substituted /dev/null in their place.  The LocalSocket</span></span><br><span class="line"><span class="comment">         * objects still need to be closed properly.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        closeSocket();</span><br><span class="line">        <span class="keyword">if</span> (descriptors != null) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Os.dup2(descriptors[<span class="number">0</span>], STDIN_FILENO);</span><br><span class="line">                Os.dup2(descriptors[<span class="number">1</span>], STDOUT_FILENO);</span><br><span class="line">                Os.dup2(descriptors[<span class="number">2</span>], STDERR_FILENO);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (FileDescriptor fd: descriptors) &#123;</span><br><span class="line">                    IoUtils.closeQuietly(fd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Error reopening stdio&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.niceName != null) &#123;</span><br><span class="line">            Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End of the postFork event.</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        <span class="keyword">if</span> (parsedArgs.invokeWith != null) &#123;</span><br><span class="line">            WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                    parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                    VMRuntime.getCurrentInstructionSet(),</span><br><span class="line">                    pipeFd, parsedArgs.remainingArgs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Should not get here.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;WrapperInit.execApplication unexpectedly returned&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isZygote) &#123;</span><br><span class="line">                <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs,</span><br><span class="line">                        null <span class="comment">/* classLoader */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">                        parsedArgs.remainingArgs, null <span class="comment">/* classLoader */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="5-3-2、ZygoteInit-zygoteInit"><a href="#5-3-2、ZygoteInit-zygoteInit" class="headerlink" title="5.3.2、ZygoteInit.zygoteInit()"></a>5.3.2、ZygoteInit.zygoteInit()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\com\android\internal\os\ZygoteInit.java</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (RuntimeInit.DEBUG) &#123;</span><br><span class="line">            Slog.d(RuntimeInit.TAG, <span class="string">&quot;RuntimeInit: Starting application from zygote&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">        RuntimeInit.redirectLogStreams();</span><br><span class="line"></span><br><span class="line">        RuntimeInit.commonInit();</span><br><span class="line">        ZygoteInit.nativeZygoteInit();</span><br><span class="line">        <span class="keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-3-3、RuntimeInit-commonInit"><a href="#5-3-3、RuntimeInit-commonInit" class="headerlink" title="5.3.3、RuntimeInit.commonInit()"></a>5.3.3、RuntimeInit.commonInit()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\java\com\android\internal\os\RuntimeInit.java</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">commonInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;Entered RuntimeInit!&quot;</span>);</span><br><span class="line">        LoggingHandler loggingHandler = <span class="keyword">new</span> LoggingHandler();</span><br><span class="line">        Thread.setUncaughtExceptionPreHandler(loggingHandler);</span><br><span class="line">        Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> KillApplicationHandler(loggingHandler));</span><br><span class="line">        </span><br><span class="line">        TimezoneGetter.setInstance(<span class="keyword">new</span> TimezoneGetter() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> String getId() &#123;</span><br><span class="line">                <span class="keyword">return</span> SystemProperties.get(<span class="string">&quot;persist.sys.timezone&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        TimeZone.setDefault(null);</span><br><span class="line"></span><br><span class="line">        LogManager.getLogManager().reset();</span><br><span class="line">        <span class="keyword">new</span> AndroidConfig()</span><br><span class="line">        String userAgent = getDefaultUserAgent();</span><br><span class="line">        System.setProperty(<span class="string">&quot;http.agent&quot;</span>, userAgent);</span><br><span class="line"></span><br><span class="line">        NetworkManagementSocketTagger.install();</span><br><span class="line"></span><br><span class="line">        String trace = SystemProperties.get(<span class="string">&quot;ro.kernel.android.tracing&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (trace.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;NOTE: emulator trace profiling enabled&quot;</span>);</span><br><span class="line">            Debug.enableEmulatorTraceOutput();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        initialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="5-3-4、nativeZygoteInit"><a href="#5-3-4、nativeZygoteInit" class="headerlink" title="5.3.4、nativeZygoteInit"></a>5.3.4、nativeZygoteInit</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\core\jni\AndroidRuntime.cpp</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_ZygoteInit_nativeZygoteInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCurRuntime-&gt;onZygoteInit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G:\android9<span class="number">.0</span>\frameworks\base\cmds\app_process\app_main.cpp</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">        ALOGV(<span class="string">&quot;App process: starting thread pool.\n&quot;</span>);</span><br><span class="line">        proc-&gt;startThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ProcessState::self():主要工作是调用open()打开/dev/binder驱动设备，再利用mmap()映射内核的地址空间，将Binder驱动的fd赋值ProcessState对象中的变量mDriverFD，用于交互操作。startThreadPool()是创建一个新的binder线程，不断进行talkWithDriver().<br>startThreadPool(): 启动Binder线程池</p>
<h5 id="5-3-5、RuntimeInit-applicationInit"><a href="#5-3-5、RuntimeInit-applicationInit" class="headerlink" title="5.3.5、RuntimeInit.applicationInit()"></a>5.3.5、RuntimeInit.applicationInit()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">G:\android9.<span class="number">0</span>\frameworks\base\core\java\com\android\internal\os\RuntimeInit.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If the application calls System.exit(), terminate the process</span></span><br><span class="line">        <span class="comment">// immediately without running any shutdown hooks.  It is not possible to</span></span><br><span class="line">        <span class="comment">// shutdown an Android application gracefully.  Among other things, the</span></span><br><span class="line">        <span class="comment">// Android runtime shutdown hooks close the Binder driver, which can cause</span></span><br><span class="line">        <span class="comment">// leftover running threads to crash before the process actually exits.</span></span><br><span class="line">        nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We want to be fairly aggressive about heap utilization, to avoid</span></span><br><span class="line">        <span class="comment">// holding on to a lot of memory that isn&#x27;t needed.</span></span><br><span class="line">        VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.75f</span>);</span><br><span class="line">        VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Arguments args = <span class="keyword">new</span> Arguments(argv);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The end of of the RuntimeInit event (see #zygoteInit).</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remaining arguments are passed to the start class&#x27;s static main</span></span><br><span class="line">        <span class="keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此处args.startClass为”android.app.ActivityThread”。</p>
<h5 id="5-3-6、findStaticMain"><a href="#5-3-6、findStaticMain" class="headerlink" title="5.3.6、findStaticMain()"></a>5.3.6、findStaticMain()</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title">findStaticMain</span><span class="params">(String className, String[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">        ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cl = Class.forName(className, <span class="literal">true</span>, classLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">&quot;Missing class when invoking static main &quot;</span> + className,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m = cl.getMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">&quot;Missing static main on &quot;</span> + className, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">&quot;Problem getting static main on &quot;</span> + className, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> modifiers = m.getModifiers();</span><br><span class="line">    <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">&quot;Main method is not public and static on &quot;</span> + className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This throw gets caught in ZygoteInit.main(), which responds</span></span><br><span class="line"><span class="comment">     * by invoking the exception&#x27;s run() method. This arrangement</span></span><br><span class="line"><span class="comment">     * clears up all the stack frames that were required in setting</span></span><br><span class="line"><span class="comment">     * up the process.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="5-3-7、MethodAndArgsCaller"><a href="#5-3-7、MethodAndArgsCaller" class="headerlink" title="5.3.7、MethodAndArgsCaller"></a>5.3.7、MethodAndArgsCaller</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="title">implements</span> <span class="title">Runnable</span> &#123;</span></span><br><span class="line">    <span class="comment">/** method to call */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** argument array */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> </span>&#123;</span><br><span class="line">        mMethod = method;</span><br><span class="line">        mArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//根据AMS startProcessLocked传递过来的参数，此处反射调用ActivityThread.main()方法</span></span><br><span class="line">            mMethod.invoke(null, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            Throwable cause = ex.getCause();</span><br><span class="line">            <span class="keyword">if</span> (cause instanceof RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause instanceof Error) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-3-8、Activity所在应用主线程初始化"><a href="#5-3-8、Activity所在应用主线程初始化" class="headerlink" title="5.3.8、Activity所在应用主线程初始化"></a>5.3.8、Activity所在应用主线程初始化</h5><p>在ActivityThread.main方法中对ActivityThread进行了初始化，创建了主线程的Looper对象并调用Looper.loop()方法启动Looper，把自定义Handler类H的对象作为主线程的handler。接下来跳转到ActivityThread.attach方法，看都做了什么。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ActivityThreadMain&quot;</span>);</span><br><span class="line">     ...</span><br><span class="line">     Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Find the value for &#123;@link #PROC_START_SEQ_IDENT&#125; if provided on the command line.</span></span><br><span class="line">     <span class="comment">// It will be in the format &quot;seq=114&quot;</span></span><br><span class="line">     <span class="keyword">long</span> startSeq = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> (args != null) &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = args.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">             <span class="keyword">if</span> (args[i] != null &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) &#123;</span><br><span class="line">                 startSeq = Long.parseLong(</span><br><span class="line">                         args[i].substring(PROC_START_SEQ_IDENT.length()));</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">     thread.attach(<span class="literal">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (sMainThreadHandler == null) &#123;</span><br><span class="line">         sMainThreadHandler = thread.getHandler();</span><br><span class="line">     &#125;</span><br><span class="line">     ...</span><br><span class="line">     Looper.loop();</span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Activity所在的进程创建完了，主线程也初始化了，接下来就该真正的启动Activity了。在ActivityThread.attach方法中，首先会通过ActivityManagerService为这个应用绑定一个Application，然后添加一个垃圾回收观察者，每当系统触发垃圾回收的时候就会在run方法里面去计算应用使用了多少内存，如果超过总量的四分之三就会尝试释放内存。最后，为根View添加config回调接收config变化相关的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br></pre></td><td class="code"><pre><span class="line">    frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">        sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">        mSystemThread = system;</span><br><span class="line">        <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.attachApplication(mAppThread, startSeq);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Watch for getting close to heap limit.</span></span><br><span class="line">            BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                    <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</span><br><span class="line">                    <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                    <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                        mSomeActivitiesChanged = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        ViewRootImpl.addConfigCallback(configChangedCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">            attachApplicationLocked(thread, callingPid, callingUid, startSeq);</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> pid, <span class="keyword">int</span> callingUid, <span class="keyword">long</span> startSeq)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the application record that is being attached...  either via</span></span><br><span class="line">        <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></span><br><span class="line">        <span class="comment">// next app record if we are emulating process with anonymous threads.</span></span><br><span class="line">        ProcessRecord app;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">                app = mPidsSelfLocked.get(pid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// It&#x27;s possible that process called attachApplication before we got a chance to</span></span><br><span class="line">        <span class="comment">// update the internal state.</span></span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; startSeq &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ProcessRecord pending = mPendingStarts.get(startSeq);</span><br><span class="line">            <span class="keyword">if</span> (pending != <span class="keyword">null</span> &amp;&amp; pending.startUid == callingUid</span><br><span class="line">                    &amp;&amp; handleProcessStartedLocked(pending, pid, pending.usingWrapper,</span><br><span class="line">                            startSeq, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                app = pending;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;No pending application record for pid &quot;</span> + pid</span><br><span class="line">                    + <span class="string">&quot; (IApplicationThread &quot;</span> + thread + <span class="string">&quot;); dropping process&quot;</span>);</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</span><br><span class="line">            <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123;</span><br><span class="line">                killProcessQuiet(pid);</span><br><span class="line">                <span class="comment">//<span class="doctag">TODO:</span> killProcessGroup(app.info.uid, pid);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    thread.scheduleExit();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// Ignore exceptions.</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this application record is still attached to a previous</span></span><br><span class="line">        <span class="comment">// process, clean it up now.</span></span><br><span class="line">        <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the process all about itself.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">                TAG, <span class="string">&quot;Binding process pid &quot;</span> + pid + <span class="string">&quot; to record &quot;</span> + app);</span><br><span class="line">------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.817</span> I/ActivityManagerService( <span class="number">1049</span>): Start proc <span class="number">2602</span>:com.android.testred/u0a88 <span class="keyword">for</span> activity com.android.testred/.TestActivity</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.837</span> V/ActivityManagerService( <span class="number">1049</span>): Binding process pid <span class="number">2602</span> to record ProcessRecord&#123;d768ca0 <span class="number">2602</span>:com.android.testred/u0a88&#125;</span><br><span class="line">------------------------------------</span><br><span class="line">        <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</span><br><span class="line">                    app, pid, thread);</span><br><span class="line">            thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</span><br><span class="line">            app.deathRecipient = adr;</span><br><span class="line">------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.837</span> V/ActivityManagerService( <span class="number">1049</span>): New death recipient com.android.server.am.ActivityManagerService$AppDeathRecipient@<span class="number">53</span>b14ff <span class="keyword">for</span> thread android.os.BinderProxy@<span class="number">6</span>c7d2cc</span><br><span class="line">------------------------------------</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            app.resetPackageList(mProcessStats);</span><br><span class="line">            startProcessLocked(app, <span class="string">&quot;link fail&quot;</span>, processName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</span><br><span class="line"></span><br><span class="line">        app.makeActive(thread, mProcessStats);</span><br><span class="line">        app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">        app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">        app.forcingToImportant = <span class="keyword">null</span>;</span><br><span class="line">        updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">        app.debugging = <span class="keyword">false</span>;</span><br><span class="line">        app.cached = <span class="keyword">false</span>;</span><br><span class="line">        app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">        app.killed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// We carefully use the same state that PackageManager uses for</span></span><br><span class="line">        <span class="comment">// filtering, since we use this flag to decide if we need to install</span></span><br><span class="line">        <span class="comment">// providers when user is unlocked later</span></span><br><span class="line">        app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);</span><br><span class="line"></span><br><span class="line">        mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line">        List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</span><br><span class="line">            Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</span><br><span class="line">            msg.obj = app;</span><br><span class="line">            mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkTime(startTime, <span class="string">&quot;attachApplicationLocked: before bindApplication&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!normalMode) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">&quot;Launching preboot mode app: &quot;</span> + app);</span><br><span class="line">        &#125;</span><br><span class="line">------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.838</span> V/ActivityManagerService( <span class="number">1049</span>): New app record ProcessRecord&#123;d768ca0 <span class="number">2602</span>:com.android.testred/u0a88&#125; thread=android.os.BinderProxy@<span class="number">6</span>c7d2cc pid=<span class="number">2602</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.838</span> V/ActivityManagerService_Configuration( <span class="number">1049</span>): Binding proc com.android.testred with config &#123;<span class="number">1.0</span> ?mcc?mnc [en_US] ldltr sw320dp w320dp h497dp <span class="number">240d</span>pi nrml port finger -keyb/v/h -nav/h winConfig=&#123; mBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">0</span>, <span class="number">0</span>) mAppBounds=Rect(<span class="number">0</span>, <span class="number">0</span> - <span class="number">480</span>, <span class="number">782</span>) mWindowingMode=fullscreen mActivityType=undefined&#125; s.<span class="number">5</span>&#125;</span><br><span class="line">------------------------------------</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;New app record &quot;</span> + app</span><br><span class="line">            + <span class="string">&quot; thread=&quot;</span> + thread.asBinder() + <span class="string">&quot; pid=&quot;</span> + pid);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> testMode = ApplicationThreadConstants.DEBUG_OFF;</span><br><span class="line">            <span class="keyword">if</span> (mDebugApp != <span class="keyword">null</span> &amp;&amp; mDebugApp.equals(processName)) &#123;</span><br><span class="line">                testMode = mWaitForDebugger</span><br><span class="line">                    ? ApplicationThreadConstants.DEBUG_WAIT</span><br><span class="line">                    : ApplicationThreadConstants.DEBUG_ON;</span><br><span class="line">                app.debugging = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (mDebugTransient) &#123;</span><br><span class="line">                    mDebugApp = mOrigDebugApp;</span><br><span class="line">                    mWaitForDebugger = mOrigWaitForDebugger;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> enableTrackAllocation = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mTrackAllocationApp != <span class="keyword">null</span> &amp;&amp; mTrackAllocationApp.equals(processName)) &#123;</span><br><span class="line">                enableTrackAllocation = <span class="keyword">true</span>;</span><br><span class="line">                mTrackAllocationApp = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the app is being launched for restore or full backup, set it up specially</span></span><br><span class="line">            <span class="keyword">boolean</span> isRestrictedBackupMode = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupAppName.equals(processName)) &#123;</span><br><span class="line">                isRestrictedBackupMode = mBackupTarget.appInfo.uid &gt;= FIRST_APPLICATION_UID</span><br><span class="line">                        &amp;&amp; ((mBackupTarget.backupMode == BackupRecord.RESTORE)</span><br><span class="line">                                || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</span><br><span class="line">                                || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (app.instr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                notifyPackageUse(app.instr.mClass.getPackageName(),</span><br><span class="line">                                 PackageManager.NOTIFY_PACKAGE_USE_INSTRUMENTATION);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">&quot;Binding proc &quot;</span></span><br><span class="line">                    + processName + <span class="string">&quot; with config &quot;</span> + getGlobalConfiguration());</span><br><span class="line">            ApplicationInfo appInfo = app.instr != <span class="keyword">null</span> ? app.instr.mTargetInfo : app.info;</span><br><span class="line">            app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line"></span><br><span class="line">            ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">            String preBindAgent = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (mProfileApp != <span class="keyword">null</span> &amp;&amp; mProfileApp.equals(processName)) &#123;</span><br><span class="line">                mProfileProc = app;</span><br><span class="line">                <span class="keyword">if</span> (mProfilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Send a profiler info object to the app if either a file is given, or</span></span><br><span class="line">                    <span class="comment">// an agent should be loaded at bind-time.</span></span><br><span class="line">                    <span class="keyword">boolean</span> needsInfo = mProfilerInfo.profileFile != <span class="keyword">null</span></span><br><span class="line">                            || mProfilerInfo.attachAgentDuringBind;</span><br><span class="line">                    profilerInfo = needsInfo ? <span class="keyword">new</span> ProfilerInfo(mProfilerInfo) : <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (mProfilerInfo.agent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        preBindAgent = mProfilerInfo.agent;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instr != <span class="keyword">null</span> &amp;&amp; app.instr.mProfileFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                profilerInfo = <span class="keyword">new</span> ProfilerInfo(app.instr.mProfileFile, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mAppAgentMap != <span class="keyword">null</span> &amp;&amp; mAppAgentMap.containsKey(processName)) &#123;</span><br><span class="line">                <span class="comment">// We need to do a debuggable check here. See setAgentApp for why the check is</span></span><br><span class="line">                <span class="comment">// postponed to here.</span></span><br><span class="line">                <span class="keyword">if</span> ((app.info.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) &#123;</span><br><span class="line">                    String agent = mAppAgentMap.get(processName);</span><br><span class="line">                    <span class="comment">// Do not overwrite already requested agent.</span></span><br><span class="line">                    <span class="keyword">if</span> (profilerInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        profilerInfo = <span class="keyword">new</span> ProfilerInfo(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                                mAppAgentMap.get(processName), <span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (profilerInfo.agent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        profilerInfo = profilerInfo.setAgent(mAppAgentMap.get(processName), <span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span> &amp;&amp; profilerInfo.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                profilerInfo.profileFd = profilerInfo.profileFd.dup();</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.equals(mProfileApp, processName) &amp;&amp; mProfilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clearProfilerLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We deprecated Build.SERIAL and it is not accessible to</span></span><br><span class="line">            <span class="comment">// apps that target the v2 security sandbox and to apps that</span></span><br><span class="line">            <span class="comment">// target APIs higher than O MR1. Since access to the serial</span></span><br><span class="line">            <span class="comment">// is now behind a permission we push down the value.</span></span><br><span class="line">            <span class="keyword">final</span> String buildSerial = (appInfo.targetSandboxVersion &lt; <span class="number">2</span></span><br><span class="line">                    &amp;&amp; appInfo.targetSdkVersion &lt; Build.VERSION_CODES.P)</span><br><span class="line">                            ? sTheRealBuildSerial : Build.UNKNOWN;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this is a secondary process that should be incorporated into some</span></span><br><span class="line">            <span class="comment">// currently active instrumentation.  (Note we do this AFTER all of the profiling</span></span><br><span class="line">            <span class="comment">// stuff above because profiling can currently happen only in the primary</span></span><br><span class="line">            <span class="comment">// instrumentation process.)</span></span><br><span class="line">            <span class="keyword">if</span> (mActiveInstrumentation.size() &gt; <span class="number">0</span> &amp;&amp; app.instr == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = mActiveInstrumentation.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; app.instr == <span class="keyword">null</span>; i--) &#123;</span><br><span class="line">                    ActiveInstrumentation aInstr = mActiveInstrumentation.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!aInstr.mFinished &amp;&amp; aInstr.mTargetInfo.uid == app.uid) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (aInstr.mTargetProcesses.length == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// This is the wildcard mode, where every process brought up for</span></span><br><span class="line">                            <span class="comment">// the target instrumentation should be included.</span></span><br><span class="line">                            <span class="keyword">if</span> (aInstr.mTargetInfo.packageName.equals(app.info.packageName)) &#123;</span><br><span class="line">                                app.instr = aInstr;</span><br><span class="line">                                aInstr.mRunningProcesses.add(app);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">for</span> (String proc : aInstr.mTargetProcesses) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (proc.equals(app.processName)) &#123;</span><br><span class="line">                                    app.instr = aInstr;</span><br><span class="line">                                    aInstr.mRunningProcesses.add(app);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we were asked to attach an agent on startup, do so now, before we&#x27;re binding</span></span><br><span class="line">            <span class="comment">// application code.</span></span><br><span class="line">            <span class="keyword">if</span> (preBindAgent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                thread.attachAgent(preBindAgent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Figure out whether the app needs to run in autofill compat mode.</span></span><br><span class="line">            <span class="keyword">boolean</span> isAutofillCompatEnabled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (UserHandle.getAppId(app.info.uid) &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">                <span class="keyword">final</span> AutofillManagerInternal afm = LocalServices.getService(</span><br><span class="line">                        AutofillManagerInternal.class);</span><br><span class="line">                <span class="keyword">if</span> (afm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    isAutofillCompatEnabled = afm.isCompatibilityModeRequested(</span><br><span class="line">                            app.info.packageName, app.info.versionCode, app.userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">&quot;attachApplicationLocked: immediately before bindApplication&quot;</span>);</span><br><span class="line">            mStackSupervisor.getActivityMetricsLogger().notifyBindApplication(app);</span><br><span class="line">            <span class="keyword">if</span> (app.isolatedEntryPoint != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// This is an isolated process which should just call an entry point instead of</span></span><br><span class="line">                <span class="comment">// being bound to an application.</span></span><br><span class="line">                thread.runIsolatedEntryPoint(app.isolatedEntryPoint, app.isolatedEntryPointArgs);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                thread.bindApplication(processName, appInfo, providers,</span><br><span class="line">                        app.instr.mClass,</span><br><span class="line">                        profilerInfo, app.instr.mArguments,</span><br><span class="line">                        app.instr.mWatcher,</span><br><span class="line">                        app.instr.mUiAutomationConnection, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                        <span class="keyword">new</span> Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                        getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, isAutofillCompatEnabled);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                thread.bindApplication(processName, appInfo, providers, <span class="keyword">null</span>, profilerInfo,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, testMode,</span><br><span class="line">                        mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                        isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                        <span class="keyword">new</span> Configuration(getGlobalConfiguration()), app.compat,</span><br><span class="line">                        getCommonServicesLocked(app.isolated),</span><br><span class="line">                        mCoreSettingsObserver.getCoreSettingsLocked(),</span><br><span class="line">                        buildSerial, isAutofillCompatEnabled);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                profilerInfo.closeFd();</span><br><span class="line">                profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;attachApplicationLocked: immediately after bindApplication&quot;</span>);</span><br><span class="line">------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.838</span> D/ActivityManagerService_LRU( <span class="number">1049</span>): Adding at <span class="number">45</span> of LRU list: ProcessRecord&#123;d768ca0 <span class="number">2602</span>:com.android.testred/u0a88&#125;</span><br><span class="line">------------------------</span><br><span class="line">            updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after updateLruProcessLocked&quot;</span>);</span><br><span class="line">            app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// todo: Yikes!  What should we do?  For now we will try to</span></span><br><span class="line">            <span class="comment">// start another process, but that could easily get us in</span></span><br><span class="line">            <span class="comment">// an infinite loop of restarting processes...</span></span><br><span class="line">            Slog.wtf(TAG, <span class="string">&quot;Exception thrown during bind of &quot;</span> + app, e);</span><br><span class="line"></span><br><span class="line">            app.resetPackageList(mProcessStats);</span><br><span class="line">            app.unlinkDeathRecipient();</span><br><span class="line">            startProcessLocked(app, <span class="string">&quot;bind fail&quot;</span>, processName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove this record from the list of starting applications.</span></span><br><span class="line">        mPersistentStartingProcesses.remove(app);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</span><br><span class="line">                <span class="string">&quot;Attach application locked removing on hold: &quot;</span> + app);</span><br><span class="line">        mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">        <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                    didSomething = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.wtf(TAG, <span class="string">&quot;Exception thrown launching activities in &quot;</span> + app, e);</span><br><span class="line">                badApp = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find any services that should be running in this process...</span></span><br><span class="line">        <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">                checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after mServices.attachApplicationLocked&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.wtf(TAG, <span class="string">&quot;Exception thrown starting services in &quot;</span> + app, e);</span><br><span class="line">                badApp = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if a next-broadcast receiver is in this process...</span></span><br><span class="line">        <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">                checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after sendPendingBroadcastsLocked&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// If the app died trying to launch the receiver we declare it &#x27;bad&#x27;</span></span><br><span class="line">                Slog.wtf(TAG, <span class="string">&quot;Exception thrown dispatching broadcasts in &quot;</span> + app, e);</span><br><span class="line">                badApp = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check whether the next backup agent is in this process...</span></span><br><span class="line">        <span class="keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupTarget.app == app) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BACKUP) Slog.v(TAG_BACKUP,</span><br><span class="line">                    <span class="string">&quot;New app is backup target, launching agent for &quot;</span> + app);</span><br><span class="line">            notifyPackageUse(mBackupTarget.appInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_BACKUP);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</span><br><span class="line">                        compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</span><br><span class="line">                        mBackupTarget.backupMode);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.wtf(TAG, <span class="string">&quot;Exception thrown creating backup agent in &quot;</span> + app, e);</span><br><span class="line">                badApp = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (badApp) &#123;</span><br><span class="line">            app.kill(<span class="string">&quot;error during init&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">            handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">            updateOomAdjLocked();</span><br><span class="line">            checkTime(startTime, <span class="string">&quot;attachApplicationLocked: after updateOomAdjLocked&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">        <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityDisplay display = mActivityDisplays.valueAt(displayNdx);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = display.getChildCount() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityStack stack = display.getChildAt(stackNdx);</span><br><span class="line">                <span class="keyword">if</span> (!isFocusedStack(stack)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList);</span><br><span class="line">                <span class="keyword">final</span> ActivityRecord top = stack.topRunningActivityLocked();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> size = mTmpActivityList.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityRecord activity = mTmpActivityList.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (activity.app == <span class="keyword">null</span> &amp;&amp; app.uid == activity.info.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; processName.equals(activity.processName)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (realStartActivityLocked(activity, app,</span><br><span class="line">                                    top == activity <span class="comment">/* andResume */</span>, <span class="keyword">true</span> <span class="comment">/* checkConfig */</span>)) &#123;</span><br><span class="line">                                didSomething = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">&quot;Exception in new application when starting activity &quot;</span></span><br><span class="line">                                    + top.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">                            <span class="keyword">throw</span> e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">            ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> didSomething;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">ensureActivitiesVisibleLocked</span><span class="params">(ActivityRecord starting, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> preserveWindows)</span> </span>&#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(starting, configChanges, preserveWindows,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/* notifyClients */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #ensureActivitiesVisibleLocked(ActivityRecord, int, boolean)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ensureActivitiesVisibleLocked</span><span class="params">(ActivityRecord starting, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> preserveWindows, <span class="keyword">boolean</span> notifyClients)</span> </span>&#123;</span><br><span class="line">        getKeyguardController().beginActivityVisibilityUpdate();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// First the front stacks. In case any are not fullscreen and are in front of home.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityDisplay display = mActivityDisplays.valueAt(displayNdx);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = display.getChildCount() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityStack stack = display.getChildAt(stackNdx);</span><br><span class="line">                    stack.ensureActivitiesVisibleLocked(starting, configChanges, preserveWindows,</span><br><span class="line">                            notifyClients);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            getKeyguardController().endActivityVisibilityUpdate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">android9.<span class="number">0</span>/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">ensureActivitiesVisibleLocked</span><span class="params">(ActivityRecord starting, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> preserveWindows, <span class="keyword">boolean</span> notifyClients)</span> </span>&#123;</span><br><span class="line">        mTopActivityOccludesKeyguard = <span class="keyword">false</span>;</span><br><span class="line">        mTopDismissingKeyguardActivity = <span class="keyword">null</span>;</span><br><span class="line">        mStackSupervisor.getKeyguardController().beginActivityVisibilityUpdate();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityRecord top = topRunningActivityLocked();</span><br><span class="line">----------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.840</span> V/ActivityStack_Visibility( <span class="number">1049</span>): ensureActivitiesVisible behind ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; configChanges=<span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.840</span> V/ActivityStack_Visibility( <span class="number">1049</span>): Make visible? ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; finishing=<span class="keyword">false</span> state=INITIALIZING</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.840</span> V/ActivityStack_Visibility( <span class="number">1049</span>): Skipping: already visible at ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;</span><br><span class="line">----------------------------------------------</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY, <span class="string">&quot;ensureActivitiesVisible behind &quot;</span> + top</span><br><span class="line">                    + <span class="string">&quot; configChanges=0x&quot;</span> + Integer.toHexString(configChanges));</span><br><span class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</span><br><span class="line">                checkTranslucentActivityWaiting(top);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the top activity is not fullscreen, then we need to</span></span><br><span class="line">            <span class="comment">// make sure any activities under it are now visible.</span></span><br><span class="line">            <span class="keyword">boolean</span> aboveTop = top != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> stackShouldBeVisible = shouldBeVisible(starting);</span><br><span class="line">            <span class="keyword">boolean</span> behindFullscreenActivity = !stackShouldBeVisible;</span><br><span class="line">            <span class="keyword">boolean</span> resumeNextActivity = mStackSupervisor.isFocusedStack(<span class="keyword">this</span>)</span><br><span class="line">                    &amp;&amp; (isInStackLocked(starting) == <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isTopNotPinnedStack =</span><br><span class="line">                    isAttached() &amp;&amp; getDisplay().isTopNotPinnedStack(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> TaskRecord task = mTaskHistory.get(taskNdx);</span><br><span class="line">                <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; activities = task.mActivities;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> activityNdx = activities.size() - <span class="number">1</span>; activityNdx &gt;= <span class="number">0</span>; --activityNdx) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityRecord r = activities.get(activityNdx);</span><br><span class="line">                    <span class="keyword">if</span> (r.finishing) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> isTop = r == top;</span><br><span class="line">                    <span class="keyword">if</span> (aboveTop &amp;&amp; !isTop) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    aboveTop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Check whether activity should be visible without Keyguard influence</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> visibleIgnoringKeyguard = r.shouldBeVisibleIgnoringKeyguard(</span><br><span class="line">                            behindFullscreenActivity);</span><br><span class="line">                    r.visibleIgnoringKeyguard = visibleIgnoringKeyguard;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Now check whether it&#x27;s really visible depending on Keyguard state.</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> reallyVisible = checkKeyguardVisibility(r,</span><br><span class="line">                            visibleIgnoringKeyguard, isTop &amp;&amp; isTopNotPinnedStack);</span><br><span class="line">                    <span class="keyword">if</span> (visibleIgnoringKeyguard) &#123;</span><br><span class="line">                        behindFullscreenActivity = updateBehindFullscreen(!stackShouldBeVisible,</span><br><span class="line">                                behindFullscreenActivity, r);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (reallyVisible) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY, <span class="string">&quot;Make visible? &quot;</span> + r</span><br><span class="line">                                + <span class="string">&quot; finishing=&quot;</span> + r.finishing + <span class="string">&quot; state=&quot;</span> + r.getState());</span><br><span class="line">                        <span class="comment">// First: if this is not the current activity being started, make</span></span><br><span class="line">                        <span class="comment">// sure it matches the current configuration.</span></span><br><span class="line">                        <span class="keyword">if</span> (r != starting &amp;&amp; notifyClients) &#123;</span><br><span class="line">                            r.ensureActivityConfiguration(<span class="number">0</span> <span class="comment">/* globalChanges */</span>, preserveWindows,</span><br><span class="line">                                    <span class="keyword">true</span> <span class="comment">/* ignoreStopState */</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (makeVisibleAndRestartIfNeeded(starting, configChanges, isTop,</span><br><span class="line">                                    resumeNextActivity, r)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (activityNdx &gt;= activities.size()) &#123;</span><br><span class="line">                                    <span class="comment">// Record may be removed if its process needs to restart.</span></span><br><span class="line">                                    activityNdx = activities.size() - <span class="number">1</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    resumeNextActivity = <span class="keyword">false</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">                            <span class="comment">// If this activity is already visible, then there is nothing to do here.</span></span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY,</span><br><span class="line">                                    <span class="string">&quot;Skipping: already visible at &quot;</span> + r);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (r.mClientVisibilityDeferred &amp;&amp; notifyClients) &#123;</span><br><span class="line">                                r.makeClientVisible();</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (r.handleAlreadyVisible()) &#123;</span><br><span class="line">                                resumeNextActivity = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            r.makeVisibleIfNeeded(starting, notifyClients);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// Aggregate current change flags.</span></span><br><span class="line">                        configChanges |= r.configChangeFlags;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY, <span class="string">&quot;Make invisible? &quot;</span> + r</span><br><span class="line">                                + <span class="string">&quot; finishing=&quot;</span> + r.finishing + <span class="string">&quot; state=&quot;</span> + r.getState()</span><br><span class="line">                                + <span class="string">&quot; stackShouldBeVisible=&quot;</span> + stackShouldBeVisible</span><br><span class="line">                                + <span class="string">&quot; behindFullscreenActivity=&quot;</span> + behindFullscreenActivity</span><br><span class="line">                                + <span class="string">&quot; mLaunchTaskBehind=&quot;</span> + r.mLaunchTaskBehind);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//charlesvincent start</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;com.android.testred&quot;</span>.equals(r.packageName) </span><br><span class="line">               || <span class="string">&quot;com.android.testgreen&quot;</span>.equals(r.packageName)</span><br><span class="line">               || <span class="string">&quot;com.android.testblue&quot;</span>.equals(r.packageName))&#123;</span><br><span class="line">                <span class="comment">//do nothing</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            makeInvisible(r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//charlesvincent end</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> windowingMode = getWindowingMode();</span><br><span class="line">                <span class="keyword">if</span> (windowingMode == WINDOWING_MODE_FREEFORM) &#123;</span><br><span class="line">                    <span class="comment">// The visibility of tasks and the activities they contain in freeform stack are</span></span><br><span class="line">                    <span class="comment">// determined individually unlike other stacks where the visibility or fullscreen</span></span><br><span class="line">                    <span class="comment">// status of an activity in a previous task affects other.</span></span><br><span class="line">                    behindFullscreenActivity = !stackShouldBeVisible;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isActivityTypeHome()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_VISIBILITY) Slog.v(TAG_VISIBILITY, <span class="string">&quot;Home task: at &quot;</span> + task</span><br><span class="line">                            + <span class="string">&quot; stackShouldBeVisible=&quot;</span> + stackShouldBeVisible</span><br><span class="line">                            + <span class="string">&quot; behindFullscreenActivity=&quot;</span> + behindFullscreenActivity);</span><br><span class="line">                    <span class="comment">// No other task in the home stack should be visible behind the home activity.</span></span><br><span class="line">                    <span class="comment">// Home activities is usually a translucent activity with the wallpaper behind</span></span><br><span class="line">                    <span class="comment">// them. However, when they don&#x27;t have the wallpaper behind them, we want to</span></span><br><span class="line">                    <span class="comment">// show activities in the next application stack behind them vs. another</span></span><br><span class="line">                    <span class="comment">// task in the home stack like recents.</span></span><br><span class="line">                    behindFullscreenActivity = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mTranslucentActivityWaiting != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    mUndrawnActivitiesBelowTopTranslucent.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">// Nothing is getting drawn or everything was already visible, don&#x27;t wait for timeout.</span></span><br><span class="line">                notifyActivityDrawnLocked(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mStackSupervisor.getKeyguardController().endActivityVisibilityUpdate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在ActivityManagerService.attachApplication方法中经过多次跳转执行到ActivityStackSupervisor.realStartActivityLocked方法。看到这个方法有没有一点眼熟？没错，就是之前分析过程中遇到的如果应用进程已经启动的情况下去启动Activity所调用的方法，有点绕，自己体会一下。在ActivityStackSupervisor.realStartActivityLocked方法中为ClientTransaction对象添加LaunchActivityItem的callback，然后设置当前的生命周期状态，最后调用ClientLifecycleManager.scheduleTransaction方法执行。</p>
<h4 id="六、执行启动Acitivity"><a href="#六、执行启动Acitivity" class="headerlink" title="六、执行启动Acitivity"></a>六、执行启动Acitivity</h4><h5 id="6-1、ActivityStackSupervisor-realStartActivityLocked"><a href="#6-1、ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="6.1、ActivityStackSupervisor.realStartActivityLocked()"></a>6.1、ActivityStackSupervisor.realStartActivityLocked()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line">    [-&gt;ActivityStackSupervisor.java]</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allPausedActivitiesComplete()) &#123;</span><br><span class="line">            <span class="comment">// While there are activities pausing we skipping starting any new activities until</span></span><br><span class="line">            <span class="comment">// pauses are complete. <span class="doctag">NOTE:</span> that we also do this for activities that are starting in</span></span><br><span class="line">            <span class="comment">// the paused state because they will first be resumed then paused on the client side.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE,</span><br><span class="line">                    <span class="string">&quot;realStartActivityLocked: Skipping start of r=&quot;</span> + r</span><br><span class="line">                    + <span class="string">&quot; some activities pausing...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = r.getTask();</span><br><span class="line">        <span class="keyword">final</span> ActivityStack stack = task.getStack();</span><br><span class="line"></span><br><span class="line">        beginDeferResume();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            r.startFreezingScreenLocked(app, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// schedule launch ticks to collect information about slow apps.</span></span><br><span class="line">            r.startLaunchTickingLocked();</span><br><span class="line"></span><br><span class="line">            r.setProcess(app);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getKeyguardController().isKeyguardLocked()) &#123;</span><br><span class="line">                r.notifyUnknownVisibilityLaunched();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Have the window manager re-evaluate the orientation of the screen based on the new</span></span><br><span class="line">            <span class="comment">// activity order.  Note that as a result of this, it can call back into the activity</span></span><br><span class="line">            <span class="comment">// manager with a new orientation.  We don&#x27;t care about that, because the activity is</span></span><br><span class="line">            <span class="comment">// not currently running so we are just restarting it anyway.</span></span><br><span class="line">            <span class="keyword">if</span> (checkConfig) &#123;</span><br><span class="line">                <span class="comment">// Deferring resume here because we&#x27;re going to launch new activity shortly.</span></span><br><span class="line">                <span class="comment">// We don&#x27;t want to perform a redundant launch of the same record while ensuring</span></span><br><span class="line">                <span class="comment">// configurations and trying to resume top activity of focused stack.</span></span><br><span class="line">                ensureVisibilityAndConfig(r, r.getDisplayId(),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* markFrozenIfConfigChanged */</span>, <span class="keyword">true</span> <span class="comment">/* deferResume */</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r.getStack().checkKeyguardVisibility(r, <span class="keyword">true</span> <span class="comment">/* shouldBeVisible */</span>,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* isTop */</span>)) &#123;</span><br><span class="line">                <span class="comment">// We only set the visibility to true if the activity is allowed to be visible</span></span><br><span class="line">                <span class="comment">// based on</span></span><br><span class="line">                <span class="comment">// keyguard state. This avoids setting this into motion in window manager that is</span></span><br><span class="line">                <span class="comment">// later cancelled due to later calls to ensure visible activities that set</span></span><br><span class="line">                <span class="comment">// visibility back to false.</span></span><br><span class="line">                r.setVisibility(<span class="keyword">true</span>);</span><br><span class="line">------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setVisibility</span><span class="params">(<span class="keyword">boolean</span> visible)</span> </span>&#123;</span><br><span class="line">        mWindowContainerController.setVisibility(visible, mDeferHidingClient);</span><br><span class="line">        mStackSupervisor.getActivityMetricsLogger().notifyVisibilityChanged(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.850</span> V/WindowManager( <span class="number">1049</span>): setAppVisibility(Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;, visible=<span class="keyword">true</span>): mNextAppTransition=TRANSIT_TASK_OPEN hidden=<span class="keyword">true</span> hiddenRequested=<span class="keyword">false</span> Callers=com.android.server.am.ActivityRecord.setVisibility:<span class="number">1668</span> com.android.server.am.ActivityStackSupervisor.realStartActivityLocked:<span class="number">1433</span> com.android.server.am.ActivityStackSupervisor.attachApplicationLocked:<span class="number">996</span> com.android.server.am.ActivityManagerService.attachApplicationLocked:<span class="number">7977</span> com.android.server.am.ActivityManagerService.attachApplication:<span class="number">8045</span> android.app.IActivityManager$Stub.onTransact:<span class="number">198</span> </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.850</span> V/WindowManager( <span class="number">1049</span>): No longer Stopped: AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125;</span><br><span class="line">------------------------------</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> applicationInfoUid =</span><br><span class="line">                    (r.info.applicationInfo != <span class="keyword">null</span>) ? r.info.applicationInfo.uid : -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ((r.userId != app.userId) || (r.appInfo.uid != applicationInfoUid)) &#123;</span><br><span class="line">                Slog.wtf(TAG,</span><br><span class="line">                        <span class="string">&quot;User ID for activity changing for &quot;</span> + r</span><br><span class="line">                                + <span class="string">&quot; appInfo.uid=&quot;</span> + r.appInfo.uid</span><br><span class="line">                                + <span class="string">&quot; info.ai.uid=&quot;</span> + applicationInfoUid</span><br><span class="line">                                + <span class="string">&quot; old=&quot;</span> + r.app + <span class="string">&quot; new=&quot;</span> + app);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            app.waitingToKill = <span class="keyword">null</span>;</span><br><span class="line">            r.launchCount++;</span><br><span class="line">            r.lastLaunchTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">&quot;Launching: &quot;</span> + r);</span><br><span class="line">-----------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.850</span> V/ActivityStackSupervisor( <span class="number">1049</span>): Launching: ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.850</span> D/ActivityManagerService_LRU( <span class="number">1049</span>): Adding to top of LRU activity list: ProcessRecord&#123;d768ca0 <span class="number">2602</span>:com.android.testred/u0a88&#125;</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.850</span> D/ActivityManagerService_OomAdj( <span class="number">1049</span>): Making top: ProcessRecord&#123;d768ca0 <span class="number">2602</span>:com.android.testred/u0a88&#125;</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> idx = app.activities.indexOf(r);</span><br><span class="line">            <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                app.activities.add(r);</span><br><span class="line">            &#125;</span><br><span class="line">            mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">            mService.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> LockTaskController lockTaskController = mService.getLockTaskController();</span><br><span class="line">            <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE</span><br><span class="line">                    || task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV</span><br><span class="line">                    || (task.mLockTaskAuth == LOCK_TASK_AUTH_WHITELISTED</span><br><span class="line">                            &amp;&amp; lockTaskController.getLockTaskModeState()</span><br><span class="line">                                    == LOCK_TASK_MODE_LOCKED)) &#123;</span><br><span class="line">                lockTaskController.startLockTaskMode(task, <span class="keyword">false</span>, <span class="number">0</span> <span class="comment">/* blank UID */</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</span><br><span class="line">                List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    <span class="comment">// We don&#x27;t need to deliver new intents and/or set results if activity is going</span></span><br><span class="line">                    <span class="comment">// to pause immediately after launch.</span></span><br><span class="line">                    results = r.results;</span><br><span class="line">                    newIntents = r.newIntents;</span><br><span class="line">                &#125;</span><br><span class="line">------------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.854</span> V/ActivityStackSupervisor_Switch( <span class="number">1049</span>): Launching: ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; icicle=<span class="keyword">null</span> with results=<span class="keyword">null</span> newIntents=<span class="keyword">null</span> andResume=<span class="keyword">true</span></span><br><span class="line">------------------------------------------------</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH,</span><br><span class="line">                        <span class="string">&quot;Launching: &quot;</span> + r + <span class="string">&quot; icicle=&quot;</span> + r.icicle + <span class="string">&quot; with results=&quot;</span> + results</span><br><span class="line">                                + <span class="string">&quot; newIntents=&quot;</span> + newIntents + <span class="string">&quot; andResume=&quot;</span> + andResume);</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY, r.userId,</span><br><span class="line">                        System.identityHashCode(r), task.taskId, r.shortComponentName);</span><br><span class="line">                <span class="keyword">if</span> (r.isActivityTypeHome()) &#123;</span><br><span class="line">                    <span class="comment">// Home process is the root process of the task.</span></span><br><span class="line">                    mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</span><br><span class="line">                &#125;</span><br><span class="line">                mService.notifyPackageUse(r.intent.getComponent().getPackageName(),</span><br><span class="line">                        PackageManager.NOTIFY_PACKAGE_USE_ACTIVITY);</span><br><span class="line">                r.sleeping = <span class="keyword">false</span>;</span><br><span class="line">                r.forceNewConfig = <span class="keyword">false</span>;</span><br><span class="line">                mService.getAppWarningsLocked().onStartActivity(r);</span><br><span class="line">                mService.showAskCompatModeDialogLocked(r);</span><br><span class="line">                r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</span><br><span class="line">                ProfilerInfo profilerInfo = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mService.mProfileProc == <span class="keyword">null</span> || mService.mProfileProc == app) &#123;</span><br><span class="line">                        mService.mProfileProc = app;</span><br><span class="line">                        ProfilerInfo profilerInfoSvc = mService.mProfilerInfo;</span><br><span class="line">                        <span class="keyword">if</span> (profilerInfoSvc != <span class="keyword">null</span> &amp;&amp; profilerInfoSvc.profileFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (profilerInfoSvc.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    profilerInfoSvc.profileFd = profilerInfoSvc.profileFd.dup();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                    profilerInfoSvc.closeFd();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            profilerInfo = <span class="keyword">new</span> ProfilerInfo(profilerInfoSvc);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                app.hasShownUi = <span class="keyword">true</span>;</span><br><span class="line">                app.pendingUiClean = <span class="keyword">true</span>;</span><br><span class="line">                app.forceProcessStateUpTo(mService.mTopProcessState);</span><br><span class="line">                <span class="comment">// Because we could be starting an Activity in the system process this may not go</span></span><br><span class="line">                <span class="comment">// across a Binder interface which would create a new Configuration. Consequently</span></span><br><span class="line">                <span class="comment">// we have to always create a new Configuration here.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> MergedConfiguration mergedConfiguration = <span class="keyword">new</span> MergedConfiguration(</span><br><span class="line">                        mService.getGlobalConfiguration(), r.getMergedOverrideConfiguration());</span><br><span class="line">                r.setLastReportedConfiguration(mergedConfiguration);</span><br><span class="line"></span><br><span class="line">                logIfTransactionTooLarge(r.intent, r.icicle);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Create activity launch transaction.</span></span><br><span class="line">                <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(app.thread,</span><br><span class="line">                        r.appToken);</span><br><span class="line">                clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">                        System.identityHashCode(r), r.info,</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                        <span class="comment">// and override configs.</span></span><br><span class="line">                        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                        r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">                        r.persistentState, results, newIntents, mService.isNextTransitionForward(),</span><br><span class="line">                        profilerInfo));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set desired final state.</span></span><br><span class="line">                <span class="comment">// ResumeActivityItem</span></span><br><span class="line">                <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">                <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">                    lifecycleItem = ResumeActivityItem.obtain(mService.isNextTransitionForward());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">                &#125;</span><br><span class="line">                clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Schedule transaction.</span></span><br><span class="line">                mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((app.info.privateFlags &amp; ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span></span><br><span class="line">                        &amp;&amp; mService.mHasHeavyWeightFeature) &#123;</span><br><span class="line">                    <span class="comment">// This may be a heavy-weight process!  Note that the package</span></span><br><span class="line">                    <span class="comment">// manager will ensure that only activity can run in the main</span></span><br><span class="line">                    <span class="comment">// process of the .apk, which is the only thing that will be</span></span><br><span class="line">                    <span class="comment">// considered heavy-weight.</span></span><br><span class="line">                    <span class="keyword">if</span> (app.processName.equals(app.info.packageName)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mService.mHeavyWeightProcess != <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; mService.mHeavyWeightProcess != app) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">&quot;Starting new heavy weight process &quot;</span> + app</span><br><span class="line">                                    + <span class="string">&quot; when already running &quot;</span></span><br><span class="line">                                    + mService.mHeavyWeightProcess);</span><br><span class="line">                        &#125;</span><br><span class="line">                        mService.mHeavyWeightProcess = app;</span><br><span class="line">                        Message msg = mService.mHandler.obtainMessage(</span><br><span class="line">                                ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);</span><br><span class="line">                        msg.obj = r;</span><br><span class="line">                        mService.mHandler.sendMessage(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.launchFailed) &#123;</span><br><span class="line">                    <span class="comment">// This is the second time we failed -- finish activity</span></span><br><span class="line">                    <span class="comment">// and give up.</span></span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Second failure launching &quot;</span></span><br><span class="line">                            + r.intent.getComponent().flattenToShortString()</span><br><span class="line">                            + <span class="string">&quot;, giving up&quot;</span>, e);</span><br><span class="line">                    mService.appDiedLocked(app);</span><br><span class="line">                    stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="string">&quot;2nd-crash&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This is the first time we failed -- restart process and</span></span><br><span class="line">                <span class="comment">// retry.</span></span><br><span class="line">                r.launchFailed = <span class="keyword">true</span>;</span><br><span class="line">                app.activities.remove(r);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            endDeferResume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.launchFailed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (stack.updateLRUListLocked(r)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Activity &quot;</span> + r + <span class="string">&quot; being launched, but already in LRU list&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO(lifecycler): Resume or pause requests are done as part of launch transaction,</span></span><br><span class="line">        <span class="comment">// so updating the state should be done accordingly.</span></span><br><span class="line">        <span class="keyword">if</span> (andResume &amp;&amp; readyToResume()) &#123;</span><br><span class="line">            <span class="comment">// As part of the process of launching, ActivityThread also performs</span></span><br><span class="line">            <span class="comment">// a resume.</span></span><br><span class="line">----------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line">    <span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.854</span> V/ActivityStack_States( <span class="number">1049</span>): Moving to RESUMED: ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; (starting <span class="keyword">new</span> instance) callers=com.android.server.am.ActivityStackSupervisor.realStartActivityLocked:<span class="number">1609</span> com.android.server.am.ActivityStackSupervisor.attachApplicationLocked:<span class="number">996</span> com.android.server.am.ActivityManagerService.attachApplicationLocked:<span class="number">7977</span> com.android.server.am.ActivityManagerService.attachApplication:<span class="number">8045</span> android.app.IActivityManager$Stub.onTransact:<span class="number">198</span> </span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.854</span> V/ActivityRecord_States( <span class="number">1049</span>): State movement: ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; from:INITIALIZING to:RESUMED reason:minimalResumeActivityLocked</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.854</span> V/ActivityStack_Stack( <span class="number">1049</span>): set resumed activity to:ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; reason:minimalResumeActivityLocked</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.855</span> D/ActivityStack_Stack( <span class="number">1049</span>): setResumedActivity stack:ActivityStack&#123;<span class="number">1</span>b7b488 stackId=<span class="number">1</span> type=standard mode=fullscreen visible=<span class="keyword">true</span> translucent=<span class="keyword">true</span>, <span class="number">1</span> tasks&#125; + from: <span class="keyword">null</span> to:ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125; reason:minimalResumeActivityLocked - onActivityStateChanged</span><br><span class="line">----------------------------------------------</span><br><span class="line">            stack.minimalResumeActivityLocked(r);</span><br><span class="line">----------------------------------------------</span><br><span class="line">看下 stack.minimalResumeActivityLocked(r)</span><br><span class="line">最终调用到android9.<span class="number">0</span>/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onActivityStateChanged</span><span class="params">(ActivityRecord record, ActivityState state, String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (record == mResumedActivity &amp;&amp; state != RESUMED) &#123;</span><br><span class="line">            setResumedActivity(<span class="keyword">null</span>, reason + <span class="string">&quot; - onActivityStateChanged&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == RESUMED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STACK) Slog.v(TAG_STACK, <span class="string">&quot;set resumed activity to:&quot;</span> + record + <span class="string">&quot; reason:&quot;</span></span><br><span class="line">                    + reason);</span><br><span class="line">            setResumedActivity(record, reason + <span class="string">&quot; - onActivityStateChanged&quot;</span>);</span><br><span class="line">            </span><br><span class="line"> <span class="comment">//mWindowManager.setFocusedApp(r.appToken, true);</span></span><br><span class="line">   ----------------------------------------------</span><br><span class="line">对应Log：</span><br><span class="line"><span class="number">04</span>-<span class="number">16</span> <span class="number">13</span>:<span class="number">08</span>:<span class="number">36.855</span> V/WindowManager( <span class="number">1049</span>): Set focused app to: AppWindowToken&#123;<span class="number">1579134</span> token=Token&#123;ce2ac07 ActivityRecord&#123;<span class="number">65</span>cc87a u0 com.android.testred/.TestActivity t5&#125;&#125;&#125; old focus=AppWindowToken&#123;<span class="number">483</span>acfb token=Token&#123;f984e8a ActivityRecord&#123;<span class="number">5e34200</span> u0 com.android.launcher3/.Launcher t4&#125;&#125;&#125; moveFocusNow=<span class="keyword">true</span></span><br><span class="line">----------------------------------------------</span><br><span class="line">       mService.setResumedActivityUncheckLocked(record, reason);</span><br><span class="line">            <span class="comment">//将TaskRecord加入到mRecentTasks</span></span><br><span class="line">            mStackSupervisor.mRecentTasks.add(record.getTask());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">----------------------------------------------</span><br><span class="line">        &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This activity is not starting in the resumed state... which should look like we asked</span></span><br><span class="line">            <span class="comment">// it to pause+stop (but remain visible), and it has done so and reported back the</span></span><br><span class="line">            <span class="comment">// current icicle and other state.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STATES) Slog.v(TAG_STATES,</span><br><span class="line">                    <span class="string">&quot;Moving to PAUSED: &quot;</span> + r + <span class="string">&quot; (starting in paused state)&quot;</span>);</span><br><span class="line">            r.setState(PAUSED, <span class="string">&quot;realStartActivityLocked&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Launch the new version setup screen if needed.  We do this -after-</span></span><br><span class="line">        <span class="comment">// launching the initial activity (that is, home), so that it can have</span></span><br><span class="line">        <span class="comment">// a chance to initialize itself while in the background, making the</span></span><br><span class="line">        <span class="comment">// switch back to it faster and look better.</span></span><br><span class="line">        <span class="keyword">if</span> (isFocusedStack(stack)) &#123;</span><br><span class="line">            mService.getActivityStartController().startSetupActivity();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update any services we are bound to that might care about whether</span></span><br><span class="line">        <span class="comment">// their client may have activities.</span></span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mService.mServices.updateServiceConnectionActivitiesLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">        System.identityHashCode(r), r.info,</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">        <span class="comment">// and override configs.</span></span><br><span class="line">        mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">        mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">        r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">        r.persistentState, results, newIntents, mService.isNextTransitionForward(),</span><br><span class="line">        profilerInfo));</span><br></pre></td></tr></table></figure>

<p>这里的clientTransaction.addCallback(LaunchActivityItem.obtain(arg…))就是我们目前用到的lifecycleItem,也就是说 这个lifecycleItem就是LaunchActivityItem<br>继续看lifecycleItem.execute(mTransactionHandler, token, mPendingActions);源码:<br>//LaunchActivityItem</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">          PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">      Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">      ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">              mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">              mPendingResults, mPendingNewIntents, mIsForward,</span><br><span class="line">              mProfilerInfo, client);</span><br><span class="line">      <span class="comment">//注释1</span></span><br><span class="line">      client.handleLaunchActivity(r, pendingActions, null <span class="comment">/* customIntent */</span>);</span><br><span class="line">      Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h5 id="6-2、ActivityThread-handleLaunchActivity"><a href="#6-2、ActivityThread-handleLaunchActivity" class="headerlink" title="6.2、ActivityThread.handleLaunchActivity()"></a>6.2、ActivityThread.handleLaunchActivity()</h5><p>client.handleLaunchActivity就是:控制activity的生命周期  真正的实现类是ClientTransactionHandler的子类 Activityhread;</p>
<p>继续看client.handleLaunchActivity源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java]</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Activity <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">        <span class="comment">// we are back active so skip it.</span></span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProfiler.setProfiler(r.profilerInfo);</span><br><span class="line">            mProfiler.startProfiling();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure we are running with the most recent config.</span></span><br><span class="line">        handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">            TAG, <span class="string">&quot;Handling launch of &quot;</span> + r);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize before creating the activity</span></span><br><span class="line">        <span class="keyword">if</span> (!ThreadedRenderer.sRendererDisabled) &#123;</span><br><span class="line">            GraphicsEnvironment.earlyInitEGL();</span><br><span class="line">        &#125;</span><br><span class="line">        WindowManagerGlobal.initialize();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">            reportSizeConfigurations(r);</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; pendingActions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pendingActions.setOldState(r.state);</span><br><span class="line">                pendingActions.setRestoreInstanceState(<span class="keyword">true</span>);</span><br><span class="line">                pendingActions.setCallOnPostCreate(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If there was an error, for any reason, tell the activity manager to stop us.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManager.getService()</span><br><span class="line">                        .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                                Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h5 id="6-3、ActivityThread-performLaunchActivity"><a href="#6-3、ActivityThread-performLaunchActivity" class="headerlink" title="6.3、ActivityThread.performLaunchActivity()"></a>6.3、ActivityThread.performLaunchActivity()</h5><p>performLaunchActivity(r, customIntent)源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[-&gt; ActivityThread.java]</span><br><span class="line">    <span class="comment">/**  Core implementation of activity launch. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">        <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ComponentName component = r.intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = r.intent.resolveActivity(</span><br><span class="line">                mInitialApplication.getPackageManager());</span><br><span class="line">            r.intent.setComponent(component);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">        Activity activity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to instantiate activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">&quot;Performing launch of &quot;</span> + r);</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, r + <span class="string">&quot;: app=&quot;</span> + app</span><br><span class="line">                    + <span class="string">&quot;, appName=&quot;</span> + app.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, pkg=&quot;</span> + r.packageInfo.getPackageName()</span><br><span class="line">                    + <span class="string">&quot;, comp=&quot;</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                    + <span class="string">&quot;, dir=&quot;</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">                <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    config.updateFrom(r.overrideConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">&quot;Launching activity &quot;</span></span><br><span class="line">                        + r.activityInfo.name + <span class="string">&quot; with config &quot;</span> + config);</span><br><span class="line">                Window window = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                    window = r.mPendingRemoveWindow;</span><br><span class="line">                    r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                    r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                appContext.setOuterContext(activity);</span><br><span class="line">                activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    activity.mIntent = customIntent;</span><br><span class="line">                &#125;</span><br><span class="line">                r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">                checkAndBlockForNetworkAccess();</span><br><span class="line">                activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">                <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                    activity.setTheme(theme);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">&quot;Activity &quot;</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">&quot; did not call through to super.onCreate()&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.activity = activity;</span><br><span class="line">            &#125;</span><br><span class="line">            r.setState(ON_CREATE);</span><br><span class="line"></span><br><span class="line">            mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">&quot;Unable to start activity &quot;</span> + component</span><br><span class="line">                    + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>初始化activity的context<br>利用classloader机制反射获取activity实例<br>创建app的入口application<br>执行 activity的attach方法   初始化window/父parent-DecorView/windowManage ,windowManager的子类为 WindowManagerimpl 是view和window的操作类<br>执行activity的onCreate方法</p>
<p>至此executeCallbacks执行完毕，开始执行executeLifecycleState方法。先执行cycleToPath方法，生命周期状态是从ON_CREATE状态到ON_RESUME状态，中间有一个ON_START状态，所以会执行ActivityThread.handleStartActivity方法。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cycleToPath</span><span class="params">(ActivityClientRecord r, <span class="keyword">int</span> finish,</span></span></span><br><span class="line"><span class="function"><span class="params">        boolean excludeLastState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> IntArray path = mHelper.getLifecyclePath(start, finish, excludeLastState);</span><br><span class="line">    performLifecycleSequence(r, path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Transition the client through previously initialized state sequence. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLifecycleSequence</span><span class="params">(ActivityClientRecord r, IntArray path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = path.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, state; i &lt; size; i++) &#123;</span><br><span class="line">        state = path.get(i);</span><br><span class="line">        <span class="built_in">log</span>(<span class="string">&quot;Transitioning to state: &quot;</span> + state);</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">                mTransactionHandler.handleLaunchActivity(r, mPendingActions,</span><br><span class="line">                        null <span class="comment">/* customIntent */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_START:</span><br><span class="line">                mTransactionHandler.handleStartActivity(r, mPendingActions);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">                mTransactionHandler.handleResumeActivity(r.token, <span class="literal">false</span> <span class="comment">/* finalStateRequest */</span>,</span><br><span class="line">                        r.isForward, <span class="string">&quot;LIFECYCLER_RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">                mTransactionHandler.handlePauseActivity(r.token, <span class="literal">false</span> <span class="comment">/* finished */</span>,</span><br><span class="line">                        <span class="literal">false</span> <span class="comment">/* userLeaving */</span>, <span class="number">0</span> <span class="comment">/* configChanges */</span>, mPendingActions,</span><br><span class="line">                        <span class="string">&quot;LIFECYCLER_PAUSE_ACTIVITY&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_STOP:</span><br><span class="line">                mTransactionHandler.handleStopActivity(r.token, <span class="literal">false</span> <span class="comment">/* show */</span>,</span><br><span class="line">                        <span class="number">0</span> <span class="comment">/* configChanges */</span>, mPendingActions, <span class="literal">false</span> <span class="comment">/* finalStateRequest */</span>,</span><br><span class="line">                        <span class="string">&quot;LIFECYCLER_STOP_ACTIVITY&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">                mTransactionHandler.handleDestroyActivity(r.token, <span class="literal">false</span> <span class="comment">/* finishing */</span>,</span><br><span class="line">                        <span class="number">0</span> <span class="comment">/* configChanges */</span>, <span class="literal">false</span> <span class="comment">/* getNonConfigInstance */</span>,</span><br><span class="line">                        <span class="string">&quot;performLifecycleSequence. cycling to:&quot;</span> + path.get(size - <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_RESTART:</span><br><span class="line">                mTransactionHandler.performRestartActivity(r.token, <span class="literal">false</span> <span class="comment">/* start */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected lifecycle state: &quot;</span> + state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从ActivityThread.handleStartActivity方法经过多次跳转最后会调用Activity.onStart方法，至此cycleToPath方法执行完毕。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartActivity</span><span class="params">(ActivityClientRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Start</span></span><br><span class="line">    activity.performStart(<span class="string">&quot;handleStartActivity&quot;</span>);</span><br><span class="line">    r.setState(ON_START);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Activity.java</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行完毕cycleToPath，开始执行ResumeActivityItem.execute方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/app/servertransaction/ResumeActivityItem.java</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">         PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">     client.handleResumeActivity(token, <span class="keyword">true</span> <span class="comment">/* finalStateRequest */</span>, mIsForward,</span><br><span class="line">             <span class="string">&quot;RESUME_ACTIVITY&quot;</span>);</span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finalStateRequest, <span class="keyword">boolean</span> isForward,</span></span></span><br><span class="line"><span class="function"><span class="params">         String reason)</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">     <span class="comment">// TODO Push resumeArgs into the activity for consideration</span></span><br><span class="line">     <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">     ...</span><br><span class="line">     Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ActivityClientRecord <span class="title">performResumeActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finalStateRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">         String reason)</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         r.activity.onStateNotSaved();</span><br><span class="line">         r.activity.mFragments.noteStateNotSaved();</span><br><span class="line">         checkAndBlockForNetworkAccess();</span><br><span class="line">         <span class="keyword">if</span> (r.pendingIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">             deliverNewIntents(r, r.pendingIntents);</span><br><span class="line">             r.pendingIntents = <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r.pendingResults != <span class="keyword">null</span>) &#123;</span><br><span class="line">             deliverResults(r, r.pendingResults, reason);</span><br><span class="line">             r.pendingResults = <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line"></span><br><span class="line">         r.state = <span class="keyword">null</span>;</span><br><span class="line">         r.persistentState = <span class="keyword">null</span>;</span><br><span class="line">         r.setState(ON_RESUME);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         <span class="keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to resume activity &quot;</span></span><br><span class="line">                     + r.intent.getComponent().toShortString() + <span class="string">&quot;: &quot;</span> + e.toString(), e);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">return</span> r;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> frameworks/base/core/java/android/app/Activity.java</span><br><span class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">(<span class="keyword">boolean</span> followedByPause, String reason)</span> </span>&#123;</span><br><span class="line">     performRestart(<span class="keyword">true</span> <span class="comment">/* start */</span>, reason);</span><br><span class="line">     ...</span><br><span class="line">     <span class="comment">// mResumed is set by the instrumentation</span></span><br><span class="line">     mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> frameworks/base/core/java/android/app/Instrumentation.java</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">     activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">     activity.onResume();</span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>经过上面的多次跳转最终调用到Activity.onResume方法，Activity启动完毕。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">我们来看一下Activity 的生命周期：</span><br><span class="line"></span><br><span class="line">&gt; protected void onCreate(); </span><br><span class="line">&gt; protected void onStart(); </span><br><span class="line">&gt; protected void onResume(); </span><br><span class="line">&gt; protected void onPause(); </span><br><span class="line">&gt; protected void onStop();</span><br><span class="line">&gt; protected void onDestory();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>前面我们分析了onCreate()、onStart() 、onResume()、onPause()。 Activity 暂停销毁时的 、onStop() 、onDestroy() 回调都与前面的过程大同小异，这里就只列举相应的方法栈，不再继续描述。</p>
<h4 id="七、参考文档"><a href="#七、参考文档" class="headerlink" title="七、参考文档"></a>七、参考文档</h4><p><a target="_blank" rel="noopener" href="http://charlesvincent.cc/">（1）【Android Display System】</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/50e4b48ed15c">（2）【Android 9.0 activity启动源码分析】</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/lj19851227/article/details/82562115">（3）【Android 9.0 Activity启动流程源码分析】</a><br><a target="_blank" rel="noopener" href="https://gitlab.com/zhoujinjianzz/apq8096_la.um.7.5.r1-03100-8x96.0_p_v5.0/commit/714c0071b4bc786d00e7a6bcd08face6a28d6c0c">（4）【Android App(“com.android.testgreen”)源码】</a><br><a target="_blank" rel="noopener" href="http://gityuan.com/2016/03/26/app-process-create/">（5）【理解Android进程创建流程】</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhoujinjian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhoujinjian.com/posts/20191201/">https://zhoujinjian.com/posts/20191201/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhoujinjian.com" target="_blank">zhoujinjian</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Graphics/">Graphics</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00005.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/20200101/"><img class="prev-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00006.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Android L Display System源码分析（6）：App 界面显示流程源码分析 之 Window加载显示流程分析（Android 9.0 &amp;&amp; Kernel 3.18）</div></div></a></div><div class="next-post pull-right"><a href="/posts/20191101/"><img class="next-cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/personal.website/post.cover.pictures.00004.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android L Display System源码分析（4）：Android Graphics 系统分析（Android 5.0.2 &amp;&amp; Kernel 3.0.86）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/20210310/" title="Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.22.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="title">Android 10 Display System源码分析（1）：LCD显示原理（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210410/" title="Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.23.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-10</div><div class="title">Android 10 Display System源码分析（2）：Display System 精彩世界（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210510/" title="Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-10</div><div class="title">Android 10 Display System源码分析（3）：U-boot Display 显示过程源码分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210610/" title="Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.25.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Android 10 Display System源码分析（4）：DRM/KMS分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210710/" title="Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.26.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-10</div><div class="title">Android 10 Display System源码分析（5）：ModeTest分析（Android 10.0 && Kernel 4.15）</div></div></a></div><div><a href="/posts/20210810/" title="Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）"><img class="cover" data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.27.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-10</div><div class="title">Android 10 Display System源码分析（6）：【DRM/KMS】HWComposer && Gralloc2 分析（Android 10.0 && Kernel 4.15）</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#App%EF%BC%88%E2%80%9Dcom-android-testred%E2%80%9D%EF%BC%89%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">App（”com.android.testred”）分析准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81App%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">①、App运行效果图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E6%89%93%E5%BC%80Debug%E5%BC%80%E5%85%B3%EF%BC%8C%E6%8A%93%E5%8F%96Log"><span class="toc-number">1.2.</span> <span class="toc-text">②、打开Debug开关，抓取Log</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E5%AE%8C%E6%95%B4Log"><span class="toc-number">1.3.</span> <span class="toc-text">③完整Log</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81Activity%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">一、Activity概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1%E3%80%81Activity%E7%9A%84%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">2.1.</span> <span class="toc-text">1.1、Activity的管理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-1%E3%80%81Task%E5%92%8CStack"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1.1、Task和Stack</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-2%E3%80%81%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.1.2、启动模式的作用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-3%E3%80%81%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.1.3、启动模式的作用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-4%E3%80%81ActivityStack-amp-TaskRecord-amp-ActivityRecord-%E5%85%B3%E7%B3%BB"><span class="toc-number">2.1.4.</span> <span class="toc-text">1.1.4、ActivityStack &amp; TaskRecord &amp; ActivityRecord 关系</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2%E3%80%81ActivityManagerService%E7%9B%B8%E5%85%B3%E7%B1%BB%E7%AE%80%E4%BB%8B"><span class="toc-number">2.2.</span> <span class="toc-text">1.2、ActivityManagerService相关类简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3%E3%80%81%E7%9B%B8%E5%85%B3%E7%B1%BB%E9%87%8D%E8%A6%81%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.</span> <span class="toc-text">1.3、相关类重要成员变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-4%E3%80%81%E5%B0%8F%E7%BB%93%EF%BC%9A"><span class="toc-number">2.4.</span> <span class="toc-text">1.4、小结：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81APP%E8%AF%B7%E6%B1%82%E5%90%AF%E5%8A%A8Activity"><span class="toc-number">3.</span> <span class="toc-text">二、APP请求启动Activity</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1%E3%80%81Activity-startActivity"><span class="toc-number">3.1.</span> <span class="toc-text">2.1、Activity.startActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2%E3%80%81Activity-startActivityForResult"><span class="toc-number">3.2.</span> <span class="toc-text">2.2、Activity.startActivityForResult()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3%E3%80%81Instrumentation-execStartActivity"><span class="toc-number">3.3.</span> <span class="toc-text">2.3、Instrumentation.execStartActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4%E3%80%81IActivityManager-Stub-Proxy-startActivity"><span class="toc-number">3.4.</span> <span class="toc-text">2.4、IActivityManager.Stub.Proxy.startActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5%E3%80%81IActivityManager-Stub-onTransact"><span class="toc-number">3.5.</span> <span class="toc-text">2.5、IActivityManager.Stub.onTransact()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81-ActivityManagerService%E6%8E%A5%E6%94%B6%E5%90%AF%E5%8A%A8Activity%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="toc-number">4.</span> <span class="toc-text">三、 ActivityManagerService接收启动Activity的请求</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81ActivityManagerService-startActivity"><span class="toc-number">4.1.</span> <span class="toc-text">3.1、ActivityManagerService.startActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2%E3%80%81ActivityStarter-execute"><span class="toc-number">4.2.</span> <span class="toc-text">3.2、ActivityStarter.execute()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3%E3%80%81ActivityStarter-startActivity"><span class="toc-number">4.3.</span> <span class="toc-text">3.3、ActivityStarter.startActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4%E3%80%81ActivityStarter-startActivityUnchecked"><span class="toc-number">4.4.</span> <span class="toc-text">3.4、ActivityStarter.startActivityUnchecked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1%E3%80%81ActivityStarter-setTaskFromReuseOrCreateNewTask-%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84Task-AMS%E7%AB%AF"><span class="toc-number">4.5.</span> <span class="toc-text">3.4.1、ActivityStarter.setTaskFromReuseOrCreateNewTask()-创建新的Task[AMS端]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-1%E3%80%81TaskRecord%E5%88%9B%E5%BB%BAcreateTaskRecord"><span class="toc-number">4.6.</span> <span class="toc-text">3.4.1.1、TaskRecord创建createTaskRecord()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-1-1%E3%80%81TaskRecord-create"><span class="toc-number">4.7.</span> <span class="toc-text">3.4.1.1.1、TaskRecord.create()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-1-2%E3%80%81%E5%B0%86TaskRecord%E5%8A%A0%E5%85%A5%E5%88%B0ActivityStack%E4%B8%AD"><span class="toc-number">4.8.</span> <span class="toc-text">3.4.1.1.2、将TaskRecord加入到ActivityStack中</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-1-3%E3%80%81TaskRecord-createWindowContainer"><span class="toc-number">4.9.</span> <span class="toc-text">3.4.1.1.3、TaskRecord.createWindowContainer()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-1-4%E3%80%81TaskWindowContainerController-createTask-WMS%E7%AB%AF%E7%9A%84Task"><span class="toc-number">4.10.</span> <span class="toc-text">3.4.1.1.4、TaskWindowContainerController.createTask()[WMS端的Task]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-1-1-5%E3%80%81%E5%B0%86Task-WMS-%E5%8A%A0%E5%85%A5%E5%88%B0TaskStack"><span class="toc-number">4.11.</span> <span class="toc-text">3.4.1.1.5、将Task[WMS]加入到TaskStack</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2%E3%80%81ActivityStack-startActivityLocked"><span class="toc-number">4.12.</span> <span class="toc-text">3.4.2、ActivityStack.startActivityLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-4-2-1%E3%80%81ActivityRecord-createWindowContainer"><span class="toc-number">4.13.</span> <span class="toc-text">3.4.2.1、ActivityRecord.createWindowContainer()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-5%E3%80%81ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><span class="toc-number">4.14.</span> <span class="toc-text">3.5、ActivityStackSupervisor.resumeFocusedStackTopActivityLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-6%E3%80%81ActivityStack-resumeTopActivityUncheckedLocked"><span class="toc-number">4.15.</span> <span class="toc-text">3.6、ActivityStack.resumeTopActivityUncheckedLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-7%E3%80%81ActivityStack-resumeTopActivityInnerLocked"><span class="toc-number">4.16.</span> <span class="toc-text">3.7、ActivityStack.resumeTopActivityInnerLocked()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%89%A7%E8%A1%8C%E6%A0%88%E9%A1%B6Activity%E7%9A%84onPause%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">四、执行栈顶Activity的onPause方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1%E3%80%81mStackSupervisor-pauseBackStacks-userLeaving-next-false"><span class="toc-number">5.1.</span> <span class="toc-text">4.1、mStackSupervisor.pauseBackStacks(userLeaving, next, false)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2%E3%80%81ActivityStack-startPausingLocked"><span class="toc-number">5.2.</span> <span class="toc-text">4.2、ActivityStack.startPausingLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3%E3%80%81scheduleTransaction-prev-app-thread-prev-appToken-PauseActivityItem-obtain-%E2%80%A6%E2%80%A6"><span class="toc-number">5.3.</span> <span class="toc-text">4.3、scheduleTransaction(prev.app.thread, prev.appToken,PauseActivityItem.obtain(……));</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-4%E3%80%81PauseActivityItem-execute"><span class="toc-number">5.4.</span> <span class="toc-text">4.4、PauseActivityItem.execute()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-5%E3%80%81-ActivityThread-handleMessage-mH"><span class="toc-number">5.5.</span> <span class="toc-text">4.5、[ActivityThread.handleMessage() : mH]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-6%E3%80%81ActivityThread-handlePauseActivity"><span class="toc-number">5.6.</span> <span class="toc-text">4.6、ActivityThread.handlePauseActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-7%E3%80%81ActivityThread-performPauseActivity"><span class="toc-number">5.7.</span> <span class="toc-text">4.7、ActivityThread.performPauseActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-8%E3%80%81Instrumentation-callActivityOnPuase"><span class="toc-number">5.8.</span> <span class="toc-text">4.8、Instrumentation.callActivityOnPuase()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-9%E3%80%81Activity-performPause"><span class="toc-number">5.9.</span> <span class="toc-text">4.9、Activity.performPause()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E3%80%81-App%EF%BC%88%E2%80%9Dcom-android-testred%E2%80%9D%EF%BC%89%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">五、 App（”com.android.testred”）进程启动过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1%E3%80%81system-server%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82"><span class="toc-number">6.1.</span> <span class="toc-text">5.1、system_server发起请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1%E3%80%81-ActivityManagerService-startProcessLocked"><span class="toc-number">6.2.</span> <span class="toc-text">5.1.1、 ActivityManagerService.startProcessLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2%E3%80%81-ActivityManagerService-newProcessRecordLocked"><span class="toc-number">6.3.</span> <span class="toc-text">5.1.2、 ActivityManagerService.newProcessRecordLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3%E3%80%81-ActivityManagerService-startProcessLocked"><span class="toc-number">6.4.</span> <span class="toc-text">5.1.3、 ActivityManagerService.startProcessLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-4%E3%80%81-ActivityManagerService-startProcess"><span class="toc-number">6.5.</span> <span class="toc-text">5.1.4、 ActivityManagerService.startProcess()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-5%E3%80%81Process-start"><span class="toc-number">6.6.</span> <span class="toc-text">5.1.5、Process.start()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-6%E3%80%81zygoteProcess-start"><span class="toc-number">6.7.</span> <span class="toc-text">5.1.6、zygoteProcess.start()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-7%E3%80%81zygoteProcess-openZygoteSocketIfNeeded"><span class="toc-number">6.8.</span> <span class="toc-text">5.1.7、zygoteProcess.openZygoteSocketIfNeeded()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-8%E3%80%81zygoteSendArgsAndGetResult"><span class="toc-number">6.9.</span> <span class="toc-text">5.1.8、zygoteSendArgsAndGetResult</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2%E3%80%81Zygote%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">6.10.</span> <span class="toc-text">5.2、Zygote创建进程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1%E3%80%81acceptCommandPeer"><span class="toc-number">6.11.</span> <span class="toc-text">5.2.1、acceptCommandPeer()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-2%E3%80%81processOneCommand"><span class="toc-number">6.12.</span> <span class="toc-text">5.2.2、processOneCommand()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-3%E3%80%81forkAndSpecialize"><span class="toc-number">6.13.</span> <span class="toc-text">5.2.3、forkAndSpecialize()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-4%E3%80%81nativeForkAndSpecialize"><span class="toc-number">6.14.</span> <span class="toc-text">5.2.4、nativeForkAndSpecialize</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-5%E3%80%81ForkAndSpecializeCommon"><span class="toc-number">6.15.</span> <span class="toc-text">5.2.5、ForkAndSpecializeCommon</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3%E3%80%81%E6%96%B0%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8C"><span class="toc-number">6.16.</span> <span class="toc-text">5.3、新进程运行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1%E3%80%81handleChildProc"><span class="toc-number">6.17.</span> <span class="toc-text">5.3.1、handleChildProc()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2%E3%80%81ZygoteInit-zygoteInit"><span class="toc-number">6.18.</span> <span class="toc-text">5.3.2、ZygoteInit.zygoteInit()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-3%E3%80%81RuntimeInit-commonInit"><span class="toc-number">6.19.</span> <span class="toc-text">5.3.3、RuntimeInit.commonInit()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-4%E3%80%81nativeZygoteInit"><span class="toc-number">6.20.</span> <span class="toc-text">5.3.4、nativeZygoteInit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-5%E3%80%81RuntimeInit-applicationInit"><span class="toc-number">6.21.</span> <span class="toc-text">5.3.5、RuntimeInit.applicationInit()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-6%E3%80%81findStaticMain"><span class="toc-number">6.22.</span> <span class="toc-text">5.3.6、findStaticMain()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-7%E3%80%81MethodAndArgsCaller"><span class="toc-number">6.23.</span> <span class="toc-text">5.3.7、MethodAndArgsCaller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-8%E3%80%81Activity%E6%89%80%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.24.</span> <span class="toc-text">5.3.8、Activity所在应用主线程初始化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%89%A7%E8%A1%8C%E5%90%AF%E5%8A%A8Acitivity"><span class="toc-number">7.</span> <span class="toc-text">六、执行启动Acitivity</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1%E3%80%81ActivityStackSupervisor-realStartActivityLocked"><span class="toc-number">7.1.</span> <span class="toc-text">6.1、ActivityStackSupervisor.realStartActivityLocked()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2%E3%80%81ActivityThread-handleLaunchActivity"><span class="toc-number">7.2.</span> <span class="toc-text">6.2、ActivityThread.handleLaunchActivity()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3%E3%80%81ActivityThread-performLaunchActivity"><span class="toc-number">7.3.</span> <span class="toc-text">6.3、ActivityThread.performLaunchActivity()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">8.</span> <span class="toc-text">七、参考文档</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.64.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序"/></a><div class="content"><a class="title" href="/posts/20240225/" title="Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序">Android 11 Display System V2（8）：Rockchip RK3399 - DRM HDMI驱动程序</a><time datetime="2024-02-24T16:00:00.000Z" title="发表于 2024-02-25 00:00:00">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.63.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍"/></a><div class="content"><a class="title" href="/posts/20240224/" title="Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍">Android 11 Display System V2（7）：Rockchip RK3399 - DRM HDMI介绍</a><time datetime="2024-02-23T16:00:00.000Z" title="发表于 2024-02-24 00:00:00">2024-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.62.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识"/></a><div class="content"><a class="title" href="/posts/20240223/" title="Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识">Android 11 Display System V2（6）：Rockchip RK3399 - DRM encoder、bridge、connector基础知识</a><time datetime="2024-02-22T16:00:00.000Z" title="发表于 2024-02-23 00:00:00">2024-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.61.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240222/" title="Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（5）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-21T16:00:00.000Z" title="发表于 2024-02-22 00:00:00">2024-02-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"><img data-lazy-src="https://raw.githubusercontent.com/zhoujinjianzz/zhoujinjian.com.images/master/post.cover.pictures/bing-wallpaper-2018.04.60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识"/></a><div class="content"><a class="title" href="/posts/20240221/" title="Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识">Android 11 Display System V2（4）：Rockchip RK3399 - DRM gem基础知识</a><time datetime="2024-02-20T16:00:00.000Z" title="发表于 2024-02-21 00:00:00">2024-02-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By zhoujinjian</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/js/fishes.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>